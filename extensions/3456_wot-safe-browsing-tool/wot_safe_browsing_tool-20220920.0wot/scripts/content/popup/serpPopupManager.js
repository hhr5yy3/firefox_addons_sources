var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var o=[],i=!0,s=!1,n=void 0;try{for(var r,a=e[Symbol.iterator]();!(i=(r=a.next()).done)&&(o.push(r.value),!t||o.length!==t);i=!0);}catch(e){s=!0,n=e}finally{try{!i&&a.return&&a.return()}finally{if(s)throw n}}return o}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};const mobileWidth=450;class SerpPopupManager{constructor(e,t,o){this.store=e,this.serpid=o,this.isOnboarding=t,this.step=e.getState().onboarding.step,this.info={},this.isInitOnboardingCalled=!1,this.promo=e.getState().remoteConfig.features.serpPromo||{},this.immediateClearPopup=this.immediateClearPopup.bind(this),this.clearPopup=this.clearPopup.bind(this),this.onLogoClick=this.onLogoClick.bind(this),this.onSettingsClick=this.onSettingsClick.bind(this),window.addEventListener("scroll",()=>{0!==this.step&&this.immediateClearPopup()}),window.addEventListener("onclick",e=>{if(!e.target.classList.contains("wot_shield")){document.querySelector("."+POPUP_OVERLAY).classList.contains("wot-open")&&this.immediateClearPopup()}}),window.addEventListener("message",e=>{if(e.data&&e.data.type===SHIELD_HOVER_EVENT){var t=e.data;const o=t.id,i=t.host,s=t.color;o&&this.onShieldOver(o,i,s)}e.data&&e.data.type===SHIELDS_READY&&!this.isInitOnboardingCalled&&(this.isInitOnboardingCalled=!0,this.initOnboarding())})}onShieldOver(e,t,o){0===this.step&&(this.store.dispatch(toNextStepOnboarding()),this.step+=1),GA("Search Popup","Shown "+o,t);const i=this.getPopupPositioning(e);this.showPopup(t,i,o)}preparePopupData(e,t){const o=this.store.getState();var i=o.ratings[e]||{};const s=i.rating,n=i.confidence,r=i.safety,a=i.commentsCount;this.info={host:e,shieldColor:t,bubbleColor:o.ratings[e].color,categories:o.ratings[e].categories||[],safety:r,childSafety:o.ratings[e].childSafety,commentsCount:a,rating:s,confidence:n,onboarding:o.onboarding,settings:o.settings},void 0===a&&this.store.dispatch(getCommentsCount(e))}desktopPopup(e){let t=e.info,o=e.isOnboarding,i=e.positionInfo;const s=setInterval(()=>{const e=document.getElementById("wot-popup-body");e&&(e.style.opacity=1,clearInterval(s))},50),n=i.styles,r=i.isBottomOfPage;return React.createElement("div",{style:n,onMouseLeave:this.clearPopup},React.createElement("div",{className:"shield__popover_container"},o&&t.onboarding.step<5&&React.createElement(ShieldOnBoarding,{closePopup:this.immediateClearPopup,safety:t.safety,step:this.step,childSafety:t.childSafety,color:this.info.shieldColor,onboarding:t.onboarding,dispatch:this.store.dispatch}),this.popupBody(t,r)))}mobilePopup(e){let t=e.info;return document.querySelector("."+POPUP_OVERLAY).classList.add("wot-open"),React.createElement("div",{className:"shield__popover_container",onMouseLeave:this.clearPopup},React.createElement("div",{className:"wot-mobile_popup"},this.popupBody(t,!0)))}getPopupHeaderText(e){switch(e){case SAFE:return"trustedByWOT";case SUSPICIOUS:return"suspiciousByWOTPopup";case NOT_SAFE:return"untrustedByWOTPopup";case UNKNOWN:default:return"unknownByWOTPopup"}}getHeaderClass(e,t){let o;switch(e){case SAFE:o="safe";break;case SUSPICIOUS:o="suspicious";break;case NOT_SAFE:o="unsafe";break;case UNKNOWN:default:o="unknown"}return`shield__header_${o} ${t?"":"wot_popup_top_of_screen"}`}popupBody(e,t){const o=e.categories,i=e.safety,s=e.childSafety,n=this.shouldShowPopupPromo(),r=n&&this.getPromoText(i,s);return React.createElement("div",{id:"wot-popup-body",className:"shield__popover"+(s===NOT_SAFE?" adult":"")},React.createElement("div",{className:"shield__header "+this.getHeaderClass(i,t)},React.createElement("span",null,translate(this.getPopupHeaderText(i))),React.createElement(SvgIcon,{className:"shield__header__icon",svg:"question_mark.svg",onClick:this.onInfoClick}),React.createElement(SvgIcon,{className:"shield__header__icon settings",svg:"settings-wheel.svg",onClick:this.onSettingsClick})),s===NOT_SAFE&&React.createElement("div",{className:"child-label"},React.createElement(SvgIcon,{className:"child-label_icon",svg:"18+red.svg"}),React.createElement("div",null,translate("popupAdultStrip"))),React.createElement("div",{className:"shield__body"},React.createElement(ScorecardData,{info:e}),React.createElement("div",{className:"shield__body_separator"}),o&&o.length?React.createElement("div",{style:{width:"100%"}},React.createElement(TargetTags,{categories:o}),React.createElement("div",{className:"shield__body_separator"})):null),React.createElement("div",{className:"shield__footer "+(t?"wot_popup_bottom_of_screen":"")},React.createElement("div",{className:"shield__footer_row"},React.createElement(ScorecardLink,{info:e}),React.createElement(SvgIcon,{className:"shield__logo",svg:"logo-bw.svg",onClick:this.onLogoClick})),n&&React.createElement("div",{className:"shield__footer_promo"},React.createElement("div",{className:"shield__footer_promo_text"},translate(r)),React.createElement("div",{className:"shield__footer_promo_cta",onClick:()=>this.onCTAClick(r)},React.createElement(SvgIcon,{svg:"white-circle-lightning.svg",className:"shield__footer_promo_cta_icon"}),translate(this.promo.options[0].ctaText)))))}getPromoText(e,t){const o=t===NOT_SAFE?"ADULT":e,i=this.promo[o];if(!i)return"";return i[Math.floor(Math.random()*i.length)]}shouldShowPopupPromo(){if(!this.promo||!this.promo.enable||!this.promo.options.length)return!1;var e=this.store.getState();const t=e.serpPopupCounter;return!e.user.isPremiumUser&&(!!t&&(t+1)%this.promo.frequency==0)}showPopup(e,t,o){this.preparePopupData(e,o);const i=this.isMobileView()?this.mobilePopup({info:this.info}):this.desktopPopup({info:this.info,isOnboarding:this.isOnboarding,positionInfo:t});ReactDOM.render(React.createElement(ReactRedux.Provider,{store:this.store},React.createElement("div",null,i)),document.querySelector("."+POPUP_CONTAINER))}showFirstTooltip(e,t){ReactDOM.render(React.createElement(ReactRedux.Provider,{store:this.store},React.createElement("div",{style:e},React.createElement(ShieldOnBoarding,{closePopup:this.immediateClearPopup,shieldColor:this.info.shieldColor,safety:this.info.safety,color:this.info.shieldColor,step:this.step,onboarding:this.info.onboarding,dispatch:this.store.dispatch,isFlipped:t}))),document.querySelector("."+POPUP_CONTAINER))}isMobileView(){return window.innerWidth<=450||window.innerHeight<=450}fixRightOverflow(e){const t=document.body.offsetWidth;return e+320>t&&(e=t-320),e}getPopupPositioning(e){if(this.isMobileView())return;var t=this.getPosition(document.getElementById(e));const o=t.left,i=t.top,s=t.bottom,n={},r=document.documentElement.clientHeight,a=this.shouldShowPopupPromo()?310:270;let l,c;return n.position="fixed",this.isOnboarding?(l=i+a>r+window.scrollY,c=36,l?(n.bottom=r-(i-window.scrollY)-c+"px",n.left=o+"px"):(n.position="absolute",n.left=o-4+"px")):(l=i+a>r,c=18,l&&(n.bottom=r-s-c+"px"),n.left=this.fixRightOverflow(o)+"px"),n.top=l?"auto":i+"px",n.zIndex="2147483646",{styles:n,isBottomOfPage:l}}clearPopup(){this.isOnboarding&&this.step<5||this.immediateClearPopup()}immediateClearPopup(){document.querySelector("."+POPUP_OVERLAY).classList.remove("wot-open");const e=document.querySelector("."+POPUP_CONTAINER);e.innerHTML&&(e.innerHTML="",window.postMessage({type:SHIELD_HOVER_EVENT,id:""},window.location.origin),this.store.dispatch(incrementPopUpCounter()))}onLogoClick(){GA("Search Popup","WOT Logo "+this.info.shieldColor,this.info.host),webextApi.runtime.sendMessage({name:OPEN_TAB_MESSAGE,url:`${MAIN_PAGE_URL}?${WOT_PRODUCT}=addon`})}onCTAClick(e){const t=_slicedToArray(this.promo.options,1)[0],o=t.utmSource+e;goUpgrade("Search Popup","promo clicked "+this.info.shieldColor,o,t.coupon,t.id)}onSettingsClick(){GA("Search Popup","Settings "+(this.info.shieldColor.charAt(0).toUpperCase()+this.info.shieldColor.substr(1).toLowerCase()),getEncodedDomain(window.location.href)),webextApi.runtime.sendMessage({name:OPEN_TAB_MESSAGE,url:`${OPTIONS_URL}?serpid=${this.serpid}`})}onInfoClick(){GA("Search Popup","Learn More"),webextApi.runtime.sendMessage({name:OPEN_TAB_MESSAGE,url:LEARN_MORE_URL})}initOnboarding(){if(this.isMobileView()||!this.isOnboarding||0!==this.step)return;let e;const t=Array.from(document.querySelectorAll(".wot_shield:not(.shield_gray)")).find(t=>(e=this.getPosition(t),e.top>14));if(!e||!t)return;const o={position:"absolute",left:e.left+23+"px",zIndex:"2147483646"},i=e.top-130<0;o.top=(i?e.top+164:e.top-14)+"px",this.showFirstTooltip(o,i)}getPosition(e){"string"==typeof e&&(e=document.querySelector(e));const t=e.getBoundingClientRect();let o=t.top,i=t.left;const s=t.bottom;if(this.isOnboarding&&this.step<5){const e=document.body.getBoundingClientRect();o-=e.top,i-=e.left}return{top:o,left:i,bottom:s}}}