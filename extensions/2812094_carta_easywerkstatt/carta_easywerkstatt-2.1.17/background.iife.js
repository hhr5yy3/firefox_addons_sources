(function(){"use strict";var X=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Q={exports:{}};(function(e,a){(function(s,n){n(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:X,function(s){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)s.exports=globalThis.browser;else{const n="The message port closed before a response was received.",g=m=>{const f={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(f).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class p extends WeakMap{constructor(t,o=void 0){super(o),this.createItem=t}get(t){return this.has(t)||this.set(t,this.createItem(t)),super.get(t)}}const C=r=>r&&typeof r=="object"&&typeof r.then=="function",L=(r,t)=>(...o)=>{m.runtime.lastError?r.reject(new Error(m.runtime.lastError.message)):t.singleCallbackArg||o.length<=1&&t.singleCallbackArg!==!1?r.resolve(o[0]):r.resolve(o)},y=r=>r==1?"argument":"arguments",O=(r,t)=>function(l,...u){if(u.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${y(t.minArgs)} for ${r}(), got ${u.length}`);if(u.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${y(t.maxArgs)} for ${r}(), got ${u.length}`);return new Promise((h,d)=>{if(t.fallbackToNoCallback)try{l[r](...u,L({resolve:h,reject:d},t))}catch(i){console.warn(`${r} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,i),l[r](...u),t.fallbackToNoCallback=!1,t.noCallback=!0,h()}else t.noCallback?(l[r](...u),h()):l[r](...u,L({resolve:h,reject:d},t))})},R=(r,t,o)=>new Proxy(t,{apply(l,u,h){return o.call(u,r,...h)}});let T=Function.call.bind(Object.prototype.hasOwnProperty);const _=(r,t={},o={})=>{let l=Object.create(null),u={has(d,i){return i in r||i in l},get(d,i,w){if(i in l)return l[i];if(!(i in r))return;let c=r[i];if(typeof c=="function")if(typeof t[i]=="function")c=R(r,r[i],t[i]);else if(T(o,i)){let P=O(i,o[i]);c=R(r,r[i],P)}else c=c.bind(r);else if(typeof c=="object"&&c!==null&&(T(t,i)||T(o,i)))c=_(c,t[i],o[i]);else if(T(o,"*"))c=_(c,t[i],o["*"]);else return Object.defineProperty(l,i,{configurable:!0,enumerable:!0,get(){return r[i]},set(P){r[i]=P}}),c;return l[i]=c,c},set(d,i,w,c){return i in l?l[i]=w:r[i]=w,!0},defineProperty(d,i,w){return Reflect.defineProperty(l,i,w)},deleteProperty(d,i){return Reflect.deleteProperty(l,i)}},h=Object.create(r);return new Proxy(h,u)},k=r=>({addListener(t,o,...l){t.addListener(r.get(o),...l)},hasListener(t,o){return t.hasListener(r.get(o))},removeListener(t,o){t.removeListener(r.get(o))}}),N=new p(r=>typeof r!="function"?r:function(o){const l=_(o,{},{getContent:{minArgs:0,maxArgs:0}});r(l)}),A=new p(r=>typeof r!="function"?r:function(o,l,u){let h=!1,d,i=new Promise($=>{d=function(b){h=!0,$(b)}}),w;try{w=r(o,l,d)}catch($){w=Promise.reject($)}const c=w!==!0&&C(w);if(w!==!0&&!c&&!h)return!1;const P=$=>{$.then(b=>{u(b)},b=>{let j;b&&(b instanceof Error||typeof b.message=="string")?j=b.message:j="An unexpected error occurred",u({__mozWebExtensionPolyfillReject__:!0,message:j})}).catch(b=>{console.error("Failed to send onMessage rejected reply",b)})};return P(c?w:i),!0}),v=({reject:r,resolve:t},o)=>{m.runtime.lastError?m.runtime.lastError.message===n?t():r(new Error(m.runtime.lastError.message)):o&&o.__mozWebExtensionPolyfillReject__?r(new Error(o.message)):t(o)},H=(r,t,o,...l)=>{if(l.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${y(t.minArgs)} for ${r}(), got ${l.length}`);if(l.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${y(t.maxArgs)} for ${r}(), got ${l.length}`);return new Promise((u,h)=>{const d=v.bind(null,{resolve:u,reject:h});l.push(d),o.sendMessage(...l)})},re={devtools:{network:{onRequestFinished:k(N)}},runtime:{onMessage:k(A),onMessageExternal:k(A),sendMessage:H.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:H.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},U={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return f.privacy={network:{"*":U},services:{"*":U},websites:{"*":U}},_(m,re,f)};s.exports=g(chrome)}})})(Q);var M=(e=>(e.Local="local",e.Sync="sync",e.Managed="managed",e.Session="session",e))(M||{});async function I(e,a){function s(g){return typeof g=="function"}function n(g){return g instanceof Promise}return s(e)?n(e)?await e(a):e(a):e}let B=!1;function V(e){if(chrome.storage[e]===void 0)throw new Error(`Check your storage permission in manifest.json: ${e} is not defined`)}function W(e,a,s){var k,N;let n=null,g=[];const m=(s==null?void 0:s.storageType)??"local",f=(s==null?void 0:s.liveUpdate)??!1,p=((k=s==null?void 0:s.serialization)==null?void 0:k.serialize)??(A=>A),C=((N=s==null?void 0:s.serialization)==null?void 0:N.deserialize)??(A=>A);B===!1&&m==="session"&&(s==null?void 0:s.sessionAccessForContentScripts)===!0&&(V(m),chrome.storage[m].setAccessLevel({accessLevel:"TRUSTED_AND_UNTRUSTED_CONTEXTS"}).catch(A=>{console.warn(A),console.warn("Please call setAccessLevel into different context, like a background script.")}),B=!0);const L=async()=>{V(m);const A=await chrome.storage[m].get([e]);return C(A[e])??a},y=()=>{g.forEach(A=>A())},O=async A=>{n=await I(A,n),await chrome.storage[m].set({[e]:p(n)}),y()},R=A=>(g=[...g,A],()=>{g=g.filter(v=>v!==A)}),T=()=>n;L().then(A=>{n=A,y()});async function _(A){if(A[e]===void 0)return;const v=C(A[e].newValue);n!==v&&(n=await I(v,n),y())}return f&&chrome.storage[m].onChanged.addListener(_),{get:L,set:O,getSnapshot:T,subscribe:R}}function E(e,a){if(!a)return!1;const s=a.urlRegex;if(s)return new RegExp(s).test(e);const n=new URL(e),g=`${n.protocol}//${n.host}${n.pathname}`,m=n.pathname;return a.urls.some(f=>f.toString().toLowerCase().includes(g==null?void 0:g.replace(m,"/")))}const x=W("carta-config-storage-key",{},{storageType:M.Local,liveUpdate:!0}),S={...x,getCssSelectorsFromCurrentShop:async()=>{let{currentShop:e}=await x.get();return E(window.location.href,e==null?void 0:e.shopInfo)||(e=await F()),(e==null?void 0:e.cssSelectors)||[]},getXPathsFromCurrentShop:async()=>{let{currentShop:e}=await x.get();return E(window.location.href,e==null?void 0:e.shopInfo)||(e=await F()),(e==null?void 0:e.xPaths)||{}},getShopInfoFromCurrentShop:async()=>{let{currentShop:e}=await x.get();return E(window.location.href,e==null?void 0:e.shopInfo)||(e=await F()),(e==null?void 0:e.shopInfo)||{}},getParseTypeFromCurrentShop:async()=>{let{currentShop:e}=await x.get();return E(window.location.href,e==null?void 0:e.shopInfo)||(e=await F()),(e==null?void 0:e.type)||""},setNewCurrentShop:async e=>{const{allShops:a,cartaConfig:s}=await x.get();await x.set({currentShop:e,allShops:a,cartaConfig:s})},setAllShops:async e=>{const{currentShop:a,cartaConfig:s}=await x.get();await x.set({currentShop:a,allShops:e,cartaConfig:s})},setCartaConfig:async e=>{const{currentShop:a,allShops:s}=await x.get();await x.set({currentShop:a,allShops:s,cartaConfig:e})},setCurrentShopFromList:async()=>await F()};async function F(){const{allShops:e,cartaConfig:a}=await x.get();let s=e;if(!e&&(await Z(),s=await x.get().then(m=>m.allShops),!s))return{};const n=window.location.href,g=s.find(m=>E(n,m.shopInfo));return g&&await x.set({currentShop:g,allShops:s,cartaConfig:a}),g||{}}const q=W("carta-current-shopname-key","",{storageType:M.Local,liveUpdate:!0}),Y={...q,isCurrentShop:async e=>!!(await q.get()).includes(e==null?void 0:e.toLowerCase())};let z=!1,G=!1,J=!1;chrome.storage.local.get(["__DEV__","__STAGING__","__PROD__"],e=>{z=e.__DEV__,G=e.__STAGING__,J=e.__PROD__});async function Z(e=!1){var n;const a=D(),s=await S.get();if((n=s==null?void 0:s.cartaConfig)!=null&&n.configVersion||await K(),!e)await ee();else{if(!window)return;const{currentShop:g}=await S.get();if(!(g!=null&&g._id))return;const m=window.location.href;await Y.set(m),await fetch(`${a}/shops?id=${g._id}`).then(f=>f.text()).then(async f=>{if(!f||f==="OK")return;const p=JSON.parse(f);await S.setNewCurrentShop(p)})}}async function ee(){const e=D();await K(),await fetch(`${e}/shops`).then(a=>a.text()).then(async a=>{if(!a||a==="OK")return;const s=JSON.parse(a);await S.setAllShops(s)})}async function K(){const e=D(),a=await(await fetch(`${e}/config`)).text();let s="",n={};const g=/^\d+\.\d+\.\d+$/,m=a.match(g);m?s=m[0]:(n=JSON.parse(a),s=(n==null?void 0:n.configVersion)||a);const f=await S.get().then(p=>{var C;return(C=p==null?void 0:p.cartaConfig)==null?void 0:C.configVersion});s!==f&&await S.setCartaConfig(n||{configVersion:s,chatUrls:[]})}function D(){return G?"https://api.staging.easywerkstatt.com/app/carta":J?"https://api.easywerkstatt.com/app/carta":"http://localhost:3001/carta"}async function se(e){const a=new Blob([JSON.stringify(e)],{type:"application/json"}),s=new FormData;s.append("files[]",a,"page.json");try{const n=await fetch("https://uguu.se/upload",{method:"POST",body:s});if(!(n!=null&&n.ok))throw new Error(`File upload failed: ${n==null?void 0:n.statusText}`);const g=await n.json();return g.files&&g.files.length>0?g.files[0].url:null}catch(n){return console.error("Error uploading file:",n),null}}chrome.storage.local.set({__DEV__:!1,__STAGING__:!1,__PROD__:!0}),Z(!1),chrome.runtime.onMessage.addListener((e,a,s)=>{if(e.type==="UPLOAD_FILE")return se(e.data).then(n=>{s({success:!0,url:n})}).catch(n=>{s({success:!1,error:n})}),!0})})();
