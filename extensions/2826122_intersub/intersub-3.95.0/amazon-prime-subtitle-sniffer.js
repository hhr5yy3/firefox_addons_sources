(()=>{"use strict";class e{constructor(){this.logDebugMessage=(...e)=>{this.logMessage(t.DEBUG,...e)},this.logInfo=(...e)=>{this.logMessage(t.INFO,...e)},this.logWarn=(...e)=>{this.logMessage(t.WARN,...e)},this.logError=(...e)=>{this.logMessage(t.ERROR,...e)}}}var t;!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR"}(t||(t={}));const s="x-session";function i(e,t){if(function(){const e=globalThis;if(void 0!==e.cloneInto)return e}()){const s=globalThis.content,i=s?.fetch;if("function"==typeof i)return i(e,t)}return fetch(e,t)}class o extends e{constructor(e,t,s,i,o){super(),this.logServerUrl=e,this.publicTokenProvider=t,this.urlProvider=s,this.pluginDataProvider=i,this.logLevel=o,this.batchSize=50,this.batch=[],this.maxSendTimeout=1e4,this.sendTimeoutId=0,this.messageId=1e3*globalThis.crypto.getRandomValues(new Uint8Array(1))[0],window&&window.addEventListener("beforeunload",(()=>{this.sendBatch()}))}logMessage(e,...s){if(e<this.logLevel)return;const i=t[e],o=[];for(const e of s)e instanceof Error?o.push(JSON.parse(JSON.stringify(e,Object.getOwnPropertyNames(e)))):o.push(e);this.batch.push({eventType:i,timestamp:Date.now(),url:this.urlProvider(),pluginData:this.pluginDataProvider(),messageId:++this.messageId,data:JSON.stringify(o)}),this.sendBatchIfNeeded()}clearSendBatchTimeout(){this.sendTimeoutId&&(clearTimeout(this.sendTimeoutId),this.sendTimeoutId=0)}sendBatchIfNeeded(){this.batch.length<this.batchSize?this.sendTimeoutId||(this.sendTimeoutId=Number(setTimeout((()=>{this.sendBatch()}),this.maxSendTimeout))):this.sendBatch()}sendBatch(){if(this.clearSendBatchTimeout(),!this.batch.length)return;const e=function(e,t,i,o,a,n,r="text/plain"){const l=new URL(i,e);let c=new Headers({"Content-Type":r});a?(c.set("Accept",a),t&&(c=function(e,t){if(!t)return e;const i="Accept",o=e.get(i);if(!o)throw new Error(`Invalid headers object: it doesn't have ${i} header!`);return e.set(i,`${o};${s}=${t}`)||e}(c,t))):t&&t&&c.set(s,t);const d={credentials:"omit",method:o,headers:c};return void 0!==n&&(d.body=JSON.stringify(n)),{url:l.toString(),options:d}}(this.logServerUrl,this.publicTokenProvider(),this.logServerUrl,"POST","application/vnd.intersub.log.response.v1+json",[...this.batch]);this.batch.length=0,i(e.url,e.options)}}var a,n,r,l;!function(e){e.ALL="ALL",e.YOUTUBE="YOUTUBE",e.COURSERA="COURSERA",e.NETFLIX="NETFLIX",e.HDREZKA="HDREZKA",e.TED="TED",e.KINOPUB="KINOPUB",e.LORD_FILM="LORD_FILM",e.OTHER="OTHER",e.INTERSUB_LANDING="INTERSUB_LANDING",e.INTERSUB_DEV="INTERSUB_DEV",e.SOAP4ME="SOAP4ME",e.TWO_SUB_MOVIE="TWO_SUB_MOVIE",e.INORIGINAL="INORIGINAL",e.AMAZON_PRIME="AMAZON_PRIME",e.LINKEDIN_LEARNING="LINKEDIN_LEARNING",e.UDEMY="UDEMY",e.CRUNCHYROLL="CRUNCHYROLL",e.ORORO="ORORO"}(a||(a={})),function(e){e.getTypeName=function(){return"ExternalVideoServiceType"},e.values=[e.ALL,e.YOUTUBE,e.COURSERA,e.NETFLIX,e.HDREZKA,e.TED,e.KINOPUB,e.LORD_FILM,e.OTHER,e.INTERSUB_LANDING,e.INTERSUB_DEV,e.SOAP4ME,e.TWO_SUB_MOVIE,e.INORIGINAL,e.AMAZON_PRIME,e.LINKEDIN_LEARNING,e.UDEMY,e.CRUNCHYROLL,e.ORORO]}(a||(a={})),function(e){e.SUBTITLES="SUBTITLES"}(n||(n={})),function(e){e.SEND_SUBS="SEND_SUBS",e.INIT="INIT"}(r||(r={})),function(e){e.SEASON="season",e.MOVIE="movie"}(l||(l={})),new Map;const c=new class extends e{logMessage(e,...s){switch(e){case t.DEBUG:console.debug("AMAZON_PRIME_SUBTITLES_LOG: debug",e,...s);break;case t.INFO:console.debug("AMAZON_PRIME_SUBTITLES_LOG: info",e,...s);break;case t.WARN:console.debug("AMAZON_PRIME_SUBTITLES_LOG: warn",e,...s);break;case t.ERROR:console.error("AMAZON_PRIME_SUBTITLES_LOG: error",e,...s)}this.sentryLogger?.logMessage(e,s)}setSentryLogger(e){this.sentryLogger=e}};class d{get resolved(){return this._resolved}get rejected(){return this._rejected}get settled(){return this.resolved||this.rejected}constructor(){this._resolved=!1,this._rejected=!1,this.promise=new Promise(((e,t)=>{this.resolveFn=e,this.rejectFn=t}))}reject(e){this._rejected=!0,this._rejectedVal=e,this.rejectFn(e)}resolve(e){this._resolved=!0,this._resolvedVal=e,this.resolveFn(e)}get resolvedValue(){return this._resolvedVal}get rejectedValue(){return this._rejectedVal}}const u=new Map,h=new Map;function g(e){return u.has(e)||u.set(e,new d),u.get(e)}function p(e){return h.has(e)||h.set(e,new d),h.get(e)}var f;window.addEventListener("is_amazon_prime_command",(e=>{const t=e.detail;switch(c.logDebugMessage(`AMAZON_PRIME_SUBTITLE: Received command ${t.type}`),t.type){case r.SEND_SUBS:(async function(e){if(e)return g(e).promise.then((t=>({payload:{[e]:{gti:e,asin:t.asin,title:t.title,subtitles:Object.fromEntries(t.map),timingShifts:t.cuepointFulfillmentAssetList,audioTracks:t.audioTracks}}})));{const e={};for(const[t,s]of u.entries())if(s.resolved){const i=s.resolvedValue;e[t]={gti:t,asin:i.asin,title:i.title,subtitles:Object.fromEntries(i.map),timingShifts:i.cuepointFulfillmentAssetList,audioTracks:i.audioTracks}}return{payload:e}}})(t.data).then((e=>{window.dispatchEvent(new CustomEvent("is_amazon_prime_subtitles",{detail:{type:n.SUBTITLES,data:e}}))})).catch((e=>{c.logDebugMessage(`AMAZON_PRIME_SUBTITLES_LOG: Subtitle loading was interrupted ${e}`)}));break;case r.INIT:{const e=t.data;a.AMAZON_PRIME,window.location.href,c.setSentryLogger(new o(e.logServerUrl,(()=>e.publicToken),(()=>window.location.href),(()=>e.pluginData),e.logLevel));break}}})),f=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=function(e,t,s,i,o){let a;a="string"==typeof t?new URL(t,location.href):t;let n=t;if(a.pathname.endsWith("/GetPlaybackResources")){const e="desiredResources",t=a.searchParams.get(e);if(t){const s=t.split(",");if(-1!==s.indexOf("CatalogMetadata")){const t=["SubtitleUrls"];let i=!1;for(const e of t)-1===s.indexOf(e)&&(s.push(e),i=!0);const o=["CuepointPlaylist"];for(const e of o){const t=s.indexOf(e);-1!==t&&(s.splice(t,1),i=!0)}i&&(a.searchParams.set(e,s.join(",")),n=a.toString()),this.addEventListener("load",(()=>{"string"==typeof this.response&&this.response&&function(e){try{const t=JSON.parse(e);if(!t)return;const s=t?.catalogMetadata?.catalog?.id;if(!s)return;const i=t?.subtitleUrls;if(!i)return;const o=g(s);if(o.settled)return;const a=new Map;for(const e of i)a.set(e.languageCode,e);const n=t?.cuepointPlaylist?.cuepointFulfillmentMetadata?.cuepointFulfillmentAssetList?.map((e=>({cardType:e.cardType,duration:e.duration,playhead:e.playhead})))||[];o.resolve({gti:t.catalogMetadata.catalog.id,asin:t.returnedTitleRendition.asin,title:t.catalogMetadata.catalog.title,map:a,cuepointFulfillmentAssetList:n,audioTracks:t?.catalogMetadata?.playback.audioTracks.map((e=>({id:e.id,displayName:e.displayName,language:e.language,type:e.type})))})}catch(e){c.logError("Failed to parse playbackResources")}}(this.response)}),!1)}}}if(-1!==a.pathname.indexOf("/playerChromeResources/")){const e="desiredResources",t=a.searchParams.get(e);if(t){const s=t.split(","),i=["catalogMetadataV2"];let o=!1;for(const e of i)-1===s.indexOf(e)&&(s.push(e),o=!0);o&&(a.searchParams.set(e,s.join(",")),n=a.toString());const r=a.searchParams.get("entityId");this.addEventListener("load",(()=>{"string"==typeof this.response&&this.response&&function(e,t){try{const s=JSON.parse(t);if(!s)return void c.logError("Failed to parse playerChromeResources to obtain catalog metadata");const i=p(e);if(i.settled)return;i.resolve(s)}catch(e){c.logError("Failed to parse playerChromeResources")}}(r,this.response)}),!1)}}if(a.pathname.endsWith("/GetVodPlaybackResources")){const e=a.searchParams.get("titleId");this.addEventListener("load",(()=>{"string"==typeof this.response&&this.response&&function(e,t){try{const s=JSON.parse(t);if(!s)return;const i=g(e);if(i.settled)return;const o=s?.timedTextUrls?.result?.subtitleUrls;if(!o)return;const a=new Map;for(const e of o)a.set(e.languageCode,e);p(e).promise.then((t=>{i.resolve({gti:e,asin:e,title:t.resources.catalogMetadataV2.catalog.title,map:a,cuepointFulfillmentAssetList:[],audioTracks:s?.vodPlaybackUrls?.result?.playbackUrls?.audioTracks.map((e=>({id:e.audioTrackId,displayName:e.displayName,language:e.languageCode,type:e.audioSubtype})))})}))}catch(e){c.logError("Failed to parse vodPlaybackResources")}}(e,this.response)}),!1)}const r=void 0===s||s;f.apply(this,[e,n,r,i,o])}})();