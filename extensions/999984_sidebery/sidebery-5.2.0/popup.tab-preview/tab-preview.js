var ADDON_HOST=browser.runtime.getURL(""),SIDEBAR_URL=browser.runtime.getURL("/sidebar/sidebar.html"),GROUP_URL=browser.runtime.getURL("/sidebery/group.html"),GROUP_URL_LEN=GROUP_URL.length,URL_URL=browser.runtime.getURL("/sidebery/url.html"),URL_URL_LEN=URL_URL.length,SETUP_URL=browser.runtime.getURL("/page.setup/setup.html"),SEARCH_URL=browser.runtime.getURL("/popup.search/search.html");var NOID=-1;function getInstanceName(instance){return instance===2?"sidebar":instance===0?"bg":instance===3?"setup":instance===1?"group":instance===6?"proxy":instance===5?"url":instance===4?"search":instance===7?"preview":"unknown"}var _type="unknown",_winId="",_tabId="";function warn(msg,...args){console.warn(`[${_type}${_winId}${_tabId}] ${msg}`,...args)}function err(msg,err2){msg=`[${_type}${_winId}${_tabId}] ${msg}
`,err2!==void 0?console.error(msg,err2):console.error(msg)}var CONNECT_CONFIRMATION_MAX_DELAY=5e3,actions,_localType=-1,_localWinId=NOID,_localTabId=NOID,state={bgConnection:void 0,searchPopupConnections:new Map,sidebarConnections:new Map,setupPageConnections:new Map,groupPageConnections:new Map,previewConnection:void 0};function setInstanceType(type){_localType=type}function registerActions(a){actions=a}function getConnection(type,id){if(type===0&&state.bgConnection)return state.bgConnection;if(type===2)return state.sidebarConnections.get(id);if(type===3)return state.setupPageConnections.get(id);if(type===4)return state.searchPopupConnections.get(id);if(type===1)return state.groupPageConnections.get(id);if(type===7)return state.previewConnection}function createConnection(type,id){let connection={type,id,reconnectCount:0};return type===0?state.bgConnection=connection:type===2?state.sidebarConnections.set(id,connection):type===3?state.setupPageConnections.set(id,connection):type===4?state.searchPopupConnections.set(id,connection):type===1?state.groupPageConnections.set(id,connection):type===7&&(state.previewConnection=connection),connection}var connectingTimeout;function connectTo(dstType,dstWinId=NOID,dstTabId=NOID){let srcType=_localType,srcWinId=_localWinId,srcTabId=_localTabId,toBg=dstType===0,toSidebar=dstType===2,toSetup=dstType===3,toSearch=dstType===4,toGroup=dstType===1,toPreview=dstType===7,id;if(toBg||toPreview)id=NOID;else if((toSidebar||toSearch)&&dstWinId!==NOID)id=dstWinId;else if((toSetup||toGroup)&&dstTabId!==NOID)id=dstTabId;else{err("IPC.connectTo: No destination id");return}let portNameData={srcType,dstType};srcWinId!==NOID&&(portNameData.srcWinId=srcWinId),srcTabId!==NOID&&(portNameData.srcTabId=srcTabId),dstWinId!==NOID&&(toSidebar||toSearch)&&(portNameData.dstWinId=dstWinId),dstTabId!==NOID&&(toSetup||toGroup)&&(portNameData.dstTabId=dstTabId);let portNameJson=JSON.stringify(portNameData),connection,connectionIsNew=!1,existedConnection=getConnection(dstType,id);existedConnection?connection=existedConnection:(connectionIsNew=!0,connection=createConnection(dstType,id)),connection.localPort&&connection.localPort.disconnect(),connection.localPort=browser.runtime.connect({name:portNameJson}),connection.postListener=msg=>{onPostMsg(msg,connection.localPort)},connection.localPort.onMessage.addListener(connection.postListener),connection.disconnectListener=port=>{port.onMessage.removeListener(connection.postListener),port.onDisconnect.removeListener(connection.disconnectListener),resolveUnfinishedCommunications(port),connection.localPort=void 0;let connectionIsRemoved=!1;if(connection.remotePort||(connectionIsRemoved=!0,toBg?state.bgConnection=void 0:toSidebar?state.sidebarConnections.delete(dstWinId):toSetup?state.setupPageConnections.delete(dstTabId):toSearch?state.searchPopupConnections.delete(dstWinId):toGroup?state.groupPageConnections.delete(dstTabId):toPreview&&(state.previewConnection=void 0)),connectionIsRemoved){let handlers=disconnectionHandlers.get(dstType);handlers&&handlers.forEach(cb=>cb(connection.id))}toBg&&connection.reconnectCount++<3&&(clearTimeout(connectingTimeout),connectingTimeout=setTimeout(()=>connectTo(dstType,dstWinId),120))},connection.localPort.onDisconnect.addListener(connection.disconnectListener),clearTimeout(connectingTimeout),connectingTimeout=setTimeout(()=>{connection.localPort&&!connection.localPort.error?connection.reconnectCount=0:err("IPC.connectTo: Cannot reconnect")},120);let conConfirmId=toBg?-1:-2,timeout=setTimeout(()=>{warn("IPC.connectTo: No confirmation:",getInstanceName(dstType)),msgsWaitingForAnswer.delete(conConfirmId)},CONNECT_CONFIRMATION_MAX_DELAY);return msgsWaitingForAnswer.set(conConfirmId,{timeout,portName:"",ok:()=>{if(connectionIsNew){let handlers=connectionHandlers.get(dstType);handlers&&handlers.forEach(cb=>cb(connection.id))}}}),connection.localPort}var msgsWaitingForAnswer=new Map;var connectionHandlers=new Map;var disconnectionHandlers=new Map;function runActionFor(msg){if(msg.action!==void 0&&actions){let action=actions[msg.action];if(action)return msg.arg?action(msg.arg):msg.args?action(...msg.args):action()}}var runningAsyncActions=new Map;async function onPostMsg(msg,port){if(msg<0){let waiting=msgsWaitingForAnswer.get(msg);waiting&&(clearTimeout(waiting.timeout),waiting.ok&&waiting.ok(),msgsWaitingForAnswer.delete(-1));return}if(typeof msg=="number"){let waiting=msgsWaitingForAnswer.get(msg);waiting&&clearTimeout(waiting.timeout);return}if(!msg.action&&msg.id){let waiting=msgsWaitingForAnswer.get(msg.id);waiting&&(clearTimeout(waiting.timeout),msg.error&&waiting.err?waiting.err(msg.error):waiting.ok&&waiting.ok(msg.result),msgsWaitingForAnswer.delete(msg.id));return}let result,error;try{result=runActionFor(msg)}catch(err2){error=String(err2),err(`IPC.onPostMsg: Error on running "${String(msg.action)}" action:`,err2)}if(msg.id&&port)if(result instanceof Promise){let msgId=msg.id;try{port.postMessage(msgId)}catch(err2){err(`IPC.onPostMsg: Error on sending "${String(msg.action)}" action confirm:`,err2);return}let finalResult,error2;try{runningAsyncActions.set(msgId,port.name),finalResult=await result}catch(err2){error2=String(err2)}if(runningAsyncActions.has(msgId))runningAsyncActions.delete(msgId);else return;try{port.postMessage({id:msgId,result:finalResult,error:error2})}catch(err2){err(`IPC.onPostMsg: Error on sending "${String(msg.action)}" action result:`,err2);return}}else try{port.postMessage({id:msg.id,result,error})}catch(err2){err(`IPC.onPostMsg: Error on sending "${String(msg.action)}" action result:`,err2)}}function resolveUnfinishedCommunications(port){for(let[msgId,waiting]of msgsWaitingForAnswer)waiting.portName===port.name&&(clearTimeout(waiting.timeout),waiting.err&&waiting.err("IPC: Target disconnected"),msgsWaitingForAnswer.delete(msgId));for(let[msgId,portName]of runningAsyncActions)portName===port.name&&runningAsyncActions.delete(msgId)}var state2={tabId:NOID,winId:NOID,unloaded:!1,titleEl:null,urlEl:null},previewConf={format:"jpeg",quality:90,scale:window.devicePixelRatio/2};async function main(){let params=new URL(window.location.href).searchParams;document.body.style.setProperty("--bg",params.get("bg")),document.body.style.setProperty("--fg",params.get("fg")),document.body.style.setProperty("--hbg",params.get("hbg")),document.body.style.setProperty("--hfg",params.get("hfg")),state2.titleEl=document.getElementById("title"),state2.titleEl&&(state2.titleEl.innerText=params.get("title")??""),state2.urlEl=document.getElementById("url"),state2.urlEl&&(state2.urlEl.innerText=params.get("url")??"");let winId=parseInt(params.get("winId")??"");isNaN(winId)||(state2.winId=winId);let tabId=parseInt(params.get("tabId")??"");isNaN(tabId)||(state2.tabId=tabId);let scale=parseFloat(params.get("scale")??"");if(isNaN(scale)||(previewConf.scale=scale),state2.unloaded=!!params.get("off"),!state2.unloaded){let preview=await browser.tabs.captureTab(state2.tabId,previewConf).catch(()=>"");state2.tabId===tabId&&setPreview(preview)}document.addEventListener("keyup",e=>{e.code==="Escape"&&window.close()}),document.addEventListener("blur",()=>window.close()),setInstanceType(7),connectTo(2,state2.winId),registerActions({updatePreview,setY:()=>{},close:()=>{}})}var previewElN=0,previewEl1=document.getElementById("preview_1"),previewEl2=document.getElementById("preview_2");function setPreview(preview){!previewEl1||!previewEl2||(previewElN?(previewElN=0,previewEl1.style.setProperty("opacity","1"),previewEl1.style.setProperty("background-image",preview?`url("${preview}")`:"none"),previewEl2.style.setProperty("opacity","0")):(previewElN++,previewEl2.style.setProperty("opacity","1"),previewEl2.style.setProperty("background-image",preview?`url("${preview}")`:"none"),previewEl1.style.setProperty("opacity","0")))}async function updatePreview(tabId,title,url,unloaded){if(state2.titleEl&&(state2.titleEl.innerText=title),state2.urlEl&&(state2.urlEl.innerText=url),state2.tabId=tabId,state2.unloaded=unloaded,state2.unloaded)setPreview("");else{let preview=await browser.tabs.captureTab(tabId,previewConf).catch(()=>"");state2.tabId===tabId&&setPreview(preview)}}main();
