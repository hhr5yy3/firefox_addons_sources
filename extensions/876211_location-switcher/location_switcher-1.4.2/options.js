!function(w,d,b,f){const defaultIconPath="icons/default.svg";var targetImage,targetInput;function Route(from,to,iconPath,looped,disabled){this.source=from||"",this.destination=to||"",this.iconPath=iconPath||defaultIconPath,this.looped=looped||!1,this.disabled=disabled||!1,this.iconPath=this.iconPath.replace("icons/light/","icons/"),this.iconPath=this.iconPath.replace("icons/dark/","icons/"),this.valid=function(){return""!==this.source||""!==this.destination},this.flatten=function(){return[this.source,this.destination,this.looped,this.iconPath,this.disabled]}}function handleError(error){console.log(error)}function insertOptionAfter(node,data){const box=function(){const elements=[],_img=d.createElement("img");_img.src="icons/default.svg",_img.classList="icon icon-button",elements.push(_img);const _source=d.createElement("input");_source.type="url",_source.name="source[]",_source.value="",_source.placeholder="http://",elements.push(_source);const _target=d.createElement("input");_target.type="url",_target.name="target[]",_target.value="",_target.placeholder="http://",elements.push(_target);const _loop=d.createElement("input");_loop.type="checkbox",_loop.name="loop[]",_loop.value=1,_loop.checked=!0,elements.push(_loop);const _disabled=d.createElement("input");_disabled.type="checkbox",_disabled.name="disabled[]",_disabled.value=1,_disabled.checked=!1,elements.push(_disabled);const box=d.createElement("div");box.className="row";for(let e of elements){const wrap=d.createElement("div");wrap.appendChild(e),box.appendChild(wrap)}const _icon=d.createElement("input");_icon.type="hidden",_icon.name="icon[]",_icon.value="";const _addButton=d.createElement("button");_addButton.type="button",_addButton.className="add-button",_addButton.innerText="+";const _delButton=d.createElement("button");_delButton.type="button",_delButton.className="del-button",_delButton.innerText="-";const wrap=d.createElement("div");return wrap.appendChild(_addButton),wrap.appendChild(_delButton),wrap.appendChild(_icon),box.appendChild(wrap),box}();if(data){let route=new Route(data[0],data[1],data[3],data[2],data[4]);box.querySelector("input[name='source[]']").value=route.source,box.querySelector("input[name='target[]']").value=route.destination,box.querySelector("input[name='icon[]']").value=route.iconPath,box.querySelector("input[name='loop[]']").checked=route.looped,box.querySelector("input[name='disabled[]']").checked=route.disabled,route.iconPath.startsWith("<?xml")||route.iconPath.startsWith("<svg")?box.querySelector(".icon").src="data:image/svg+xml;base64,"+b64EncodeUnicode(route.iconPath):box.querySelector(".icon").src=route.iconPath,box.querySelector(".icon").data=route.iconPath}node?node.parentNode.insertBefore(box,node.nextSibling):d.querySelector(".content").appendChild(box)}function showIconModal(display){if(d.getElementById("modal").style.display=display?"block":"none",targetImage.src.startsWith("data:image/svg+xml;base64,")){let value=(str=targetImage.src.replace("data:image/svg+xml;base64,",""),decodeURIComponent(atob(str).split("").map(function(c){return"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)}).join("")));d.querySelector("[name='custom']").value=value}else targetImage.src.startsWith("http")?d.querySelector("[name='custom']").value=targetImage.src:d.querySelector("[name='custom']").value="";var str}function b64EncodeUnicode(str){return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,function(match,p1){return String.fromCharCode("0x"+p1)}))}d.addEventListener("DOMContentLoaded",function(){b.storage.sync.get(null).then(res=>{if(res.data){let total=res.data.length||0;for(var i=0;i<total;i++)insertOptionAfter(null,res.data[i])}insertOptionAfter(),f.elements.dark_theme.checked=res.darkThemeEnabled||!1,f.elements.sort.checked=res.sortEnabled||!1,f.elements.force_popup.checked=res.forcePopupEnabled||!1},handleError)}),d.querySelector("form").addEventListener("submit",function(){let darkThemeEnabled=f.elements.dark_theme.checked,sortEnabled=f.elements.sort.checked,forcePopupEnabled=f.elements.force_popup.checked,data=function(e){for(var data=[],total=e["source[]"].length||1,i=0;i<total;i++){let source=(e["source[]"][i]||e["source[]"]).value.trim(),target=(e["target[]"][i]||e["target[]"]).value.trim(),icon=(e["icon[]"][i]||e["icon[]"]).value.trim(),loop=(e["loop[]"][i]||e["loop[]"]).checked||!1,disabled=(e["disabled[]"][i]||e["disabled[]"]).checked||!1,route=new Route(source,target,icon,loop,disabled);route.valid()&&data.push(route.flatten())}return data}(f.elements);b.storage.sync.set({data:data,darkThemeEnabled:darkThemeEnabled,sortEnabled:sortEnabled,forcePopupEnabled:forcePopupEnabled}),b.runtime.reload(),alert("Saved and reloaded.")}),d.addEventListener("click",e=>{if("add-button"==e.target.className)insertOptionAfter(e.target.parentNode.parentNode);else if("del-button"==e.target.className)e.target.parentNode.parentNode.remove(),d.querySelectorAll(".content .row").length<=0&&insertOptionAfter();else if(e.target.classList.contains("icon-button"))targetImage=e.target,targetInput=e.target.parentElement.parentElement.querySelector("[name='icon[]']"),showIconModal(!0);else if("icon"==e.target.className)targetImage.src=e.target.attributes.src.value,targetInput.value=e.target.attributes.src.value,showIconModal(!1);else if("custom-icon-button"==e.target.className){var value=d.querySelector("[name='custom']").value;""===value?targetImage.src=defaultIconPath:value.startsWith("<?xml")||value.startsWith("<svg")?targetImage.src="data:image/svg+xml;base64,"+b64EncodeUnicode(value):targetImage.src=value,targetInput.value=value,showIconModal(!1)}}),d.getElementById("export-button").addEventListener("click",()=>{b.storage.sync.get(null).then(res=>{var json=[];if(res.data&&res.data.length>0)for(const item of res.data){let route=new Route(item[0],item[1],item[3],item[2],item[4]);route.valid()&&json.push(route)}else json.push(new Route("http://localhost/sub","https://sub.example.com","",!0,!1)),json.push(new Route("http://localhost","https://example.com","",!0,!1));const blob=new Blob([JSON.stringify(json,null,4)],{type:"application/json"}),url=URL.createObjectURL(blob),a=d.createElement("a");a.href=url,a.download="location-switcher-addon.json",a.click(),URL.revokeObjectURL(url)})}),d.getElementById("import-button").addEventListener("change",e=>{const file=e.target.files[0]||null;if(!file||!file.type.match("application/json"))return;const reader=new FileReader;reader.onload=(()=>{try{const json=JSON.parse(reader.result);d.querySelector(".content").innerHTML="";for(const item of json){let route=new Route(item.source,item.destination,item.iconPath,item.looped,item.disabled);route.valid()&&insertOptionAfter(null,route.flatten())}insertOptionAfter()}catch(error){alert(error)}}),reader.readAsText(file)})}(window,document,browser,document.forms.form);