(()=>{"use strict";var __assign=function(){return(__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)},__awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};function createTab(url){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return[4,("object"==typeof browser?browser:chrome).tabs.create({url})];case 1:return[2,_a.sent()]}}))}))}function localStorageGet(keys){return new Promise((function(resolve,reject){chrome.storage.local.get(keys,(function(storage){resolve(storage)}))}))}var Background_assign=function(){return(Background_assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)},Background_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},Background_generator=function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},__spreadArray=function(to,from,pack){if(pack||2===arguments.length)for(var ar,i=0,l=from.length;i<l;i++)!ar&&i in from||(ar||(ar=Array.prototype.slice.call(from,0,i)),ar[i]=from[i]);return to.concat(ar||Array.prototype.slice.call(from))};function recordNavigationEvent(url,transitionType,transitionQualifiers,recording){return Background_awaiter(this,void 0,void 0,(function(){var navigationEvent,newRecording;return Background_generator(this,(function(_a){switch(_a.label){case 0:return navigationEvent={type:"navigate",url,transitionType,transitionQualifiers},newRecording=__spreadArray(__spreadArray([],recording,!0),[Background_assign({},navigationEvent)],!1),[4,chrome.storage.local.set({recording:newRecording})];case 1:return _a.sent(),[2]}}))}))}function onNavEvent(details){return Background_awaiter(this,void 0,void 0,(function(){var tabId,url,transitionType,transitionQualifiers,frameId,_a,recording,recordingTabId,recordingState;return Background_generator(this,(function(_b){switch(_b.label){case 0:return tabId=details.tabId,url=details.url,transitionType=details.transitionType,transitionQualifiers=details.transitionQualifiers,frameId=details.frameId,[4,localStorageGet(["recording","recordingState","recordingTabId"])];case 1:return _a=_b.sent(),recording=_a.recording,recordingTabId=_a.recordingTabId,recordingState=_a.recordingState,0!==frameId||"active"!==recordingState||recordingTabId!==tabId?[2]:[4,recordNavigationEvent(url,transitionType,transitionQualifiers,recording)];case 2:return _b.sent(),[2]}}))}))}function updateContextMenuItems(_a){var enabled=_a.enabled;chrome.contextMenus.update("deploysentinel-menu-id",{enabled}),chrome.contextMenus.update("deploysentinel-menu-await-text-id",{enabled})}chrome.runtime.onMessage.addListener((function(request,sender,sendResponse){var _a;return Background_awaiter(this,void 0,void 0,(function(){var testEditorTabId,newUrl,newTab,tabId;return Background_generator(this,(function(_b){switch(_b.label){case 0:return"start-recording"!==request.type?[3,2]:(testEditorTabId=null===(_a=sender.tab)||void 0===_a?void 0:_a.id,[4,createTab(newUrl=request.url)]);case 1:if(newTab=_b.sent(),null==(tabId=newTab.id))throw new Error("New tab id not defined");return function(tabId,newUrl,returnTabId){var storage=__assign({recordingState:"active",recordingTabId:tabId,recording:[{type:"load",url:newUrl}]},null!=returnTabId?{returnTabId}:{});chrome.storage.local.set(storage)}(tabId,newUrl,testEditorTabId),[3,3];case 2:"forward-recording"===request.type&&(chrome.tabs.update(request.tabId,{active:!0}),chrome.tabs.sendMessage(request.tabId,{type:"playwright-test-recording",code:request.code,actions:request.actions})),_b.label=3;case 3:return[2]}}))}))})),chrome.tabs.onRemoved.addListener((function(tabId){return Background_awaiter(void 0,void 0,void 0,(function(){var recordingTabId;return Background_generator(this,(function(_a){switch(_a.label){case 0:return[4,localStorageGet(["recordingTabId"])];case 1:return recordingTabId=_a.sent().recordingTabId,tabId==recordingTabId&&chrome.storage.local.set({recordingState:"finished",recordingTabId:null,returnTabId:null}),[2]}}))}))})),chrome.webNavigation.onHistoryStateUpdated.addListener(onNavEvent),chrome.webNavigation.onReferenceFragmentUpdated.addListener(onNavEvent),chrome.webNavigation.onCommitted.addListener(onNavEvent),chrome.webNavigation.onCompleted.addListener((function(details){return Background_awaiter(void 0,void 0,void 0,(function(){var tabId,_a,recordingTabId,recordingState;return Background_generator(this,(function(_b){switch(_b.label){case 0:return tabId=details.tabId,0!==details.frameId?[2]:[4,localStorageGet(["recordingTabId","recordingState"])];case 1:return _a=_b.sent(),recordingTabId=_a.recordingTabId,recordingState=_a.recordingState,tabId!=recordingTabId||"active"!=recordingState?[2]:(function(tabId,file){__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return"object"!=typeof browser?[3,2]:[4,browser.tabs.executeScript(tabId,{file})];case 1:return _a.sent(),[3,4];case 2:return[4,chrome.scripting.executeScript({target:{tabId},files:[file]})];case 3:_a.sent(),_a.label=4;case 4:return[2]}}))}))}(tabId,"contentScript.bundle.js"),[2])}}))}))})),chrome.contextMenus.removeAll(),chrome.contextMenus.create({title:"Record hover over element",contexts:["all"],id:"deploysentinel-menu-id",enabled:!1}),chrome.contextMenus.create({title:"Assert/wait for selected text",contexts:["selection"],id:"deploysentinel-menu-await-text-id",enabled:!1}),chrome.contextMenus.onClicked.addListener((function(info,tab){return Background_awaiter(void 0,void 0,void 0,(function(){var recordingTabId,type;return Background_generator(this,(function(_a){switch(_a.label){case 0:return void 0===tab?[2]:[4,localStorageGet(["recordingTabId"])];case 1:return recordingTabId=_a.sent().recordingTabId,tab.id!=recordingTabId?[2]:(type="deploysentinel-menu-id"===info.menuItemId?"onHoverCtxMenu":"onAwaitTextCtxMenu",chrome.tabs.sendMessage(recordingTabId,{type,selectionText:info.selectionText}),[2])}}))}))})),localStorageGet(["recordingState"]).then((function(_a){updateContextMenuItems("active"===_a.recordingState?{enabled:!0}:{enabled:!1})})),chrome.storage.onChanged.addListener((function(changes){var _a,_b,_c,_d;(null===(_a=null==changes?void 0:changes.recordingState)||void 0===_a?void 0:_a.oldValue)!==(null===(_b=null==changes?void 0:changes.recordingState)||void 0===_b?void 0:_b.newValue)&&("active"==(null===(_c=null==changes?void 0:changes.recordingState)||void 0===_c?void 0:_c.newValue)&&updateContextMenuItems({enabled:!0}),"finished"==(null===(_d=null==changes?void 0:changes.recordingState)||void 0===_d?void 0:_d.newValue)&&updateContextMenuItems({enabled:!1}))}))})();