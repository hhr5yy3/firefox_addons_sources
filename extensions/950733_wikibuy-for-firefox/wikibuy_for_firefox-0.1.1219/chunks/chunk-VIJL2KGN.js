import{D as se,E as le,G as ce}from"./chunk-OEPSEZ5A.js";import{c as M}from"./chunk-3GYLW4KZ.js";var G=M(j=>{"use strict";var V=j&&j.__awaiter||function(o,n,t,a){function i(e){return e instanceof t?e:new t(function(u){u(e)})}return new(t||(t=Promise))(function(e,u){function l(s){try{r(a.next(s))}catch(d){u(d)}}function c(s){try{r(a.throw(s))}catch(d){u(d)}}function r(s){s.done?e(s.value):i(s.value).then(l,c)}r((a=a.apply(o,n||[])).next())})},z=j&&j.__generator||function(o,n){var t={label:0,sent:function(){if(e[0]&1)throw e[1];return e[1]},trys:[],ops:[]},a,i,e,u;return u={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(u[Symbol.iterator]=function(){return this}),u;function l(r){return function(s){return c([r,s])}}function c(r){if(a)throw new TypeError("Generator is already executing.");for(;u&&(u=0,r[0]&&(t=0)),t;)try{if(a=1,i&&(e=r[0]&2?i.return:r[0]?i.throw||((e=i.return)&&e.call(i),0):i.next)&&!(e=e.call(i,r[1])).done)return e;switch(i=0,e&&(r=[r[0]&2,e.value]),r[0]){case 0:case 1:e=r;break;case 4:return t.label++,{value:r[1],done:!1};case 5:t.label++,i=r[1],r=[0];continue;case 7:r=t.ops.pop(),t.trys.pop();continue;default:if(e=t.trys,!(e=e.length>0&&e[e.length-1])&&(r[0]===6||r[0]===2)){t=0;continue}if(r[0]===3&&(!e||r[1]>e[0]&&r[1]<e[3])){t.label=r[1];break}if(r[0]===6&&t.label<e[1]){t.label=e[1],e=r;break}if(e&&t.label<e[2]){t.label=e[2],t.ops.push(r);break}e[2]&&t.ops.pop(),t.trys.pop();continue}r=n.call(o,t)}catch(s){r=[6,s],i=0}finally{a=e=0}if(r[0]&5)throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}};Object.defineProperty(j,"__esModule",{value:!0});var fe=ce(),de=new Set(["and","or","not","regex","listContains","equals","elementExists"]),me=new Set(["url","protocol","domain","path","search","cookie","userCountry","domContent"]),he=function(){function o(n){var t=n.url,a=n.protocol,i=n.domain,e=n.pathname,u=n.search,l=n.country,c=n.getCookie;Object.assign(this,{url:t,protocol:a,domain:i,pathname:e,search:u,country:l,getCookie:c}),this.testElementExistAttemptCount=0,this.elementExistsTimeoutMs=2e3}return o.prototype.getContextValueForOperation=function(n){return V(this,void 0,void 0,function(){var t;return z(this,function(a){if(t=n.context,!me.has(t))throw new Error("Unsupported context [".concat(t,"]"));return t==="url"?[2,this.url]:t==="protocol"?[2,this.protocol]:t==="domain"?[2,this.domain]:t==="path"?[2,this.pathname]:t==="search"?[2,this.search]:t==="cookie"?[2,this.getCookie(n.name)]:t==="userCountry"?[2,this.country]:[2]})})},o.prototype.test=function(n,t){return t===void 0&&(t=!1),V(this,void 0,void 0,function(){var e,a,i,c,e,u,l,c,s,r,s,s,d;return z(this,function(f){switch(f.label){case 0:if(!de.has(n.operator))return console.log("Unsupported operator [".concat(n.operator,"]")),[2,!1];if(n.operator!=="and")return[3,5];if(!Array.isArray(n.value))throw new Error("The value of operator `and` must be an array");e=!0,a=0,i=n.value,f.label=1;case 1:return a<i.length?(c=i[a],[4,this.test(c,t)]):[3,4];case 2:if(!f.sent())return e=!1,[3,4];f.label=3;case 3:return a++,[3,1];case 4:return[2,e];case 5:if(n.operator!=="not")return[3,7];if(Array.isArray(n.value))throw new Error("The value of operator `not` must be a single condition");return[4,this.test(n.value,t)];case 6:return[2,f.sent()===!1];case 7:if(n.operator!=="or")return[3,12];if(!Array.isArray(n.value))throw new Error("The value of operator `or` must be an array");e=!1,u=0,l=n.value,f.label=8;case 8:return u<l.length?(c=l[u],[4,this.test(c,t)]):[3,11];case 9:if(f.sent())return e=!0,[3,11];f.label=10;case 10:return u++,[3,8];case 11:return[2,e];case 12:return n.operator!=="regex"?[3,14]:[4,this.getContextValueForOperation(n)];case 13:return s=f.sent(),typeof s!="string"?[2,!1]:(r=n.value||n.pattern,[2,r&&!!s.match(new RegExp(r,n.flags||""))]);case 14:return n.operator!=="listContains"?[3,16]:[4,this.getContextValueForOperation(n)];case 15:return s=f.sent(),[2,Array.isArray(n.value)&&n.value.includes(s)];case 16:return n.operator!=="equals"?[3,18]:[4,this.getContextValueForOperation(n)];case 17:return s=f.sent(),[2,n.value===s];case 18:return n.operator!=="elementExists"?[3,22]:t?[3,19]:[2,!1];case 19:return f.trys.push([19,21,,22]),[4,this.testElementExists(n.value)];case 20:return[2,f.sent()];case 21:return d=f.sent(),console.log("program rules error",d),[2,null];case 22:return[2,!1]}})})},o.prototype.hasDomContentRule=function(n){var t=!1,a=function(i){if(Array.isArray(i.value))for(var e=0,u=i.value;e<u.length;e++){var l=u[e];a(l)}i.context==="domContent"&&(t=!0)};return a(n),t},o.prototype.testClientRules=function(n,t){return V(this,void 0,void 0,function(){var a;return z(this,function(i){switch(i.label){case 0:return t&&(this.elementExistsTimeoutMs=t),[4,this.test(n,!0)];case 1:return a=i.sent(),[2,{matched:a,elementExistTestCount:this.testElementExistAttemptCount}]}})})},o.prototype.testElementExists=function(n){return V(this,void 0,void 0,function(){var t,a,i=this;return z(this,function(e){return t=100,a=this.elementExistsTimeoutMs/t,[2,new fe.Promise(function(u,l){var c=document.querySelectorAll(n);if(c.length>0)return u(!0);try{var r=0,s=setInterval(function(){r++;var d=document.querySelectorAll(n);if(i.testElementExistAttemptCount++,d.length>0)return clearInterval(s),u(!0);if(r>=a)return clearInterval(s),u(!1)},t)}catch(d){return l(d)}})]})})},o}();j.default=he});var Z=M(O=>{"use strict";var ve=O&&O.__awaiter||function(o,n,t,a){function i(e){return e instanceof t?e:new t(function(u){u(e)})}return new(t||(t=Promise))(function(e,u){function l(s){try{r(a.next(s))}catch(d){u(d)}}function c(s){try{r(a.throw(s))}catch(d){u(d)}}function r(s){s.done?e(s.value):i(s.value).then(l,c)}r((a=a.apply(o,n||[])).next())})},pe=O&&O.__generator||function(o,n){var t={label:0,sent:function(){if(e[0]&1)throw e[1];return e[1]},trys:[],ops:[]},a,i,e,u;return u={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(u[Symbol.iterator]=function(){return this}),u;function l(r){return function(s){return c([r,s])}}function c(r){if(a)throw new TypeError("Generator is already executing.");for(;u&&(u=0,r[0]&&(t=0)),t;)try{if(a=1,i&&(e=r[0]&2?i.return:r[0]?i.throw||((e=i.return)&&e.call(i),0):i.next)&&!(e=e.call(i,r[1])).done)return e;switch(i=0,e&&(r=[r[0]&2,e.value]),r[0]){case 0:case 1:e=r;break;case 4:return t.label++,{value:r[1],done:!1};case 5:t.label++,i=r[1],r=[0];continue;case 7:r=t.ops.pop(),t.trys.pop();continue;default:if(e=t.trys,!(e=e.length>0&&e[e.length-1])&&(r[0]===6||r[0]===2)){t=0;continue}if(r[0]===3&&(!e||r[1]>e[0]&&r[1]<e[3])){t.label=r[1];break}if(r[0]===6&&t.label<e[1]){t.label=e[1],e=r;break}if(e&&t.label<e[2]){t.label=e[2],t.ops.push(r);break}e[2]&&t.ops.pop(),t.trys.pop();continue}r=n.call(o,t)}catch(s){r=[6,s],i=0}finally{a=e=0}if(r[0]&5)throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}},ge=O&&O.__spreadArray||function(o,n,t){if(t||arguments.length===2)for(var a=0,i=n.length,e;a<i;a++)(e||!(a in n))&&(e||(e=Array.prototype.slice.call(n,0,a)),e[a]=n[a]);return o.concat(e||Array.prototype.slice.call(n))};Object.defineProperty(O,"__esModule",{value:!0});function ye(o){return o==null?!1:typeof o[Symbol.iterator]=="function"}function we(o){for(var n=[],t=1;t<arguments.length;t++)n[t-1]=arguments[t];var a=n.map(function(i){return typeof i=="number"||typeof i=="string"?i:ye(i)?Object.entries(i).sort(function(e,u){return u[0].localeCompare(e[0])}):i});return a.unshift(o),JSON.stringify(a)}var B=new Map;function be(){for(var o=Date.now(),n=0,t=B;n<t.length;n++){var a=t[n],i=a[0],e=a[1];e.expires<o&&B.delete(i)}}function Ce(o,n,t,a,i){return t===void 0&&(t=[]),a===void 0&&(a={expirationDuration:5e3}),i===void 0&&(i=null),ve(this,void 0,void 0,function(){var e,u,l,c,r,s;return pe(this,function(d){return be(),t||(t=[]),e=we.apply(void 0,ge([o],t,!1)),u=Date.now(),l=a.expirationDuration,c=u+l,r=B.get(e),r&&r.expires>=u?(r.expires=c,[2,a&&a.responsePromiseTransform?r.promise.then(a.responsePromiseTransform):r.promise]):(s=n.apply(void 0,t),s.then(function(f){var m=a&&a.preventCache&&a.preventCache(f);m&&B.delete(e)},function(f){B.delete(e),i&&i(f)}),B.set(e,{promise:s,expires:c}),[2,a&&a.responsePromiseTransform?s.then(a.responsePromiseTransform):s])})})}O.default=Ce});var $=M(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});var xe=Z();function ke(o,n,t){return n===void 0&&(n={}),t===void 0&&(t=null),(0,xe.default)("fetch",globalThis.fetch,[o,n],{expirationDuration:1e3*5,responsePromiseTransform:function(a){return a.clone()},preventCache:function(a){return!a.ok}},function(a){t&&t("Failed to fetch",{url:o},a)})}H.default=ke});var ee=M(J=>{"use strict";Object.defineProperty(J,"__esModule",{value:!0});function Te(o){o===void 0&&(o=[]);var n=o.find(function(t){return t.indexOf("c_ranker_")===0});if(n)return n.split("c_ranker_")[1]}J.default=Te});var X=M(Q=>{"use strict";Object.defineProperty(Q,"__esModule",{value:!0});var K=le(),De=["1password.com","pantheonsite.io"];function Pe(o){var n=K.getDomain(o);if(!n){var t=K.getPublicSuffix(o);if(De.includes(t))return t}var a=K.getSubdomain(o),i=a&&a.startsWith("www.")?a.substr(4):a,e="".concat(i,".").concat(n);return i&&i!=="www"?e:n}Q.default=Pe});var ae=M(b=>{"use strict";var g=b&&b.__assign||function(){return g=Object.assign||function(o){for(var n,t=1,a=arguments.length;t<a;t++){n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(o[i]=n[i])}return o},g.apply(this,arguments)},N=b&&b.__awaiter||function(o,n,t,a){function i(e){return e instanceof t?e:new t(function(u){u(e)})}return new(t||(t=Promise))(function(e,u){function l(s){try{r(a.next(s))}catch(d){u(d)}}function c(s){try{r(a.throw(s))}catch(d){u(d)}}function r(s){s.done?e(s.value):i(s.value).then(l,c)}r((a=a.apply(o,n||[])).next())})},_=b&&b.__generator||function(o,n){var t={label:0,sent:function(){if(e[0]&1)throw e[1];return e[1]},trys:[],ops:[]},a,i,e,u;return u={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(u[Symbol.iterator]=function(){return this}),u;function l(r){return function(s){return c([r,s])}}function c(r){if(a)throw new TypeError("Generator is already executing.");for(;u&&(u=0,r[0]&&(t=0)),t;)try{if(a=1,i&&(e=r[0]&2?i.return:r[0]?i.throw||((e=i.return)&&e.call(i),0):i.next)&&!(e=e.call(i,r[1])).done)return e;switch(i=0,e&&(r=[r[0]&2,e.value]),r[0]){case 0:case 1:e=r;break;case 4:return t.label++,{value:r[1],done:!1};case 5:t.label++,i=r[1],r=[0];continue;case 7:r=t.ops.pop(),t.trys.pop();continue;default:if(e=t.trys,!(e=e.length>0&&e[e.length-1])&&(r[0]===6||r[0]===2)){t=0;continue}if(r[0]===3&&(!e||r[1]>e[0]&&r[1]<e[3])){t.label=r[1];break}if(r[0]===6&&t.label<e[1]){t.label=e[1],e=r;break}if(e&&t.label<e[2]){t.label=e[2],t.ops.push(r);break}e[2]&&t.ops.pop(),t.trys.pop();continue}r=n.call(o,t)}catch(s){r=[6,s],i=0}finally{a=e=0}if(r[0]&5)throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}};Object.defineProperty(b,"__esModule",{value:!0});b.getProgramDataById=b.applyClientRules=void 0;var Ae=se(),Y=G(),L=$(),Ee=ee(),te=X(),re=globalThis.URL?globalThis.URL:Ae.URL;function Ie(o,n){var t,a=n.apiBase,i=n.sessionToken,e=n.ignoreCache,u=n.experience,l=n.omitCredentials,c=n.logError;return N(this,void 0,void 0,function(){var r,s,d,f,m,y,h;return _(this,function(v){switch(v.label){case 0:return r=i?{"x-wb-session":decodeURIComponent(i)}:void 0,s=e?{"cache-control":"no-cache"}:void 0,d=g(g({},r),s),f=l?{credentials:"omit"}:void 0,m=g({headers:d},f),[4,(0,L.default)("".concat(a,"/v1/programs/").concat(o).concat(u?"?experience=".concat(u):""),m,c)];case 1:return y=v.sent(),[4,y.json()];case 2:return h=v.sent(),[2,(t=h?.programs)===null||t===void 0?void 0:t.rules]}})})}function ne(o,n){var t=n.apiBase,a=n.sessionToken,i=n.features,e=n.extensionName,u=n.ignoreCache,l=n.vendorMetaId,c=n.omitCredentials,r=n.logError;return N(this,void 0,void 0,function(){var s,d,f,m,y,h,v,A,P,k,E,T,p,x,w,I;return _(this,function(S){switch(S.label){case 0:return s=a?{"x-wb-session":decodeURIComponent(a)}:void 0,d=u?{"cache-control":"no-cache"}:void 0,f=l?{"vendor-meta-id":l}:void 0,m=g(g(g({},s),d),f),y=c?{credentials:"omit"}:void 0,h=m?g({headers:m},y):void 0,v=(0,Ee.default)(i),A="?".concat(e?"extension=".concat(e):"").concat(v?"&ranker=".concat(v):""),P=(0,L.default)("".concat(t,"/v1/program/").concat(o,"/coupons").concat(A),h,r).then(function(D){return D.json()}),k=(0,L.default)("".concat(t,"/v1/program/").concat(o,"/rewards"),h,r).then(function(D){return D.json()}),E=(0,L.default)("".concat(t,"/v1/program/").concat(o),h,r).then(function(D){return D.json()}),[4,Promise.all([P,k,E])];case 1:return T=S.sent(),p=T[0],x=T[1],w=T[2],w.meta=Re(w?.meta,p?.meta),I=g(g({},w.siteData),{coupons:p?.coupons,cashback:x?.rewards}),[2,g(g({},w),{siteData:I})]}})})}function Re(o,n){return o===void 0&&(o={}),n===void 0&&(n={}),g(g({},o),n)}function Oe(o){var n=o.url,t=o.session,a=o.getCookie,i=o.apiBase,e=o.extensionName,u=o.ignoreCache,l=o.experience,c=o.platformDomain,r=o.vendorMetaId,s=o.omitCredentials,d=o.logError;return N(this,void 0,void 0,function(){var f,m,y,h,v,A,P,k,E,T,p,x,w,I,S,D,U,q,F;return _(this,function(R){switch(R.label){case 0:return f=c||(0,te.default)(n),m=new re(n),y=m.pathname,h=m.hostname,v=m.protocol,A=m.search,P=t.country,i=i||"https://capitaloneshopping.com/api",[4,Ie(f,{apiBase:i,ignoreCache:u,sessionToken:t.sessionToken,features:t.features,extensionName:e,experience:l,omitCredentials:s,logError:d})];case 1:k=R.sent(),E=k.filter(function(ie){var oe=ie.rulesTree,ue=new Y.default({url:n,domain:h,pathname:y,protocol:v,search:A,country:P,getCookie:a});return!ue.hasDomContentRule(oe)}),T=E.length<k.length,x=0,w=E,R.label=2;case 2:return x<w.length?(I=w[x],S=I.programId,D=I.rulesTree,U=new Y.default({url:n,domain:h,pathname:y,protocol:v,search:A,country:P,getCookie:a}),[4,U.test(D)]):[3,5];case 3:if(R.sent())return p=S,[3,5];R.label=4;case 4:return x++,[3,2];case 5:return!p&&!k.length?[2]:p?[4,ne(p,{apiBase:i,ignoreCache:u,sessionToken:t.sessionToken,features:t.features,extensionName:e,vendorMetaId:r,omitCredentials:s})]:[3,7];case 6:q=R.sent(),R.label=7;case 7:return F={program:q,deferredProgramSelection:T?k:null},[2,F]}})})}b.default=Oe;function Se(o,n,t,a,i){return N(this,void 0,void 0,function(){var e,u,l,c,r,s,d,f,m,y,h,v,A,P,k,E,T,p,x,w,I,S,D,U;return _(this,function(q){switch(q.label){case 0:e=(0,te.default)(n),u=new re(n),l=u.pathname,c=u.hostname,r=u.protocol,s=u.search,d=function(F,R){return F+=R.duration,F},f=[],m=0,y=0,h=o,q.label=1;case 1:return y<h.length?(v=h[y],m++,A=performance.now(),P=v.programId,k=v.rulesTree,E=new Y.default({url:n,protocol:r,domain:e,pathname:l,search:s,country:t,getCookie:a}),[4,E.testClientRules(k,i?.programAttemptTimeoutMs)]):[3,4];case 2:if(T=q.sent(),p=T.matched,x=T.elementExistTestCount,w=performance.now(),I=w-A,f.push({program:P,duration:I,attempts:x}),p)return S=f.reduce(d,0),[2,{programId:P,metrics:{totalDuration:S,programsTestedCount:m,attempts:f}}];q.label=3;case 3:return y++,[3,1];case 4:return D=f.reduce(d,0),U={totalDuration:D,programsTestedCount:m,attempts:f},[2,{metrics:U}]}})})}b.applyClientRules=Se;function qe(o,n){var t=n.session,a=n.apiBase,i=n.extensionName,e=n.ignoreCache,u=n.vendorMetaId,l=n.omitCredentials;return N(this,void 0,void 0,function(){var c;return _(this,function(r){switch(r.label){case 0:return a=a||"https://capitaloneshopping.com/api",[4,ne(o,{apiBase:a,ignoreCache:e,sessionToken:t.sessionToken,features:t.features,extensionName:i,vendorMetaId:u,omitCredentials:l})];case 1:return c=r.sent(),[2,c]}})})}b.getProgramDataById=qe});var Be=M(C=>{"use strict";Object.defineProperty(C,"__esModule",{value:!0});C.getSiteDomainFromUrl=C.ProgramRules=C.applyClientRules=C.getProgramDataById=C.getProgram=void 0;var W=ae();C.getProgram=W.default;Object.defineProperty(C,"getProgramDataById",{enumerable:!0,get:function(){return W.getProgramDataById}});Object.defineProperty(C,"applyClientRules",{enumerable:!0,get:function(){return W.applyClientRules}});var Me=G();C.ProgramRules=Me.default;var je=X();C.getSiteDomainFromUrl=je.default;C.default=W.default});export{Be as a};
