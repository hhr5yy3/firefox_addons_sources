var C=Object.defineProperty;var O=(t,e,s)=>e in t?C(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var c=(t,e,s)=>(O(t,typeof e!="symbol"?e+"":e,s),s);import{ax as v,ay as b,az as R,aA as L,aB as P,ab as M,aC as T,P as E,y as G,aD as $,D as V,aE as _,aF as j}from"./popupInitializer.bb4281b7.js";import{i as S}from"./pageInteraction.2f84ddce.js";const U=t=>t.hostname==="www.google.com",F="rcm",q=.5*3600*1e3;var z=(t=>(t.Deals="Google RCM",t.Coupons="Google Coupon RCM",t))(z||{});const n=class{constructor(e,s,a,r,i){c(this,"queries",new Map);this.localStorageService=e,this.requestService=s,this.userOptionsService=a,this.iconService=r,this.analytics=i}static create(){var e;return(e=n.instance)!=null||(n.instance=new n(v.create(F),b.create(),R.create(),L.create(),P.create())),n.instance}async init(){await this.localStorageService.init({queries:[]});const e=this.localStorageService.getValue("queries");e&&(this.queries=new Map(e),this.queries.forEach((s,a)=>{this.doReset(a)&&this.remove(a)}),this.sync())}async getSearchRcm({query:e,url:s,tabId:a}){const r=new URL(s);if(!U(r))return null;const i=this.userOptionsService.getOptionKeyValue(M.GoogleRcmInject);if(this.doReset(e)&&(this.put(e),this.sync()),!i||this.isDismissed(e))return null;const h=await(await this.requestService.fetch(`${T}/related-content/1/google-rcm?query=${encodeURIComponent(e)}`)).json();let f="Google RCM",g=h.total||0;return h.coupons&&(f="Google Coupon RCM",g=h.couponTotal||0),g<1?(this.analytics.trackEvent({category:`${f} - Not Shown`,action:"Insufficient Results",label:e,value:g},void 0,a),null):/\bebay\b/i.test(e)?(this.analytics.trackEvent({category:`${f} - Not Shown`,action:"Suppressed Keyword",label:e},void 0,a),null):(this.queries.has(e)||(this.put(e),this.sync()),this.iconService.activateIcon({tabId:a}),this.analytics.trackEvent({category:`${f}`,action:"Shown",label:e,value:g},void 0,a),f==="Google Coupon RCM"?this.getCouponRcmData(h,e):this.getDealRcmData(h,e))}getDealRcmData(e,s){var a,r;return{type:"Google RCM",query:s,totalResultCount:(a=e.total)!=null?a:0,deals:(r=e.deals)!=null?r:[],seeMoreDealsUrl:e.seeMoreLink}}getCouponRcmData(e,s){var a,r;return{type:"Google Coupon RCM",query:s,totalResultCount:(a=e.couponTotal)!=null?a:0,coupons:(r=e.coupons)!=null?r:[],merchant:e.store}}put(e,s=!1){this.queries.set(e,{lifetime:Date.now()+q,dismissed:s})}doReset(e){if(this.queries.has(e)){const s=this.queries.get(e);return!!(s&&s.lifetime<Date.now())}return null}remove(e){this.queries.delete(e)}hide(e){this.queries.has(e)&&(this.put(e,!0),this.sync())}sync(){const e=Array.from(this.queries,([s,a])=>[s,a]);this.localStorageService.setValue("queries",e)}isDismissed(e){var s;if(this.queries.has(e)){const{dismissed:a}=(s=this.queries.get(e))!=null?s:{};return!!a}return!1}};let d=n;c(d,"instance");var K=(t=>(t[t.AllowTrackingNotification=0]="AllowTrackingNotification",t[t.CouponAutoApplyManual=1]="CouponAutoApplyManual",t[t.GoogleDealRcm=2]="GoogleDealRcm",t[t.LoyaltyActivated=3]="LoyaltyActivated",t[t.LoyaltyActivateOffer=4]="LoyaltyActivateOffer",t[t.LoyaltyProductOffer=5]="LoyaltyProductOffer",t[t.LoyaltyReactivateOffer=6]="LoyaltyReactivateOffer",t[t.LoyaltySegmentedOffer=7]="LoyaltySegmentedOffer",t[t.LoyaltyStillActive=8]="LoyaltyStillActive",t[t.Onboarding=9]="Onboarding",t))(K||{}),B=Object.defineProperty,x=Object.getOwnPropertyDescriptor,I=(t,e,s,a)=>{for(var r=a>1?void 0:a?x(e,s):e,i=t.length-1,o;i>=0;i--)(o=t[i])&&(r=(a?o(e,s,r):o(r))||r);return a&&r&&B(e,s,r),r},Q=(t=>(t[t.Default=0]="Default",t[t.DealDetails=1]="DealDetails",t))(Q||{});const k=24*60*60;var y;let l=(y=class{constructor(t){this.localStorage=t}static create(){var t;return(t=l.instance)!=null||(l.instance=new this(v.create("slickdealsButton"))),l.instance}async init(){await this.localStorage.init({buttonDismissed:{dismissed:!1,dismissedTime:0,dismissedCount:0}})}async getSlickdealsButton({merchant:t,windowRoute:e,couponAutoApply:s}){if(await this.init(),!t||s.caaEnabled)return null;if(e){const[a,r]=e.split("?"),i=new URLSearchParams(r);return i.get("minimized")==="1"&&a===E.path?{type:1,props:{threadId:Number(i.get("threadId"))||0}}:null}return await this.shouldShowDefaultButton({merchant:t})?{type:0}:null}async setButtonDismissed(){const t=await this.localStorage.getValue("buttonDismissed");await this.localStorage.setValue("buttonDismissed",{dismissed:!0,dismissedTime:Math.floor(Date.now()/1e3),dismissedCount:t.dismissedCount+1})}async setButtonCoordinates(t){await this.localStorage.setValue("coordinates",{y:t})}async getButtonCoordinates(){const t=await this.localStorage.getValue("coordinates");return(t==null?void 0:t.y)||75}async shouldShowDefaultButton({merchant:t}){var e,s;return Boolean(t&&t.id!==G.Slickdeals&&(((e=t.deals)==null?void 0:e.length)||$(t)>0)&&!((s=t.config)!=null&&s.disableMerchantOnboarding)&&!t.suppressed&&!await this.isButtonDismissed())}async isButtonDismissed(){const t=await this.localStorage.getValue("buttonDismissed");return t!=null&&t.dismissed?(t.dismissedCount<3&&t.dismissedTime+k<=Date.now()/1e3&&(t.dismissed=!1,await this.localStorage.setValue("buttonDismissed",t)),t.dismissed):!1}},c(y,"instance"),y);l=I([S],l);var J=Object.defineProperty,W=Object.getOwnPropertyDescriptor,X=(t,e,s,a)=>{for(var r=a>1?void 0:a?W(e,s):e,i=t.length-1,o;i>=0;i--)(o=t[i])&&(r=(a?o(e,s,r):o(r))||r);return a&&r&&J(e,s,r),r},Y=(t=>(t.FirstCaaSeen="f-caa",t.FirstDdsbSeen="f-ddsb",t.FirstRewardsTooltipSeen="f-rt",t))(Y||{}),w;let p=(w=class{constructor(t){this.userActionsStorage=t}static create(){var t;return p.instance=(t=p.instance)!=null?t:new this(v.create("ua")),p.instance}async init(){await this.userActionsStorage.init({})}async get(t){return await this.init(),this.userActionsStorage.getValue(t)}async getAll(){return await this.init(),this.userActionsStorage.getAll()}async set(t){return await this.init(),this.userActionsStorage.setValue(t.key,t.value)}},c(w,"instance"),w);p=X([S],p);var Z=(t=>(t[t.CouponAutoApply=0]="CouponAutoApply",t[t.CouponAutoApplyLoyalty=1]="CouponAutoApplyLoyalty",t[t.LoyaltyActivateOffer=2]="LoyaltyActivateOffer",t[t.LoyaltyReactivateOffer=3]="LoyaltyReactivateOffer",t))(Z||{});class N{static create(){return new this}createNotification(e,{title:s,message:a}){V.notifications.create(e,{type:"basic",title:s,message:a!=null?a:""})}}var H=(t=>(t[t.SegmentedOffer=14]="SegmentedOffer",t))(H||{}),tt=(t=>(t.Initial="initial",t.Activating="activating",t.Complete="complete",t))(tt||{});function D(t){const{startDate:e,endDate:s}=t,a=new Date,r=new Date(e),i=new Date(s);return r<=a&&i>=a}function A(t){var e,s;return(s=(e=t.store)==null?void 0:e.storeRate)!=null&&s.indexOf("%")?Number.parseInt(t.store.storeRate,10):0}const u=class{constructor(e,s,a){this.auth=e,this.loyaltyRepository=s,this.browserNotificationService=a}static create(){var e;return(e=u.instance)!=null||(u.instance=new this(_.create(),j.create(),N.create())),u.instance}async getActiveMerchantOffers(e){const s=await this.loyaltyRepository.getMerchantOffers(e,await this.auth.getUserId());if({}.ENABLE_CASHBACK_OFFER_NOTIFICATION){const a=s[0];a&&this.browserNotificationService.createNotification(`${a.offerId}`,{title:"New Cashback Offer Available!"})}return s.filter(D).sort((a,r)=>A(r)-A(a))}async getActiveProductOffers(e,s){return(await this.loyaltyRepository.getProductOffers(e,s,await this.auth.getUserId())).filter(D)}getProductSkuFromUrl(e){var a,r,i;const s=new URL(e);if(/ebay\.com/.test(s.hostname)&&/\/itm\//.test(s.pathname))return(a=s.pathname.match(/\/(\d+)[/|$|?]?/))==null?void 0:a[1];if(/samsung\.com/.test(s.hostname)&&/-\w+-\w+\/$/.test(s.pathname))return(r=s.pathname.match(/-(\w+-\w+)\/$/))==null?void 0:r[1];if(/sears\.com/.test(s.hostname)&&/\/p-\w+/.test(s.pathname)){const o=(i=s.pathname.match(/\/p-(\w+)/))==null?void 0:i[1];if(!o)return null;if(o.charAt(0)==="A")return o.substring(1,o.length);if(o.charAt(o.length-1)==="P")return o.substring(0,o.length-1)}return/verizon\.com/.test(s.hostname)&&s.searchParams.has("sku")?s.searchParams.get("sku"):null}};let m=u;c(m,"instance");export{Z as H,K as I,tt as L,Q as S,Y as U,z as a,m as b,H as c,l as d,p as e,d as f,U as i};
