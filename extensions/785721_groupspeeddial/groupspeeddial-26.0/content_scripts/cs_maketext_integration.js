(()=>{"use strict";const e=e=>!!e,t=e=>new Promise((t=>setTimeout(t,e)));function r(){let e,t;return[new Promise(((r,n)=>{e=r,t=n})),e,t]}const n="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope;class s{subscribers=[];addOnChange(e){this.subscribers.push(e)}removeOnChange(e){this.subscribers=this.subscribers.filter((t=>t!==e))}hasOnChange(e){return this.subscribers.includes(e)}notifyChange(e){this.subscribers.forEach((t=>{try{t(e)}catch(e){}}))}}const o=void 0;class a extends s{storageArea;onChanged;constructor(e){super(),this.storageArea=e,this.onChanged=new BroadcastChannel(`web_ext_storage.${this.storageArea}.onChanged`),this.onChanged.onmessage=e=>{const t=e.data;this.notifyChange(t)},this.onChanged.onmessageerror=console.error}async notifyAllContexts(e){this.notifyChange(e),await o,this.onChanged.postMessage(e)}async withDb(e){const t=self.indexedDB.open(`web_ext_storage.${this.storageArea}`,1);return new Promise(((e,r)=>{t.onerror=()=>r(t.error),t.onsuccess=()=>e(t.result),t.onupgradeneeded=()=>{const e=t.result;e.objectStoreNames.contains("data")||e.createObjectStore("data",{keyPath:"key"})}})).then(e).finally((()=>t.result.close()))}async getMultipleItems(t,r){const n=r.map((e=>new Promise(((r,n)=>{const s=t.get(e);s.onerror=()=>n(s.error),s.onsuccess=()=>r(s.result)}))));return Object.fromEntries((await Promise.all(n)).filter(e).map((e=>[e.key,e.value])))}async get(e){return this.withDb((async t=>{const r=t.transaction("data","readonly").objectStore("data");if(Array.isArray(e))return this.getMultipleItems(r,e);const n=r.getAll(e);return new Promise(((e,t)=>{n.onerror=()=>t(n.error),n.onsuccess=()=>e(n.result.reduce(((e,{key:t,value:r})=>(e[t]=r,e)),{}))}))}))}async set(e){return this.withDb((async t=>{const r=t.transaction("data","readwrite"),n=r.objectStore("data"),s=await this.getMultipleItems(n,Object.keys(e)),o={};for(const[t,r]of Object.entries(e))n.put({key:t,value:r}),o[t]={oldValue:s[t],newValue:r};return new Promise(((e,t)=>{r.onerror=()=>t(r.error),r.oncomplete=()=>{this.notifyAllContexts(o),e()}}))}))}async remove(e){return this.withDb((async t=>{const r=t.transaction("data","readwrite"),n=r.objectStore("data");e=Array.isArray(e)?e:[e];const s=await this.getMultipleItems(n,e);for(const t of e)n.delete(t);return new Promise(((t,n)=>{r.onerror=()=>n(r.error),r.oncomplete=()=>{const r={};for(const t of e)r[t]={oldValue:s[t]};this.notifyAllContexts(r),t()}}))}))}async clear(){return this.withDb((async e=>{const t=e.transaction("data","readwrite");return t.objectStore("data").clear(),new Promise(((e,r)=>{t.onerror=()=>r(t.error),t.oncomplete=()=>e()}))}))}async getBytesInUse(){return this.withDb((async e=>{const t=e.transaction("data","readonly").objectStore("data").getAll();return new Promise(((e,r)=>{t.onerror=()=>r(t.error),t.onsuccess=()=>{const r=t.result.reduce(((e,{key:t,value:r})=>e+t.length+JSON.stringify(r).length),0);e(r)}}))}))}static getBrowserPolyfill(e){const t=new a(e);return"session"===e&&n&&self.addEventListener("activate",(()=>t.clear())),{get:t.get.bind(t),set:t.set.bind(t),remove:t.remove.bind(t),clear:t.clear.bind(t),getBytesInUse:t.getBytesInUse.bind(t),onChanged:{addListener:t.addOnChange.bind(t),removeListener:t.removeOnChange.bind(t),hasListener:t.hasOnChange.bind(t)}}}}class i{_callback;promise;constructor(e){this._callback=e}execute(){return this.promise||(this.promise=this._callback().finally((()=>{this.promise=void 0}))),this.promise}}const c=(e,t,r)=>{const s=r.value;return r.value=function(...e){if(n)return s.apply(this,e)},r};function l(e,t,r,n){var s,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var i=e.length-1;i>=0;i--)(s=e[i])&&(a=(o<3?s(a):o>3?s(t,r,a):s(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}class d extends s{broadcast;storage;constructor(){super(),this.broadcast=new BroadcastChannel("web_ext_alarms"),this.storage=a.getBrowserPolyfill("_internal_alarms"),this.infiniteAlarmsCheck()}async clearAll(){return await this.storage.clear(),!0}async clear(e=""){const{[e]:t}=await this.storage.get(e);return!!t&&(await this.storage.remove(e),!0)}async create(e,t){const[r,n]="string"==typeof e?[e,t]:["",e],s=Date.now(),o={name:r,scheduledTime:n.periodInMinutes?this.computeNextRun(n.periodInMinutes):n.when||s+6e4*(n.delayInMinutes||0),periodInMinutes:n.periodInMinutes};o.scheduledTime<s?this.notifyAllContexts(o):await this.storage.set({[r]:o})}async get(e=""){const{[e]:t}=await this.storage.get(e);return t}async getAll(){const e=await this.storage.get();return Object.values(e)}async infiniteAlarmsCheck(){for(;;)await this.checkForDueAlarms(),await t(12e3)}async checkForDueAlarms(){const e=Date.now(),t=(await this.getAll()).filter((t=>t.scheduledTime<=e));for(const e of t)this.notifyAllContexts(e),e.periodInMinutes?(e.scheduledTime=this.computeNextRun(e.periodInMinutes),await this.storage.set({[e.name]:e})):await this.storage.remove(e.name)}computeNextRun(e){return Date.now()+6e4*e}async notifyAllContexts(e){this.notifyChange(e),await o,this.broadcast.postMessage(e)}static getBrowserPolyfill(){const e=new d;return{get:e.get.bind(e),getAll:e.getAll.bind(e),create:e.create.bind(e),clear:e.clear.bind(e),clearAll:e.clearAll.bind(e),onAlarm:{addListener:e.addOnChange.bind(e),hasListener:e.hasOnChange.bind(e),removeListener:e.removeOnChange.bind(e)}}}}l([c],d.prototype,"infiniteAlarmsCheck",null),l([c,(e,t,r)=>{let n;const s=r.value,o=new i((async()=>s.apply(n)));r.value=function(){return n=this,o.execute()}}],d.prototype,"checkForDueAlarms",null);"moz-extension:"===self.location.protocol&&(browser.windows||(browser.windows={}),browser.windows.getCurrent||(browser.windows.getCurrent=async e=>{const t=await browser.tabs.query({}),r=t.find((e=>e.active));return{id:r?.windowId??1,title:r?.title??"",focused:!0,alwaysOnTop:!1,incognito:!!browser.extension.inIncognitoContext,...e?.populate?{tabs:t}:{},state:"maximized",type:"normal",height:screen.availHeight,width:screen.availWidth,top:0,left:0}}),browser.windows.getLastFocused||(browser.windows.getLastFocused=async e=>browser.windows.getCurrent(e)),browser.windows.get||(browser.windows.get=async(e,t)=>{const[r]=await browser.tabs.query({windowId:e});return{...await browser.windows.getCurrent(t),id:r?.windowId??1,title:r?.title??"",focused:r?.active}}),browser.windows.getAll||(browser.windows.getAll=async e=>!1!==e?.windowTypes?.includes("normal")?[await browser.windows.getCurrent(e)]:[]),browser.windows.update||(browser.windows.update=async(e,t)=>{if(t.focused||"maximized"===t.state){const[t]=await browser.tabs.query({windowId:e});t&&await browser.tabs.update(t.id,{active:!0})}return browser.windows.getCurrent()}),browser.windows.remove||(browser.windows.remove=async e=>{const[t]=await browser.tabs.query({windowId:e});t&&await browser.tabs.remove(t.id)}),browser.windows.create||(browser.windows.create=async e=>{const t=e?.url?Array.isArray(e.url)?e.url:[e.url]:["about:blank"];for(const r of t)await browser.tabs.create({url:r,active:e?.focused});const r=await browser.windows.getCurrent({populate:!0});return r.tabs=r.tabs.filter((e=>e.windowId===r.id)),r}));const w=e=>function(e,t){return new Promise(((r,n)=>{const s=new FileReader;s.onload=e=>r(s.result),s.onerror=s.onabort=n,s[t](e)}))}(e,"readAsDataURL");const u=n?Promise.resolve():new Promise((e=>"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener("DOMContentLoaded",(()=>e())))),[h,b]=r();browser.runtime.onMessage.addListener((e=>{if("getCreatedImage"===e.type)return async function(e){await u;const t=document.getElementById("editor-download-btn"),r=document.createElement("div");r.textContent=e,r.style.fontWeight="bold",r.className="btn btn-outline-dark",r.onclick=()=>document.querySelector('.btn[data-type="svg"]').dispatchEvent(new Event("click"));const n=document.createElement("img");n.style.width="32px",n.style.margin="-6px 6px -6px -12px",n.src=browser.runtime.getURL("128.png"),r.insertAdjacentElement("afterbegin",n),t.insertAdjacentElement("afterbegin",r)}(e.downloadText),h})),window.addEventListener("message",(async e=>{if("image.ready"===e.data.n){const{name:t,type:r,url:n,dataurl:s}=e.data.data[0];if("image/svg+xml"!==r)return;if(s)b(s);else{const e=await(await fetch(n)).blob();b(await w(e))}}}))})();