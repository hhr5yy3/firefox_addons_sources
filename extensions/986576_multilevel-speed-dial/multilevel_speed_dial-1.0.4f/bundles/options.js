!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);const o=0,r=1,s=2,l=3,i=0,c=1,m=2,d=3,a="_",u="el",g="number";var b=function(e){this.type=o,this.number=e},y=b;let f,B,h;function p(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}b.prototype.parseObj=function(e){return new b(e.number)},b.prototype.onClicked=function(e){return!!G(e,[document.getElementById(u+a+this.number),document.getElementById("hdr"+a+this.number),document.getElementById("fico"+a+this.number),document.getElementById("cap"+a+this.number),document.getElementById("mture"+a+this.number),document.getElementById(g+a+this.number)])&&(this.action(),!0)},b.prototype.action=function(){Q(this,H.CREATE)},b.prototype.getInitHtml=function(e){e=e||this.number;let t=document.createElement("div");return t.className="element",t.id=u+a+e,t.draggable="true",t},b.prototype.getInnerHtml=function(){let e=document.createElement("div");e.className="elementMiniature",e.id="mture"+a+this.number;let t=document.createElement("label");t.className="elementNumber",t.setAttribute("tag","common"),t.id=g+a+this.number,t.textContent=this.number,e.appendChild(t);let n=document.createDocumentFragment();return n.appendChild(e),n},b.prototype.bindHtml=function(){let e=document.getElementById(u+a+this.number);e.onclick=b.prototype.onClicked.bind(this),e.ondragstart=b.prototype.onDragStart.bind(this),e.ondragenter=b.prototype.onDragEnter.bind(this),e.ondragleave=b.prototype.onDragLeave.bind(this),e.ondragover=b.prototype.onDragOver.bind(this),e.ondrop=b.prototype.onDrop.bind(this)},b.prototype.onDragStart=function(e){if(this.type!=o&&this.type!=l){let t=Array.from(F);t.push(this.number),e.dataTransfer.setData("srcPath",JSON.stringify(t)),e.dataTransfer.setData("",JSON.stringify(t)),e.dataTransfer.effectAllowed="move",h=!1,B=0}},b.prototype.onDragEnter=function(e){e.preventDefault(),++B;let t=Array.from(F);t.push(this.number);let n=p(t,JSON.parse(e.dataTransfer.getData("srcPath")));if(!h&&!n){let t=new Date;f=t.getTime(),h=!0,e.currentTarget.style.borderStyle="dashed"}},b.prototype.onDragLeave=function(e){e.preventDefault(),0==--B&&(h=!1,e.currentTarget.style.borderStyle="solid")},b.prototype.onDragOver=function(e){e.preventDefault(),e.dataTransfer.dropEffect="move";let t=Array.from(F);if(t.push(this.number),!p(t,JSON.parse(e.dataTransfer.getData("srcPath")))&&(this.type==l||this.type==s)){let e=new Date;if(e.getTime()-f>1e3){f=e.getTime(),x[this.type](this).action(),B=0}}},b.prototype.onDrop=function(e){if(e.preventDefault(),this.type!=l){let t=Array.from(F);t.push(this.number),t=t.join("/");let n=JSON.parse(e.dataTransfer.getData("srcPath")),o=n.join("/");if(o.startsWith(t)&&o.length>t.length)e.currentTarget.style.borderStyle="solid",alert(browser.i18n.getMessage("ohnonono"));else{let e=Array.from(F);e.push(this.number),function(e,t){let n=e.pop(),o=t.pop(),r=te(e),s=te(t),l=r.elements[n-1];r.elements[n-1]=s.elements[o-1],s.elements[o-1]=l,r.elements[n-1].number=n,s.elements[o-1].number=o,Y(e,F)&&_(r.elements[n-1]);Y(t,F)&&_(s.elements[o-1]);browser.storage.local.set({structure:O})}(n,e)}}};var E=function(e){y.call(this,e),this.caption="",this.icon=null,this.isCaptionHidden=!1,this.isMiniatureHidden=!1};(E.prototype=Object.create(y.prototype)).constructor=E;var I=E;E.prototype.parseObj=function(e){let t=new E(e.number),n=y.prototype.parseObj.call(this,e);return Object.assign(t,n),t.type=e.type,t.caption=e.caption,t.icon=e.icon,t.isCaptionHidden=e.isCaptionHidden,t.isMiniatureHidden=e.isMiniatureHidden,t},E.prototype.getInnerHtml=function(){let e=document.createElement("div");e.className="elementHeader",e.id="hdr"+a+this.number;let t=document.createElement("img");t.id="fico"+a+this.number,t.src=this.icon,e.appendChild(t);let n=document.createElement("label");n.className="elementCaption",n.id="cap"+a+this.number,this.isCaptionHidden||(n.textContent=this.caption),e.appendChild(n);let o=document.createElement("img");o.className="elementButton",o.id="ribtn"+a+this.number,o.src="icons/refresh.svg",e.appendChild(o),o.onclick=function(){this.refresh(0,!1)}.bind(this);let r=document.createElement("img");r.className="elementButton",r.id="editbtn"+a+this.number,r.src="icons/edit.svg",e.appendChild(r),r.onclick=function(){Q(this,H.EDIT)}.bind(this);let s=document.createElement("img");s.className="elementButton",s.id="rmvbtn"+a+this.number,s.src="icons/delete.svg",e.appendChild(s),s.onclick=function(){if(confirm(browser.i18n.getMessage("rlyDeleteElement",[this.number,this.caption]))){let e=new y(this.number);ee(F,e)}}.bind(this);let l=y.prototype.getInnerHtml.call(this);l.insertBefore(e,l.children[0]);l.getElementById("mture"+a+this.number);return l},E.prototype.refresh=function(e,t){!function(e,t){let n=Array.from(e);browser.storage.local.get("structure").then(function(e){let o=te(n,e.structure),r=o.elements[t-1],s=te(n,O);s.elements[r.number-1]=r,Y(n,F)&&_(r)},q)}(F,this.number)};var w=function(e,t){I.call(this,e),this.type=r,this.url=t,this.icon=null,this.caption=null,this.miniature=null};(w.prototype=Object.create(I.prototype)).constructor=w;var k=w;w.prototype.parseObj=function(e){let t=new w(e.number,e.url),n=I.prototype.parseObj.call(this,e);return Object.assign(t,n),t.miniature=e.miniature,t},w.prototype.action=function(){},w.prototype.getInitHtml=function(){let e=document.createElement("a");return e.className="element",e.id=u+a+this.number,e.href=this.url,e.draggable="true",e},w.prototype.getInnerHtml=function(){let e=I.prototype.getInnerHtml.call(this),t=e.getElementById("hdr"+a+this.number),n=e.getElementById("editbtn"+a+this.number),o=document.createElement("img");return o.className="elementButton",o.id="rdbtn"+a+this.number,o.src="icons/refresh-delayed.svg",t.insertBefore(o,n),o.onclick=function(){this.refresh(3e3,!0)}.bind(this),this.isCaptionHidden||(e.getElementById("cap"+a+this.number).textContent=this.caption),e.getElementById("fico"+a+this.number).src=this.icon,this.isMiniatureHidden||(e.getElementById("mture"+a+this.number).style.backgroundImage="url('"+this.miniature+"')"),e},w.prototype.refresh=function(e,t){let n=Array.from(F);document.getElementById(g+a+this.number).textContent="...",I.prototype.refresh.call(this),function(e,t,n){return t=t||0,n=n||!1,new Promise((o,r)=>{browser.tabs.create({url:e,active:n}).then(function(e){n||browser.permissions.contains({permissions:["tabHide"]}).then(function(t){t&&browser.tabs.hide(e.id)});let s=!1,l=function(n,i,c){!s&&n==e.id&&i.status&&"complete"==i.status&&(s=!0,browser.tabs.get(n).then(function(e){let n={title:e.title,favicon:e.favIconUrl,screenshot:null};setTimeout(function(){browser.tabs.captureTab(e.id,{format:"jpeg",quality:25}).then(function(e){n.screenshot=e},r).then(function(){browser.tabs.remove(e.id),browser.tabs.onUpdated.removeListener(l),o(n)},function(){r(browser.i18n.getMessage("unableToGetPageInfo"))})},t)},r))};browser.tabs.onUpdated.addListener(l)},r)})}(this.url,e,t).then(function(e){if(this.caption=e.title||this.caption,this.icon=e.favicon||this.icon,this.miniature=e.screenshot||this.miniature,this.miniature){let e=new Image;const t=this;e.onload=function(){if(e.width>480){const n=480*e.height/e.width;t.miniature=function(e,t,n){let o=document.createElement("img");o.src=e;let r=document.createElement("canvas");return r.width=t,r.height=n,r.getContext("2d").drawImage(o,0,0,t,n),r.toDataURL("image/jpeg",25)}(t.miniature,480,n)}ee(n,t)},e.src=this.miniature}}.bind(this),q).then(function(){document.getElementById(g+a+this.number).textContent=this.number}.bind(this))};const v="#f9f9fa",L="#38383d";async function M(){let e;return await browser.storage.local.get(["settings"]).then(function(t){t.settings&&(e=t.settings.darkTheme?L:v)}),e}var T=function(e){y.call(this,e),this.type=l};(T.prototype=Object.create(y.prototype)).constructor=T;var S=T;T.prototype.parseObj=function(e){return new T(e.number)},T.prototype.action=function(){F.pop(),z(te(F))},T.prototype.getInnerHtml=function(){let e=y.prototype.getInnerHtml.call(this),t=e.getElementById(g+a+this.number);return t.setAttribute("tag","backstep"),t.textContent="←",e};var C=function(e,t,n=3,o=3,r=i,l=null,c=""){I.call(this,e),this.type=s,this.caption=t,this.icon="icons/folder.svg",this.rows=n>0?n:1,this.cols=o>0?o:1,this.bgtype=r,this.bgdata=l,this.bgviewstr=c;let m=this.rows*this.cols;this.elements=new Array(m);for(let e=0;e<m-1;++e)this.elements[e]=new y(e+1);this.number>0?this.elements[m-1]=new S(m):this.elements[m-1]=new y(m)};(C.prototype=Object.create(I.prototype)).constructor=C;var P=C;C.prototype.parseObj=function(e){let t=new C(e.number,e.caption,e.rows,e.cols,e.bgtype,e.bgdata,e.bgviewstr),n=I.prototype.parseObj.call(this,e);return Object.assign(t,n),t.elements=e.elements,t},C.prototype.action=function(){F.push(this.number),z(this)},C.prototype.getInnerHtml=function(){let e=I.prototype.getInnerHtml.call(this),t=e.getElementById("hdr"+a+this.number),n=e.getElementById("ribtn"+a+this.number),o=document.createElement("img");if(o.className="elementButton",o.style.width="var(--iconSize)",o.src="data:image/gif;base64,R0lGODlhAQABAPAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==",o.style.cursor="initial",t.insertBefore(o,n),!this.isMiniatureHidden){let t=e.getElementById("mture"+a+this.number);switch(this.bgtype){case i:M().then(function(e){t.style.backgroundColor=e}),t.style.backgroundImage="";break;case c:t.style.backgroundColor=this.bgdata,t.style.backgroundImage="";break;case m:case d:t.style.backgroundColor="",t.style.backgroundImage="url('"+this.bgdata+"')"}}return e};const R={showNumbers:!0,roundCorners:!1,darkTheme:!1,doPageFocus:!0,newTabActive:!0,kbdnavOn:!0};function A(e){let t={};e.settings&&(t=e.settings);let n=!1;for(let e in R)e in t||(t[e]=R[e],n=!0);return n&&browser.storage.local.set({settings:t}),t}Object.freeze(R);const H={CREATE:0,EDIT:1};Object.freeze(H);const x={[o]:y.prototype.parseObj,[r]:k.prototype.parseObj,[s]:P.prototype.parseObj,[l]:S.prototype.parseObj};Object.freeze(x);let O,D,N,j,F=[],U=!0;function W(e){document.getElementById("gridSizeLabel").textContent=browser.i18n.getMessage("gridSize")+": ",document.getElementById("bgLabel").innerHTML+=browser.i18n.getMessage("background")+":",document.getElementById("defaultBgLabel").innerHTML+=browser.i18n.getMessage("default"),document.getElementById("colorBgLabel").innerHTML+=browser.i18n.getMessage("color")+": ",document.getElementById("imgLocalBgLabel").innerHTML+=browser.i18n.getMessage("imageLocal")+": ",document.getElementById("fakeBgimgPickerBtn").value=browser.i18n.getMessage("browse"),document.getElementById("fakeBgimgPickerLabel").textContent=browser.i18n.getMessage("nofilechosen"),document.getElementById("imgRemoteBgLabel").innerHTML+=browser.i18n.getMessage("imageRemote")+": ";let t=function(){document.getElementById("bgcolorPicker").disabled=!document.getElementById("colorBgRb").checked,document.getElementById("bgimgPicker").disabled=!document.getElementById("imgLocalBgRb").checked,document.getElementById("fakeBgimgPickerBtn").disabled=!document.getElementById("imgLocalBgRb").checked,document.getElementById("bgimgUrlTf").disabled=!document.getElementById("imgRemoteBgRb").checked};document.getElementsByName("bgtype").forEach(function(e){e.oninput=t});let n=document.getElementById("bgimgPicker");document.getElementById("fakeBgimgPickerBtn").onclick=function(){n.click()},n.onchange=function(){n.files.length>0?document.getElementById("fakeBgimgPickerLabel").textContent=n.files[0].name:document.getElementById("fakeBgimgPickerLabel").textContent=browser.i18n.getMessage("nofilechosen")},J(e)}function J(e){let t=function(){const t=document.getElementById("rowsOld").value*document.getElementById("colsOld").value,n=document.getElementById("rowsSpin").value*document.getElementById("colsSpin").value;if(n<t){let o,l=document.getElementById("numberTf");o=e?e.elements:te(F||[]).elements[l.value-1].elements;let i=0,c=0;const m=n-(l?1:0);for(let e=m;e<t;++e)switch(o[e].type){case r:++i;break;case s:++c}if(i+c>0){let e=function(e){const t=browser.i18n.getMessage("@@ui_locale");return t.startsWith("ru")?e%100!=11&&e%10==1?browser.i18n.getMessage("endingCase1"):(e%100<12||e%100>14)&&e%10>=2&&e%10<=4?browser.i18n.getMessage("endingCase2"):browser.i18n.getMessage("endingCase0"):t.startsWith("en")?1==e?"":"s":void 0};const t=e(i),n=e(c);document.getElementById("elemsWillBeLostLabel").textContent=browser.i18n.getMessage("elemsWillBeLost",[m,i,t,c,n]),document.getElementById("elemsWillBeLostLabel").style.display="initial"}else document.getElementById("elemsWillBeLostLabel").textContent="",document.getElementById("elemsWillBeLostLabel").style.display="none"}else document.getElementById("elemsWillBeLostLabel").textContent="",document.getElementById("elemsWillBeLostLabel").style.display="none"};document.getElementsByName("gridSize").forEach(function(e){e.oninput=t})}function q(e){console.log(browser.i18n.getMessage("errMsg")+": "+e)}function z(e){let t=document.getElementById("background");switch(e.bgtype){case i:M().then(function(e){t.style.backgroundColor=e}),t.style.backgroundImage="";break;case c:t.style.backgroundColor=e.bgdata,t.style.backgroundImage="";break;case m:case d:t.style.backgroundColor="",t.style.backgroundImage="url('"+e.bgdata+"')"}let n=document.getElementById("grid");n.innerHTML="";for(let t=0;t<e.rows;++t){let o=n.insertRow(t);for(let n=0;n<e.cols;++n){let r=o.insertCell(n),s=e.cols*t+n+1;r.appendChild(y.prototype.getInitHtml(s)),_(e.elements[s-1])}}let o,r=e.rows*e.cols;for(o=0;r>1;++o)r/=10;window.onresize=function(){let e=document.getElementById(g+a+"1"),t=e.style.display;e.style.display="flex";let n=Math.min(.9*e.offsetWidth/o,e.offsetHeight);document.documentElement.style.setProperty("--numberFontSize",n+"px"),e.style.display=t,K()},window.onresize()}function _(e){e=function(e){e instanceof y||(e=x[e.type](e));return e}(e);let t=document.getElementById(u+a+e.number),n=t.parentElement;t.remove();let o=e.getInitHtml();o.appendChild(e.getInnerHtml()),n.appendChild(o),e.bindHtml()}function Y(e,t){if(e.length!=t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!=t[n])return!1;return!0}function G(e,t){return e=window.event||e,t.some(function(t){return e.target===t})}function Q(e,t){if(window.getSelection().removeAllRanges(),document.getElementById("assignmentForm").reset(),document.getElementById("bgimgBase64").value="",document.getElementById("bgimgPicker").required=!0,document.getElementById("numberTf").value=e.number,document.getElementById("elemsWillBeLostLabel").textContent="",document.getElementById("elemsWillBeLostLabel").style.display="none",document.getElementById("imgLocalBgSpinner").style.display="none",document.getElementById("fakeBgimgPickerLabel").textContent=browser.i18n.getMessage("nofilechosen"),t==H.CREATE)document.getElementById("modeTf").value=H.CREATE,document.getElementById("bookmarkSettings").disabled=!1,document.getElementById("folderSettings").disabled=!0,document.getElementById("bookmarkRb").checked=!0,document.getElementById("defaultBgRb").checked=!0,document.getElementById("bgcolorPicker").disabled=!0,document.getElementById("bgimgPicker").disabled=!0,document.getElementById("fakeBgimgPickerBtn").disabled=!0,document.getElementById("bgimgUrlTf").disabled=!0;else if(t==H.EDIT){if(document.getElementById("modeTf").value=H.EDIT,document.getElementById("bookmarkSettings").disabled=!(document.getElementById("bookmarkRb").checked=e.type==r||e.type==o),document.getElementById("folderSettings").disabled=!(document.getElementById("folderRb").checked=e.type==s),e.type==r)document.getElementById("urlTf").value=e.url,document.getElementById("defaultBgRb").checked=!0,document.getElementById("bgcolorPicker").disabled=!(document.getElementById("colorBgRb").checked=!1),document.getElementById("bgimgPicker").disabled=!(document.getElementById("imgLocalBgRb").checked=!1),document.getElementById("fakeBgimgPickerBtn").disabled=!(document.getElementById("imgLocalBgRb").checked=!1),document.getElementById("bgimgUrlTf").disabled=!(document.getElementById("imgRemoteBgRb").checked=!1);else if(e.type==s)switch(document.getElementById("folderNameTf").value=e.caption,document.getElementById("rowsSpin").value=e.rows,document.getElementById("colsSpin").value=e.cols,document.getElementById("rowsOld").value=e.rows,document.getElementById("colsOld").value=e.cols,document.getElementById("defaultBgRb").checked=e.bgtype==i,document.getElementById("bgcolorPicker").disabled=!(document.getElementById("colorBgRb").checked=e.bgtype==c),document.getElementById("bgimgPicker").disabled=!(document.getElementById("imgLocalBgRb").checked=e.bgtype==m),document.getElementById("fakeBgimgPickerBtn").disabled=!(document.getElementById("imgLocalBgRb").checked=e.bgtype==m),document.getElementById("bgimgUrlTf").disabled=!(document.getElementById("imgRemoteBgRb").checked=e.bgtype==d),e.bgtype){case c:document.getElementById("bgcolorPicker").value=e.bgdata;break;case m:0==e.bgviewstr.length?(document.getElementById("bgimgPicker").required=!0,document.getElementById("bgimgBase64").value=""):(document.getElementById("bgimgPicker").required=!1,document.getElementById("bgimgBase64").value=e.bgdata,document.getElementById("fakeBgimgPickerLabel").textContent=e.bgviewstr);break;case d:0==e.bgviewstr.length?(document.getElementById("bgimgUrlTf").value="",document.getElementById("bgimgUrlTf").required=!0,document.getElementById("bgimgBase64").value=""):(document.getElementById("bgimgUrlTf").value=e.bgviewstr,document.getElementById("bgimgUrlTf").required=!1,document.getElementById("bgimgBase64").value=e.bgdata)}document.getElementById("hideCaptionChb").checked=e.isCaptionHidden,document.getElementById("hideMiniatureChb").checked=e.isMiniatureHidden}if(document.getElementById("curtain").style.display="flex",document.getElementById("background").style.WebkitFilter="contrast(0.25)",K(),document.getElementById("bookmarkRb").checked)document.getElementById("urlTf").focus();else{if(!document.getElementById("folderRb").checked)throw-1;document.getElementById("folderNameTf").focus()}}function K(){let e=document.getElementById("assignmentFormContainer");let t=Math.min(window.innerWidth/(e.offsetWidth+8),window.innerHeight/(e.offsetHeight+8));t>1?t=1:t<.75&&(t=.75),document.documentElement.style.setProperty("--assignmentFormScale",t)}function V(){document.getElementById("curtain").style.display="none",document.getElementById("background").style.WebkitFilter=""}function X(e){e.preventDefault(),V(),async function(e){let t=null,n=parseInt(document.getElementById("numberTf").value);if(document.getElementById("bookmarkRb").checked){let e=document.getElementById("urlTf").value;/^https?:\/\//i.test(e)||(e="http:"+(e.startsWith("//")?"":"//")+e),t=new k(n,e)}else{if(!document.getElementById("folderRb").checked)throw-1;{let o,r,a,u=document.getElementById("folderNameTf").value,g=parseInt(document.getElementById("rowsSpin").value),b=parseInt(document.getElementById("colsSpin").value);if(document.getElementById("defaultBgRb").checked)o=i,r=null,a="";else if(document.getElementById("colorBgRb").checked)o=c,r=document.getElementById("bgcolorPicker").value,a="";else if(document.getElementById("imgLocalBgRb").checked){o=m;const e=document.getElementById("bgimgPicker");if(e.files.length>0){let t=e.files[0];document.getElementById("imgLocalBgSpinner").style.display="initial",await Z(t,document.getElementById("imgLocalBgSpinner"),!0).then(function(e){r=e},q),a=e.files[0].name}else r=document.getElementById("bgimgBase64").value,a=document.getElementById("fakeBgimgPickerLabel").textContent}else document.getElementById("imgRemoteBgRb").checked&&(o=d,await ne(document.getElementById("bgimgUrlTf").value).then(function(e){r=e},q),a=document.getElementById("bgimgUrlTf").value);if(t=new P(n,u,g,b,o,r,a),e){let e=te(F,O).elements[n-1];if(e.type==s){let n=g*b;const o=Math.min(e.elements.length,n);for(let n=0;n<o;++n)t.elements[n]=e.elements[n];let r=function(e){for(let t=0;t<e.elements.length;++t)if(e.elements[t].type==l)return t;return-1}(t);r>=0&&r+1<n&&(t.elements[r]=new y(r+1)),t.elements[n-1]=new S(n)}}}}return t.isCaptionHidden=document.getElementById("hideCaptionChb").checked,t.isMiniatureHidden=document.getElementById("hideMiniatureChb").checked,t}(+document.getElementById("modeTf").value==H.EDIT).then(function(e){ee(F,e),e instanceof k&&e.refresh()})}function Z(e,t,n){return new Promise((o,r)=>{let s=new FileReader;s.onloadend=function(){t&&(t.style.display="none"),o&&s.result?o(s.result):r&&r(browser.i18n.getMessage("unableToLoadFile"))},n?s.readAsDataURL(e):s.readAsText(e)})}function $(e){G(e,[document.getElementById("curtain")])&&V()}function ee(e,t){let n=Array.from(e);te(n,O).elements[t.number-1]=t,Y(n,F)&&_(t),browser.storage.local.set({structure:O})}function te(e,t){let n=t||O;for(let t=0;t<e.length;++t)n=n.elements[e[t]-1];return n}function ne(e){return new Promise((t,n)=>{let o=document.createElement("img");o.onload=function(){let e=function(e){let t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),t.toDataURL("image/jpeg",25)}(o);t(e)},o.onerror=function(){n(browser.i18n.getMessage("unableToLoadFile"))},o.src=e})}function oe(e){e.structure?N=e.structure:(N=new P(-1,browser.i18n.getMessage("extensionName")),browser.storage.local.set({structure:N}))}function re(){switch(document.getElementById("bgimgBase64").value="",document.getElementById("bgimgPicker").required=!0,document.getElementById("elemsWillBeLostLabel").textContent="",document.getElementById("elemsWillBeLostLabel").style.display="none",document.getElementById("imgLocalBgSpinner").style.display="none",document.getElementById("fakeBgimgPickerLabel").textContent=browser.i18n.getMessage("nofilechosen"),document.getElementById("rowsSpin").value=N.rows,document.getElementById("colsSpin").value=N.cols,document.getElementById("rowsOld").value=N.rows,document.getElementById("colsOld").value=N.cols,document.getElementById("defaultBgRb").checked=N.bgtype==i,document.getElementById("bgcolorPicker").disabled=!(document.getElementById("colorBgRb").checked=N.bgtype==c),document.getElementById("bgimgPicker").disabled=!(document.getElementById("imgLocalBgRb").checked=N.bgtype==m),document.getElementById("fakeBgimgPickerBtn").disabled=!(document.getElementById("imgLocalBgRb").checked=N.bgtype==m),document.getElementById("bgimgUrlTf").disabled=!(document.getElementById("imgRemoteBgRb").checked=N.bgtype==d),N.bgtype){case c:document.getElementById("bgcolorPicker").value=N.bgdata;break;case m:0==N.bgviewstr.length?(document.getElementById("bgimgPicker").required=!0,document.getElementById("bgimgBase64").value=""):(document.getElementById("bgimgPicker").required=!1,document.getElementById("bgimgBase64").value=N.bgdata,document.getElementById("fakeBgimgPickerLabel").textContent=N.bgviewstr);break;case d:0==N.bgviewstr.length?(document.getElementById("bgimgUrlTf").value="",document.getElementById("bgimgUrlTf").required=!0,document.getElementById("bgimgBase64").value=""):(document.getElementById("bgimgUrlTf").value=N.bgviewstr,document.getElementById("bgimgUrlTf").required=!1,document.getElementById("bgimgBase64").value=N.bgdata)}}window.onload=function(){browser.storage.local.get(["structure","settings"]).then(function(e){!function(e){e.structure?O=e.structure:(O=new P(-1,browser.i18n.getMessage("extensionName")),browser.storage.local.set({structure:O}));D=A(e),document.documentElement.style.setProperty("--elementNumberDisplay",D.showNumbers?"flex":"none"),document.documentElement.style.setProperty("--elementBorderRadius",D.roundCorners?"8px":"2px"),function(e){e?(document.documentElement.style.setProperty("--backgroundColor","var(--grey-70)"),document.documentElement.style.setProperty("--textColor","var(--grey-10)"),document.documentElement.style.setProperty("--inputsColor","var(--grey-60)"),document.documentElement.style.setProperty("--curtainColor","var(--grey-90-a90)"),document.documentElement.style.setProperty("--togglesColor","var(--grey-90-a50)")):(document.documentElement.style.setProperty("--backgroundColor","var(--grey-10)"),document.documentElement.style.setProperty("--textColor","var(--grey-90)"),document.documentElement.style.setProperty("--inputsColor","var(--white-100)"),document.documentElement.style.setProperty("--curtainColor","var(--grey-90-a60)"),document.documentElement.style.setProperty("--togglesColor","var(--grey-90-a10)"))}(D.darkTheme)}(e),U&&z(O)},q),document.getElementById("cellAssignmentTitle").textContent=browser.i18n.getMessage("cellAssignmentTitle")+" - "+browser.i18n.getMessage("extensionName"),document.getElementById("cellNumberLabel").textContent=browser.i18n.getMessage("cellNumber")+":",document.getElementById("cellTypeLabel").textContent=browser.i18n.getMessage("cellType")+":",document.getElementById("bookmarkLabel").innerHTML+=browser.i18n.getMessage("bookmark"),document.getElementById("folderLabel").innerHTML+=browser.i18n.getMessage("folder"),document.getElementById("generalSettingsLabel").textContent=browser.i18n.getMessage("generalSettings"),document.getElementById("hideCaptionLabel").innerHTML+=browser.i18n.getMessage("hideCaption"),document.getElementById("hideMiniatureLabel").innerHTML+=browser.i18n.getMessage("hideMiniature"),document.getElementById("bookmarkSettingsLabel").textContent=browser.i18n.getMessage("bookmarkSettings"),document.getElementById("urlLabel").innerHTML+=browser.i18n.getMessage("url")+": ",document.getElementById("folderSettingsLabel").innerHTML+=browser.i18n.getMessage("folderSettings")+":",document.getElementById("folderNameLabel").innerHTML+=browser.i18n.getMessage("folderName")+": ",document.getElementById("okBtn").value=browser.i18n.getMessage("ok"),document.getElementById("cancelBtn").value=browser.i18n.getMessage("cancel"),document.getElementById("bgimgUrlTf").title=browser.i18n.getMessage("imgUrlRequired"),document.getElementById("assignmentForm").onsubmit=X,document.getElementById("curtain").onclick=$;let e=function(){if(document.getElementById("bookmarkSettings").disabled=!document.getElementById("bookmarkRb").checked,document.getElementById("folderSettings").disabled=!document.getElementById("folderRb").checked,document.getElementById("bookmarkRb").checked)document.getElementById("urlTf").focus();else{if(!document.getElementById("folderRb").checked)throw-1;document.getElementById("folderNameTf").focus()}};document.getElementsByName("elementType").forEach(function(t){t.oninput=e}),W(),document.getElementById("urlTf").oninput=function(){let e=document.getElementById("urlSuggectionsDL"),t=document.getElementById("urlTf");e.innerHTML="",browser.permissions.contains({permissions:["history"]}).then(function(n){n&&browser.history.search({text:t.value,startTime:0,maxResults:20}).then(function(t){e.innerHTML="";for(let n of t){let t=document.createElement("option");t.value=n.url,e.appendChild(t)}},q)})},document.getElementById("cancelBtn").onclick=V},browser.runtime.onMessage.addListener(function(e,t,n){switch(e.command){case 2:"string"===(typeof e.path).toLowerCase()&&(e.path=e.path.split("/")),e.path=e.path.filter(e=>""!=e);let t=e.folder||te(e.path);F=e.path,U=!1,z(t)}}),window.onload=function(){browser.storage.local.get(["structure","settings"]).then(function(e){oe(e),W(N),re(),j=A(e),document.getElementById("showNumbersChb").checked=j.showNumbers,document.getElementById("roundCornersChb").checked=j.roundCorners,document.getElementById("darkThemeChb").checked=j.darkTheme,document.getElementById("kbdnavOnChb").checked=j.kbdnavOn,document.getElementById("focusAddressBarRb").checked=!(document.getElementById("focusPageRb").checked=j.doPageFocus),document.getElementById("newTabActiveNoRb").checked=!(document.getElementById("newTabActiveYesRb").checked=j.newTabActive)},q),document.getElementById("permissionsSettingsLabel").textContent=browser.i18n.getMessage("permissionsSettings"),document.getElementById("historyPermissionLabel").textContent=browser.i18n.getMessage("historyPermission")+":",document.getElementById("tabHidePermissionLabel").textContent=browser.i18n.getMessage("tabHidePermission")+":";let e=function(e,t){document.getElementById(e+"PermissionBtn").disabled=!1,t?(document.getElementById(e+"PermissionBtn").value=browser.i18n.getMessage("permissionDisable"),document.getElementById(e+"PermissionStatusLabel").textContent=browser.i18n.getMessage("permissionEnabled"),document.getElementById(e+"PermissionStatusLabel").setAttribute("tag","enabled")):(document.getElementById(e+"PermissionBtn").value=browser.i18n.getMessage("permissionEnable"),document.getElementById(e+"PermissionStatusLabel").textContent=browser.i18n.getMessage("permissionDisabled"),document.getElementById(e+"PermissionStatusLabel").setAttribute("tag","disabled"))},t=["history","tabHide"];for(let n=0;n<t.length;++n){let o=t[n];document.getElementById(o+"PermissionBtn").onclick=function(){let t=document.getElementById(o+"PermissionStatusLabel").getAttribute("tag")&&"enabled"==document.getElementById(o+"PermissionStatusLabel").getAttribute("tag");document.getElementById(o+"PermissionStatusLabel").textContent="...",document.getElementById(o+"PermissionStatusLabel").setAttribute("tag",""),t?browser.permissions.remove({permissions:[o]}).then(function(t){e(o,!t)},q):browser.permissions.request({permissions:[o]}).then(function(t){e(o,t)},q)},browser.permissions.contains({permissions:[o]}).then(function(t){e(o,t)},q)}document.getElementById("generalSettingsLabel").textContent=browser.i18n.getMessage("generalSettings"),document.getElementById("showNumbersLabel").innerHTML+=browser.i18n.getMessage("showNumbers"),document.getElementById("roundCornersLabel").innerHTML+=browser.i18n.getMessage("roundCorners"),document.getElementById("darkThemeLabel").innerHTML+=browser.i18n.getMessage("darkTheme"),document.getElementById("kbdnavOnLabel").innerHTML+=browser.i18n.getMessage("kbdnavOn");let n=function(e){browser.storage.local.get("settings").then(function(t){A(t),j[e.target.id.substr(0,e.target.id.length-3)]=e.target.checked,browser.storage.local.set({settings:j})},q)},o=document.getElementsByName("generalChbs");o.forEach(function(e){e.oninput=n},q),document.getElementById("rootFolderSettingsLabel").textContent=browser.i18n.getMessage("rootFolderSettings"),document.getElementById("rootFolderSettingsDescLabel").textContent=browser.i18n.getMessage("rootFolderSettingsDesc"),document.getElementById("rootFolderSettingsDescLabel").innerHTML=document.getElementById("rootFolderSettingsDescLabel").innerHTML.replace(/\n/g,"<br/>"),document.getElementById("okBtn").value=browser.i18n.getMessage("save"),document.getElementById("restoreBtn").value=browser.i18n.getMessage("restore"),document.getElementById("folderSettingsForm").onsubmit=function(e){e.preventDefault(),browser.storage.local.get("structure").then(function(e){oe(e),async function(){let e,t,n,o=parseInt(document.getElementById("rowsSpin").value),r=parseInt(document.getElementById("colsSpin").value);if(document.getElementById("defaultBgRb").checked)e=i,t=null,n="";else if(document.getElementById("colorBgRb").checked)e=c,t=document.getElementById("bgcolorPicker").value,n="";else if(document.getElementById("imgLocalBgRb").checked){e=m;const o=document.getElementById("bgimgPicker");if(o.files.length>0){let e=o.files[0];document.getElementById("imgLocalBgSpinner").style.display="initial",await Z(e,document.getElementById("imgLocalBgSpinner"),!0).then(function(e){t=e},q),n=o.files[0].name}else t=document.getElementById("bgimgBase64").value,n=document.getElementById("fakeBgimgPickerLabel").textContent}else document.getElementById("imgRemoteBgRb").checked&&(e=d,await ne(document.getElementById("bgimgUrlTf").value).then(function(e){t=e},q),n=document.getElementById("bgimgUrlTf").value);let s=new P(-1,browser.i18n.getMessage("extensionName"),o,r,e,t,n);const l=Math.min(N.elements.length,o*r);for(let e=0;e<l;++e)s.elements[e]=N.elements[e];N=s,browser.storage.local.set({structure:N})}().then(function(){re(),J(N)},q)},q)},document.getElementById("restoreBtn").onclick=function(e){confirm(browser.i18n.getMessage("rlyRestoreRootFolderForm"))&&browser.storage.local.get("structure").then(function(e){oe(e),re(),J(N)},q)},document.getElementById("newTabFocusSettingsLabel").textContent=browser.i18n.getMessage("newTabFocusSettings"),document.getElementById("newTabFocusSettingsDescLabel").textContent=browser.i18n.getMessage("newTabFocusSettingsDesc"),document.getElementById("newTabFocusSettingsDescLabel").innerHTML=document.getElementById("newTabFocusSettingsDescLabel").innerHTML.replace(/\n/g,"<br/>"),document.getElementById("focusPageLabel").innerHTML+=browser.i18n.getMessage("focusPage"),document.getElementById("focusAddressBarLabel").innerHTML+=browser.i18n.getMessage("focusAddressBar");let l=function(){browser.storage.local.get("settings").then(function(e){A(e),j.doPageFocus=document.getElementById("focusPageRb").checked,browser.storage.local.set({settings:j})},q)};(o=document.getElementsByName("newPageFocus")).forEach(function(e){e.oninput=l},q),document.getElementById("newTabActiveSettingsLabel").textContent=browser.i18n.getMessage("newTabActiveSettings"),document.getElementById("newTabActiveYesLabel").innerHTML+=browser.i18n.getMessage("newTabActiveYes"),document.getElementById("newTabActiveNoLabel").innerHTML+=browser.i18n.getMessage("newTabActiveNo");let a=function(){browser.storage.local.get("settings").then(function(e){A(e),j.newTabActive=document.getElementById("newTabActiveYesRb").checked,browser.storage.local.set({settings:j})},q)};(o=document.getElementsByName("newTabActive")).forEach(function(e){e.oninput=a},q),document.getElementById("structureManagingLabel").textContent=browser.i18n.getMessage("structureManaging"),document.getElementById("structureManagingDescLabel").textContent=browser.i18n.getMessage("structureManagingDesc"),document.getElementById("uploadSyncStorageBtn").value=browser.i18n.getMessage("uploadSyncStorage"),document.getElementById("downloadSyncStorageBtn").value=browser.i18n.getMessage("downloadSyncStorage"),document.getElementById("getJsonStructureBtn").value=browser.i18n.getMessage("getJsonStructure"),document.getElementById("fakeSetJsonStructureBtn").value=browser.i18n.getMessage("setJsonStructure"),document.getElementById("setDefaultStorageBtn").value=browser.i18n.getMessage("setDefaultStorage"),document.getElementById("uploadSyncStorageBtn").onclick=function(){confirm(browser.i18n.getMessage("rlyOverwriteRemoteStructure"))&&browser.storage.local.get("structure").then(function(e){if(e.structure){let t=function(e){if(e.type==r)e.miniature="";else if(e.type==s&&(e.bgtype==m||e.bgtype==d)){e.bgdata="",e.bgType==m&&(e.bgviewstr="");for(let n=0;n<e.elements.length;++n)t(e.elements[n])}};t(e.structure),browser.storage.sync.set({structure:e.structure}).then(function(){},alert)}else alert(browser.i18n.getMessage("noStructureInLocal"))},alert)},document.getElementById("downloadSyncStorageBtn").onclick=function(){confirm(browser.i18n.getMessage("rlyOverwriteCurrStructure"))&&browser.storage.sync.get("structure").then(function(e){e.structure?browser.storage.local.set({structure:e.structure}).then(function(){browser.storage.local.get("structure").then(function(e){oe(e),re(),J(N)},q)},alert):alert(browser.i18n.getMessage("noStructureInSync"))},alert)},document.getElementById("getJsonStructureBtn").onclick=function(){browser.permissions.request({permissions:["downloads"]}).then(function(e){e&&browser.storage.local.get("structure").then(function(e){if(e.structure){let t=JSON.stringify(e.structure),n=new Blob([t]),o=URL.createObjectURL(n),r=function(){browser.permissions.remove({permissions:["downloads"]}),URL.revokeObjectURL(o)};browser.downloads.download({url:o,saveAs:!0,filename:"mlsd-structure.json"}).then(function(e){let t=function(n){n.id==e&&(browser.downloads.onChanged.removeListener(t),r())};browser.downloads.onChanged.addListener(t)},r)}else alert(browser.i18n.getMessage("noStructureInLocal"))},alert)},q)},document.getElementById("fakeSetJsonStructureBtn").onclick=function(){document.getElementById("setJsonStructureBtn").click()},document.getElementById("setJsonStructureBtn").oninput=async function(){document.getElementById("setJsonStructureBtn").files.length>0&&confirm(browser.i18n.getMessage("rlyOverwriteCurrStructure"))&&(document.getElementById("jsonStructureSpinner").style.display="initial",await Z(document.getElementById("setJsonStructureBtn").files[0],document.getElementById("jsonStructureSpinner"),!1).then(function(e){let t;try{t=JSON.parse(e),browser.storage.local.set({structure:t}).then(function(e){browser.storage.local.get("structure").then(function(e){oe(e),re(),J(N)},q)},alert)}catch(e){alert(e.message)}},q))},document.getElementById("setDefaultStorageBtn").onclick=function(){if(confirm(browser.i18n.getMessage("rlyOverwriteCurrStructure"))){let e=new P(-1,browser.i18n.getMessage("extensionName"));browser.storage.local.set({structure:e}).then(function(e){browser.storage.local.get("structure").then(function(e){oe(e),re(),J(N)},q)},alert)}}}}]);