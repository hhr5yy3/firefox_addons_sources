(()=>{let y=0,h=[];function g(e){return new Promise(t=>{browser.storage.local.get(e,t)})}function e(){const t=setInterval(()=>{clearInterval(t);e();n()},1e3)}function k(t){const e=/[?:;"<>\/\\|*]|^\s+|[\u200B-\u200D\uFEFF]/gi;return t.replace(e,t=>{return t===" "||t.match(/[\u200B-\u200D\uFEFF]/)?"":"_"})}function t(t){return btoa(t)}function n(){const e=document.querySelectorAll(".d-track, .track");if(e){for(let t in e){if(e[t].tagName=="DIV"){r(e[t])}}}}function r(r){let t=r.classList;if(t.contains("_yamusic_ready")||!r){return null}t.add("_yamusic_ready");let o=r.querySelectorAll(".d-track__title, .d-link.track__title")[0];if(o){let n=document.createElement("span");n.href="#";n.title="Скачать";n.classList.add("_yamusic_save");n.innerHTML=`<button class="button button_round button_action button-play button-play__type_track button_ico" id="_yamusic_save_button" style="background-image: url(${browser.runtime.getURL("images/save_button.png")})"></button>`;o.parentElement.insertBefore(n,o);let e=document.querySelectorAll(".page-main__chart.column-chart, .page-metatag__tracks, .sidebar__tracks, .page-artist__tracks_top, .serp-snippet__tracks, .serp-snippet__podcast_episodes");e.length==0&&(e=[n.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement]);browser.runtime.sendMessage({message:"all"},t=>{if(e&&t==true){[...e].forEach(t=>{let e=t.querySelectorAll("._yamusic_save")||[];if(e.length>1){a(t)}})}});n.addEventListener("click",function(t){if(this.alreadyCalled&&n?.innerText!="error")return true;this.alreadyCalled=true;t.stopPropagation();t.preventDefault();browser.runtime.sendMessage({message:"check"},t=>{if(t.status==true){n.innerHTML='<button class="button button_round button_action button-play button-play__type_track button_ico" id="_yamusic_save_button" style="background-color: #ff3333">error</button>';return}else{n.innerHTML='<button class="button button_round button_action button-play button-play__type_track button_ico" id="_yamusic_save_button">0%</button>';let e;try{e=r.getElementsByClassName("d-track__play")[0].getElementsByTagName("button")[0].getAttribute("data-idx")}catch(t){e=r.querySelector(".d-link.deco-link.track__title").getAttribute("href").split("/")[4]}let t=0;try{t=r.querySelectorAll(".d-track__chart-number, .d-track__id")[0].innerText}catch(t){}if(!e){return}y++;if(y>7){h.push([n,e,t]);return}else{v(n,e,t)}}})})}}function v(m,t,p){function f(e,o){let a=0;return new Promise((n,t)=>{function r(){e.read().then(({done:t,value:e})=>{if(t){n();return}a=a+e.byteLength;try{m.innerHTML=`<button class="button button_round button_action button-play button-play__type_track button_ico" id="_yamusic_save_button">${Math.round(a/Number(o)*100)}%</button>`}catch(t){console.log(t)}r()}).catch(t)}r()})}let e=`https://${location.host}/handlers/track.jsx?track=${t}`;fetch(e).then(t=>{return t.json()}).catch(t=>{console.log(t)}).then(t=>{let d=t.track;let e=`https://${location.host}/api/v2.1/handlers/track/${d.id}/track/download/m?hq=1`;fetch(e,{headers:{Accept:"application/json; q=1.0, text/*; q=0.8, */*; q=0.1","X-Requested-With":"XMLHttpRequest","X-Retpath-Y":encodeURIComponent(location.href)}}).then(t=>{return t.json()}).catch(t=>{console.log(t)}).then(t=>{if(!t.src){y--;m.innerHTML=`<button class="button button_round button_action button-play button-play__type_track button_ico" id="_yamusic_save_button" style="background-color: #ff3333">error</button>`;return}let e=/^https?:\/\//i.test(t.src)?t.src:`https://${t.src}`;fetch(`${e}&format=json`).then(t=>{return t.json()}).catch(t=>{y--;m.innerHTML=`<button class="button button_round button_action button-play button-play__type_track button_ico" id="_yamusic_save_button" style="background-color: #ff3333">error</button>`}).then(async t=>{if(!t.s)return;let e=["XGRlBW9FXlekgbPrRHuSiA",t.path.substr(1),t.s],n="",r=[],o,a="",s="",c,i="";e=e.join("");e=window.Crypto.MD5(e);o=encodeURIComponent(`https://${t.host}/get-mp3/${e}/${t.ts}${t.path}`);if(d.title)a=d.title;if(d.artists[1]){for(let t in d.artists){n+=d.artists[t].name+",";r.push(d.artists[t].name)}n=n.substring(0,n.length-1)}else{if(d.artists[0]){r.push(d.artists[0].name);n=d.artists[0].name}else{n=d["title"]}}if(d.version)a=a+` (${d.version})`;n=k(`${n} - ${a}.mp3`);if(d.albums[0]){s=d.albums[0]["title"]||"";i=d.albums[0]["year"]||"";try{genre=d.albums[0]["genre"]||d.albums[0]["genre"][0]}catch(t){genre=""}try{number=d.albums[0]["trackPosition"]["index"]}catch(t){number=""}}const l=await g(["tags","folder","path","position","cover"]);if(d.coverUri){let t="400x400";if(l.cover){t=l.cover}const b=d.coverUri.replace("%%",t);c=encodeURIComponent(`https://${b}`)}const u={message:"data",url:o,name:n,artist:r,title:a,album:s,cover:c,year:i,genre:genre,number:number,position:p};if(u.message=="data"){_(u);function _(r){const t=fetch(decodeURIComponent(r.url)).then(t=>{f(t.clone().body.getReader(),t.headers.get("content-length"));return t.arrayBuffer()});const e=r.cover?fetch(decodeURIComponent(r.cover)).then(t=>t.arrayBuffer()):Promise.resolve(null);Promise.all([t,e]).then(t=>{const e=new browserId3Writer(t[0]);e.setFrame("TIT2",r.title).setFrame("TPE1",r.artist).setFrame("TPE2",r.artist).setFrame("TALB",r.album).setFrame("TYER",r.year).setFrame("TCON",[r.genre]).setFrame("TRCK",r.number);try{e.setFrame("APIC",{type:3,data:t[1],description:""})}catch(t){}if(l.tags==true){e.addTag()}let n;if(l.folder==true&&l.path.length>0){if(l.position==true){if(r.position>0){n=`${l.path}/${r.position}. ${r.name}`}else{n=`${l.path}/${r.number}. ${r.name}`}}else{n=`${l.path}/${r.name}`}}else{if(l.position==true){if(r.position>0){n=`${r.position}. ${r.name}`}else{n=`${r.number}. ${r.name}`}}else{n=r.name}}browser.runtime.sendMessage({message:"download",url:e.arrayBuffer,filename:n},t=>{if(t?.status=="done"){m.innerHTML=`<button class="button button_round button_action button-play button-play__type_track button_ico" id="_yamusic_save_button" style="background-color: #0cf40c" title="Трек успешно скачен">100%</button>`;m.setAttribute("track-id",t.id);y--;console.log(`%cQueue: ${y}     Array: ${h.length}`,"border-radius: 2px; padding: 2px 4px; color: #fff; background-color: purple");if(y==0&&h.length==0){$()}if(h.length>0){const e=h.shift();v(e[0],e[1],e[2])}}})}).catch(t=>{console.log(t)})}}})}).catch(t=>{return null})}).catch(t=>{return null})}function a(e){let r=document.createElement("span");let t=e.querySelector("._yamusic_download_all_container");if(!t){r.className="_yamusic_download_all_btn";r.title="Нажми, чтобы скачать все аудиозаписи. Максимальное кол-во скачиваний ограничивается 100 треками.";r.innerHTML="Скачать все аудиозаписи (max = 100)";t=document.createElement("div");t.className="_yamusic_download_all_container";t.appendChild(r)}function n(t){let n=e.querySelectorAll(t);r.innerHTML=`Загрузка ${n.length} треков началась...<br> * Загрузка будет завершена автоматически *`;r.title="Ожидайте окончания загрузки всех треков (max = 100)";for(let e=0;e<n.length;e++){let t=n.item(e);t.click()}}r.removeEventListener("click",o,false);r.addEventListener("click",o,false);function o(){n("#_yamusic_save_button")}e.insertBefore(t,e.nextSibling)}function $(){document.querySelectorAll("._yamusic_download_all_btn").forEach(t=>{if(t.innerText.includes("*")){t.style.color="#0cf40c";t.innerText="Загрузка завершена"}})}function o(e,t,n){if(e?.message=="crash"){try{let t=document.querySelector(`[track-id='${e.id}']`);t.innerHTML='<button class="button button_round button_action button-play button-play__type_track button_ico" id="_yamusic_save_button" style="background-color: #ff3333" title="Произошла ошибка... Нажмите на иконку, чтобы скачать ещё раз.">error</button>'}catch(t){}}}e();browser.runtime.onMessage.addListener(o)})();