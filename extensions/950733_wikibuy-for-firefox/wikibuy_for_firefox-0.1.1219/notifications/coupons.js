import{a as be,b as Ie}from"../chunks/chunk-B4ALZHVJ.js";import{a as ae}from"../chunks/chunk-TTUV466N.js";import{a as $,f as ke}from"../chunks/chunk-MLUAWWJO.js";import"../chunks/chunk-2TNTZIHB.js";import{a as De}from"../chunks/chunk-AU5XKNPD.js";import{a as Re}from"../chunks/chunk-5VY5EMKN.js";import{G as ye,I as ve,a as pe,f as ue,i as we,j as Te,l as Se,m as Ce}from"../chunks/chunk-Z2ZWTSDM.js";import"../chunks/chunk-5SH53EW4.js";import"../chunks/chunk-FQ7KGWHN.js";import{a as Ye,b as M}from"../chunks/chunk-4DY7Q7SZ.js";import{a as N,b as J}from"../chunks/chunk-WDPQNPC7.js";import{A as he,B as _e,C as B,c as le,g as me,s as fe,z as de}from"../chunks/chunk-HMFVUZXK.js";import"../chunks/chunk-3REBBJSH.js";import"../chunks/chunk-543EMZFQ.js";import"../chunks/chunk-L4RDDWJP.js";import"../chunks/chunk-34DZYYOD.js";import"../chunks/chunk-XD5O2TNZ.js";import{a as ie}from"../chunks/chunk-ZN5XPMIY.js";import{a as ne}from"../chunks/chunk-RIL6IOBV.js";import{b as se,e as re,h as ce}from"../chunks/chunk-6BB4SG5R.js";import"../chunks/chunk-6V4PETGI.js";import{b as ge}from"../chunks/chunk-IJLSJJ7U.js";import"../chunks/chunk-LG525BKV.js";import"../chunks/chunk-WOENBU2A.js";import{a as G}from"../chunks/chunk-W32UHEZE.js";import{a as Z,b as je}from"../chunks/chunk-3DLX7NOK.js";import"../chunks/chunk-4GJAJKDK.js";import"../chunks/chunk-HGJD3ZUF.js";import"../chunks/chunk-JDV5FZKX.js";import"../chunks/chunk-5GRN66PK.js";import"../chunks/chunk-BCG2KUGW.js";import"../chunks/chunk-QCT7FZJD.js";import"../chunks/chunk-FVPQGETT.js";import"../chunks/chunk-Z64FBUPL.js";import"../chunks/chunk-KWDMUJJA.js";import{a as oe}from"../chunks/chunk-MT4LVDUX.js";import"../chunks/chunk-WN4MFSKN.js";import"../chunks/chunk-7S3YJSN5.js";import{a as C}from"../chunks/chunk-QUFHRGH2.js";import"../chunks/chunk-BODFWMPN.js";import{M as U,c as z}from"../chunks/chunk-LADTODTA.js";import"../chunks/chunk-O4TFJKJQ.js";import{B as S,c as o,d as x,h as te,r as u,v as y,w as E,x as v}from"../chunks/chunk-WRHUMLYF.js";import"../chunks/chunk-RXMLGJMT.js";import"../chunks/chunk-AC7VHEB5.js";import"../chunks/chunk-HY2GWXPO.js";import"../chunks/chunk-XSKOAVIS.js";import{G as He,R as ee,S as Ke,d as Q,j as X,p as Be,q as $e}from"../chunks/chunk-OEPSEZ5A.js";import"../chunks/chunk-XERCZVWP.js";import"../chunks/chunk-AT6M4CEW.js";import{e as W}from"../chunks/chunk-3GYLW4KZ.js";var Fe=W(He());Be();var t=W($e());var q=W(Ye());Ke();je();var Ae=a=>v("getAutoCoupTestList",a);var Ve=a=>v("getRooVsTiggerDomains",a);var xe=a=>v("getSelectPartnersList",a);var Ne=()=>v("hasDeferredCouponRewards");function H(){return o.get(["couponView","rooVsTiggerDomains"])?.includes(y())}window.__wb_timing.couponsRequireAt=performance.now();var Qe=new Set(["etsy.com","amazon.com"]),P=!1,O=!1,Xe=t.default.throttle(ae,2e3),Ze=()=>{setTimeout(()=>{let a={currentLocation:t.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])},n=t.default.extend({},window.__wb_timing,a);S("track","pageTimingMetrics",n)},5e3)};function et(){return Fe.default.all([ne(),G(),ce(),ie(),Ne(),Ie(),xe(),Ve(),Ae()]).spread((a,n,c,i,r,g,l,p,_)=>{Re(a),o.merge({siteAPIData:n}),o.merge({cashback:c}),o.set("lifetimeSavings",i),o.set(["couponView","hasDeferredCouponRewards"],r),o.set("sameTabRedirectDomains",g),o.set(["couponView","selectPartnersList"],l),o.set(["couponView","rooVsTiggerDomains"],p),o.set(["couponView","autoCoupTestList"],_)})}var tt=[{domain:"etsy.com"},{domain:"amazon.com",condition:a=>{let n=t.default.get(a,"pageType")==="checkoutPage",c=t.default.get(a,"pageData.meta"),i=c?c.coupon_input_present:!1;return n&&i}}];function Oe(a,n){return!!t.default.find(tt,i=>i.domain===a&&(i.condition?i.condition(n):!0))}async function Pe(){if(await et(),await De("24_hr_throttle_all"))return;let n=y();Ze();let c=["macys.com","jcpenney.com","kohls.com","walgreens.com","groupon.com","loft.com","fanatics.com","samsung.com","ulta.com","overstock.com","wish.com"];if(u("ext_inc_v_2")&&c.includes(n))return;if(navigator.userAgent.indexOf("Firefox")>-1&&n.match(/eyebuydirect\.com/))return!1;let i=o.get("cashback"),r=await N("emailCreateAccount");r&&JSON.parse(r)?.shouldLoadNotification&&(await J("emailCreateAccount"),me(t.default.get(i,"reward",null)));let g=await N("affiliateRedirect");if(g){let s=JSON.parse(g);if(o.set("affiliateRedirect",s),re()){let e=window.location.href,d=o.get("pageViewId");be({resolvedUrl:e,domain:n,pageViewId:d})}}o.set("couponsVisible",!1);let l=o.get("siteAPIData"),p=await nt(l),_=t.default.get(l,"siteData.coupons.tld")==="ebay.com"&&t.default.get(l,"siteData.coupons.coupons.length");le()||(i&&!i.postCoupons&&!_?x({active:!0,cashback:i,fromCoupons:!0}):x({active:!0}));let m;try{m=JSON.parse(sessionStorage.getItem("ogPageData")),m&&m.expires<Z()&&(sessionStorage.removeItem("ogPageData"),m=null)}catch{}async function R(s){if(Xe(n,s),await it(s),s.callSource==="internal"&&s.pageData)try{let e=JSON.parse(sessionStorage.getItem("cartTotalAfterSavings"));if(sessionStorage.removeItem("cartTotalAfterSavings"),!Number.isNaN(e.value)){let d=Date.now()-e.time;s.pageData?.order?.total>e.value&&d<2e3&&S("track","extensionError",{type:"coupon_error"})}}catch{}if(s.callSource==="coupons_start"&&s.pageData)sessionStorage.setItem("ogPageData",JSON.stringify({...s.pageData,expires:X(Q(new Date,3))}));else if(s.callSource==="coupons_end"){let e=o.select("couponView").get("resultTemp");e||(e=o.select("couponView").get("result"),e.pageReload=void 0);try{m=JSON.parse(sessionStorage.getItem("ogPageData"))}catch{}sessionStorage.removeItem("ogPageData");let d=t.default.get(m,"order.total");if(e.deweyOriginalTotal=d,e.savings>0){t.default.get(s,"pageData.products.length")>1?s.pageData.products=t.default.map(s.pageData.products,(h,V)=>(t.default.has(h,"list_price")&&t.default.has(m,`products[${V}].list_price`)&&m.products[V].list_price-h.list_price&&(h.coupon_savings=m.products[V].list_price-h.list_price),h.coupon_applied=e.bestCoupon.code,h)):t.default.get(s,"pageData.products.length")===1&&(s.pageData.products[0].coupon_savings=e.savings,s.pageData.products[0].coupon_applied=e.bestCoupon.code);let k=s.pageData?.order?.total;k>0&&sessionStorage.setItem("cartTotalAfterSavings",JSON.stringify({value:k,time:Date.now()}))}let I=y(),T=o.get("couponsConfig");if(T&&T.pageWasReloaded){T.result=e;let k=o.get("couponView"),h=t.default.get(k,"resultTemp.allCoupons",[]);Qe.has(I)&&h.length>0&&(T.coupons=t.default.cloneDeep(h)),A(T,i)}else o.select("couponView").set("result",e);e&&e.couponScriptType==="roo"&&S("track","rooActionTiming",{triggerType:e.automaticCouponsRun?"auto":e.autoFallback?"auto_fallback":e.isSiteHub?"site_hub":null,couponRunId:e.couponRunId,aggApplyCodeTime:e.aggApplyCodeTime,aggGetTotalTime:e.aggGetTotalTime,aggRemovePreviousTime:e.aggRemovePreviousTime,aggWaitForReloadTime:e.aggWaitForReloadTime,initialActionTime:e.initialActionTime,currentLocation:t.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])});let{cleanedSavings:K,wasCleaned:Ee}=st(e.savings),{automaticCouponsRun:Me,autoFallback:Je,isSiteHub:qe,manuallyActivatedAutoRun:We,manuallyActivatedFallback:ze}=e,Ue=pe({automaticCouponsRun:Me||We,autoFallback:Je,isSiteHub:qe,manuallyActivatedFallback:ze});o.select("couponView").set("manuallyActivatedAutoRun",e.manuallyActivatedAutoRun);let Ge=localStorage.getItem("__wb_redirecting")&&e.manuallyActivatedAutoRun,Y=o.get("affiliateRedirect");if(e.manuallyActivatedAutoRun&&Y&&(e.couponRunId=t.default.get(Y,"couponRunId",e.couponRunId)),!Ge){let k=oe(K,{noDollarSign:!0})??"0",h=t.default.round(parseFloat(k),2);await chrome.storage.local.set({lastCouponSavings:h});let V=await ot();S("track","tryCouponsResult",{triggerType:Ue,couponScriptType:e.couponScriptType,clickId:e.clickId,redirectId:ee(e.clickId),couponRunId:e.couponRunId,cashback:e.cashback,deweyOriginalTotal:e.deweyOriginalTotal,originalTotal:e.originalTotal,originalTotalV2:e.originalTotalV2,baseTotal:e.baseTotal,finalTotal:e.finalTotal,savingsOld:e.savings||0,savings:K,savingsCurrency:l?.siteData?.merchantPage?.currency,savingsWasCleaned:Ee,shopifyLoggedIn:e.shopLoggedIn,couponReloadSkipped:e.couponReloadSkipped,errored:e.errored,runTime:e.runTime,runTimeV2:new Date().getTime()-t.default.get(e,"startTime")||null,totalCouponsTested:t.default.get(e,"coupons.length"),coupons:t.default.get(e,"coupons"),originalCoupons:e.originalCoupons,preappliedCodes:e.preappliedCodes,bestCoupon:t.default.get(e,"bestCoupon.code"),platform:e.platform,cartData:V,currentLocation:t.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])}),S("track","deweyResult",t.default.assign(s,{url:window.location.href}))}}else if(m&&t.default.get(s,"pageType")&&!O)O=!0,p();else if(Oe(n,s)&&!P){if(t.default.get(s,"pageData"))if(n==="amazon.com")await Le(s,p,i);else{let e=await p();if(e){P=!0;let d=await C({message:"getClassifierCodes",domain:n,pageData:s.pageData});if(d){let I=L({siteAPIData:l,classifierCoupons:d,rankedCoupons:e.coupons});e.coupons=I}A(e,i)}}}else if(O&&u("ext_coupons_skip_cashback_fallback")&&l?.siteData?.coupons?.type==="roo"&&(s.pageType==="cartPage"||s.pageType==="checkoutPage")&&!o.get(["couponView","rooIsCheckingForCouponPage"])&&!o.get(["couponView","rooIsCouponPage"])){let e=await p();e&&A(e,i)}else if(!u("ext_coupons_skip_cashback_fallback")&&!o.get("cashbackVisible")&&!t.default.get(i,"postCoupons")){let e=Ce()?3e3:1e3;setTimeout(()=>{if(!o.get("couponsVisible")){let d=o.get("deweyResult");B(d)}},e)}}let b=await N("rooReloading"),D=o.get("deweyResult");D&&!b&&R(D),b&&await J("rooReloading"),ge.emitter.on("result",R);function L({siteAPIData:s,classifierCoupons:e,rankedCoupons:d}={}){let I=t.default.get(s,"siteData.coupons.count"),T=t.default.concat(e,d);return T=t.default.uniqBy(T,"code"),T.slice(0,I)}let f=Oe(n,D),w;!f&&!O&&(O=!0,w=await p());let F=t.default.get(D,"pageData");if(f){if(n==="amazon.com")await Le(D,p,i);else if(F&&!P){let s=await p();if(s){P=!0;let e=await C({message:"getClassifierCodes",domain:n,pageData:F});e&&(s.coupons=e),A(s,i)}}}w&&!w.pageWasReloaded&&A(w,i)}async function A(a,n){let c="/coupons",{standDown:i}=a,r=y();o.merge("couponView",a);let g=o.get("cashbackView")||n;o.set("cashbackView",g);let l={initialRoute:c,cssUrl:"coupons.css",routeConfig:{childRoutes:[{path:"coupons",component:z(ke)},{path:"reactivate",component:z(de)}]},disableDelay:!0};if(g&&t.default.get(g,"user.compInactivated")&&_e()&&!o.get("cashbackReactivateVisible")&&!o.get("throttleCreditsReactivation")){o.set(["warnAboutStandDown"],!0),o.set("cashbackReactivateVisible",!0),c="/reactivate",U({...l,initialRoute:c});return}let _=o.get("affiliateRedirect");if(sessionStorage.getItem("__wb_same_tab_auto")||sessionStorage.getItem("__r_reload_auto")){let f;if(_&&({manuallyActivatedAutoRun:f}=_,f&&o.select("couponView").set("manuallyActivatedAutoRun",f)),sessionStorage.getItem("__wb_same_tab_auto")){let w=JSON.parse(sessionStorage.getItem("__wb_same_tab_auto"));f=t.default.get(w,"manuallyActivatedAutoRun")}if(sessionStorage.getItem("__r_reload_auto")){let w=JSON.parse(sessionStorage.getItem("__r_reload_auto"));f=t.default.get(w,"manuallyActivatedAutoRun")}f||await C({domain:r,message:"endThrottle"})}try{let f=await N("deferredPinTab");f&&(se(JSON.parse(f)),J("deferredPinTab"))}catch{}let m=Se(),R=r;fe(r)&&o.get("deweyResult","pageType")==="checkoutPage"&&(R="amazon.com_checkout");let b=await C({domain:R,message:"isThrottled",isAutoCoup:m});if(m&&await C({domain:R,message:"isAutoCoupThrottled",isAutoCoup:m})){if(o.get("affiliateRedirect")){let w=sessionStorage.getItem("__wb_clickId"),F=localStorage.getItem("__wb_redirecting");if(w&&!F){b||(sessionStorage.removeItem("__wb_clickId"),Te());return}}o.select("couponView").set("autoCoupThrottled",!0)}let D=!!o.get(["events","hasSeenCouponsThrottleToolTip"]),L=b&&!D&&!a.pageWasReloaded;if(o.select("couponView").set("showThrottleToolTip",L),b&&!a.pageWasReloaded){if(o.set("couponsThrottled",!0),!L){x({active:!0,textOverride:`${t.default.get(a,"coupons.length","")}C`}),u("ext_coupons_skip_cashback_fallback")&&!u("ext_coupons_skip_cashback_when_throttled")&&B(o.get("deweyResult"));return}}else if(i){o.set("couponsThrottled",!0),he();return}o.get(["couponView","standDownOverride"])&&x({active:!0,textOverride:`${t.default.get(a,"coupons.length","")}C`}),r==="groupon.com"&&S("track","foundCouponsEnd",{pageViewId:o.get("pageViewId")}),o.get("couponsVisible")||(o.set("couponsVisible",!0),U(l))}function j(a,n){let c;n==="Shopify"&&(c=(0,q.getShopifyPath)()),S("track","platformIdentified",{platform:n,currentLocation:t.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"]),shopifyPath:c})}async function ot(){let a=y(),n=u("ext_separate_domain_platform")?o.get("platformDomain"):await M(a);if(u("ext_separate_domain_platform")?o.get("platform")==="Shopify":n){let i=await C({message:"makeRequest",reqInfo:{method:"GET",url:`https://${n}/cart.json`,headers:{Accept:"*/*"}}});if(i?.items?.length>0)return at(i)}}function at(a){let n=t.default.map(a.items,c=>t.default.pick(c,["id","product_id","sku","url","discounts","discounted_price","original_price","image","title","variant_title"]));return{cartLevelDiscountApplications:a?.cart_level_discount_applications,cartItems:n,originalTotal:a?.original_total_price,totalDiscount:a?.total_discount,totalPrice:a?.total_price}}async function it(a){let n=y(),c=u("ext_separate_domain_platform")?o.get("platformDomain"):await M(n);if((u("ext_separate_domain_platform")?o.get("platform")==="Shopify":c)&&a&&a.pageType==="checkoutPage"){let r=document.querySelectorAll(".notice.notice--warning .notice__text"),g=t.default.find(r,l=>l.offsetHeight>0);if(g){let l=g.querySelector("strong").innerText.trim();S("track","shopifyInvalidCouponDetected",{domain:n,coupon:l})}}}async function nt(a){let n=t.default.get(a,"tld");if(H()){let g=u("roo_coup_24_q_3_test")&&"roo"||u("tigger_coup_24_q_3_test")&&"asyncTigger";g&&t.default.assign(a.siteData.coupons,{type:g})}let c=await(0,q.getPlatform)({hasFeature:u,desktop:!0});c&&(o.set(["platform"],c),j(n,c)),E(n);let i=u("ext_separate_domain_platform")?o.get("platformDomain"):await M(n),r=u("ext_separate_domain_platform")?o.get("platform")==="Shopify":i;if(i&&(u("ext_separate_domain_platform")?j(n,o.get("platform")):j(n,"Shopify")),t.default.get(a,"siteData.coupons.ignoreSite"))return t.default.noop;if(t.default.get(a,"siteData.coupons.type")==="eeyore"&&t.default.get(a,"siteData.coupons.coupons.length")>0)return t.default.get(a,"siteData.coupons.identifiers")?ve:t.default.noop;if(t.default.get(a,"siteData.coupons.type")==="tigger"&&(i||await ue.isTiggerSite(n,c))){if(i){if(E(i),i!==n){let l=await C({message:"makeRequest",reqInfo:{method:"GET",url:`${te}/site/${i}`,headers:{"Content-Type":"application/json"}}}),p=t.default.get(l,"siteData.coupons"),_=t.default.get(l,"siteData");t.default.assign(a,{tld:p.tld,cashback:_?.cashback,merchantPage:_?.merchantPage,pageTypesV2:_?.pageTypesV2}),E(p.tld),t.default.assign(a.siteData.coupons,{coupons:p.items||[],ignoreSite:t.default.isUndefined(p.ignoreSite)?!0:p.ignoreSite,ignoreAffiliate:t.default.isUndefined(p.ignoreAffiliate)?!0:p.ignoreAffiliate,tld:p.tld}),o.merge({siteAPIData:a})}r&&(a.siteData.coupons.shopify=!0,a.siteData.appliedCodeSelector=".applied-reduction-code__information"),await G(t.default.assign(a,{domain:i,setSite:!0}))}return!!(u("shopify_async_tigger")&&r)?$:ye}else{if(t.default.get(a,"siteData.coupons.type")==="roo")return we.initCoupons;if(t.default.get(a,"siteData.coupons.type")==="asyncTigger")return t.default.get(a,"siteData.coupons.identifiers")?$:t.default.noop}return t.default.noop}async function Le(a,n,c){if(a){let i=await n({experience:"checkout"});if(!u("amz_class_on"))return;P=!0;let r=await C({message:"getClassifierCodes",domain:"amazon.com",pageData:a.pageData,pageViewId:o.get("pageViewId")});r&&(i.coupons=r),r&&r.length>=1&&(i.couponCount=r.length,A(i,c))}}function st(a){let i=!1,r=a||0;return r=parseInt(r),isNaN(r)&&(i=!0,r=0),r>1e8?(i=!0,r=1e8):r<-1e8&&(i=!0,r=-1e8),{cleanedSavings:r,wasCleaned:i}}document.readyState!=="loading"?Pe():document.addEventListener("DOMContentLoaded",Pe);export{Pe as init};
