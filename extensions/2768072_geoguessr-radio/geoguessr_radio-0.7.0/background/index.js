"use strict";(()=>{var E="external-radio",w="radio-client",g=chrome.runtime.getManifest().manifest_version===2,p=chrome.runtime.getURL("public/external-radio.html"),m={isOn:!0,anchor:"center",autoCollapse:!0,playerMode:g?"background":"window",usesClassicCompass:!1,isMuted:!1,volume:25,lastPlayed:"",autoSwitch:!1,autoSwitchDelay:10,vibe:null,favorites:{},playFavorite:!1},u=null,f=null,c=!1,i,a=null,t={},s="";chrome.runtime.onInstalled.addListener(M);chrome.runtime.onStartup.addListener(M);chrome.storage.local.get(["isOn","playerMode"],e=>t=e);chrome.runtime.onMessageExternal.addListener((e,o,d)=>{});chrome.storage.onChanged.addListener((e,o)=>{if(e.isOn&&(t.isOn=e.isOn.newValue,t.isOn||l()),e.playerMode){let d=a!==null;l(),t.playerMode=e.playerMode.newValue,d&&L()}});chrome.runtime.onConnect.addListener(e=>{e.name===E?(l(),c=!1,a=e,a.onMessage.addListener(R),a.onDisconnect.addListener(T),u&&(a.postMessage(u),u=null)):e.name===w&&(e.onMessage.addListener(b),e.onDisconnect.addListener(_),g||(e._timer=setTimeout(x,25e4,e)),i||(i=e,f&&(i.postMessage(f),f=null)))});chrome.webRequest.onCompleted.addListener(e=>{t.isOn&&(e.method!=="GET"||!e.url.endsWith("ignore=1"))&&chrome.tabs.sendMessage(e.tabId,{action:"refresh"},o=>{})},{urls:["https://www.geoguessr.com/api/v3/games/*"]});chrome.commands.onCommand.addListener(e=>{e==="toggle-radio"?(t.isOn=!t.isOn,chrome.storage.local.set({isOn:t.isOn})):(e==="increase-volume"||e==="decrease-volume"||e==="next-station")&&O(e)});function O(e){var o;(o=chrome.runtime)!=null&&o.id&&i&&t.isOn&&i.postMessage({action:e})}function v(){i&&t.isOn&&(i.postMessage({event:"abort"}),i.postMessage({event:"pause"}))}function b(e,o){!t.isOn||e.action==="ping"||(i&&i!=o&&v(),i=o,t.playerMode==="background"?I(e):(t.playerMode==="window"||t.playerMode==="tab")&&(a?a.postMessage(e):u=e,!a&&e.action!=="volume"&&L()))}function R(e,o){t.isOn&&(e.action==="ready"&&t.playerMode==="tab"&&i&&chrome.tabs.highlight({tabs:i.sender.tab.index}).catch(()=>{}),i?i.postMessage(e):f=e)}function T(e){a===e&&(a=null,v())}function _(e){y(e),chrome.tabs.query({url:"https://www.geoguessr.com/*"},o=>{o.length||l()})}function x(e){y(e),e.disconnect()}function y(e){i===e&&(i=null),e._timer&&(clearTimeout(e._timer),delete e._timer)}function h(){c=!1}function L(){if(!(!t.isOn||c)){if(t.playerMode==="window"){l(),c=!0;let e={url:p,type:"panel",width:450,height:220};chrome.windows.create(e).catch(h)}else if(t.playerMode==="tab"){l(),c=!0;let e={url:p,active:!0};i&&(e.openerTabId=i.sender.tabId),chrome.tabs.create(e).catch(h)}}}function l(){n&&D(),a&&(a.disconnect(),a=null)}function M(){chrome.storage.local.get(Object.keys(m),e=>{t=e;for(let[o,d]of Object.entries(m))t.hasOwnProperty(o)||(t[o]=d);chrome.storage.local.set(t)})}var n=null;function I(e){n||C(),e.volume>=0&&e.volume<=1&&(n.volume=e.volume),(s!==e.src||e.action==="src")&&(s=e.src,s.length&&(n.src=s)),e.action==="pause"?n.pause():e.action==="stop"?(n.pause(),n.currentTime=0,s=""):e.action==="play"&&s.length&&n.play().catch(()=>{})}function C(){n=new Audio,n.addEventListener("play",r),n.addEventListener("playing",r),n.addEventListener("pause",r),n.addEventListener("abort",r),n.addEventListener("error",r),n.addEventListener("waiting",r)}var r=e=>(i&&i.postMessage({event:e.type}),!1);function D(){n.removeEventListener("play",r),n.removeEventListener("playing",r),n.removeEventListener("pause",r),n.removeEventListener("abort",r),n.removeEventListener("error",r),n.removeEventListener("waiting",r),n.pause(),n.currentTime=0,n=null}})();
