{"version":3,"file":"10ten-ja-options.js","sources":["webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+json-equalish@1.1.2/node_modules/@birchill/json-equalish/src/index.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/webextension-polyfill@0.12.0/node_modules/webextension-polyfill/dist/browser-polyfill.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/src/constants.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/src/util.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/src/options.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/src/create-element.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/src/component.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/src/diff/props.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/src/create-context.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/src/diff/children.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/src/diff/index.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/src/render.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/src/clone-element.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/src/diff/catch-error.js","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/fetch-delivery.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/safe-filter.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/is-error.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/is-object.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/parse-stack.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/to-exceptions.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/browser-unhandled-exceptions.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/browser-unhandled-rejections.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/console-breadcrumbs.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/error-breadcrumbs.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/fetch-breadcrumbs.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/interaction-breadcrumbs.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/navigation-breadcrumbs.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/app-duration.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/simple-ua-parser.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/browser-context.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/deviceorientation.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/limit-events.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/stringify.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/stringify-values.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/browser-handled-rejection-breadcrumbs.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+bugsnag-zero@0.6.9/node_modules/@birchill/src/index.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/superstruct@2.0.2/node_modules/superstruct/dist/index.mjs","webpack://10ten-ja-reader/./src/background/fx-data.ts","webpack://10ten-ja-reader/./src/utils/is-object.ts","webpack://10ten-ja-reader/./src/utils/strip-fields.ts","webpack://10ten-ja-reader/./src/utils/ua-utils.ts","webpack://10ten-ja-reader/./src/common/db-languages.ts","webpack://10ten-ja-reader/./src/common/extension-storage-error.ts","webpack://10ten-ja-reader/./src/common/popup-keys.ts","webpack://10ten-ja-reader/./src/common/refs.ts","webpack://10ten-ja-reader/./src/common/config.ts","webpack://10ten-ja-reader/./src/utils/release-stage.ts","webpack://10ten-ja-reader/./src/utils/bugsnag.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/hooks/src/index.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/compat/src/util.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/compat/src/PureComponent.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/compat/src/memo.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/compat/src/forwardRef.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/compat/src/Children.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/compat/src/suspense.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/compat/src/suspense-list.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/compat/src/portals.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/compat/src/render.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/compat/src/index.js","webpack://10ten-ja-reader/./node_modules/.pnpm/preact@10.24.2/node_modules/preact/jsx-runtime/src/index.js","webpack://10ten-ja-reader/./src/common/i18n.tsx","webpack://10ten-ja-reader/./src/utils/device.ts","webpack://10ten-ja-reader/./src/common/priority-labels.ts","webpack://10ten-ja-reader/./src/content/reference-value.ts","webpack://10ten-ja-reader/./src/content/copy-text.ts","webpack://10ten-ja-reader/./src/options/CheckboxRow.tsx","webpack://10ten-ja-reader/./src/options/NewBadge.tsx","webpack://10ten-ja-reader/./src/options/CopySettingsForm.tsx","webpack://10ten-ja-reader/./src/options/SectionHeading.tsx","webpack://10ten-ja-reader/./src/options/use-config-value.ts","webpack://10ten-ja-reader/./src/options/CopySettings.tsx","webpack://10ten-ja-reader/./src/options/CurrencySettingsForm.tsx","webpack://10ten-ja-reader/./src/options/CurrencySettings.tsx","webpack://10ten-ja-reader/./node_modules/.pnpm/idb@8.0.0/node_modules/idb/build/index.js","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+normal-jp@1.5.2/node_modules/@birchill/normal-jp/src/to-normalized.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/abort-error.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/data-series.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/download-error.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/validation-helpers.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/download-version-info.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/download.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/quota-exceeded-error.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/download-types.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/offline-error.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/words.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/word-result-sorting.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/request-idle-callback.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/update-key.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/@birchill+jpdict-idb@2.6.1/node_modules/@birchill/jpdict-idb/src/update-with-retry.ts","webpack://10ten-ja-reader/./node_modules/.pnpm/classname-variants@1.5.0/node_modules/classname-variants/lib/index.js","webpack://10ten-ja-reader/./node_modules/.pnpm/classname-variants@1.5.0/node_modules/classname-variants/lib/react.js","webpack://10ten-ja-reader/./src/common/data-series-labels.ts","webpack://10ten-ja-reader/./src/utils/classes.ts","webpack://10ten-ja-reader/./src/options/Linkify.tsx","webpack://10ten-ja-reader/./src/options/format.ts","webpack://10ten-ja-reader/./src/options/DbStatus.tsx","webpack://10ten-ja-reader/./src/common/db-listener-messages.ts","webpack://10ten-ja-reader/./src/options/use-db.ts","webpack://10ten-ja-reader/./src/options/DictionaryDataSettings.tsx","webpack://10ten-ja-reader/./src/options/DictionaryLanguageSettingsForm.tsx","webpack://10ten-ja-reader/./src/options/DictionaryLanguageSettings.tsx","webpack://10ten-ja-reader/./src/options/IconRadio.tsx","webpack://10ten-ja-reader/./src/options/HighlightStyleRadio.tsx","webpack://10ten-ja-reader/./src/options/ToolbarIconRadio.tsx","webpack://10ten-ja-reader/./src/options/GeneralSettingsForm.tsx","webpack://10ten-ja-reader/./src/options/GeneralSettings.tsx","webpack://10ten-ja-reader/./src/options/KanjiReferenceSettingsForm.tsx","webpack://10ten-ja-reader/./src/options/KanjiReferenceSettings.tsx","webpack://10ten-ja-reader/./src/common/copy-keys.ts","webpack://10ten-ja-reader/./src/options/KeyBox.tsx","webpack://10ten-ja-reader/./src/options/PopupKeysForm.tsx","webpack://10ten-ja-reader/./src/options/ShowPopupKeysForm.tsx","webpack://10ten-ja-reader/./src/options/commands.ts","webpack://10ten-ja-reader/./src/options/ToggleKeyForm.tsx","webpack://10ten-ja-reader/./src/options/KeyboardSettingsForm.tsx","webpack://10ten-ja-reader/./src/options/KeyboardSettings.tsx","webpack://10ten-ja-reader/./src/utils/use-has-mouse.ts","webpack://10ten-ja-reader/./src/utils/use-has-touch.ts","webpack://10ten-ja-reader/./src/utils/themes.ts","webpack://10ten-ja-reader/./src/utils/use-theme-class.ts","webpack://10ten-ja-reader/./src/options/MouseInteractivityRadio.tsx","webpack://10ten-ja-reader/./src/options/TabDisplayRadio.tsx","webpack://10ten-ja-reader/./src/options/PopupInteractivitySettingsForm.tsx","webpack://10ten-ja-reader/./src/options/PopupInteractivitySettings.tsx","webpack://10ten-ja-reader/./src/options/PopupThemeRadio.tsx","webpack://10ten-ja-reader/./src/options/PopupStyleForm.tsx","webpack://10ten-ja-reader/./src/options/PopupStyleSettings.tsx","webpack://10ten-ja-reader/./src/options/PuckSettingsForm.tsx","webpack://10ten-ja-reader/./src/options/PuckSettings.tsx","webpack://10ten-ja-reader/./src/options/UnitSettingsForm.tsx","webpack://10ten-ja-reader/./src/options/UnitSettings.tsx","webpack://10ten-ja-reader/./src/options/OptionsPage.tsx","webpack://10ten-ja-reader/./src/options/options.ts"],"sourcesContent":["export function jsonEqualish(actual: any, expected: any) {\n  if (Object.is(actual, expected)) {\n    return true;\n  }\n\n  // For non-objects, use Object.is. This will cause 'undefined' and 'null' to\n  // be different, as desired.\n  if (\n    !actual ||\n    !expected ||\n    (typeof actual !== 'object' && typeof expected !== 'object')\n  ) {\n    // Except for numbers, since we want '-0' and '+0' to be equivalent\n    //\n    // (We should really just use JSON.stringify here. Might be slower but would\n    // it matter?)\n    return typeof actual === 'number'\n      ? actual === expected\n      : Object.is(actual, expected);\n  }\n\n  return objEquiv(actual, expected);\n}\n\nfunction objEquiv(a: any, b: any) {\n  if (typeof a !== typeof b) {\n    return false;\n  }\n\n  if (a instanceof Date) {\n    return b instanceof Date && a.getTime() == b.getTime();\n  }\n\n  if (Array.isArray(a) !== Array.isArray(b)) {\n    return false;\n  }\n\n  // We only deal with POD at the moment.\n  if (\n    (a.constructor && a.constructor !== Object && a.constructor !== Array) ||\n    (b.constructor && b.constructor !== Object && b.constructor !== Array)\n  ) {\n    throw new Error('Trying to compare something fancy');\n  }\n\n  const aKeys = definedKeys(a);\n  const bKeys = definedKeys(b);\n  if (aKeys.length !== bKeys.length) {\n    return false;\n  }\n\n  aKeys.sort();\n  bKeys.sort();\n\n  // Compare keys first\n  for (let i = 0; i < aKeys.length; ++i) {\n    if (aKeys[i] != bKeys[i]) {\n      return false;\n    }\n  }\n\n  // Compare values\n  for (const key of aKeys) {\n    if (!jsonEqualish(a[key], b[key])) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\nfunction definedKeys(a: any) {\n  return Object.keys(a).filter(key => typeof a[key] !== 'undefined');\n}\n\nexport default jsonEqualish;\n","/* webextension-polyfill - v0.12.0 - Tue May 14 2024 18:01:29 */\n/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */\n/* vim: set sts=2 sw=2 et tw=80: */\n/* This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n\"use strict\";\n\nif (!(globalThis.chrome && globalThis.chrome.runtime && globalThis.chrome.runtime.id)) {\n  throw new Error(\"This script should only be loaded in a browser extension.\");\n}\n\nif (!(globalThis.browser && globalThis.browser.runtime && globalThis.browser.runtime.id)) {\n  const CHROME_SEND_MESSAGE_CALLBACK_NO_RESPONSE_MESSAGE = \"The message port closed before a response was received.\";\n\n  // Wrapping the bulk of this polyfill in a one-time-use function is a minor\n  // optimization for Firefox. Since Spidermonkey does not fully parse the\n  // contents of a function until the first time it's called, and since it will\n  // never actually need to be called, this allows the polyfill to be included\n  // in Firefox nearly for free.\n  const wrapAPIs = extensionAPIs => {\n    // NOTE: apiMetadata is associated to the content of the api-metadata.json file\n    // at build time by replacing the following \"include\" with the content of the\n    // JSON file.\n    const apiMetadata = {\n      \"alarms\": {\n        \"clear\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"clearAll\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"get\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"getAll\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        }\n      },\n      \"bookmarks\": {\n        \"create\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"get\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getChildren\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getRecent\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getSubTree\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getTree\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"move\": {\n          \"minArgs\": 2,\n          \"maxArgs\": 2\n        },\n        \"remove\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"removeTree\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"search\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"update\": {\n          \"minArgs\": 2,\n          \"maxArgs\": 2\n        }\n      },\n      \"browserAction\": {\n        \"disable\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1,\n          \"fallbackToNoCallback\": true\n        },\n        \"enable\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1,\n          \"fallbackToNoCallback\": true\n        },\n        \"getBadgeBackgroundColor\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getBadgeText\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getPopup\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getTitle\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"openPopup\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"setBadgeBackgroundColor\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1,\n          \"fallbackToNoCallback\": true\n        },\n        \"setBadgeText\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1,\n          \"fallbackToNoCallback\": true\n        },\n        \"setIcon\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"setPopup\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1,\n          \"fallbackToNoCallback\": true\n        },\n        \"setTitle\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1,\n          \"fallbackToNoCallback\": true\n        }\n      },\n      \"browsingData\": {\n        \"remove\": {\n          \"minArgs\": 2,\n          \"maxArgs\": 2\n        },\n        \"removeCache\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"removeCookies\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"removeDownloads\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"removeFormData\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"removeHistory\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"removeLocalStorage\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"removePasswords\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"removePluginData\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"settings\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        }\n      },\n      \"commands\": {\n        \"getAll\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        }\n      },\n      \"contextMenus\": {\n        \"remove\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"removeAll\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"update\": {\n          \"minArgs\": 2,\n          \"maxArgs\": 2\n        }\n      },\n      \"cookies\": {\n        \"get\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getAll\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getAllCookieStores\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"remove\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"set\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        }\n      },\n      \"devtools\": {\n        \"inspectedWindow\": {\n          \"eval\": {\n            \"minArgs\": 1,\n            \"maxArgs\": 2,\n            \"singleCallbackArg\": false\n          }\n        },\n        \"panels\": {\n          \"create\": {\n            \"minArgs\": 3,\n            \"maxArgs\": 3,\n            \"singleCallbackArg\": true\n          },\n          \"elements\": {\n            \"createSidebarPane\": {\n              \"minArgs\": 1,\n              \"maxArgs\": 1\n            }\n          }\n        }\n      },\n      \"downloads\": {\n        \"cancel\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"download\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"erase\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getFileIcon\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 2\n        },\n        \"open\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1,\n          \"fallbackToNoCallback\": true\n        },\n        \"pause\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"removeFile\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"resume\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"search\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"show\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1,\n          \"fallbackToNoCallback\": true\n        }\n      },\n      \"extension\": {\n        \"isAllowedFileSchemeAccess\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"isAllowedIncognitoAccess\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        }\n      },\n      \"history\": {\n        \"addUrl\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"deleteAll\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"deleteRange\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"deleteUrl\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getVisits\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"search\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        }\n      },\n      \"i18n\": {\n        \"detectLanguage\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getAcceptLanguages\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        }\n      },\n      \"identity\": {\n        \"launchWebAuthFlow\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        }\n      },\n      \"idle\": {\n        \"queryState\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        }\n      },\n      \"management\": {\n        \"get\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getAll\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"getSelf\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"setEnabled\": {\n          \"minArgs\": 2,\n          \"maxArgs\": 2\n        },\n        \"uninstallSelf\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        }\n      },\n      \"notifications\": {\n        \"clear\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"create\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 2\n        },\n        \"getAll\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"getPermissionLevel\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"update\": {\n          \"minArgs\": 2,\n          \"maxArgs\": 2\n        }\n      },\n      \"pageAction\": {\n        \"getPopup\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getTitle\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"hide\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1,\n          \"fallbackToNoCallback\": true\n        },\n        \"setIcon\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"setPopup\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1,\n          \"fallbackToNoCallback\": true\n        },\n        \"setTitle\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1,\n          \"fallbackToNoCallback\": true\n        },\n        \"show\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1,\n          \"fallbackToNoCallback\": true\n        }\n      },\n      \"permissions\": {\n        \"contains\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getAll\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"remove\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"request\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        }\n      },\n      \"runtime\": {\n        \"getBackgroundPage\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"getPlatformInfo\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"openOptionsPage\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"requestUpdateCheck\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"sendMessage\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 3\n        },\n        \"sendNativeMessage\": {\n          \"minArgs\": 2,\n          \"maxArgs\": 2\n        },\n        \"setUninstallURL\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        }\n      },\n      \"sessions\": {\n        \"getDevices\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"getRecentlyClosed\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"restore\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        }\n      },\n      \"storage\": {\n        \"local\": {\n          \"clear\": {\n            \"minArgs\": 0,\n            \"maxArgs\": 0\n          },\n          \"get\": {\n            \"minArgs\": 0,\n            \"maxArgs\": 1\n          },\n          \"getBytesInUse\": {\n            \"minArgs\": 0,\n            \"maxArgs\": 1\n          },\n          \"remove\": {\n            \"minArgs\": 1,\n            \"maxArgs\": 1\n          },\n          \"set\": {\n            \"minArgs\": 1,\n            \"maxArgs\": 1\n          }\n        },\n        \"managed\": {\n          \"get\": {\n            \"minArgs\": 0,\n            \"maxArgs\": 1\n          },\n          \"getBytesInUse\": {\n            \"minArgs\": 0,\n            \"maxArgs\": 1\n          }\n        },\n        \"sync\": {\n          \"clear\": {\n            \"minArgs\": 0,\n            \"maxArgs\": 0\n          },\n          \"get\": {\n            \"minArgs\": 0,\n            \"maxArgs\": 1\n          },\n          \"getBytesInUse\": {\n            \"minArgs\": 0,\n            \"maxArgs\": 1\n          },\n          \"remove\": {\n            \"minArgs\": 1,\n            \"maxArgs\": 1\n          },\n          \"set\": {\n            \"minArgs\": 1,\n            \"maxArgs\": 1\n          }\n        }\n      },\n      \"tabs\": {\n        \"captureVisibleTab\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 2\n        },\n        \"create\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"detectLanguage\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"discard\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"duplicate\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"executeScript\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 2\n        },\n        \"get\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getCurrent\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        },\n        \"getZoom\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"getZoomSettings\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"goBack\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"goForward\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"highlight\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"insertCSS\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 2\n        },\n        \"move\": {\n          \"minArgs\": 2,\n          \"maxArgs\": 2\n        },\n        \"query\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"reload\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 2\n        },\n        \"remove\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"removeCSS\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 2\n        },\n        \"sendMessage\": {\n          \"minArgs\": 2,\n          \"maxArgs\": 3\n        },\n        \"setZoom\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 2\n        },\n        \"setZoomSettings\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 2\n        },\n        \"update\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 2\n        }\n      },\n      \"topSites\": {\n        \"get\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        }\n      },\n      \"webNavigation\": {\n        \"getAllFrames\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"getFrame\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        }\n      },\n      \"webRequest\": {\n        \"handlerBehaviorChanged\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 0\n        }\n      },\n      \"windows\": {\n        \"create\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"get\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 2\n        },\n        \"getAll\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"getCurrent\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"getLastFocused\": {\n          \"minArgs\": 0,\n          \"maxArgs\": 1\n        },\n        \"remove\": {\n          \"minArgs\": 1,\n          \"maxArgs\": 1\n        },\n        \"update\": {\n          \"minArgs\": 2,\n          \"maxArgs\": 2\n        }\n      }\n    };\n\n    if (Object.keys(apiMetadata).length === 0) {\n      throw new Error(\"api-metadata.json has not been included in browser-polyfill\");\n    }\n\n    /**\n     * A WeakMap subclass which creates and stores a value for any key which does\n     * not exist when accessed, but behaves exactly as an ordinary WeakMap\n     * otherwise.\n     *\n     * @param {function} createItem\n     *        A function which will be called in order to create the value for any\n     *        key which does not exist, the first time it is accessed. The\n     *        function receives, as its only argument, the key being created.\n     */\n    class DefaultWeakMap extends WeakMap {\n      constructor(createItem, items = undefined) {\n        super(items);\n        this.createItem = createItem;\n      }\n\n      get(key) {\n        if (!this.has(key)) {\n          this.set(key, this.createItem(key));\n        }\n\n        return super.get(key);\n      }\n    }\n\n    /**\n     * Returns true if the given object is an object with a `then` method, and can\n     * therefore be assumed to behave as a Promise.\n     *\n     * @param {*} value The value to test.\n     * @returns {boolean} True if the value is thenable.\n     */\n    const isThenable = value => {\n      return value && typeof value === \"object\" && typeof value.then === \"function\";\n    };\n\n    /**\n     * Creates and returns a function which, when called, will resolve or reject\n     * the given promise based on how it is called:\n     *\n     * - If, when called, `chrome.runtime.lastError` contains a non-null object,\n     *   the promise is rejected with that value.\n     * - If the function is called with exactly one argument, the promise is\n     *   resolved to that value.\n     * - Otherwise, the promise is resolved to an array containing all of the\n     *   function's arguments.\n     *\n     * @param {object} promise\n     *        An object containing the resolution and rejection functions of a\n     *        promise.\n     * @param {function} promise.resolve\n     *        The promise's resolution function.\n     * @param {function} promise.reject\n     *        The promise's rejection function.\n     * @param {object} metadata\n     *        Metadata about the wrapped method which has created the callback.\n     * @param {boolean} metadata.singleCallbackArg\n     *        Whether or not the promise is resolved with only the first\n     *        argument of the callback, alternatively an array of all the\n     *        callback arguments is resolved. By default, if the callback\n     *        function is invoked with only a single argument, that will be\n     *        resolved to the promise, while all arguments will be resolved as\n     *        an array if multiple are given.\n     *\n     * @returns {function}\n     *        The generated callback function.\n     */\n    const makeCallback = (promise, metadata) => {\n      return (...callbackArgs) => {\n        if (extensionAPIs.runtime.lastError) {\n          promise.reject(new Error(extensionAPIs.runtime.lastError.message));\n        } else if (metadata.singleCallbackArg ||\n                   (callbackArgs.length <= 1 && metadata.singleCallbackArg !== false)) {\n          promise.resolve(callbackArgs[0]);\n        } else {\n          promise.resolve(callbackArgs);\n        }\n      };\n    };\n\n    const pluralizeArguments = (numArgs) => numArgs == 1 ? \"argument\" : \"arguments\";\n\n    /**\n     * Creates a wrapper function for a method with the given name and metadata.\n     *\n     * @param {string} name\n     *        The name of the method which is being wrapped.\n     * @param {object} metadata\n     *        Metadata about the method being wrapped.\n     * @param {integer} metadata.minArgs\n     *        The minimum number of arguments which must be passed to the\n     *        function. If called with fewer than this number of arguments, the\n     *        wrapper will raise an exception.\n     * @param {integer} metadata.maxArgs\n     *        The maximum number of arguments which may be passed to the\n     *        function. If called with more than this number of arguments, the\n     *        wrapper will raise an exception.\n     * @param {boolean} metadata.singleCallbackArg\n     *        Whether or not the promise is resolved with only the first\n     *        argument of the callback, alternatively an array of all the\n     *        callback arguments is resolved. By default, if the callback\n     *        function is invoked with only a single argument, that will be\n     *        resolved to the promise, while all arguments will be resolved as\n     *        an array if multiple are given.\n     *\n     * @returns {function(object, ...*)}\n     *       The generated wrapper function.\n     */\n    const wrapAsyncFunction = (name, metadata) => {\n      return function asyncFunctionWrapper(target, ...args) {\n        if (args.length < metadata.minArgs) {\n          throw new Error(`Expected at least ${metadata.minArgs} ${pluralizeArguments(metadata.minArgs)} for ${name}(), got ${args.length}`);\n        }\n\n        if (args.length > metadata.maxArgs) {\n          throw new Error(`Expected at most ${metadata.maxArgs} ${pluralizeArguments(metadata.maxArgs)} for ${name}(), got ${args.length}`);\n        }\n\n        return new Promise((resolve, reject) => {\n          if (metadata.fallbackToNoCallback) {\n            // This API method has currently no callback on Chrome, but it return a promise on Firefox,\n            // and so the polyfill will try to call it with a callback first, and it will fallback\n            // to not passing the callback if the first call fails.\n            try {\n              target[name](...args, makeCallback({resolve, reject}, metadata));\n            } catch (cbError) {\n              console.warn(`${name} API method doesn't seem to support the callback parameter, ` +\n                           \"falling back to call it without a callback: \", cbError);\n\n              target[name](...args);\n\n              // Update the API method metadata, so that the next API calls will not try to\n              // use the unsupported callback anymore.\n              metadata.fallbackToNoCallback = false;\n              metadata.noCallback = true;\n\n              resolve();\n            }\n          } else if (metadata.noCallback) {\n            target[name](...args);\n            resolve();\n          } else {\n            target[name](...args, makeCallback({resolve, reject}, metadata));\n          }\n        });\n      };\n    };\n\n    /**\n     * Wraps an existing method of the target object, so that calls to it are\n     * intercepted by the given wrapper function. The wrapper function receives,\n     * as its first argument, the original `target` object, followed by each of\n     * the arguments passed to the original method.\n     *\n     * @param {object} target\n     *        The original target object that the wrapped method belongs to.\n     * @param {function} method\n     *        The method being wrapped. This is used as the target of the Proxy\n     *        object which is created to wrap the method.\n     * @param {function} wrapper\n     *        The wrapper function which is called in place of a direct invocation\n     *        of the wrapped method.\n     *\n     * @returns {Proxy<function>}\n     *        A Proxy object for the given method, which invokes the given wrapper\n     *        method in its place.\n     */\n    const wrapMethod = (target, method, wrapper) => {\n      return new Proxy(method, {\n        apply(targetMethod, thisObj, args) {\n          return wrapper.call(thisObj, target, ...args);\n        },\n      });\n    };\n\n    let hasOwnProperty = Function.call.bind(Object.prototype.hasOwnProperty);\n\n    /**\n     * Wraps an object in a Proxy which intercepts and wraps certain methods\n     * based on the given `wrappers` and `metadata` objects.\n     *\n     * @param {object} target\n     *        The target object to wrap.\n     *\n     * @param {object} [wrappers = {}]\n     *        An object tree containing wrapper functions for special cases. Any\n     *        function present in this object tree is called in place of the\n     *        method in the same location in the `target` object tree. These\n     *        wrapper methods are invoked as described in {@see wrapMethod}.\n     *\n     * @param {object} [metadata = {}]\n     *        An object tree containing metadata used to automatically generate\n     *        Promise-based wrapper functions for asynchronous. Any function in\n     *        the `target` object tree which has a corresponding metadata object\n     *        in the same location in the `metadata` tree is replaced with an\n     *        automatically-generated wrapper function, as described in\n     *        {@see wrapAsyncFunction}\n     *\n     * @returns {Proxy<object>}\n     */\n    const wrapObject = (target, wrappers = {}, metadata = {}) => {\n      let cache = Object.create(null);\n      let handlers = {\n        has(proxyTarget, prop) {\n          return prop in target || prop in cache;\n        },\n\n        get(proxyTarget, prop, receiver) {\n          if (prop in cache) {\n            return cache[prop];\n          }\n\n          if (!(prop in target)) {\n            return undefined;\n          }\n\n          let value = target[prop];\n\n          if (typeof value === \"function\") {\n            // This is a method on the underlying object. Check if we need to do\n            // any wrapping.\n\n            if (typeof wrappers[prop] === \"function\") {\n              // We have a special-case wrapper for this method.\n              value = wrapMethod(target, target[prop], wrappers[prop]);\n            } else if (hasOwnProperty(metadata, prop)) {\n              // This is an async method that we have metadata for. Create a\n              // Promise wrapper for it.\n              let wrapper = wrapAsyncFunction(prop, metadata[prop]);\n              value = wrapMethod(target, target[prop], wrapper);\n            } else {\n              // This is a method that we don't know or care about. Return the\n              // original method, bound to the underlying object.\n              value = value.bind(target);\n            }\n          } else if (typeof value === \"object\" && value !== null &&\n                     (hasOwnProperty(wrappers, prop) ||\n                      hasOwnProperty(metadata, prop))) {\n            // This is an object that we need to do some wrapping for the children\n            // of. Create a sub-object wrapper for it with the appropriate child\n            // metadata.\n            value = wrapObject(value, wrappers[prop], metadata[prop]);\n          } else if (hasOwnProperty(metadata, \"*\")) {\n            // Wrap all properties in * namespace.\n            value = wrapObject(value, wrappers[prop], metadata[\"*\"]);\n          } else {\n            // We don't need to do any wrapping for this property,\n            // so just forward all access to the underlying object.\n            Object.defineProperty(cache, prop, {\n              configurable: true,\n              enumerable: true,\n              get() {\n                return target[prop];\n              },\n              set(value) {\n                target[prop] = value;\n              },\n            });\n\n            return value;\n          }\n\n          cache[prop] = value;\n          return value;\n        },\n\n        set(proxyTarget, prop, value, receiver) {\n          if (prop in cache) {\n            cache[prop] = value;\n          } else {\n            target[prop] = value;\n          }\n          return true;\n        },\n\n        defineProperty(proxyTarget, prop, desc) {\n          return Reflect.defineProperty(cache, prop, desc);\n        },\n\n        deleteProperty(proxyTarget, prop) {\n          return Reflect.deleteProperty(cache, prop);\n        },\n      };\n\n      // Per contract of the Proxy API, the \"get\" proxy handler must return the\n      // original value of the target if that value is declared read-only and\n      // non-configurable. For this reason, we create an object with the\n      // prototype set to `target` instead of using `target` directly.\n      // Otherwise we cannot return a custom object for APIs that\n      // are declared read-only and non-configurable, such as `chrome.devtools`.\n      //\n      // The proxy handlers themselves will still use the original `target`\n      // instead of the `proxyTarget`, so that the methods and properties are\n      // dereferenced via the original targets.\n      let proxyTarget = Object.create(target);\n      return new Proxy(proxyTarget, handlers);\n    };\n\n    /**\n     * Creates a set of wrapper functions for an event object, which handles\n     * wrapping of listener functions that those messages are passed.\n     *\n     * A single wrapper is created for each listener function, and stored in a\n     * map. Subsequent calls to `addListener`, `hasListener`, or `removeListener`\n     * retrieve the original wrapper, so that  attempts to remove a\n     * previously-added listener work as expected.\n     *\n     * @param {DefaultWeakMap<function, function>} wrapperMap\n     *        A DefaultWeakMap object which will create the appropriate wrapper\n     *        for a given listener function when one does not exist, and retrieve\n     *        an existing one when it does.\n     *\n     * @returns {object}\n     */\n    const wrapEvent = wrapperMap => ({\n      addListener(target, listener, ...args) {\n        target.addListener(wrapperMap.get(listener), ...args);\n      },\n\n      hasListener(target, listener) {\n        return target.hasListener(wrapperMap.get(listener));\n      },\n\n      removeListener(target, listener) {\n        target.removeListener(wrapperMap.get(listener));\n      },\n    });\n\n    const onRequestFinishedWrappers = new DefaultWeakMap(listener => {\n      if (typeof listener !== \"function\") {\n        return listener;\n      }\n\n      /**\n       * Wraps an onRequestFinished listener function so that it will return a\n       * `getContent()` property which returns a `Promise` rather than using a\n       * callback API.\n       *\n       * @param {object} req\n       *        The HAR entry object representing the network request.\n       */\n      return function onRequestFinished(req) {\n        const wrappedReq = wrapObject(req, {} /* wrappers */, {\n          getContent: {\n            minArgs: 0,\n            maxArgs: 0,\n          },\n        });\n        listener(wrappedReq);\n      };\n    });\n\n    const onMessageWrappers = new DefaultWeakMap(listener => {\n      if (typeof listener !== \"function\") {\n        return listener;\n      }\n\n      /**\n       * Wraps a message listener function so that it may send responses based on\n       * its return value, rather than by returning a sentinel value and calling a\n       * callback. If the listener function returns a Promise, the response is\n       * sent when the promise either resolves or rejects.\n       *\n       * @param {*} message\n       *        The message sent by the other end of the channel.\n       * @param {object} sender\n       *        Details about the sender of the message.\n       * @param {function(*)} sendResponse\n       *        A callback which, when called with an arbitrary argument, sends\n       *        that value as a response.\n       * @returns {boolean}\n       *        True if the wrapped listener returned a Promise, which will later\n       *        yield a response. False otherwise.\n       */\n      return function onMessage(message, sender, sendResponse) {\n        let didCallSendResponse = false;\n\n        let wrappedSendResponse;\n        let sendResponsePromise = new Promise(resolve => {\n          wrappedSendResponse = function(response) {\n            didCallSendResponse = true;\n            resolve(response);\n          };\n        });\n\n        let result;\n        try {\n          result = listener(message, sender, wrappedSendResponse);\n        } catch (err) {\n          result = Promise.reject(err);\n        }\n\n        const isResultThenable = result !== true && isThenable(result);\n\n        // If the listener didn't returned true or a Promise, or called\n        // wrappedSendResponse synchronously, we can exit earlier\n        // because there will be no response sent from this listener.\n        if (result !== true && !isResultThenable && !didCallSendResponse) {\n          return false;\n        }\n\n        // A small helper to send the message if the promise resolves\n        // and an error if the promise rejects (a wrapped sendMessage has\n        // to translate the message into a resolved promise or a rejected\n        // promise).\n        const sendPromisedResult = (promise) => {\n          promise.then(msg => {\n            // send the message value.\n            sendResponse(msg);\n          }, error => {\n            // Send a JSON representation of the error if the rejected value\n            // is an instance of error, or the object itself otherwise.\n            let message;\n            if (error && (error instanceof Error ||\n                typeof error.message === \"string\")) {\n              message = error.message;\n            } else {\n              message = \"An unexpected error occurred\";\n            }\n\n            sendResponse({\n              __mozWebExtensionPolyfillReject__: true,\n              message,\n            });\n          }).catch(err => {\n            // Print an error on the console if unable to send the response.\n            console.error(\"Failed to send onMessage rejected reply\", err);\n          });\n        };\n\n        // If the listener returned a Promise, send the resolved value as a\n        // result, otherwise wait the promise related to the wrappedSendResponse\n        // callback to resolve and send it as a response.\n        if (isResultThenable) {\n          sendPromisedResult(result);\n        } else {\n          sendPromisedResult(sendResponsePromise);\n        }\n\n        // Let Chrome know that the listener is replying.\n        return true;\n      };\n    });\n\n    const wrappedSendMessageCallback = ({reject, resolve}, reply) => {\n      if (extensionAPIs.runtime.lastError) {\n        // Detect when none of the listeners replied to the sendMessage call and resolve\n        // the promise to undefined as in Firefox.\n        // See https://github.com/mozilla/webextension-polyfill/issues/130\n        if (extensionAPIs.runtime.lastError.message === CHROME_SEND_MESSAGE_CALLBACK_NO_RESPONSE_MESSAGE) {\n          resolve();\n        } else {\n          reject(new Error(extensionAPIs.runtime.lastError.message));\n        }\n      } else if (reply && reply.__mozWebExtensionPolyfillReject__) {\n        // Convert back the JSON representation of the error into\n        // an Error instance.\n        reject(new Error(reply.message));\n      } else {\n        resolve(reply);\n      }\n    };\n\n    const wrappedSendMessage = (name, metadata, apiNamespaceObj, ...args) => {\n      if (args.length < metadata.minArgs) {\n        throw new Error(`Expected at least ${metadata.minArgs} ${pluralizeArguments(metadata.minArgs)} for ${name}(), got ${args.length}`);\n      }\n\n      if (args.length > metadata.maxArgs) {\n        throw new Error(`Expected at most ${metadata.maxArgs} ${pluralizeArguments(metadata.maxArgs)} for ${name}(), got ${args.length}`);\n      }\n\n      return new Promise((resolve, reject) => {\n        const wrappedCb = wrappedSendMessageCallback.bind(null, {resolve, reject});\n        args.push(wrappedCb);\n        apiNamespaceObj.sendMessage(...args);\n      });\n    };\n\n    const staticWrappers = {\n      devtools: {\n        network: {\n          onRequestFinished: wrapEvent(onRequestFinishedWrappers),\n        },\n      },\n      runtime: {\n        onMessage: wrapEvent(onMessageWrappers),\n        onMessageExternal: wrapEvent(onMessageWrappers),\n        sendMessage: wrappedSendMessage.bind(null, \"sendMessage\", {minArgs: 1, maxArgs: 3}),\n      },\n      tabs: {\n        sendMessage: wrappedSendMessage.bind(null, \"sendMessage\", {minArgs: 2, maxArgs: 3}),\n      },\n    };\n    const settingMetadata = {\n      clear: {minArgs: 1, maxArgs: 1},\n      get: {minArgs: 1, maxArgs: 1},\n      set: {minArgs: 1, maxArgs: 1},\n    };\n    apiMetadata.privacy = {\n      network: {\"*\": settingMetadata},\n      services: {\"*\": settingMetadata},\n      websites: {\"*\": settingMetadata},\n    };\n\n    return wrapObject(extensionAPIs, staticWrappers, apiMetadata);\n  };\n\n  // The build process adds a UMD wrapper around this file, which makes the\n  // `module` variable available.\n  module.exports = wrapAPIs(chrome);\n} else {\n  module.exports = globalThis.browser;\n}\n","/** Normal hydration that attaches to a DOM tree but does not diff it. */\nexport const MODE_HYDRATE = 1 << 5;\n/** Signifies this VNode suspended on the previous render */\nexport const MODE_SUSPENDED = 1 << 7;\n/** Indicates that this node needs to be inserted while patching children */\nexport const INSERT_VNODE = 1 << 16;\n/** Indicates a VNode has been matched with another VNode in the diff */\nexport const MATCHED = 1 << 17;\n\n/** Reset all mode flags */\nexport const RESET_MODE = ~(MODE_HYDRATE | MODE_SUSPENDED);\n\nexport const EMPTY_OBJ = /** @type {any} */ ({});\nexport const EMPTY_ARR = [];\nexport const IS_NON_DIMENSIONAL =\n\t/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;\n","import { EMPTY_ARR } from './constants';\n\nexport const isArray = Array.isArray;\n\n/**\n * Assign properties from `props` to `obj`\n * @template O, P The obj and props types\n * @param {O} obj The object to copy properties to\n * @param {P} props The object to copy properties from\n * @returns {O & P}\n */\nexport function assign(obj, props) {\n\t// @ts-expect-error We change the type of `obj` to be `O & P`\n\tfor (let i in props) obj[i] = props[i];\n\treturn /** @type {O & P} */ (obj);\n}\n\n/**\n * Remove a child node from its parent if attached. This is a workaround for\n * IE11 which doesn't support `Element.prototype.remove()`. Using this function\n * is smaller than including a dedicated polyfill.\n * @param {preact.ContainerNode} node The node to remove\n */\nexport function removeNode(node) {\n\tif (node && node.parentNode) node.parentNode.removeChild(node);\n}\n\nexport const slice = EMPTY_ARR.slice;\n","import { _catchError } from './diff/catch-error';\n\n/**\n * The `option` object can potentially contain callback functions\n * that are called during various stages of our renderer. This is the\n * foundation on which all our addons like `preact/debug`, `preact/compat`,\n * and `preact/hooks` are based on. See the `Options` type in `internal.d.ts`\n * for a full list of available option hooks (most editors/IDEs allow you to\n * ctrl+click or cmd+click on mac the type definition below).\n * @type {Options}\n */\nconst options = {\n\t_catchError\n};\n\nexport default options;\n","import { slice } from './util';\nimport options from './options';\n\nlet vnodeId = 0;\n\n/**\n * Create an virtual node (used for JSX)\n * @param {VNode[\"type\"]} type The node name or Component constructor for this\n * virtual node\n * @param {object | null | undefined} [props] The properties of the virtual node\n * @param {Array<import('.').ComponentChildren>} [children] The children of the\n * virtual node\n * @returns {VNode}\n */\nexport function createElement(type, props, children) {\n\tlet normalizedProps = {},\n\t\tkey,\n\t\tref,\n\t\ti;\n\tfor (i in props) {\n\t\tif (i == 'key') key = props[i];\n\t\telse if (i == 'ref') ref = props[i];\n\t\telse normalizedProps[i] = props[i];\n\t}\n\n\tif (arguments.length > 2) {\n\t\tnormalizedProps.children =\n\t\t\targuments.length > 3 ? slice.call(arguments, 2) : children;\n\t}\n\n\t// If a Component VNode, check for and apply defaultProps\n\t// Note: type may be undefined in development, must never error here.\n\tif (typeof type == 'function' && type.defaultProps != null) {\n\t\tfor (i in type.defaultProps) {\n\t\t\tif (normalizedProps[i] === undefined) {\n\t\t\t\tnormalizedProps[i] = type.defaultProps[i];\n\t\t\t}\n\t\t}\n\t}\n\n\treturn createVNode(type, normalizedProps, key, ref, null);\n}\n\n/**\n * Create a VNode (used internally by Preact)\n * @param {VNode[\"type\"]} type The node name or Component\n * Constructor for this virtual node\n * @param {object | string | number | null} props The properties of this virtual node.\n * If this virtual node represents a text node, this is the text of the node (string or number).\n * @param {string | number | null} key The key for this virtual node, used when\n * diffing it against its children\n * @param {VNode[\"ref\"]} ref The ref property that will\n * receive a reference to its created child\n * @returns {VNode}\n */\nexport function createVNode(type, props, key, ref, original) {\n\t// V8 seems to be better at detecting type shapes if the object is allocated from the same call site\n\t// Do not inline into createElement and coerceToVNode!\n\t/** @type {VNode} */\n\tconst vnode = {\n\t\ttype,\n\t\tprops,\n\t\tkey,\n\t\tref,\n\t\t_children: null,\n\t\t_parent: null,\n\t\t_depth: 0,\n\t\t_dom: null,\n\t\t// _nextDom must be initialized to undefined b/c it will eventually\n\t\t// be set to dom.nextSibling which can return `null` and it is important\n\t\t// to be able to distinguish between an uninitialized _nextDom and\n\t\t// a _nextDom that has been set to `null`\n\t\t_nextDom: undefined,\n\t\t_component: null,\n\t\tconstructor: undefined,\n\t\t_original: original == null ? ++vnodeId : original,\n\t\t_index: -1,\n\t\t_flags: 0\n\t};\n\n\t// Only invoke the vnode hook if this was *not* a direct copy:\n\tif (original == null && options.vnode != null) options.vnode(vnode);\n\n\treturn vnode;\n}\n\nexport function createRef() {\n\treturn { current: null };\n}\n\nexport function Fragment(props) {\n\treturn props.children;\n}\n\n/**\n * Check if a the argument is a valid Preact VNode.\n * @param {*} vnode\n * @returns {vnode is VNode}\n */\nexport const isValidElement = vnode =>\n\tvnode != null && vnode.constructor == undefined;\n","import { assign } from './util';\nimport { diff, commitRoot } from './diff/index';\nimport options from './options';\nimport { Fragment } from './create-element';\nimport { MODE_HYDRATE } from './constants';\n\n/**\n * Base Component class. Provides `setState()` and `forceUpdate()`, which\n * trigger rendering\n * @param {object} props The initial component props\n * @param {object} context The initial context from parent components'\n * getChildContext\n */\nexport function BaseComponent(props, context) {\n\tthis.props = props;\n\tthis.context = context;\n}\n\n/**\n * Update component state and schedule a re-render.\n * @this {Component}\n * @param {object | ((s: object, p: object) => object)} update A hash of state\n * properties to update with new values or a function that given the current\n * state and props returns a new partial state\n * @param {() => void} [callback] A function to be called once component state is\n * updated\n */\nBaseComponent.prototype.setState = function (update, callback) {\n\t// only clone state when copying to nextState the first time.\n\tlet s;\n\tif (this._nextState != null && this._nextState !== this.state) {\n\t\ts = this._nextState;\n\t} else {\n\t\ts = this._nextState = assign({}, this.state);\n\t}\n\n\tif (typeof update == 'function') {\n\t\t// Some libraries like `immer` mark the current state as readonly,\n\t\t// preventing us from mutating it, so we need to clone it. See #2716\n\t\tupdate = update(assign({}, s), this.props);\n\t}\n\n\tif (update) {\n\t\tassign(s, update);\n\t}\n\n\t// Skip update if updater function returned null\n\tif (update == null) return;\n\n\tif (this._vnode) {\n\t\tif (callback) {\n\t\t\tthis._stateCallbacks.push(callback);\n\t\t}\n\t\tenqueueRender(this);\n\t}\n};\n\n/**\n * Immediately perform a synchronous re-render of the component\n * @this {Component}\n * @param {() => void} [callback] A function to be called after component is\n * re-rendered\n */\nBaseComponent.prototype.forceUpdate = function (callback) {\n\tif (this._vnode) {\n\t\t// Set render mode so that we can differentiate where the render request\n\t\t// is coming from. We need this because forceUpdate should never call\n\t\t// shouldComponentUpdate\n\t\tthis._force = true;\n\t\tif (callback) this._renderCallbacks.push(callback);\n\t\tenqueueRender(this);\n\t}\n};\n\n/**\n * Accepts `props` and `state`, and returns a new Virtual DOM tree to build.\n * Virtual DOM is generally constructed via [JSX](http://jasonformat.com/wtf-is-jsx).\n * @param {object} props Props (eg: JSX attributes) received from parent\n * element/component\n * @param {object} state The component's current state\n * @param {object} context Context object, as returned by the nearest\n * ancestor's `getChildContext()`\n * @returns {ComponentChildren | void}\n */\nBaseComponent.prototype.render = Fragment;\n\n/**\n * @param {VNode} vnode\n * @param {number | null} [childIndex]\n */\nexport function getDomSibling(vnode, childIndex) {\n\tif (childIndex == null) {\n\t\t// Use childIndex==null as a signal to resume the search from the vnode's sibling\n\t\treturn vnode._parent\n\t\t\t? getDomSibling(vnode._parent, vnode._index + 1)\n\t\t\t: null;\n\t}\n\n\tlet sibling;\n\tfor (; childIndex < vnode._children.length; childIndex++) {\n\t\tsibling = vnode._children[childIndex];\n\n\t\tif (sibling != null && sibling._dom != null) {\n\t\t\t// Since updateParentDomPointers keeps _dom pointer correct,\n\t\t\t// we can rely on _dom to tell us if this subtree contains a\n\t\t\t// rendered DOM node, and what the first rendered DOM node is\n\t\t\treturn sibling._dom;\n\t\t}\n\t}\n\n\t// If we get here, we have not found a DOM node in this vnode's children.\n\t// We must resume from this vnode's sibling (in it's parent _children array)\n\t// Only climb up and search the parent if we aren't searching through a DOM\n\t// VNode (meaning we reached the DOM parent of the original vnode that began\n\t// the search)\n\treturn typeof vnode.type == 'function' ? getDomSibling(vnode) : null;\n}\n\n/**\n * Trigger in-place re-rendering of a component.\n * @param {Component} component The component to rerender\n */\nfunction renderComponent(component) {\n\tlet oldVNode = component._vnode,\n\t\toldDom = oldVNode._dom,\n\t\tcommitQueue = [],\n\t\trefQueue = [];\n\n\tif (component._parentDom) {\n\t\tconst newVNode = assign({}, oldVNode);\n\t\tnewVNode._original = oldVNode._original + 1;\n\t\tif (options.vnode) options.vnode(newVNode);\n\n\t\tdiff(\n\t\t\tcomponent._parentDom,\n\t\t\tnewVNode,\n\t\t\toldVNode,\n\t\t\tcomponent._globalContext,\n\t\t\tcomponent._parentDom.namespaceURI,\n\t\t\toldVNode._flags & MODE_HYDRATE ? [oldDom] : null,\n\t\t\tcommitQueue,\n\t\t\toldDom == null ? getDomSibling(oldVNode) : oldDom,\n\t\t\t!!(oldVNode._flags & MODE_HYDRATE),\n\t\t\trefQueue\n\t\t);\n\n\t\tnewVNode._original = oldVNode._original;\n\t\tnewVNode._parent._children[newVNode._index] = newVNode;\n\t\tcommitRoot(commitQueue, newVNode, refQueue);\n\n\t\tif (newVNode._dom != oldDom) {\n\t\t\tupdateParentDomPointers(newVNode);\n\t\t}\n\t}\n}\n\n/**\n * @param {VNode} vnode\n */\nfunction updateParentDomPointers(vnode) {\n\tif ((vnode = vnode._parent) != null && vnode._component != null) {\n\t\tvnode._dom = vnode._component.base = null;\n\t\tfor (let i = 0; i < vnode._children.length; i++) {\n\t\t\tlet child = vnode._children[i];\n\t\t\tif (child != null && child._dom != null) {\n\t\t\t\tvnode._dom = vnode._component.base = child._dom;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn updateParentDomPointers(vnode);\n\t}\n}\n\n/**\n * The render queue\n * @type {Array<Component>}\n */\nlet rerenderQueue = [];\n\n/*\n * The value of `Component.debounce` must asynchronously invoke the passed in callback. It is\n * important that contributors to Preact can consistently reason about what calls to `setState`, etc.\n * do, and when their effects will be applied. See the links below for some further reading on designing\n * asynchronous APIs.\n * * [Designing APIs for Asynchrony](https://blog.izs.me/2013/08/designing-apis-for-asynchrony)\n * * [Callbacks synchronous and asynchronous](https://blog.ometer.com/2011/07/24/callbacks-synchronous-and-asynchronous/)\n */\n\nlet prevDebounce;\n\nconst defer =\n\ttypeof Promise == 'function'\n\t\t? Promise.prototype.then.bind(Promise.resolve())\n\t\t: setTimeout;\n\n/**\n * Enqueue a rerender of a component\n * @param {Component} c The component to rerender\n */\nexport function enqueueRender(c) {\n\tif (\n\t\t(!c._dirty &&\n\t\t\t(c._dirty = true) &&\n\t\t\trerenderQueue.push(c) &&\n\t\t\t!process._rerenderCount++) ||\n\t\tprevDebounce !== options.debounceRendering\n\t) {\n\t\tprevDebounce = options.debounceRendering;\n\t\t(prevDebounce || defer)(process);\n\t}\n}\n\n/**\n * @param {Component} a\n * @param {Component} b\n */\nconst depthSort = (a, b) => a._vnode._depth - b._vnode._depth;\n\n/** Flush the render queue by rerendering all queued components */\nfunction process() {\n\tlet c;\n\trerenderQueue.sort(depthSort);\n\t// Don't update `renderCount` yet. Keep its value non-zero to prevent unnecessary\n\t// process() calls from getting scheduled while `queue` is still being consumed.\n\twhile ((c = rerenderQueue.shift())) {\n\t\tif (c._dirty) {\n\t\t\tlet renderQueueLength = rerenderQueue.length;\n\t\t\trenderComponent(c);\n\t\t\tif (rerenderQueue.length > renderQueueLength) {\n\t\t\t\t// When i.e. rerendering a provider additional new items can be injected, we want to\n\t\t\t\t// keep the order from top to bottom with those new items so we can handle them in a\n\t\t\t\t// single pass\n\t\t\t\trerenderQueue.sort(depthSort);\n\t\t\t}\n\t\t}\n\t}\n\tprocess._rerenderCount = 0;\n}\n\nprocess._rerenderCount = 0;\n","import { IS_NON_DIMENSIONAL } from '../constants';\nimport options from '../options';\n\nfunction setStyle(style, key, value) {\n\tif (key[0] === '-') {\n\t\tstyle.setProperty(key, value == null ? '' : value);\n\t} else if (value == null) {\n\t\tstyle[key] = '';\n\t} else if (typeof value != 'number' || IS_NON_DIMENSIONAL.test(key)) {\n\t\tstyle[key] = value;\n\t} else {\n\t\tstyle[key] = value + 'px';\n\t}\n}\n\n// A logical clock to solve issues like https://github.com/preactjs/preact/issues/3927.\n// When the DOM performs an event it leaves micro-ticks in between bubbling up which means that\n// an event can trigger on a newly reated DOM-node while the event bubbles up.\n//\n// Originally inspired by Vue\n// (https://github.com/vuejs/core/blob/caeb8a68811a1b0f79/packages/runtime-dom/src/modules/events.ts#L90-L101),\n// but modified to use a logical clock instead of Date.now() in case event handlers get attached\n// and events get dispatched during the same millisecond.\n//\n// The clock is incremented after each new event dispatch. This allows 1 000 000 new events\n// per second for over 280 years before the value reaches Number.MAX_SAFE_INTEGER (2**53 - 1).\nlet eventClock = 0;\n\n/**\n * Set a property value on a DOM node\n * @param {PreactElement} dom The DOM node to modify\n * @param {string} name The name of the property to set\n * @param {*} value The value to set the property to\n * @param {*} oldValue The old value the property had\n * @param {string} namespace Whether or not this DOM node is an SVG node or not\n */\nexport function setProperty(dom, name, value, oldValue, namespace) {\n\tlet useCapture;\n\n\to: if (name === 'style') {\n\t\tif (typeof value == 'string') {\n\t\t\tdom.style.cssText = value;\n\t\t} else {\n\t\t\tif (typeof oldValue == 'string') {\n\t\t\t\tdom.style.cssText = oldValue = '';\n\t\t\t}\n\n\t\t\tif (oldValue) {\n\t\t\t\tfor (name in oldValue) {\n\t\t\t\t\tif (!(value && name in value)) {\n\t\t\t\t\t\tsetStyle(dom.style, name, '');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (value) {\n\t\t\t\tfor (name in value) {\n\t\t\t\t\tif (!oldValue || value[name] !== oldValue[name]) {\n\t\t\t\t\t\tsetStyle(dom.style, name, value[name]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t// Benchmark for comparison: https://esbench.com/bench/574c954bdb965b9a00965ac6\n\telse if (name[0] === 'o' && name[1] === 'n') {\n\t\tuseCapture =\n\t\t\tname !== (name = name.replace(/(PointerCapture)$|Capture$/i, '$1'));\n\n\t\t// Infer correct casing for DOM built-in events:\n\t\tif (\n\t\t\tname.toLowerCase() in dom ||\n\t\t\tname === 'onFocusOut' ||\n\t\t\tname === 'onFocusIn'\n\t\t)\n\t\t\tname = name.toLowerCase().slice(2);\n\t\telse name = name.slice(2);\n\n\t\tif (!dom._listeners) dom._listeners = {};\n\t\tdom._listeners[name + useCapture] = value;\n\n\t\tif (value) {\n\t\t\tif (!oldValue) {\n\t\t\t\tvalue._attached = eventClock;\n\t\t\t\tdom.addEventListener(\n\t\t\t\t\tname,\n\t\t\t\t\tuseCapture ? eventProxyCapture : eventProxy,\n\t\t\t\t\tuseCapture\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tvalue._attached = oldValue._attached;\n\t\t\t}\n\t\t} else {\n\t\t\tdom.removeEventListener(\n\t\t\t\tname,\n\t\t\t\tuseCapture ? eventProxyCapture : eventProxy,\n\t\t\t\tuseCapture\n\t\t\t);\n\t\t}\n\t} else {\n\t\tif (namespace == 'http://www.w3.org/2000/svg') {\n\t\t\t// Normalize incorrect prop usage for SVG:\n\t\t\t// - xlink:href / xlinkHref --> href (xlink:href was removed from SVG and isn't needed)\n\t\t\t// - className --> class\n\t\t\tname = name.replace(/xlink(H|:h)/, 'h').replace(/sName$/, 's');\n\t\t} else if (\n\t\t\tname != 'width' &&\n\t\t\tname != 'height' &&\n\t\t\tname != 'href' &&\n\t\t\tname != 'list' &&\n\t\t\tname != 'form' &&\n\t\t\t// Default value in browsers is `-1` and an empty string is\n\t\t\t// cast to `0` instead\n\t\t\tname != 'tabIndex' &&\n\t\t\tname != 'download' &&\n\t\t\tname != 'rowSpan' &&\n\t\t\tname != 'colSpan' &&\n\t\t\tname != 'role' &&\n\t\t\tname != 'popover' &&\n\t\t\tname in dom\n\t\t) {\n\t\t\ttry {\n\t\t\t\tdom[name] = value == null ? '' : value;\n\t\t\t\t// labelled break is 1b smaller here than a return statement (sorry)\n\t\t\t\tbreak o;\n\t\t\t} catch (e) {}\n\t\t}\n\n\t\t// aria- and data- attributes have no boolean representation.\n\t\t// A `false` value is different from the attribute not being\n\t\t// present, so we can't remove it. For non-boolean aria\n\t\t// attributes we could treat false as a removal, but the\n\t\t// amount of exceptions would cost too many bytes. On top of\n\t\t// that other frameworks generally stringify `false`.\n\n\t\tif (typeof value == 'function') {\n\t\t\t// never serialize functions as attribute values\n\t\t} else if (value != null && (value !== false || name[4] === '-')) {\n\t\t\tdom.setAttribute(name, name == 'popover' && value == true ? '' : value);\n\t\t} else {\n\t\t\tdom.removeAttribute(name);\n\t\t}\n\t}\n}\n\n/**\n * Create an event proxy function.\n * @param {boolean} useCapture Is the event handler for the capture phase.\n * @private\n */\nfunction createEventProxy(useCapture) {\n\t/**\n\t * Proxy an event to hooked event handlers\n\t * @param {PreactEvent} e The event object from the browser\n\t * @private\n\t */\n\treturn function (e) {\n\t\tif (this._listeners) {\n\t\t\tconst eventHandler = this._listeners[e.type + useCapture];\n\t\t\tif (e._dispatched == null) {\n\t\t\t\te._dispatched = eventClock++;\n\n\t\t\t\t// When `e._dispatched` is smaller than the time when the targeted event\n\t\t\t\t// handler was attached we know we have bubbled up to an element that was added\n\t\t\t\t// during patching the DOM.\n\t\t\t} else if (e._dispatched < eventHandler._attached) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treturn eventHandler(options.event ? options.event(e) : e);\n\t\t}\n\t};\n}\n\nconst eventProxy = createEventProxy(false);\nconst eventProxyCapture = createEventProxy(true);\n","import { enqueueRender } from './component';\n\nexport let i = 0;\n\nexport function createContext(defaultValue, contextId) {\n\tcontextId = '__cC' + i++;\n\n\tconst context = {\n\t\t_id: contextId,\n\t\t_defaultValue: defaultValue,\n\t\t/** @type {FunctionComponent} */\n\t\tConsumer(props, contextValue) {\n\t\t\t// return props.children(\n\t\t\t// \tcontext[contextId] ? context[contextId].props.value : defaultValue\n\t\t\t// );\n\t\t\treturn props.children(contextValue);\n\t\t},\n\t\t/** @type {FunctionComponent} */\n\t\tProvider(props) {\n\t\t\tif (!this.getChildContext) {\n\t\t\t\t/** @type {Component[] | null} */\n\t\t\t\tlet subs = [];\n\t\t\t\tlet ctx = {};\n\t\t\t\tctx[contextId] = this;\n\n\t\t\t\tthis.getChildContext = () => ctx;\n\n\t\t\t\tthis.componentWillUnmount = () => {\n\t\t\t\t\tsubs = null;\n\t\t\t\t};\n\n\t\t\t\tthis.shouldComponentUpdate = function (_props) {\n\t\t\t\t\tif (this.props.value !== _props.value) {\n\t\t\t\t\t\tsubs.some(c => {\n\t\t\t\t\t\t\tc._force = true;\n\t\t\t\t\t\t\tenqueueRender(c);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tthis.sub = c => {\n\t\t\t\t\tsubs.push(c);\n\t\t\t\t\tlet old = c.componentWillUnmount;\n\t\t\t\t\tc.componentWillUnmount = () => {\n\t\t\t\t\t\tif (subs) {\n\t\t\t\t\t\t\tsubs.splice(subs.indexOf(c), 1);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (old) old.call(c);\n\t\t\t\t\t};\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn props.children;\n\t\t}\n\t};\n\n\t// Devtools needs access to the context object when it\n\t// encounters a Provider. This is necessary to support\n\t// setting `displayName` on the context object instead\n\t// of on the component itself. See:\n\t// https://reactjs.org/docs/context.html#contextdisplayname\n\n\treturn (context.Provider._contextRef = context.Consumer.contextType =\n\t\tcontext);\n}\n","import { diff, unmount, applyRef } from './index';\nimport { createVNode, Fragment } from '../create-element';\nimport { EMPTY_OBJ, EMPTY_ARR, INSERT_VNODE, MATCHED } from '../constants';\nimport { isArray } from '../util';\nimport { getDomSibling } from '../component';\n\n/**\n * Diff the children of a virtual node\n * @param {PreactElement} parentDom The DOM element whose children are being\n * diffed\n * @param {ComponentChildren[]} renderResult\n * @param {VNode} newParentVNode The new virtual node whose children should be\n * diff'ed against oldParentVNode\n * @param {VNode} oldParentVNode The old virtual node whose children should be\n * diff'ed against newParentVNode\n * @param {object} globalContext The current context object - modified by\n * getChildContext\n * @param {string} namespace Current namespace of the DOM node (HTML, SVG, or MathML)\n * @param {Array<PreactElement>} excessDomChildren\n * @param {Array<Component>} commitQueue List of components which have callbacks\n * to invoke in commitRoot\n * @param {PreactElement} oldDom The current attached DOM element any new dom\n * elements should be placed around. Likely `null` on first render (except when\n * hydrating). Can be a sibling DOM element when diffing Fragments that have\n * siblings. In most cases, it starts out as `oldChildren[0]._dom`.\n * @param {boolean} isHydrating Whether or not we are in hydration\n * @param {any[]} refQueue an array of elements needed to invoke refs\n */\nexport function diffChildren(\n\tparentDom,\n\trenderResult,\n\tnewParentVNode,\n\toldParentVNode,\n\tglobalContext,\n\tnamespace,\n\texcessDomChildren,\n\tcommitQueue,\n\toldDom,\n\tisHydrating,\n\trefQueue\n) {\n\tlet i,\n\t\t/** @type {VNode} */\n\t\toldVNode,\n\t\t/** @type {VNode} */\n\t\tchildVNode,\n\t\t/** @type {PreactElement} */\n\t\tnewDom,\n\t\t/** @type {PreactElement} */\n\t\tfirstChildDom;\n\n\t// This is a compression of oldParentVNode!=null && oldParentVNode != EMPTY_OBJ && oldParentVNode._children || EMPTY_ARR\n\t// as EMPTY_OBJ._children should be `undefined`.\n\t/** @type {VNode[]} */\n\tlet oldChildren = (oldParentVNode && oldParentVNode._children) || EMPTY_ARR;\n\n\tlet newChildrenLength = renderResult.length;\n\n\tnewParentVNode._nextDom = oldDom;\n\tconstructNewChildrenArray(newParentVNode, renderResult, oldChildren);\n\toldDom = newParentVNode._nextDom;\n\n\tfor (i = 0; i < newChildrenLength; i++) {\n\t\tchildVNode = newParentVNode._children[i];\n\t\tif (childVNode == null) continue;\n\n\t\t// At this point, constructNewChildrenArray has assigned _index to be the\n\t\t// matchingIndex for this VNode's oldVNode (or -1 if there is no oldVNode).\n\t\tif (childVNode._index === -1) {\n\t\t\toldVNode = EMPTY_OBJ;\n\t\t} else {\n\t\t\toldVNode = oldChildren[childVNode._index] || EMPTY_OBJ;\n\t\t}\n\n\t\t// Update childVNode._index to its final index\n\t\tchildVNode._index = i;\n\n\t\t// Morph the old element into the new one, but don't append it to the dom yet\n\t\tdiff(\n\t\t\tparentDom,\n\t\t\tchildVNode,\n\t\t\toldVNode,\n\t\t\tglobalContext,\n\t\t\tnamespace,\n\t\t\texcessDomChildren,\n\t\t\tcommitQueue,\n\t\t\toldDom,\n\t\t\tisHydrating,\n\t\t\trefQueue\n\t\t);\n\n\t\t// Adjust DOM nodes\n\t\tnewDom = childVNode._dom;\n\t\tif (childVNode.ref && oldVNode.ref != childVNode.ref) {\n\t\t\tif (oldVNode.ref) {\n\t\t\t\tapplyRef(oldVNode.ref, null, childVNode);\n\t\t\t}\n\t\t\trefQueue.push(\n\t\t\t\tchildVNode.ref,\n\t\t\t\tchildVNode._component || newDom,\n\t\t\t\tchildVNode\n\t\t\t);\n\t\t}\n\n\t\tif (firstChildDom == null && newDom != null) {\n\t\t\tfirstChildDom = newDom;\n\t\t}\n\n\t\tif (\n\t\t\tchildVNode._flags & INSERT_VNODE ||\n\t\t\toldVNode._children === childVNode._children\n\t\t) {\n\t\t\toldDom = insert(childVNode, oldDom, parentDom);\n\t\t} else if (\n\t\t\ttypeof childVNode.type == 'function' &&\n\t\t\tchildVNode._nextDom !== undefined\n\t\t) {\n\t\t\t// Since Fragments or components that return Fragment like VNodes can\n\t\t\t// contain multiple DOM nodes as the same level, continue the diff from\n\t\t\t// the sibling of last DOM child of this child VNode\n\t\t\toldDom = childVNode._nextDom;\n\t\t} else if (newDom) {\n\t\t\toldDom = newDom.nextSibling;\n\t\t}\n\n\t\t// Eagerly cleanup _nextDom. We don't need to persist the value because it\n\t\t// is only used by `diffChildren` to determine where to resume the diff\n\t\t// after diffing Components and Fragments. Once we store it the nextDOM\n\t\t// local var, we can clean up the property. Also prevents us hanging on to\n\t\t// DOM nodes that may have been unmounted.\n\t\tchildVNode._nextDom = undefined;\n\n\t\t// Unset diffing flags\n\t\tchildVNode._flags &= ~(INSERT_VNODE | MATCHED);\n\t}\n\n\t// TODO: With new child diffing algo, consider alt ways to diff Fragments.\n\t// Such as dropping oldDom and moving fragments in place\n\t//\n\t// Because the newParentVNode is Fragment-like, we need to set it's\n\t// _nextDom property to the nextSibling of its last child DOM node.\n\t//\n\t// `oldDom` contains the correct value here because if the last child\n\t// is a Fragment-like, then oldDom has already been set to that child's _nextDom.\n\t// If the last child is a DOM VNode, then oldDom will be set to that DOM\n\t// node's nextSibling.\n\tnewParentVNode._nextDom = oldDom;\n\tnewParentVNode._dom = firstChildDom;\n}\n\n/**\n * @param {VNode} newParentVNode\n * @param {ComponentChildren[]} renderResult\n * @param {VNode[]} oldChildren\n */\nfunction constructNewChildrenArray(newParentVNode, renderResult, oldChildren) {\n\t/** @type {number} */\n\tlet i;\n\t/** @type {VNode} */\n\tlet childVNode;\n\t/** @type {VNode} */\n\tlet oldVNode;\n\n\tconst newChildrenLength = renderResult.length;\n\tlet oldChildrenLength = oldChildren.length,\n\t\tremainingOldChildren = oldChildrenLength;\n\n\tlet skew = 0;\n\n\tnewParentVNode._children = [];\n\tfor (i = 0; i < newChildrenLength; i++) {\n\t\t// @ts-expect-error We are reusing the childVNode variable to hold both the\n\t\t// pre and post normalized childVNode\n\t\tchildVNode = renderResult[i];\n\n\t\tif (\n\t\t\tchildVNode == null ||\n\t\t\ttypeof childVNode == 'boolean' ||\n\t\t\ttypeof childVNode == 'function'\n\t\t) {\n\t\t\tchildVNode = newParentVNode._children[i] = null;\n\t\t\tcontinue;\n\t\t}\n\t\t// If this newVNode is being reused (e.g. <div>{reuse}{reuse}</div>) in the same diff,\n\t\t// or we are rendering a component (e.g. setState) copy the oldVNodes so it can have\n\t\t// it's own DOM & etc. pointers\n\t\telse if (\n\t\t\ttypeof childVNode == 'string' ||\n\t\t\ttypeof childVNode == 'number' ||\n\t\t\t// eslint-disable-next-line valid-typeof\n\t\t\ttypeof childVNode == 'bigint' ||\n\t\t\tchildVNode.constructor == String\n\t\t) {\n\t\t\tchildVNode = newParentVNode._children[i] = createVNode(\n\t\t\t\tnull,\n\t\t\t\tchildVNode,\n\t\t\t\tnull,\n\t\t\t\tnull,\n\t\t\t\tnull\n\t\t\t);\n\t\t} else if (isArray(childVNode)) {\n\t\t\tchildVNode = newParentVNode._children[i] = createVNode(\n\t\t\t\tFragment,\n\t\t\t\t{ children: childVNode },\n\t\t\t\tnull,\n\t\t\t\tnull,\n\t\t\t\tnull\n\t\t\t);\n\t\t} else if (childVNode.constructor === undefined && childVNode._depth > 0) {\n\t\t\t// VNode is already in use, clone it. This can happen in the following\n\t\t\t// scenario:\n\t\t\t//   const reuse = <div />\n\t\t\t//   <div>{reuse}<span />{reuse}</div>\n\t\t\tchildVNode = newParentVNode._children[i] = createVNode(\n\t\t\t\tchildVNode.type,\n\t\t\t\tchildVNode.props,\n\t\t\t\tchildVNode.key,\n\t\t\t\tchildVNode.ref ? childVNode.ref : null,\n\t\t\t\tchildVNode._original\n\t\t\t);\n\t\t} else {\n\t\t\tchildVNode = newParentVNode._children[i] = childVNode;\n\t\t}\n\n\t\tconst skewedIndex = i + skew;\n\t\tchildVNode._parent = newParentVNode;\n\t\tchildVNode._depth = newParentVNode._depth + 1;\n\n\t\t// Temporarily store the matchingIndex on the _index property so we can pull\n\t\t// out the oldVNode in diffChildren. We'll override this to the VNode's\n\t\t// final index after using this property to get the oldVNode\n\t\tconst matchingIndex = (childVNode._index = findMatchingIndex(\n\t\t\tchildVNode,\n\t\t\toldChildren,\n\t\t\tskewedIndex,\n\t\t\tremainingOldChildren\n\t\t));\n\n\t\toldVNode = null;\n\t\tif (matchingIndex !== -1) {\n\t\t\toldVNode = oldChildren[matchingIndex];\n\t\t\tremainingOldChildren--;\n\t\t\tif (oldVNode) {\n\t\t\t\toldVNode._flags |= MATCHED;\n\t\t\t}\n\t\t}\n\n\t\t// Here, we define isMounting for the purposes of the skew diffing\n\t\t// algorithm. Nodes that are unsuspending are considered mounting and we detect\n\t\t// this by checking if oldVNode._original === null\n\t\tconst isMounting = oldVNode == null || oldVNode._original === null;\n\n\t\tif (isMounting) {\n\t\t\tif (matchingIndex == -1) {\n\t\t\t\tskew--;\n\t\t\t}\n\n\t\t\t// If we are mounting a DOM VNode, mark it for insertion\n\t\t\tif (typeof childVNode.type != 'function') {\n\t\t\t\tchildVNode._flags |= INSERT_VNODE;\n\t\t\t}\n\t\t} else if (matchingIndex !== skewedIndex) {\n\t\t\t// When we move elements around i.e. [0, 1, 2] --> [1, 0, 2]\n\t\t\t// --> we diff 1, we find it at position 1 while our skewed index is 0 and our skew is 0\n\t\t\t//     we set the skew to 1 as we found an offset.\n\t\t\t// --> we diff 0, we find it at position 0 while our skewed index is at 2 and our skew is 1\n\t\t\t//     this makes us increase the skew again.\n\t\t\t// --> we diff 2, we find it at position 2 while our skewed index is at 4 and our skew is 2\n\t\t\t//\n\t\t\t// this becomes an optimization question where currently we see a 1 element offset as an insertion\n\t\t\t// or deletion i.e. we optimize for [0, 1, 2] --> [9, 0, 1, 2]\n\t\t\t// while a more than 1 offset we see as a swap.\n\t\t\t// We could probably build heuristics for having an optimized course of action here as well, but\n\t\t\t// might go at the cost of some bytes.\n\t\t\t//\n\t\t\t// If we wanted to optimize for i.e. only swaps we'd just do the last two code-branches and have\n\t\t\t// only the first item be a re-scouting and all the others fall in their skewed counter-part.\n\t\t\t// We could also further optimize for swaps\n\t\t\tif (matchingIndex == skewedIndex - 1) {\n\t\t\t\tskew--;\n\t\t\t} else if (matchingIndex == skewedIndex + 1) {\n\t\t\t\tskew++;\n\t\t\t} else {\n\t\t\t\tif (matchingIndex > skewedIndex) {\n\t\t\t\t\tskew--;\n\t\t\t\t} else {\n\t\t\t\t\tskew++;\n\t\t\t\t}\n\n\t\t\t\t// Move this VNode's DOM if the original index (matchingIndex) doesn't\n\t\t\t\t// match the new skew index (i + new skew)\n\t\t\t\t// In the former two branches we know that it matches after skewing\n\t\t\t\tchildVNode._flags |= INSERT_VNODE;\n\t\t\t}\n\t\t}\n\t}\n\n\t// Remove remaining oldChildren if there are any. Loop forwards so that as we\n\t// unmount DOM from the beginning of the oldChildren, we can adjust oldDom to\n\t// point to the next child, which needs to be the first DOM node that won't be\n\t// unmounted.\n\tif (remainingOldChildren) {\n\t\tfor (i = 0; i < oldChildrenLength; i++) {\n\t\t\toldVNode = oldChildren[i];\n\t\t\tif (oldVNode != null && (oldVNode._flags & MATCHED) === 0) {\n\t\t\t\tif (oldVNode._dom == newParentVNode._nextDom) {\n\t\t\t\t\tnewParentVNode._nextDom = getDomSibling(oldVNode);\n\t\t\t\t}\n\n\t\t\t\tunmount(oldVNode, oldVNode);\n\t\t\t}\n\t\t}\n\t}\n}\n\n/**\n * @param {VNode} parentVNode\n * @param {PreactElement} oldDom\n * @param {PreactElement} parentDom\n * @returns {PreactElement}\n */\nfunction insert(parentVNode, oldDom, parentDom) {\n\t// Note: VNodes in nested suspended trees may be missing _children.\n\n\tif (typeof parentVNode.type == 'function') {\n\t\tlet children = parentVNode._children;\n\t\tfor (let i = 0; children && i < children.length; i++) {\n\t\t\tif (children[i]) {\n\t\t\t\t// If we enter this code path on sCU bailout, where we copy\n\t\t\t\t// oldVNode._children to newVNode._children, we need to update the old\n\t\t\t\t// children's _parent pointer to point to the newVNode (parentVNode\n\t\t\t\t// here).\n\t\t\t\tchildren[i]._parent = parentVNode;\n\t\t\t\toldDom = insert(children[i], oldDom, parentDom);\n\t\t\t}\n\t\t}\n\n\t\treturn oldDom;\n\t} else if (parentVNode._dom != oldDom) {\n\t\tif (oldDom && parentVNode.type && !parentDom.contains(oldDom)) {\n\t\t\toldDom = getDomSibling(parentVNode);\n\t\t}\n\t\tparentDom.insertBefore(parentVNode._dom, oldDom || null);\n\t\toldDom = parentVNode._dom;\n\t}\n\n\tdo {\n\t\toldDom = oldDom && oldDom.nextSibling;\n\t} while (oldDom != null && oldDom.nodeType === 8);\n\n\treturn oldDom;\n}\n\n/**\n * Flatten and loop through the children of a virtual node\n * @param {ComponentChildren} children The unflattened children of a virtual\n * node\n * @returns {VNode[]}\n */\nexport function toChildArray(children, out) {\n\tout = out || [];\n\tif (children == null || typeof children == 'boolean') {\n\t} else if (isArray(children)) {\n\t\tchildren.some(child => {\n\t\t\ttoChildArray(child, out);\n\t\t});\n\t} else {\n\t\tout.push(children);\n\t}\n\treturn out;\n}\n\n/**\n * @param {VNode} childVNode\n * @param {VNode[]} oldChildren\n * @param {number} skewedIndex\n * @param {number} remainingOldChildren\n * @returns {number}\n */\nfunction findMatchingIndex(\n\tchildVNode,\n\toldChildren,\n\tskewedIndex,\n\tremainingOldChildren\n) {\n\tconst key = childVNode.key;\n\tconst type = childVNode.type;\n\tlet x = skewedIndex - 1;\n\tlet y = skewedIndex + 1;\n\tlet oldVNode = oldChildren[skewedIndex];\n\n\t// We only need to perform a search if there are more children\n\t// (remainingOldChildren) to search. However, if the oldVNode we just looked\n\t// at skewedIndex was not already used in this diff, then there must be at\n\t// least 1 other (so greater than 1) remainingOldChildren to attempt to match\n\t// against. So the following condition checks that ensuring\n\t// remainingOldChildren > 1 if the oldVNode is not already used/matched. Else\n\t// if the oldVNode was null or matched, then there could needs to be at least\n\t// 1 (aka `remainingOldChildren > 0`) children to find and compare against.\n\tlet shouldSearch =\n\t\tremainingOldChildren >\n\t\t(oldVNode != null && (oldVNode._flags & MATCHED) === 0 ? 1 : 0);\n\n\tif (\n\t\toldVNode === null ||\n\t\t(oldVNode &&\n\t\t\tkey == oldVNode.key &&\n\t\t\ttype === oldVNode.type &&\n\t\t\t(oldVNode._flags & MATCHED) === 0)\n\t) {\n\t\treturn skewedIndex;\n\t} else if (shouldSearch) {\n\t\twhile (x >= 0 || y < oldChildren.length) {\n\t\t\tif (x >= 0) {\n\t\t\t\toldVNode = oldChildren[x];\n\t\t\t\tif (\n\t\t\t\t\toldVNode &&\n\t\t\t\t\t(oldVNode._flags & MATCHED) === 0 &&\n\t\t\t\t\tkey == oldVNode.key &&\n\t\t\t\t\ttype === oldVNode.type\n\t\t\t\t) {\n\t\t\t\t\treturn x;\n\t\t\t\t}\n\t\t\t\tx--;\n\t\t\t}\n\n\t\t\tif (y < oldChildren.length) {\n\t\t\t\toldVNode = oldChildren[y];\n\t\t\t\tif (\n\t\t\t\t\toldVNode &&\n\t\t\t\t\t(oldVNode._flags & MATCHED) === 0 &&\n\t\t\t\t\tkey == oldVNode.key &&\n\t\t\t\t\ttype === oldVNode.type\n\t\t\t\t) {\n\t\t\t\t\treturn y;\n\t\t\t\t}\n\t\t\t\ty++;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn -1;\n}\n","import {\n\tEMPTY_OBJ,\n\tMODE_HYDRATE,\n\tMODE_SUSPENDED,\n\tRESET_MODE\n} from '../constants';\nimport { BaseComponent, getDomSibling } from '../component';\nimport { Fragment } from '../create-element';\nimport { diffChildren } from './children';\nimport { setProperty } from './props';\nimport { assign, isArray, removeNode, slice } from '../util';\nimport options from '../options';\n\n/**\n * Diff two virtual nodes and apply proper changes to the DOM\n * @param {PreactElement} parentDom The parent of the DOM element\n * @param {VNode} newVNode The new virtual node\n * @param {VNode} oldVNode The old virtual node\n * @param {object} globalContext The current context object. Modified by\n * getChildContext\n * @param {string} namespace Current namespace of the DOM node (HTML, SVG, or MathML)\n * @param {Array<PreactElement>} excessDomChildren\n * @param {Array<Component>} commitQueue List of components which have callbacks\n * to invoke in commitRoot\n * @param {PreactElement} oldDom The current attached DOM element any new dom\n * elements should be placed around. Likely `null` on first render (except when\n * hydrating). Can be a sibling DOM element when diffing Fragments that have\n * siblings. In most cases, it starts out as `oldChildren[0]._dom`.\n * @param {boolean} isHydrating Whether or not we are in hydration\n * @param {any[]} refQueue an array of elements needed to invoke refs\n */\nexport function diff(\n\tparentDom,\n\tnewVNode,\n\toldVNode,\n\tglobalContext,\n\tnamespace,\n\texcessDomChildren,\n\tcommitQueue,\n\toldDom,\n\tisHydrating,\n\trefQueue\n) {\n\t/** @type {any} */\n\tlet tmp,\n\t\tnewType = newVNode.type;\n\n\t// When passing through createElement it assigns the object\n\t// constructor as undefined. This to prevent JSON-injection.\n\tif (newVNode.constructor !== undefined) return null;\n\n\t// If the previous diff bailed out, resume creating/hydrating.\n\tif (oldVNode._flags & MODE_SUSPENDED) {\n\t\tisHydrating = !!(oldVNode._flags & MODE_HYDRATE);\n\t\toldDom = newVNode._dom = oldVNode._dom;\n\t\texcessDomChildren = [oldDom];\n\t}\n\n\tif ((tmp = options._diff)) tmp(newVNode);\n\n\touter: if (typeof newType == 'function') {\n\t\ttry {\n\t\t\tlet c, isNew, oldProps, oldState, snapshot, clearProcessingException;\n\t\t\tlet newProps = newVNode.props;\n\t\t\tconst isClassComponent =\n\t\t\t\t'prototype' in newType && newType.prototype.render;\n\n\t\t\t// Necessary for createContext api. Setting this property will pass\n\t\t\t// the context value as `this.context` just for this component.\n\t\t\ttmp = newType.contextType;\n\t\t\tlet provider = tmp && globalContext[tmp._id];\n\t\t\tlet componentContext = tmp\n\t\t\t\t? provider\n\t\t\t\t\t? provider.props.value\n\t\t\t\t\t: tmp._defaultValue\n\t\t\t\t: globalContext;\n\n\t\t\t// Get component and set it to `c`\n\t\t\tif (oldVNode._component) {\n\t\t\t\tc = newVNode._component = oldVNode._component;\n\t\t\t\tclearProcessingException = c._processingException = c._pendingError;\n\t\t\t} else {\n\t\t\t\t// Instantiate the new component\n\t\t\t\tif (isClassComponent) {\n\t\t\t\t\t// @ts-expect-error The check above verifies that newType is suppose to be constructed\n\t\t\t\t\tnewVNode._component = c = new newType(newProps, componentContext); // eslint-disable-line new-cap\n\t\t\t\t} else {\n\t\t\t\t\t// @ts-expect-error Trust me, Component implements the interface we want\n\t\t\t\t\tnewVNode._component = c = new BaseComponent(\n\t\t\t\t\t\tnewProps,\n\t\t\t\t\t\tcomponentContext\n\t\t\t\t\t);\n\t\t\t\t\tc.constructor = newType;\n\t\t\t\t\tc.render = doRender;\n\t\t\t\t}\n\t\t\t\tif (provider) provider.sub(c);\n\n\t\t\t\tc.props = newProps;\n\t\t\t\tif (!c.state) c.state = {};\n\t\t\t\tc.context = componentContext;\n\t\t\t\tc._globalContext = globalContext;\n\t\t\t\tisNew = c._dirty = true;\n\t\t\t\tc._renderCallbacks = [];\n\t\t\t\tc._stateCallbacks = [];\n\t\t\t}\n\n\t\t\t// Invoke getDerivedStateFromProps\n\t\t\tif (isClassComponent && c._nextState == null) {\n\t\t\t\tc._nextState = c.state;\n\t\t\t}\n\n\t\t\tif (isClassComponent && newType.getDerivedStateFromProps != null) {\n\t\t\t\tif (c._nextState == c.state) {\n\t\t\t\t\tc._nextState = assign({}, c._nextState);\n\t\t\t\t}\n\n\t\t\t\tassign(\n\t\t\t\t\tc._nextState,\n\t\t\t\t\tnewType.getDerivedStateFromProps(newProps, c._nextState)\n\t\t\t\t);\n\t\t\t}\n\n\t\t\toldProps = c.props;\n\t\t\toldState = c.state;\n\t\t\tc._vnode = newVNode;\n\n\t\t\t// Invoke pre-render lifecycle methods\n\t\t\tif (isNew) {\n\t\t\t\tif (\n\t\t\t\t\tisClassComponent &&\n\t\t\t\t\tnewType.getDerivedStateFromProps == null &&\n\t\t\t\t\tc.componentWillMount != null\n\t\t\t\t) {\n\t\t\t\t\tc.componentWillMount();\n\t\t\t\t}\n\n\t\t\t\tif (isClassComponent && c.componentDidMount != null) {\n\t\t\t\t\tc._renderCallbacks.push(c.componentDidMount);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (\n\t\t\t\t\tisClassComponent &&\n\t\t\t\t\tnewType.getDerivedStateFromProps == null &&\n\t\t\t\t\tnewProps !== oldProps &&\n\t\t\t\t\tc.componentWillReceiveProps != null\n\t\t\t\t) {\n\t\t\t\t\tc.componentWillReceiveProps(newProps, componentContext);\n\t\t\t\t}\n\n\t\t\t\tif (\n\t\t\t\t\t!c._force &&\n\t\t\t\t\t((c.shouldComponentUpdate != null &&\n\t\t\t\t\t\tc.shouldComponentUpdate(\n\t\t\t\t\t\t\tnewProps,\n\t\t\t\t\t\t\tc._nextState,\n\t\t\t\t\t\t\tcomponentContext\n\t\t\t\t\t\t) === false) ||\n\t\t\t\t\t\tnewVNode._original === oldVNode._original)\n\t\t\t\t) {\n\t\t\t\t\t// More info about this here: https://gist.github.com/JoviDeCroock/bec5f2ce93544d2e6070ef8e0036e4e8\n\t\t\t\t\tif (newVNode._original !== oldVNode._original) {\n\t\t\t\t\t\t// When we are dealing with a bail because of sCU we have to update\n\t\t\t\t\t\t// the props, state and dirty-state.\n\t\t\t\t\t\t// when we are dealing with strict-equality we don't as the child could still\n\t\t\t\t\t\t// be dirtied see #3883\n\t\t\t\t\t\tc.props = newProps;\n\t\t\t\t\t\tc.state = c._nextState;\n\t\t\t\t\t\tc._dirty = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tnewVNode._dom = oldVNode._dom;\n\t\t\t\t\tnewVNode._children = oldVNode._children;\n\t\t\t\t\tnewVNode._children.some(vnode => {\n\t\t\t\t\t\tif (vnode) vnode._parent = newVNode;\n\t\t\t\t\t});\n\n\t\t\t\t\tfor (let i = 0; i < c._stateCallbacks.length; i++) {\n\t\t\t\t\t\tc._renderCallbacks.push(c._stateCallbacks[i]);\n\t\t\t\t\t}\n\t\t\t\t\tc._stateCallbacks = [];\n\n\t\t\t\t\tif (c._renderCallbacks.length) {\n\t\t\t\t\t\tcommitQueue.push(c);\n\t\t\t\t\t}\n\n\t\t\t\t\tbreak outer;\n\t\t\t\t}\n\n\t\t\t\tif (c.componentWillUpdate != null) {\n\t\t\t\t\tc.componentWillUpdate(newProps, c._nextState, componentContext);\n\t\t\t\t}\n\n\t\t\t\tif (isClassComponent && c.componentDidUpdate != null) {\n\t\t\t\t\tc._renderCallbacks.push(() => {\n\t\t\t\t\t\tc.componentDidUpdate(oldProps, oldState, snapshot);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tc.context = componentContext;\n\t\t\tc.props = newProps;\n\t\t\tc._parentDom = parentDom;\n\t\t\tc._force = false;\n\n\t\t\tlet renderHook = options._render,\n\t\t\t\tcount = 0;\n\t\t\tif (isClassComponent) {\n\t\t\t\tc.state = c._nextState;\n\t\t\t\tc._dirty = false;\n\n\t\t\t\tif (renderHook) renderHook(newVNode);\n\n\t\t\t\ttmp = c.render(c.props, c.state, c.context);\n\n\t\t\t\tfor (let i = 0; i < c._stateCallbacks.length; i++) {\n\t\t\t\t\tc._renderCallbacks.push(c._stateCallbacks[i]);\n\t\t\t\t}\n\t\t\t\tc._stateCallbacks = [];\n\t\t\t} else {\n\t\t\t\tdo {\n\t\t\t\t\tc._dirty = false;\n\t\t\t\t\tif (renderHook) renderHook(newVNode);\n\n\t\t\t\t\ttmp = c.render(c.props, c.state, c.context);\n\n\t\t\t\t\t// Handle setState called in render, see #2553\n\t\t\t\t\tc.state = c._nextState;\n\t\t\t\t} while (c._dirty && ++count < 25);\n\t\t\t}\n\n\t\t\t// Handle setState called in render, see #2553\n\t\t\tc.state = c._nextState;\n\n\t\t\tif (c.getChildContext != null) {\n\t\t\t\tglobalContext = assign(assign({}, globalContext), c.getChildContext());\n\t\t\t}\n\n\t\t\tif (isClassComponent && !isNew && c.getSnapshotBeforeUpdate != null) {\n\t\t\t\tsnapshot = c.getSnapshotBeforeUpdate(oldProps, oldState);\n\t\t\t}\n\n\t\t\tlet isTopLevelFragment =\n\t\t\t\ttmp != null && tmp.type === Fragment && tmp.key == null;\n\t\t\tlet renderResult = isTopLevelFragment ? tmp.props.children : tmp;\n\n\t\t\tdiffChildren(\n\t\t\t\tparentDom,\n\t\t\t\tisArray(renderResult) ? renderResult : [renderResult],\n\t\t\t\tnewVNode,\n\t\t\t\toldVNode,\n\t\t\t\tglobalContext,\n\t\t\t\tnamespace,\n\t\t\t\texcessDomChildren,\n\t\t\t\tcommitQueue,\n\t\t\t\toldDom,\n\t\t\t\tisHydrating,\n\t\t\t\trefQueue\n\t\t\t);\n\n\t\t\tc.base = newVNode._dom;\n\n\t\t\t// We successfully rendered this VNode, unset any stored hydration/bailout state:\n\t\t\tnewVNode._flags &= RESET_MODE;\n\n\t\t\tif (c._renderCallbacks.length) {\n\t\t\t\tcommitQueue.push(c);\n\t\t\t}\n\n\t\t\tif (clearProcessingException) {\n\t\t\t\tc._pendingError = c._processingException = null;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tnewVNode._original = null;\n\t\t\t// if hydrating or creating initial tree, bailout preserves DOM:\n\t\t\tif (isHydrating || excessDomChildren != null) {\n\t\t\t\tnewVNode._flags |= isHydrating\n\t\t\t\t\t? MODE_HYDRATE | MODE_SUSPENDED\n\t\t\t\t\t: MODE_HYDRATE;\n\n\t\t\t\twhile (oldDom && oldDom.nodeType === 8 && oldDom.nextSibling) {\n\t\t\t\t\toldDom = oldDom.nextSibling;\n\t\t\t\t}\n\t\t\t\texcessDomChildren[excessDomChildren.indexOf(oldDom)] = null;\n\t\t\t\tnewVNode._dom = oldDom;\n\t\t\t} else {\n\t\t\t\tnewVNode._dom = oldVNode._dom;\n\t\t\t\tnewVNode._children = oldVNode._children;\n\t\t\t}\n\t\t\toptions._catchError(e, newVNode, oldVNode);\n\t\t}\n\t} else if (\n\t\texcessDomChildren == null &&\n\t\tnewVNode._original === oldVNode._original\n\t) {\n\t\tnewVNode._children = oldVNode._children;\n\t\tnewVNode._dom = oldVNode._dom;\n\t} else {\n\t\tnewVNode._dom = diffElementNodes(\n\t\t\toldVNode._dom,\n\t\t\tnewVNode,\n\t\t\toldVNode,\n\t\t\tglobalContext,\n\t\t\tnamespace,\n\t\t\texcessDomChildren,\n\t\t\tcommitQueue,\n\t\t\tisHydrating,\n\t\t\trefQueue\n\t\t);\n\t}\n\n\tif ((tmp = options.diffed)) tmp(newVNode);\n}\n\n/**\n * @param {Array<Component>} commitQueue List of components\n * which have callbacks to invoke in commitRoot\n * @param {VNode} root\n */\nexport function commitRoot(commitQueue, root, refQueue) {\n\troot._nextDom = undefined;\n\n\tfor (let i = 0; i < refQueue.length; i++) {\n\t\tapplyRef(refQueue[i], refQueue[++i], refQueue[++i]);\n\t}\n\n\tif (options._commit) options._commit(root, commitQueue);\n\n\tcommitQueue.some(c => {\n\t\ttry {\n\t\t\t// @ts-expect-error Reuse the commitQueue variable here so the type changes\n\t\t\tcommitQueue = c._renderCallbacks;\n\t\t\tc._renderCallbacks = [];\n\t\t\tcommitQueue.some(cb => {\n\t\t\t\t// @ts-expect-error See above comment on commitQueue\n\t\t\t\tcb.call(c);\n\t\t\t});\n\t\t} catch (e) {\n\t\t\toptions._catchError(e, c._vnode);\n\t\t}\n\t});\n}\n\n/**\n * Diff two virtual nodes representing DOM element\n * @param {PreactElement} dom The DOM element representing the virtual nodes\n * being diffed\n * @param {VNode} newVNode The new virtual node\n * @param {VNode} oldVNode The old virtual node\n * @param {object} globalContext The current context object\n * @param {string} namespace Current namespace of the DOM node (HTML, SVG, or MathML)\n * @param {Array<PreactElement>} excessDomChildren\n * @param {Array<Component>} commitQueue List of components which have callbacks\n * to invoke in commitRoot\n * @param {boolean} isHydrating Whether or not we are in hydration\n * @param {any[]} refQueue an array of elements needed to invoke refs\n * @returns {PreactElement}\n */\nfunction diffElementNodes(\n\tdom,\n\tnewVNode,\n\toldVNode,\n\tglobalContext,\n\tnamespace,\n\texcessDomChildren,\n\tcommitQueue,\n\tisHydrating,\n\trefQueue\n) {\n\tlet oldProps = oldVNode.props;\n\tlet newProps = newVNode.props;\n\tlet nodeType = /** @type {string} */ (newVNode.type);\n\t/** @type {any} */\n\tlet i;\n\t/** @type {{ __html?: string }} */\n\tlet newHtml;\n\t/** @type {{ __html?: string }} */\n\tlet oldHtml;\n\t/** @type {ComponentChildren} */\n\tlet newChildren;\n\tlet value;\n\tlet inputValue;\n\tlet checked;\n\n\t// Tracks entering and exiting namespaces when descending through the tree.\n\tif (nodeType === 'svg') namespace = 'http://www.w3.org/2000/svg';\n\telse if (nodeType === 'math')\n\t\tnamespace = 'http://www.w3.org/1998/Math/MathML';\n\telse if (!namespace) namespace = 'http://www.w3.org/1999/xhtml';\n\n\tif (excessDomChildren != null) {\n\t\tfor (i = 0; i < excessDomChildren.length; i++) {\n\t\t\tvalue = excessDomChildren[i];\n\n\t\t\t// if newVNode matches an element in excessDomChildren or the `dom`\n\t\t\t// argument matches an element in excessDomChildren, remove it from\n\t\t\t// excessDomChildren so it isn't later removed in diffChildren\n\t\t\tif (\n\t\t\t\tvalue &&\n\t\t\t\t'setAttribute' in value === !!nodeType &&\n\t\t\t\t(nodeType ? value.localName === nodeType : value.nodeType === 3)\n\t\t\t) {\n\t\t\t\tdom = value;\n\t\t\t\texcessDomChildren[i] = null;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (dom == null) {\n\t\tif (nodeType === null) {\n\t\t\treturn document.createTextNode(newProps);\n\t\t}\n\n\t\tdom = document.createElementNS(\n\t\t\tnamespace,\n\t\t\tnodeType,\n\t\t\tnewProps.is && newProps\n\t\t);\n\n\t\t// we are creating a new node, so we can assume this is a new subtree (in\n\t\t// case we are hydrating), this deopts the hydrate\n\t\tif (isHydrating) {\n\t\t\tif (options._hydrationMismatch)\n\t\t\t\toptions._hydrationMismatch(newVNode, excessDomChildren);\n\t\t\tisHydrating = false;\n\t\t}\n\t\t// we created a new parent, so none of the previously attached children can be reused:\n\t\texcessDomChildren = null;\n\t}\n\n\tif (nodeType === null) {\n\t\t// During hydration, we still have to split merged text from SSR'd HTML.\n\t\tif (oldProps !== newProps && (!isHydrating || dom.data !== newProps)) {\n\t\t\tdom.data = newProps;\n\t\t}\n\t} else {\n\t\t// If excessDomChildren was not null, repopulate it with the current element's children:\n\t\texcessDomChildren = excessDomChildren && slice.call(dom.childNodes);\n\n\t\toldProps = oldVNode.props || EMPTY_OBJ;\n\n\t\t// If we are in a situation where we are not hydrating but are using\n\t\t// existing DOM (e.g. replaceNode) we should read the existing DOM\n\t\t// attributes to diff them\n\t\tif (!isHydrating && excessDomChildren != null) {\n\t\t\toldProps = {};\n\t\t\tfor (i = 0; i < dom.attributes.length; i++) {\n\t\t\t\tvalue = dom.attributes[i];\n\t\t\t\toldProps[value.name] = value.value;\n\t\t\t}\n\t\t}\n\n\t\tfor (i in oldProps) {\n\t\t\tvalue = oldProps[i];\n\t\t\tif (i == 'children') {\n\t\t\t} else if (i == 'dangerouslySetInnerHTML') {\n\t\t\t\toldHtml = value;\n\t\t\t} else if (!(i in newProps)) {\n\t\t\t\tif (\n\t\t\t\t\t(i == 'value' && 'defaultValue' in newProps) ||\n\t\t\t\t\t(i == 'checked' && 'defaultChecked' in newProps)\n\t\t\t\t) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tsetProperty(dom, i, null, value, namespace);\n\t\t\t}\n\t\t}\n\n\t\t// During hydration, props are not diffed at all (including dangerouslySetInnerHTML)\n\t\t// @TODO we should warn in debug mode when props don't match here.\n\t\tfor (i in newProps) {\n\t\t\tvalue = newProps[i];\n\t\t\tif (i == 'children') {\n\t\t\t\tnewChildren = value;\n\t\t\t} else if (i == 'dangerouslySetInnerHTML') {\n\t\t\t\tnewHtml = value;\n\t\t\t} else if (i == 'value') {\n\t\t\t\tinputValue = value;\n\t\t\t} else if (i == 'checked') {\n\t\t\t\tchecked = value;\n\t\t\t} else if (\n\t\t\t\t(!isHydrating || typeof value == 'function') &&\n\t\t\t\toldProps[i] !== value\n\t\t\t) {\n\t\t\t\tsetProperty(dom, i, value, oldProps[i], namespace);\n\t\t\t}\n\t\t}\n\n\t\t// If the new vnode didn't have dangerouslySetInnerHTML, diff its children\n\t\tif (newHtml) {\n\t\t\t// Avoid re-applying the same '__html' if it did not changed between re-render\n\t\t\tif (\n\t\t\t\t!isHydrating &&\n\t\t\t\t(!oldHtml ||\n\t\t\t\t\t(newHtml.__html !== oldHtml.__html &&\n\t\t\t\t\t\tnewHtml.__html !== dom.innerHTML))\n\t\t\t) {\n\t\t\t\tdom.innerHTML = newHtml.__html;\n\t\t\t}\n\n\t\t\tnewVNode._children = [];\n\t\t} else {\n\t\t\tif (oldHtml) dom.innerHTML = '';\n\n\t\t\tdiffChildren(\n\t\t\t\tdom,\n\t\t\t\tisArray(newChildren) ? newChildren : [newChildren],\n\t\t\t\tnewVNode,\n\t\t\t\toldVNode,\n\t\t\t\tglobalContext,\n\t\t\t\tnodeType === 'foreignObject'\n\t\t\t\t\t? 'http://www.w3.org/1999/xhtml'\n\t\t\t\t\t: namespace,\n\t\t\t\texcessDomChildren,\n\t\t\t\tcommitQueue,\n\t\t\t\texcessDomChildren\n\t\t\t\t\t? excessDomChildren[0]\n\t\t\t\t\t: oldVNode._children && getDomSibling(oldVNode, 0),\n\t\t\t\tisHydrating,\n\t\t\t\trefQueue\n\t\t\t);\n\n\t\t\t// Remove children that are not part of any vnode.\n\t\t\tif (excessDomChildren != null) {\n\t\t\t\tfor (i = excessDomChildren.length; i--; ) {\n\t\t\t\t\tremoveNode(excessDomChildren[i]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// As above, don't diff props during hydration\n\t\tif (!isHydrating) {\n\t\t\ti = 'value';\n\t\t\tif (nodeType === 'progress' && inputValue == null) {\n\t\t\t\tdom.removeAttribute('value');\n\t\t\t} else if (\n\t\t\t\tinputValue !== undefined &&\n\t\t\t\t// #2756 For the <progress>-element the initial value is 0,\n\t\t\t\t// despite the attribute not being present. When the attribute\n\t\t\t\t// is missing the progress bar is treated as indeterminate.\n\t\t\t\t// To fix that we'll always update it when it is 0 for progress elements\n\t\t\t\t(inputValue !== dom[i] ||\n\t\t\t\t\t(nodeType === 'progress' && !inputValue) ||\n\t\t\t\t\t// This is only for IE 11 to fix <select> value not being updated.\n\t\t\t\t\t// To avoid a stale select value we need to set the option.value\n\t\t\t\t\t// again, which triggers IE11 to re-evaluate the select value\n\t\t\t\t\t(nodeType === 'option' && inputValue !== oldProps[i]))\n\t\t\t) {\n\t\t\t\tsetProperty(dom, i, inputValue, oldProps[i], namespace);\n\t\t\t}\n\n\t\t\ti = 'checked';\n\t\t\tif (checked !== undefined && checked !== dom[i]) {\n\t\t\t\tsetProperty(dom, i, checked, oldProps[i], namespace);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn dom;\n}\n\n/**\n * Invoke or update a ref, depending on whether it is a function or object ref.\n * @param {Ref<any> & { _unmount?: unknown }} ref\n * @param {any} value\n * @param {VNode} vnode\n */\nexport function applyRef(ref, value, vnode) {\n\ttry {\n\t\tif (typeof ref == 'function') {\n\t\t\tlet hasRefUnmount = typeof ref._unmount == 'function';\n\t\t\tif (hasRefUnmount) {\n\t\t\t\t// @ts-ignore TS doesn't like moving narrowing checks into variables\n\t\t\t\tref._unmount();\n\t\t\t}\n\n\t\t\tif (!hasRefUnmount || value != null) {\n\t\t\t\t// Store the cleanup function on the function\n\t\t\t\t// instance object itself to avoid shape\n\t\t\t\t// transitioning vnode\n\t\t\t\tref._unmount = ref(value);\n\t\t\t}\n\t\t} else ref.current = value;\n\t} catch (e) {\n\t\toptions._catchError(e, vnode);\n\t}\n}\n\n/**\n * Unmount a virtual node from the tree and apply DOM changes\n * @param {VNode} vnode The virtual node to unmount\n * @param {VNode} parentVNode The parent of the VNode that initiated the unmount\n * @param {boolean} [skipRemove] Flag that indicates that a parent node of the\n * current element is already detached from the DOM.\n */\nexport function unmount(vnode, parentVNode, skipRemove) {\n\tlet r;\n\tif (options.unmount) options.unmount(vnode);\n\n\tif ((r = vnode.ref)) {\n\t\tif (!r.current || r.current === vnode._dom) {\n\t\t\tapplyRef(r, null, parentVNode);\n\t\t}\n\t}\n\n\tif ((r = vnode._component) != null) {\n\t\tif (r.componentWillUnmount) {\n\t\t\ttry {\n\t\t\t\tr.componentWillUnmount();\n\t\t\t} catch (e) {\n\t\t\t\toptions._catchError(e, parentVNode);\n\t\t\t}\n\t\t}\n\n\t\tr.base = r._parentDom = null;\n\t}\n\n\tif ((r = vnode._children)) {\n\t\tfor (let i = 0; i < r.length; i++) {\n\t\t\tif (r[i]) {\n\t\t\t\tunmount(\n\t\t\t\t\tr[i],\n\t\t\t\t\tparentVNode,\n\t\t\t\t\tskipRemove || typeof vnode.type != 'function'\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (!skipRemove) {\n\t\tremoveNode(vnode._dom);\n\t}\n\n\t// Must be set to `undefined` to properly clean up `_nextDom`\n\t// for which `null` is a valid value. See comment in `create-element.js`\n\tvnode._component = vnode._parent = vnode._dom = vnode._nextDom = undefined;\n}\n\n/** The `.render()` method for a PFC backing instance. */\nfunction doRender(props, state, context) {\n\treturn this.constructor(props, context);\n}\n","import { EMPTY_OBJ } from './constants';\nimport { commitRoot, diff } from './diff/index';\nimport { createElement, Fragment } from './create-element';\nimport options from './options';\nimport { slice } from './util';\n\n/**\n * Render a Preact virtual node into a DOM element\n * @param {ComponentChild} vnode The virtual node to render\n * @param {PreactElement} parentDom The DOM element to render into\n * @param {PreactElement | object} [replaceNode] Optional: Attempt to re-use an\n * existing DOM tree rooted at `replaceNode`\n */\nexport function render(vnode, parentDom, replaceNode) {\n\tif (options._root) options._root(vnode, parentDom);\n\n\t// We abuse the `replaceNode` parameter in `hydrate()` to signal if we are in\n\t// hydration mode or not by passing the `hydrate` function instead of a DOM\n\t// element..\n\tlet isHydrating = typeof replaceNode == 'function';\n\n\t// To be able to support calling `render()` multiple times on the same\n\t// DOM node, we need to obtain a reference to the previous tree. We do\n\t// this by assigning a new `_children` property to DOM nodes which points\n\t// to the last rendered tree. By default this property is not present, which\n\t// means that we are mounting a new tree for the first time.\n\tlet oldVNode = isHydrating\n\t\t? null\n\t\t: (replaceNode && replaceNode._children) || parentDom._children;\n\n\tvnode = ((!isHydrating && replaceNode) || parentDom)._children =\n\t\tcreateElement(Fragment, null, [vnode]);\n\n\t// List of effects that need to be called after diffing.\n\tlet commitQueue = [],\n\t\trefQueue = [];\n\tdiff(\n\t\tparentDom,\n\t\t// Determine the new vnode tree and store it on the DOM element on\n\t\t// our custom `_children` property.\n\t\tvnode,\n\t\toldVNode || EMPTY_OBJ,\n\t\tEMPTY_OBJ,\n\t\tparentDom.namespaceURI,\n\t\t!isHydrating && replaceNode\n\t\t\t? [replaceNode]\n\t\t\t: oldVNode\n\t\t\t\t? null\n\t\t\t\t: parentDom.firstChild\n\t\t\t\t\t? slice.call(parentDom.childNodes)\n\t\t\t\t\t: null,\n\t\tcommitQueue,\n\t\t!isHydrating && replaceNode\n\t\t\t? replaceNode\n\t\t\t: oldVNode\n\t\t\t\t? oldVNode._dom\n\t\t\t\t: parentDom.firstChild,\n\t\tisHydrating,\n\t\trefQueue\n\t);\n\n\t// Flush all queued effects\n\tcommitRoot(commitQueue, vnode, refQueue);\n}\n\n/**\n * Update an existing DOM element with data from a Preact virtual node\n * @param {ComponentChild} vnode The virtual node to render\n * @param {PreactElement} parentDom The DOM element to update\n */\nexport function hydrate(vnode, parentDom) {\n\trender(vnode, parentDom, hydrate);\n}\n","import { assign, slice } from './util';\nimport { createVNode } from './create-element';\n\n/**\n * Clones the given VNode, optionally adding attributes/props and replacing its\n * children.\n * @param {VNode} vnode The virtual DOM element to clone\n * @param {object} props Attributes/props to add when cloning\n * @param {Array<ComponentChildren>} rest Any additional arguments will be used\n * as replacement children.\n * @returns {VNode}\n */\nexport function cloneElement(vnode, props, children) {\n\tlet normalizedProps = assign({}, vnode.props),\n\t\tkey,\n\t\tref,\n\t\ti;\n\n\tlet defaultProps;\n\n\tif (vnode.type && vnode.type.defaultProps) {\n\t\tdefaultProps = vnode.type.defaultProps;\n\t}\n\n\tfor (i in props) {\n\t\tif (i == 'key') key = props[i];\n\t\telse if (i == 'ref') ref = props[i];\n\t\telse if (props[i] === undefined && defaultProps !== undefined) {\n\t\t\tnormalizedProps[i] = defaultProps[i];\n\t\t} else {\n\t\t\tnormalizedProps[i] = props[i];\n\t\t}\n\t}\n\n\tif (arguments.length > 2) {\n\t\tnormalizedProps.children =\n\t\t\targuments.length > 3 ? slice.call(arguments, 2) : children;\n\t}\n\n\treturn createVNode(\n\t\tvnode.type,\n\t\tnormalizedProps,\n\t\tkey || vnode.key,\n\t\tref || vnode.ref,\n\t\tnull\n\t);\n}\n","/**\n * Find the closest error boundary to a thrown error and call it\n * @param {object} error The thrown value\n * @param {VNode} vnode The vnode that threw the error that was caught (except\n * for unmounting when this parameter is the highest parent that was being\n * unmounted)\n * @param {VNode} [oldVNode]\n * @param {ErrorInfo} [errorInfo]\n */\nexport function _catchError(error, vnode, oldVNode, errorInfo) {\n\t/** @type {Component} */\n\tlet component,\n\t\t/** @type {ComponentType} */\n\t\tctor,\n\t\t/** @type {boolean} */\n\t\thandled;\n\n\tfor (; (vnode = vnode._parent); ) {\n\t\tif ((component = vnode._component) && !component._processingException) {\n\t\t\ttry {\n\t\t\t\tctor = component.constructor;\n\n\t\t\t\tif (ctor && ctor.getDerivedStateFromError != null) {\n\t\t\t\t\tcomponent.setState(ctor.getDerivedStateFromError(error));\n\t\t\t\t\thandled = component._dirty;\n\t\t\t\t}\n\n\t\t\t\tif (component.componentDidCatch != null) {\n\t\t\t\t\tcomponent.componentDidCatch(error, errorInfo || {});\n\t\t\t\t\thandled = component._dirty;\n\t\t\t\t}\n\n\t\t\t\t// This is an error boundary. Mark it as having bailed out, and whether it was mid-hydration.\n\t\t\t\tif (handled) {\n\t\t\t\t\treturn (component._pendingError = component);\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\terror = e;\n\t\t\t}\n\t\t}\n\t}\n\n\tthrow error;\n}\n","import { Delivery, EventForDelivery, ExtendedClientApi } from './client';\nimport { Notifier } from './notifier';\n\nexport class FetchDelivery implements Delivery {\n  constructor(private client: ExtendedClientApi) {}\n\n  async sendEvent({\n    apiKey,\n    events,\n    notifier,\n    payloadVersion,\n  }: {\n    apiKey: string;\n    events: Array<EventForDelivery>;\n    notifier: Notifier;\n    payloadVersion: string;\n  }): Promise<void> {\n    const sentAt = new Date().toISOString();\n\n    const body = JSON.stringify({\n      apiKey,\n      payloadVersion,\n      notifier,\n      events,\n    });\n\n    await fetch(this.client.endpoints.notify, {\n      method: 'POST',\n      mode: 'cors',\n      credentials: 'omit',\n      headers: {\n        'Content-Type': 'application/json',\n        'Bugsnag-Api-Key': apiKey,\n        'Bugsnag-Payload-Version': payloadVersion,\n        'Bugsnag-Sent-At': sentAt,\n      },\n      referrerPolicy: 'no-referrer',\n      body,\n    });\n  }\n}\n","export type Replacer = (key: string | number, value: unknown) => unknown;\n\nexport const CircularReference = Symbol('Circular');\nexport const AccessError = Symbol('AccessError');\n\n/**\n * Iterate through an object's properties and return a copy with the values\n * replaced by the result of the replacer function.\n *\n * Detects circular references and replaces them with the `CircularReference`\n * symbol.\n *\n * Detects errors accessing properties and replaces them with the `AccessError`\n * symbol.\n *\n * For any objects with a `toJSON` function, it will be called instead of\n * traversing the object's properties.\n */\nexport function safeFilter(\n  input: unknown,\n  replacer?: Replacer | null,\n  options?: { depthLimit?: number; edgesLimit?: number }\n): unknown {\n  return filter({\n    key: '',\n    value: input,\n    replacer,\n    seen: [],\n    depth: 0,\n    depthLimit: options?.depthLimit,\n    edgeIndex: 0,\n    edgesLimit: options?.edgesLimit,\n  });\n}\n\nfunction filter({\n  key,\n  value,\n  replacer,\n  seen,\n  depthLimit = Infinity,\n  depth,\n  edgeIndex,\n  edgesLimit = Infinity,\n}: {\n  key: string | number;\n  value: unknown;\n  replacer?: Replacer | null;\n  seen: unknown[];\n  depth: number;\n  depthLimit?: number;\n  edgeIndex: number;\n  edgesLimit?: number;\n}): unknown {\n  let replacement = value;\n\n  if (seen.includes(replacement)) {\n    replacement = CircularReference;\n  }\n\n  if (replacer) {\n    replacement = replacer(key, replacement);\n  }\n\n  if (hasToJson(replacement)) {\n    replacement = safeAccess(() =>\n      (replacement as withToJson).toJSON(String(key))\n    );\n  }\n\n  // TODO: We really should re-run our cyclic dependency check at this point in\n  // case the replacer or toJSON has created a new cyclic dependency.\n  //\n  // Surely no-one would do that though, right?\n\n  if (replacement === null || typeof replacement !== 'object') {\n    return replacement;\n  }\n\n  if (depth > depthLimit || edgeIndex + 1 > edgesLimit) {\n    return '[...]';\n  }\n\n  seen.push(value);\n\n  if (Array.isArray(replacement)) {\n    const copy: unknown[] = [];\n    const limit = Math.min(replacement.length, edgesLimit);\n\n    for (let i = 0; i < limit; i++) {\n      const item = safeAccess(() => (replacement as unknown[])[i]);\n\n      copy.push(\n        filter({\n          key: i,\n          value: item,\n          replacer,\n          seen,\n          depth,\n          depthLimit,\n          edgeIndex: i,\n          edgesLimit,\n        })\n      );\n    }\n\n    if (limit < replacement.length) {\n      copy.push('[...]');\n    }\n\n    replacement = copy;\n  } else {\n    const copy: Record<string, unknown> = {};\n\n    const keys = Object.keys(replacement as object);\n    for (let i = 0; i < keys.length; i++) {\n      const currentKey = keys[i];\n      const value = safeAccess(\n        () => (replacement as Record<string, unknown>)[currentKey]\n      );\n\n      copy[currentKey] = filter({\n        key: currentKey,\n        value,\n        replacer,\n        seen,\n        depth,\n        depthLimit,\n        edgeIndex: i,\n        edgesLimit,\n      });\n    }\n\n    replacement = copy;\n  }\n\n  seen.pop();\n\n  return replacement;\n}\n\nexport function safeAccess<T>(accessor: () => T): T | typeof AccessError {\n  try {\n    return accessor();\n  } catch {\n    return AccessError;\n  }\n}\n\ntype withToJson = { toJSON: (key?: string) => unknown };\n\nfunction hasToJson(value: unknown): value is withToJson {\n  return (\n    typeof value === 'object' &&\n    value !== null &&\n    'toJSON' in value &&\n    typeof (value as { toJSON: unknown }).toJSON === 'function'\n  );\n}\n","// Based heavily on: https://github.com/mk-pmb/is-error-js\n//\n// which has the following license:\n//\n// Copyright (c) 2015 is-error.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nconst objectToString = Object.prototype.toString;\nconst getPrototypeOf = Object.getPrototypeOf;\nconst ERROR_TYPE = '[object Error]';\n\nexport function isError(a: unknown): a is Error {\n  if (a instanceof Error) {\n    return true;\n  }\n\n  let err = a;\n  while (err) {\n    if (objectToString.call(err) === ERROR_TYPE) {\n      return true;\n    }\n    err = getPrototypeOf(err);\n  }\n\n  return false;\n}\n","export function isObject(a: unknown): a is Record<string, any> {\n  return typeof a === 'object' && a !== null && !Array.isArray(a);\n}\n","import { StackFrame } from './event';\n\n// The following code is based on:\n//\n// https://github.com/stacktracejs/error-stack-parser/blob/master/error-stack-parser.js\n//\n// which is released under the MIT license. Its copyright and license terms\n// are as follows:\n//\n// Copyright (c) 2017 Eric Wendelin and other contributors\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n// SOFTWARE.\n//\n// It has been modified to match Bugsnag's stackframe format, remove unneeded\n// Opera stackframe handling, and use TypeScript and more modern JavaScript.\n\nconst CHROME_IE_STACK_REGEXP = /^\\s*at .*(\\S+:\\d+|\\(native\\))/m;\nconst SAFARI_NATIVE_CODE_REGEXP = /^(eval@)?(\\[native code])?$/;\n\nexport function parseStack(stackString: string): Array<StackFrame> {\n  const partialResult = stackString.match(CHROME_IE_STACK_REGEXP)\n    ? parseV8OrIE(stackString)\n    : parseFFOrSafari(stackString);\n\n  return partialResult.reduce<StackFrame[]>((result, stack) => {\n    // Drop empty stack frames\n    if (JSON.stringify(stack) === '{}') {\n      return result;\n    }\n\n    // If we have no file or method but we _do_ have a line number, it must be\n    // global code.\n    let file =\n      !stack.file && !stack.method && typeof stack.lineNumber === 'number'\n        ? 'global code'\n        : stack.file || '(unknown file)';\n\n    // Strip the query string / fragment from filenames\n    file = file.replace(/\\?.*$/, '').replace(/#.*$/, '');\n\n    // Case normalize \"global code\" function names\n    let method = stack.method || '(unknown function)';\n    method = /^global code$/i.test(method) ? 'global code' : method;\n\n    return result.concat([\n      {\n        file,\n        lineNumber: stack.lineNumber,\n        columnNumber: stack.columnNumber,\n        method,\n      },\n    ]);\n  }, []);\n}\n\nfunction parseV8OrIE(stackString: string): Array<Partial<StackFrame>> {\n  const filtered = stackString\n    .split('\\n')\n    .filter((line) => !!line.match(CHROME_IE_STACK_REGEXP));\n\n  return filtered.map((line) => {\n    // Bugsnag stack frames don't have a way of representing eval origins\n    // so we just throw that information away for now.\n    //\n    // stacktrace.js can represent this but it still throws this information\n    // away.\n    if (line.indexOf('(eval ') > -1) {\n      line = line\n        .replace(/eval code/g, 'eval')\n        .replace(/(\\(eval at [^()]*)|(\\),.*$)/g, '');\n    }\n    let sanitizedLine = line.replace(/^\\s+/, '').replace(/\\(eval code/g, '(');\n\n    // Capture and preserve the parenthesized location \"(/foo/my bar.js:12:87)\"\n    // in case it has spaces in it, as the string is split on \\s+ later on.\n    const location = sanitizedLine.match(/ (\\((.+):(\\d+):(\\d+)\\)$)/);\n\n    // Remove the parenthesized location from the line, if it was matched.\n    sanitizedLine = location\n      ? sanitizedLine.replace(location[0], '')\n      : sanitizedLine;\n\n    const tokens = sanitizedLine.split(/\\s+/).slice(1);\n\n    // If a location was matched, pass it to extractLocation(), otherwise pop\n    // the last token.\n    const locationParts = extractLocation(\n      location ? location[1] : tokens.pop() || '(no location)'\n    );\n\n    const method = tokens.join(' ') || undefined;\n    const file =\n      ['eval', '<anonymous>'].indexOf(locationParts[0]) > -1\n        ? undefined\n        : locationParts[0];\n\n    return {\n      file,\n      lineNumber: locationParts[1],\n      columnNumber: locationParts[2],\n      method,\n    };\n  });\n}\n\nfunction parseFFOrSafari(stackString: string): Array<Partial<StackFrame>> {\n  const filtered = stackString\n    .split('\\n')\n    .filter((line) => !line.match(SAFARI_NATIVE_CODE_REGEXP));\n\n  return filtered.map((line) => {\n    // Bugsnag stack frames don't have a way of representing eval origins\n    // so we just throw that information away for now.\n    //\n    // stacktrace.js can represent this but it still throws this information\n    // away.\n    if (line.indexOf(' > eval') > -1) {\n      line = line.replace(\n        / line (\\d+)(?: > eval line \\d+)* > eval:\\d+:\\d+/g,\n        ':$1'\n      );\n    }\n\n    if (line.indexOf('@') === -1 && line.indexOf(':') === -1) {\n      // Safari eval frames only have function names and nothing else\n      return {\n        method: line,\n      };\n    } else {\n      const functionNameRegex = /((.*\".+\"[^@]*)?[^@]*)(?:@)/;\n      const matches = line.match(functionNameRegex);\n      const method = matches && matches[1] ? matches[1] : undefined;\n      const locationParts = extractLocation(\n        line.replace(functionNameRegex, '')\n      );\n\n      return {\n        file: locationParts[0],\n        lineNumber: locationParts[1],\n        columnNumber: locationParts[2],\n        method,\n      };\n    }\n  });\n}\n\n// Separate line and column numbers from a string of the form: (URI:Line:Column)\nfunction extractLocation(\n  urlLike: string\n): [uri: string, line?: number | undefined, col?: number | undefined] {\n  // Fail-fast but return locations like \"(native)\"\n  if (urlLike.indexOf(':') === -1) {\n    return [urlLike];\n  }\n\n  const regExp = /(.+?)(?::(\\d+))?(?::(\\d+))?$/;\n  const parts = regExp.exec(urlLike.replace(/[()]/g, ''));\n  if (!parts) {\n    return [urlLike];\n  }\n\n  const line = parts[2] ? parseInt(parts[2], 10) : undefined;\n  const col = parts[3] ? parseInt(parts[3], 10) : undefined;\n\n  return [parts[1], line, col];\n}\n","import type { BugsnagException, StackFrame } from './event';\nimport { isError } from './is-error';\nimport { isObject } from './is-object';\nimport { parseStack } from './parse-stack';\nimport { NonEmptyArray } from './type-helpers';\n\nexport function toExceptions(\n  maybeError: unknown,\n  component: string\n): {\n  exceptions: NonEmptyArray<BugsnagException>;\n  metadata?: Record<string, any>;\n} {\n  const error = normalizeError(maybeError, component);\n\n  // Add metadata for non-errors\n  let metadata: Record<string, any> | undefined;\n  if (error.name === 'InvalidError') {\n    metadata = {\n      [component]: {\n        'non-error parameter': maybeError,\n      },\n    };\n  }\n\n  // Merge any metadata defined on the object itself\n  if (\n    typeof (error as any).metadata !== 'undefined' &&\n    isObject((error as any).metadata)\n  ) {\n    metadata = { ...metadata, [error.name]: (error as any).metadata };\n  }\n\n  const exceptions: NonEmptyArray<BugsnagException> = [makeException(error)];\n\n  // Add any causes\n  exceptions.push(\n    ...getCauses(error).map((cause) =>\n      makeException(cause, { backtrace: false })\n    )\n  );\n\n  return { exceptions, metadata };\n}\n\nfunction normalizeError(maybeError: unknown, component: string): Error {\n  if (isError(maybeError)) {\n    return maybeError;\n  }\n\n  let error = fromSimpleError(maybeError);\n  if (error) {\n    return error;\n  }\n\n  switch (typeof error) {\n    case 'string':\n    case 'number':\n    case 'boolean':\n      return new Error(String(maybeError));\n\n    default: {\n      error = new Error(\n        `${component} received a non-error. See \"${component}\" tab for more detail.`\n      );\n      error.name = 'InvalidError';\n      return error;\n    }\n  }\n}\n\nfunction fromSimpleError(error: unknown): Error | null {\n  if (!isObject(error)) {\n    return null;\n  }\n\n  const getStringMember = (field: string) =>\n    typeof error[field] === 'string' && error[field].length\n      ? error[field]\n      : undefined;\n\n  const name = getStringMember('name') || getStringMember('errorClass');\n  const message = getStringMember('message') || getStringMember('errorMessage');\n  if (!name || !message) {\n    return null;\n  }\n\n  const newError = new Error(message);\n  newError.name = name;\n  return newError;\n}\n\nfunction makeException(\n  error: Error,\n  stackOptions: { backtrace: boolean } = { backtrace: false }\n): BugsnagException {\n  return {\n    errorClass: error.name,\n    message: error.message,\n    stacktrace: getStacktrace(error, stackOptions),\n    type:\n      typeof self === 'object' && (self as Window).navigator\n        ? 'browserjs'\n        : 'nodejs',\n  };\n}\n\nfunction getStacktrace(\n  error: Error,\n  { backtrace }: { backtrace: boolean }\n): Array<StackFrame> {\n  const stackString = getStackString(error);\n  if (stackString) {\n    return parseStack(stackString);\n  } else if (backtrace) {\n    // TODO: We'll probably want to trim this to remove some of our own\n    // frames from it but let's wait until we actually have some examples of\n    // that to work with.\n    return generateBacktrace();\n  } else {\n    return [];\n  }\n}\n\nfunction getStackString(error: Error): string | undefined {\n  const stack = error.stack || (error as any).stacktrace;\n  return typeof stack === 'string' &&\n    stack.length &&\n    stack !== `${error.name}: ${error.message}`\n    ? stack\n    : undefined;\n}\n\nconst MAX_STACK_SIZE = 20;\n\n// The following is based on\n//\n// https://github.com/stacktracejs/stack-generator/blob/master/stack-generator.js\n//\n// which is licensed to the Public Domain.\nfunction generateBacktrace(): Array<StackFrame> {\n  const stack: Array<StackFrame> = [];\n\n  // arguments.callee cannot be accessed in strict mode.\n  let curr: Function;\n  try {\n    // eslint-disable-next-line no-caller\n    curr = arguments.callee;\n  } catch (_e) {\n    return [];\n  }\n\n  while (curr && stack.length < MAX_STACK_SIZE) {\n    if (curr.name) {\n      stack.push({ method: curr.name, file: '(unknown file)' });\n    } else if (/function(?:\\s+([\\w$]+))+\\s*\\(/.test(curr.toString())) {\n      stack.push({ method: RegExp.$1, file: '(unknown file)' });\n    }\n\n    try {\n      curr = curr.caller;\n    } catch (e) {\n      break;\n    }\n  }\n\n  return stack;\n}\n\nfunction getCauses(error: Error): Array<Error> {\n  if (!error.cause) {\n    return [];\n  }\n\n  const cause = normalizeError(error.cause, 'cause');\n  if (cause.name === 'InvalidError') {\n    return [];\n  }\n\n  return [cause].concat(getCauses(cause));\n}\n","import type { ExtendedClientApi, Plugin } from './client';\nimport type { BugsnagException } from './event';\nimport { toExceptions } from './to-exceptions';\nimport { NonEmptyArray } from './type-helpers';\n\nexport const browserNotifyUnhandledExceptions: Plugin = {\n  name: 'browserNotifyUnhandledExceptions',\n  load(client: ExtendedClientApi) {\n    self.addEventListener('error', (evt: ErrorEvent | Event) => {\n      let exceptions: NonEmptyArray<BugsnagException>;\n      let metadata: Record<string, any> | undefined;\n\n      if (evt instanceof ErrorEvent) {\n        const { message, filename: file, lineno, colno, error } = evt;\n        const lineNumber = Number.isSafeInteger(lineno) ? lineno : undefined;\n        if (lineNumber === 0 && /Script error\\.?/.test(message)) {\n          console.log('Ignoring cross-domain or eval script error.');\n          return;\n        }\n\n        ({ exceptions, metadata } = toExceptions(error, 'window onerror'));\n\n        // Augment first stacktrace if we have more info in the ErrorEvent than\n        // the stack trace we got.\n        const columnNumber = Number.isSafeInteger(colno) ? colno : undefined;\n        const { stacktrace } = exceptions[0];\n        if (!stacktrace.length) {\n          stacktrace.push({\n            file,\n            lineNumber,\n            columnNumber,\n            method: '(unknown file)',\n          });\n        } else {\n          const firstStackFrame = stacktrace[0];\n          firstStackFrame.file = firstStackFrame.file || file;\n          firstStackFrame.lineNumber = firstStackFrame.lineNumber ?? lineNumber;\n          firstStackFrame.columnNumber =\n            firstStackFrame.columnNumber ?? columnNumber;\n        }\n      } else {\n        ({ exceptions, metadata } = toExceptions(evt, 'window onerror'));\n      }\n\n      client.notifyEvent(\n        {\n          exceptions,\n          unhandled: true,\n          severity: 'error',\n          severityReason: {\n            type: 'unhandledException',\n          },\n          metadata,\n        },\n        evt\n      );\n    });\n  },\n};\n","import { ExtendedClientApi, Plugin } from './client';\nimport { toExceptions } from './to-exceptions';\n\nexport const browserNotifyUnhandledRejections: Plugin = {\n  name: 'browserNotifyUnhandledRejections',\n  load(client: ExtendedClientApi) {\n    self.addEventListener(\n      'unhandledrejection',\n      (evt: PromiseRejectionEvent) => {\n        const error = evt.reason;\n\n        const { exceptions, metadata } = toExceptions(\n          error,\n          'unhandledrejection'\n        );\n\n        // The official bugsnag client digs into `error` and, if it has no\n        // stack, but is an Error object, it pulls out the name, message, code\n        // and adds them to a metadata tab called 'unhandledRejection handler'.\n        //\n        // I don't understand this. Surely we'll have the same information in\n        // our exception object already?\n\n        client.notifyEvent(\n          {\n            exceptions,\n            unhandled: true,\n            severity: 'error',\n            severityReason: {\n              type: 'unhandledPromiseRejection',\n            },\n            metadata,\n          },\n          error\n        );\n      }\n    );\n  },\n};\n","import { ExtendedClientApi, Plugin } from './client';\n\nexport const consoleBreadcrumbs: Plugin = {\n  name: 'consoleBreadcrumbs',\n  load(client: ExtendedClientApi) {\n    // We need to exclude the 'Console' ctor function because it's in Node's\n    // Console interface but not the DOM one.\n    type nonCtorKeys = Exclude<keyof Console, 'Console'>;\n    const methodsToHook = (\n      ['log', 'debug', 'info', 'warn', 'error'] as Array<nonCtorKeys>\n    ).filter(\n      (method) =>\n        typeof console !== 'undefined' && typeof console[method] === 'function'\n    );\n\n    for (const method of methodsToHook) {\n      const original = console[method];\n      console[method] = (...args: Array<any>) => {\n        client.leaveBreadcrumb(\n          'Console output',\n          args.reduce(\n            (metadata: Record<string, any>, arg: any, i: number) => {\n              // Try to stringify each argument\n              let stringified = '[Unknown value]';\n\n              // Try to use toString.\n              //\n              // This may fail if the input is:\n              //\n              // - an object whose [[Prototype]] is null (no toString), or\n              // - an object with a broken toString or @@toPrimitive\n              //   implementation\n              try {\n                stringified = String(arg);\n              } catch (_e) {\n                /* Ignore */\n              }\n\n              // If it stringifies to [object Object] attempt to JSON stringify\n              if (stringified === '[object Object]') {\n                // But catch any stringify errors (falling back to\n                // [object Object])\n                try {\n                  stringified = JSON.stringify(arg);\n                } catch (_e) {\n                  /* Ignore */\n                }\n              }\n\n              metadata[`[${i}]`] = stringified;\n              return metadata;\n            },\n            {\n              // The official client attempts to map console.group to 'log' here\n              // but it never actually hooks console.group.\n              severity: method,\n            }\n          ),\n          'log'\n        );\n        original.apply(console, args);\n      };\n    }\n  },\n};\n","import { ExtendedClientApi, Plugin } from './client';\nimport { BugsnagEvent } from './event';\n\nexport const errorBreadcrumbs: Plugin = {\n  name: 'errorBreadcrumbs',\n  load(client: ExtendedClientApi) {\n    client.addOnPostError((event: BugsnagEvent) => {\n      client.leaveBreadcrumb(\n        event.exceptions[0].errorClass,\n        {\n          errorClass: event.exceptions[0].errorClass,\n          errorMessage: event.exceptions[0].message,\n          severity: event.severity,\n        },\n        'error'\n      );\n    });\n  },\n};\n","import { ExtendedClientApi, Plugin } from './client';\nimport { isObject } from './is-object';\n\n// Unlike the official bugsnag JS client this does NOT cover XHR.\n// Furthermore, it does not provide a way to be cleaned up.\nexport const fetchBreadcrumbs: Plugin = {\n  name: 'fetchBreadcrumbs',\n  load(client: ExtendedClientApi) {\n    if (!('fetch' in self)) {\n      return;\n    }\n\n    const oldFetch = self.fetch;\n    self.fetch = function fetch(input: RequestInfo | URL, init?: RequestInit) {\n      let method = 'GET';\n      let url: string;\n\n      if (isRequest(input)) {\n        url = input.url;\n        method = input.method;\n      } else {\n        url = input.toString();\n      }\n\n      // Per the fetch algorithm, the method specified in the RequestInit takes\n      // precedence over the method specified in the Request.\n      if (init && typeof init.method === 'string' && init.method.length) {\n        method = init.method;\n      }\n\n      const leaveBreadcrumb = client.leaveBreadcrumb.bind(client);\n      return new Promise((resolve, reject) => {\n        oldFetch(input, init)\n          .then((response) => {\n            handleFetchSuccess({ response, method, url, leaveBreadcrumb });\n            resolve(response);\n          })\n          .catch((error) => {\n            handleFetchError({ method, url, leaveBreadcrumb });\n            reject(error);\n          });\n      });\n    };\n  },\n};\n\nfunction isRequest(input: RequestInfo | URL): input is Request {\n  // instanceof alone won't work for objects from different realms\n  return input instanceof Request || (isObject(input) && 'url' in input);\n}\n\nfunction handleFetchSuccess({\n  response,\n  method,\n  url,\n  leaveBreadcrumb,\n}: {\n  response: Response;\n  method: string;\n  url: string;\n  leaveBreadcrumb: ExtendedClientApi['leaveBreadcrumb'];\n}) {\n  // The official bugsnag client ignores bugsnag requests for XHR but not for\n  // fetch. I think it means to ignore it for fetch, though.\n  if (url.startsWith('https://notify.bugsnag.com')) {\n    return;\n  }\n\n  const metadata = {\n    status: response.status,\n    request: `${method} ${url}`,\n  };\n\n  if (response.status >= 400) {\n    leaveBreadcrumb('fetch() failed', metadata, 'request');\n  } else {\n    leaveBreadcrumb('fetch() succeeded', metadata, 'request');\n  }\n}\n\nfunction handleFetchError({\n  method,\n  url,\n  leaveBreadcrumb,\n}: {\n  method: string;\n  url: string;\n  leaveBreadcrumb: ExtendedClientApi['leaveBreadcrumb'];\n}) {\n  if (url.startsWith('https://notify.bugsnag.com')) {\n    return;\n  }\n\n  leaveBreadcrumb('fetch() error', { request: `${method} ${url}` }, 'request');\n}\n","import { isObject } from './is-object';\nimport { ExtendedClientApi, Plugin } from './client';\n\nexport const interactionBreadcrumbs: Plugin = {\n  name: 'interactionBreadcrumbs',\n  load(client: ExtendedClientApi) {\n    if (!('addEventListener' in self)) {\n      return;\n    }\n\n    self.addEventListener(\n      'click',\n      (event) => {\n        let targetText, targetSelector;\n        try {\n          targetText = isHtmlElement(event.target)\n            ? getNodeText(event.target)\n            : '(Non-HTML Element)';\n          targetSelector = isElement(event.target)\n            ? getNodeSelector(event.target)\n            : '(Non-element target)';\n        } catch (e) {\n          targetText = '[hidden]';\n          targetSelector = '[hidden]';\n        }\n        client.leaveBreadcrumb(\n          'UI click',\n          { targetText, targetSelector },\n          'user'\n        );\n      },\n      true\n    );\n  },\n};\n\nfunction isElement(target: EventTarget | null): target is Element {\n  return isObject(target) && (target as Node).nodeType === Node.ELEMENT_NODE;\n}\n\nfunction isHtmlElement(target: EventTarget | null): target is HTMLElement {\n  return (\n    isElement(target) && target.namespaceURI === 'http://www.w3.org/1999/xhtml'\n  );\n}\n\nfunction getNodeText(elem: HTMLElement): string {\n  let text = elem.textContent || elem.innerText || '';\n  if (\n    !text &&\n    ((elem as HTMLInputElement).type === 'submit' ||\n      (elem as HTMLInputElement).type === 'button')\n  ) {\n    text = (elem as HTMLInputElement).value;\n  }\n  return truncate(text.trim(), 140);\n}\n\n// Create a label from tagname, id and css class of the element\nfunction getNodeSelector(elem: Element): string {\n  // Generate an initial selector using ID + class names\n  //\n  // (This is particularly unsuitable for utility CSS frameworks like Tailwind\n  // but oh well)\n  const parts = [elem.tagName];\n  if (elem.id) {\n    parts.push('#' + elem.id);\n  }\n  if (elem.className && elem.className.length) {\n    parts.push(`.${elem.className.split(' ').join('.')}`);\n  }\n\n  // We can't try out the selector in this context so just return it as-is.\n  if (!self.document.querySelectorAll) {\n    return parts.join('');\n  }\n\n  // See if the selector we have generated is sufficiently specific\n  try {\n    if (self.document.querySelectorAll(parts.join('')).length === 1) {\n      return parts.join('');\n    }\n  } catch {\n    // Sometimes the query selector can be invalid just return it as-is.\n    return parts.join('');\n  }\n\n  // Try to get a more specific selector if this one matches more than one\n  // element.\n  if (elem.parentNode && elem.parentNode.childNodes.length > 1) {\n    const index = Array.from(elem.parentNode.children).indexOf(elem) + 1;\n    parts.push(`:nth-child(${index})`);\n  }\n\n  if (self.document.querySelectorAll(parts.join('')).length === 1) {\n    return parts.join('');\n  }\n\n  // Try prepending the parent element selector\n  if (elem.parentElement) {\n    return `${getNodeSelector(elem.parentElement)} > ${parts.join('')}`;\n  }\n\n  return parts.join('');\n}\n\nfunction truncate(value: string, length: number): string {\n  const ommision = '(...)';\n  return value.length <= length\n    ? value\n    : value.slice(0, length - ommision.length) + ommision;\n}\n","import { ExtendedClientApi, Plugin } from './client';\n\nexport const navigationBreadcrumbs: Plugin = {\n  name: 'navigationBreadcrumbs',\n  load(client: ExtendedClientApi) {\n    if (!('addEventListener' in self)) {\n      return;\n    }\n\n    const drop = (name: string) => () =>\n      client.leaveBreadcrumb(name, undefined, 'navigation');\n\n    self.addEventListener('pagehide', drop('Page hidden'), true);\n    self.addEventListener('pageshow', drop('Page shown'), true);\n    self.addEventListener('load', drop('Page loaded'), true);\n    if (self.document) {\n      self.document.addEventListener(\n        'DOMContentLoaded',\n        drop('DOMContentLoaded'),\n        true\n      );\n    }\n\n    // Some browsers like to emit popstate when the page loads, so only add the\n    // popstate listener after that\n    self.addEventListener('load', () =>\n      self.addEventListener('popstate', drop('Navigated back'), true)\n    );\n\n    // hashchange has some metadata that we care about\n    if (self.location) {\n      self.addEventListener(\n        'hashchange',\n        (event: HashChangeEvent) => {\n          const metadata = event.oldURL\n            ? {\n                from: relativeLocation(event.oldURL),\n                to: relativeLocation(event.newURL),\n                state: getCurrentState(self),\n              }\n            : { to: relativeLocation(self.location.href) };\n          client.leaveBreadcrumb('Hash changed', metadata, 'navigation');\n        },\n        true\n      );\n    }\n\n    // Wrap replaceState/pushState\n    const leaveBreadcrumb = client.leaveBreadcrumb.bind(client);\n    if (self.history && self instanceof Window) {\n      if (typeof self.history.replaceState === 'function') {\n        wrapHistoryFn({\n          fn: 'replaceState',\n          target: self.history,\n          leaveBreadcrumb,\n          win: self,\n        });\n      }\n      if (typeof self.history.pushState === 'function') {\n        wrapHistoryFn({\n          fn: 'pushState',\n          target: self.history,\n          leaveBreadcrumb,\n          win: self,\n        });\n      }\n    }\n  },\n};\n\n// Takes a full url like http://foo.com:1234/pages/01.html?yes=no#section-2 and\n// returns just the path and hash parts, e.g. /pages/01.html?yes=no#section-2\n//\n// Compatibility: This uses the URL constructor which is not available in IE\n// or Edge < 12.\nfunction relativeLocation(url: string): string {\n  try {\n    const urlObj = new URL(url);\n    return `${urlObj.pathname}${urlObj.search}${urlObj.hash}`;\n  } catch (e) {\n    return url;\n  }\n}\n\nfunction getCurrentState(win: Window): any {\n  try {\n    return win.history.state;\n  } catch (e) {\n    return {};\n  }\n}\n\nfunction wrapHistoryFn({\n  fn,\n  leaveBreadcrumb,\n  target,\n  win,\n}: {\n  fn: 'replaceState' | 'pushState';\n  leaveBreadcrumb: ExtendedClientApi['leaveBreadcrumb'];\n  target: History;\n  win: Window;\n}) {\n  const orig = target[fn];\n  target[fn] = (state: any, title: string, url?: string | null | undefined) => {\n    leaveBreadcrumb(\n      `History ${fn}`,\n      stateChangeToMetadata({ win, state, title, url }),\n      'navigation'\n    );\n\n    // TODO: If we implement maxEvents, reset that count here.\n\n    orig.apply(target, [state, title, url]);\n  };\n}\n\nfunction stateChangeToMetadata({\n  win,\n  state,\n  title,\n  url,\n}: {\n  win: Window;\n  state: any;\n  title: string;\n  url?: string | null | undefined;\n}) {\n  const currentPath = relativeLocation(win.location.href);\n\n  return {\n    title,\n    state,\n    prevState: getCurrentState(win),\n    to: url || currentPath,\n    from: currentPath,\n  };\n}\n","import { ExtendedClientApi, Plugin } from './client';\nimport { BugsnagEvent } from './event';\n\nlet appStart = Date.now();\nconst reset = () => {\n  appStart = Date.now();\n};\n\nexport const appDuration: Plugin = {\n  name: 'appDuration',\n  load(client: ExtendedClientApi) {\n    client.addOnError((event: BugsnagEvent) => {\n      const now = Date.now();\n      event.app = event.app || {};\n      event.app.duration = now - appStart;\n    });\n\n    return { reset };\n  },\n};\n","import { UserAgentInfo } from './browser-context';\n\n// The Bugsnag v5 API requires doing your own UA string parsing, requiring a\n// `browserName`, `browserVersion`, `osName`, `osVersion`, etc.\n//\n// That's very unfriendly and probably why the official client still uses the v4\n// API which takes a `userAgent` parameter and appears to parse it on the\n// server.\n//\n// Nevertheless, we're using the v5 API for now so we should do the parsing\n// ourselves.\n//\n// Note that UA parser libraries typically are very heavyweight since they try\n// to cover every user agent that ever existed including various bots etc.\n//\n// However, all we really care about is differentiating between the most common\n// _browsers_ and their respective platforms / OSes.\n//\n// Furthermore, we want this to be as lightweight as possible so this is very\n// deliberately a very barebones approach. We can add other user agents if and\n// when they become interesting.\n//\n// This is based on\n// https://github.com/DamonOehlman/detect-browser/blob/master/src/index.ts but\n// adapted quite heavily.\n\nexport function parseUserAgent(userAgent: string): UserAgentInfo {\n  const matchedRule: UserAgentMatch = matchUserAgent(userAgent);\n\n  if (!matchedRule) {\n    return {};\n  }\n\n  const [name, match] = matchedRule;\n  const os = detectOS(userAgent);\n  const device = os?.osName === 'iOS' ? detectAppleDevice(userAgent) : {};\n\n  return {\n    browserName: name,\n    browserVersion: match[1],\n    osName: os?.osName,\n    osVersion: os?.osVersion,\n    manufacturer: device?.manufacturer,\n    model: device?.model,\n  };\n}\n\ntype UserAgentRule = [string, RegExp];\nconst userAgentRules: UserAgentRule[] = [\n  ['Edge (EdgeHTML)', /Edge\\/([0-9._]+)/],\n  ['Edge (iOS)', /EdgiOS\\/([0-9._]+)/],\n  ['Yandex', /YaBrowser\\/([0-9._]+)/],\n  ['KakaoTalk', /KAKAOTALK\\s([0-9.]+)/],\n  ['Samsung', /SamsungBrowser\\/([0-9.]+)/],\n  ['Silk', /\\bSilk\\/([0-9._-]+)\\b/],\n  ['MIUI', /MiuiBrowser\\/([0-9.]+)$/],\n  ['Beaker', /BeakerBrowser\\/([0-9.]+)/],\n  ['Edge (Chromium)', /EdgA?\\/([0-9.]+)/],\n  ['Chromium WebView', /(?!Chrom.*OPR)wv\\).*Chrom(?:e|ium)\\/([0-9.]+)(:?\\s|$)/],\n  ['Chrome', /(?!Chrom.*OPR)Chrom(?:e|ium)\\/([0-9.]+)(:?\\s|$)/],\n  ['Chrome (iOS)', /CriOS\\/([0-9.]+)(:?\\s|$)/],\n  ['Firefox', /Firefox\\/([0-9.]+)(?:\\s|$)/],\n  ['Firefox (iOS)', /FxiOS\\/([0-9.]+)/],\n  ['Opera Mini', /Opera Mini.*Version\\/([0-9.]+)/],\n  ['Opera', /Opera\\/([0-9.]+)(?:\\s|$)/],\n  ['Opera', /OPR\\/([0-9.]+)(:?\\s|$)/],\n  ['Internet Explorer', /Trident\\/7\\.0.*rv:([0-9.]+).*\\).*Gecko$/],\n  ['Internet Explorer', /MSIE\\s([0-9.]+);.*Trident\\/[4-7].0/],\n  ['Internet Explorer', /MSIE\\s(7\\.0)/],\n  ['Blackberry', /BB10;\\sTouch.*Version\\/([0-9.]+)/],\n  ['Android', /Android\\s([0-9.]+)/],\n  ['Safari (iOS)', /Version\\/([0-9._]+).*Mobile.*Safari.*/],\n  ['Safari', /Version\\/([0-9._]+).*Safari/],\n  ['Facebook', /FB[AS]V\\/([0-9.]+)/],\n  ['Instagram', /Instagram\\s([0-9.]+)/],\n  ['iOS WebView', /AppleWebKit\\/([0-9.]+).*Mobile/],\n  ['iOS WebView', /AppleWebKit\\/([0-9.]+).*Gecko\\)$/],\n];\n\ntype UserAgentMatch = [string, RegExpExecArray] | false;\n\nfunction matchUserAgent(userAgent: string): UserAgentMatch {\n  return (\n    userAgent !== '' &&\n    userAgentRules.reduce<UserAgentMatch>(\n      (matched: UserAgentMatch, [browser, regex]) => {\n        if (matched) {\n          return matched;\n        }\n\n        const uaMatch = regex.exec(userAgent);\n        return !!uaMatch && [browser, uaMatch];\n      },\n      false\n    )\n  );\n}\n\ntype OperatingSystemRule = [string, string | undefined, RegExp];\n\nconst operatingSystemRules: OperatingSystemRule[] = [\n  ['iOS', undefined, /iP(hone|od|ad)/],\n  ['Android', undefined, /Android/],\n  ['BlackBerry', undefined, /BlackBerry|BB10/],\n  ['Windows Mobile', undefined, /IEMobile/],\n  ['Kindle', undefined, /Kindle/],\n  ['Windows', '3.11', /Win16/],\n  ['Windows', '95', /(Windows 95)|(Win95)|(Windows_95)/],\n  ['Windows', '98', /(Windows 98)|(Win98)/],\n  ['Windows', '2000', /(Windows NT 5.0)|(Windows 2000)/],\n  ['Windows', 'XP', /(Windows NT 5.1)|(Windows XP)/],\n  ['Windows', 'Server 2003', /(Windows NT 5.2)/],\n  ['Windows', 'Vista', /(Windows NT 6.0)/],\n  ['Windows', '7', /(Windows NT 6.1)/],\n  ['Windows', '8', /(Windows NT 6.2)/],\n  ['Windows', '8.1', /(Windows NT 6.3)/],\n  ['Windows', '10+', /(Windows NT 10.0)/],\n  ['Windows', 'ME', /Windows ME/],\n  ['Open BSD', undefined, /OpenBSD/],\n  ['Sun OS', undefined, /SunOS/],\n  ['Chrome OS', undefined, /CrOS/],\n  ['Linux', undefined, /(Linux)|(X11)/],\n  ['Mac OS', undefined, /(Mac_PowerPC)|(Macintosh)/],\n  ['QNX', undefined, /QNX/],\n  ['BeOS', undefined, /BeOS/],\n  ['OS/2', undefined, /OS\\/2/],\n];\n\nfunction detectOS(\n  userAgent: string\n): { osName: string; osVersion?: string } | null {\n  for (const [osName, osVersion, regex] of operatingSystemRules) {\n    const match = regex.exec(userAgent);\n    if (match) {\n      return { osName, osVersion };\n    }\n  }\n\n  return null;\n}\n\nfunction detectAppleDevice(userAgent: string): {\n  manufacturer?: string;\n  model?: string;\n} | null {\n  const matches = /iPad|iPhone|iPod/.exec(userAgent);\n  if (matches) {\n    return { manufacturer: 'Apple', model: matches[0] };\n  }\n\n  if (\n    /MacIntel/.test(userAgent) &&\n    self.navigator &&\n    self.navigator.maxTouchPoints &&\n    self.navigator.maxTouchPoints > 2\n  ) {\n    return { manufacturer: 'Apple', model: 'iPad' };\n  }\n\n  return null;\n}\n","import { ExtendedClientApi, Plugin } from './client';\nimport { BugsnagEvent } from './event';\nimport { parseUserAgent } from './simple-ua-parser';\n\nexport type UserAgentInfo = {\n  browserName?: string;\n  browserVersion?: string;\n  osName?: string;\n  osVersion?: string;\n  manufacturer?: string;\n  model?: string;\n  modelNumber?: string;\n};\n\nexport type UserAgentParserFn = (userAgent: string) => UserAgentInfo;\n\nexport const browserContextWithUaParser = (\n  uaParser: UserAgentParserFn\n): Plugin => {\n  return {\n    name: 'browserContext',\n    load(client: ExtendedClientApi) {\n      client.addOnError((event: BugsnagEvent) => {\n        event.request = { ...event.request, url: self.location.href };\n        event.context = event.context || self.location.pathname;\n\n        event.device = {\n          ...event.device,\n          ...uaParser(self.navigator.userAgent),\n          locale: self.navigator.language,\n          userAgent: self.navigator.userAgent,\n        };\n\n        let languages: ReadonlyArray<string> = ['n/a'];\n        try {\n          languages = self.navigator.languages;\n        } catch {\n          /* Ignore */\n        }\n\n        event.metaData = {\n          ...event.metaData,\n          language: {\n            language: self.navigator.language,\n            languages,\n          },\n        };\n      });\n    },\n  };\n};\n\nexport const browserContext: Plugin =\n  browserContextWithUaParser(parseUserAgent);\n","import { ExtendedClientApi, Plugin } from './client';\nimport { BugsnagEvent, DeviceOrientation } from './event';\n\nexport const deviceOrientation: Plugin = {\n  name: 'deviceOrientation',\n  load(client: ExtendedClientApi) {\n    client.addOnError((event: BugsnagEvent) => {\n      let orientation: DeviceOrientation | undefined;\n\n      const screen = self.screen;\n      if (screen && screen.orientation && screen.orientation.type) {\n        orientation = screen.orientation.type;\n      } else if (self.document && self.document.documentElement) {\n        orientation =\n          self.document.documentElement.clientWidth >\n          self.document.documentElement.clientHeight\n            ? 'landscape'\n            : 'portrait';\n      }\n\n      if (orientation) {\n        event.device = { ...event.device, orientation };\n      }\n    });\n  },\n};\n","import { ExtendedClientApi, Plugin } from './client';\n\nexport const limitEvents = (limit: number): Plugin => {\n  let n = 0;\n\n  const reset = () => {\n    n = 0;\n  };\n\n  if (typeof window !== 'undefined') {\n    window.addEventListener('popstate', reset);\n  }\n\n  return {\n    name: 'limitEvents',\n    load(client: ExtendedClientApi) {\n      client.addOnError(function throttle(): boolean | void {\n        if (n >= limit) {\n          return false;\n        }\n        n++;\n      });\n\n      return { reset };\n    },\n  };\n};\n","import {\n  AccessError,\n  CircularReference,\n  safeAccess,\n  safeFilter,\n} from './safe-filter';\n\nexport function stringify(\n  input: unknown,\n  options?: {\n    depthLimit?: number;\n    edgesLimit?: number;\n  }\n): unknown {\n  return safeFilter(\n    input,\n    (_key: string | number, value: unknown) => {\n      if (value === CircularReference) {\n        return '[Circular]';\n      }\n\n      if (value === AccessError) {\n        return '[Error]';\n      }\n\n      if (\n        typeof value === 'bigint' ||\n        typeof value === 'symbol' ||\n        value instanceof RegExp\n      ) {\n        return safeAccess(() => (value as any).toString());\n      }\n\n      if (value instanceof Map) {\n        return {\n          type: 'Map',\n          value: safeAccess(() => [...(value as Map<any, any>).entries()]),\n        };\n      }\n\n      if (value instanceof Set) {\n        return {\n          type: 'Set',\n          value: safeAccess(() => [...(value as Set<any>).values()]),\n        };\n      }\n\n      if (typeof value === 'function') {\n        return safeAccess(() =>\n          truncateString(\n            (value as Function).toString().replace(/\\s+/g, ' '),\n            50\n          )\n        );\n      }\n\n      if (value instanceof Error) {\n        const replacement = {};\n        for (const key of Object.getOwnPropertyNames(value)) {\n          (replacement as Record<string, any>)[key] = safeAccess(\n            () => (value as any)[key]\n          );\n        }\n        return replacement;\n      }\n\n      if (value instanceof ArrayBuffer) {\n        return `ArrayBuffer(${value.byteLength})`;\n      }\n\n      return value;\n    },\n    options\n  );\n}\n\nfunction truncateString(input: string, maxLength: number) {\n  return input.length > maxLength\n    ? input.substring(0, maxLength - 3) + '...'\n    : input;\n}\n","import type { ExtendedClientApi, Plugin } from './client';\nimport type { BugsnagEvent } from './event';\nimport { stringify } from './stringify';\n\n/**\n * Plugin to try to stringify various unserializable JS objects (e.g. bigints,\n * Maps, Sets, functions, Error objects, Regexps) in Bugsnag events.\n */\nexport const stringifyValues: Plugin = {\n  name: 'stringifyValues',\n  load(client: ExtendedClientApi) {\n    client.addOnError(function stringifyValues(event: BugsnagEvent) {\n      if (event.metaData) {\n        event.metaData = stringify(event.metaData) as BugsnagEvent['metaData'];\n      }\n\n      if (event.breadcrumbs) {\n        event.breadcrumbs = event.breadcrumbs.map((breadcrumb) => ({\n          ...breadcrumb,\n          metaData: stringify(breadcrumb.metaData),\n        })) as BugsnagEvent['breadcrumbs'];\n      }\n    });\n  },\n};\n","import { ExtendedClientApi, Plugin } from './client';\nimport { toExceptions } from './to-exceptions';\n\nexport const browserHandledRejectionBreadcrumbs: Plugin = {\n  name: 'browserHandledRejectionBreadcrumbs',\n  load(client: ExtendedClientApi) {\n    self.addEventListener('rejectionhandled', (evt: PromiseRejectionEvent) => {\n      const error = evt.reason;\n\n      const { exceptions } = toExceptions(error, 'handledrejection');\n      const message = `Handled Promise rejection: [${exceptions[0].errorClass}] ${exceptions[0].message}`;\n\n      client.leaveBreadcrumb(\n        message,\n        { stacktrace: exceptions[0].stacktrace },\n        'error'\n      );\n    });\n  },\n};\n","import {\n  Client,\n  Delivery,\n  EventForDelivery,\n  ExtendedClientApi,\n  OnErrorCallback,\n  OnPostErrorCallback,\n  PartialEvent,\n} from './client';\nimport { Config } from './config';\nimport { Breadcrumb, BreadcrumbType, BugsnagEvent, User } from './event';\nimport { FetchDelivery } from './fetch-delivery';\nimport { Notifier } from './notifier';\nimport { safeFilter } from './safe-filter';\nimport { toExceptions } from './to-exceptions';\n\n// eslint-disable-next-line typescript-eslint(no-unsafe-declaration-merging)\nclass BugsnagStatic implements ExtendedClientApi {\n  private breadcrumbs: Array<Breadcrumb> = [];\n  private config: Config | undefined;\n  private delivery: Delivery = new FetchDelivery(this);\n  private errorCallbacks: Set<OnErrorCallback> = new Set();\n  private postErrorCallbacks: Set<OnPostErrorCallback> = new Set();\n  private plugins: Array<{ name: string; plugin: any }> = [];\n\n  start(config: Config): Client {\n    if (this.config) {\n      console.error(\n        'Bugsnag.start called multiple times. Subsequent invocations will be ignored'\n      );\n      return this;\n    }\n\n    this.config = config;\n\n    let errorCallbacks: Array<OnErrorCallback> | undefined = undefined;\n    if (this.config.onError) {\n      errorCallbacks =\n        typeof this.config.onError === 'function'\n          ? [this.config.onError]\n          : this.config.onError;\n    }\n    this.errorCallbacks = new Set(errorCallbacks);\n\n    for (const plugin of this.config.plugins || []) {\n      this.plugins.push({\n        name: plugin.name || 'unknown',\n        plugin: plugin.load(this),\n      });\n    }\n\n    this.leaveBreadcrumb('Bugsnag loaded', {}, 'state');\n\n    return this;\n  }\n\n  get endpoints() {\n    return {\n      notify: this.config?.endpoints?.notify || 'https://notify.bugsnag.com/',\n    };\n  }\n\n  notify<ErrorType = unknown>(\n    error: ErrorType,\n    options:\n      | {\n          metadata?: Record<string, any>;\n          severity?: BugsnagEvent['severity'];\n        }\n      | OnErrorCallback = {}\n  ): Promise<void> {\n    let { exceptions, metadata } = toExceptions(error, 'notify');\n\n    let onError: OnErrorCallback | undefined;\n    let severity: BugsnagEvent['severity'] | undefined;\n\n    if (typeof options === 'function') {\n      onError = options;\n    } else {\n      severity = options.severity;\n      if (options.metadata) {\n        metadata = { ...metadata, ...options.metadata };\n      }\n    }\n\n    return this.notifyEvent(\n      {\n        exceptions,\n        metadata,\n        severity,\n        onError,\n      },\n      error\n    );\n  }\n\n  leaveBreadcrumb(\n    message: string,\n    metadata?: Record<string, any>,\n    type?: BreadcrumbType\n  ): void {\n    if (!this.config) {\n      // The official bugsnag client will produce a console eror in this case\n      // but that's annoying since often unit tests will exercise code that\n      // calls notify/leaveBreadcrumb and we don't want to have to either:\n      //\n      // (a) wrap each call to bugsnag in an \"isTest\" conditional, or\n      // (b) ensure the bugsnag client is initialized at the start of each\n      //     test\n      return;\n    }\n\n    // It appears we sometimes get non-string `message` values here.\n    if (typeof message !== 'string') {\n      try {\n        message = String(message);\n      } catch {\n        message = 'Unable to stringify breadcrumb message';\n      }\n    }\n\n    if (!message.length) {\n      return;\n    }\n\n    this.breadcrumbs.push({\n      name: message,\n      metaData: metadata,\n      type: type || 'manual',\n      timestamp: new Date().toISOString(),\n    });\n\n    const { maxBreadcrumbs = 25 } = this.config;\n    if (this.breadcrumbs.length > maxBreadcrumbs) {\n      this.breadcrumbs.splice(0, this.breadcrumbs.length - maxBreadcrumbs);\n    }\n  }\n\n  async notifyEvent(\n    {\n      exceptions,\n      unhandled,\n      severity,\n      severityReason,\n      metadata,\n      onError,\n    }: PartialEvent,\n    originalError: unknown\n  ): Promise<void> {\n    if (!this.config) {\n      // The official bugsnag client will produce a console eror in this case\n      // but that's annoying since often unit tests will exercise code that\n      // calls notify/leaveBreadcrumb and we don't want to have to either:\n      //\n      // (a) wrap each call to bugsnag in an \"isTest\" conditional, or\n      // (b) ensure the bugsnag client is initialized at the start of each\n      //     test\n      return;\n    }\n\n    // Check if the current release stage is enabled\n    const releaseStage = this.config.releaseStage || 'production';\n    if (\n      this.config.enabledReleaseStages &&\n      !this.config.enabledReleaseStages.includes(releaseStage)\n    ) {\n      return;\n    }\n\n    const event: BugsnagEvent = {\n      exceptions,\n      breadcrumbs: this.breadcrumbs.length ? this.breadcrumbs : undefined,\n      originalError,\n      unhandled: typeof unhandled !== 'boolean' ? false : unhandled,\n      severity: severity || 'warning',\n      severityReason,\n      user: this.config.user || undefined,\n      app: {\n        releaseStage,\n        version: this.config.appVersion,\n        type:\n          this.config.appType ||\n          (typeof window === 'object' ? 'browser' : 'node'),\n      },\n      device: { time: new Date().toISOString() },\n      metaData: metadata || {},\n    };\n\n    // Error callbacks\n\n    const errorCallbacks = [...this.errorCallbacks];\n    if (onError) {\n      errorCallbacks.push(onError);\n    }\n\n    // Make sure the redact and stringifyValues callbacks come last\n    const sortLast = ['stringifyValues', 'redact'];\n    errorCallbacks.sort((a, b) => {\n      if (sortLast.includes(a.name) && sortLast.includes(b.name)) {\n        return 0;\n      } else if (sortLast.includes(a.name)) {\n        return 1;\n      } else if (sortLast.includes(b.name)) {\n        return -1;\n      } else {\n        return 0;\n      }\n    });\n\n    for (const callback of errorCallbacks) {\n      const callbackResult = await callback(event);\n      if (typeof callbackResult === 'boolean' && !callbackResult) {\n        return;\n      }\n    }\n\n    const notifier: Notifier = {\n      name: '@birchill/bugsnag-zero',\n      version: '1',\n      url: 'https://github.com/birchill/bugsnag-zero',\n    };\n\n    const eventForDelivery = safeFilter(\n      event,\n      (key, value) => {\n        if (key === 'originalError') {\n          return undefined;\n        }\n        return value;\n      },\n      { depthLimit: 20, edgesLimit: 500 }\n    ) as EventForDelivery;\n\n    let body: string;\n    const payload = {\n      apiKey: this.config.apiKey,\n      payloadVersion: '5',\n      notifier,\n      events: [eventForDelivery],\n    };\n\n    try {\n      body = JSON.stringify(payload);\n    } catch {\n      eventForDelivery.metaData = {\n        notifier: 'Unable to serialize metadata',\n      };\n\n      body = JSON.stringify(payload);\n    }\n\n    // Check the size of the payload\n    if (body.length > 10e5) {\n      eventForDelivery.metaData = {\n        notifier: `Payload was ${body.length / 10e5}Mb. Metadata removed.`,\n      };\n      body = JSON.stringify(payload);\n      if (body.length > 10e5) {\n        throw new Error('Payload exceeded 1Mb limit');\n      }\n    }\n\n    // Although it's called \"post error\" we run these callbacks before we\n    // actually send the event over the network since sending is async and if\n    // the callback is logging the fact that an error was recorded then we want\n    // that log entry to appear in the correct sequence, particularly if other\n    // things take place while the fetch is still happenning.\n    for (const callback of this.postErrorCallbacks) {\n      callback(event);\n    }\n\n    try {\n      await this.delivery.sendEvent(payload);\n    } catch (e) {\n      console.error('Failed to post report to Bugsnag', e);\n    }\n  }\n\n  getUser(): User {\n    return this.config?.user || {};\n  }\n\n  setUser(id?: string, email?: string, name?: string): void {\n    if (!this.config) {\n      return;\n    }\n\n    this.config.user = { id, email, name };\n  }\n\n  addOnError(fn: OnErrorCallback): void {\n    this.errorCallbacks.add(fn);\n  }\n\n  removeOnError(fn: OnErrorCallback): void {\n    this.errorCallbacks.delete(fn);\n  }\n\n  addOnPostError(fn: OnPostErrorCallback): void {\n    this.postErrorCallbacks.add(fn);\n  }\n\n  removeOnPostError(fn: OnPostErrorCallback): void {\n    this.postErrorCallbacks.delete(fn);\n  }\n\n  getPlugin(name: string): unknown {\n    return this.plugins.find((plugin) => plugin.name === name)?.plugin;\n  }\n\n  setDelivery(delivery: Delivery) {\n    this.delivery = delivery;\n  }\n}\n\nconst Bugsnag = new BugsnagStatic();\n\nexport default Bugsnag;\nexport {\n  Client,\n  Delivery,\n  ExtendedClientApi,\n  NotifiableError,\n  Plugin,\n} from './client';\nexport { Config } from './config';\nexport { fromLegacyConfig, LegacyConfig } from './legacy-config';\nexport { BugsnagEvent as Event } from './event';\nexport { Notifier } from './notifier';\n\n// Breadcrumb loggers\nexport { consoleBreadcrumbs } from './console-breadcrumbs';\nexport { errorBreadcrumbs } from './error-breadcrumbs';\nexport { fetchBreadcrumbs } from './fetch-breadcrumbs';\nexport { interactionBreadcrumbs } from './interaction-breadcrumbs';\nexport { navigationBreadcrumbs } from './navigation-breadcrumbs';\nexport { browserHandledRejectionBreadcrumbs } from './browser-handled-rejection-breadcrumbs';\n\n// Error notifiers\nexport { browserNotifyUnhandledExceptions } from './browser-unhandled-exceptions';\nexport { browserNotifyUnhandledRejections } from './browser-unhandled-rejections';\nexport { nodeNotifyUnhandledRejections } from './node-unhandled-rejections';\nexport { nodeNotifyUnhandledExceptions } from './node-unhandled-exceptions';\n\n// Other plugins\nexport { appDuration } from './app-duration';\nexport {\n  browserContext,\n  browserContextWithUaParser,\n  UserAgentParserFn,\n  UserAgentInfo,\n} from './browser-context';\nexport { deviceOrientation } from './deviceorientation';\nexport { limitEvents } from './limit-events';\nexport {\n  ReactPlugin,\n  ReactPluginResult,\n  ErrorBoundaryProps,\n  FallbackComponentProps,\n} from './react';\nexport {\n  redactEvent,\n  redactKeys,\n  RedactKeysPluginResult,\n  redactObject,\n} from './redact-keys';\nexport { stringifyValues } from './stringify-values';\n\n// Delivery plugins\nexport { FetchDelivery } from './fetch-delivery';\n\ninterface BugsnagStatic {\n  getPlugin(id: 'react'): import('./react').ReactPluginResult | undefined;\n  getPlugin(\n    id: 'redactKeys'\n  ): import('./redact-keys').RedactKeysPluginResult | undefined;\n  getPlugin(\n    id: 'lambdaContext'\n  ): import('./lambda-context').LambdaContextPlugin | undefined;\n  getPlugin(id: string): unknown;\n}\n","/**\n * A `StructFailure` represents a single specific failure in validation.\n */\n/**\n * `StructError` objects are thrown (or returned) when validation fails.\n *\n * Validation logic is design to exit early for maximum performance. The error\n * represents the first error encountered during validation. For more detail,\n * the `error.failures` property is a generator function that can be run to\n * continue validation and receive all the failures in the data.\n */\nclass StructError extends TypeError {\n    constructor(failure, failures) {\n        let cached;\n        const { message, explanation, ...rest } = failure;\n        const { path } = failure;\n        const msg = path.length === 0 ? message : `At path: ${path.join('.')} -- ${message}`;\n        super(explanation ?? msg);\n        if (explanation != null)\n            this.cause = msg;\n        Object.assign(this, rest);\n        this.name = this.constructor.name;\n        this.failures = () => {\n            return (cached ?? (cached = [failure, ...failures()]));\n        };\n    }\n}\n\n/**\n * Check if a value is an iterator.\n */\nfunction isIterable(x) {\n    return isObject(x) && typeof x[Symbol.iterator] === 'function';\n}\n/**\n * Check if a value is a plain object.\n */\nfunction isObject(x) {\n    return typeof x === 'object' && x != null;\n}\n/**\n * Check if a value is a non-array object.\n */\nfunction isNonArrayObject(x) {\n    return isObject(x) && !Array.isArray(x);\n}\n/**\n * Check if a value is a plain object.\n */\nfunction isPlainObject(x) {\n    if (Object.prototype.toString.call(x) !== '[object Object]') {\n        return false;\n    }\n    const prototype = Object.getPrototypeOf(x);\n    return prototype === null || prototype === Object.prototype;\n}\n/**\n * Return a value as a printable string.\n */\nfunction print(value) {\n    if (typeof value === 'symbol') {\n        return value.toString();\n    }\n    return typeof value === 'string' ? JSON.stringify(value) : `${value}`;\n}\n/**\n * Shifts (removes and returns) the first value from the `input` iterator.\n * Like `Array.prototype.shift()` but for an `Iterator`.\n */\nfunction shiftIterator(input) {\n    const { done, value } = input.next();\n    return done ? undefined : value;\n}\n/**\n * Convert a single validation result to a failure.\n */\nfunction toFailure(result, context, struct, value) {\n    if (result === true) {\n        return;\n    }\n    else if (result === false) {\n        result = {};\n    }\n    else if (typeof result === 'string') {\n        result = { message: result };\n    }\n    const { path, branch } = context;\n    const { type } = struct;\n    const { refinement, message = `Expected a value of type \\`${type}\\`${refinement ? ` with refinement \\`${refinement}\\`` : ''}, but received: \\`${print(value)}\\``, } = result;\n    return {\n        value,\n        type,\n        refinement,\n        key: path[path.length - 1],\n        path,\n        branch,\n        ...result,\n        message,\n    };\n}\n/**\n * Convert a validation result to an iterable of failures.\n */\nfunction* toFailures(result, context, struct, value) {\n    if (!isIterable(result)) {\n        result = [result];\n    }\n    for (const r of result) {\n        const failure = toFailure(r, context, struct, value);\n        if (failure) {\n            yield failure;\n        }\n    }\n}\n/**\n * Check a value against a struct, traversing deeply into nested values, and\n * returning an iterator of failures or success.\n */\nfunction* run(value, struct, options = {}) {\n    const { path = [], branch = [value], coerce = false, mask = false } = options;\n    const ctx = { path, branch, mask };\n    if (coerce) {\n        value = struct.coercer(value, ctx);\n    }\n    let status = 'valid';\n    for (const failure of struct.validator(value, ctx)) {\n        failure.explanation = options.message;\n        status = 'not_valid';\n        yield [failure, undefined];\n    }\n    for (let [k, v, s] of struct.entries(value, ctx)) {\n        const ts = run(v, s, {\n            path: k === undefined ? path : [...path, k],\n            branch: k === undefined ? branch : [...branch, v],\n            coerce,\n            mask,\n            message: options.message,\n        });\n        for (const t of ts) {\n            if (t[0]) {\n                status = t[0].refinement != null ? 'not_refined' : 'not_valid';\n                yield [t[0], undefined];\n            }\n            else if (coerce) {\n                v = t[1];\n                if (k === undefined) {\n                    value = v;\n                }\n                else if (value instanceof Map) {\n                    value.set(k, v);\n                }\n                else if (value instanceof Set) {\n                    value.add(v);\n                }\n                else if (isObject(value)) {\n                    if (v !== undefined || k in value)\n                        value[k] = v;\n                }\n            }\n        }\n    }\n    if (status !== 'not_valid') {\n        for (const failure of struct.refiner(value, ctx)) {\n            failure.explanation = options.message;\n            status = 'not_refined';\n            yield [failure, undefined];\n        }\n    }\n    if (status === 'valid') {\n        yield [undefined, value];\n    }\n}\n\n/**\n * `Struct` objects encapsulate the validation logic for a specific type of\n * values. Once constructed, you use the `assert`, `is` or `validate` helpers to\n * validate unknown input data against the struct.\n */\nclass Struct {\n    constructor(props) {\n        const { type, schema, validator, refiner, coercer = (value) => value, entries = function* () { }, } = props;\n        this.type = type;\n        this.schema = schema;\n        this.entries = entries;\n        this.coercer = coercer;\n        if (validator) {\n            this.validator = (value, context) => {\n                const result = validator(value, context);\n                return toFailures(result, context, this, value);\n            };\n        }\n        else {\n            this.validator = () => [];\n        }\n        if (refiner) {\n            this.refiner = (value, context) => {\n                const result = refiner(value, context);\n                return toFailures(result, context, this, value);\n            };\n        }\n        else {\n            this.refiner = () => [];\n        }\n    }\n    /**\n     * Assert that a value passes the struct's validation, throwing if it doesn't.\n     */\n    assert(value, message) {\n        return assert(value, this, message);\n    }\n    /**\n     * Create a value with the struct's coercion logic, then validate it.\n     */\n    create(value, message) {\n        return create(value, this, message);\n    }\n    /**\n     * Check if a value passes the struct's validation.\n     */\n    is(value) {\n        return is(value, this);\n    }\n    /**\n     * Mask a value, coercing and validating it, but returning only the subset of\n     * properties defined by the struct's schema. Masking applies recursively to\n     * props of `object` structs only.\n     */\n    mask(value, message) {\n        return mask(value, this, message);\n    }\n    /**\n     * Validate a value with the struct's validation logic, returning a tuple\n     * representing the result.\n     *\n     * You may optionally pass `true` for the `coerce` argument to coerce\n     * the value before attempting to validate it. If you do, the result will\n     * contain the coerced result when successful. Also, `mask` will turn on\n     * masking of the unknown `object` props recursively if passed.\n     */\n    validate(value, options = {}) {\n        return validate(value, this, options);\n    }\n}\n/**\n * Assert that a value passes a struct, throwing if it doesn't.\n */\nfunction assert(value, struct, message) {\n    const result = validate(value, struct, { message });\n    if (result[0]) {\n        throw result[0];\n    }\n}\n/**\n * Create a value with the coercion logic of struct and validate it.\n */\nfunction create(value, struct, message) {\n    const result = validate(value, struct, { coerce: true, message });\n    if (result[0]) {\n        throw result[0];\n    }\n    else {\n        return result[1];\n    }\n}\n/**\n * Mask a value, returning only the subset of properties defined by a struct.\n */\nfunction mask(value, struct, message) {\n    const result = validate(value, struct, { coerce: true, mask: true, message });\n    if (result[0]) {\n        throw result[0];\n    }\n    else {\n        return result[1];\n    }\n}\n/**\n * Check if a value passes a struct.\n */\nfunction is(value, struct) {\n    const result = validate(value, struct);\n    return !result[0];\n}\n/**\n * Validate a value against a struct, returning an error if invalid, or the\n * value (with potential coercion) if valid.\n */\nfunction validate(value, struct, options = {}) {\n    const tuples = run(value, struct, options);\n    const tuple = shiftIterator(tuples);\n    if (tuple[0]) {\n        const error = new StructError(tuple[0], function* () {\n            for (const t of tuples) {\n                if (t[0]) {\n                    yield t[0];\n                }\n            }\n        });\n        return [error, undefined];\n    }\n    else {\n        const v = tuple[1];\n        return [undefined, v];\n    }\n}\n\nfunction assign(...Structs) {\n    const isType = Structs[0].type === 'type';\n    const schemas = Structs.map((s) => s.schema);\n    const schema = Object.assign({}, ...schemas);\n    return isType ? type(schema) : object(schema);\n}\n/**\n * Define a new struct type with a custom validation function.\n */\nfunction define(name, validator) {\n    return new Struct({ type: name, schema: null, validator });\n}\n/**\n * Create a new struct based on an existing struct, but the value is allowed to\n * be `undefined`. `log` will be called if the value is not `undefined`.\n */\nfunction deprecated(struct, log) {\n    return new Struct({\n        ...struct,\n        refiner: (value, ctx) => value === undefined || struct.refiner(value, ctx),\n        validator(value, ctx) {\n            if (value === undefined) {\n                return true;\n            }\n            else {\n                log(value, ctx);\n                return struct.validator(value, ctx);\n            }\n        },\n    });\n}\n/**\n * Create a struct with dynamic validation logic.\n *\n * The callback will receive the value currently being validated, and must\n * return a struct object to validate it with. This can be useful to model\n * validation logic that changes based on its input.\n */\nfunction dynamic(fn) {\n    return new Struct({\n        type: 'dynamic',\n        schema: null,\n        *entries(value, ctx) {\n            const struct = fn(value, ctx);\n            yield* struct.entries(value, ctx);\n        },\n        validator(value, ctx) {\n            const struct = fn(value, ctx);\n            return struct.validator(value, ctx);\n        },\n        coercer(value, ctx) {\n            const struct = fn(value, ctx);\n            return struct.coercer(value, ctx);\n        },\n        refiner(value, ctx) {\n            const struct = fn(value, ctx);\n            return struct.refiner(value, ctx);\n        },\n    });\n}\n/**\n * Create a struct with lazily evaluated validation logic.\n *\n * The first time validation is run with the struct, the callback will be called\n * and must return a struct object to use. This is useful for cases where you\n * want to have self-referential structs for nested data structures to avoid a\n * circular definition problem.\n */\nfunction lazy(fn) {\n    let struct;\n    return new Struct({\n        type: 'lazy',\n        schema: null,\n        *entries(value, ctx) {\n            struct ?? (struct = fn());\n            yield* struct.entries(value, ctx);\n        },\n        validator(value, ctx) {\n            struct ?? (struct = fn());\n            return struct.validator(value, ctx);\n        },\n        coercer(value, ctx) {\n            struct ?? (struct = fn());\n            return struct.coercer(value, ctx);\n        },\n        refiner(value, ctx) {\n            struct ?? (struct = fn());\n            return struct.refiner(value, ctx);\n        },\n    });\n}\n/**\n * Create a new struct based on an existing object struct, but excluding\n * specific properties.\n *\n * Like TypeScript's `Omit` utility.\n */\nfunction omit(struct, keys) {\n    const { schema } = struct;\n    const subschema = { ...schema };\n    for (const key of keys) {\n        delete subschema[key];\n    }\n    switch (struct.type) {\n        case 'type':\n            return type(subschema);\n        default:\n            return object(subschema);\n    }\n}\n/**\n * Create a new struct based on an existing object struct, but with all of its\n * properties allowed to be `undefined`.\n *\n * Like TypeScript's `Partial` utility.\n */\nfunction partial(struct) {\n    const isStruct = struct instanceof Struct;\n    const schema = isStruct ? { ...struct.schema } : { ...struct };\n    for (const key in schema) {\n        schema[key] = optional(schema[key]);\n    }\n    if (isStruct && struct.type === 'type') {\n        return type(schema);\n    }\n    return object(schema);\n}\n/**\n * Create a new struct based on an existing object struct, but only including\n * specific properties.\n *\n * Like TypeScript's `Pick` utility.\n */\nfunction pick(struct, keys) {\n    const { schema } = struct;\n    const subschema = {};\n    for (const key of keys) {\n        subschema[key] = schema[key];\n    }\n    switch (struct.type) {\n        case 'type':\n            return type(subschema);\n        default:\n            return object(subschema);\n    }\n}\n/**\n * Define a new struct type with a custom validation function.\n *\n * @deprecated This function has been renamed to `define`.\n */\nfunction struct(name, validator) {\n    console.warn('superstruct@0.11 - The `struct` helper has been renamed to `define`.');\n    return define(name, validator);\n}\n\n/**\n * Ensure that any value passes validation.\n */\nfunction any() {\n    return define('any', () => true);\n}\nfunction array(Element) {\n    return new Struct({\n        type: 'array',\n        schema: Element,\n        *entries(value) {\n            if (Element && Array.isArray(value)) {\n                for (const [i, v] of value.entries()) {\n                    yield [i, v, Element];\n                }\n            }\n        },\n        coercer(value) {\n            return Array.isArray(value) ? value.slice() : value;\n        },\n        validator(value) {\n            return (Array.isArray(value) ||\n                `Expected an array value, but received: ${print(value)}`);\n        },\n    });\n}\n/**\n * Ensure that a value is a bigint.\n */\nfunction bigint() {\n    return define('bigint', (value) => {\n        return typeof value === 'bigint';\n    });\n}\n/**\n * Ensure that a value is a boolean.\n */\nfunction boolean() {\n    return define('boolean', (value) => {\n        return typeof value === 'boolean';\n    });\n}\n/**\n * Ensure that a value is a valid `Date`.\n *\n * Note: this also ensures that the value is *not* an invalid `Date` object,\n * which can occur when parsing a date fails but still returns a `Date`.\n */\nfunction date() {\n    return define('date', (value) => {\n        return ((value instanceof Date && !isNaN(value.getTime())) ||\n            `Expected a valid \\`Date\\` object, but received: ${print(value)}`);\n    });\n}\nfunction enums(values) {\n    const schema = {};\n    const description = values.map((v) => print(v)).join();\n    for (const key of values) {\n        schema[key] = key;\n    }\n    return new Struct({\n        type: 'enums',\n        schema,\n        validator(value) {\n            return (values.includes(value) ||\n                `Expected one of \\`${description}\\`, but received: ${print(value)}`);\n        },\n    });\n}\n/**\n * Ensure that a value is a function.\n */\nfunction func() {\n    return define('func', (value) => {\n        return (typeof value === 'function' ||\n            `Expected a function, but received: ${print(value)}`);\n    });\n}\n/**\n * Ensure that a value is an instance of a specific class.\n */\nfunction instance(Class) {\n    return define('instance', (value) => {\n        return (value instanceof Class ||\n            `Expected a \\`${Class.name}\\` instance, but received: ${print(value)}`);\n    });\n}\n/**\n * Ensure that a value is an integer.\n */\nfunction integer() {\n    return define('integer', (value) => {\n        return ((typeof value === 'number' && !isNaN(value) && Number.isInteger(value)) ||\n            `Expected an integer, but received: ${print(value)}`);\n    });\n}\n/**\n * Ensure that a value matches all of a set of types.\n */\nfunction intersection(Structs) {\n    return new Struct({\n        type: 'intersection',\n        schema: null,\n        *entries(value, ctx) {\n            for (const S of Structs) {\n                yield* S.entries(value, ctx);\n            }\n        },\n        *validator(value, ctx) {\n            for (const S of Structs) {\n                yield* S.validator(value, ctx);\n            }\n        },\n        *refiner(value, ctx) {\n            for (const S of Structs) {\n                yield* S.refiner(value, ctx);\n            }\n        },\n    });\n}\nfunction literal(constant) {\n    const description = print(constant);\n    const t = typeof constant;\n    return new Struct({\n        type: 'literal',\n        schema: t === 'string' || t === 'number' || t === 'boolean' ? constant : null,\n        validator(value) {\n            return (value === constant ||\n                `Expected the literal \\`${description}\\`, but received: ${print(value)}`);\n        },\n    });\n}\nfunction map(Key, Value) {\n    return new Struct({\n        type: 'map',\n        schema: null,\n        *entries(value) {\n            if (Key && Value && value instanceof Map) {\n                for (const [k, v] of value.entries()) {\n                    yield [k, k, Key];\n                    yield [k, v, Value];\n                }\n            }\n        },\n        coercer(value) {\n            return value instanceof Map ? new Map(value) : value;\n        },\n        validator(value) {\n            return (value instanceof Map ||\n                `Expected a \\`Map\\` object, but received: ${print(value)}`);\n        },\n    });\n}\n/**\n * Ensure that no value ever passes validation.\n */\nfunction never() {\n    return define('never', () => false);\n}\n/**\n * Augment an existing struct to allow `null` values.\n */\nfunction nullable(struct) {\n    return new Struct({\n        ...struct,\n        validator: (value, ctx) => value === null || struct.validator(value, ctx),\n        refiner: (value, ctx) => value === null || struct.refiner(value, ctx),\n    });\n}\n/**\n * Ensure that a value is a number.\n */\nfunction number() {\n    return define('number', (value) => {\n        return ((typeof value === 'number' && !isNaN(value)) ||\n            `Expected a number, but received: ${print(value)}`);\n    });\n}\nfunction object(schema) {\n    const knowns = schema ? Object.keys(schema) : [];\n    const Never = never();\n    return new Struct({\n        type: 'object',\n        schema: schema ? schema : null,\n        *entries(value) {\n            if (schema && isObject(value)) {\n                const unknowns = new Set(Object.keys(value));\n                for (const key of knowns) {\n                    unknowns.delete(key);\n                    yield [key, value[key], schema[key]];\n                }\n                for (const key of unknowns) {\n                    yield [key, value[key], Never];\n                }\n            }\n        },\n        validator(value) {\n            return (isNonArrayObject(value) ||\n                `Expected an object, but received: ${print(value)}`);\n        },\n        coercer(value, ctx) {\n            if (!isNonArrayObject(value)) {\n                return value;\n            }\n            const coerced = { ...value };\n            // The `object` struct has special behaviour enabled by the mask flag.\n            // When masking, properties that are not in the schema are deleted from\n            // the coerced object instead of eventually failing validaiton.\n            if (ctx.mask && schema) {\n                for (const key in coerced) {\n                    if (schema[key] === undefined) {\n                        delete coerced[key];\n                    }\n                }\n            }\n            return coerced;\n        },\n    });\n}\n/**\n * Augment a struct to allow `undefined` values.\n */\nfunction optional(struct) {\n    return new Struct({\n        ...struct,\n        validator: (value, ctx) => value === undefined || struct.validator(value, ctx),\n        refiner: (value, ctx) => value === undefined || struct.refiner(value, ctx),\n    });\n}\n/**\n * Ensure that a value is an object with keys and values of specific types, but\n * without ensuring any specific shape of properties.\n *\n * Like TypeScript's `Record` utility.\n */\nfunction record(Key, Value) {\n    return new Struct({\n        type: 'record',\n        schema: null,\n        *entries(value) {\n            if (isObject(value)) {\n                for (const k in value) {\n                    const v = value[k];\n                    yield [k, k, Key];\n                    yield [k, v, Value];\n                }\n            }\n        },\n        validator(value) {\n            return (isNonArrayObject(value) ||\n                `Expected an object, but received: ${print(value)}`);\n        },\n        coercer(value) {\n            return isNonArrayObject(value) ? { ...value } : value;\n        },\n    });\n}\n/**\n * Ensure that a value is a `RegExp`.\n *\n * Note: this does not test the value against the regular expression! For that\n * you need to use the `pattern()` refinement.\n */\nfunction regexp() {\n    return define('regexp', (value) => {\n        return value instanceof RegExp;\n    });\n}\nfunction set(Element) {\n    return new Struct({\n        type: 'set',\n        schema: null,\n        *entries(value) {\n            if (Element && value instanceof Set) {\n                for (const v of value) {\n                    yield [v, v, Element];\n                }\n            }\n        },\n        coercer(value) {\n            return value instanceof Set ? new Set(value) : value;\n        },\n        validator(value) {\n            return (value instanceof Set ||\n                `Expected a \\`Set\\` object, but received: ${print(value)}`);\n        },\n    });\n}\n/**\n * Ensure that a value is a string.\n */\nfunction string() {\n    return define('string', (value) => {\n        return (typeof value === 'string' ||\n            `Expected a string, but received: ${print(value)}`);\n    });\n}\n/**\n * Ensure that a value is a tuple of a specific length, and that each of its\n * elements is of a specific type.\n */\nfunction tuple(Structs) {\n    const Never = never();\n    return new Struct({\n        type: 'tuple',\n        schema: null,\n        *entries(value) {\n            if (Array.isArray(value)) {\n                const length = Math.max(Structs.length, value.length);\n                for (let i = 0; i < length; i++) {\n                    yield [i, value[i], Structs[i] || Never];\n                }\n            }\n        },\n        validator(value) {\n            return (Array.isArray(value) ||\n                `Expected an array, but received: ${print(value)}`);\n        },\n        coercer(value) {\n            return Array.isArray(value) ? value.slice() : value;\n        },\n    });\n}\n/**\n * Ensure that a value has a set of known properties of specific types.\n *\n * Note: Unrecognized properties are allowed and untouched. This is similar to\n * how TypeScript's structural typing works.\n */\nfunction type(schema) {\n    const keys = Object.keys(schema);\n    return new Struct({\n        type: 'type',\n        schema,\n        *entries(value) {\n            if (isObject(value)) {\n                for (const k of keys) {\n                    yield [k, value[k], schema[k]];\n                }\n            }\n        },\n        validator(value) {\n            return (isNonArrayObject(value) ||\n                `Expected an object, but received: ${print(value)}`);\n        },\n        coercer(value) {\n            return isNonArrayObject(value) ? { ...value } : value;\n        },\n    });\n}\n/**\n * Ensure that a value matches one of a set of types.\n */\nfunction union(Structs) {\n    const description = Structs.map((s) => s.type).join(' | ');\n    return new Struct({\n        type: 'union',\n        schema: null,\n        coercer(value, ctx) {\n            for (const S of Structs) {\n                const [error, coerced] = S.validate(value, {\n                    coerce: true,\n                    mask: ctx.mask,\n                });\n                if (!error) {\n                    return coerced;\n                }\n            }\n            return value;\n        },\n        validator(value, ctx) {\n            const failures = [];\n            for (const S of Structs) {\n                const [...tuples] = run(value, S, ctx);\n                const [first] = tuples;\n                if (!first[0]) {\n                    return [];\n                }\n                else {\n                    for (const [failure] of tuples) {\n                        if (failure) {\n                            failures.push(failure);\n                        }\n                    }\n                }\n            }\n            return [\n                `Expected the value to satisfy a union of \\`${description}\\`, but received: ${print(value)}`,\n                ...failures,\n            ];\n        },\n    });\n}\n/**\n * Ensure that any value passes validation, without widening its type to `any`.\n */\nfunction unknown() {\n    return define('unknown', () => true);\n}\n\n/**\n * Augment a `Struct` to add an additional coercion step to its input.\n *\n * This allows you to transform input data before validating it, to increase the\n * likelihood that it passes validationfor example for default values, parsing\n * different formats, etc.\n *\n * Note: You must use `create(value, Struct)` on the value to have the coercion\n * take effect! Using simply `assert()` or `is()` will not use coercion.\n */\nfunction coerce(struct, condition, coercer) {\n    return new Struct({\n        ...struct,\n        coercer: (value, ctx) => {\n            return is(value, condition)\n                ? struct.coercer(coercer(value, ctx), ctx)\n                : struct.coercer(value, ctx);\n        },\n    });\n}\n/**\n * Augment a struct to replace `undefined` values with a default.\n *\n * Note: You must use `create(value, Struct)` on the value to have the coercion\n * take effect! Using simply `assert()` or `is()` will not use coercion.\n */\nfunction defaulted(struct, fallback, options = {}) {\n    return coerce(struct, unknown(), (x) => {\n        const f = typeof fallback === 'function' ? fallback() : fallback;\n        if (x === undefined) {\n            return f;\n        }\n        if (!options.strict && isPlainObject(x) && isPlainObject(f)) {\n            const ret = { ...x };\n            let changed = false;\n            for (const key in f) {\n                if (ret[key] === undefined) {\n                    ret[key] = f[key];\n                    changed = true;\n                }\n            }\n            if (changed) {\n                return ret;\n            }\n        }\n        return x;\n    });\n}\n/**\n * Augment a struct to trim string inputs.\n *\n * Note: You must use `create(value, Struct)` on the value to have the coercion\n * take effect! Using simply `assert()` or `is()` will not use coercion.\n */\nfunction trimmed(struct) {\n    return coerce(struct, string(), (x) => x.trim());\n}\n\n/**\n * Ensure that a string, array, map, or set is empty.\n */\nfunction empty(struct) {\n    return refine(struct, 'empty', (value) => {\n        const size = getSize(value);\n        return (size === 0 ||\n            `Expected an empty ${struct.type} but received one with a size of \\`${size}\\``);\n    });\n}\nfunction getSize(value) {\n    if (value instanceof Map || value instanceof Set) {\n        return value.size;\n    }\n    else {\n        return value.length;\n    }\n}\n/**\n * Ensure that a number or date is below a threshold.\n */\nfunction max(struct, threshold, options = {}) {\n    const { exclusive } = options;\n    return refine(struct, 'max', (value) => {\n        return exclusive\n            ? value < threshold\n            : value <= threshold ||\n                `Expected a ${struct.type} less than ${exclusive ? '' : 'or equal to '}${threshold} but received \\`${value}\\``;\n    });\n}\n/**\n * Ensure that a number or date is above a threshold.\n */\nfunction min(struct, threshold, options = {}) {\n    const { exclusive } = options;\n    return refine(struct, 'min', (value) => {\n        return exclusive\n            ? value > threshold\n            : value >= threshold ||\n                `Expected a ${struct.type} greater than ${exclusive ? '' : 'or equal to '}${threshold} but received \\`${value}\\``;\n    });\n}\n/**\n * Ensure that a string, array, map or set is not empty.\n */\nfunction nonempty(struct) {\n    return refine(struct, 'nonempty', (value) => {\n        const size = getSize(value);\n        return (size > 0 || `Expected a nonempty ${struct.type} but received an empty one`);\n    });\n}\n/**\n * Ensure that a string matches a regular expression.\n */\nfunction pattern(struct, regexp) {\n    return refine(struct, 'pattern', (value) => {\n        return (regexp.test(value) ||\n            `Expected a ${struct.type} matching \\`/${regexp.source}/\\` but received \"${value}\"`);\n    });\n}\n/**\n * Ensure that a string, array, number, date, map, or set has a size (or length, or time) between `min` and `max`.\n */\nfunction size(struct, min, max = min) {\n    const expected = `Expected a ${struct.type}`;\n    const of = min === max ? `of \\`${min}\\`` : `between \\`${min}\\` and \\`${max}\\``;\n    return refine(struct, 'size', (value) => {\n        if (typeof value === 'number' || value instanceof Date) {\n            return ((min <= value && value <= max) ||\n                `${expected} ${of} but received \\`${value}\\``);\n        }\n        else if (value instanceof Map || value instanceof Set) {\n            const { size } = value;\n            return ((min <= size && size <= max) ||\n                `${expected} with a size ${of} but received one with a size of \\`${size}\\``);\n        }\n        else {\n            const { length } = value;\n            return ((min <= length && length <= max) ||\n                `${expected} with a length ${of} but received one with a length of \\`${length}\\``);\n        }\n    });\n}\n/**\n * Augment a `Struct` to add an additional refinement to the validation.\n *\n * The refiner function is guaranteed to receive a value of the struct's type,\n * because the struct's existing validation will already have passed. This\n * allows you to layer additional validation on top of existing structs.\n */\nfunction refine(struct, name, refiner) {\n    return new Struct({\n        ...struct,\n        *refiner(value, ctx) {\n            yield* struct.refiner(value, ctx);\n            const result = refiner(value, ctx);\n            const failures = toFailures(result, ctx, struct, value);\n            for (const failure of failures) {\n                yield { ...failure, refinement: name };\n            }\n        },\n    });\n}\n\nexport { Struct, StructError, any, array, assert, assign, bigint, boolean, coerce, create, date, defaulted, define, deprecated, dynamic, empty, enums, func, instance, integer, intersection, is, lazy, literal, map, mask, max, min, never, nonempty, nullable, number, object, omit, optional, partial, pattern, pick, record, refine, regexp, set, size, string, struct, trimmed, tuple, type, union, unknown, validate };\n//# sourceMappingURL=index.mjs.map\n","import Bugsnag from '@birchill/bugsnag-zero';\nimport * as s from 'superstruct';\nimport browser from 'webextension-polyfill';\n\nconst FxLocalDataSchema = s.type({\n  timestamp: s.min(s.integer(), 0),\n  rates: s.record(s.string(), s.number()),\n  updated: s.min(s.integer(), 0),\n});\n\nexport type FxLocalData = s.Infer<typeof FxLocalDataSchema>;\n\nexport async function getLocalFxData(\n  onUpdate?: (data: FxLocalData) => void\n): Promise<FxLocalData | undefined> {\n  if (onUpdate) {\n    browser.storage.onChanged.addListener(getStorageChangeCallback(onUpdate));\n  }\n\n  try {\n    const fxData = (await browser.storage.local.get('fx'))?.fx;\n    if (!fxData) {\n      return undefined;\n    }\n    const [error, validated] = s.validate(fxData, FxLocalDataSchema);\n\n    if (validated) {\n      return validated;\n    } else {\n      void Bugsnag.notify(error, { severity: 'warning' });\n    }\n  } catch {\n    console.warn('Failed to get fx data from storage');\n  }\n\n  return undefined;\n}\n\nfunction getStorageChangeCallback(onChange: (data: FxLocalData) => void) {\n  return (\n    changes: Record<string, { oldValue?: unknown; newValue?: unknown }>,\n    areaName: string\n  ) => {\n    if (areaName !== 'local') {\n      return;\n    }\n\n    if ('fx' in changes) {\n      const [error, validated] = s.validate(\n        changes.fx.newValue,\n        FxLocalDataSchema\n      );\n\n      if (validated) {\n        onChange(validated);\n      } else {\n        void Bugsnag.notify(error, { severity: 'warning' });\n      }\n    }\n  };\n}\n","export function isObject(a: unknown): a is Record<string, any> {\n  return typeof a === 'object' && a !== null && !Array.isArray(a);\n}\n","/**\n * A helper to strip certain fields from an object.\n */\nexport function stripFields<T, K extends keyof T>(\n  o: T,\n  fields: K[]\n): Omit<T, K> {\n  const result: Partial<T> = { ...o };\n  for (const field of fields) {\n    delete result[field];\n  }\n  return result as Omit<T, K>;\n}\n","export function isFirefox(): boolean {\n  return navigator.userAgent.indexOf('Firefox/') !== -1;\n}\n\nexport function isFenix(): boolean {\n  return isFirefox() && navigator.userAgent.indexOf('Android') !== -1;\n}\n\nexport function isChromium(): boolean {\n  return (\n    navigator.userAgent.indexOf('Chrome/') !== -1 ||\n    navigator.userAgent.indexOf('Chromium/') !== -1\n  );\n}\n\nexport function isEdge(): boolean {\n  return navigator.userAgent.indexOf('Edg/') !== -1;\n}\n\nexport function isSafari(): boolean {\n  return navigator.userAgent.indexOf('Safari/') !== -1 && !isChromium();\n}\n\nexport function isMac(): boolean {\n  return /^Mac/i.test(navigator.platform);\n}\n\nexport function isIOS(): boolean {\n  return (\n    [\n      'iPad Simulator',\n      'iPhone Simulator',\n      'iPod Simulator',\n      'iPad',\n      'iPhone',\n      'iPod',\n    ].includes(navigator.platform) ||\n    // iPad on iOS 13 detection\n    (navigator.userAgent.includes('Mac') && 'ontouchend' in document)\n  );\n}\n\n/** @public */\nexport function isThunderbird(): boolean {\n  return navigator.userAgent.indexOf('Thunderbird/') !== -1;\n}\n","export const dbLanguages = [\n  'de',\n  'en',\n  'es',\n  'fr',\n  'hu',\n  'nl',\n  'pt',\n  'ru',\n  'sl',\n  'sv',\n] as const;\n\nexport type DbLanguageId = (typeof dbLanguages)[number];\n\nexport const dbLanguageMeta: Array<\n  [DbLanguageId, { name: string; hasKanji?: boolean; hasWords?: boolean }]\n> = [\n  ['de', { name: 'Deutsch', hasWords: true }],\n  ['en', { name: 'English', hasKanji: true, hasWords: true }],\n  ['es', { name: 'Espaol', hasKanji: true, hasWords: true }],\n  ['fr', { name: 'Franais', hasKanji: true, hasWords: true }],\n  ['hu', { name: 'Magyar', hasWords: true }],\n  ['nl', { name: 'Nederlands', hasWords: true }],\n  ['pt', { name: 'Portugus', hasKanji: true }],\n  ['ru', { name: '', hasWords: true }],\n  ['sl', { name: 'Slovenina', hasWords: true }],\n  ['sv', { name: 'Svenska', hasWords: true }],\n];\n\nexport function isDbLanguageId(id: string): id is DbLanguageId {\n  return dbLanguages.includes(id as DbLanguageId);\n}\n","export class ExtensionStorageError extends Error {\n  key: string;\n  action: 'set' | 'get' | 'remove';\n\n  constructor(\n    { key, action }: { key: string; action: 'set' | 'get' | 'remove' },\n    ...params: any[]\n  ) {\n    super(...params);\n    Object.setPrototypeOf(this, ExtensionStorageError.prototype);\n\n    if (typeof Error.captureStackTrace === 'function') {\n      Error.captureStackTrace(this, ExtensionStorageError);\n    }\n\n    this.name = 'ExtensionStorageError';\n    this.message = `Failed to ${action} '${key}'`;\n    this.key = key;\n    this.action = action;\n  }\n}\n","import { KeyboardKeys } from './content-config-params';\n\n// Although we separate out the keys for moving a pop-up up or down when we\n// report the keys to the content page, we store them as a single setting.\nexport type StoredKeyboardKeys = Omit<\n  KeyboardKeys,\n  'movePopupUp' | 'movePopupDown'\n> & {\n  movePopupDownOrUp: string[];\n};\n\n// A single key description. We use this definition for storing the default keys\n// since it allows storing as an array (so we can determine the order the\n// options are displayed in) and storing a description along with each key.\nexport type KeySetting = {\n  name: keyof StoredKeyboardKeys;\n  keys: string[];\n  enabledKeys: string[];\n  l10nKey: string;\n};\n\nexport const PopupKeys: KeySetting[] = [\n  {\n    name: 'nextDictionary',\n    keys: ['Shift', 'Enter', 'n'],\n    enabledKeys: ['Shift', 'Enter'],\n    l10nKey: 'options_popup_switch_dictionaries',\n  },\n  {\n    name: 'kanjiLookup',\n    keys: ['Shift'],\n    enabledKeys: [],\n    l10nKey: 'options_popup_kanji_lookup',\n  },\n  {\n    name: 'toggleDefinition',\n    keys: ['d'],\n    enabledKeys: [],\n    l10nKey: 'options_popup_toggle_definition',\n  },\n  {\n    name: 'expandPopup',\n    keys: ['x'],\n    enabledKeys: ['x'],\n    l10nKey: 'options_popup_expand_popup',\n  },\n  {\n    name: 'closePopup',\n    keys: ['Esc', 'x'],\n    enabledKeys: ['Esc'],\n    l10nKey: 'options_popup_close_popup',\n  },\n  {\n    name: 'pinPopup',\n    keys: ['Alt', 'Ctrl', 'Space'],\n    enabledKeys: ['Ctrl'],\n    l10nKey: 'options_popup_pin_popup',\n  },\n  {\n    name: 'movePopupDownOrUp',\n    keys: ['j,k'],\n    enabledKeys: [],\n    l10nKey: 'options_popup_move_popup_down_or_up',\n  },\n  {\n    name: 'startCopy',\n    keys: ['c'],\n    enabledKeys: ['c'],\n    l10nKey: 'options_popup_start_copy',\n  },\n];\n","import { DbLanguageId } from './db-languages';\nimport { TranslateFunctionType } from './i18n';\n\nconst SUPPORTED_REFERENCES = [\n  // The radical for the kanji (number and character, from rad field)\n  'radical',\n  // Nelson radical (from rad field)\n  'nelson_r',\n  // Kanji kentei (from misc field)\n  'kk',\n  // WaniKani level (from misc field)\n  'wk',\n  // Pinyin reading\n  'py',\n  // JLPT level (from misc field)\n  'jlpt',\n  // Unicode codepoint (generated)\n  'unicode',\n  // Conning, The Kodansha Kanji Learner's Course\n  'conning',\n  // New Japanese-English Character Dictionary\n  'halpern_njecd',\n  // Learners Dictionary 2nd ed.\n  'halpern_kkld_2ed',\n  // Remembering the Kanji (6th ed.)\n  'heisig6',\n  // A Guide To Remembering Japanese Characters\n  'henshall',\n  // Kanji and Kana (2011 edition)\n  'sh_kk2',\n  // Japanese For Busy People vols I-III\n  'busy_people',\n  // Kanji in Context by Nishiguchi and Kono\n  'kanji_in_context',\n  // the Kodansha Compact Kanji Guide\n  'kodansha_compact',\n  // Yves Maniette's \"Les Kanjis dans la tete\" French adaptation of Heisig\n  // (Only included for lang:fr)\n  'maniette',\n  // \"Classic\" Nelson - Modern Reader's Japanese-English Character Dictionary\n  'nelson_c',\n  // The New Nelson Japanese-English Character Dictionary\n  'nelson_n',\n  // Halpern's SKIP (System of Kanji Indexing by Patterns)\n  'skip',\n  // Descriptor codes for The Kanji Dictionary\n  'sh_desc',\n] as const;\n\nexport type ReferenceAbbreviation = (typeof SUPPORTED_REFERENCES)[number];\n\nexport function getReferencesForLang(lang: DbLanguageId) {\n  if (lang !== 'fr') {\n    return SUPPORTED_REFERENCES.filter((ref) => ref !== 'maniette');\n  }\n  return SUPPORTED_REFERENCES;\n}\n\nconst REFERENCE_ABBREV_MAPPING: {\n  [key: string]: ReferenceAbbreviation;\n} = {\n  CO: 'conning',\n  H: 'halpern_njecd',\n  L: 'heisig6',\n  E: 'henshall',\n  KK: 'kk',\n  DK: 'halpern_kkld_2ed',\n  N: 'nelson_c',\n  NR: 'nelson_r',\n  V: 'nelson_n',\n  P: 'skip',\n  IN: 'sh_kk2',\n  I: 'sh_desc',\n  U: 'unicode',\n  Y: 'py',\n  WK: 'wk',\n} as const;\n\nexport function convertLegacyReference(\n  ref: string\n): ReferenceAbbreviation | undefined {\n  return REFERENCE_ABBREV_MAPPING.hasOwnProperty(ref)\n    ? REFERENCE_ABBREV_MAPPING[ref]\n    : undefined;\n}\n\ntype LocalizedReferences = 'radical' | 'nelson_r' | 'kk' | 'jlpt' | 'unicode';\ntype NotLocalizedReferences = Exclude<\n  ReferenceAbbreviation,\n  LocalizedReferences\n>;\ntype ReferenceLabel = { full: string; short?: string; lang: string };\n\n// Note that when adding or modifying labels here, it is important that the full\n// and short versions sort roughly the same so that they appear to be in\n// alphabetical order in both the popup (where we use the short form) and\n// options page (where we use the long form).\n//\n// We sort by the short label, where available, which enables, for example,\n// showing an initial \"The\" in the long label but still sorting by the short\n// label (which does not include the \"The\"). Such exceptions aside, however, the\n// full and short versions should generally start with the same first few words.\nconst REFERENCE_LABELS: {\n  [key in NotLocalizedReferences]: ReferenceLabel;\n} = {\n  conning: {\n    full: \"Conning - Kodansha Kanji Learner's Course\",\n    short: 'Conning',\n    lang: 'en',\n  },\n  sh_kk2: {\n    full: 'Kanji & Kana (Hadamitzky, Tuttle, 2011)',\n    short: 'Kanji & Kana',\n    lang: 'en',\n  },\n  halpern_njecd: {\n    full: 'Halpern - New Japanese-English Character Dictionary',\n    short: 'Halpern',\n    lang: 'en',\n  },\n  halpern_kkld_2ed: {\n    full: \"Kanji Learner's Dictionary (Halpbern, Kodansha, 2nd ed.)\",\n    short: \"Kanji Learner's Dictionary\",\n    lang: 'en',\n  },\n  heisig6: {\n    full: 'Heisig - Rembering the Kanji (6th ed.)',\n    short: 'Heisig',\n    lang: 'en',\n  },\n  henshall: {\n    full: 'Henshall - A Guide to Remembering Japanese Characters',\n    short: 'Henshall',\n    lang: 'en',\n  },\n  busy_people: { full: 'Japanese for Busy People', lang: 'en' },\n  kanji_in_context: { full: 'Kanji in Context', lang: 'en' },\n  kodansha_compact: {\n    full: 'Compact Kanji Guide (Kodansha)',\n    short: 'Compact Kanji Guide',\n    lang: 'en',\n  },\n  maniette: { full: 'Les Kanjis dans la tete', lang: 'fr' },\n  nelson_c: {\n    full: \"Classic Nelson - Modern Reader's Japanese-English Character Dictionary\",\n    short: 'Classic Nelson',\n    lang: 'en',\n  },\n  nelson_n: {\n    full: 'New Nelson Japanese-English Character Dictionary',\n    short: 'New Nelson',\n    lang: 'en',\n  },\n  py: { full: 'Pinyin', lang: 'en' },\n  skip: { full: 'SKIP', lang: 'en' },\n  sh_desc: {\n    full: 'The Kanji Dictionary (Spahn)',\n    short: 'Kanji Dictionary',\n    lang: 'en',\n  },\n  wk: {\n    full: 'WaniKani level',\n    short: 'WaniKani',\n    lang: 'en',\n  },\n} as const;\n\n// Get an array matching reference abbreviations to suitable names.\n//\n// These two methods return an array, not a map or object, since we try to\n// preserve the same order of references everywhere we present them.\n//\n// For the localized ones (radical, JLPT, kk, unicode), we look up the\n// appropriate string. For the others, we return a fixed string. (This way we\n// keep complete string keys--not concatenated strings--in the source so we can\n// readily determine which strings are in use.)\n\ntype ReferenceAndLabel = { ref: ReferenceAbbreviation } & ReferenceLabel;\n\nexport function getReferenceLabelsForLang(\n  lang: string,\n  t: TranslateFunctionType\n): Array<ReferenceAndLabel> {\n  const result: Array<ReferenceAndLabel> = [];\n\n  for (const ref of SUPPORTED_REFERENCES) {\n    if (lang !== 'fr' && ref === 'maniette') {\n      continue;\n    }\n    result.push({ ref, ...getLabelForReference(ref, t) });\n  }\n\n  // Sort by short version first since this is what will be shown in the pop-up.\n  result.sort((a, b) => (a.short || a.full).localeCompare(b.short || b.full));\n\n  return result;\n}\n\nexport function getSelectedReferenceLabels(\n  selectedRefs: ReadonlyArray<ReferenceAbbreviation>,\n  t: TranslateFunctionType\n): Array<ReferenceAndLabel> {\n  const result: Array<ReferenceAndLabel> = [];\n  const selectedRefsSet = new Set<ReferenceAbbreviation>(selectedRefs);\n\n  for (const ref of SUPPORTED_REFERENCES) {\n    if (!selectedRefsSet.has(ref)) {\n      continue;\n    }\n    result.push({ ref, ...getLabelForReference(ref, t) });\n  }\n\n  // Sort by short version first since this is what will be shown in the pop-up.\n  result.sort((a, b) => (a.short || a.full).localeCompare(b.short || b.full));\n\n  return result;\n}\n\nfunction getLabelForReference(\n  ref: ReferenceAbbreviation,\n  t: TranslateFunctionType\n): ReferenceLabel {\n  const lang = t('lang_tag');\n\n  switch (ref) {\n    case 'radical':\n      return { full: t('ref_label_radical'), lang };\n\n    case 'nelson_r':\n      return { full: t('ref_label_nelson_r'), lang };\n\n    case 'kk':\n      return { full: t('ref_label_kk'), lang };\n\n    case 'jlpt':\n      return { full: t('ref_label_jlpt'), lang };\n\n    case 'py':\n      return { full: t('ref_label_py'), lang };\n\n    case 'unicode':\n      return { full: t('ref_label_unicode'), lang };\n\n    default:\n      return REFERENCE_LABELS[ref];\n  }\n}\n","// This is largely a wrapper about the browser.sync.settings API which provides\n// following important features:\n//\n// * Only options that are explicitly set get saved. (This prevents the\n//   \"FoxClocks problem\" where, when you install the FoxClocks add-on on a new\n//   computer it sets all the settings to their default values before a sync\n//   happens so then all other synchronized computers end up having their\n//   settings reset to their default values.)\n//\n// * Provides a snapshot of all options with their default values filled-in for\n//   passing to the content process.\nimport Bugsnag from '@birchill/bugsnag-zero';\nimport browser from 'webextension-polyfill';\n\nimport { FxLocalData, getLocalFxData } from '../background/fx-data';\nimport { isObject } from '../utils/is-object';\nimport { stripFields } from '../utils/strip-fields';\nimport { isSafari } from '../utils/ua-utils';\n\nimport type {\n  AccentDisplay,\n  AutoExpandableEntry,\n  ContentConfigParams,\n  FontFace,\n  FontSize,\n  HighlightStyle,\n  KeyboardKeys,\n  PartOfSpeechDisplay,\n  TabDisplay,\n} from './content-config-params';\nimport { DbLanguageId, dbLanguages } from './db-languages';\nimport { ExtensionStorageError } from './extension-storage-error';\nimport { PopupKeys, StoredKeyboardKeys } from './popup-keys';\nimport { PuckState } from './puck-state';\nimport {\n  ReferenceAbbreviation,\n  convertLegacyReference,\n  getReferencesForLang,\n} from './refs';\n\n// We represent the set of references that have been turned on as a series\n// of true or false values.\n//\n// It might seem like it's sufficient to just store the _set_ values (or\n// vice-versa) but that complicates matters when we introduce a new reference\n// type or change the default value of an existing reference type. Currently all\n// references as enabled by default, but we may wish to add a new reference type\n// that is disabled by default, or conditionally enabled by default (e.g. if we\n// find data for JLPT Nx levels, we might want to only enable it if the user has\n// already got the existing JLPT data enabled).\n//\n// By recording the references that have actually been changed by the user as\n// being either enabled or disabled we capture the user's intention more\n// accurately. Anything not set should use the default setting.\ntype KanjiReferenceFlagsV2 = { [key in ReferenceAbbreviation]?: boolean };\n\ninterface Settings {\n  accentDisplay?: AccentDisplay;\n  autoExpand?: Array<AutoExpandableEntry>;\n  bunproDisplay?: boolean;\n  contextMenuEnable?: boolean;\n  copyHeadwords?: 'common' | 'regular';\n  copyPos?: 'code' | 'none';\n  copySenses?: 'first' | 'all';\n  dictLang?: DbLanguageId;\n  enableTapLookup?: boolean;\n  fontFace?: FontFace;\n  fontSize?: FontSize;\n  fxCurrency?: string;\n  highlightStyle?: HighlightStyle;\n  holdToShowKeys?: string;\n  holdToShowImageKeys?: string;\n  kanjiReferencesV2?: KanjiReferenceFlagsV2;\n  keys?: Partial<StoredKeyboardKeys>;\n  localSettings?: {\n    canHover?: boolean;\n    popupInteractive?: boolean;\n    showPuck?: 'show' | 'hide';\n    puckState?: PuckState;\n  };\n  noTextHighlight?: boolean;\n  popupStyle?: string;\n  posDisplay?: PartOfSpeechDisplay;\n  preferredUnits?: 'metric' | 'imperial';\n  readingOnly?: boolean;\n  showKanjiComponents?: boolean;\n  showPriority?: boolean;\n  showRomaji?: boolean;\n  tabDisplay?: TabDisplay;\n  toolbarIcon?: 'default' | 'sky';\n  waniKaniVocabDisplay?: 'hide' | 'show-matches';\n}\n\ntype StorageChange = {\n  oldValue?: any;\n  newValue?: any;\n};\ntype ChangeDict = { [field: string]: StorageChange };\nexport type ChangeCallback = (changes: ChangeDict) => void;\n\n// The following references were added to this extension in a later version and\n// so we turn them off by default to avoid overwhelming users with too many\n// references.\nconst OFF_BY_DEFAULT_REFERENCES: Set<ReferenceAbbreviation> = new Set([\n  'busy_people',\n  'kanji_in_context',\n  'kodansha_compact',\n  'maniette',\n  'wk',\n]);\n\nexport class Config {\n  private fxData: FxLocalData | undefined;\n  private settings: Settings = {};\n  private readyPromise: Promise<void>;\n  private changeListeners: ChangeCallback[] = [];\n  private previousDefaultLang: DbLanguageId;\n\n  constructor() {\n    this.readyPromise = this.readSettings().then(async () => {\n      this.fxData = await getLocalFxData(this.onFxDataChange.bind(this));\n    });\n    this.previousDefaultLang = this.getDefaultLang();\n\n    this.onChange = this.onChange.bind(this);\n    browser.storage.onChanged.addListener(this.onChange);\n\n    this.onLanguageChange = this.onLanguageChange.bind(this);\n    self.addEventListener('languagechange', this.onLanguageChange);\n  }\n\n  private async readSettings() {\n    let settings;\n    try {\n      settings = await browser.storage.sync.get(null);\n    } catch {\n      settings = {};\n    }\n    try {\n      settings.localSettings = (\n        await browser.storage.local.get('settings')\n      ).settings;\n    } catch {\n      // Ignore\n    }\n    this.settings = settings;\n    await this.upgradeSettings();\n  }\n\n  private async upgradeSettings() {\n    // If we have old kanji reference settings but not new ones, upgrade them.\n    if (\n      this.settings.hasOwnProperty('kanjiReferences') &&\n      !this.settings.kanjiReferencesV2\n    ) {\n      const newSettings: KanjiReferenceFlagsV2 = {};\n      const existingSettings: { [key: string]: boolean } = (\n        this.settings as any\n      ).kanjiReferences;\n      for (const [ref, enabled] of Object.entries(existingSettings)) {\n        const newRef = convertLegacyReference(ref);\n        if (newRef) {\n          newSettings[newRef] = enabled;\n        }\n      }\n\n      this.settings.kanjiReferencesV2 = newSettings;\n      try {\n        await browser.storage.sync.set({\n          kanjiReferencesV2: newSettings,\n        });\n      } catch {\n        // If we failed to store the upgraded settings that's fine since at\n        // least the in-memory version of the settings has been upgraded.\n        // We'll try upgrading the stored settings next time we're loaded\n        // anyway.\n        console.error('Failed to upgrade kanji references settings');\n      }\n    }\n\n    // If we have old mouse onboarding prefs, drop them\n    if (this.settings.hasOwnProperty('hasDismissedMouseOnboarding')) {\n      try {\n        await browser.storage.sync.remove('hasDismissedMouseOnboarding');\n      } catch {\n        // Ignore\n      }\n    }\n\n    if (\n      this.settings.localSettings?.hasOwnProperty('hasUpgradedFromPreMouse') ||\n      this.settings.localSettings?.hasOwnProperty(\n        'numLookupsWithMouseOnboarding'\n      )\n    ) {\n      const localSettings = { ...this.settings.localSettings };\n      delete (localSettings as Record<string, unknown>).hasUpgradedFromPreMouse;\n      delete (localSettings as Record<string, unknown>)\n        .numLookupsWithMouseOnboarding;\n      this.settings.localSettings = localSettings;\n      try {\n        await browser.storage.local.set({ settings: localSettings });\n      } catch {\n        // Ignore\n      }\n    }\n  }\n\n  get ready(): Promise<void> {\n    return this.readyPromise;\n  }\n\n  private async onChange(changes: ChangeDict, areaName: string) {\n    // Safari bug https://bugs.webkit.org/show_bug.cgi?id=281644 means that\n    // `areaName` is undefined in Safari 18.\n    if (!isSafari() && areaName !== 'sync' && areaName !== 'local') {\n      return;\n    }\n\n    // Re-read settings in case the changes were made by a different instance of\n    // this class.\n    await this.readSettings();\n\n    // Extract the changes in a suitable form\n    //\n    // We should be able to key this on `areaName` but since Safari 18 doesn't\n    // set that properly, we have to inspect the actual changes instead.\n    let updatedChanges = { ...changes };\n    if (typeof updatedChanges.settings !== 'undefined') {\n      const localSettings = updatedChanges.settings;\n      delete updatedChanges.settings;\n      updatedChanges = {\n        ...updatedChanges,\n        ...this.extractLocalSettingChanges(localSettings),\n      };\n    }\n\n    // Fill in default setting values\n    for (const key of Object.keys(updatedChanges)) {\n      switch (key) {\n        case 'dictLang':\n          updatedChanges.dictLang = { ...changes.dictLang };\n          if (!updatedChanges.dictLang.newValue) {\n            updatedChanges.dictLang.newValue = this.dictLang;\n          }\n          if (!updatedChanges.dictLang.oldValue) {\n            updatedChanges.dictLang.oldValue = this.previousDefaultLang;\n          }\n          break;\n\n        // Following is just the set of properties we know we actually inspect\n        // the `newValue` of. We don't have a convenient means of fetching the\n        // default value to fill in the oldValue, but we don't currently need\n        // it either.\n        case 'contextMenuEnable':\n        case 'popupStyle':\n        case 'toolbarIcon':\n          updatedChanges[key] = { ...changes[key] };\n          if (\n            typeof updatedChanges[key].newValue === 'undefined' ||\n            updatedChanges[key].newValue === null\n          ) {\n            updatedChanges[key].newValue = this[key];\n          }\n          break;\n\n        // Rename the kanji reference key since the name we use to store it\n        // differs from the name we expose via our API.\n        case 'kanjiReferencesV2':\n          updatedChanges.kanjiReferences = changes.kanjiReferencesV2;\n          delete updatedChanges.kanjiReferencesV2;\n          break;\n\n        // In some cases, the pinPopup key is calculated from the holdToShowKeys\n        // value so we might need to report that too.\n        case 'holdToShowKeys':\n          // If...\n          if (\n            // We are already reporting a change to `keys`, or\n            Object.keys(updatedChanges).includes('keys') ||\n            // The pinPopup key is already explicitly set\n            this.settings.keys?.pinPopup\n          ) {\n            // ... we don't need to report a change\n            break;\n          }\n          updatedChanges.keys = { newValue: this.keys };\n          break;\n      }\n    }\n\n    if (!Object.keys(updatedChanges).length) {\n      return;\n    }\n\n    Bugsnag.leaveBreadcrumb('Settings change', updatedChanges);\n\n    for (const listener of this.changeListeners) {\n      listener(updatedChanges);\n    }\n  }\n\n  private async onFxDataChange(fxData: FxLocalData) {\n    this.fxData = fxData;\n\n    const updatedChanges: ChangeDict = {\n      fxCurrencies: { newValue: this.fxCurrencies },\n      fx: { newValue: this.contentConfig.fx },\n    };\n\n    for (const listener of this.changeListeners) {\n      listener(updatedChanges);\n    }\n  }\n\n  private extractLocalSettingChanges(\n    settingsChange: StorageChange\n  ): ChangeDict {\n    if (!isObject(settingsChange)) {\n      return {};\n    }\n\n    const settings = [\n      ...new Set([\n        ...Object.keys(settingsChange.newValue || {}),\n        ...Object.keys(settingsChange.oldValue || {}),\n      ]),\n    ];\n\n    const result: ChangeDict = {};\n    for (const setting of settings) {\n      result[setting] = {\n        newValue: settingsChange.newValue?.[setting],\n        oldValue: settingsChange.oldValue?.[setting],\n      };\n    }\n\n    return result;\n  }\n\n  addChangeListener(callback: ChangeCallback) {\n    if (this.changeListeners.indexOf(callback) !== -1) {\n      return;\n    }\n    this.changeListeners.push(callback);\n  }\n\n  removeChangeListener(callback: ChangeCallback) {\n    const index = this.changeListeners.indexOf(callback);\n    if (index === -1) {\n      return;\n    }\n    this.changeListeners.splice(index, 1);\n  }\n\n  //\n  // Property accessors\n  //\n\n  // Ultimately we want to do away with all this boilerplate and use decorators\n  // to generate this code.\n  //\n  // Something like:\n  //\n  //   function syncedPref<T>(defaultValue: T) {\n  //     return (\n  //       _value: {\n  //         get: () => T;\n  //         set: (value: T) => void;\n  //       },\n  //       context: {\n  //         kind: 'accessor';\n  //         name: keyof Settings;\n  //         static: boolean;\n  //         private: boolean;\n  //         access: {\n  //           get: (object: Config) => T;\n  //           set: (object: Config, value: T) => void;\n  //         };\n  //         addInitializer(initializer: () => void): void;\n  //       }\n  //     ): {\n  //       get?: (this: Config) => T;\n  //       set?: (this: Config, value: unknown) => void;\n  //       init?: (this: Config, initialValue: T) => T;\n  //     } | void => {\n  //       return {\n  //         get: () => this.settings[context.name] ?? defaultValue,\n  //         set: (value: T) => {\n  //           if (this.settings[context.name] === value) {\n  //             return;\n  //           }\n  //\n  //           if (value === defaultValue) {\n  //             delete this.settings[context.name];\n  //             void browser.storage.sync.remove(context.name);\n  //           } else {\n  //             this.settings[context.name] = value;\n  //             void browser.storage.sync.set({ [context.name]: value });\n  //           }\n  //         },\n  //       };\n  //     };\n  //   }\n  //\n  // Usage:\n  //\n  //   @syncedPref<'common' | 'regular' | undefined>('regular')\n  //   accessor copyHeadwords: 'common' | 'regular' | undefined;\n  //\n  // (Come to think of it, once we do that each accessor will have its own\n  // storage so we can skip writing to this.settings and just use\n  // _value.get.call(this) etc.)\n  //\n  // (Also, we should make the generated getter/setter exclude `undefined` from\n  // `T`).\n  //\n  // Unfortunately, while TypeScript can transpile that, we use vitest for our\n  // unit tests which uses esbuild under the hood which doesn't yet support\n  // decorators and in any case, won't transpile them:\n  //\n  //   https://github.com/evanw/esbuild/issues/104\n  //\n  // UPDATE: Looks like support was added for decorators as of esbuild v0.21.3\n  // https://github.com/evanw/esbuild/releases/tag/v0.21.3\n  //\n  // Our options are either to use SWC (which runs the risk of behaving a bit\n  // differently to TypeScript) or try to get TSC to transpile the relevant\n  // files, e.g. using https://github.com/thomaschaaf/esbuild-plugin-tsc\n  //\n  // Unfortunately apparently vitest doesn't support esbuild plugins so that\n  // last option probably won't work.\n  //\n  // Decorators are being implemented in browsers (e.g. Firefox bug:\n  // https://bugzilla.mozilla.org/show_bug.cgi?id=1781212) so one day they should\n  // be available in esbuild and vitest too.\n\n  // accentDisplay: Defaults to binary\n\n  get accentDisplay(): AccentDisplay {\n    return typeof this.settings.accentDisplay === 'undefined'\n      ? 'binary'\n      : this.settings.accentDisplay;\n  }\n\n  set accentDisplay(value: AccentDisplay) {\n    if (\n      typeof this.settings.accentDisplay !== 'undefined' &&\n      this.settings.accentDisplay === value\n    ) {\n      return;\n    }\n\n    this.settings.accentDisplay = value;\n    void browser.storage.sync.set({ accentDisplay: value });\n  }\n\n  // autoExpand: Defaults to an empty array\n\n  get autoExpand(): Array<AutoExpandableEntry> {\n    return typeof this.settings.autoExpand === 'undefined'\n      ? []\n      : [...new Set(this.settings.autoExpand)];\n  }\n\n  toggleAutoExpand(type: AutoExpandableEntry, value: boolean) {\n    const enabled = new Set(this.settings.autoExpand);\n    if (value === enabled.has(type)) {\n      return;\n    }\n\n    if (value) {\n      enabled.add(type);\n    } else {\n      enabled.delete(type);\n    }\n\n    if (enabled.size) {\n      this.settings.autoExpand = [...enabled];\n      void browser.storage.sync.set({ autoExpand: [...enabled] });\n    } else {\n      delete this.settings.autoExpand;\n      void browser.storage.sync.remove('autoExpand');\n    }\n  }\n\n  // canHover (local): Defaults to true\n\n  get canHover(): boolean {\n    return this.settings.localSettings?.canHover ?? true;\n  }\n\n  set canHover(value: boolean) {\n    const storedSetting = this.settings.localSettings?.canHover;\n    if (storedSetting === value || (storedSetting === undefined && value)) {\n      return;\n    }\n\n    const localSettings = { ...this.settings.localSettings };\n    if (value) {\n      delete localSettings.canHover;\n    } else {\n      localSettings.canHover = false;\n    }\n    this.settings.localSettings = localSettings;\n    void browser.storage.local.set({ settings: localSettings });\n  }\n\n  // bunproDisplay: Defaults to false\n\n  get bunproDisplay(): boolean {\n    return !!this.settings.bunproDisplay;\n  }\n\n  set bunproDisplay(value: boolean) {\n    if (this.settings.bunproDisplay === (value || undefined)) {\n      return;\n    }\n\n    if (!value) {\n      delete this.settings.bunproDisplay;\n      void browser.storage.sync.remove('bunproDisplay');\n    } else {\n      this.settings.bunproDisplay = value;\n      void browser.storage.sync.set({ bunproDisplay: value });\n    }\n  }\n\n  // contextMenuEnable: Defaults to true\n\n  get contextMenuEnable(): boolean {\n    return (\n      typeof this.settings.contextMenuEnable === 'undefined' ||\n      this.settings.contextMenuEnable\n    );\n  }\n\n  set contextMenuEnable(value: boolean) {\n    if (\n      typeof this.settings.contextMenuEnable !== 'undefined' &&\n      this.settings.contextMenuEnable === value\n    ) {\n      return;\n    }\n\n    this.settings.contextMenuEnable = value;\n    void browser.storage.sync.set({ contextMenuEnable: value });\n  }\n\n  // copyHeadwords: Defaults to 'regular'\n\n  get copyHeadwords(): 'common' | 'regular' {\n    return this.settings.copyHeadwords || 'regular';\n  }\n\n  set copyHeadwords(value: 'common' | 'regular') {\n    if (this.settings.copyHeadwords === value) {\n      return;\n    }\n\n    if (value === 'regular') {\n      delete this.settings.copyHeadwords;\n      void browser.storage.sync.remove('copyHeadwords');\n    } else {\n      this.settings.copyHeadwords = value;\n      void browser.storage.sync.set({ copyHeadwords: value });\n    }\n  }\n\n  // copyPos: Defaults to 'code'\n\n  get copyPos(): 'code' | 'none' {\n    return this.settings.copyPos || 'code';\n  }\n\n  set copyPos(value: 'code' | 'none') {\n    if (this.settings.copyPos === value) {\n      return;\n    }\n\n    if (value === 'code') {\n      delete this.settings.copyPos;\n      void browser.storage.sync.remove('copyPos');\n    } else {\n      this.settings.copyPos = value;\n      void browser.storage.sync.set({ copyPos: value });\n    }\n  }\n\n  // copySenses: Defaults to 'all'\n\n  get copySenses(): 'first' | 'all' {\n    return this.settings.copySenses || 'all';\n  }\n\n  set copySenses(value: 'first' | 'all') {\n    if (this.settings.copySenses === value) {\n      return;\n    }\n\n    if (value === 'all') {\n      delete this.settings.copySenses;\n      void browser.storage.sync.remove('copySenses');\n    } else {\n      this.settings.copySenses = value;\n      void browser.storage.sync.set({ copySenses: value });\n    }\n  }\n\n  // dictLang: Defaults to the first match from navigator.languages found in\n  // dbLanguages, or 'en' otherwise.\n\n  get dictLang(): DbLanguageId {\n    return this.useDefaultLang()\n      ? this.getDefaultLang()\n      : this.settings.dictLang!;\n  }\n\n  set dictLang(value: DbLanguageId) {\n    if (this.settings.dictLang && this.settings.dictLang === value) {\n      return;\n    }\n\n    // Note that we don't need to check that `value` is valid since TypeScript\n    // does that for us.\n\n    // If the value to set matches the default we clear the setting. This is so\n    // that if we later support one of the user's more preferred languages we\n    // can update them automatically.\n    if (value === this.getDefaultLang()) {\n      browser.storage.sync.remove('dictLang').catch((e) => {\n        void Bugsnag.notify(\n          new ExtensionStorageError(\n            { key: 'dictLang', action: 'remove' },\n            { cause: e }\n          ),\n          { severity: 'warning' }\n        );\n      });\n      delete this.settings.dictLang;\n    } else {\n      browser.storage.sync.set({ dictLang: value }).catch((e) => {\n        void Bugsnag.notify(\n          new ExtensionStorageError(\n            { key: 'dictLang', action: 'set' },\n            { cause: e }\n          ),\n          { severity: 'warning' }\n        );\n      });\n      this.settings.dictLang = value;\n    }\n  }\n\n  private useDefaultLang(): boolean {\n    // Check that the language that is set is valid. It might be invalid if we\n    // deprecated a language or we synced a value from a newer version of the\n    // extension.\n    if (this.settings.dictLang) {\n      return !dbLanguages.includes(this.settings.dictLang);\n    }\n\n    return true;\n  }\n\n  private getDefaultLang(): DbLanguageId {\n    const availableLanguages = new Set(dbLanguages);\n    for (const lang of navigator.languages) {\n      const langCode = lang.split('-')[0];\n      if (availableLanguages.has(langCode as DbLanguageId)) {\n        return langCode as DbLanguageId;\n      }\n    }\n\n    return 'en';\n  }\n\n  onLanguageChange() {\n    // If the user's accept-languages setting changed AND we are basing the\n    // dictLang value on that we should notify listeners of the change.\n    if (!this.useDefaultLang()) {\n      return;\n    }\n\n    const newValue = this.getDefaultLang();\n    if (this.previousDefaultLang !== newValue) {\n      const oldValue = this.previousDefaultLang;\n      this.previousDefaultLang = newValue;\n      const changes: ChangeDict = { dictLang: { newValue, oldValue } };\n      for (const listener of this.changeListeners) {\n        listener(changes);\n      }\n    }\n  }\n\n  // enableTapLookup: Defaults to true\n\n  get enableTapLookup(): boolean {\n    return this.settings.enableTapLookup ?? true;\n  }\n\n  set enableTapLookup(value: boolean) {\n    const storedSetting = this.settings.enableTapLookup;\n    if (storedSetting === value) {\n      return;\n    }\n\n    if (value) {\n      void browser.storage.sync.remove('enableTapLookup');\n      delete this.settings.enableTapLookup;\n    } else {\n      void browser.storage.sync.set({ enableTapLookup: value });\n      this.settings.enableTapLookup = value;\n    }\n  }\n\n  // fontFace: Defaults to 'bundled'\n\n  get fontFace(): FontFace {\n    return this.settings.fontFace === undefined\n      ? 'bundled'\n      : this.settings.fontFace;\n  }\n\n  set fontFace(value: FontFace) {\n    if (\n      (this.settings.fontFace !== undefined &&\n        this.settings.fontFace === value) ||\n      (typeof this.settings.fontFace === 'undefined' && value === 'bundled')\n    ) {\n      return;\n    }\n\n    if (value !== 'bundled') {\n      this.settings.fontFace = value;\n      void browser.storage.sync.set({ fontFace: value });\n    } else {\n      this.settings.fontFace = undefined;\n      void browser.storage.sync.remove('fontFace');\n    }\n  }\n\n  // fontSize: Defaults to normal\n\n  get fontSize(): FontSize {\n    return typeof this.settings.fontSize === 'undefined'\n      ? 'normal'\n      : this.settings.fontSize;\n  }\n\n  set fontSize(value: FontSize) {\n    if (\n      typeof this.settings.fontSize !== 'undefined' &&\n      this.settings.fontSize === value\n    ) {\n      return;\n    }\n\n    if (value === 'normal') {\n      this.settings.fontSize = undefined;\n      void browser.storage.sync.remove('fontSize');\n    } else {\n      this.settings.fontSize = value;\n      void browser.storage.sync.set({ fontSize: value });\n    }\n  }\n\n  // fxCurrency: Defaults to USD\n\n  get fxCurrency(): string {\n    return typeof this.settings.fxCurrency === 'string'\n      ? this.settings.fxCurrency\n      : 'USD';\n  }\n\n  set fxCurrency(value: string) {\n    const storedSetting = this.settings.fxCurrency;\n    if (value === storedSetting) {\n      return;\n    }\n\n    // Unlike many other settings, we don't reset the setting if the user\n    // chooses the default value ('USD') since in this case we treat it as an\n    // explicit signal they want currencies displayed in USD even if we later\n    // change the default.\n    void browser.storage.sync.set({ fxCurrency: value });\n    this.settings.fxCurrency = value;\n  }\n\n  get fxCurrencies(): Array<string> | undefined {\n    return this.fxData\n      ? Object.keys(this.fxData.rates).sort((a, b) => a.localeCompare(b))\n      : undefined;\n  }\n\n  // highlightStyle: Defaults to 'yellow'\n\n  get highlightStyle(): HighlightStyle {\n    return this.settings.highlightStyle ?? 'yellow';\n  }\n\n  set highlightStyle(value: HighlightStyle) {\n    if (this.highlightStyle === value) {\n      return;\n    }\n\n    if (value === 'yellow') {\n      this.settings.highlightStyle = undefined;\n      void browser.storage.sync.remove('highlightStyle');\n    } else {\n      this.settings.highlightStyle = value;\n      void browser.storage.sync.set({ highlightStyle: value });\n    }\n  }\n\n  // holdToShowKeys: Defaults to null\n\n  get holdToShowKeys(): string | null {\n    return typeof this.settings.holdToShowKeys === 'string'\n      ? this.settings.holdToShowKeys\n      : null;\n  }\n\n  set holdToShowKeys(value: string | null) {\n    const storedSetting = this.settings.holdToShowKeys || null;\n    if (value === storedSetting) {\n      return;\n    }\n\n    if (value === null) {\n      void browser.storage.sync.remove('holdToShowKeys');\n      delete this.settings.holdToShowKeys;\n    } else {\n      void browser.storage.sync.set({ holdToShowKeys: value });\n      this.settings.holdToShowKeys = value;\n    }\n\n    // If holdToShowImageKeys was mirroring this setting, save the previous\n    // value as its own value.\n    if (typeof this.settings.holdToShowImageKeys === 'undefined') {\n      this.holdToShowImageKeys = storedSetting;\n    }\n    // Otherwise, if we have cleared this setting and holdToShowImageKeys was\n    // storing 'none' just to differentiate itself from us, we can clear that\n    // stored value now.\n    else if (!value && this.settings.holdToShowImageKeys === 'none') {\n      this.holdToShowImageKeys = null;\n    }\n  }\n\n  // holdToShowImageKeys: Default is... complicated.\n  //\n  // This setting was introduced after the \"holdToShowKeys\" setting was\n  // introduced and we want the default behavior to be:\n  //\n  // - For new users, nothing, since that's the default for \"holdToShow\" keys\n  //   and it makes sense to surface this by default and let users who find it\n  //   annoying turn it off.\n  //\n  // - For users who have previously configured a \"holdToShowKeys\" setting,\n  //   the same value as the \"holdToShowKeys\" setting since previously that\n  //   setting controlled this behavior.\n  //\n  // But how do we distinguish between a user who has previously configured the\n  // \"holdToShowKeys\" setting (meaning we should mirror that value here) vs one\n  // who has configured the \"holdToShowKeys\" setting _since_ this setting was\n  // introduced and deliberately wants different behavior to that setting?\n  //\n  // We achieve that by deliberately storing \"none\" as the value for this\n  // setting any time we alter the \"holdToShowKeys\" setting while this is null.\n\n  get holdToShowImageKeys(): string | null {\n    // If there is an explicit setting for this value, use that.\n    if (typeof this.settings.holdToShowImageKeys === 'string') {\n      return this.settings.holdToShowImageKeys === 'none'\n        ? null\n        : this.settings.holdToShowImageKeys;\n    }\n\n    // Otherwise, mirror the holdToShowKeys setting\n    return this.holdToShowKeys;\n  }\n\n  set holdToShowImageKeys(value: string | null) {\n    // If this is null AND holdToShowKeys is null, then we can clear the local\n    // setting. We only need to store 'none' if holdToShowKeys is set (in order\n    // to ensure we DON'T mirror that setting).\n    const settingToStore =\n      value === null && this.holdToShowKeys ? 'none' : value;\n\n    // Ignore null-op changes\n    const storedSetting = this.settings.holdToShowImageKeys || null;\n    if (settingToStore === storedSetting) {\n      return;\n    }\n\n    if (settingToStore === null) {\n      void browser.storage.sync.remove('holdToShowImageKeys');\n      delete this.settings.holdToShowImageKeys;\n    } else {\n      void browser.storage.sync.set({ holdToShowImageKeys: settingToStore });\n      this.settings.holdToShowImageKeys = settingToStore;\n    }\n  }\n\n  // kanjiReferences: Defaults to true for all but a few references\n  // that were added more recently.\n\n  get kanjiReferences(): Array<ReferenceAbbreviation> {\n    const setValues = this.settings.kanjiReferencesV2 || {};\n    const result: Array<ReferenceAbbreviation> = [];\n    for (const ref of getReferencesForLang(this.dictLang)) {\n      if (typeof setValues[ref] === 'undefined') {\n        if (!OFF_BY_DEFAULT_REFERENCES.has(ref)) {\n          result.push(ref);\n        }\n      } else if (setValues[ref]) {\n        result.push(ref);\n      }\n    }\n    return result;\n  }\n\n  updateKanjiReferences(updatedReferences: KanjiReferenceFlagsV2) {\n    const existingSettings = this.settings.kanjiReferencesV2 || {};\n    this.settings.kanjiReferencesV2 = {\n      ...existingSettings,\n      ...updatedReferences,\n    };\n    void browser.storage.sync.set({\n      kanjiReferencesV2: this.settings.kanjiReferencesV2,\n    });\n  }\n\n  // keys: Defaults are defined by DEFAULT_KEY_SETTINGS, and particularly the\n  // enabledKeys member.\n\n  private getDefaultEnabledKeys(): StoredKeyboardKeys {\n    return PopupKeys.reduce<Partial<StoredKeyboardKeys>>(\n      (defaultKeys, setting) => {\n        defaultKeys[setting.name] = setting.enabledKeys;\n        return defaultKeys;\n      },\n      {}\n    ) as StoredKeyboardKeys;\n  }\n\n  get keys(): StoredKeyboardKeys {\n    const setValues = this.settings.keys || {};\n    const keys = { ...this.getDefaultEnabledKeys(), ...setValues };\n\n    // If there is no key set for the pin popup key, but there _is_ a suitable\n    // hold-to-show key set, we should use that as the default value.\n    //\n    // (Note that all this complexity might be meaningless. At least on Firefox\n    // on Windows, no one in their right mind would configure Alt as their\n    // hold-to-show key. Every time you release it the menu pops up!)\n    if (!('pinPopup' in setValues)) {\n      // Hold-to-show keys contains a string like `Alt+Ctrl` but we can only\n      // re-use the hold-to-show keys when it's a single item like 'Alt'.\n      const holdToShowKeys = this.holdToShowKeys?.split('+');\n      if (holdToShowKeys?.length === 1) {\n        const holdToShowKey = holdToShowKeys[0];\n        const availableKeys = PopupKeys.find((k) => k.name === 'pinPopup');\n        if (availableKeys?.keys.includes(holdToShowKey)) {\n          keys.pinPopup = [holdToShowKey];\n        }\n      }\n    }\n\n    // When we first released the `expandPopup` key ('x') we didn't notice\n    // that it was already possible to assign 'x' to `closePopup`.\n    //\n    // We _could_ try to make it so that if you assign 'x' to `expandPopup` we\n    // remove it from `closePopup`. But it might be slightly more useful to\n    // allow it to be assigned to both and simply report it as being assigned to\n    // `closePopup` in that case.\n    //\n    // That has the advantages that:\n    //\n    // 1. If you go to enable it for `closePopup` and notice that doing so\n    //    clears it from `expandPopup`, you can just untick it from `closePopup`\n    //    and it will automatically be restored to `expandPopup`.\n    //\n    // 2. We need to handle the case when they're both selected anyway since\n    //    it's already possible to get it into that state in a released version.\n    if (keys.expandPopup.includes('x') && keys.closePopup.includes('x')) {\n      keys.expandPopup = keys.expandPopup.filter((k) => k !== 'x');\n    }\n\n    return keys;\n  }\n\n  get keysNormalized(): KeyboardKeys {\n    const storedKeys = this.keys;\n    const [down, up] = this.keys.movePopupDownOrUp\n      .map((key) => key.split(',', 2))\n      .reduce<[Array<string>, Array<string>]>(\n        ([existingDown, existingUp], [down, up]) => [\n          [...existingDown, down],\n          [...existingUp, up],\n        ],\n        [[], []]\n      );\n\n    return {\n      ...stripFields(storedKeys, ['movePopupDownOrUp']),\n      movePopupDown: down,\n      movePopupUp: up,\n    };\n  }\n\n  updateKeys(keys: Partial<StoredKeyboardKeys>) {\n    const existingSettings = this.settings.keys || {};\n    this.settings.keys = {\n      ...existingSettings,\n      ...keys,\n    };\n\n    void browser.storage.sync.set({ keys: this.settings.keys });\n  }\n\n  // noTextHighlight: Defaults to false\n\n  get noTextHighlight(): boolean {\n    return !!this.settings.noTextHighlight;\n  }\n\n  set noTextHighlight(value: boolean) {\n    if (\n      typeof this.settings.noTextHighlight !== 'undefined' &&\n      this.settings.noTextHighlight === value\n    ) {\n      return;\n    }\n\n    this.settings.noTextHighlight = value;\n    void browser.storage.sync.set({ noTextHighlight: value });\n  }\n\n  // popupInteractive (local): Defaults to true\n\n  get popupInteractive(): boolean {\n    return this.settings.localSettings?.popupInteractive ?? true;\n  }\n\n  set popupInteractive(value: boolean) {\n    const storedSetting = this.settings.localSettings?.popupInteractive;\n    if (storedSetting === value) {\n      return;\n    }\n\n    const localSettings = { ...this.settings.localSettings };\n    if (value) {\n      delete localSettings.popupInteractive;\n    } else {\n      localSettings.popupInteractive = false;\n    }\n    this.settings.localSettings = localSettings;\n    void browser.storage.local.set({ settings: localSettings });\n  }\n\n  // popupStyle: Defaults to 'default'\n\n  get popupStyle(): string {\n    return typeof this.settings.popupStyle === 'undefined'\n      ? 'default'\n      : this.settings.popupStyle;\n  }\n\n  set popupStyle(value: string) {\n    if (\n      (typeof this.settings.popupStyle !== 'undefined' &&\n        this.settings.popupStyle === value) ||\n      (typeof this.settings.popupStyle === 'undefined' && value === 'default')\n    ) {\n      return;\n    }\n\n    if (value !== 'default') {\n      this.settings.popupStyle = value;\n      void browser.storage.sync.set({ popupStyle: value });\n    } else {\n      this.settings.popupStyle = undefined;\n      void browser.storage.sync.remove('popupStyle');\n    }\n  }\n\n  // posDisplay: Defaults to expl\n\n  get posDisplay(): PartOfSpeechDisplay {\n    return typeof this.settings.posDisplay === 'undefined'\n      ? 'expl'\n      : this.settings.posDisplay;\n  }\n\n  set posDisplay(value: PartOfSpeechDisplay) {\n    if (\n      typeof this.settings.posDisplay !== 'undefined' &&\n      this.settings.posDisplay === value\n    ) {\n      return;\n    }\n\n    this.settings.posDisplay = value;\n    void browser.storage.sync.set({ posDisplay: value });\n  }\n\n  // preferredUnits: Defaults to 'metric'\n\n  get preferredUnits(): 'metric' | 'imperial' {\n    return this.settings.preferredUnits || 'metric';\n  }\n\n  set preferredUnits(value: 'metric' | 'imperial') {\n    if (this.settings.preferredUnits === value) {\n      return;\n    }\n\n    this.settings.preferredUnits = value;\n    void browser.storage.sync.set({ preferredUnits: value });\n  }\n\n  // readingOnly: Defaults to false\n\n  get readingOnly(): boolean {\n    return !!this.settings.readingOnly;\n  }\n\n  set readingOnly(value: boolean) {\n    if (\n      typeof this.settings.readingOnly !== 'undefined' &&\n      this.settings.readingOnly === value\n    ) {\n      return;\n    }\n\n    this.settings.readingOnly = value;\n    void browser.storage.sync.set({ readingOnly: value });\n  }\n\n  toggleReadingOnly() {\n    this.readingOnly = !this.settings.readingOnly;\n  }\n\n  // showKanjiComponents: Defaults to true\n\n  get showKanjiComponents(): boolean {\n    return (\n      typeof this.settings.showKanjiComponents === 'undefined' ||\n      this.settings.showKanjiComponents\n    );\n  }\n\n  set showKanjiComponents(value: boolean) {\n    this.settings.showKanjiComponents = value;\n    void browser.storage.sync.set({ showKanjiComponents: value });\n  }\n\n  // showPriority: Defaults to true\n\n  get showPriority(): boolean {\n    return (\n      typeof this.settings.showPriority === 'undefined' ||\n      this.settings.showPriority\n    );\n  }\n\n  set showPriority(value: boolean) {\n    this.settings.showPriority = value;\n    void browser.storage.sync.set({ showPriority: value });\n  }\n\n  // showPuck (local): Defaults to 'auto'\n\n  get showPuck(): 'show' | 'hide' | 'auto' {\n    return this.settings.localSettings?.showPuck || 'auto';\n  }\n\n  set showPuck(value: 'show' | 'hide' | 'auto') {\n    const storedSetting = this.settings.localSettings?.showPuck || 'auto';\n    if (storedSetting === value) {\n      return;\n    }\n\n    const localSettings = { ...this.settings.localSettings };\n    if (value === 'auto') {\n      delete localSettings.showPuck;\n    } else {\n      localSettings.showPuck = value;\n    }\n    this.settings.localSettings = localSettings;\n\n    // If value is 'hide' we should reset the puck state but since that writes\n    // to the same key in local storage we should wait for the current write to\n    // complete first.\n    void browser.storage.local.set({ settings: localSettings }).finally(() => {\n      if (value === 'hide') {\n        this.puckState = undefined;\n      }\n    });\n  }\n\n  get computedShowPuck(): 'show' | 'hide' {\n    return this.showPuck !== 'auto'\n      ? this.showPuck\n      : this.canHover\n        ? 'hide'\n        : 'show';\n  }\n\n  // Puck state (local): Defaults to undefined\n\n  get puckState(): PuckState | undefined {\n    return this.settings.localSettings?.puckState;\n  }\n\n  set puckState(value: PuckState | undefined) {\n    const storedSetting = this.settings.localSettings?.puckState;\n    if (JSON.stringify(storedSetting) === JSON.stringify(value)) {\n      return;\n    }\n\n    const localSettings = { ...this.settings.localSettings };\n    if (!value) {\n      delete localSettings.puckState;\n    } else {\n      localSettings.puckState = value;\n    }\n    this.settings.localSettings = localSettings;\n\n    void browser.storage.local.set({ settings: localSettings });\n  }\n\n  // showRomaji: Defaults to false\n\n  get showRomaji(): boolean {\n    return !!this.settings.showRomaji;\n  }\n\n  set showRomaji(value: boolean) {\n    if (this.settings.showRomaji === value) {\n      return;\n    }\n\n    if (!value) {\n      delete this.settings.showRomaji;\n      void browser.storage.sync.remove('showRomaji');\n    } else {\n      this.settings.showRomaji = value;\n      void browser.storage.sync.set({ showRomaji: value });\n    }\n  }\n\n  // waniKaniVocabDisplay: Defaults to 'hide'\n\n  get waniKaniVocabDisplay(): 'hide' | 'show-matches' {\n    return this.settings.waniKaniVocabDisplay || 'hide';\n  }\n\n  set waniKaniVocabDisplay(value: 'hide' | 'show-matches') {\n    if (this.settings.waniKaniVocabDisplay === value) {\n      return;\n    }\n\n    if (value === 'hide') {\n      delete this.settings.waniKaniVocabDisplay;\n      void browser.storage.sync.remove('waniKaniVocabDisplay');\n    } else {\n      this.settings.waniKaniVocabDisplay = value;\n      void browser.storage.sync.set({ waniKaniVocabDisplay: value });\n    }\n  }\n\n  // tabDisplay: Defaults to 'top'\n\n  get tabDisplay(): TabDisplay {\n    return typeof this.settings.tabDisplay === 'undefined'\n      ? 'top'\n      : this.settings.tabDisplay;\n  }\n\n  set tabDisplay(value: TabDisplay) {\n    if (\n      (typeof this.settings.tabDisplay !== 'undefined' &&\n        this.settings.tabDisplay === value) ||\n      (typeof this.settings.tabDisplay === 'undefined' && value === 'top')\n    ) {\n      return;\n    }\n\n    if (value !== 'top') {\n      this.settings.tabDisplay = value;\n      void browser.storage.sync.set({ tabDisplay: value });\n    } else {\n      this.settings.tabDisplay = undefined;\n      void browser.storage.sync.remove('tabDisplay');\n    }\n  }\n\n  // toolbarIcon: Defaults to 'default'\n\n  get toolbarIcon(): 'default' | 'sky' {\n    return typeof this.settings.toolbarIcon === 'undefined'\n      ? 'default'\n      : this.settings.toolbarIcon;\n  }\n\n  set toolbarIcon(value: 'default' | 'sky') {\n    if (\n      (typeof this.settings.toolbarIcon !== 'undefined' &&\n        this.settings.toolbarIcon === value) ||\n      (typeof this.settings.toolbarIcon === 'undefined' && value === 'default')\n    ) {\n      return;\n    }\n\n    if (value !== 'default') {\n      this.settings.toolbarIcon = value;\n      void browser.storage.sync.set({ toolbarIcon: value });\n    } else {\n      this.settings.toolbarIcon = undefined;\n      void browser.storage.sync.remove('toolbarIcon');\n    }\n  }\n\n  // Get all the options the content process cares about at once\n  get contentConfig(): ContentConfigParams {\n    return {\n      accentDisplay: this.accentDisplay,\n      autoExpand: this.autoExpand,\n      bunproDisplay: this.bunproDisplay,\n      copyHeadwords: this.copyHeadwords,\n      copyPos: this.copyPos,\n      copySenses: this.copySenses,\n      dictLang: this.dictLang,\n      enableTapLookup: this.enableTapLookup,\n      fx:\n        this.fxData && this.fxCurrency in this.fxData.rates\n          ? {\n              currency: this.fxCurrency,\n              rate: this.fxData.rates[this.fxCurrency],\n              timestamp: this.fxData.timestamp,\n            }\n          : undefined,\n      fontFace: this.fontFace,\n      fontSize: this.fontSize,\n      highlightStyle: this.highlightStyle,\n      holdToShowKeys: this.holdToShowKeys\n        ? (this.holdToShowKeys.split('+') as Array<'Ctrl' | 'Alt'>)\n        : [],\n      holdToShowImageKeys: this.holdToShowImageKeys\n        ? (this.holdToShowImageKeys.split('+') as Array<'Ctrl' | 'Alt'>)\n        : [],\n      kanjiReferences: this.kanjiReferences,\n      keys: this.keysNormalized,\n      noTextHighlight: this.noTextHighlight,\n      popupInteractive: this.popupInteractive,\n      popupStyle: this.popupStyle,\n      posDisplay: this.posDisplay,\n      preferredUnits: this.preferredUnits,\n      puckState: this.puckState,\n      readingOnly: this.readingOnly,\n      showKanjiComponents: this.showKanjiComponents,\n      showPriority: this.showPriority,\n      showPuck: this.showPuck,\n      showRomaji: this.showRomaji,\n      tabDisplay: this.tabDisplay,\n      toolbarIcon: this.toolbarIcon,\n      waniKaniVocabDisplay: this.waniKaniVocabDisplay,\n    };\n  }\n}\n","import browser from 'webextension-polyfill';\n\nlet releaseStage: 'production' | 'development' = 'production';\n\nif (browser.management) {\n  browser.management\n    .getSelf()\n    .then((info) => {\n      if (info.installType === 'development') {\n        releaseStage = 'development';\n      }\n    })\n    .catch((e) => {\n      console.warn(e);\n    });\n}\n\nexport function getReleaseStage(): 'production' | 'development' {\n  return releaseStage;\n}\n","import Bugsnag, {\n  Event as BugsnagEvent,\n  appDuration,\n  browserContext,\n  browserHandledRejectionBreadcrumbs,\n  browserNotifyUnhandledExceptions,\n  browserNotifyUnhandledRejections,\n  consoleBreadcrumbs,\n  deviceOrientation,\n  errorBreadcrumbs,\n  fetchBreadcrumbs,\n  interactionBreadcrumbs,\n  limitEvents,\n  navigationBreadcrumbs,\n  stringifyValues,\n} from '@birchill/bugsnag-zero';\nimport browser from 'webextension-polyfill';\n\nimport { ExtensionStorageError } from '../common/extension-storage-error';\n\nimport { isObject } from './is-object';\nimport { getReleaseStage } from './release-stage';\n\nconst getExtensionInstallId = async (): Promise<string> => {\n  let internalUuid: string | undefined;\n  try {\n    // In Firefox, each install gets a unique internal UUID which differs from\n    // the extension ID (provided it is set through the\n    // browser_specific_settings in manifest.json).\n    //\n    // Specifically:\n    //\n    // browser.runtime.id = Extension ID\n    // browser.runtime.getURL('yer').host = Internal UUID\n    // browser.getMessage('@@extension_id') = Internal UUID\n    //\n    // In other browsers I think all of the above return the Extension ID.\n    // (I haven't checked Safari, however.)\n    //\n    // If that internal UUID is available, we use it because it is sometimes\n    // helpful when Firefox users contact us describing a bug, to be able to\n    // find error reports generated from their installation.\n    //\n    internalUuid = new URL(browser.runtime.getURL('yer')).host;\n  } catch {\n    // Ignore\n  }\n\n  if (internalUuid && internalUuid !== browser.runtime.id) {\n    return internalUuid;\n  }\n\n  // Generate/fetch a unique install ID since the browser doesn't provide one.\n  try {\n    let storedInstallId = (await browser.storage.local.get('installid'))\n      ?.installid;\n    if (typeof storedInstallId !== 'string') {\n      const installId = getRandomId();\n      await browser.storage.local.set({ installid: installId });\n      storedInstallId = installId;\n    }\n\n    return storedInstallId as string;\n  } catch {\n    // Ignore because we are probably already in the middle of reporting an error\n  }\n\n  return 'unknown';\n};\n\nfunction getRandomId() {\n  const number = getRandomNumber(10);\n  return `${'0'.repeat(10)}${number.toString(36)}`.slice(-10);\n}\n\n// |length| here is the maximum number of base-36 digits we want to generate.\nfunction getRandomNumber(length: number): number {\n  if (Math.pow(36, length) > Number.MAX_SAFE_INTEGER) {\n    console.error(\n      `A base-36 number with ${length} digits overflows the range of an integer`\n    );\n  }\n  const values = new Uint8Array(length);\n  crypto.getRandomValues(values);\n  const max = Math.pow(2, 8);\n\n  let result = 0;\n  for (let i = 0; i < values.length; i++) {\n    result *= 36;\n    result += Math.round((values[i] / max) * 35);\n  }\n  return result;\n}\n\nexport function startBugsnag() {\n  const manifest = browser.runtime.getManifest();\n\n  const plugins = [\n    appDuration,\n    browserContext,\n    browserHandledRejectionBreadcrumbs,\n    browserNotifyUnhandledExceptions,\n    browserNotifyUnhandledRejections,\n    deviceOrientation,\n    errorBreadcrumbs,\n    fetchBreadcrumbs,\n    interactionBreadcrumbs,\n    limitEvents(20),\n    navigationBreadcrumbs,\n    stringifyValues,\n  ];\n\n  if (getReleaseStage() !== 'development') {\n    plugins.push(consoleBreadcrumbs);\n  }\n\n  Bugsnag.start({\n    apiKey: 'e707c9ae84265d122b019103641e6462',\n    appVersion: manifest.version_name || manifest.version,\n    collectUserIp: false,\n    onError: async (event: BugsnagEvent) => {\n      // Fill out the user ID\n      event.user = { id: await getExtensionInstallId() };\n\n      // Group download errors by URL and error code\n      if (isDownloadError(event.originalError)) {\n        event.groupingHash =\n          String(event.originalError.code) + event.originalError.url;\n        if (!event.request) {\n          event.request = {};\n        }\n        event.request.url = event.originalError.url;\n      }\n\n      // Group extension errors by action and key\n      if (event.originalError instanceof ExtensionStorageError) {\n        const { key, action } = event.originalError;\n        event.groupingHash = `${action}:${key}`;\n      }\n\n      // Update release stage here since we can only fetch this async but\n      // bugsnag doesn't allow updating the instance after initializing.\n      if (!event.app) {\n        event.app = {};\n      }\n      event.app.releaseStage = getReleaseStage();\n\n      // Update paths in stack trace so that:\n      //\n      // (a) They are the same across installations of the same version (since\n      //     the installed extension ID in the path differs per installation).\n      // (b) They point to where the source is available publicly.\n      //\n      // Note that this is also necessary because Bugsnag's backend discards stack\n      // frames from extensions.\n      //\n      // See: https://docs.bugsnag.com/platforms/javascript/faq/?#how-can-i-get-error-reports-from-browser-extensions\n      const basePath = `https://github.com/birchill/10ten-ja-reader/releases/download/v${manifest.version_name || manifest.version}`;\n      for (const error of event.exceptions) {\n        for (const frame of error.stacktrace) {\n          frame.file = frame.file.replace(\n            /^(moz-extension|chrome-extension|extension|safari-extension|safari-web-extension):\\/\\/[0-9a-z-]+/,\n            basePath\n          );\n        }\n      }\n\n      // If we get a QuotaExceededError, report how much disk space was available.\n      if (event.exceptions[0].errorClass === 'QuotaExceededError') {\n        try {\n          const { quota, usage } = await navigator.storage.estimate();\n          if (!event.metaData) {\n            event.metaData = {};\n          }\n          event.metaData.storage = { quota, usage };\n        } catch {\n          console.warn('Failed to get storage estimate');\n        }\n      }\n\n      return true;\n    },\n    plugins,\n  });\n}\n\n// Common demonimator between jpdict-idb's DownloadError type and\n// fx-fetcher.ts's DownloadError.\ntype CommonDownloadError = {\n  name: 'DownloadError';\n  url?: string;\n  code: number | string;\n};\n\nfunction isDownloadError(error: unknown): error is CommonDownloadError {\n  return (\n    isObject(error) &&\n    typeof error.name === 'string' &&\n    (typeof error.url === 'string' || typeof error.url === 'undefined') &&\n    (typeof error.code === 'number' || typeof error.url === 'string')\n  );\n}\n","import { options as _options } from 'preact';\n\n/** @type {number} */\nlet currentIndex;\n\n/** @type {import('./internal').Component} */\nlet currentComponent;\n\n/** @type {import('./internal').Component} */\nlet previousComponent;\n\n/** @type {number} */\nlet currentHook = 0;\n\n/** @type {Array<import('./internal').Component>} */\nlet afterPaintEffects = [];\n\n// Cast to use internal Options type\nconst options = /** @type {import('./internal').Options} */ (_options);\n\nlet oldBeforeDiff = options._diff;\nlet oldBeforeRender = options._render;\nlet oldAfterDiff = options.diffed;\nlet oldCommit = options._commit;\nlet oldBeforeUnmount = options.unmount;\nlet oldRoot = options._root;\n\nconst RAF_TIMEOUT = 100;\nlet prevRaf;\n\n/** @type {(vnode: import('./internal').VNode) => void} */\noptions._diff = vnode => {\n\tcurrentComponent = null;\n\tif (oldBeforeDiff) oldBeforeDiff(vnode);\n};\n\noptions._root = (vnode, parentDom) => {\n\tif (vnode && parentDom._children && parentDom._children._mask) {\n\t\tvnode._mask = parentDom._children._mask;\n\t}\n\n\tif (oldRoot) oldRoot(vnode, parentDom);\n};\n\n/** @type {(vnode: import('./internal').VNode) => void} */\noptions._render = vnode => {\n\tif (oldBeforeRender) oldBeforeRender(vnode);\n\n\tcurrentComponent = vnode._component;\n\tcurrentIndex = 0;\n\n\tconst hooks = currentComponent.__hooks;\n\tif (hooks) {\n\t\tif (previousComponent === currentComponent) {\n\t\t\thooks._pendingEffects = [];\n\t\t\tcurrentComponent._renderCallbacks = [];\n\t\t\thooks._list.forEach(hookItem => {\n\t\t\t\tif (hookItem._nextValue) {\n\t\t\t\t\thookItem._value = hookItem._nextValue;\n\t\t\t\t}\n\t\t\t\thookItem._pendingArgs = hookItem._nextValue = undefined;\n\t\t\t});\n\t\t} else {\n\t\t\thooks._pendingEffects.forEach(invokeCleanup);\n\t\t\thooks._pendingEffects.forEach(invokeEffect);\n\t\t\thooks._pendingEffects = [];\n\t\t\tcurrentIndex = 0;\n\t\t}\n\t}\n\tpreviousComponent = currentComponent;\n};\n\n/** @type {(vnode: import('./internal').VNode) => void} */\noptions.diffed = vnode => {\n\tif (oldAfterDiff) oldAfterDiff(vnode);\n\n\tconst c = vnode._component;\n\tif (c && c.__hooks) {\n\t\tif (c.__hooks._pendingEffects.length) afterPaint(afterPaintEffects.push(c));\n\t\tc.__hooks._list.forEach(hookItem => {\n\t\t\tif (hookItem._pendingArgs) {\n\t\t\t\thookItem._args = hookItem._pendingArgs;\n\t\t\t}\n\t\t\thookItem._pendingArgs = undefined;\n\t\t});\n\t}\n\tpreviousComponent = currentComponent = null;\n};\n\n// TODO: Improve typing of commitQueue parameter\n/** @type {(vnode: import('./internal').VNode, commitQueue: any) => void} */\noptions._commit = (vnode, commitQueue) => {\n\tcommitQueue.some(component => {\n\t\ttry {\n\t\t\tcomponent._renderCallbacks.forEach(invokeCleanup);\n\t\t\tcomponent._renderCallbacks = component._renderCallbacks.filter(cb =>\n\t\t\t\tcb._value ? invokeEffect(cb) : true\n\t\t\t);\n\t\t} catch (e) {\n\t\t\tcommitQueue.some(c => {\n\t\t\t\tif (c._renderCallbacks) c._renderCallbacks = [];\n\t\t\t});\n\t\t\tcommitQueue = [];\n\t\t\toptions._catchError(e, component._vnode);\n\t\t}\n\t});\n\n\tif (oldCommit) oldCommit(vnode, commitQueue);\n};\n\n/** @type {(vnode: import('./internal').VNode) => void} */\noptions.unmount = vnode => {\n\tif (oldBeforeUnmount) oldBeforeUnmount(vnode);\n\n\tconst c = vnode._component;\n\tif (c && c.__hooks) {\n\t\tlet hasErrored;\n\t\tc.__hooks._list.forEach(s => {\n\t\t\ttry {\n\t\t\t\tinvokeCleanup(s);\n\t\t\t} catch (e) {\n\t\t\t\thasErrored = e;\n\t\t\t}\n\t\t});\n\t\tc.__hooks = undefined;\n\t\tif (hasErrored) options._catchError(hasErrored, c._vnode);\n\t}\n};\n\n/**\n * Get a hook's state from the currentComponent\n * @param {number} index The index of the hook to get\n * @param {number} type The index of the hook to get\n * @returns {any}\n */\nfunction getHookState(index, type) {\n\tif (options._hook) {\n\t\toptions._hook(currentComponent, index, currentHook || type);\n\t}\n\tcurrentHook = 0;\n\n\t// Largely inspired by:\n\t// * https://github.com/michael-klein/funcy.js/blob/f6be73468e6ec46b0ff5aa3cc4c9baf72a29025a/src/hooks/core_hooks.mjs\n\t// * https://github.com/michael-klein/funcy.js/blob/650beaa58c43c33a74820a3c98b3c7079cf2e333/src/renderer.mjs\n\t// Other implementations to look at:\n\t// * https://codesandbox.io/s/mnox05qp8\n\tconst hooks =\n\t\tcurrentComponent.__hooks ||\n\t\t(currentComponent.__hooks = {\n\t\t\t_list: [],\n\t\t\t_pendingEffects: []\n\t\t});\n\n\tif (index >= hooks._list.length) {\n\t\thooks._list.push({});\n\t}\n\n\treturn hooks._list[index];\n}\n\n/**\n * @template {unknown} S\n * @param {import('./index').Dispatch<import('./index').StateUpdater<S>>} [initialState]\n * @returns {[S, (state: S) => void]}\n */\nexport function useState(initialState) {\n\tcurrentHook = 1;\n\treturn useReducer(invokeOrReturn, initialState);\n}\n\n/**\n * @template {unknown} S\n * @template {unknown} A\n * @param {import('./index').Reducer<S, A>} reducer\n * @param {import('./index').Dispatch<import('./index').StateUpdater<S>>} initialState\n * @param {(initialState: any) => void} [init]\n * @returns {[ S, (state: S) => void ]}\n */\nexport function useReducer(reducer, initialState, init) {\n\t/** @type {import('./internal').ReducerHookState} */\n\tconst hookState = getHookState(currentIndex++, 2);\n\thookState._reducer = reducer;\n\tif (!hookState._component) {\n\t\thookState._value = [\n\t\t\t!init ? invokeOrReturn(undefined, initialState) : init(initialState),\n\n\t\t\taction => {\n\t\t\t\tconst currentValue = hookState._nextValue\n\t\t\t\t\t? hookState._nextValue[0]\n\t\t\t\t\t: hookState._value[0];\n\t\t\t\tconst nextValue = hookState._reducer(currentValue, action);\n\n\t\t\t\tif (currentValue !== nextValue) {\n\t\t\t\t\thookState._nextValue = [nextValue, hookState._value[1]];\n\t\t\t\t\thookState._component.setState({});\n\t\t\t\t}\n\t\t\t}\n\t\t];\n\n\t\thookState._component = currentComponent;\n\n\t\tif (!currentComponent._hasScuFromHooks) {\n\t\t\tcurrentComponent._hasScuFromHooks = true;\n\t\t\tlet prevScu = currentComponent.shouldComponentUpdate;\n\t\t\tconst prevCWU = currentComponent.componentWillUpdate;\n\n\t\t\t// If we're dealing with a forced update `shouldComponentUpdate` will\n\t\t\t// not be called. But we use that to update the hook values, so we\n\t\t\t// need to call it.\n\t\t\tcurrentComponent.componentWillUpdate = function (p, s, c) {\n\t\t\t\tif (this._force) {\n\t\t\t\t\tlet tmp = prevScu;\n\t\t\t\t\t// Clear to avoid other sCU hooks from being called\n\t\t\t\t\tprevScu = undefined;\n\t\t\t\t\tupdateHookState(p, s, c);\n\t\t\t\t\tprevScu = tmp;\n\t\t\t\t}\n\n\t\t\t\tif (prevCWU) prevCWU.call(this, p, s, c);\n\t\t\t};\n\n\t\t\t// This SCU has the purpose of bailing out after repeated updates\n\t\t\t// to stateful hooks.\n\t\t\t// we store the next value in _nextValue[0] and keep doing that for all\n\t\t\t// state setters, if we have next states and\n\t\t\t// all next states within a component end up being equal to their original state\n\t\t\t// we are safe to bail out for this specific component.\n\t\t\t/**\n\t\t\t *\n\t\t\t * @type {import('./internal').Component[\"shouldComponentUpdate\"]}\n\t\t\t */\n\t\t\t// @ts-ignore - We don't use TS to downtranspile\n\t\t\t// eslint-disable-next-line no-inner-declarations\n\t\t\tfunction updateHookState(p, s, c) {\n\t\t\t\tif (!hookState._component.__hooks) return true;\n\n\t\t\t\t/** @type {(x: import('./internal').HookState) => x is import('./internal').ReducerHookState} */\n\t\t\t\tconst isStateHook = x => !!x._component;\n\t\t\t\tconst stateHooks =\n\t\t\t\t\thookState._component.__hooks._list.filter(isStateHook);\n\n\t\t\t\tconst allHooksEmpty = stateHooks.every(x => !x._nextValue);\n\t\t\t\t// When we have no updated hooks in the component we invoke the previous SCU or\n\t\t\t\t// traverse the VDOM tree further.\n\t\t\t\tif (allHooksEmpty) {\n\t\t\t\t\treturn prevScu ? prevScu.call(this, p, s, c) : true;\n\t\t\t\t}\n\n\t\t\t\t// We check whether we have components with a nextValue set that\n\t\t\t\t// have values that aren't equal to one another this pushes\n\t\t\t\t// us to update further down the tree\n\t\t\t\tlet shouldUpdate = false;\n\t\t\t\tstateHooks.forEach(hookItem => {\n\t\t\t\t\tif (hookItem._nextValue) {\n\t\t\t\t\t\tconst currentValue = hookItem._value[0];\n\t\t\t\t\t\thookItem._value = hookItem._nextValue;\n\t\t\t\t\t\thookItem._nextValue = undefined;\n\t\t\t\t\t\tif (currentValue !== hookItem._value[0]) shouldUpdate = true;\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\treturn shouldUpdate || hookState._component.props !== p\n\t\t\t\t\t? prevScu\n\t\t\t\t\t\t? prevScu.call(this, p, s, c)\n\t\t\t\t\t\t: true\n\t\t\t\t\t: false;\n\t\t\t}\n\n\t\t\tcurrentComponent.shouldComponentUpdate = updateHookState;\n\t\t}\n\t}\n\n\treturn hookState._nextValue || hookState._value;\n}\n\n/**\n * @param {import('./internal').Effect} callback\n * @param {unknown[]} args\n * @returns {void}\n */\nexport function useEffect(callback, args) {\n\t/** @type {import('./internal').EffectHookState} */\n\tconst state = getHookState(currentIndex++, 3);\n\tif (!options._skipEffects && argsChanged(state._args, args)) {\n\t\tstate._value = callback;\n\t\tstate._pendingArgs = args;\n\n\t\tcurrentComponent.__hooks._pendingEffects.push(state);\n\t}\n}\n\n/**\n * @param {import('./internal').Effect} callback\n * @param {unknown[]} args\n * @returns {void}\n */\nexport function useLayoutEffect(callback, args) {\n\t/** @type {import('./internal').EffectHookState} */\n\tconst state = getHookState(currentIndex++, 4);\n\tif (!options._skipEffects && argsChanged(state._args, args)) {\n\t\tstate._value = callback;\n\t\tstate._pendingArgs = args;\n\n\t\tcurrentComponent._renderCallbacks.push(state);\n\t}\n}\n\n/** @type {(initialValue: unknown) => unknown} */\nexport function useRef(initialValue) {\n\tcurrentHook = 5;\n\treturn useMemo(() => ({ current: initialValue }), []);\n}\n\n/**\n * @param {object} ref\n * @param {() => object} createHandle\n * @param {unknown[]} args\n * @returns {void}\n */\nexport function useImperativeHandle(ref, createHandle, args) {\n\tcurrentHook = 6;\n\tuseLayoutEffect(\n\t\t() => {\n\t\t\tif (typeof ref == 'function') {\n\t\t\t\tref(createHandle());\n\t\t\t\treturn () => ref(null);\n\t\t\t} else if (ref) {\n\t\t\t\tref.current = createHandle();\n\t\t\t\treturn () => (ref.current = null);\n\t\t\t}\n\t\t},\n\t\targs == null ? args : args.concat(ref)\n\t);\n}\n\n/**\n * @template {unknown} T\n * @param {() => T} factory\n * @param {unknown[]} args\n * @returns {T}\n */\nexport function useMemo(factory, args) {\n\t/** @type {import('./internal').MemoHookState<T>} */\n\tconst state = getHookState(currentIndex++, 7);\n\tif (argsChanged(state._args, args)) {\n\t\tstate._value = factory();\n\t\tstate._args = args;\n\t\tstate._factory = factory;\n\t}\n\n\treturn state._value;\n}\n\n/**\n * @param {() => void} callback\n * @param {unknown[]} args\n * @returns {() => void}\n */\nexport function useCallback(callback, args) {\n\tcurrentHook = 8;\n\treturn useMemo(() => callback, args);\n}\n\n/**\n * @param {import('./internal').PreactContext} context\n */\nexport function useContext(context) {\n\tconst provider = currentComponent.context[context._id];\n\t// We could skip this call here, but than we'd not call\n\t// `options._hook`. We need to do that in order to make\n\t// the devtools aware of this hook.\n\t/** @type {import('./internal').ContextHookState} */\n\tconst state = getHookState(currentIndex++, 9);\n\t// The devtools needs access to the context object to\n\t// be able to pull of the default value when no provider\n\t// is present in the tree.\n\tstate._context = context;\n\tif (!provider) return context._defaultValue;\n\t// This is probably not safe to convert to \"!\"\n\tif (state._value == null) {\n\t\tstate._value = true;\n\t\tprovider.sub(currentComponent);\n\t}\n\treturn provider.props.value;\n}\n\n/**\n * Display a custom label for a custom hook for the devtools panel\n * @type {<T>(value: T, cb?: (value: T) => string | number) => void}\n */\nexport function useDebugValue(value, formatter) {\n\tif (options.useDebugValue) {\n\t\toptions.useDebugValue(\n\t\t\tformatter ? formatter(value) : /** @type {any}*/ (value)\n\t\t);\n\t}\n}\n\n/**\n * @param {(error: unknown, errorInfo: import('preact').ErrorInfo) => void} cb\n * @returns {[unknown, () => void]}\n */\nexport function useErrorBoundary(cb) {\n\t/** @type {import('./internal').ErrorBoundaryHookState} */\n\tconst state = getHookState(currentIndex++, 10);\n\tconst errState = useState();\n\tstate._value = cb;\n\tif (!currentComponent.componentDidCatch) {\n\t\tcurrentComponent.componentDidCatch = (err, errorInfo) => {\n\t\t\tif (state._value) state._value(err, errorInfo);\n\t\t\terrState[1](err);\n\t\t};\n\t}\n\treturn [\n\t\terrState[0],\n\t\t() => {\n\t\t\terrState[1](undefined);\n\t\t}\n\t];\n}\n\n/** @type {() => string} */\nexport function useId() {\n\t/** @type {import('./internal').IdHookState} */\n\tconst state = getHookState(currentIndex++, 11);\n\tif (!state._value) {\n\t\t// Grab either the root node or the nearest async boundary node.\n\t\t/** @type {import('./internal.d').VNode} */\n\t\tlet root = currentComponent._vnode;\n\t\twhile (root !== null && !root._mask && root._parent !== null) {\n\t\t\troot = root._parent;\n\t\t}\n\n\t\tlet mask = root._mask || (root._mask = [0, 0]);\n\t\tstate._value = 'P' + mask[0] + '-' + mask[1]++;\n\t}\n\n\treturn state._value;\n}\n\n/**\n * After paint effects consumer.\n */\nfunction flushAfterPaintEffects() {\n\tlet component;\n\twhile ((component = afterPaintEffects.shift())) {\n\t\tif (!component._parentDom || !component.__hooks) continue;\n\t\ttry {\n\t\t\tcomponent.__hooks._pendingEffects.forEach(invokeCleanup);\n\t\t\tcomponent.__hooks._pendingEffects.forEach(invokeEffect);\n\t\t\tcomponent.__hooks._pendingEffects = [];\n\t\t} catch (e) {\n\t\t\tcomponent.__hooks._pendingEffects = [];\n\t\t\toptions._catchError(e, component._vnode);\n\t\t}\n\t}\n}\n\nlet HAS_RAF = typeof requestAnimationFrame == 'function';\n\n/**\n * Schedule a callback to be invoked after the browser has a chance to paint a new frame.\n * Do this by combining requestAnimationFrame (rAF) + setTimeout to invoke a callback after\n * the next browser frame.\n *\n * Also, schedule a timeout in parallel to the the rAF to ensure the callback is invoked\n * even if RAF doesn't fire (for example if the browser tab is not visible)\n *\n * @param {() => void} callback\n */\nfunction afterNextFrame(callback) {\n\tconst done = () => {\n\t\tclearTimeout(timeout);\n\t\tif (HAS_RAF) cancelAnimationFrame(raf);\n\t\tsetTimeout(callback);\n\t};\n\tconst timeout = setTimeout(done, RAF_TIMEOUT);\n\n\tlet raf;\n\tif (HAS_RAF) {\n\t\traf = requestAnimationFrame(done);\n\t}\n}\n\n// Note: if someone used options.debounceRendering = requestAnimationFrame,\n// then effects will ALWAYS run on the NEXT frame instead of the current one, incurring a ~16ms delay.\n// Perhaps this is not such a big deal.\n/**\n * Schedule afterPaintEffects flush after the browser paints\n * @param {number} newQueueLength\n * @returns {void}\n */\nfunction afterPaint(newQueueLength) {\n\tif (newQueueLength === 1 || prevRaf !== options.requestAnimationFrame) {\n\t\tprevRaf = options.requestAnimationFrame;\n\t\t(prevRaf || afterNextFrame)(flushAfterPaintEffects);\n\t}\n}\n\n/**\n * @param {import('./internal').HookState} hook\n * @returns {void}\n */\nfunction invokeCleanup(hook) {\n\t// A hook cleanup can introduce a call to render which creates a new root, this will call options.vnode\n\t// and move the currentComponent away.\n\tconst comp = currentComponent;\n\tlet cleanup = hook._cleanup;\n\tif (typeof cleanup == 'function') {\n\t\thook._cleanup = undefined;\n\t\tcleanup();\n\t}\n\n\tcurrentComponent = comp;\n}\n\n/**\n * Invoke a Hook's effect\n * @param {import('./internal').EffectHookState} hook\n * @returns {void}\n */\nfunction invokeEffect(hook) {\n\t// A hook call can introduce a call to render which creates a new root, this will call options.vnode\n\t// and move the currentComponent away.\n\tconst comp = currentComponent;\n\thook._cleanup = hook._value();\n\tcurrentComponent = comp;\n}\n\n/**\n * @param {unknown[]} oldArgs\n * @param {unknown[]} newArgs\n * @returns {boolean}\n */\nfunction argsChanged(oldArgs, newArgs) {\n\treturn (\n\t\t!oldArgs ||\n\t\toldArgs.length !== newArgs.length ||\n\t\tnewArgs.some((arg, index) => arg !== oldArgs[index])\n\t);\n}\n\n/**\n * @template Arg\n * @param {Arg} arg\n * @param {(arg: Arg) => any} f\n * @returns {any}\n */\nfunction invokeOrReturn(arg, f) {\n\treturn typeof f == 'function' ? f(arg) : f;\n}\n","/**\n * Assign properties from `props` to `obj`\n * @template O, P The obj and props types\n * @param {O} obj The object to copy properties to\n * @param {P} props The object to copy properties from\n * @returns {O & P}\n */\nexport function assign(obj, props) {\n\tfor (let i in props) obj[i] = props[i];\n\treturn /** @type {O & P} */ (obj);\n}\n\n/**\n * Check if two objects have a different shape\n * @param {object} a\n * @param {object} b\n * @returns {boolean}\n */\nexport function shallowDiffers(a, b) {\n\tfor (let i in a) if (i !== '__source' && !(i in b)) return true;\n\tfor (let i in b) if (i !== '__source' && a[i] !== b[i]) return true;\n\treturn false;\n}\n\n/**\n * Check if two values are the same value\n * @param {*} x\n * @param {*} y\n * @returns {boolean}\n */\nexport function is(x, y) {\n\treturn (x === y && (x !== 0 || 1 / x === 1 / y)) || (x !== x && y !== y);\n}\n","import { Component } from 'preact';\nimport { shallowDiffers } from './util';\n\n/**\n * Component class with a predefined `shouldComponentUpdate` implementation\n */\nexport function PureComponent(p, c) {\n\tthis.props = p;\n\tthis.context = c;\n}\nPureComponent.prototype = new Component();\n// Some third-party libraries check if this property is present\nPureComponent.prototype.isPureReactComponent = true;\nPureComponent.prototype.shouldComponentUpdate = function (props, state) {\n\treturn shallowDiffers(this.props, props) || shallowDiffers(this.state, state);\n};\n","import { createElement } from 'preact';\nimport { shallowDiffers } from './util';\n\n/**\n * Memoize a component, so that it only updates when the props actually have\n * changed. This was previously known as `React.pure`.\n * @param {import('./internal').FunctionComponent} c functional component\n * @param {(prev: object, next: object) => boolean} [comparer] Custom equality function\n * @returns {import('./internal').FunctionComponent}\n */\nexport function memo(c, comparer) {\n\tfunction shouldUpdate(nextProps) {\n\t\tlet ref = this.props.ref;\n\t\tlet updateRef = ref == nextProps.ref;\n\t\tif (!updateRef && ref) {\n\t\t\tref.call ? ref(null) : (ref.current = null);\n\t\t}\n\n\t\tif (!comparer) {\n\t\t\treturn shallowDiffers(this.props, nextProps);\n\t\t}\n\n\t\treturn !comparer(this.props, nextProps) || !updateRef;\n\t}\n\n\tfunction Memoed(props) {\n\t\tthis.shouldComponentUpdate = shouldUpdate;\n\t\treturn createElement(c, props);\n\t}\n\tMemoed.displayName = 'Memo(' + (c.displayName || c.name) + ')';\n\tMemoed.prototype.isReactComponent = true;\n\tMemoed._forwarded = true;\n\treturn Memoed;\n}\n","import { options } from 'preact';\n\nlet oldDiffHook = options._diff;\noptions._diff = vnode => {\n\tif (vnode.type && vnode.type._forwarded && vnode.ref) {\n\t\tvnode.props.ref = vnode.ref;\n\t\tvnode.ref = null;\n\t}\n\tif (oldDiffHook) oldDiffHook(vnode);\n};\n\nexport const REACT_FORWARD_SYMBOL =\n\t(typeof Symbol != 'undefined' &&\n\t\tSymbol.for &&\n\t\tSymbol.for('react.forward_ref')) ||\n\t0xf47;\n\n/**\n * Pass ref down to a child. This is mainly used in libraries with HOCs that\n * wrap components. Using `forwardRef` there is an easy way to get a reference\n * of the wrapped component instead of one of the wrapper itself.\n * @param {import('./index').ForwardFn} fn\n * @returns {import('./internal').FunctionComponent}\n */\nexport function forwardRef(fn) {\n\tfunction Forwarded(props) {\n\t\tif (!('ref' in props)) return fn(props, null);\n\n\t\tlet ref = props.ref;\n\t\tdelete props.ref;\n\t\tconst result = fn(props, ref);\n\t\tprops.ref = ref;\n\t\treturn result;\n\t}\n\n\t// mobx-react checks for this being present\n\tForwarded.$$typeof = REACT_FORWARD_SYMBOL;\n\t// mobx-react heavily relies on implementation details.\n\t// It expects an object here with a `render` property,\n\t// and prototype.render will fail. Without this\n\t// mobx-react throws.\n\tForwarded.render = Forwarded;\n\n\tForwarded.prototype.isReactComponent = Forwarded._forwarded = true;\n\tForwarded.displayName = 'ForwardRef(' + (fn.displayName || fn.name) + ')';\n\treturn Forwarded;\n}\n","import { toChildArray } from 'preact';\n\nconst mapFn = (children, fn) => {\n\tif (children == null) return null;\n\treturn toChildArray(toChildArray(children).map(fn));\n};\n\n// This API is completely unnecessary for Preact, so it's basically passthrough.\nexport const Children = {\n\tmap: mapFn,\n\tforEach: mapFn,\n\tcount(children) {\n\t\treturn children ? toChildArray(children).length : 0;\n\t},\n\tonly(children) {\n\t\tconst normalized = toChildArray(children);\n\t\tif (normalized.length !== 1) throw 'Children.only';\n\t\treturn normalized[0];\n\t},\n\ttoArray: toChildArray\n};\n","import { Component, createElement, options, Fragment } from 'preact';\nimport { MODE_HYDRATE } from '../../src/constants';\nimport { assign } from './util';\n\nconst oldCatchError = options._catchError;\noptions._catchError = function (error, newVNode, oldVNode, errorInfo) {\n\tif (error.then) {\n\t\t/** @type {import('./internal').Component} */\n\t\tlet component;\n\t\tlet vnode = newVNode;\n\n\t\tfor (; (vnode = vnode._parent); ) {\n\t\t\tif ((component = vnode._component) && component._childDidSuspend) {\n\t\t\t\tif (newVNode._dom == null) {\n\t\t\t\t\tnewVNode._dom = oldVNode._dom;\n\t\t\t\t\tnewVNode._children = oldVNode._children;\n\t\t\t\t}\n\t\t\t\t// Don't call oldCatchError if we found a Suspense\n\t\t\t\treturn component._childDidSuspend(error, newVNode);\n\t\t\t}\n\t\t}\n\t}\n\toldCatchError(error, newVNode, oldVNode, errorInfo);\n};\n\nconst oldUnmount = options.unmount;\noptions.unmount = function (vnode) {\n\t/** @type {import('./internal').Component} */\n\tconst component = vnode._component;\n\tif (component && component._onResolve) {\n\t\tcomponent._onResolve();\n\t}\n\n\t// if the component is still hydrating\n\t// most likely it is because the component is suspended\n\t// we set the vnode.type as `null` so that it is not a typeof function\n\t// so the unmount will remove the vnode._dom\n\tif (component && vnode._flags & MODE_HYDRATE) {\n\t\tvnode.type = null;\n\t}\n\n\tif (oldUnmount) oldUnmount(vnode);\n};\n\nfunction detachedClone(vnode, detachedParent, parentDom) {\n\tif (vnode) {\n\t\tif (vnode._component && vnode._component.__hooks) {\n\t\t\tvnode._component.__hooks._list.forEach(effect => {\n\t\t\t\tif (typeof effect._cleanup == 'function') effect._cleanup();\n\t\t\t});\n\n\t\t\tvnode._component.__hooks = null;\n\t\t}\n\n\t\tvnode = assign({}, vnode);\n\t\tif (vnode._component != null) {\n\t\t\tif (vnode._component._parentDom === parentDom) {\n\t\t\t\tvnode._component._parentDom = detachedParent;\n\t\t\t}\n\t\t\tvnode._component = null;\n\t\t}\n\n\t\tvnode._children =\n\t\t\tvnode._children &&\n\t\t\tvnode._children.map(child =>\n\t\t\t\tdetachedClone(child, detachedParent, parentDom)\n\t\t\t);\n\t}\n\n\treturn vnode;\n}\n\nfunction removeOriginal(vnode, detachedParent, originalParent) {\n\tif (vnode && originalParent) {\n\t\tvnode._original = null;\n\t\tvnode._children =\n\t\t\tvnode._children &&\n\t\t\tvnode._children.map(child =>\n\t\t\t\tremoveOriginal(child, detachedParent, originalParent)\n\t\t\t);\n\n\t\tif (vnode._component) {\n\t\t\tif (vnode._component._parentDom === detachedParent) {\n\t\t\t\tif (vnode._dom) {\n\t\t\t\t\toriginalParent.appendChild(vnode._dom);\n\t\t\t\t}\n\t\t\t\tvnode._component._force = true;\n\t\t\t\tvnode._component._parentDom = originalParent;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn vnode;\n}\n\n// having custom inheritance instead of a class here saves a lot of bytes\nexport function Suspense() {\n\t// we do not call super here to golf some bytes...\n\tthis._pendingSuspensionCount = 0;\n\tthis._suspenders = null;\n\tthis._detachOnNextRender = null;\n}\n\n// Things we do here to save some bytes but are not proper JS inheritance:\n// - call `new Component()` as the prototype\n// - do not set `Suspense.prototype.constructor` to `Suspense`\nSuspense.prototype = new Component();\n\n/**\n * @this {import('./internal').SuspenseComponent}\n * @param {Promise} promise The thrown promise\n * @param {import('./internal').VNode<any, any>} suspendingVNode The suspending component\n */\nSuspense.prototype._childDidSuspend = function (promise, suspendingVNode) {\n\tconst suspendingComponent = suspendingVNode._component;\n\n\t/** @type {import('./internal').SuspenseComponent} */\n\tconst c = this;\n\n\tif (c._suspenders == null) {\n\t\tc._suspenders = [];\n\t}\n\tc._suspenders.push(suspendingComponent);\n\n\tconst resolve = suspended(c._vnode);\n\n\tlet resolved = false;\n\tconst onResolved = () => {\n\t\tif (resolved) return;\n\n\t\tresolved = true;\n\t\tsuspendingComponent._onResolve = null;\n\n\t\tif (resolve) {\n\t\t\tresolve(onSuspensionComplete);\n\t\t} else {\n\t\t\tonSuspensionComplete();\n\t\t}\n\t};\n\n\tsuspendingComponent._onResolve = onResolved;\n\n\tconst onSuspensionComplete = () => {\n\t\tif (!--c._pendingSuspensionCount) {\n\t\t\t// If the suspension was during hydration we don't need to restore the\n\t\t\t// suspended children into the _children array\n\t\t\tif (c.state._suspended) {\n\t\t\t\tconst suspendedVNode = c.state._suspended;\n\t\t\t\tc._vnode._children[0] = removeOriginal(\n\t\t\t\t\tsuspendedVNode,\n\t\t\t\t\tsuspendedVNode._component._parentDom,\n\t\t\t\t\tsuspendedVNode._component._originalParentDom\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tc.setState({ _suspended: (c._detachOnNextRender = null) });\n\n\t\t\tlet suspended;\n\t\t\twhile ((suspended = c._suspenders.pop())) {\n\t\t\t\tsuspended.forceUpdate();\n\t\t\t}\n\t\t}\n\t};\n\n\t/**\n\t * We do not set `suspended: true` during hydration because we want the actual markup\n\t * to remain on screen and hydrate it when the suspense actually gets resolved.\n\t * While in non-hydration cases the usual fallback -> component flow would occour.\n\t */\n\tif (\n\t\t!c._pendingSuspensionCount++ &&\n\t\t!(suspendingVNode._flags & MODE_HYDRATE)\n\t) {\n\t\tc.setState({ _suspended: (c._detachOnNextRender = c._vnode._children[0]) });\n\t}\n\tpromise.then(onResolved, onResolved);\n};\n\nSuspense.prototype.componentWillUnmount = function () {\n\tthis._suspenders = [];\n};\n\n/**\n * @this {import('./internal').SuspenseComponent}\n * @param {import('./internal').SuspenseComponent[\"props\"]} props\n * @param {import('./internal').SuspenseState} state\n */\nSuspense.prototype.render = function (props, state) {\n\tif (this._detachOnNextRender) {\n\t\t// When the Suspense's _vnode was created by a call to createVNode\n\t\t// (i.e. due to a setState further up in the tree)\n\t\t// it's _children prop is null, in this case we \"forget\" about the parked vnodes to detach\n\t\tif (this._vnode._children) {\n\t\t\tconst detachedParent = document.createElement('div');\n\t\t\tconst detachedComponent = this._vnode._children[0]._component;\n\t\t\tthis._vnode._children[0] = detachedClone(\n\t\t\t\tthis._detachOnNextRender,\n\t\t\t\tdetachedParent,\n\t\t\t\t(detachedComponent._originalParentDom = detachedComponent._parentDom)\n\t\t\t);\n\t\t}\n\n\t\tthis._detachOnNextRender = null;\n\t}\n\n\t// Wrap fallback tree in a VNode that prevents itself from being marked as aborting mid-hydration:\n\t/** @type {import('./internal').VNode} */\n\tconst fallback =\n\t\tstate._suspended && createElement(Fragment, null, props.fallback);\n\tif (fallback) fallback._flags &= ~MODE_HYDRATE;\n\n\treturn [\n\t\tcreateElement(Fragment, null, state._suspended ? null : props.children),\n\t\tfallback\n\t];\n};\n\n/**\n * Checks and calls the parent component's _suspended method, passing in the\n * suspended vnode. This is a way for a parent (e.g. SuspenseList) to get notified\n * that one of its children/descendants suspended.\n *\n * The parent MAY return a callback. The callback will get called when the\n * suspension resolves, notifying the parent of the fact.\n * Moreover, the callback gets function `unsuspend` as a parameter. The resolved\n * child descendant will not actually get unsuspended until `unsuspend` gets called.\n * This is a way for the parent to delay unsuspending.\n *\n * If the parent does not return a callback then the resolved vnode\n * gets unsuspended immediately when it resolves.\n *\n * @param {import('./internal').VNode} vnode\n * @returns {((unsuspend: () => void) => void)?}\n */\nexport function suspended(vnode) {\n\t/** @type {import('./internal').Component} */\n\tlet component = vnode._parent._component;\n\treturn component && component._suspended && component._suspended(vnode);\n}\n\nexport function lazy(loader) {\n\tlet prom;\n\tlet component;\n\tlet error;\n\n\tfunction Lazy(props) {\n\t\tif (!prom) {\n\t\t\tprom = loader();\n\t\t\tprom.then(\n\t\t\t\texports => {\n\t\t\t\t\tcomponent = exports.default || exports;\n\t\t\t\t},\n\t\t\t\te => {\n\t\t\t\t\terror = e;\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\n\t\tif (!component) {\n\t\t\tthrow prom;\n\t\t}\n\n\t\treturn createElement(component, props);\n\t}\n\n\tLazy.displayName = 'Lazy';\n\tLazy._forwarded = true;\n\treturn Lazy;\n}\n","import { Component, toChildArray } from 'preact';\nimport { suspended } from './suspense.js';\n\n// Indexes to linked list nodes (nodes are stored as arrays to save bytes).\nconst SUSPENDED_COUNT = 0;\nconst RESOLVED_COUNT = 1;\nconst NEXT_NODE = 2;\n\n// Having custom inheritance instead of a class here saves a lot of bytes.\nexport function SuspenseList() {\n\tthis._next = null;\n\tthis._map = null;\n}\n\n// Mark one of child's earlier suspensions as resolved.\n// Some pending callbacks may become callable due to this\n// (e.g. the last suspended descendant gets resolved when\n// revealOrder === 'together'). Process those callbacks as well.\nconst resolve = (list, child, node) => {\n\tif (++node[RESOLVED_COUNT] === node[SUSPENDED_COUNT]) {\n\t\t// The number a child (or any of its descendants) has been suspended\n\t\t// matches the number of times it's been resolved. Therefore we\n\t\t// mark the child as completely resolved by deleting it from ._map.\n\t\t// This is used to figure out when *all* children have been completely\n\t\t// resolved when revealOrder is 'together'.\n\t\tlist._map.delete(child);\n\t}\n\n\t// If revealOrder is falsy then we can do an early exit, as the\n\t// callbacks won't get queued in the node anyway.\n\t// If revealOrder is 'together' then also do an early exit\n\t// if all suspended descendants have not yet been resolved.\n\tif (\n\t\t!list.props.revealOrder ||\n\t\t(list.props.revealOrder[0] === 't' && list._map.size)\n\t) {\n\t\treturn;\n\t}\n\n\t// Walk the currently suspended children in order, calling their\n\t// stored callbacks on the way. Stop if we encounter a child that\n\t// has not been completely resolved yet.\n\tnode = list._next;\n\twhile (node) {\n\t\twhile (node.length > 3) {\n\t\t\tnode.pop()();\n\t\t}\n\t\tif (node[RESOLVED_COUNT] < node[SUSPENDED_COUNT]) {\n\t\t\tbreak;\n\t\t}\n\t\tlist._next = node = node[NEXT_NODE];\n\t}\n};\n\n// Things we do here to save some bytes but are not proper JS inheritance:\n// - call `new Component()` as the prototype\n// - do not set `Suspense.prototype.constructor` to `Suspense`\nSuspenseList.prototype = new Component();\n\nSuspenseList.prototype._suspended = function (child) {\n\tconst list = this;\n\tconst delegated = suspended(list._vnode);\n\n\tlet node = list._map.get(child);\n\tnode[SUSPENDED_COUNT]++;\n\n\treturn unsuspend => {\n\t\tconst wrappedUnsuspend = () => {\n\t\t\tif (!list.props.revealOrder) {\n\t\t\t\t// Special case the undefined (falsy) revealOrder, as there\n\t\t\t\t// is no need to coordinate a specific order or unsuspends.\n\t\t\t\tunsuspend();\n\t\t\t} else {\n\t\t\t\tnode.push(unsuspend);\n\t\t\t\tresolve(list, child, node);\n\t\t\t}\n\t\t};\n\t\tif (delegated) {\n\t\t\tdelegated(wrappedUnsuspend);\n\t\t} else {\n\t\t\twrappedUnsuspend();\n\t\t}\n\t};\n};\n\nSuspenseList.prototype.render = function (props) {\n\tthis._next = null;\n\tthis._map = new Map();\n\n\tconst children = toChildArray(props.children);\n\tif (props.revealOrder && props.revealOrder[0] === 'b') {\n\t\t// If order === 'backwards' (or, well, anything starting with a 'b')\n\t\t// then flip the child list around so that the last child will be\n\t\t// the first in the linked list.\n\t\tchildren.reverse();\n\t}\n\t// Build the linked list. Iterate through the children in reverse order\n\t// so that `_next` points to the first linked list node to be resolved.\n\tfor (let i = children.length; i--; ) {\n\t\t// Create a new linked list node as an array of form:\n\t\t// \t[suspended_count, resolved_count, next_node]\n\t\t// where suspended_count and resolved_count are numeric counters for\n\t\t// keeping track how many times a node has been suspended and resolved.\n\t\t//\n\t\t// Note that suspended_count starts from 1 instead of 0, so we can block\n\t\t// processing callbacks until componentDidMount has been called. In a sense\n\t\t// node is suspended at least until componentDidMount gets called!\n\t\t//\n\t\t// Pending callbacks are added to the end of the node:\n\t\t// \t[suspended_count, resolved_count, next_node, callback_0, callback_1, ...]\n\t\tthis._map.set(children[i], (this._next = [1, 0, this._next]));\n\t}\n\treturn props.children;\n};\n\nSuspenseList.prototype.componentDidUpdate =\n\tSuspenseList.prototype.componentDidMount = function () {\n\t\t// Iterate through all children after mounting for two reasons:\n\t\t// 1. As each node[SUSPENDED_COUNT] starts from 1, this iteration increases\n\t\t//    each node[RELEASED_COUNT] by 1, therefore balancing the counters.\n\t\t//    The nodes can now be completely consumed from the linked list.\n\t\t// 2. Handle nodes that might have gotten resolved between render and\n\t\t//    componentDidMount.\n\t\tthis._map.forEach((node, child) => {\n\t\t\tresolve(this, child, node);\n\t\t});\n\t};\n","import { createElement, render } from 'preact';\n\n/**\n * @param {import('../../src/index').RenderableProps<{ context: any }>} props\n */\nfunction ContextProvider(props) {\n\tthis.getChildContext = () => props.context;\n\treturn props.children;\n}\n\n/**\n * Portal component\n * @this {import('./internal').Component}\n * @param {object | null | undefined} props\n *\n * TODO: use createRoot() instead of fake root\n */\nfunction Portal(props) {\n\tconst _this = this;\n\tlet container = props._container;\n\n\t_this.componentWillUnmount = function () {\n\t\trender(null, _this._temp);\n\t\t_this._temp = null;\n\t\t_this._container = null;\n\t};\n\n\t// When we change container we should clear our old container and\n\t// indicate a new mount.\n\tif (_this._container && _this._container !== container) {\n\t\t_this.componentWillUnmount();\n\t}\n\n\tif (!_this._temp) {\n\t\t_this._container = container;\n\n\t\t// Create a fake DOM parent node that manages a subset of `container`'s children:\n\t\t_this._temp = {\n\t\t\tnodeType: 1,\n\t\t\tparentNode: container,\n\t\t\tchildNodes: [],\n\t\t\tcontains: () => true,\n\t\t\tappendChild(child) {\n\t\t\t\tthis.childNodes.push(child);\n\t\t\t\t_this._container.appendChild(child);\n\t\t\t},\n\t\t\tinsertBefore(child, before) {\n\t\t\t\tthis.childNodes.push(child);\n\t\t\t\t_this._container.appendChild(child);\n\t\t\t},\n\t\t\tremoveChild(child) {\n\t\t\t\tthis.childNodes.splice(this.childNodes.indexOf(child) >>> 1, 1);\n\t\t\t\t_this._container.removeChild(child);\n\t\t\t}\n\t\t};\n\t}\n\n\t// Render our wrapping element into temp.\n\trender(\n\t\tcreateElement(ContextProvider, { context: _this.context }, props._vnode),\n\t\t_this._temp\n\t);\n}\n\n/**\n * Create a `Portal` to continue rendering the vnode tree at a different DOM node\n * @param {import('./internal').VNode} vnode The vnode to render\n * @param {import('./internal').PreactElement} container The DOM node to continue rendering in to.\n */\nexport function createPortal(vnode, container) {\n\tconst el = createElement(Portal, { _vnode: vnode, _container: container });\n\tel.containerInfo = container;\n\treturn el;\n}\n","import {\n\trender as preactRender,\n\thydrate as preactHydrate,\n\toptions,\n\ttoChildArray,\n\tComponent\n} from 'preact';\nimport {\n\tuseCallback,\n\tuseContext,\n\tuseDebugValue,\n\tuseEffect,\n\tuseId,\n\tuseImperativeHandle,\n\tuseLayoutEffect,\n\tuseMemo,\n\tuseReducer,\n\tuseRef,\n\tuseState\n} from 'preact/hooks';\nimport {\n\tuseDeferredValue,\n\tuseInsertionEffect,\n\tuseSyncExternalStore,\n\tuseTransition\n} from './index';\n\nexport const REACT_ELEMENT_TYPE =\n\t(typeof Symbol != 'undefined' && Symbol.for && Symbol.for('react.element')) ||\n\t0xeac7;\n\nconst CAMEL_PROPS =\n\t/^(?:accent|alignment|arabic|baseline|cap|clip(?!PathU)|color|dominant|fill|flood|font|glyph(?!R)|horiz|image(!S)|letter|lighting|marker(?!H|W|U)|overline|paint|pointer|shape|stop|strikethrough|stroke|text(?!L)|transform|underline|unicode|units|v|vector|vert|word|writing|x(?!C))[A-Z]/;\nconst ON_ANI = /^on(Ani|Tra|Tou|BeforeInp|Compo)/;\nconst CAMEL_REPLACE = /[A-Z0-9]/g;\nconst IS_DOM = typeof document !== 'undefined';\n\n// Input types for which onchange should not be converted to oninput.\n// type=\"file|checkbox|radio\", plus \"range\" in IE11.\n// (IE11 doesn't support Symbol, which we use here to turn `rad` into `ra` which matches \"range\")\nconst onChangeInputType = type =>\n\t(typeof Symbol != 'undefined' && typeof Symbol() == 'symbol'\n\t\t? /fil|che|rad/\n\t\t: /fil|che|ra/\n\t).test(type);\n\n// Some libraries like `react-virtualized` explicitly check for this.\nComponent.prototype.isReactComponent = {};\n\n// `UNSAFE_*` lifecycle hooks\n// Preact only ever invokes the unprefixed methods.\n// Here we provide a base \"fallback\" implementation that calls any defined UNSAFE_ prefixed method.\n// - If a component defines its own `componentDidMount()` (including via defineProperty), use that.\n// - If a component defines `UNSAFE_componentDidMount()`, `componentDidMount` is the alias getter/setter.\n// - If anything assigns to an `UNSAFE_*` property, the assignment is forwarded to the unprefixed property.\n// See https://github.com/preactjs/preact/issues/1941\n[\n\t'componentWillMount',\n\t'componentWillReceiveProps',\n\t'componentWillUpdate'\n].forEach(key => {\n\tObject.defineProperty(Component.prototype, key, {\n\t\tconfigurable: true,\n\t\tget() {\n\t\t\treturn this['UNSAFE_' + key];\n\t\t},\n\t\tset(v) {\n\t\t\tObject.defineProperty(this, key, {\n\t\t\t\tconfigurable: true,\n\t\t\t\twritable: true,\n\t\t\t\tvalue: v\n\t\t\t});\n\t\t}\n\t});\n});\n\n/**\n * Proxy render() since React returns a Component reference.\n * @param {import('./internal').VNode} vnode VNode tree to render\n * @param {import('./internal').PreactElement} parent DOM node to render vnode tree into\n * @param {() => void} [callback] Optional callback that will be called after rendering\n * @returns {import('./internal').Component | null} The root component reference or null\n */\nexport function render(vnode, parent, callback) {\n\t// React destroys any existing DOM nodes, see #1727\n\t// ...but only on the first render, see #1828\n\tif (parent._children == null) {\n\t\tparent.textContent = '';\n\t}\n\n\tpreactRender(vnode, parent);\n\tif (typeof callback == 'function') callback();\n\n\treturn vnode ? vnode._component : null;\n}\n\nexport function hydrate(vnode, parent, callback) {\n\tpreactHydrate(vnode, parent);\n\tif (typeof callback == 'function') callback();\n\n\treturn vnode ? vnode._component : null;\n}\n\nlet oldEventHook = options.event;\noptions.event = e => {\n\tif (oldEventHook) e = oldEventHook(e);\n\n\te.persist = empty;\n\te.isPropagationStopped = isPropagationStopped;\n\te.isDefaultPrevented = isDefaultPrevented;\n\treturn (e.nativeEvent = e);\n};\n\nfunction empty() {}\n\nfunction isPropagationStopped() {\n\treturn this.cancelBubble;\n}\n\nfunction isDefaultPrevented() {\n\treturn this.defaultPrevented;\n}\n\nconst classNameDescriptorNonEnumberable = {\n\tenumerable: false,\n\tconfigurable: true,\n\tget() {\n\t\treturn this.class;\n\t}\n};\n\nfunction handleDomVNode(vnode) {\n\tlet props = vnode.props,\n\t\ttype = vnode.type,\n\t\tnormalizedProps = {};\n\n\tlet isNonDashedType = type.indexOf('-') === -1;\n\tfor (let i in props) {\n\t\tlet value = props[i];\n\n\t\tif (\n\t\t\t(i === 'value' && 'defaultValue' in props && value == null) ||\n\t\t\t// Emulate React's behavior of not rendering the contents of noscript tags on the client.\n\t\t\t(IS_DOM && i === 'children' && type === 'noscript') ||\n\t\t\ti === 'class' ||\n\t\t\ti === 'className'\n\t\t) {\n\t\t\t// Skip applying value if it is null/undefined and we already set\n\t\t\t// a default value\n\t\t\tcontinue;\n\t\t}\n\n\t\tlet lowerCased = i.toLowerCase();\n\t\tif (i === 'defaultValue' && 'value' in props && props.value == null) {\n\t\t\t// `defaultValue` is treated as a fallback `value` when a value prop is present but null/undefined.\n\t\t\t// `defaultValue` for Elements with no value prop is the same as the DOM defaultValue property.\n\t\t\ti = 'value';\n\t\t} else if (i === 'download' && value === true) {\n\t\t\t// Calling `setAttribute` with a truthy value will lead to it being\n\t\t\t// passed as a stringified value, e.g. `download=\"true\"`. React\n\t\t\t// converts it to an empty string instead, otherwise the attribute\n\t\t\t// value will be used as the file name and the file will be called\n\t\t\t// \"true\" upon downloading it.\n\t\t\tvalue = '';\n\t\t} else if (lowerCased === 'translate' && value === 'no') {\n\t\t\tvalue = false;\n\t\t} else if (lowerCased[0] === 'o' && lowerCased[1] === 'n') {\n\t\t\tif (lowerCased === 'ondoubleclick') {\n\t\t\t\ti = 'ondblclick';\n\t\t\t} else if (\n\t\t\t\tlowerCased === 'onchange' &&\n\t\t\t\t(type === 'input' || type === 'textarea') &&\n\t\t\t\t!onChangeInputType(props.type)\n\t\t\t) {\n\t\t\t\tlowerCased = i = 'oninput';\n\t\t\t} else if (lowerCased === 'onfocus') {\n\t\t\t\ti = 'onfocusin';\n\t\t\t} else if (lowerCased === 'onblur') {\n\t\t\t\ti = 'onfocusout';\n\t\t\t} else if (ON_ANI.test(i)) {\n\t\t\t\ti = lowerCased;\n\t\t\t}\n\t\t} else if (isNonDashedType && CAMEL_PROPS.test(i)) {\n\t\t\ti = i.replace(CAMEL_REPLACE, '-$&').toLowerCase();\n\t\t} else if (value === null) {\n\t\t\tvalue = undefined;\n\t\t}\n\n\t\t// Add support for onInput and onChange, see #3561\n\t\t// if we have an oninput prop already change it to oninputCapture\n\t\tif (lowerCased === 'oninput') {\n\t\t\ti = lowerCased;\n\t\t\tif (normalizedProps[i]) {\n\t\t\t\ti = 'oninputCapture';\n\t\t\t}\n\t\t}\n\n\t\tnormalizedProps[i] = value;\n\t}\n\n\t// Add support for array select values: <select multiple value={[]} />\n\tif (\n\t\ttype == 'select' &&\n\t\tnormalizedProps.multiple &&\n\t\tArray.isArray(normalizedProps.value)\n\t) {\n\t\t// forEach() always returns undefined, which we abuse here to unset the value prop.\n\t\tnormalizedProps.value = toChildArray(props.children).forEach(child => {\n\t\t\tchild.props.selected =\n\t\t\t\tnormalizedProps.value.indexOf(child.props.value) != -1;\n\t\t});\n\t}\n\n\t// Adding support for defaultValue in select tag\n\tif (type == 'select' && normalizedProps.defaultValue != null) {\n\t\tnormalizedProps.value = toChildArray(props.children).forEach(child => {\n\t\t\tif (normalizedProps.multiple) {\n\t\t\t\tchild.props.selected =\n\t\t\t\t\tnormalizedProps.defaultValue.indexOf(child.props.value) != -1;\n\t\t\t} else {\n\t\t\t\tchild.props.selected =\n\t\t\t\t\tnormalizedProps.defaultValue == child.props.value;\n\t\t\t}\n\t\t});\n\t}\n\n\tif (props.class && !props.className) {\n\t\tnormalizedProps.class = props.class;\n\t\tObject.defineProperty(\n\t\t\tnormalizedProps,\n\t\t\t'className',\n\t\t\tclassNameDescriptorNonEnumberable\n\t\t);\n\t} else if (props.className && !props.class) {\n\t\tnormalizedProps.class = normalizedProps.className = props.className;\n\t} else if (props.class && props.className) {\n\t\tnormalizedProps.class = normalizedProps.className = props.className;\n\t}\n\n\tvnode.props = normalizedProps;\n}\n\nlet oldVNodeHook = options.vnode;\noptions.vnode = vnode => {\n\t// only normalize props on Element nodes\n\tif (typeof vnode.type === 'string') {\n\t\thandleDomVNode(vnode);\n\t}\n\n\tvnode.$$typeof = REACT_ELEMENT_TYPE;\n\n\tif (oldVNodeHook) oldVNodeHook(vnode);\n};\n\n// Only needed for react-relay\nlet currentComponent;\nconst oldBeforeRender = options._render;\noptions._render = function (vnode) {\n\tif (oldBeforeRender) {\n\t\toldBeforeRender(vnode);\n\t}\n\tcurrentComponent = vnode._component;\n};\n\nconst oldDiffed = options.diffed;\n/** @type {(vnode: import('./internal').VNode) => void} */\noptions.diffed = function (vnode) {\n\tif (oldDiffed) {\n\t\toldDiffed(vnode);\n\t}\n\n\tconst props = vnode.props;\n\tconst dom = vnode._dom;\n\n\tif (\n\t\tdom != null &&\n\t\tvnode.type === 'textarea' &&\n\t\t'value' in props &&\n\t\tprops.value !== dom.value\n\t) {\n\t\tdom.value = props.value == null ? '' : props.value;\n\t}\n\n\tcurrentComponent = null;\n};\n\n// This is a very very private internal function for React it\n// is used to sort-of do runtime dependency injection.\nexport const __SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED = {\n\tReactCurrentDispatcher: {\n\t\tcurrent: {\n\t\t\treadContext(context) {\n\t\t\t\treturn currentComponent._globalContext[context._id].props.value;\n\t\t\t},\n\t\t\tuseCallback,\n\t\t\tuseContext,\n\t\t\tuseDebugValue,\n\t\t\tuseDeferredValue,\n\t\t\tuseEffect,\n\t\t\tuseId,\n\t\t\tuseImperativeHandle,\n\t\t\tuseInsertionEffect,\n\t\t\tuseLayoutEffect,\n\t\t\tuseMemo,\n\t\t\t// useMutableSource, // experimental-only and replaced by uSES, likely not worth supporting\n\t\t\tuseReducer,\n\t\t\tuseRef,\n\t\t\tuseState,\n\t\t\tuseSyncExternalStore,\n\t\t\tuseTransition\n\t\t}\n\t}\n};\n","import {\n\tcreateElement,\n\trender as preactRender,\n\tcloneElement as preactCloneElement,\n\tcreateRef,\n\tComponent,\n\tcreateContext,\n\tFragment\n} from 'preact';\nimport {\n\tuseState,\n\tuseId,\n\tuseReducer,\n\tuseEffect,\n\tuseLayoutEffect,\n\tuseRef,\n\tuseImperativeHandle,\n\tuseMemo,\n\tuseCallback,\n\tuseContext,\n\tuseDebugValue\n} from 'preact/hooks';\nimport { PureComponent } from './PureComponent';\nimport { memo } from './memo';\nimport { forwardRef } from './forwardRef';\nimport { Children } from './Children';\nimport { Suspense, lazy } from './suspense';\nimport { SuspenseList } from './suspense-list';\nimport { createPortal } from './portals';\nimport { is } from './util';\nimport {\n\thydrate,\n\trender,\n\tREACT_ELEMENT_TYPE,\n\t__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED\n} from './render';\n\nconst version = '18.3.1'; // trick libraries to think we are react\n\n/**\n * Legacy version of createElement.\n * @param {import('./internal').VNode[\"type\"]} type The node name or Component constructor\n */\nfunction createFactory(type) {\n\treturn createElement.bind(null, type);\n}\n\n/**\n * Check if the passed element is a valid (p)react node.\n * @param {*} element The element to check\n * @returns {boolean}\n */\nfunction isValidElement(element) {\n\treturn !!element && element.$$typeof === REACT_ELEMENT_TYPE;\n}\n\n/**\n * Check if the passed element is a Fragment node.\n * @param {*} element The element to check\n * @returns {boolean}\n */\nfunction isFragment(element) {\n\treturn isValidElement(element) && element.type === Fragment;\n}\n\n/**\n * Check if the passed element is a Memo node.\n * @param {*} element The element to check\n * @returns {boolean}\n */\nfunction isMemo(element) {\n\treturn (\n\t\t!!element &&\n\t\t!!element.displayName &&\n\t\t(typeof element.displayName === 'string' ||\n\t\t\telement.displayName instanceof String) &&\n\t\telement.displayName.startsWith('Memo(')\n\t);\n}\n\n/**\n * Wrap `cloneElement` to abort if the passed element is not a valid element and apply\n * all vnode normalizations.\n * @param {import('./internal').VNode} element The vnode to clone\n * @param {object} props Props to add when cloning\n * @param {Array<import('./internal').ComponentChildren>} rest Optional component children\n */\nfunction cloneElement(element) {\n\tif (!isValidElement(element)) return element;\n\treturn preactCloneElement.apply(null, arguments);\n}\n\n/**\n * Remove a component tree from the DOM, including state and event handlers.\n * @param {import('./internal').PreactElement} container\n * @returns {boolean}\n */\nfunction unmountComponentAtNode(container) {\n\tif (container._children) {\n\t\tpreactRender(null, container);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\n/**\n * Get the matching DOM node for a component\n * @param {import('./internal').Component} component\n * @returns {import('./internal').PreactElement | null}\n */\nfunction findDOMNode(component) {\n\treturn (\n\t\t(component &&\n\t\t\t(component.base || (component.nodeType === 1 && component))) ||\n\t\tnull\n\t);\n}\n\n/**\n * Deprecated way to control batched rendering inside the reconciler, but we\n * already schedule in batches inside our rendering code\n * @template Arg\n * @param {(arg: Arg) => void} callback function that triggers the updated\n * @param {Arg} [arg] Optional argument that can be passed to the callback\n */\n// eslint-disable-next-line camelcase\nconst unstable_batchedUpdates = (callback, arg) => callback(arg);\n\n/**\n * In React, `flushSync` flushes the entire tree and forces a rerender. It's\n * implmented here as a no-op.\n * @template Arg\n * @template Result\n * @param {(arg: Arg) => Result} callback function that runs before the flush\n * @param {Arg} [arg] Optional argument that can be passed to the callback\n * @returns\n */\nconst flushSync = (callback, arg) => callback(arg);\n\n/**\n * Strict Mode is not implemented in Preact, so we provide a stand-in for it\n * that just renders its children without imposing any restrictions.\n */\nconst StrictMode = Fragment;\n\nexport function startTransition(cb) {\n\tcb();\n}\n\nexport function useDeferredValue(val) {\n\treturn val;\n}\n\nexport function useTransition() {\n\treturn [false, startTransition];\n}\n\n// TODO: in theory this should be done after a VNode is diffed as we want to insert\n// styles/... before it attaches\nexport const useInsertionEffect = useLayoutEffect;\n\n// compat to react-is\nexport const isElement = isValidElement;\n\n/**\n * This is taken from https://github.com/facebook/react/blob/main/packages/use-sync-external-store/src/useSyncExternalStoreShimClient.js#L84\n * on a high level this cuts out the warnings, ... and attempts a smaller implementation\n * @typedef {{ _value: any; _getSnapshot: () => any }} Store\n */\nexport function useSyncExternalStore(subscribe, getSnapshot) {\n\tconst value = getSnapshot();\n\n\t/**\n\t * @typedef {{ _instance: Store }} StoreRef\n\t * @type {[StoreRef, (store: StoreRef) => void]}\n\t */\n\tconst [{ _instance }, forceUpdate] = useState({\n\t\t_instance: { _value: value, _getSnapshot: getSnapshot }\n\t});\n\n\tuseLayoutEffect(() => {\n\t\t_instance._value = value;\n\t\t_instance._getSnapshot = getSnapshot;\n\n\t\tif (didSnapshotChange(_instance)) {\n\t\t\tforceUpdate({ _instance });\n\t\t}\n\t}, [subscribe, value, getSnapshot]);\n\n\tuseEffect(() => {\n\t\tif (didSnapshotChange(_instance)) {\n\t\t\tforceUpdate({ _instance });\n\t\t}\n\n\t\treturn subscribe(() => {\n\t\t\tif (didSnapshotChange(_instance)) {\n\t\t\t\tforceUpdate({ _instance });\n\t\t\t}\n\t\t});\n\t}, [subscribe]);\n\n\treturn value;\n}\n\n/** @type {(inst: Store) => boolean} */\nfunction didSnapshotChange(inst) {\n\tconst latestGetSnapshot = inst._getSnapshot;\n\tconst prevValue = inst._value;\n\ttry {\n\t\tconst nextValue = latestGetSnapshot();\n\t\treturn !is(prevValue, nextValue);\n\t} catch (error) {\n\t\treturn true;\n\t}\n}\n\nexport * from 'preact/hooks';\nexport {\n\tversion,\n\tChildren,\n\trender,\n\thydrate,\n\tunmountComponentAtNode,\n\tcreatePortal,\n\tcreateElement,\n\tcreateContext,\n\tcreateFactory,\n\tcloneElement,\n\tcreateRef,\n\tFragment,\n\tisValidElement,\n\tisFragment,\n\tisMemo,\n\tfindDOMNode,\n\tComponent,\n\tPureComponent,\n\tmemo,\n\tforwardRef,\n\tflushSync,\n\t// eslint-disable-next-line camelcase\n\tunstable_batchedUpdates,\n\tStrictMode,\n\tSuspense,\n\tSuspenseList,\n\tlazy,\n\t__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED\n};\n\n// React copies the named exports to the default one.\nexport default {\n\tuseState,\n\tuseId,\n\tuseReducer,\n\tuseEffect,\n\tuseLayoutEffect,\n\tuseInsertionEffect,\n\tuseTransition,\n\tuseDeferredValue,\n\tuseSyncExternalStore,\n\tstartTransition,\n\tuseRef,\n\tuseImperativeHandle,\n\tuseMemo,\n\tuseCallback,\n\tuseContext,\n\tuseDebugValue,\n\tversion,\n\tChildren,\n\trender,\n\thydrate,\n\tunmountComponentAtNode,\n\tcreatePortal,\n\tcreateElement,\n\tcreateContext,\n\tcreateFactory,\n\tcloneElement,\n\tcreateRef,\n\tFragment,\n\tisValidElement,\n\tisElement,\n\tisFragment,\n\tisMemo,\n\tfindDOMNode,\n\tComponent,\n\tPureComponent,\n\tmemo,\n\tforwardRef,\n\tflushSync,\n\tunstable_batchedUpdates,\n\tStrictMode,\n\tSuspense,\n\tSuspenseList,\n\tlazy,\n\t__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED\n};\n","import { options, Fragment } from 'preact';\nimport { encodeEntities } from './utils';\nimport { IS_NON_DIMENSIONAL } from '../../src/constants';\n\nlet vnodeId = 0;\n\nconst isArray = Array.isArray;\n\n/**\n * @fileoverview\n * This file exports various methods that implement Babel's \"automatic\" JSX runtime API:\n * - jsx(type, props, key)\n * - jsxs(type, props, key)\n * - jsxDEV(type, props, key, __source, __self)\n *\n * The implementation of createVNode here is optimized for performance.\n * Benchmarks: https://esbench.com/bench/5f6b54a0b4632100a7dcd2b3\n */\n\n/**\n * JSX.Element factory used by Babel's {runtime:\"automatic\"} JSX transform\n * @param {VNode['type']} type\n * @param {VNode['props']} props\n * @param {VNode['key']} [key]\n * @param {unknown} [isStaticChildren]\n * @param {unknown} [__source]\n * @param {unknown} [__self]\n */\nfunction createVNode(type, props, key, isStaticChildren, __source, __self) {\n\tif (!props) props = {};\n\t// We'll want to preserve `ref` in props to get rid of the need for\n\t// forwardRef components in the future, but that should happen via\n\t// a separate PR.\n\tlet normalizedProps = props,\n\t\tref,\n\t\ti;\n\n\tif ('ref' in props) {\n\t\tref = props.ref;\n\t\tdelete props.ref;\n\t}\n\n\t/** @type {VNode & { __source: any; __self: any }} */\n\tconst vnode = {\n\t\ttype,\n\t\tprops: normalizedProps,\n\t\tkey,\n\t\tref,\n\t\t_children: null,\n\t\t_parent: null,\n\t\t_depth: 0,\n\t\t_dom: null,\n\t\t_nextDom: undefined,\n\t\t_component: null,\n\t\tconstructor: undefined,\n\t\t_original: --vnodeId,\n\t\t_index: -1,\n\t\t_flags: 0,\n\t\t__source,\n\t\t__self\n\t};\n\n\t// If a Component VNode, check for and apply defaultProps.\n\t// Note: `type` is often a String, and can be `undefined` in development.\n\tif (typeof type === 'function' && (ref = type.defaultProps)) {\n\t\tfor (i in ref)\n\t\t\tif (typeof normalizedProps[i] === 'undefined') {\n\t\t\t\tnormalizedProps[i] = ref[i];\n\t\t\t}\n\t}\n\n\tif (options.vnode) options.vnode(vnode);\n\treturn vnode;\n}\n\n/**\n * Create a template vnode. This function is not expected to be\n * used directly, but rather through a precompile JSX transform\n * @param {string[]} templates\n * @param  {Array<string | null | VNode>} exprs\n * @returns {VNode}\n */\nfunction jsxTemplate(templates, ...exprs) {\n\tconst vnode = createVNode(Fragment, { tpl: templates, exprs });\n\t// Bypass render to string top level Fragment optimization\n\tvnode.key = vnode._vnode;\n\treturn vnode;\n}\n\nconst JS_TO_CSS = {};\nconst CSS_REGEX = /[A-Z]/g;\n\n/**\n * Serialize an HTML attribute to a string. This function is not\n * expected to be used directly, but rather through a precompile\n * JSX transform\n * @param {string} name The attribute name\n * @param {*} value The attribute value\n * @returns {string}\n */\nfunction jsxAttr(name, value) {\n\tif (options.attr) {\n\t\tconst result = options.attr(name, value);\n\t\tif (typeof result === 'string') return result;\n\t}\n\n\tif (name === 'ref' || name === 'key') return '';\n\tif (name === 'style' && typeof value === 'object') {\n\t\tlet str = '';\n\t\tfor (let prop in value) {\n\t\t\tlet val = value[prop];\n\t\t\tif (val != null && val !== '') {\n\t\t\t\tconst name =\n\t\t\t\t\tprop[0] == '-'\n\t\t\t\t\t\t? prop\n\t\t\t\t\t\t: JS_TO_CSS[prop] ||\n\t\t\t\t\t\t\t(JS_TO_CSS[prop] = prop.replace(CSS_REGEX, '-$&').toLowerCase());\n\n\t\t\t\tlet suffix = ';';\n\t\t\t\tif (\n\t\t\t\t\ttypeof val === 'number' &&\n\t\t\t\t\t// Exclude custom-attributes\n\t\t\t\t\t!name.startsWith('--') &&\n\t\t\t\t\t!IS_NON_DIMENSIONAL.test(name)\n\t\t\t\t) {\n\t\t\t\t\tsuffix = 'px;';\n\t\t\t\t}\n\t\t\t\tstr = str + name + ':' + val + suffix;\n\t\t\t}\n\t\t}\n\t\treturn name + '=\"' + str + '\"';\n\t}\n\n\tif (\n\t\tvalue == null ||\n\t\tvalue === false ||\n\t\ttypeof value === 'function' ||\n\t\ttypeof value === 'object'\n\t) {\n\t\treturn '';\n\t} else if (value === true) return name;\n\n\treturn name + '=\"' + encodeEntities(value) + '\"';\n}\n\n/**\n * Escape a dynamic child passed to `jsxTemplate`. This function\n * is not expected to be used directly, but rather through a\n * precompile JSX transform\n * @param {*} value\n * @returns {string | null | VNode | Array<string | null | VNode>}\n */\nfunction jsxEscape(value) {\n\tif (\n\t\tvalue == null ||\n\t\ttypeof value === 'boolean' ||\n\t\ttypeof value === 'function'\n\t) {\n\t\treturn null;\n\t}\n\n\tif (typeof value === 'object') {\n\t\t// Check for VNode\n\t\tif (value.constructor === undefined) return value;\n\n\t\tif (isArray(value)) {\n\t\t\tfor (let i = 0; i < value.length; i++) {\n\t\t\t\tvalue[i] = jsxEscape(value[i]);\n\t\t\t}\n\t\t\treturn value;\n\t\t}\n\t}\n\n\treturn encodeEntities('' + value);\n}\n\nexport {\n\tcreateVNode as jsx,\n\tcreateVNode as jsxs,\n\tcreateVNode as jsxDEV,\n\tFragment,\n\t// precompiled JSX transform\n\tjsxTemplate,\n\tjsxAttr,\n\tjsxEscape\n};\n","import { RenderableProps, createContext } from 'preact';\nimport { useContext } from 'preact/hooks';\nimport browser from 'webextension-polyfill';\n\nexport type TranslateFunctionType = (\n  key: string,\n  substitutions?: string | Array<string>\n) => string;\n\nexport type i18nContextType = {\n  t: TranslateFunctionType;\n  langTag: string;\n};\n\nconst contextValue: i18nContextType = {\n  t: browser.i18n.getMessage.bind(browser.i18n),\n  langTag: browser.i18n.getMessage('lang_tag'),\n};\n\nconst i18nContext = createContext<i18nContextType>(contextValue);\n\ntype LocaleType = 'en' | 'ja' | 'zh_hans';\n\ntype I18nProviderProps = {\n  locale?: LocaleType;\n};\n\nexport function I18nProvider(props: RenderableProps<I18nProviderProps>) {\n  if (props.locale !== undefined) {\n    throw new Error('Changing locale is not supported');\n  }\n\n  return (\n    <i18nContext.Provider value={contextValue}>\n      {props.children}\n    </i18nContext.Provider>\n  );\n}\n\nexport function useLocale(): i18nContextType {\n  return useContext(i18nContext);\n}\n","import { isIOS } from './ua-utils';\n\nexport function isTouchDevice(): boolean {\n  if (window.PointerEvent && 'maxTouchPoints' in navigator) {\n    return navigator.maxTouchPoints > 0;\n  }\n\n  if (window.matchMedia && window.matchMedia('(any-pointer:coarse)').matches) {\n    return true;\n  }\n\n  // The following will give a false positive in Chrome desktop but hopefully\n  // one of the above checks will cover us there.\n  return 'TouchEvent' in window;\n}\n\nexport function possiblyHasPhysicalKeyboard(): boolean {\n  const desktopOsStrings = ['Windows', 'Win32', 'Win64', 'Mac', 'Linux'];\n\n  return (\n    // In general, if the device has a fine pointer (e.g. mouse) we assume\n    // it also has a keyboard.\n    window.matchMedia('(hover) and (pointer: fine)').matches ||\n    // However, we've encountered at least one notebook device which returns\n    // `any-pointer: coarse` and `any-hover: none` for its trackpad on Firefox.\n    //\n    // That seems to be a bug somewhere (at very least, a trackpad can hover)\n    // in either Firefox or the OS/device driver, we shouldn't prevent users of\n    // such a device from being able to configure the keyboard so we _also_\n    // assume we have a keyboard when we're on an OS that we know to be\n    // a desktop OS.\n    (desktopOsStrings.some(\n      (osString) => navigator.userAgent.indexOf(osString) !== -1\n    ) &&\n      // Exclude iOS, however, because the UA string there has \"like Mac OS X\"\n      !isIOS())\n  );\n}\n\n// Detect if the primary input means is capable of hovering. If it is NOT\n// we show the puck by default.\n//\n// e.g. if we're on a laptop device that has a touchpad or mouse we generally\n// _don't_ want to show the puck unless the user explicitly enables it.\n// For a smartphone or tablet, however, we want to show the puck by default.\nexport function getHoverCapabilityMql(): MediaQueryList | undefined {\n  // The undefined case here is just for the sake of our unit tests.\n  return window.matchMedia ? window.matchMedia('(hover: hover)') : undefined;\n}\n\nexport function getMouseCapabilityMql(): MediaQueryList | undefined {\n  return window.matchMedia\n    ? window.matchMedia('(hover: hover) and (pointer: fine)')\n    : undefined;\n}\n","export const highPriorityLabels = ['i1', 'n1', 's1', 's2', 'g1'];\n","import type { KanjiResult } from '@birchill/jpdict-idb';\n\nimport type { TranslateFunctionType } from '../common/i18n';\nimport type { ReferenceAbbreviation } from '../common/refs';\n\nexport function getReferenceValue(\n  entry: KanjiResult,\n  ref: ReferenceAbbreviation,\n  t: TranslateFunctionType\n): string {\n  switch (ref) {\n    case 'nelson_r': {\n      // If the Nelson radical is empty, it means it's the same as the regular\n      // radical so we should fall through to that branch.\n      if (entry.rad.nelson) {\n        return `${entry.rad.nelson} ${String.fromCodePoint(\n          entry.rad.nelson + 0x2eff\n        )}`;\n      }\n      // Fall through\n    }\n\n    case 'radical': {\n      const { rad } = entry;\n      const radChar = rad.base ? rad.base.b || rad.base.k : rad.b || rad.k;\n      return `${rad.x} ${radChar}`;\n    }\n\n    case 'kk':\n      return renderKanKen(entry.misc.kk, t);\n\n    case 'jlpt':\n      return entry.misc.jlpt ? String(entry.misc.jlpt) : '';\n\n    case 'py':\n      return entry.r.py ? entry.r.py.join(', ') : '';\n\n    case 'unicode':\n      return `U+${entry.c.codePointAt(0)!.toString(16).toUpperCase()}`;\n\n    case 'wk':\n      return entry.misc.wk ? String(entry.misc.wk) : '';\n\n    default:\n      return entry.refs[ref] ? String(entry.refs[ref]) : '';\n  }\n}\n\nfunction renderKanKen(\n  level: number | undefined,\n  t: TranslateFunctionType\n): string {\n  if (!level) {\n    return '';\n  }\n  if (level === 15) {\n    return t('content_kanji_kentei_level_pre', ['1']);\n  }\n  if (level === 25) {\n    return t('content_kanji_kentei_level_pre', ['2']);\n  }\n  return t('content_kanji_kentei_level', [String(level)]);\n}\n","import { Dialect, KanjiResult, LangSource } from '@birchill/jpdict-idb';\n\nimport type {\n  NameResult,\n  Sense,\n  WordResult,\n} from '../background/search-result';\nimport type { CopyType } from '../common/copy-keys';\nimport type { TranslateFunctionType } from '../common/i18n';\nimport { highPriorityLabels } from '../common/priority-labels';\nimport {\n  ReferenceAbbreviation,\n  getSelectedReferenceLabels,\n} from '../common/refs';\n\nimport { getReferenceValue } from './reference-value';\n\nexport type CopyEntry =\n  | { type: 'word'; data: WordResult }\n  | { type: 'name'; data: NameResult }\n  | { type: 'kanji'; data: KanjiResult };\n\nexport function getTextToCopy({\n  entry,\n  copyType,\n  getMessage,\n  includeAllSenses = true,\n  includeLessCommonHeadwords = true,\n  includePartOfSpeech = true,\n  kanjiReferences = [] as Array<ReferenceAbbreviation>,\n  showKanjiComponents = true,\n}: {\n  entry: CopyEntry;\n  copyType: CopyType;\n  getMessage: TranslateFunctionType;\n  includeAllSenses?: boolean;\n  includeLessCommonHeadwords?: boolean;\n  includePartOfSpeech?: boolean;\n  kanjiReferences?: Array<ReferenceAbbreviation>;\n  showKanjiComponents?: boolean;\n}): string {\n  switch (copyType) {\n    case 'entry':\n      return getEntryToCopy(entry, {\n        getMessage,\n        includeAllSenses,\n        includeLessCommonHeadwords,\n        includePartOfSpeech,\n        kanjiReferences,\n        showKanjiComponents,\n      });\n\n    case 'tab':\n      return getFieldsToCopy(entry, {\n        getMessage,\n        includeAllSenses,\n        includeLessCommonHeadwords,\n        includePartOfSpeech,\n        kanjiReferences,\n        showKanjiComponents,\n      });\n\n    case 'word':\n      return getWordToCopy(entry);\n  }\n}\n\nexport function getWordToCopy(entry: CopyEntry): string {\n  let result: string;\n\n  switch (entry.type) {\n    case 'word':\n      {\n        let headwords = entry.data.k?.length\n          ? entry.data.k.filter((k) => !k.i?.includes('sK'))\n          : entry.data.r.filter((r) => !r.i?.includes('sk'));\n\n        // Only show matches -- unless our only matches were search-only\n        // terms -- in which case we want to include all headwords.\n        if (headwords.some((h) => h.match)) {\n          headwords = headwords.filter((entry) => entry.match);\n        }\n\n        result = headwords.map((entry) => entry.ent).join(', ');\n      }\n      break;\n\n    case 'name':\n      result = (entry.data.k || entry.data.r).join(', ');\n      break;\n\n    case 'kanji':\n      result = entry.data.c;\n      break;\n  }\n\n  return result!;\n}\n\nexport function getEntryToCopy(\n  entry: CopyEntry,\n  {\n    getMessage,\n    includeAllSenses = true,\n    includeLessCommonHeadwords = true,\n    includePartOfSpeech = true,\n    kanjiReferences = [] as Array<ReferenceAbbreviation>,\n    showKanjiComponents = true,\n  }: {\n    getMessage: TranslateFunctionType;\n    includeAllSenses?: boolean;\n    includeLessCommonHeadwords?: boolean;\n    includePartOfSpeech?: boolean;\n    kanjiReferences?: Array<ReferenceAbbreviation>;\n    showKanjiComponents?: boolean;\n  }\n): string {\n  let result: string;\n\n  switch (entry.type) {\n    case 'word':\n      {\n        const kanjiHeadwords = entry.data.k\n          ? filterRelevantKanjiHeadwords(entry.data.k, {\n              includeLessCommonHeadwords,\n            }).map((k) => k.ent)\n          : [];\n        const kanaHeadwords = filterRelevantKanaHeadwords(entry.data.r, {\n          includeLessCommonHeadwords,\n        }).map((r) => r.ent);\n\n        result = kanjiHeadwords.length\n          ? `${kanjiHeadwords.join(', ')} [${kanaHeadwords.join(', ')}]`\n          : kanaHeadwords.join(', ');\n        if (entry.data.romaji?.length) {\n          result += ` (${entry.data.romaji.join(', ')})`;\n        }\n\n        result +=\n          (includeAllSenses ? '\\n' : ' ') +\n          serializeDefinition(entry.data, {\n            getMessage,\n            includeAllSenses,\n            includePartOfSpeech,\n            oneSensePerLine: true,\n          });\n      }\n      break;\n\n    case 'name':\n      result = entry.data.k\n        ? `${entry.data.k.join(', ')} [${entry.data.r.join(', ')}]${includeAllSenses ? '\\n' : ' '}`\n        : entry.data.r.join(', ') + (includeAllSenses ? '\\n' : ' ');\n\n      for (const [i, tr] of entry.data.tr.entries()) {\n        if (i) {\n          result += '; ';\n        }\n        if (includePartOfSpeech && tr.type) {\n          result += `(${tr.type.join(', ')}) `;\n        }\n        result += tr.det.join(', ');\n      }\n      break;\n\n    case 'kanji':\n      {\n        const { c, r, m, rad, comp } = entry.data;\n\n        result = c;\n        const readings = getKanjiReadings(entry.data);\n        if (readings) {\n          result += ` [${readings}]`;\n        }\n        if (r.na && r.na.length) {\n          result += ` (${r.na.join('')})`;\n        }\n        result += ` ${m.join(', ')}`;\n        const radicalLabel = getMessage('content_kanji_radical_label');\n        result += `; ${radicalLabel}: ${rad.b || rad.k}${rad.na.join(\n          ''\n        )}`;\n        if (rad.base) {\n          const baseChar = (rad.base.b || rad.base.k)!;\n          const baseReadings = rad.base.na.join('');\n          result +=\n            ' ' +\n            getMessage('content_kanji_base_radical', [baseChar, baseReadings]);\n        }\n        if (showKanjiComponents && comp.length) {\n          const componentsLabel = getMessage('content_kanji_components_label');\n          const components: Array<string> = [];\n          for (const component of comp) {\n            components.push(\n              `${component.c} (${\n                component.na.length ? component.na[0] + ', ' : ''\n              }${component.m.length ? component.m[0] : ''})`\n            );\n          }\n          result += `; ${componentsLabel}: ${components.join(', ')}`;\n        }\n\n        if (kanjiReferences.length) {\n          const labels = getSelectedReferenceLabels(\n            kanjiReferences,\n            getMessage\n          );\n          for (const label of labels) {\n            if (\n              label.ref === 'nelson_r' &&\n              !rad.nelson &&\n              kanjiReferences.includes('radical')\n            ) {\n              continue;\n            }\n            result += `; ${label.short || label.full} ${\n              getReferenceValue(entry.data, label.ref, getMessage) || '-'\n            }`;\n          }\n        }\n      }\n      break;\n  }\n\n  return result!;\n}\n\ntype KanjiHeadword = WordResult['k'][number];\n\nconst highPriorityLabelsSet = new Set(highPriorityLabels);\n\nfunction filterRelevantKanjiHeadwords(\n  headwords: Array<KanjiHeadword>,\n  {\n    includeLessCommonHeadwords,\n  }: {\n    includeLessCommonHeadwords: boolean;\n  }\n) {\n  if (includeLessCommonHeadwords) {\n    return headwords.filter((k) => !k.i?.includes('sK'));\n  }\n\n  const commonHeadwords = headwords.filter(\n    (k) => !k.i?.includes('sK') && !k.i?.includes('rK')\n  );\n\n  const highPriorityHeadwords = commonHeadwords.filter((k) =>\n    k.p?.some((p) => highPriorityLabelsSet.has(p))\n  );\n  if (highPriorityHeadwords.length) {\n    return highPriorityHeadwords;\n  }\n\n  const hasPriorityHeadwords = commonHeadwords.filter((k) => k.p?.length);\n  if (hasPriorityHeadwords.length) {\n    return hasPriorityHeadwords;\n  }\n\n  return commonHeadwords;\n}\n\ntype KanaHeadword = WordResult['r'][number];\n\nfunction filterRelevantKanaHeadwords(\n  headwords: Array<KanaHeadword>,\n  {\n    includeLessCommonHeadwords,\n  }: {\n    includeLessCommonHeadwords: boolean;\n  }\n) {\n  if (includeLessCommonHeadwords) {\n    return headwords.filter((k) => !k.i?.includes('sk'));\n  }\n\n  const commonHeadwords = headwords.filter(\n    (k) => !k.i?.includes('sk') && !k.i?.includes('rk')\n  );\n\n  const highPriorityHeadwords = commonHeadwords.filter((k) =>\n    k.p?.some((p) => highPriorityLabelsSet.has(p))\n  );\n  if (highPriorityHeadwords.length) {\n    return highPriorityHeadwords;\n  }\n\n  const hasPriorityHeadwords = commonHeadwords.filter((k) => k.p?.length);\n  if (hasPriorityHeadwords.length) {\n    return hasPriorityHeadwords;\n  }\n\n  return commonHeadwords;\n}\n\nfunction serializeDefinition(\n  entry: WordResult,\n  {\n    getMessage,\n    includeAllSenses = true,\n    includePartOfSpeech = true,\n    oneSensePerLine = false,\n  }: {\n    getMessage: TranslateFunctionType;\n    includeAllSenses?: boolean;\n    includePartOfSpeech?: boolean;\n    oneSensePerLine?: boolean;\n  }\n): string {\n  const senses = entry.s;\n  if (senses.length > 1 && includeAllSenses) {\n    const nativeSenses = senses\n      .filter((s) => s.lang && s.lang !== 'en')\n      .map(\n        (s) => ` ${serializeSense(s, { getMessage, includePartOfSpeech })}`\n      );\n    const enSenses = senses\n      .filter((s) => !s.lang || s.lang === 'en')\n      .map(\n        (s, index) =>\n          `(${index + 1}) ${serializeSense(s, { getMessage, includePartOfSpeech })}`\n      );\n\n    return [...nativeSenses, ...enSenses].join(oneSensePerLine ? '\\n' : ' ');\n  } else {\n    return serializeSense(senses[0], { getMessage, includePartOfSpeech });\n  }\n}\n\n// Match the formatting in Edict\nconst dialects: { [dial in Dialect]: string } = {\n  bra: 'bra:',\n  ho: 'hob:',\n  tsug: 'tsug:',\n  th: 'thb:',\n  na: 'nab:',\n  kt: 'ktb:',\n  ks: 'ksb:',\n  ky: 'kyb:',\n  os: 'osb:',\n  ts: 'tsb:',\n  '9s': 'kyu:',\n  ok: 'rkb:',\n};\n\nfunction serializeSense(\n  sense: Sense,\n  {\n    getMessage,\n    includePartOfSpeech = true,\n  }: { getMessage: TranslateFunctionType; includePartOfSpeech?: boolean }\n): string {\n  let result = '';\n\n  if (includePartOfSpeech && sense.pos) {\n    result += `(${sense.pos.join(',')}) `;\n  }\n  result += sense.field ? `(${sense.field.join(',')}) ` : '';\n  result += sense.misc ? `(${sense.misc.join(',')}) ` : '';\n  result += sense.dial\n    ? `(${sense.dial\n        .map((dial) => (dial in dialects ? dialects[dial as Dialect] : dial))\n        .join(',')}) `\n    : '';\n\n  const glosses: Array<string> = [];\n  for (const g of sense.g) {\n    let gloss = '';\n    if (g.type && g.type !== 'tm' && g.type !== 'none') {\n      const glossTypeStr = getMessage(`gloss_type_short_${g.type}`);\n      if (glossTypeStr) {\n        gloss = `(${glossTypeStr}) `;\n      }\n    }\n    gloss += g.str;\n    if (g.type === 'tm') {\n      gloss += '';\n    }\n    glosses.push(gloss);\n  }\n  result += glosses.join('; ');\n\n  result += sense.lsrc\n    ? ` (${sense.lsrc.map(serializeLangSrc).join(', ')})`\n    : '';\n  result += sense.inf ? ` (${sense.inf})` : '';\n\n  return result;\n}\n\nfunction serializeLangSrc(lsrc: LangSource) {\n  const lang = lsrc.wasei ? 'wasei' : lsrc.lang;\n  const parts = [];\n  if (lang) {\n    parts.push(lang);\n  }\n  if (lsrc.src) {\n    parts.push(lsrc.src);\n  }\n  return parts.join(': ');\n}\n\nexport function getFieldsToCopy(\n  entry: CopyEntry,\n  {\n    getMessage,\n    includeAllSenses = true,\n    includeLessCommonHeadwords = true,\n    includePartOfSpeech = true,\n    kanjiReferences = [] as Array<ReferenceAbbreviation>,\n    showKanjiComponents = true,\n  }: {\n    getMessage: TranslateFunctionType;\n    includeAllSenses?: boolean;\n    includeLessCommonHeadwords?: boolean;\n    includePartOfSpeech?: boolean;\n    kanjiReferences?: Array<ReferenceAbbreviation>;\n    showKanjiComponents?: boolean;\n  }\n): string {\n  let result: string;\n\n  switch (entry.type) {\n    case 'word':\n      result = entry.data.k\n        ? filterRelevantKanjiHeadwords(entry.data.k, {\n            includeLessCommonHeadwords,\n          })\n            .map((k) => k.ent)\n            .join('; ')\n        : '';\n      result +=\n        '\\t' +\n        filterRelevantKanaHeadwords(entry.data.r, {\n          includeLessCommonHeadwords,\n        })\n          .map((r) => r.ent)\n          .join('; ');\n      if (entry.data.romaji?.length) {\n        result += '\\t' + entry.data.romaji.join('; ');\n      }\n\n      result +=\n        '\\t' +\n        serializeDefinition(entry.data, {\n          getMessage,\n          includeAllSenses,\n          includePartOfSpeech,\n        });\n      break;\n\n    case 'name':\n      {\n        let definition = '';\n        for (const [i, tr] of entry.data.tr.entries()) {\n          if (i) {\n            definition += '; ';\n          }\n          if (includePartOfSpeech && tr.type) {\n            definition += `(${tr.type.join(', ')}) `;\n          }\n          definition += tr.det.join(', ');\n        }\n\n        // Split each kanji name out into a separate row\n        result = '';\n        for (const [i, kanji] of (entry.data.k || ['']).entries()) {\n          if (i) {\n            result += '\\n';\n          }\n          result += `${kanji}\\t${entry.data.r.join(', ')}\\t${definition}`;\n        }\n      }\n      break;\n\n    case 'kanji':\n      {\n        const { c, r, m, comp } = entry.data;\n\n        result = c;\n        const readings = getKanjiReadings(entry.data);\n        result += `\\t${readings}`;\n        result += `\\t${(r.na || []).join('')}`;\n        result += `\\t${m.join(', ')}`;\n        if (showKanjiComponents) {\n          const components = comp.map((comp) => comp.c).join('');\n          result += `\\t${components}`;\n        }\n        if (kanjiReferences.length) {\n          const labels = getSelectedReferenceLabels(\n            kanjiReferences,\n            getMessage\n          );\n          for (const label of labels) {\n            // For some common types we don't produce the label\n            switch (label.ref) {\n              case 'radical':\n              case 'unicode':\n              case 'nelson_r':\n                // All the above types also either always exist (radical,\n                // unicode) or if they don't exist we want to produce an empty\n                // value (not '-') hence why we don't include the ... || '-'\n                // from the next block.\n                result +=\n                  '\\t' + getReferenceValue(entry.data, label.ref, getMessage);\n                break;\n\n              default:\n                result += `\\t${label.short || label.full} ${\n                  getReferenceValue(entry.data, label.ref, getMessage) || '-'\n                }`;\n                break;\n            }\n          }\n        }\n      }\n      break;\n  }\n\n  return result!;\n}\n\nfunction getKanjiReadings(kanji: KanjiResult): string {\n  return [\n    ...(kanji.r.on ? kanji.r.on : []),\n    ...(kanji.r.kun ? kanji.r.kun : []),\n  ].join('');\n}\n","import type { ComponentProps } from 'preact';\n\nexport function CheckboxRow(\n  props: Omit<ComponentProps<'div'>, 'class' | 'className'>\n) {\n  return (\n    <div\n      {...props}\n      class=\"flex items-baseline gap-1.5 leading-snug [&>:not(input)]:flex-1 [&>input]:translate-y-px [&>label]:cursor-pointer [&>label]:select-none\"\n    >\n      {props.children}\n    </div>\n  );\n}\n","import { useLocale } from '../common/i18n';\n\ntype Props = {\n  expiry: Date;\n};\n\nexport function NewBadge(props: Props) {\n  const { t } = useLocale();\n\n  return new Date() < props.expiry ? (\n    <span class=\"mx-2 mt-[5px] inline-block rounded-full bg-rose-100 px-3 py-[2px] text-[12px] font-medium leading-none text-rose-900 dark:bg-rose-800 dark:text-rose-100\">\n      {t('options_new_badge_text')}\n    </span>\n  ) : null;\n}\n","import { useLocale } from '../common/i18n';\nimport { getTextToCopy } from '../content/copy-text';\n\nimport { CheckboxRow } from './CheckboxRow';\nimport { NewBadge } from './NewBadge';\n\ntype Props = {\n  simplifiedCopy: boolean;\n  showRomaji?: boolean;\n  onChangeSimplifiedCopy: (value: boolean) => void;\n};\n\nexport function CopySettingsForm(props: Props) {\n  const { t } = useLocale();\n\n  return (\n    <div class=\"flex flex-col gap-4\">\n      <CheckboxRow>\n        <input\n          id=\"simplifiedCopy\"\n          name=\"simplifiedCopy\"\n          type=\"checkbox\"\n          checked={props.simplifiedCopy}\n          onChange={(e) =>\n            props.onChangeSimplifiedCopy(e.currentTarget.checked)\n          }\n        />\n        <label for=\"simplifiedCopy\">\n          {t('options_simplified_copy')}\n          <NewBadge expiry={new Date('2024-05-01')} />\n        </label>\n      </CheckboxRow>\n      <div class=\"rounded-lg border border-solid border-zinc-200 bg-zinc-50 px-4 py-3 dark:border-zinc-700 dark:bg-zinc-800\">\n        <p class=\"m-0 mb-2 text-xs text-zinc-500 dark:text-zinc-400\">\n          {t('options_copy_preview')}\n        </p>\n        <code class=\"whitespace-pre-wrap text-sm font-medium text-zinc-700 dark:text-zinc-300\">\n          {getTextToCopy({\n            entry: {\n              type: 'word',\n              data: {\n                id: 1704220,\n                k: [\n                  { ent: '', p: ['n1', 'nf15'], match: true, bv: { l: 3 } },\n                  { ent: '', match: true },\n                ],\n                r: [\n                  {\n                    ent: '',\n                    p: ['n1', 'nf15'],\n                    a: [{ i: 0 }, { i: 3 }],\n                    match: true,\n                    matchRange: [0, 4],\n                  },\n                ],\n                s: [\n                  {\n                    g: [\n                      { str: 'moving from place to place' },\n                      { str: 'being passed around repeatedly' },\n                    ],\n                    pos: ['adv', 'adv-to', 'n', 'vs'],\n                    match: true,\n                  },\n                  {\n                    g: [{ str: 'rolling about' }],\n                    pos: ['adv', 'adv-to', 'n', 'vs'],\n                    match: true,\n                  },\n                ],\n                romaji: props.showRomaji ? ['tenten'] : undefined,\n              },\n            },\n            copyType: 'entry',\n            getMessage,\n            includeAllSenses: !props.simplifiedCopy,\n            includeLessCommonHeadwords: !props.simplifiedCopy,\n            includePartOfSpeech: !props.simplifiedCopy,\n          })}\n        </code>\n      </div>\n    </div>\n  );\n}\n\nfunction getMessage(id: string) {\n  return id;\n}\n","import type { RenderableProps } from 'preact';\n\nimport type { EmptyProps } from '../utils/type-helpers';\n\nexport function SectionHeading(props: RenderableProps<EmptyProps>) {\n  return (\n    <h1 class=\"mb-2 mt-4 border-0 border-t border-solid border-t-zinc-300 pt-4 text-2xl font-light first-of-type:mt-2 first-of-type:border-none first-of-type:pt-0\">\n      {props.children}\n    </h1>\n  );\n}\n","import { useEffect, useState } from 'preact/hooks';\n\nimport { type ChangeCallback, Config } from '../common/config';\n\nexport function useConfigValue<K extends keyof Config>(\n  config: Config,\n  key: K\n): Config[K] {\n  const [value, setValue] = useState<Config[K]>(config[key]);\n\n  useEffect(() => {\n    const changeCallback: ChangeCallback = (changes) => {\n      if (Object.keys(changes).includes(key)) {\n        setValue(config[key]);\n      }\n    };\n\n    config.addChangeListener(changeCallback);\n    return () => config.removeChangeListener(changeCallback);\n  }, [config, key]);\n\n  return value;\n}\n","import { useCallback } from 'preact/hooks';\n\nimport type { Config } from '../common/config';\nimport { useLocale } from '../common/i18n';\n\nimport { CopySettingsForm } from './CopySettingsForm';\nimport { SectionHeading } from './SectionHeading';\nimport { useConfigValue } from './use-config-value';\n\ntype Props = {\n  config: Config;\n};\n\nexport function CopySettings(props: Props) {\n  const { t } = useLocale();\n  const copyHeadwords = useConfigValue(props.config, 'copyHeadwords');\n  const copyPos = useConfigValue(props.config, 'copyPos');\n  const copySenses = useConfigValue(props.config, 'copySenses');\n  const simplifiedCopy =\n    copyHeadwords === 'common' || copyPos === 'none' || copySenses === 'first';\n\n  const onChangeSimplifiedCopy = useCallback(\n    (value: boolean) => {\n      if (value) {\n        props.config.copyHeadwords = 'common';\n        props.config.copyPos = 'none';\n        props.config.copySenses = 'first';\n      } else {\n        props.config.copyHeadwords = 'regular';\n        props.config.copyPos = 'code';\n        props.config.copySenses = 'all';\n      }\n    },\n    [props.config]\n  );\n\n  const showRomaji = useConfigValue(props.config, 'showRomaji');\n\n  return (\n    <>\n      <SectionHeading>{t('options_copy_heading')}</SectionHeading>\n      <div class=\"py-4\">\n        <CopySettingsForm\n          showRomaji={showRomaji}\n          simplifiedCopy={simplifiedCopy}\n          onChangeSimplifiedCopy={onChangeSimplifiedCopy}\n        />\n      </div>\n    </>\n  );\n}\n","import { useLocale } from '../common/i18n';\n\ntype Props = {\n  currencies: Array<string>;\n  selectedCurrency: string;\n  onChange: (currency: string) => void;\n};\n\nexport function CurrencySettingsForm(props: Props) {\n  const { t } = useLocale();\n\n  const currencyNames = Intl.DisplayNames\n    ? new Intl.DisplayNames(['en'], { type: 'currency' })\n    : undefined;\n\n  const options = [\n    ['none', t('options_currency_none_label')],\n    ...props.currencies.map((c) => {\n      const label = currencyNames ? `${c} - ${currencyNames.of(c)}` : c;\n      return [c, label];\n    }),\n  ];\n\n  return (\n    <>\n      <label for=\"fxCurrency\">{t('options_currency_label')}</label>\n      <select\n        id=\"fxCurrency\"\n        name=\"fxCurrency\"\n        onInput={(event) => {\n          props.onChange(event.currentTarget.value);\n        }}\n      >\n        {options.map(([value, label]) => (\n          <option\n            key={value}\n            value={value}\n            selected={value === props.selectedCurrency}\n          >\n            {label}\n          </option>\n        ))}\n      </select>\n    </>\n  );\n}\n","import { useCallback } from 'preact/hooks';\n\nimport type { Config } from '../common/config';\nimport { useLocale } from '../common/i18n';\n\nimport { CurrencySettingsForm } from './CurrencySettingsForm';\nimport { SectionHeading } from './SectionHeading';\nimport { useConfigValue } from './use-config-value';\n\ntype Props = {\n  config: Config;\n};\n\nexport function CurrencySettings(props: Props) {\n  const { t } = useLocale();\n  const fxCurrency = useConfigValue(props.config, 'fxCurrency');\n  const fxCurrencies = useConfigValue(props.config, 'fxCurrencies');\n\n  const onChangeCurrency = useCallback(\n    (value: string) => {\n      props.config.fxCurrency = value;\n    },\n    [props.config]\n  );\n\n  if (!fxCurrencies) {\n    return null;\n  }\n\n  return (\n    <>\n      <SectionHeading>\n        {t('options_currency_conversion_heading')}\n      </SectionHeading>\n      <div class=\"py-4\">\n        <CurrencySettingsForm\n          currencies={fxCurrencies}\n          selectedCurrency={fxCurrency}\n          onChange={onChangeCurrency}\n        />\n      </div>\n    </>\n  );\n}\n","const instanceOfAny = (object, constructors) => constructors.some((c) => object instanceof c);\n\nlet idbProxyableTypes;\nlet cursorAdvanceMethods;\n// This is a function to prevent it throwing up in node environments.\nfunction getIdbProxyableTypes() {\n    return (idbProxyableTypes ||\n        (idbProxyableTypes = [\n            IDBDatabase,\n            IDBObjectStore,\n            IDBIndex,\n            IDBCursor,\n            IDBTransaction,\n        ]));\n}\n// This is a function to prevent it throwing up in node environments.\nfunction getCursorAdvanceMethods() {\n    return (cursorAdvanceMethods ||\n        (cursorAdvanceMethods = [\n            IDBCursor.prototype.advance,\n            IDBCursor.prototype.continue,\n            IDBCursor.prototype.continuePrimaryKey,\n        ]));\n}\nconst transactionDoneMap = new WeakMap();\nconst transformCache = new WeakMap();\nconst reverseTransformCache = new WeakMap();\nfunction promisifyRequest(request) {\n    const promise = new Promise((resolve, reject) => {\n        const unlisten = () => {\n            request.removeEventListener('success', success);\n            request.removeEventListener('error', error);\n        };\n        const success = () => {\n            resolve(wrap(request.result));\n            unlisten();\n        };\n        const error = () => {\n            reject(request.error);\n            unlisten();\n        };\n        request.addEventListener('success', success);\n        request.addEventListener('error', error);\n    });\n    // This mapping exists in reverseTransformCache but doesn't doesn't exist in transformCache. This\n    // is because we create many promises from a single IDBRequest.\n    reverseTransformCache.set(promise, request);\n    return promise;\n}\nfunction cacheDonePromiseForTransaction(tx) {\n    // Early bail if we've already created a done promise for this transaction.\n    if (transactionDoneMap.has(tx))\n        return;\n    const done = new Promise((resolve, reject) => {\n        const unlisten = () => {\n            tx.removeEventListener('complete', complete);\n            tx.removeEventListener('error', error);\n            tx.removeEventListener('abort', error);\n        };\n        const complete = () => {\n            resolve();\n            unlisten();\n        };\n        const error = () => {\n            reject(tx.error || new DOMException('AbortError', 'AbortError'));\n            unlisten();\n        };\n        tx.addEventListener('complete', complete);\n        tx.addEventListener('error', error);\n        tx.addEventListener('abort', error);\n    });\n    // Cache it for later retrieval.\n    transactionDoneMap.set(tx, done);\n}\nlet idbProxyTraps = {\n    get(target, prop, receiver) {\n        if (target instanceof IDBTransaction) {\n            // Special handling for transaction.done.\n            if (prop === 'done')\n                return transactionDoneMap.get(target);\n            // Make tx.store return the only store in the transaction, or undefined if there are many.\n            if (prop === 'store') {\n                return receiver.objectStoreNames[1]\n                    ? undefined\n                    : receiver.objectStore(receiver.objectStoreNames[0]);\n            }\n        }\n        // Else transform whatever we get back.\n        return wrap(target[prop]);\n    },\n    set(target, prop, value) {\n        target[prop] = value;\n        return true;\n    },\n    has(target, prop) {\n        if (target instanceof IDBTransaction &&\n            (prop === 'done' || prop === 'store')) {\n            return true;\n        }\n        return prop in target;\n    },\n};\nfunction replaceTraps(callback) {\n    idbProxyTraps = callback(idbProxyTraps);\n}\nfunction wrapFunction(func) {\n    // Due to expected object equality (which is enforced by the caching in `wrap`), we\n    // only create one new func per func.\n    // Cursor methods are special, as the behaviour is a little more different to standard IDB. In\n    // IDB, you advance the cursor and wait for a new 'success' on the IDBRequest that gave you the\n    // cursor. It's kinda like a promise that can resolve with many values. That doesn't make sense\n    // with real promises, so each advance methods returns a new promise for the cursor object, or\n    // undefined if the end of the cursor has been reached.\n    if (getCursorAdvanceMethods().includes(func)) {\n        return function (...args) {\n            // Calling the original function with the proxy as 'this' causes ILLEGAL INVOCATION, so we use\n            // the original object.\n            func.apply(unwrap(this), args);\n            return wrap(this.request);\n        };\n    }\n    return function (...args) {\n        // Calling the original function with the proxy as 'this' causes ILLEGAL INVOCATION, so we use\n        // the original object.\n        return wrap(func.apply(unwrap(this), args));\n    };\n}\nfunction transformCachableValue(value) {\n    if (typeof value === 'function')\n        return wrapFunction(value);\n    // This doesn't return, it just creates a 'done' promise for the transaction,\n    // which is later returned for transaction.done (see idbObjectHandler).\n    if (value instanceof IDBTransaction)\n        cacheDonePromiseForTransaction(value);\n    if (instanceOfAny(value, getIdbProxyableTypes()))\n        return new Proxy(value, idbProxyTraps);\n    // Return the same value back if we're not going to transform it.\n    return value;\n}\nfunction wrap(value) {\n    // We sometimes generate multiple promises from a single IDBRequest (eg when cursoring), because\n    // IDB is weird and a single IDBRequest can yield many responses, so these can't be cached.\n    if (value instanceof IDBRequest)\n        return promisifyRequest(value);\n    // If we've already transformed this value before, reuse the transformed value.\n    // This is faster, but it also provides object equality.\n    if (transformCache.has(value))\n        return transformCache.get(value);\n    const newValue = transformCachableValue(value);\n    // Not all types are transformed.\n    // These may be primitive types, so they can't be WeakMap keys.\n    if (newValue !== value) {\n        transformCache.set(value, newValue);\n        reverseTransformCache.set(newValue, value);\n    }\n    return newValue;\n}\nconst unwrap = (value) => reverseTransformCache.get(value);\n\n/**\n * Open a database.\n *\n * @param name Name of the database.\n * @param version Schema version.\n * @param callbacks Additional callbacks.\n */\nfunction openDB(name, version, { blocked, upgrade, blocking, terminated } = {}) {\n    const request = indexedDB.open(name, version);\n    const openPromise = wrap(request);\n    if (upgrade) {\n        request.addEventListener('upgradeneeded', (event) => {\n            upgrade(wrap(request.result), event.oldVersion, event.newVersion, wrap(request.transaction), event);\n        });\n    }\n    if (blocked) {\n        request.addEventListener('blocked', (event) => blocked(\n        // Casting due to https://github.com/microsoft/TypeScript-DOM-lib-generator/pull/1405\n        event.oldVersion, event.newVersion, event));\n    }\n    openPromise\n        .then((db) => {\n        if (terminated)\n            db.addEventListener('close', () => terminated());\n        if (blocking) {\n            db.addEventListener('versionchange', (event) => blocking(event.oldVersion, event.newVersion, event));\n        }\n    })\n        .catch(() => { });\n    return openPromise;\n}\n/**\n * Delete a database.\n *\n * @param name Name of the database.\n */\nfunction deleteDB(name, { blocked } = {}) {\n    const request = indexedDB.deleteDatabase(name);\n    if (blocked) {\n        request.addEventListener('blocked', (event) => blocked(\n        // Casting due to https://github.com/microsoft/TypeScript-DOM-lib-generator/pull/1405\n        event.oldVersion, event));\n    }\n    return wrap(request).then(() => undefined);\n}\n\nconst readMethods = ['get', 'getKey', 'getAll', 'getAllKeys', 'count'];\nconst writeMethods = ['put', 'add', 'delete', 'clear'];\nconst cachedMethods = new Map();\nfunction getMethod(target, prop) {\n    if (!(target instanceof IDBDatabase &&\n        !(prop in target) &&\n        typeof prop === 'string')) {\n        return;\n    }\n    if (cachedMethods.get(prop))\n        return cachedMethods.get(prop);\n    const targetFuncName = prop.replace(/FromIndex$/, '');\n    const useIndex = prop !== targetFuncName;\n    const isWrite = writeMethods.includes(targetFuncName);\n    if (\n    // Bail if the target doesn't exist on the target. Eg, getAll isn't in Edge.\n    !(targetFuncName in (useIndex ? IDBIndex : IDBObjectStore).prototype) ||\n        !(isWrite || readMethods.includes(targetFuncName))) {\n        return;\n    }\n    const method = async function (storeName, ...args) {\n        // isWrite ? 'readwrite' : undefined gzipps better, but fails in Edge :(\n        const tx = this.transaction(storeName, isWrite ? 'readwrite' : 'readonly');\n        let target = tx.store;\n        if (useIndex)\n            target = target.index(args.shift());\n        // Must reject if op rejects.\n        // If it's a write operation, must reject if tx.done rejects.\n        // Must reject with op rejection first.\n        // Must resolve with op value.\n        // Must handle both promises (no unhandled rejections)\n        return (await Promise.all([\n            target[targetFuncName](...args),\n            isWrite && tx.done,\n        ]))[0];\n    };\n    cachedMethods.set(prop, method);\n    return method;\n}\nreplaceTraps((oldTraps) => ({\n    ...oldTraps,\n    get: (target, prop, receiver) => getMethod(target, prop) || oldTraps.get(target, prop, receiver),\n    has: (target, prop) => !!getMethod(target, prop) || oldTraps.has(target, prop),\n}));\n\nconst advanceMethodProps = ['continue', 'continuePrimaryKey', 'advance'];\nconst methodMap = {};\nconst advanceResults = new WeakMap();\nconst ittrProxiedCursorToOriginalProxy = new WeakMap();\nconst cursorIteratorTraps = {\n    get(target, prop) {\n        if (!advanceMethodProps.includes(prop))\n            return target[prop];\n        let cachedFunc = methodMap[prop];\n        if (!cachedFunc) {\n            cachedFunc = methodMap[prop] = function (...args) {\n                advanceResults.set(this, ittrProxiedCursorToOriginalProxy.get(this)[prop](...args));\n            };\n        }\n        return cachedFunc;\n    },\n};\nasync function* iterate(...args) {\n    // tslint:disable-next-line:no-this-assignment\n    let cursor = this;\n    if (!(cursor instanceof IDBCursor)) {\n        cursor = await cursor.openCursor(...args);\n    }\n    if (!cursor)\n        return;\n    cursor = cursor;\n    const proxiedCursor = new Proxy(cursor, cursorIteratorTraps);\n    ittrProxiedCursorToOriginalProxy.set(proxiedCursor, cursor);\n    // Map this double-proxy back to the original, so other cursor methods work.\n    reverseTransformCache.set(proxiedCursor, unwrap(cursor));\n    while (cursor) {\n        yield proxiedCursor;\n        // If one of the advancing methods was not called, call continue().\n        cursor = await (advanceResults.get(proxiedCursor) || cursor.continue());\n        advanceResults.delete(proxiedCursor);\n    }\n}\nfunction isIteratorProp(target, prop) {\n    return ((prop === Symbol.asyncIterator &&\n        instanceOfAny(target, [IDBIndex, IDBObjectStore, IDBCursor])) ||\n        (prop === 'iterate' && instanceOfAny(target, [IDBIndex, IDBObjectStore])));\n}\nreplaceTraps((oldTraps) => ({\n    ...oldTraps,\n    get(target, prop, receiver) {\n        if (isIteratorProp(target, prop))\n            return iterate;\n        return oldTraps.get(target, prop, receiver);\n    },\n    has(target, prop) {\n        return isIteratorProp(target, prop) || oldTraps.has(target, prop);\n    },\n}));\n\nexport { deleteDB, openDB, unwrap, wrap };\n","// prettier-ignore\nconst HANKAKU_KATAKANA_TO_ZENKAKU = [\n 0x3002, 0x300c, 0x300d, 0x3001, 0x30fb, 0x30f2, 0x30a1, 0x30a3, 0x30a5,\n 0x30a7, 0x30a9, 0x30e3, 0x30e5, 0x30e7, 0x30c3, 0x30fc, 0x30a2, 0x30a4,\n 0x30a6, 0x30a8, 0x30aa, 0x30ab, 0x30ad, 0x30af, 0x30b1, 0x30b3, 0x30b5,\n 0x30b7, 0x30b9, 0x30bb, 0x30bd, 0x30bf, 0x30c1, 0x30c4, 0x30c6, 0x30c8,\n 0x30ca, 0x30cb, 0x30cc, 0x30cd, 0x30ce, 0x30cf, 0x30d2, 0x30d5, 0x30d8,\n 0x30db, 0x30de, 0x30df, 0x30e0, 0x30e1, 0x30e2, 0x30e4, 0x30e6, 0x30e8,\n 0x30e9, 0x30ea, 0x30eb, 0x30ec, 0x30ed, 0x30ef, 0x30f3, 0x3099, 0x309a,\n];\n\n// prettier-ignore\nconst VOICED_TO_COMPOSED = new Map([\n  [0x3046, 0x3094], [0x304b, 0x304c], [0x304d, 0x304e], [0x304f, 0x3050],\n  [0x3051, 0x3052], [0x3053, 0x3054], [0x3055, 0x3056], [0x3057, 0x3058],\n  [0x3059, 0x305a], [0x305b, 0x305c], [0x305d, 0x305e], [0x305f, 0x3060],\n  [0x3061, 0x3062], [0x3064, 0x3065], [0x3066, 0x3067], [0x3068, 0x3069],\n  [0x306f, 0x3070], [0x3072, 0x3073], [0x3075, 0x3076], [0x3078, 0x3079],\n  [0x307b, 0x307c], [0x309d, 0x309e], [0x30ab, 0x30ac], [0x30ad, 0x30ae],\n  [0x30a6, 0x30f4], [0x30af, 0x30b0], [0x30b1, 0x30b2], [0x30b3, 0x30b4],\n  [0x30b5, 0x30b6], [0x30b7, 0x30b8], [0x30b9, 0x30ba], [0x30bb, 0x30bc],\n  [0x30bd, 0x30be], [0x30bf, 0x30c0], [0x30c1, 0x30c2], [0x30c4, 0x30c5],\n  [0x30c6, 0x30c7], [0x30c8, 0x30c9], [0x30cf, 0x30d0], [0x30d2, 0x30d3],\n  [0x30d5, 0x30d6], [0x30d8, 0x30d9], [0x30db, 0x30dc], [0x30ef, 0x30f7],\n  [0x30f0, 0x30f8], [0x30f1, 0x30f9], [0x30f2, 0x30fa], [0x30fd, 0x30fe]\n]);\n\n// prettier-ignore\nconst SEMIVOICED_TO_COMPOSED = new Map([\n  [0x306f, 0x3071], [0x3072, 0x3074], [0x3075, 0x3077], [0x3078, 0x307a],\n  [0x307b, 0x307d], [0x30cf, 0x30d1], [0x30d2, 0x30d4], [0x30d5, 0x30d7],\n  [0x30d8, 0x30da], [0x30db, 0x30dd]\n]);\n\n// First part of the CJK Compatibility block: 0x3300-0x3370\n// prettier-ignore\nconst COMBINED_CHARS_A = [\n '', '', '', '', '', '', '',\n  '', '', '', '', '', '',\n  '', '', '', '', '', '', '',\n  '', '', '', '', '', '',\n  '', '', '', '', '', '',\n  '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '',\n  '', '', '', '', '', '',\n  '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '',\n  '', '0', '1', '2', '3', '4', '5', '6', '7', '8',\n  '9', '10', '11', '12', '13', '14', '15', '16', '17', '18',\n  '19', '20', '21', '22', '23', '24'\n];\n\n// Second part of the CJK Compatibility block: 0x337b-0x337f\n// prettier-ignore\nconst COMBINED_CHARS_B = ['', '', '', '', ''];\n\n// First part of Enclosed CJK letters and motnhs block: 0x3220-0x3247\n// prettier-ignore\nconst ENCLOSED_CHARS_A = [\n  '', '', '', '', '', '', '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '', '', '', '', '', '', '',\n  ''\n];\n\n// Second part of Enclosed CJK letters and motnhs block: 0x3280-0x32b0\n// prettier-ignore\nconst ENCLOSED_CHARS_B = [\n  '', '', '', '', '', '', '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '', '', '', ''\n];\n\n// Third part of Enclosed CJK letters and motnhs block: 0x32c0-0x32cb\n// prettier-ignore\nconst ENCLOSED_CHARS_C = [\n  '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11',\n  '12'\n];\n\n// Fourth part of Enclosed CJK letters and motnhs block: 0x32d0-0x32ff\n// prettier-ignore\nconst ENCLOSED_CHARS_D = [\n  '', '', '', '', '', '', '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '', '', '', '', '', '', '',\n  '', '', '', '', '', '', '', '', ''\n];\n\n// We should handle the Enclosed Ideographic Supplement too\n// (https://en.wikipedia.org/wiki/Enclosed_Ideographic_Supplement)\n// but it's in the SMP so it makes processing more complicated.\n//\n// We'll wait until it's actually needed.\n\n// The following is a mapping from radical characters in the Kangxi Radicals\n// and _some_ of the radicals in the CJK Radicals Supplement block.\n//\n// The purpose of this mapping is to help in looking up mis-encoded characters.\n// Therefore, we have deliberately _not_ included some characters where even\n// where there's a possible mapping because the characters don't necessarily\n// look similar or are ambiguous (e.g. the different variants on ).\n//\n// We've also avoided using equivalents that are not in the BMP even if they're\n// better because it seems unlikely someone would have wanted to encode a\n// non-BMP character and used a radical character instead.\nconst RADICAL_TO_KANJI_CHARS: ReadonlyArray<[number, number]> = [\n  //   \n  [0x2f00, 0x4e00],\n  //   \n  [0x2f01, 0x4e28],\n  //   \n  [0x2f02, 0x4e36],\n  //   \n  [0x2f03, 0x4e3f],\n  //   \n  [0x2f04, 0x4e59],\n  //   \n  [0x2f05, 0x4e85],\n  //   \n  [0x2f06, 0x4e8c],\n  //   \n  [0x2f07, 0x4ea0],\n  //   \n  [0x2f08, 0x4eba],\n  //   \n  [0x2f09, 0x513f],\n  //   \n  [0x2f0a, 0x5165],\n  //   \n  [0x2f0b, 0x516b],\n  //   \n  [0x2f0c, 0x5182],\n  //   \n  [0x2f0d, 0x5196],\n  //   \n  [0x2f0e, 0x51ab],\n  //   \n  [0x2f0f, 0x51e0],\n  //   \n  [0x2f10, 0x51f5],\n  //   \n  [0x2f11, 0x5200],\n  //   \n  [0x2f12, 0x529b],\n  //   \n  [0x2f13, 0x52f9],\n  //   \n  [0x2f14, 0x5315],\n  //   \n  [0x2f15, 0x531a],\n  //   \n  [0x2f16, 0x5338],\n  //   \n  [0x2f17, 0x5341],\n  //   \n  [0x2f18, 0x535c],\n  //   \n  [0x2f19, 0x5369],\n  //   \n  [0x2f1a, 0x5382],\n  //   \n  [0x2f1b, 0x53b6],\n  //   \n  [0x2f1c, 0x53c8],\n  //   \n  [0x2f1d, 0x53e3],\n  //   \n  [0x2f1e, 0x56d7],\n  //   \n  [0x2f1f, 0x571f],\n  //   \n  [0x2f20, 0x58eb],\n  //   \n  [0x2f21, 0x5902],\n  //   \n  [0x2f22, 0x590a],\n  //   \n  [0x2f23, 0x5915],\n  //   \n  [0x2f24, 0x5927],\n  //   \n  [0x2f25, 0x5973],\n  //   \n  [0x2f26, 0x5b50],\n  //   \n  [0x2f27, 0x5b80],\n  //   \n  [0x2f28, 0x5bf8],\n  //   \n  [0x2f29, 0x5c0f],\n  //   \n  [0x2f2a, 0x5c22],\n  //   \n  [0x2f2b, 0x5c38],\n  //   \n  [0x2f2c, 0x5c6e],\n  //   \n  [0x2f2d, 0x5c71],\n  //   \n  [0x2f2e, 0x5ddb],\n  //   \n  [0x2f2f, 0x5de5],\n  //   \n  [0x2f30, 0x5df1],\n  //   \n  [0x2f31, 0x5dfe],\n  //   \n  [0x2f32, 0x5e72],\n  //   \n  [0x2f33, 0x5e7a],\n  //   \n  [0x2f34, 0x5e7f],\n  //   \n  [0x2f35, 0x5ef4],\n  //   \n  [0x2f36, 0x5efe],\n  //   \n  [0x2f37, 0x5f0b],\n  //   \n  [0x2f38, 0x5f13],\n  //   \n  [0x2f39, 0x5f50],\n  //   \n  [0x2f3a, 0x5f61],\n  //   \n  [0x2f3b, 0x5f73],\n  //   \n  [0x2f3c, 0x5fc3],\n  //   \n  [0x2f3d, 0x6208],\n  //   \n  [0x2f3e, 0x6236],\n  //   \n  [0x2f3f, 0x624b],\n  //   \n  [0x2f40, 0x652f],\n  //   \n  [0x2f41, 0x6534],\n  //   \n  [0x2f42, 0x6587],\n  //   \n  [0x2f43, 0x6597],\n  //   \n  [0x2f44, 0x65a4],\n  //   \n  [0x2f45, 0x65b9],\n  //   \n  [0x2f46, 0x65e0],\n  //   \n  [0x2f47, 0x65e5],\n  //   \n  [0x2f48, 0x66f0],\n  //   \n  [0x2f49, 0x6708],\n  //   \n  [0x2f4a, 0x6728],\n  //   \n  [0x2f4b, 0x6b20],\n  //   \n  [0x2f4c, 0x6b62],\n  //   \n  [0x2f4d, 0x6b79],\n  //   \n  [0x2f4e, 0x6bb3],\n  //   \n  [0x2f4f, 0x6bcb],\n  //   \n  [0x2f50, 0x6bd4],\n  //   \n  [0x2f51, 0x6bdb],\n  //   \n  [0x2f52, 0x6c0f],\n  //   \n  [0x2f53, 0x6c14],\n  //   \n  [0x2f54, 0x6c34],\n  //   \n  [0x2f55, 0x706b],\n  //   \n  [0x2f56, 0x722a],\n  //   \n  [0x2f57, 0x7236],\n  //   \n  [0x2f58, 0x723b],\n  //   \n  [0x2f59, 0x723f],\n  //   \n  [0x2f5a, 0x7247],\n  //   \n  [0x2f5b, 0x7259],\n  //   \n  [0x2f5c, 0x725b],\n  //   \n  [0x2f5d, 0x72ac],\n  //   \n  [0x2f5e, 0x7384],\n  //   \n  [0x2f5f, 0x7389],\n  //   \n  [0x2f60, 0x74dc],\n  //   \n  [0x2f61, 0x74e6],\n  //   \n  [0x2f62, 0x7518],\n  //   \n  [0x2f63, 0x751f],\n  //   \n  [0x2f64, 0x7528],\n  //   \n  [0x2f65, 0x7530],\n  //   \n  [0x2f66, 0x758b],\n  //   \n  [0x2f67, 0x7592],\n  //   \n  [0x2f68, 0x7676],\n  //   \n  [0x2f69, 0x767d],\n  //   \n  [0x2f6a, 0x76ae],\n  //   \n  [0x2f6b, 0x76bf],\n  //   \n  [0x2f6c, 0x76ee],\n  //   \n  [0x2f6d, 0x77db],\n  //   \n  [0x2f6e, 0x77e2],\n  //   \n  [0x2f6f, 0x77f3],\n  //   \n  [0x2f70, 0x793a],\n  //   \n  [0x2f71, 0x79b8],\n  //   \n  [0x2f72, 0x79be],\n  //   \n  [0x2f73, 0x7a74],\n  //   \n  [0x2f74, 0x7acb],\n  //   \n  [0x2f75, 0x7af9],\n  //   \n  [0x2f76, 0x7c73],\n  //   \n  [0x2f77, 0x7cf8],\n  //   \n  [0x2f78, 0x7f36],\n  //   \n  [0x2f79, 0x7f51],\n  //   \n  [0x2f7a, 0x7f8a],\n  //   \n  [0x2f7b, 0x7fbd],\n  //   \n  [0x2f7c, 0x8001],\n  //   \n  [0x2f7d, 0x800c],\n  //   \n  [0x2f7e, 0x8012],\n  //   \n  [0x2f7f, 0x8033],\n  //   \n  [0x2f80, 0x807f],\n  //   \n  [0x2f81, 0x8089],\n  //   \n  [0x2f82, 0x81e3],\n  //   \n  [0x2f83, 0x81ea],\n  //   \n  [0x2f84, 0x81f3],\n  //   \n  [0x2f85, 0x81fc],\n  //   \n  [0x2f86, 0x820c],\n  //   \n  [0x2f87, 0x821b],\n  //   \n  [0x2f88, 0x821f],\n  //   \n  [0x2f89, 0x826e],\n  //   \n  [0x2f8a, 0x8272],\n  //   \n  [0x2f8b, 0x8278],\n  //   \n  [0x2f8c, 0x864d],\n  //   \n  [0x2f8d, 0x866b],\n  //   \n  [0x2f8e, 0x8840],\n  //   \n  [0x2f8f, 0x884c],\n  //   \n  [0x2f90, 0x8863],\n  //   \n  [0x2f91, 0x897e],\n  //   \n  [0x2f92, 0x898b],\n  //   \n  [0x2f93, 0x89d2],\n  //   \n  [0x2f94, 0x8a00],\n  //   \n  [0x2f95, 0x8c37],\n  //   \n  [0x2f96, 0x8c46],\n  //   \n  [0x2f97, 0x8c55],\n  //   \n  [0x2f98, 0x8c78],\n  //   \n  [0x2f99, 0x8c9d],\n  //   \n  [0x2f9a, 0x8d64],\n  //   \n  [0x2f9b, 0x8d70],\n  //   \n  [0x2f9c, 0x8db3],\n  //   \n  [0x2f9d, 0x8eab],\n  //   \n  [0x2f9e, 0x8eca],\n  //   \n  [0x2f9f, 0x8f9b],\n  //   \n  [0x2fa0, 0x8fb0],\n  //   \n  [0x2fa1, 0x8fb5],\n  //   \n  [0x2fa2, 0x9091],\n  //   \n  [0x2fa3, 0x9149],\n  //   \n  [0x2fa4, 0x91c6],\n  //   \n  [0x2fa5, 0x91cc],\n  //   \n  [0x2fa6, 0x91d1],\n  //   \n  [0x2fa7, 0x9577],\n  //   \n  [0x2fa8, 0x9580],\n  //   \n  [0x2fa9, 0x961c],\n  //   \n  [0x2faa, 0x96b6],\n  //   \n  [0x2fab, 0x96b9],\n  //   \n  [0x2fac, 0x96e8],\n  //   \n  [0x2fad, 0x9751],\n  //   \n  [0x2fae, 0x975e],\n  //   \n  [0x2faf, 0x9762],\n  //   \n  [0x2fb0, 0x9769],\n  //   \n  [0x2fb1, 0x97cb],\n  //   \n  [0x2fb2, 0x97ed],\n  //   \n  [0x2fb3, 0x97f3],\n  //   \n  [0x2fb4, 0x9801],\n  //   \n  [0x2fb5, 0x98a8],\n  //   \n  [0x2fb6, 0x98db],\n  //   \n  [0x2fb7, 0x98df],\n  //   \n  [0x2fb8, 0x9996],\n  //   \n  [0x2fb9, 0x9999],\n  //   \n  [0x2fba, 0x99ac],\n  //   \n  [0x2fbb, 0x9aa8],\n  //   \n  [0x2fbc, 0x9ad8],\n  //   \n  [0x2fbd, 0x9adf],\n  //   \n  [0x2fbe, 0x9b25],\n  //   \n  [0x2fbf, 0x9b2f],\n  //   \n  [0x2fc0, 0x9b32],\n  //   \n  [0x2fc1, 0x9b3c],\n  //   \n  [0x2fc2, 0x9b5a],\n  //   \n  [0x2fc3, 0x9ce5],\n  //   \n  [0x2fc4, 0x9e75],\n  //   \n  [0x2fc5, 0x9e7f],\n  //   \n  [0x2fc6, 0x9ea5],\n  //   \n  [0x2fc7, 0x9ebb],\n  //   \n  [0x2fc8, 0x9ec3],\n  //   \n  [0x2fc9, 0x9ecd],\n  //   \n  [0x2fca, 0x9ed1],\n  //   \n  [0x2fcb, 0x9ef9],\n  //   \n  [0x2fcc, 0x9efd],\n  //   \n  [0x2fcd, 0x9f0e],\n  //   \n  [0x2fce, 0x9f13],\n  //   \n  [0x2fcf, 0x9f20],\n  //   \n  [0x2fd0, 0x9f3b],\n  //   \n  [0x2fd1, 0x9f4a],\n  //   \n  [0x2fd2, 0x9f52],\n  //   \n  [0x2fd3, 0x9f8d],\n  //   \n  [0x2fd4, 0x9f9c],\n  //   \n  [0x2fd5, 0x9fa0],\n  //   \n  [0x2e81, 0x5382],\n  //   \n  [0x2e83, 0x4e5a],\n  //   \n  [0x2e85, 0x4ebb],\n  //   \n  [0x2e86, 0x5182],\n  //   \n  [0x2e87, 0x51e0],\n  //   \n  [0x2e89, 0x5202],\n  //   \n  [0x2e8e, 0x5140],\n  //   \n  [0x2e8f, 0x5c23],\n  //   \n  [0x2e90, 0x5c22],\n  //   \n  [0x2e91, 0x5c23],\n  //   \n  [0x2e92, 0x5df3],\n  //   \n  [0x2e93, 0x5e7a],\n  //   \n  [0x2e94, 0x5f51],\n  //   \n  [0x2e95, 0x5f50],\n  //   \n  [0x2e96, 0x5fc4],\n  //   \n  [0x2e98, 0x624c],\n  //   \n  [0x2e99, 0x6535],\n  //   \n  [0x2e9b, 0x65e1],\n  //   \n  [0x2e9d, 0x6708],\n  //   \n  [0x2e9e, 0x6b7a],\n  //   \n  [0x2e9f, 0x6bcd],\n  //   \n  [0x2ea0, 0x6c11],\n  //   \n  [0x2ea1, 0x6c35],\n  //   \n  [0x2ea2, 0x6c3a],\n  //   \n  [0x2ea3, 0x706c],\n  //   \n  [0x2ea4, 0x722b],\n  //   \n  [0x2ea5, 0x722b],\n  //   \n  [0x2ea6, 0x4e2c],\n  //   \n  [0x2ea8, 0x72ad],\n  //   \n  [0x2eab, 0x7f52],\n  //   \n  [0x2eaf, 0x7cf9],\n  //   \n  [0x2eb0, 0x7e9f],\n  //   \n  [0x2eb1, 0x7f53],\n  //   \n  [0x2eb4, 0x34c1],\n  //   \n  [0x2eb8, 0x7f8b],\n  //   \n  [0x2eb9, 0x8002],\n  //   \n  [0x2eba, 0x8080],\n  //   \n  [0x2ebd, 0x81fc],\n  //   \n  [0x2ebe, 0x8279],\n  //   \n  [0x2ec1, 0x864e],\n  //   \n  [0x2ec2, 0x8864],\n  //   \n  [0x2ec3, 0x8980],\n  //   \n  [0x2ec4, 0x897f],\n  //   \n  [0x2ec5, 0x89c1],\n  //   \n  [0x2ec6, 0x89d2],\n  //   \n  [0x2ec8, 0x8ba0],\n  //   \n  [0x2ec9, 0x8d1d],\n  //   \n  [0x2ecb, 0x8f66],\n  //   \n  [0x2ed0, 0x9485],\n  //   \n  [0x2ed1, 0x9577],\n  //   \n  [0x2ed2, 0x9578],\n  //   \n  [0x2ed3, 0x957f],\n  //   \n  [0x2ed4, 0x95e8],\n  //   \n  [0x2ed6, 0x961d],\n  //   \n  [0x2ed8, 0x9752],\n  //   \n  [0x2ed9, 0x97e6],\n  //   \n  [0x2eda, 0x9875],\n  //   \n  [0x2edb, 0x98ce],\n  //   \n  [0x2edc, 0x98de],\n  //   \n  [0x2edd, 0x98df],\n  //   \n  [0x2edf, 0x98e0],\n  //   \n  [0x2ee0, 0x9963],\n  //   \n  [0x2ee2, 0x9a6c],\n  //   \n  [0x2ee3, 0x9aa8],\n  //   \n  [0x2ee4, 0x9b3c],\n  //   \n  [0x2ee5, 0x9c7c],\n  //   \n  [0x2ee6, 0x9e1f],\n  //   \n  [0x2ee7, 0x5364],\n  //   \n  [0x2ee8, 0x9ea6],\n  //   \n  [0x2ee9, 0x9ec4],\n  //   \n  [0x2eea, 0x9efe],\n  //   \n  [0x2eeb, 0x6589],\n  //   \n  [0x2eec, 0x9f50],\n  //   \n  [0x2eed, 0x6b6f],\n  //   \n  [0x2eee, 0x9f7f],\n  //   \n  [0x2eef, 0x7adc],\n  //   \n  [0x2ef0, 0x9f99],\n  //   \n  [0x2ef1, 0x9f9c],\n  //   \n  [0x2ef2, 0x4e80],\n  //   \n  [0x2ef3, 0x9f9f],\n];\n\nlet RADICAL_TO_KANJI: Map<number, number> | undefined;\n\n// Converts:\n//\n// - half-width katakana to full-width katakana (e.g.   )\n// - decomposed characters to their composed equivalents\n//   (e.g.   )\n// - various enclosed characters into their plain form\n//   (e.g.   )\n// - various combined characters into their expanded form\n//   (e.g.   ,   )\n// - characters with variation selectors into the base character only\n// - radicals into the equivalent kanji character\n//\n// while maintaining a mapping from output character offsets to input\n// offsets.\nexport function toNormalized(input: string): [string, number[]] {\n  // Lazily create the radical map to that RADICAL_TO_KANJI_CHARS can be\n  // tree-shaken when this function is not being used (unlike arrays, Maps()\n  // always seem to be included because presumably the ctor could have\n  // side-effects).\n  if (!RADICAL_TO_KANJI) {\n    RADICAL_TO_KANJI = new Map(RADICAL_TO_KANJI_CHARS);\n  }\n\n  let inputLengths = [0];\n  let result = '';\n\n  for (let i = 0; i < input.length; ++i) {\n    let c = input.charCodeAt(i);\n\n    // Drop Unicode variation selectors\n    if ((c >= 0xfe00 && c <= 0xfe0f) || (c >= 0xe0100 && c <= 0xe011f)) {\n      inputLengths[result.length] = i + 1;\n      continue;\n    }\n\n    // Half-width to full-width katakana\n    if (c >= 0xff61 && c <= 0xff9f) {\n      c = HANKAKU_KATAKANA_TO_ZENKAKU[c - 0xff61]!;\n    }\n\n    // Decomposed characters (including any half-width katakana which we just\n    // converted since half-width katakana is always decomposed).\n    const prevChar = result.length ? result.charCodeAt(result.length - 1) : 0;\n    if (c === 0x3099) {\n      const composed = VOICED_TO_COMPOSED.get(prevChar);\n      if (composed) {\n        result = result.slice(0, -1);\n        c = composed;\n      }\n    } else if (c === 0x309a) {\n      // Decomposed semi-voiced mark (full-width or half-width)\n      const composed = SEMIVOICED_TO_COMPOSED.get(prevChar);\n      if (composed) {\n        result = result.slice(0, -1);\n        c = composed;\n      }\n    }\n\n    // Look for an expanded character\n    let expanded: string | undefined;\n    if (c >= 0x3300 && c <= 0x3370) {\n      expanded = COMBINED_CHARS_A[c - 0x3300];\n    } else if (c >= 0x337b && c <= 0x337f) {\n      expanded = COMBINED_CHARS_B[c - 0x337b];\n    } else if (c >= 0x3220 && c <= 0x3247) {\n      expanded = ENCLOSED_CHARS_A[c - 0x3220];\n    } else if (c >= 0x3280 && c <= 0x32b0) {\n      expanded = ENCLOSED_CHARS_B[c - 0x3280];\n    } else if (c >= 0x32c0 && c <= 0x32cb) {\n      expanded = ENCLOSED_CHARS_C[c - 0x32c0];\n    } else if (c >= 0x32d0 && c <= 0x32ff) {\n      expanded = ENCLOSED_CHARS_D[c - 0x32d0];\n    }\n\n    // Look for radical characters to map to kanji\n    const radical = !expanded ? RADICAL_TO_KANJI.get(c) : undefined;\n    if (radical) {\n      expanded = String.fromCodePoint(radical);\n    }\n\n    if (expanded) {\n      result += expanded;\n      inputLengths.push(...Array(expanded.length - 1).fill(i));\n    } else {\n      result += String.fromCharCode(c);\n    }\n    inputLengths[result.length] = i + 1;\n  }\n\n  return [result, inputLengths];\n}\n","export class AbortError extends Error {\n  constructor(...params: any[]) {\n    super(...params);\n    Object.setPrototypeOf(this, AbortError.prototype);\n\n    if (typeof (Error as any).captureStackTrace === 'function') {\n      (Error as any).captureStackTrace(this, AbortError);\n    }\n\n    this.name = 'AbortError';\n  }\n}\n","export type DataSeries = 'words' | 'kanji' | 'radicals' | 'names';\n\nexport const allDataSeries: ReadonlyArray<DataSeries> = [\n  'words',\n  'kanji',\n  'radicals',\n  'names',\n];\n\nexport function isDataSeries(a: unknown): a is DataSeries {\n  return typeof a === 'string' && allDataSeries.includes(a as DataSeries);\n}\n\n// For certain interface actions we lump kanji and radicals together.\n// e.g. If you want to update the kanji data set, you need to update the\n// radicals too since we cross-reference the two.\n//\n// We call the combined set a \"major\" data series.\nexport type MajorDataSeries = 'words' | 'kanji' | 'names';\n\nexport const allMajorDataSeries: ReadonlyArray<MajorDataSeries> = [\n  'words',\n  'kanji',\n  'names',\n];\n\nexport function isMajorDataSeries(a: unknown): a is MajorDataSeries {\n  return (\n    typeof a === 'string' && allMajorDataSeries.includes(a as MajorDataSeries)\n  );\n}\n","export type DownloadErrorCode =\n  | 'VersionFileNotFound'\n  | 'VersionFileNotAccessible'\n  | 'VersionFileInvalid'\n  | 'MajorVersionNotFound'\n  | 'DatabaseFileNotFound'\n  | 'DatabaseFileNotAccessible'\n  | 'DatabaseFileHeaderMissing'\n  | 'DatabaseFileHeaderDuplicate'\n  | 'DatabaseFileVersionMismatch'\n  | 'DatabaseFileInvalidJSON'\n  | 'DatabaseFileInvalidRecord'\n  | 'DatabaseTooOld'\n  | 'Timeout';\n\ntype DownloadErrorOptions = {\n  code: DownloadErrorCode;\n  url?: string;\n};\n\nexport class DownloadError extends Error {\n  code: DownloadErrorCode;\n  url?: string;\n\n  constructor({ code, url }: DownloadErrorOptions, ...params: any[]) {\n    super(...params);\n    Object.setPrototypeOf(this, DownloadError.prototype);\n\n    if (typeof (Error as any).captureStackTrace === 'function') {\n      (Error as any).captureStackTrace(this, DownloadError);\n    }\n\n    this.name = 'DownloadError';\n    this.code = code;\n    this.url = url;\n  }\n}\n","import * as s from 'superstruct';\n\nexport const safeInteger = (): s.Struct<number, null> =>\n  s.refine(s.integer(), 'safeInteger', (value) => Number.isSafeInteger(value));\n","import * as s from 'superstruct';\n\nimport { AbortError } from './abort-error';\nimport { DownloadError } from './download-error';\nimport {\n  getErrorMessage,\n  isAbortError,\n  isDownloadError,\n} from './error-parsing';\nimport { fetchWithTimeout } from './fetch';\nimport { safeInteger } from './validation-helpers';\n\nexport type VersionInfo = s.Infer<typeof VersionInfoStruct>;\n\nexport async function getVersionInfo({\n  baseUrl,\n  series,\n  lang,\n  majorVersion,\n  timeout,\n  signal,\n}: {\n  baseUrl: string;\n  series: string;\n  lang: string;\n  majorVersion: number;\n  timeout: number;\n  signal?: AbortSignal;\n}): Promise<VersionInfo> {\n  const versionInfoFile = await getVersionInfoFile({\n    baseUrl,\n    lang,\n    timeout,\n    signal,\n  });\n\n  // Extract the appropriate database version information\n  const dbVersionInfo = getCurrentVersionInfo(\n    versionInfoFile,\n    series,\n    majorVersion\n  );\n  if (!dbVersionInfo) {\n    throw new DownloadError(\n      { code: 'VersionFileInvalid' },\n      `Invalid version object: the requested series, ${series} was not available in this language ('${lang}')`\n    );\n  }\n\n  return dbVersionInfo;\n}\n\nexport function clearCachedVersionInfo() {\n  cachedVersionInfo = undefined;\n}\n\nconst CACHE_TIMEOUT = 3_000 * 60; // Cache version file contents for 3 minutes\n\nlet cachedVersionInfo:\n  | { lang: string; versionInfoFile: VersionInfoFile; accessTime: number }\n  | undefined;\n\nasync function getVersionInfoFile({\n  baseUrl,\n  lang,\n  timeout,\n  signal,\n}: {\n  baseUrl: string;\n  lang: string;\n  timeout: number;\n  signal?: AbortSignal;\n}): Promise<VersionInfoFile> {\n  if (\n    cachedVersionInfo?.lang === lang &&\n    cachedVersionInfo.accessTime > Date.now() - CACHE_TIMEOUT\n  ) {\n    return cachedVersionInfo.versionInfoFile;\n  }\n  cachedVersionInfo = undefined;\n  const accessTime = Date.now();\n\n  let rawVersionInfoFile;\n\n  const url = `${baseUrl}jpdict/reader/version-${lang}.json`;\n\n  let response;\n  try {\n    response = await fetchWithTimeout(url, { signal, timeout });\n  } catch (e) {\n    if (isAbortError(e) || isDownloadError(e)) {\n      throw e;\n    }\n\n    throw new DownloadError(\n      { code: 'VersionFileNotAccessible', url },\n      `Version file ${url} not accessible (${getErrorMessage(e)})`\n    );\n  }\n\n  // Fetch rejects the promise for network errors, but not for HTTP errors :(\n  if (!response.ok) {\n    const code =\n      response.status === 404\n        ? 'VersionFileNotFound'\n        : 'VersionFileNotAccessible';\n    throw new DownloadError(\n      { code, url },\n      `Version file ${url} not accessible (status: ${response.status})`\n    );\n  }\n\n  // Try to parse it\n  try {\n    rawVersionInfoFile = await response.json();\n  } catch (e) {\n    throw new DownloadError(\n      { code: 'VersionFileInvalid', url },\n      `Invalid version object: ${\n        getErrorMessage(e) || '(No detailed error message)'\n      }`\n    );\n  }\n\n  if (signal?.aborted) {\n    throw new AbortError();\n  }\n\n  const versionInfoFile = parseVersionInfoFile(rawVersionInfoFile);\n\n  cachedVersionInfo = { lang, versionInfoFile, accessTime };\n\n  return versionInfoFile;\n}\n\nconst VersionInfoStruct = s.type({\n  major: s.min(safeInteger(), 1),\n  minor: s.min(safeInteger(), 0),\n  patch: s.min(safeInteger(), 0),\n  parts: s.optional(s.min(safeInteger(), 1)),\n  databaseVersion: s.optional(s.string()),\n  dateOfCreation: s.nonempty(s.string()),\n});\n\nconst VersionInfoFileStruct = s.record(\n  s.string(),\n  s.record(s.string(), VersionInfoStruct)\n);\n\ntype VersionInfoFile = s.Infer<typeof VersionInfoFileStruct>;\n\nfunction parseVersionInfoFile(rawVersionInfoFile: unknown): VersionInfoFile {\n  if (!rawVersionInfoFile) {\n    throw new DownloadError(\n      { code: 'VersionFileInvalid' },\n      'Empty version info file'\n    );\n  }\n\n  const [error, versionInfoFile] = s.validate(\n    rawVersionInfoFile,\n    VersionInfoFileStruct\n  );\n\n  if (error) {\n    throw new DownloadError(\n      { code: 'VersionFileInvalid' },\n      `Version file was invalid: ${error}`\n    );\n  }\n\n  return versionInfoFile;\n}\n\nfunction getCurrentVersionInfo(\n  versionInfoFile: VersionInfoFile,\n  series: string,\n  majorVersion: number\n): VersionInfo | null {\n  if (!(series in versionInfoFile)) {\n    return null;\n  }\n\n  if (!(majorVersion in versionInfoFile[series])) {\n    throw new DownloadError(\n      { code: 'MajorVersionNotFound' },\n      `No ${majorVersion}.x version information for ${series} data`\n    );\n  }\n\n  return versionInfoFile[series][majorVersion];\n}\n","import * as s from 'superstruct';\n\nimport { DataSeries } from './data-series';\nimport { DataVersion } from './data-version';\nimport { DownloadError } from './download-error';\nimport { getVersionInfo } from './download-version-info';\nimport {\n  getErrorMessage,\n  isAbortError,\n  isDownloadError,\n} from './error-parsing';\nimport { fetchWithTimeout } from './fetch';\nimport { isObject } from './is-object';\nimport { ljsonStreamIterator } from './ljson-stream';\nimport { PartInfo } from './part-info';\nimport { stripFields } from './utils';\nimport { safeInteger } from './validation-helpers';\nimport { compareVersions, VersionNumber } from './version-number';\n\n// Produces an async interator of DownloadEvents\n\n//\n// Event types\n//\n\nexport type DownloadEvent =\n  | ResetEvent\n  | DownloadStartEvent\n  | DownloadEndEvent\n  | FileStartEvent\n  | FileEndEvent\n  | RecordEvent;\n\nexport type ResetEvent = { type: 'reset' };\nexport type DownloadStartEvent = { type: 'downloadstart'; files: number };\nexport type DownloadEndEvent = { type: 'downloadend' };\nexport type FileStartEvent = {\n  type: 'filestart';\n  version: DataVersion;\n  totalRecords: number;\n};\nexport type FileEndEvent = { type: 'fileend' };\nexport type RecordEvent = {\n  type: 'record';\n  mode: 'add' | 'change' | 'delete';\n  record: Record<string, unknown>;\n};\n\n//\n// Helper types\n//\n\nexport type CurrentVersion = VersionNumber & {\n  partInfo?: PartInfo;\n};\n\n//\n// Configuration constants\n//\n\nconst BASE_URL = 'https://data.10ten.life/';\n\nconst DOWNLOAD_TIMEOUT = 20_000;\n\nexport type DownloadOptions = {\n  series: DataSeries;\n  majorVersion: number;\n  currentVersion?: CurrentVersion;\n  lang: string;\n  signal: AbortSignal;\n};\n\nexport async function hasLanguage({\n  series,\n  majorVersion,\n  lang,\n  signal,\n}: {\n  baseUrl?: string;\n  series: DataSeries;\n  majorVersion: number;\n  lang: string;\n  signal?: AbortSignal;\n}): Promise<boolean> {\n  try {\n    const result = await getVersionInfo({\n      baseUrl: BASE_URL,\n      series,\n      lang,\n      majorVersion,\n      timeout: DOWNLOAD_TIMEOUT,\n      signal,\n    });\n    return !!result;\n  } catch {\n    return false;\n  }\n}\n\nexport async function* download({\n  series,\n  majorVersion,\n  currentVersion,\n  lang,\n  signal,\n}: DownloadOptions): AsyncIterableIterator<DownloadEvent> {\n  const versionInfo = await getVersionInfo({\n    baseUrl: BASE_URL,\n    series,\n    lang,\n    majorVersion,\n    timeout: DOWNLOAD_TIMEOUT,\n    signal,\n  });\n\n  const { files, type } = getDownloadList({\n    currentVersion,\n    latestVersion: versionInfo,\n  });\n\n  if (type === 'reset' && currentVersion) {\n    yield { type: 'reset' };\n  }\n\n  yield { type: 'downloadstart', files: files.length };\n\n  for (const file of files) {\n    yield* getEvents({\n      baseUrl: BASE_URL,\n      series,\n      lang,\n      version: file.version,\n      signal,\n      format: file.format,\n      partInfo: file.partInfo,\n    });\n  }\n\n  yield { type: 'downloadend' };\n}\n\ntype DownloadFileSpec =\n  | {\n      format: 'full';\n      version: VersionNumber;\n      partInfo?: PartInfo;\n    }\n  | {\n      format: 'patch';\n      version: VersionNumber;\n      partInfo?: never;\n    };\n\nfunction getDownloadList({\n  currentVersion,\n  latestVersion,\n}: {\n  currentVersion?: CurrentVersion;\n  latestVersion: {\n    major: number;\n    minor: number;\n    patch: number;\n    parts?: number;\n  };\n}): {\n  type: 'reset' | 'update';\n  files: Array<DownloadFileSpec>;\n} {\n  // Check the local database is not ahead of what we're about to download\n  //\n  // This can happen when the version file gets cached because we can\n  // download a more recent version (e.g. we have DevTools open with \"skip\n  // cache\" ticked) and then try again to fetch the file but get the older\n  // version.\n  if (currentVersion && compareVersions(currentVersion, latestVersion) > 0) {\n    const versionToString = ({ major, minor, patch }: VersionNumber) =>\n      `${major}.${minor}.${patch}`;\n    throw new DownloadError(\n      { code: 'DatabaseTooOld' },\n      `Database version (${versionToString(\n        latestVersion\n      )}) is older than the current version (${versionToString(\n        currentVersion\n      )})`\n    );\n  }\n\n  // If there's no current version or if there's been a change in major/minor\n  // version, reset any existing data.\n  let downloadType =\n    !currentVersion ||\n    compareVersions(currentVersion, { ...latestVersion, patch: 0 }) < 0\n      ? ('reset' as const)\n      : ('update' as const);\n\n  // Furthermore, if we're resuming a multi-part initial download but there have\n  // since been more than 10 new patches to that minor version, we should just\n  // start over.\n  //\n  // This will probably be faster and, more importantly, it means we can archive\n  // the full (i.e. non-patch) version files of any minor version that is more\n  // than 10 patches old without having to worry about really out-of-date\n  // clients later requesting those parts.\n  if (\n    downloadType === 'update' &&\n    currentVersion?.partInfo &&\n    latestVersion.patch - currentVersion.patch > 10\n  ) {\n    downloadType = 'reset';\n  }\n\n  // There are four cases to consider:\n  //\n  // 1. We are doing a full download of a partitioned data series\n  //    i.e. we need to download all the parts from 0 to `parts - 1`.\n  //\n  // 2. We are doing a full download of an unpartitioned data series\n  //    i.e. we simply need to download the data file for the current patch\n  //    level.\n  //\n  // 3. We are resuming a full download\n  //    i.e. we need to download all the remaining parts _and_ any\n  //    subsequent patches.\n  //\n  // 4. We are patching an existing series\n  //    i.e. we need to download each patch from the one after the current\n  //    version up to and including the latest patch.\n\n  // Case 1: Partitioned series\n  if (downloadType === 'reset' && latestVersion.parts) {\n    const files: Array<DownloadFileSpec> = [];\n    let nextPart = 1;\n\n    while (nextPart <= latestVersion.parts) {\n      files.push({\n        format: 'full',\n        version: {\n          major: latestVersion.major,\n          minor: latestVersion.minor,\n          patch: latestVersion.patch,\n        },\n        partInfo: {\n          part: nextPart,\n          parts: latestVersion.parts,\n        },\n      });\n      nextPart++;\n    }\n\n    return { type: downloadType, files };\n  }\n\n  // Case 2: Unpartitioned series\n  if (downloadType === 'reset') {\n    return {\n      type: downloadType,\n      files: [\n        {\n          format: 'full',\n          version: {\n            major: latestVersion.major,\n            minor: latestVersion.minor,\n            patch: latestVersion.patch,\n          },\n        },\n      ],\n    };\n  }\n\n  // The following is just to help TypeScript realise that `currentVersion` must\n  // be defined if `downloadType` is 'update'.\n  if (!currentVersion) {\n    throw new Error(\n      'We should have already dealt with the initial download case'\n    );\n  }\n\n  // Case 3 (part 1): Resumed partitioned series\n  const files: Array<DownloadFileSpec> = [];\n  if (currentVersion.partInfo) {\n    let nextPart = currentVersion.partInfo.part + 1;\n\n    while (nextPart <= currentVersion.partInfo.parts) {\n      files.push({\n        format: 'full',\n        version: {\n          major: currentVersion.major,\n          minor: currentVersion.minor,\n          patch: currentVersion.patch,\n        },\n        partInfo: {\n          part: nextPart,\n          parts: currentVersion.partInfo.parts,\n        },\n      });\n      nextPart++;\n    }\n  }\n\n  // Case 3 (part 2) and case 4: Updating a series\n  let nextPatch = currentVersion.patch + 1;\n  while (nextPatch <= latestVersion.patch) {\n    files.push({\n      format: 'patch',\n      version: {\n        major: latestVersion.major,\n        minor: latestVersion.minor,\n        patch: nextPatch,\n      },\n    });\n    nextPatch++;\n  }\n\n  return { type: downloadType, files };\n}\n\ntype GetEventsOptions = {\n  baseUrl: string;\n  series: DataSeries;\n  lang: string;\n  version: VersionNumber;\n  signal: AbortSignal;\n  format: 'full' | 'patch';\n  partInfo?: PartInfo;\n};\n\nconst HeaderLineStruct = s.type({\n  type: s.literal('header'),\n  version: s.type({\n    major: s.min(safeInteger(), 1),\n    minor: s.min(safeInteger(), 0),\n    patch: s.min(safeInteger(), 0),\n    databaseVersion: s.optional(s.string()),\n    dateOfCreation: s.nonempty(s.string()),\n  }),\n  records: s.min(safeInteger(), 0),\n  part: s.optional(s.min(safeInteger(), 0)),\n  format: s.enums(['patch', 'full']),\n});\n\nconst PatchLineStruct = s.type({\n  _: s.enums(['+', '-', '~']),\n});\n\nasync function* getEvents({\n  baseUrl,\n  series,\n  lang,\n  version,\n  signal,\n  format,\n  partInfo,\n}: GetEventsOptions): AsyncIterableIterator<DownloadEvent> {\n  const dottedVersion = `${version.major}.${version.minor}.${version.patch}`;\n  const commonUrlStart = `${baseUrl}jpdict/reader/${series}/${lang}/${dottedVersion}`;\n  const url =\n    format === 'patch'\n      ? `${commonUrlStart}-patch.jsonl`\n      : partInfo\n        ? `${commonUrlStart}-${partInfo.part}.jsonl`\n        : `${commonUrlStart}.jsonl`;\n\n  let response;\n  try {\n    response = await fetchWithTimeout(url, {\n      signal,\n      timeout: DOWNLOAD_TIMEOUT,\n    });\n  } catch (e) {\n    if (isAbortError(e) || isDownloadError(e)) {\n      throw e;\n    }\n\n    throw new DownloadError(\n      { code: 'DatabaseFileNotFound', url },\n      `Database file ${url} not accessible (${getErrorMessage(e)})`\n    );\n  }\n\n  if (!response.ok) {\n    const code =\n      response.status === 404\n        ? 'DatabaseFileNotFound'\n        : 'DatabaseFileNotAccessible';\n    throw new DownloadError(\n      { code, url },\n      `Database file ${url} not accessible (status: ${response.status})`\n    );\n  }\n\n  if (response.body === null) {\n    throw new DownloadError(\n      { code: 'DatabaseFileNotAccessible', url },\n      'Body is null'\n    );\n  }\n\n  let headerRead = false;\n\n  for await (const line of ljsonStreamIterator({\n    stream: response.body,\n    signal,\n    timeout: DOWNLOAD_TIMEOUT,\n    url,\n  })) {\n    if (s.is(line, HeaderLineStruct)) {\n      if (headerRead) {\n        throw new DownloadError(\n          { code: 'DatabaseFileHeaderDuplicate', url },\n          `Got duplicate database header: ${JSON.stringify(line)}`\n        );\n      }\n\n      if (compareVersions(line.version, version) !== 0) {\n        throw new DownloadError(\n          { code: 'DatabaseFileVersionMismatch', url },\n          `Got mismatched database versions (Expected: ${JSON.stringify(\n            version\n          )} got: ${JSON.stringify(line.version)})`\n        );\n      }\n\n      if (line.part !== partInfo?.part) {\n        throw new DownloadError(\n          { code: 'DatabaseFileVersionMismatch', url },\n          `Got mismatched database part number (Expected: ${partInfo?.part}, got: ${line.part})`\n        );\n      }\n\n      if (line.format !== format) {\n        throw new DownloadError(\n          { code: 'DatabaseFileVersionMismatch', url },\n          `Expected to get a data file in ${format} format but got '${line.format}' format instead`\n        );\n      }\n\n      let fileStartEvent: FileStartEvent;\n      if (line.part !== undefined) {\n        fileStartEvent = {\n          type: 'filestart',\n          totalRecords: line.records,\n          version: {\n            ...line.version,\n            partInfo: {\n              part: line.part,\n              parts: partInfo!.parts,\n            },\n            lang,\n          },\n        };\n      } else {\n        fileStartEvent = {\n          type: 'filestart',\n          totalRecords: line.records,\n          version: {\n            ...line.version,\n            lang,\n          },\n        };\n      }\n\n      yield fileStartEvent;\n\n      headerRead = true;\n    } else if (format === 'patch' && s.is(line, PatchLineStruct)) {\n      if (!headerRead) {\n        throw new DownloadError(\n          { code: 'DatabaseFileHeaderMissing', url },\n          `Expected database version but got ${JSON.stringify(line)}`\n        );\n      }\n\n      const mode =\n        line._ === '+' ? 'add' : line._ === '-' ? 'delete' : 'change';\n      yield { type: 'record', mode, record: stripFields(line, ['_']) };\n    } else if (format === 'full' && isObject(line)) {\n      if (!headerRead) {\n        throw new DownloadError(\n          { code: 'DatabaseFileHeaderMissing', url },\n          `Expected database version but got ${JSON.stringify(line)}`\n        );\n      }\n\n      if ('_' in line) {\n        throw new DownloadError(\n          { code: 'DatabaseFileInvalidRecord', url },\n          `Got patch-like '_' field in non-patch record: ${JSON.stringify(\n            line\n          )}`\n        );\n      }\n\n      yield { type: 'record', mode: 'add', record: line };\n    } else {\n      // If we encounter anything unexpected we should fail.\n      //\n      // It might be tempting to make this \"robust\" by ignoring unrecognized\n      // inputs but that could effectively leave us in an invalid state where\n      // we claim to be update-to-date with database version X but are\n      // actually missing some of the records.\n      //\n      // If anything unexpected shows up we should fail so we can debug\n      // exactly what happenned.\n      throw new DownloadError(\n        { code: 'DatabaseFileInvalidRecord', url },\n        `Got unexpected record: ${JSON.stringify(line)}`\n      );\n    }\n  }\n\n  yield { type: 'fileend' };\n}\n","export class QuotaExceededError extends Error {\n  constructor(...params: any[]) {\n    super(...params);\n    Object.setPrototypeOf(this, QuotaExceededError.prototype);\n\n    if (typeof (Error as any).captureStackTrace === 'function') {\n      (Error as any).captureStackTrace(this, QuotaExceededError);\n    }\n\n    this.name = 'QuotaExceededError';\n    this.message = 'The current transaction exceeded its quota limitations.';\n  }\n}\n","import * as s from 'superstruct';\n\nimport { DataSeries } from './data-series';\nimport { KanjiMiscInfo, KanjiReading, KanjiRecord, Radical } from './kanji';\nimport { NameRecord, NameTranslation } from './names';\nimport { RadicalRecord } from './radicals';\nimport { Overwrite } from './type-helpers';\nimport { safeInteger } from './validation-helpers';\nimport {\n  Accent,\n  CrossReference,\n  KanjiMeta,\n  LangSource,\n  ReadingMeta,\n  WordRecord,\n  WordSense,\n} from './words';\n\n// ----------------------------------------------------------------------------\n//\n// Words\n//\n// ----------------------------------------------------------------------------\n\nconst KanjiMetaSchema: s.Describe<KanjiMeta> = s.type({\n  i: s.optional(s.array(s.string())),\n  p: s.optional(s.array(s.string())),\n  bv: s.optional(s.string()),\n  bg: s.optional(s.string()),\n});\n\nconst AccentSchema: s.Describe<Accent> = s.type({\n  i: s.min(safeInteger(), 0),\n  pos: s.optional(s.array(s.string())),\n});\n\nconst ReadingMetaSchema: s.Describe<ReadingMeta> = s.type({\n  i: s.optional(s.array(s.string())),\n  p: s.optional(s.array(s.string())),\n  app: s.optional(s.min(safeInteger(), 0)),\n  a: s.optional(s.union([s.min(safeInteger(), 0), s.array(AccentSchema)])),\n  bv: s.optional(s.string()),\n  bg: s.optional(s.string()),\n});\n\n// The following typing is because Describe struggles with union types\nconst CrossReferenceSchema: s.Struct<s.Describe<CrossReference>['TYPE'], null> =\n  s.union([\n    s.type({\n      k: s.nonempty(s.string()),\n      sense: s.optional(s.min(safeInteger(), 0)),\n    }),\n    s.type({\n      r: s.nonempty(s.string()),\n      sense: s.optional(s.min(safeInteger(), 0)),\n    }),\n    s.type({\n      k: s.nonempty(s.string()),\n      r: s.string(),\n      sense: s.optional(s.min(safeInteger(), 0)),\n    }),\n  ]);\n\nconst LangSourceSchema: s.Describe<LangSource> = s.type({\n  lang: s.optional(s.nonempty(s.string())),\n  src: s.optional(s.string()),\n  // The following should be:\n  //\n  //   part: s.optional(s.literal(true)),\n  //   wasei: s.optional(s.literal(true)),\n  //\n  // But Describe doesn't seem to handle optional boolean literals so we try\n  // this way for now.\n  part: s.union([s.literal(true), s.literal(undefined)]),\n  wasei: s.union([s.literal(true), s.literal(undefined)]),\n});\n\nconst WordSenseSchema: s.Describe<WordSense> = s.type({\n  g: s.nonempty(s.array(s.nonempty(s.string()))),\n  gt: s.optional(s.min(safeInteger(), 1)),\n  lang: s.optional(s.nonempty(s.string())),\n  kapp: s.optional(s.min(safeInteger(), 0)),\n  rapp: s.optional(s.min(safeInteger(), 0)),\n  pos: s.optional(s.array(s.string())),\n  field: s.optional(s.array(s.string())),\n  misc: s.optional(s.array(s.string())),\n  dial: s.optional(s.array(s.string())),\n  inf: s.optional(s.nonempty(s.string())),\n  xref: s.optional(s.nonempty(s.array(CrossReferenceSchema))),\n  ant: s.optional(s.nonempty(s.array(CrossReferenceSchema))),\n  lsrc: s.optional(s.nonempty(s.array(LangSourceSchema))),\n});\n\nconst WordIdSchema = s.min(safeInteger(), 1);\n\nexport type WordDownloadRecord = Overwrite<\n  WordRecord,\n  {\n    km?: Array<0 | KanjiMeta>;\n    rm?: Array<0 | ReadingMeta>;\n    s: Array<WordSense>;\n  }\n>;\n\nconst WordDownloadRecordSchema: s.Describe<WordDownloadRecord> = s.type({\n  id: WordIdSchema,\n  k: s.optional(s.nonempty(s.array(s.string()))),\n  km: s.optional(s.nonempty(s.array(s.union([s.literal(0), KanjiMetaSchema])))),\n  r: s.array(s.nonempty(s.nonempty(s.string()))),\n  rm: s.optional(\n    s.nonempty(s.array(s.union([s.literal(0), ReadingMetaSchema])))\n  ),\n  s: s.array(WordSenseSchema),\n});\n\nexport function validateWordDownloadRecord(\n  record: unknown\n): [Error, undefined] | [undefined, WordDownloadRecord] {\n  return s.validate(record, WordDownloadRecordSchema);\n}\n\n// -- Delete variant --\n\nexport type WordDownloadDeleteRecord = Pick<WordDownloadRecord, 'id'>;\n\nconst WordDownloadDeleteRecordSchema: s.Describe<WordDownloadDeleteRecord> =\n  s.type({\n    id: WordIdSchema,\n  });\n\nexport function validateWordDownloadDeleteRecord(\n  record: unknown\n): [Error, undefined] | [undefined, WordDownloadDeleteRecord] {\n  return s.validate(record, WordDownloadDeleteRecordSchema);\n}\n\n// ----------------------------------------------------------------------------\n//\n// Names\n//\n// ----------------------------------------------------------------------------\n\nconst NameTranslationSchema: s.Describe<NameTranslation> = s.type({\n  type: s.optional(s.array(s.string())),\n  det: s.array(s.nonempty(s.string())),\n  cf: s.optional(s.array(s.nonempty(s.string()))),\n});\n\nconst NameIdSchema = s.min(safeInteger(), 1);\n\nexport type NameDownloadRecord = NameRecord;\n\nconst NameDownloadRecordSchema: s.Describe<NameDownloadRecord> = s.type({\n  id: NameIdSchema,\n  k: s.optional(s.array(s.nonempty(s.string()))),\n  r: s.nonempty(s.array(s.nonempty(s.string()))),\n  tr: s.array(NameTranslationSchema),\n});\n\nexport function validateNameDownloadRecord(\n  record: unknown\n): [Error, undefined] | [undefined, NameDownloadRecord] {\n  return s.validate(record, NameDownloadRecordSchema);\n}\n\n// -- Delete variant --\n\nexport type NameDownloadDeleteRecord = Pick<NameDownloadRecord, 'id'>;\n\nconst NameDownloadDeleteRecordSchema: s.Describe<NameDownloadDeleteRecord> =\n  s.type({\n    id: NameIdSchema,\n  });\n\nexport function validateNameDownloadDeleteRecord(\n  record: unknown\n): [Error, undefined] | [undefined, NameDownloadDeleteRecord] {\n  return s.validate(record, NameDownloadDeleteRecordSchema);\n}\n\n// ----------------------------------------------------------------------------\n//\n// Kanji\n//\n// ----------------------------------------------------------------------------\n\nconst ReadingsStruct: s.Describe<KanjiReading> = s.type({\n  on: s.optional(s.array(s.string())),\n  kun: s.optional(s.array(s.string())),\n  na: s.optional(s.array(s.string())),\n  py: s.optional(s.array(s.string())),\n});\n\nconst RadicalStruct: s.Describe<Radical> = s.type({\n  x: s.min(safeInteger(), 0),\n  nelson: s.optional(s.min(safeInteger(), 0)),\n  name: s.optional(s.array(s.string())),\n  var: s.optional(s.string()),\n});\n\nconst MiscSchema: s.Describe<KanjiMiscInfo> = s.type({\n  gr: s.optional(safeInteger()),\n  sc: s.min(safeInteger(), 1),\n  freq: s.optional(s.min(safeInteger(), 0)),\n  // The following three items should really have a minimum value of 1, but in\n  // the interests of being (a bit) forgiving in what we accept, we allow 0 too.\n  jlpt: s.optional(s.min(safeInteger(), 0)),\n  jlptn: s.optional(s.min(safeInteger(), 0)),\n  kk: s.optional(s.min(safeInteger(), 0)),\n  // As with jlpt(n), we allow 0 here even though we expect WaniKani levels to\n  // be between 1 and 60.\n  wk: s.optional(s.min(safeInteger(), 0)),\n  meta: s.optional(s.array(s.string())),\n});\n\nconst KanjiIdSchema = s.nonempty(s.string());\n\nexport type KanjiDownloadRecord = KanjiRecord;\n\nconst KanjiDownloadRecordSchema: s.Describe<KanjiDownloadRecord> = s.type({\n  c: KanjiIdSchema,\n  r: ReadingsStruct,\n  m: s.array(s.string()),\n  m_lang: s.optional(s.string()),\n  rad: RadicalStruct,\n  refs: s.record(s.string(), s.union([s.string(), s.number()])),\n  misc: MiscSchema,\n  st: s.optional(s.string()),\n  comp: s.optional(s.string()),\n  var: s.optional(s.array(s.string())),\n  cf: s.optional(s.union([s.string(), s.array(s.string())])),\n});\n\nexport function validateKanjiDownloadRecord(\n  record: unknown\n): [Error, undefined] | [undefined, KanjiDownloadRecord] {\n  return s.validate(record, KanjiDownloadRecordSchema);\n}\n\n// -- Delete variant --\n\nexport type KanjiDownloadDeleteRecord = Pick<KanjiDownloadRecord, 'c'>;\n\nconst KanjiDownloadDeleteRecordSchema: s.Describe<KanjiDownloadDeleteRecord> =\n  s.type({\n    c: KanjiIdSchema,\n  });\n\nexport function validateKanjiDownloadDeleteRecord(\n  record: unknown\n): [Error, undefined] | [undefined, KanjiDownloadDeleteRecord] {\n  return s.validate(record, KanjiDownloadDeleteRecordSchema);\n}\n\n// ----------------------------------------------------------------------------\n//\n// Radicals\n//\n// ----------------------------------------------------------------------------\n\nconst RadicalIdSchema = s.nonempty(s.string());\n\nexport type RadicalDownloadRecord = Overwrite<\n  RadicalRecord,\n  {\n    // We don't validate the posn field for downloaded records because we don't\n    // want to force a major version bump every time we add a posn field.\n    posn?: string;\n  }\n>;\n\nconst RadicalDownloadRecordSchema: s.Describe<RadicalDownloadRecord> = s.type({\n  id: RadicalIdSchema,\n  r: s.min(safeInteger(), 1),\n  b: s.optional(s.nonempty(s.string())),\n  k: s.optional(s.nonempty(s.string())),\n  pua: s.optional(safeInteger()),\n  s: safeInteger(),\n  na: s.array(s.nonempty(s.string())),\n  posn: s.optional(s.nonempty(s.string())),\n  m: s.array(s.nonempty(s.string())),\n  m_lang: s.optional(s.nonempty(s.string())),\n});\n\nexport function validateRadicalDownloadRecord(\n  record: unknown\n): [Error, undefined] | [undefined, RadicalDownloadRecord] {\n  return s.validate(record, RadicalDownloadRecordSchema);\n}\n\n// -- Delete variant --\n\nexport type RadicalDownloadDeleteRecord = Pick<RadicalDownloadRecord, 'id'>;\n\nconst RadicalDownloadDeleteRecordSchema: s.Describe<RadicalDownloadDeleteRecord> =\n  s.type({\n    id: RadicalIdSchema,\n  });\n\nexport function validateRadicalDownloadDeleteRecord(\n  record: unknown\n): [Error, undefined] | [undefined, RadicalDownloadDeleteRecord] {\n  return s.validate(record, RadicalDownloadDeleteRecordSchema);\n}\n\n// ----------------------------------------------------------------------------\n//\n// Combined types\n//\n// ----------------------------------------------------------------------------\n\ntype DownloadRecordMapping = {\n  words: WordDownloadRecord;\n  names: NameDownloadRecord;\n  kanji: KanjiDownloadRecord;\n  radicals: RadicalDownloadRecord;\n};\n\nexport type DownloadRecord<T extends DataSeries> = DownloadRecordMapping[T];\n\nconst validateDownloadRecordMapping: {\n  [Series in DataSeries]: (\n    record: unknown\n  ) => [Error, undefined] | [undefined, DownloadRecord<Series>];\n} = {\n  words: validateWordDownloadRecord,\n  names: validateNameDownloadRecord,\n  kanji: validateKanjiDownloadRecord,\n  radicals: validateRadicalDownloadRecord,\n};\n\nexport function validateDownloadRecord<Series extends DataSeries>({\n  series,\n  record,\n}: {\n  series: Series;\n  record: unknown;\n}) {\n  return validateDownloadRecordMapping[series](record);\n}\n\n// -- Delete variant --\n\ntype DownloadDeleteRecordMapping = {\n  words: WordDownloadDeleteRecord;\n  names: NameDownloadDeleteRecord;\n  kanji: KanjiDownloadDeleteRecord;\n  radicals: RadicalDownloadDeleteRecord;\n};\n\nexport type DownloadDeleteRecord<T extends DataSeries> =\n  DownloadDeleteRecordMapping[T];\n\nconst validateDownloadDeleteRecordMapping: {\n  [Series in DataSeries]: (\n    record: unknown\n  ) => [Error, undefined] | [undefined, DownloadDeleteRecord<Series>];\n} = {\n  words: validateWordDownloadDeleteRecord,\n  names: validateNameDownloadDeleteRecord,\n  kanji: validateKanjiDownloadDeleteRecord,\n  radicals: validateRadicalDownloadDeleteRecord,\n};\n\nexport function validateDownloadDeleteRecord<Series extends DataSeries>({\n  series,\n  record,\n}: {\n  series: Series;\n  record: unknown;\n}) {\n  return validateDownloadDeleteRecordMapping[series](record);\n}\n","export class OfflineError extends Error {\n  constructor(...params: any[]) {\n    super(...params);\n    Object.setPrototypeOf(this, OfflineError.prototype);\n\n    if (typeof (Error as any).captureStackTrace === 'function') {\n      (Error as any).captureStackTrace(this, OfflineError);\n    }\n\n    this.name = 'OfflineError';\n  }\n}\n","export type WordRecord = {\n  id: number;\n\n  // Kanji readings for the entry\n  k?: Array<string>;\n  km?: Array<null | KanjiMeta>;\n\n  // Kana readings for the entry\n  r: Array<string>;\n  rm?: Array<null | ReadingMeta>;\n\n  // Sense information\n  s: Array<WordSense>;\n};\n\nexport type KanjiMeta = {\n  // Information about a kanji headword\n  //\n  // Typically this should be of type KanjiInfo but we allow it to be any string\n  // in case new types are introduced in future and the client has yet to be\n  // updated.\n  i?: Array<string>;\n\n  // Priority information\n  p?: Array<string>;\n\n  // Bunpro vocab fuzzy match source text\n  bv?: string;\n\n  // Bunpro grammar fuzzy match source text\n  bg?: string;\n};\n\nexport type ReadingMeta = {\n  // Information about the reading\n  //\n  // Typically this should be of type ReadingInfo but we allow it to be any\n  // string in case new types are introduced in future and the client has yet to\n  // be updated.\n  i?: Array<string>;\n\n  // Priority information\n  p?: Array<string>;\n\n  // Bitfield representing which kanji entries (based on their order in the k\n  // array) the reading applies to. 0 means it applies to none of them. If the\n  // field is absent, it means the reading applies to all of the kanji entries.\n  app?: number;\n\n  // Pitch accent information.\n  a?: number | Array<Accent>;\n\n  // Bunpro vocab fuzzy match source text\n  bv?: string;\n\n  // Bunpro grammar fuzzy match source text\n  bg?: string;\n};\n\nexport type Accent = {\n  // Syllable number of the accent (after which the drop occurs).\n  // 0 = \n  i: number;\n\n  // This should typically be a PartOfSpeech value.\n  pos?: Array<string>;\n};\n\nexport type WordSense = {\n  g: Array<string>;\n  // A bitfield representing the type of the glosses in `g`. Two bits are used\n  // to represent the type of each item in `g`, where each two-bit value is one\n  // of the GlossType values below.\n  //\n  // Undefined if the value is 0 (i.e. no glosses have a type, the most common\n  // case).\n  gt?: number;\n  // undefined = 'en'\n  lang?: string;\n\n  // Bit field representing the kanji / kana entries this sense applies to.\n  // If the sense applies to all entries the field will be undefined.\n  kapp?: number;\n  rapp?: number;\n\n  // Extra information about the sense.\n\n  // Typically a PartOfSpeech value\n  pos?: Array<string>;\n  // Typically a FieldType value\n  field?: Array<string>;\n  // Typically a MiscType value\n  misc?: Array<string>;\n  // Typically a Dialect value\n  dial?: Array<string>;\n  inf?: string;\n  xref?: Array<CrossReference>;\n  ant?: Array<CrossReference>;\n\n  // Language source information.\n  lsrc?: Array<LangSource>;\n};\n\nexport const GlossTypes = ['none', 'expl', 'lit', 'fig', 'tm'] as const;\nexport type GlossType = (typeof GlossTypes)[number];\nexport const GLOSS_TYPE_MAX = GlossTypes.length;\nexport const BITS_PER_GLOSS_TYPE = Math.floor(Math.log2(GLOSS_TYPE_MAX)) + 1;\n\nexport type CrossReference =\n  | {\n      k: string;\n      sense?: number;\n    }\n  | {\n      r: string;\n      sense?: number;\n    }\n  | {\n      k: string;\n      r: string;\n      sense?: number;\n    };\n\nexport type LangSource = {\n  // undefined = 'en'\n  lang?: string;\n\n  // The term in the source language\n  //\n  // This may be empty in some cases.\n  src?: string;\n\n  // Partial source (i.e. this only represents part of the string)\n  // absent = false\n  part?: true;\n\n  // The Japanese word is made from words from another language but doesn't\n  // actually represent the meaning of those words literally.\n  wasei?: true;\n};\n\n// ----------------------------------------------------------------------------\n//\n// Supplemental types that may be used to further refine the fields above\n//\n// ----------------------------------------------------------------------------\n\n// KanjiInfo\n\nexport type KanjiInfo = (typeof kanjiInfoValues)[number];\n\nconst kanjiInfoValues = [\n  // ateji (phonetic) reading\n  'ateji',\n  // irregular okurigana usage\n  'io',\n  // word containing irregular kanji usage\n  'iK',\n  // word containing irregular kana usage\n  'ik',\n  // word containing out-dated kanji or kanji usage\n  'oK',\n  // rarely-used kanji form\n  'rK',\n  // search-only kanji form\n  'sK',\n] as const;\n\nexport function isKanjiInfo(a: unknown): a is KanjiInfo {\n  return typeof a === 'string' && kanjiInfoValues.includes(a as KanjiInfo);\n}\n\nexport function asKanjiInfo(a: unknown): KanjiInfo | undefined {\n  return isKanjiInfo(a) ? a : undefined;\n}\n\n// ReadingInfo\n\nexport type ReadingInfo = (typeof allReadingInfo)[number];\n\nconst allReadingInfo = [\n  // gikun (meaning as reading) or jukujikun (special kanji reading)\n  'gikun',\n  // word containing irregular kana usage\n  'ik',\n  // out-dated or obsolete kana usage\n  'ok',\n  // rarely-used kana form\n  'rk',\n  // search-only kana form\n  'sk',\n] as const;\n\nexport function isReadingInfo(a: unknown): a is ReadingInfo {\n  return typeof a === 'string' && allReadingInfo.includes(a as ReadingInfo);\n}\n\nexport function asReadingInfo(a: unknown): ReadingInfo | undefined {\n  return isReadingInfo(a) ? a : undefined;\n}\n\n// Part of speech\n\nexport type PartOfSpeech = (typeof allPartsOfSpeech)[number];\n\n// prettier-ignore\nconst allPartsOfSpeech = [\n  'adj-f', 'adj-i', 'adj-ix', 'adj-kari', 'adj-ku', 'adj-na', 'adj-nari',\n  'adj-no', 'adj-pn', 'adj-shiku', 'adj-t', 'adv', 'adv-to', 'aux', 'aux-adj',\n  'aux-v', 'conj', 'cop', 'ctr', 'exp', 'int', 'n', 'n-adv', 'n-pr', 'n-pref',\n  'n-suf', 'n-t', 'num', 'pn', 'pref', 'prt', 'suf', 'unc', 'v-unspec', 'v1',\n  'v1-s', 'v2a-s', 'v2b-k', 'v2b-s', 'v2d-k', 'v2d-s', 'v2g-k', 'v2g-s',\n  'v2h-k', 'v2h-s', 'v2k-k', 'v2k-s', 'v2m-k', 'v2m-s', 'v2n-s', 'v2r-k',\n  'v2r-s', 'v2s-s', 'v2t-k', 'v2t-s', 'v2w-s', 'v2y-k', 'v2y-s', 'v2z-s', 'v4b',\n  'v4g', 'v4h', 'v4k', 'v4m', 'v4n', 'v4r', 'v4s', 'v4t', 'v5aru', 'v5b', 'v5g',\n  'v5k', 'v5k-s', 'v5m', 'v5n', 'v5r', 'v5r-i', 'v5s', 'v5t', 'v5u', 'v5u-s',\n  'v5uru', 'vi', 'vk', 'vn', 'vr', 'vs', 'vs-c', 'vs-i', 'vs-s', 'vt', 'vz',\n] as const;\n\nexport function isPartOfSpeech(a: unknown): a is PartOfSpeech {\n  return typeof a === 'string' && allPartsOfSpeech.includes(a as PartOfSpeech);\n}\n\nexport function asPartOfSpeech(a: unknown): PartOfSpeech | undefined {\n  return isPartOfSpeech(a) ? a : undefined;\n}\n\n// Field\n\nexport type FieldType = (typeof allFieldTypes)[number];\n\n// prettier-ignore\nconst allFieldTypes = [\n  'agric', 'anat', 'archeol', 'archit', 'art', 'astron', 'audvid', 'aviat',\n  'baseb', 'biochem', 'biol', 'bot', 'boxing', 'Buddh', 'bus', 'cards', 'chem',\n  'chmyth', 'Christn', 'civeng', 'cloth', 'comp', 'cryst', 'dent', 'ecol',\n  'econ', 'elec', 'electr', 'embryo', 'engr', 'ent', 'figskt', 'film', 'finc',\n  'fish', 'food', 'gardn', 'genet', 'geogr', 'geol', 'geom', 'go', 'golf',\n  'gramm', 'grmyth', 'hanaf', 'horse', 'internet', 'jpmyth', 'kabuki', 'law',\n  'ling', 'logic', 'MA', 'mahj', 'manga', 'math', 'mech', 'med', 'met', 'mil',\n  'min', 'mining', 'motor', 'music', 'noh', 'ornith', 'paleo', 'pathol',\n  'pharm', 'phil', 'photo', 'physics', 'physiol', 'politics', 'print',\n  'prowres', 'psy', 'psyanal', 'psych', 'rail', 'rommyth', 'Shinto', 'shogi',\n  'ski', 'sports', 'stat', 'stockm', 'sumo', 'surg', 'telec', 'tradem', 'tv',\n  'vet', 'vidg', 'zool',\n] as const;\n\nexport function isFieldType(a: unknown): a is FieldType {\n  return typeof a === 'string' && allFieldTypes.includes(a as FieldType);\n}\n\nexport function asFieldType(a: unknown): FieldType | undefined {\n  return isFieldType(a) ? a : undefined;\n}\n\n// Misc types. A few of these are not used (e.g. male-sl, uK) but they have\n// entity definitions in the upstream XML file so we include them here.\n\nexport type MiscType = (typeof allMiscTypes)[number];\n\n// prettier-ignore\nconst allMiscTypes = [\n  'abbr', 'aphorism', 'arch', 'char', 'chn', 'col', 'company', 'creat', 'dated',\n  'dei', 'derog', 'doc', 'ev', 'euph', 'fam', 'fem', 'fict', 'form', 'given',\n  'group', 'hist', 'hon', 'hum', 'id', 'joc', 'leg', 'm-sl', 'male', 'myth',\n  'net-sl', 'obj', 'obs', 'obsc', 'on-mim', 'organization', 'oth', 'person',\n  'place', 'poet', 'pol', 'product', 'proverb', 'quote', 'rare', 'relig',\n  'sens', 'serv', 'ship', 'sl', 'station', 'surname', 'uk', 'unclass', 'vulg',\n  'work', 'X', 'yoji',\n] as const;\n\nexport function isMiscType(a: unknown): a is MiscType {\n  return typeof a === 'string' && allMiscTypes.includes(a as MiscType);\n}\n\nexport function asMiscType(a: unknown): MiscType | undefined {\n  return isMiscType(a) ? a : undefined;\n}\n\n// Dialects\n\nexport type Dialect = (typeof allDialects)[number];\n\nconst allDialects = [\n  'bra', // Brazilian\n  'ho', // Hokkaido\n  'tsug', // Tsugaru\n  'th', // Tohoku\n  'na', // Nagano\n  'kt', // Kanto\n  'ks', // Kansai\n  'ky', // Kyoto\n  'os', // Osaka\n  'ts', // Tosa\n  '9s', // Kyushu\n  'ok', // Ryuukyuu\n] as const;\n\nexport function isDialect(a: unknown): a is Dialect {\n  return typeof a === 'string' && allDialects.includes(a as Dialect);\n}\n\nexport function asDialect(a: unknown): Dialect | undefined {\n  return isDialect(a) ? a : undefined;\n}\n","import type { ExtendedKanaEntry, WordResult } from './result-types';\n\n// As with Array.prototype.sort, sorts `results` in-place, but returns the\n// result to support chaining.\nexport function sortWordResults(\n  results: Array<WordResult>,\n  { searchLength }: { searchLength?: number } = {}\n): Array<WordResult> {\n  const sortMeta: Map<\n    number,\n    { excessChars: number | undefined; priority: number; type: number }\n  > = new Map();\n\n  for (const result of results) {\n    // Calculate the number of excess characters in the matching headword\n    const matchingHeadword =\n      result.k.find((k) => k.matchRange) || result.r.find((r) => r.matchRange);\n    const excessChars =\n      searchLength && matchingHeadword\n        ? matchingHeadword.ent.length - searchLength\n        : undefined;\n\n    // Determine the headword match type\n    //\n    // 1 = match on a kanji, or kana which is not just the reading for a kanji\n    // 2 = match on a kana reading for a kanji\n    //\n    // TODO: Don't bother doing this unless the input is all kana\n    const kanaReading = result.r.find((r) => !!r.matchRange);\n    const rt = kanaReading ? getKanaHeadwordType(kanaReading, result) : 1;\n\n    // Priority\n    const priority = getPriority(result);\n\n    sortMeta.set(result.id, { excessChars, priority, type: rt });\n  }\n\n  results.sort((a, b) => {\n    const metaA = sortMeta.get(a.id)!;\n    const metaB = sortMeta.get(b.id)!;\n\n    if (\n      metaA.excessChars !== undefined &&\n      metaB.excessChars !== undefined &&\n      metaA.excessChars !== metaB.excessChars\n    ) {\n      return metaA.excessChars - metaB.excessChars;\n    }\n\n    if (metaA.type !== metaB.type) {\n      return metaA.type - metaB.type;\n    }\n\n    return metaB.priority - metaA.priority;\n  });\n\n  return results;\n}\n\nfunction getKanaHeadwordType(r: ExtendedKanaEntry, result: WordResult): 1 | 2 {\n  // We don't want to prioritize readings marked as `ok` etc. or else we'll end\n  // up prioritizing words like `` and `` being prioritized when searching\n  // for ``.\n  const isReadingObscure =\n    r.i?.includes('ok') ||\n    r.i?.includes('rk') ||\n    r.i?.includes('sk') ||\n    r.i?.includes('ik');\n\n  if (isReadingObscure) {\n    return 2;\n  }\n\n  // Kana headwords are type 1 (i.e. they are a primary headword, not just a\n  // reading for a kanji headword) if:\n  //\n  // (a) the entry has no kanji headwords or all the kanji headwords are marked\n  //     as `rK`, `sK`, or `iK`.\n  if (\n    !result.k.length ||\n    result.k.every(\n      (k) => k.i?.includes('rK') || k.i?.includes('sK') || k.i?.includes('iK')\n    )\n  ) {\n    return 1;\n  }\n\n  // (b) most of the English senses for the entry have a `uk` (usually kana)\n  //     `misc` field and the reading is not marked as `ok` (old kana usage).\n  //\n  // We wanted to make the condition here be just one sense being marked as `uk`\n  // but then you get words like `` being prioritized when searching for ``\n  // because of one sense out of many being usually kana.\n  //\n  // Furthermore, we don't want to require _all_ senses to be marked as `uk` or\n  // else that will mean that  fails to be prioritized when searching for\n  // `` because one sense out of 11 is not marked as `uk`.\n  if (mostMatchedEnSensesAreUk(result.s)) {\n    return 1;\n  }\n\n  // (c) the headword is marked as `nokanji`\n  return r.app === 0 ? 1 : 2;\n}\n\nfunction mostMatchedEnSensesAreUk(senses: WordResult['s']): boolean {\n  const matchedEnSenses = senses.filter(\n    (s) => s.match && (s.lang === undefined || s.lang === 'en')\n  );\n  if (matchedEnSenses.length === 0) {\n    return false;\n  }\n\n  const ukEnSenseCount = matchedEnSenses.filter((s) =>\n    s.misc?.includes('uk')\n  ).length;\n  return ukEnSenseCount >= matchedEnSenses.length / 2;\n}\n\nexport function getPriority(result: WordResult): number {\n  // Go through each _matching_ kanji / reading and look for priority\n  // information and return the highest score.\n  const scores: Array<number> = [0];\n  const isHeadwordSearch =\n    result.k.some((k) => !!k.matchRange) ||\n    result.r.some((r) => !!r.matchRange);\n\n  // Scores from kanji readings\n  for (const k of result.k) {\n    if ((isHeadwordSearch ? !k.matchRange : !k.match) || !k.p) {\n      continue;\n    }\n\n    scores.push(getPrioritySum(k.p));\n  }\n\n  // Scores from kana readings\n  for (const r of result.r) {\n    if ((isHeadwordSearch ? !r.matchRange : !r.match) || !r.p) {\n      continue;\n    }\n\n    scores.push(getPrioritySum(r.p));\n  }\n\n  // Return top score\n  return Math.max(...scores);\n}\n\n// Produce an overall priority from a series of priority strings.\n//\n// This should produce a value somewhere in the range 0~67.\n//\n// In general we report the highest priority, but if we have several priority\n// scores we add a decreasing fraction (10%) of the lesser scores as an\n// indication that several sources have attested to the priority.\n//\n// That should typically produce a maximum attainable score of 66.8.\n// Having a bounded range like this makes it easier to combine this value with\n// other metrics when sorting.\nfunction getPrioritySum(priorities: Array<string>): number {\n  const scores = priorities.map(getPriorityScore).sort().reverse();\n  return scores.length\n    ? scores[0] +\n        scores\n          .slice(1)\n          .reduce(\n            (total, score, index) => total + score / Math.pow(10, index + 1),\n            0\n          )\n    : 0;\n}\n\n// This assignment is pretty arbitrary however it's mostly used for sorting\n// entries where all we need to do is distinguish between the really common ones\n// and the obscure academic ones.\n//\n// Entries with (P) are those ones that are marked with (P) in Edict.\nconst PRIORITY_ASSIGNMENTS: Map<string, number> = new Map([\n  ['i1', 50], // Top 10,000 words minus i2 (from 1998) (P)\n  ['i2', 20],\n  ['n1', 40], // Top 12,000 words in newspapers (from 2003?) (P)\n  ['n2', 20], // Next 12,000\n  ['s1', 32], // \"Speculative\" annotations? Seem pretty common to me. (P)\n  ['s2', 20], // (P)\n  ['g1', 30], // (P)\n  ['g2', 15],\n]);\n\nexport function getPriorityScore(p: string): number {\n  if (PRIORITY_ASSIGNMENTS.has(p)) {\n    return PRIORITY_ASSIGNMENTS.get(p)!;\n  }\n\n  if (p.startsWith('nf')) {\n    // The wordfreq scores are groups of 500 words.\n    // e.g. nf01 is the top 500 words, and nf48 is the 23,501 ~ 24,000\n    // most popular words.\n    const wordfreq = parseInt(p.substring(2), 10);\n    if (wordfreq > 0 && wordfreq < 48) {\n      return 48 - wordfreq / 2;\n    }\n  }\n\n  return 0;\n}\n","// This is in part:\n//\n// - Missing typings for requestIdleCallback\n// - Polyfill for browsers that don't support requestIdleCallback\n// - Polyfill for non-Window contexts (e.g. workers)\n\ninterface IdleDeadline {\n  timeRemaining: () => number;\n  readonly didTimeout: boolean;\n}\n\ninterface IdleRequestOptions {\n  timeout: number;\n}\n\ntype IdleCallbackHandle = number;\n\ntype IdleRequestCallback = (deadline: IdleDeadline) => void;\n\nexport let requestIdleCallback: (\n  callback: IdleRequestCallback,\n  options?: IdleRequestOptions\n) => IdleCallbackHandle;\nexport let cancelIdleCallback: (handle: IdleCallbackHandle) => void;\n\nif (\n  typeof self === 'object' &&\n  typeof self.requestIdleCallback === 'function' &&\n  typeof self.cancelIdleCallback === 'function'\n) {\n  requestIdleCallback = (self as any).requestIdleCallback;\n  cancelIdleCallback = (self as any).cancelIdleCallback;\n} else {\n  requestIdleCallback = (\n    callback: IdleRequestCallback,\n    options?: IdleRequestOptions\n  ): IdleCallbackHandle => {\n    // Use half the specified timeout since it probably represents a worst-case\n    // scenario.\n    const timeout = options ? options.timeout / 2 : 0;\n    return self.setTimeout(() => {\n      callback({ timeRemaining: () => 0, didTimeout: true });\n    }, timeout);\n  };\n\n  cancelIdleCallback = (handle: IdleCallbackHandle) => {\n    clearTimeout(handle);\n  };\n}\n","import { DataSeries } from './data-series';\nimport { JpdictIdb } from './database';\nimport { uuid } from './uuid';\n\nconst dbToUuid: Map<JpdictIdb, string> = new Map();\n\nexport function getUpdateKey(obj: JpdictIdb, series: DataSeries): string {\n  if (!dbToUuid.has(obj)) {\n    dbToUuid.set(obj, uuid());\n  }\n  const baseId = dbToUuid.get(obj);\n\n  return `${baseId}-${series}`;\n}\n","import { DataSeries, MajorDataSeries } from './data-series';\nimport { ChangeCallback, ChangeTopic, JpdictIdb } from './database';\nimport { DownloadError } from './download-error';\nimport { OfflineError } from './offline-error';\nimport {\n  cancelIdleCallback,\n  requestIdleCallback,\n} from './request-idle-callback';\nimport { getUpdateKey } from './update-key';\nimport { UpdatingUpdateState } from './update-state';\n\nexport type UpdateCompleteCallback = () => void;\nexport type UpdateErrorCallback = (params: {\n  error: Error;\n  nextRetry?: Date;\n  retryCount?: number;\n}) => void;\n\n// We allow passing in a custom setTimeout implementation so that unit tests\n// can mock it, because overriding the global definition interferes with\n// playwright, and sinon can't mock ES6 dependencies:\n//\n// https://github.com/hugomrdias/playwright-test/issues/426\n// https://github.com/microsoft/playwright/issues/9123\n// https://github.com/sinonjs/sinon/issues/1711\ntype SetTimeoutFn = (cb: () => void, duration: number) => number;\n\n// Updates the passed-in database and retries in the case of failure due to\n// network failures or being offline.\n//\n// Note that if there is an existing call to this function in motion\n// (including waiting to retry) the existing call will be re-used.\n// As a result, if the passed-in callback functions differ between invocations,\n// only the originally passed-in callback functions will be called.\n//\n// (This is fixable but it introduces complexity and currently all clients\n// have a single point where they call into this so it is not necessary to try\n// and store a list of callback functions.)\n//\n// If the `updateNow` parameter is set then an existing call to this function\n// will be canceled first UNLESS it is already running or blocked due to being\n// offline. That is, the `updateNow` flag is meant to say, \"Update now if you\n// are not already.\"\n//\n// Furthermore, note that if an invocation is canceled there is no abort\n// callback or AbortError or anything of the sort. (Again, this is fixable but\n// it requires us to store the callbacks passed-in, and currently no client\n// needs this.)\nexport function updateWithRetry({\n  db,\n  lang,\n  series,\n  onUpdateComplete,\n  onUpdateError,\n  setTimeout = self.setTimeout,\n  updateNow = false,\n}: {\n  db: JpdictIdb;\n  lang: string;\n  series: MajorDataSeries;\n  setTimeout?: SetTimeoutFn;\n  onUpdateComplete?: UpdateCompleteCallback;\n  onUpdateError?: UpdateErrorCallback;\n  updateNow?: boolean;\n}) {\n  startUpdate({\n    db,\n    lang,\n    series,\n    setTimeout,\n    onUpdateComplete,\n    onUpdateError,\n    updateNow,\n  });\n}\n\nfunction runUpdate({\n  db,\n  lang,\n  series,\n  setTimeout,\n  onUpdateComplete,\n  onUpdateError,\n}: {\n  db: JpdictIdb;\n  lang: string;\n  series: MajorDataSeries;\n  setTimeout: SetTimeoutFn;\n  onUpdateComplete?: UpdateCompleteCallback;\n  onUpdateError?: UpdateErrorCallback;\n}) {\n  // If we are offline, wait until we are online.\n  if (!navigator.onLine) {\n    const onlineCallback = async () => {\n      runUpdate({\n        db,\n        lang,\n        series,\n        setTimeout,\n        onUpdateComplete,\n        onUpdateError,\n      });\n    };\n\n    addEventListener('online', onlineCallback, { once: true });\n    goOffline({ db, series, lang, onlineCallback });\n    onUpdateError?.({ error: new OfflineError() });\n    return;\n  }\n\n  // Transition to updating state.\n  beginUpdating({ db, series, lang });\n\n  // Actually run the update and handle any errors\n  void (async () => {\n    try {\n      await db.update({ series, lang });\n\n      resetUpdate({ db, series });\n\n      if (db.isVerbose) {\n        console.log('Successfully completed update.');\n      }\n\n      onUpdateComplete?.();\n    } catch (e) {\n      if (db.isVerbose) {\n        console.error('Got error while updating', e);\n      }\n\n      let retryCount: number | undefined;\n      let nextRetry: Date | undefined;\n      let suppressError = false;\n\n      // Retry network errors at decreasing intervals\n      const isNetworkError = e instanceof DownloadError;\n      if (isNetworkError) {\n        const scheduleResult = maybeScheduleRetry({\n          db,\n          lang,\n          series,\n          setTimeout,\n          onUpdateComplete,\n          onUpdateError,\n        });\n        if (scheduleResult) {\n          ({ nextRetry, retryCount } = scheduleResult);\n        }\n      } else if (e && e instanceof Error && e.name === 'ConstraintError') {\n        const scheduleResult = maybeScheduleIdleRetry({\n          db,\n          lang,\n          series,\n          setTimeout,\n          onUpdateComplete,\n          onUpdateError,\n        });\n        if (scheduleResult) {\n          ({ retryCount } = scheduleResult);\n        }\n\n        suppressError = !!scheduleResult;\n      } else {\n        resetUpdate({ db, series });\n      }\n\n      if (!suppressError && onUpdateError) {\n        const error = e instanceof Error ? e : new Error(String(e));\n        onUpdateError({ error, nextRetry, retryCount });\n      }\n    }\n  })();\n}\n\nfunction onDatabaseChange({\n  db,\n  series,\n  topic,\n}: {\n  db: JpdictIdb;\n  series: MajorDataSeries;\n  topic: ChangeTopic;\n}) {\n  // If the database was deleted, cancel any scheduled retries.\n  if (topic === 'deleted') {\n    resetUpdate({ db, series });\n    return;\n  }\n\n  // topic === 'stateupdated'\n  //\n  // If we successfully downloaded *something*, reset the retry interval.\n  //\n  // We should only do this when we have a retry interval set since we DON'T\n  // want to reset the retry count if we are retrying due to a database error.\n  const seriesHasProgress = (series: DataSeries) =>\n    db[series].updateState.type === 'updating' &&\n    (db[series].updateState as UpdatingUpdateState).fileProgress > 0;\n  const downloadedSomething =\n    series === 'kanji'\n      ? seriesHasProgress('kanji') || seriesHasProgress('radicals')\n      : seriesHasProgress(series);\n\n  if (downloadedSomething) {\n    clearRetryInterval({ db, series });\n  }\n}\n\nexport function cancelUpdateWithRetry({\n  db,\n  series,\n}: {\n  db: JpdictIdb;\n  series: MajorDataSeries;\n}) {\n  resetUpdate({ db, series });\n}\n\n// ---------------------------------------------------------------------------\n//\n// State management\n//\n// ---------------------------------------------------------------------------\n\ntype RetryState =\n  | {\n      type: 'offline';\n      lang: string;\n      changeCallback: ChangeCallback;\n      onlineCallback: () => any;\n    }\n  | {\n      type: 'updating';\n      lang: string;\n      changeCallback: ChangeCallback;\n      retryIntervalMs?: number;\n      retryCount?: number;\n    }\n  | {\n      type: 'waiting-for-timeout';\n      lang: string;\n      changeCallback: ChangeCallback;\n      setTimeoutHandle: number;\n      retryIntervalMs: number;\n      retryCount: number;\n    }\n  | {\n      type: 'waiting-for-idle';\n      lang: string;\n      changeCallback: ChangeCallback;\n      requestIdleCallbackHandle: number;\n      retryCount: number;\n    };\n\nconst inProgressUpdates: Map<string, RetryState> = new Map();\n\n// ---------------------------------------------------------------------------\n//\n// State transitions\n//\n// ---------------------------------------------------------------------------\n\nfunction startUpdate({\n  db,\n  lang,\n  series,\n  setTimeout,\n  onUpdateComplete,\n  onUpdateError,\n  updateNow,\n}: {\n  db: JpdictIdb;\n  lang: string;\n  series: MajorDataSeries;\n  setTimeout: SetTimeoutFn;\n  onUpdateComplete?: UpdateCompleteCallback;\n  onUpdateError?: UpdateErrorCallback;\n  updateNow: boolean;\n}) {\n  // Check if we have an in-progress update.\n  const updateKey = getUpdateKey(db, series);\n  let retryState = inProgressUpdates.get(updateKey);\n\n  // If the languages differ, we should cancel the existing update.\n  if (retryState && retryState.lang !== lang) {\n    if (db.isVerbose) {\n      console.info(\n        'Canceling existing call to updateWithRetry because the requested language has changed.'\n      );\n    }\n    resetUpdate({ db, series });\n  }\n\n  // Re-fetch the retry status since we may have canceled it.\n  retryState = inProgressUpdates.get(updateKey);\n  if (retryState) {\n    // If we are not trying to force an update then use the existing in-progress\n    // update.\n    if (!updateNow) {\n      if (db.isVerbose) {\n        console.info(\n          'Overlapping calls to updateWithRetry. Re-using existing invocation. This could be problematic if different callback functions were passed on each invocation.'\n        );\n      }\n      return;\n    }\n\n    // If we're offline, then we're not even going to try updating until we\n    // are online (at which point we will retry immediately).\n    if (retryState.type === 'offline') {\n      if (db.isVerbose) {\n        console.info('Deferring forced update. Currently offline.');\n      }\n      return;\n    }\n\n    // Even if we are trying to force the update, if we just started an update\n    // (or are retrying rapidly) then use the existing update.\n    if (retryState.type === 'updating') {\n      if (db.isVerbose) {\n        console.info('Skipping forced update. Already updating presently.');\n      }\n      return;\n    }\n\n    // Otherwise, cancel the in-progress update.\n    if (db.isVerbose) {\n      console.log('Canceling existing queued retry.');\n    }\n    resetUpdate({ db, series });\n  }\n\n  // If we _still_ have an in-progress update here, it means we got an\n  // overlapping call to this method while we were waiting to cancel the\n  // previous in-progress update.\n  retryState = inProgressUpdates.get(updateKey);\n  if (retryState) {\n    if (db.isVerbose) {\n      console.log('Skipping overlapping auto-retry request.');\n    }\n    return;\n  }\n\n  runUpdate({ db, lang, series, setTimeout, onUpdateComplete, onUpdateError });\n}\n\nfunction resetUpdate({\n  db,\n  series,\n}: {\n  db: JpdictIdb;\n  series: MajorDataSeries;\n}) {\n  const updateKey = getUpdateKey(db, series);\n  const retryState = inProgressUpdates.get(updateKey);\n  if (!retryState) {\n    return;\n  }\n\n  switch (retryState.type) {\n    case 'offline':\n      removeEventListener('online', retryState.onlineCallback);\n      break;\n\n    case 'waiting-for-timeout':\n      clearTimeout(retryState.setTimeoutHandle);\n      break;\n\n    case 'waiting-for-idle':\n      cancelIdleCallback(retryState.requestIdleCallbackHandle);\n      break;\n  }\n\n  db.removeChangeListener(retryState.changeCallback);\n  inProgressUpdates.delete(updateKey);\n\n  db.cancelUpdate(series);\n}\n\nfunction goOffline({\n  db,\n  lang,\n  onlineCallback,\n  series,\n}: {\n  db: JpdictIdb;\n  lang: string;\n  onlineCallback: () => any;\n  series: MajorDataSeries;\n}) {\n  const updateKey = getUpdateKey(db, series);\n  const retryState = inProgressUpdates.get(updateKey);\n  if (retryState) {\n    resetUpdate({ db, series });\n  }\n\n  inProgressUpdates.set(updateKey, {\n    type: 'offline',\n    lang,\n    onlineCallback,\n    changeCallback: getOrRegisterChangeCallback({ db, series }),\n  });\n}\n\nfunction beginUpdating({\n  db,\n  lang,\n  series,\n}: {\n  db: JpdictIdb;\n  lang: string;\n  series: MajorDataSeries;\n}) {\n  const updateKey = getUpdateKey(db, series);\n  const retryState = inProgressUpdates.get(updateKey);\n\n  inProgressUpdates.set(updateKey, {\n    type: 'updating',\n    lang,\n    changeCallback: getOrRegisterChangeCallback({ db, series }),\n    retryCount: getRetryCount(retryState),\n    retryIntervalMs: getRetryIntervalMs(retryState),\n  });\n}\n\nfunction maybeScheduleRetry({\n  db,\n  lang,\n  series,\n  setTimeout,\n  onUpdateComplete,\n  onUpdateError,\n}: {\n  db: JpdictIdb;\n  lang: string;\n  series: MajorDataSeries;\n  setTimeout: SetTimeoutFn;\n  onUpdateComplete?: UpdateCompleteCallback;\n  onUpdateError?: UpdateErrorCallback;\n}): { retryCount: number; nextRetry: Date } | undefined {\n  const updateKey = getUpdateKey(db, series);\n  const retryState = inProgressUpdates.get(updateKey);\n\n  // If we are not updating to begin with, don't schedule a retry since it\n  // probably means we were canceled.\n  if (retryState?.type !== 'updating') {\n    return undefined;\n  }\n\n  let retryIntervalMs = retryState.retryIntervalMs;\n  if (retryIntervalMs) {\n    // Don't let the interval become longer than 12 hours\n    retryIntervalMs = Math.min(retryIntervalMs * 2, 12 * 60 * 60 * 1000);\n  } else {\n    // Randomize the initial interval to somewhere between 3s ~ 6s.\n    retryIntervalMs = 3000 + Math.random() * 3000;\n  }\n\n  let retryCount = retryState.retryCount;\n  retryCount = typeof retryCount === 'number' ? retryCount + 1 : 0;\n\n  if (db.isVerbose) {\n    console.log(`Scheduling retry of update in ${retryIntervalMs}ms`);\n  }\n\n  const setTimeoutHandle = setTimeout(() => {\n    if (db.isVerbose) {\n      console.log('Running automatic retry of update...');\n    }\n\n    runUpdate({\n      db,\n      lang,\n      series,\n      setTimeout,\n      onUpdateComplete,\n      onUpdateError,\n    });\n  }, retryIntervalMs) as unknown as number;\n\n  const nextRetry = new Date(Date.now() + retryIntervalMs);\n\n  inProgressUpdates.set(updateKey, {\n    type: 'waiting-for-timeout',\n    lang,\n    changeCallback: getOrRegisterChangeCallback({ db, series }),\n    retryCount,\n    retryIntervalMs,\n    setTimeoutHandle,\n  });\n\n  return { nextRetry, retryCount };\n}\n\nfunction clearRetryInterval({\n  db,\n  series,\n}: {\n  db: JpdictIdb;\n  series: MajorDataSeries;\n}) {\n  const updateKey = getUpdateKey(db, series);\n  const retryState = inProgressUpdates.get(updateKey);\n\n  // The check here for `retryIntervalMs` being set ensures we don't clear the\n  // interval when we call this as a result of an idle callback running.\n  if (retryState?.type !== 'updating' || !retryState.retryIntervalMs) {\n    return;\n  }\n\n  inProgressUpdates.set(updateKey, {\n    ...retryState,\n    retryIntervalMs: undefined,\n    retryCount: undefined,\n  });\n}\n\nfunction maybeScheduleIdleRetry({\n  db,\n  lang,\n  series,\n  setTimeout,\n  onUpdateComplete,\n  onUpdateError,\n}: {\n  db: JpdictIdb;\n  lang: string;\n  series: MajorDataSeries;\n  setTimeout: SetTimeoutFn;\n  onUpdateComplete?: UpdateCompleteCallback;\n  onUpdateError?: UpdateErrorCallback;\n}): { retryCount: number } | undefined {\n  const updateKey = getUpdateKey(db, series);\n  const retryState = inProgressUpdates.get(updateKey);\n\n  // If we are not updating to begin with, don't schedule a retry since it\n  // probably means we were canceled.\n  if (retryState?.type !== 'updating') {\n    return undefined;\n  }\n\n  // We only want to do this kind of rapid retry a few times (it's for database\n  // errors).\n  let retryCount = retryState.retryCount;\n  if (retryCount && retryCount >= 2) {\n    return undefined;\n  }\n\n  retryCount = typeof retryCount === 'number' ? retryCount + 1 : 0;\n\n  if (db.isVerbose) {\n    console.log('Retrying update momentarily');\n  }\n\n  const requestIdleCallbackHandle = requestIdleCallback(\n    () => {\n      if (db.isVerbose) {\n        console.log('Running automatic retry of update...');\n      }\n\n      runUpdate({\n        db,\n        lang,\n        series,\n        setTimeout,\n        onUpdateComplete,\n        onUpdateError,\n      });\n    },\n    { timeout: 2000 }\n  );\n\n  inProgressUpdates.set(updateKey, {\n    type: 'waiting-for-idle',\n    lang,\n    changeCallback: getOrRegisterChangeCallback({ db, series }),\n    requestIdleCallbackHandle,\n    retryCount,\n  });\n\n  return { retryCount };\n}\n\n// ----------------------------------------------------------------------------\n//\n// State helpers\n//\n// ----------------------------------------------------------------------------\n\nfunction getOrRegisterChangeCallback({\n  db,\n  series,\n}: {\n  db: JpdictIdb;\n  series: MajorDataSeries;\n}): ChangeCallback {\n  const updateKey = getUpdateKey(db, series);\n  const retryState = inProgressUpdates.get(updateKey);\n  if (retryState) {\n    return retryState.changeCallback;\n  }\n\n  const changeCallback = (topic: ChangeTopic) =>\n    onDatabaseChange({ db, series, topic });\n  db.addChangeListener(changeCallback);\n\n  return changeCallback;\n}\n\nfunction getRetryCount(retryState: RetryState | undefined): number | undefined {\n  return retryState?.type !== 'offline' ? retryState?.retryCount : undefined;\n}\n\nfunction getRetryIntervalMs(\n  retryState: RetryState | undefined\n): number | undefined {\n  return retryState?.type === 'waiting-for-timeout' ||\n    retryState?.type === 'updating'\n    ? retryState?.retryIntervalMs\n    : undefined;\n}\n","export const classNames = {\n    combine: (...classes) => classes.filter(Boolean).join(\" \"),\n};\nexport function variants(config) {\n    const { base, variants, compoundVariants, defaultVariants } = config;\n    const isBooleanVariant = (name) => {\n        const v = variants === null || variants === void 0 ? void 0 : variants[name];\n        return v && (\"false\" in v || \"true\" in v);\n    };\n    return (props) => {\n        var _a;\n        const classes = base ? [base] : [];\n        const getSelected = (name) => {\n            var _a, _b;\n            return (_b = (_a = props[name]) !== null && _a !== void 0 ? _a : defaultVariants === null || defaultVariants === void 0 ? void 0 : defaultVariants[name]) !== null && _b !== void 0 ? _b : (isBooleanVariant(name) ? false : undefined);\n        };\n        for (let name in variants) {\n            const selected = getSelected(name);\n            if (selected !== undefined)\n                classes.push((_a = variants[name]) === null || _a === void 0 ? void 0 : _a[selected]);\n        }\n        for (let { variants, className } of compoundVariants !== null && compoundVariants !== void 0 ? compoundVariants : []) {\n            const isSelected = (name) => getSelected(name) === variants[name];\n            if (Object.keys(variants).every(isSelected)) {\n                classes.push(className);\n            }\n        }\n        return classNames.combine(...classes);\n    };\n}\n/**\n * No-op function to mark template literals as tailwind strings.\n */\nexport const tw = String.raw;\n","import { createElement, forwardRef, } from \"react\";\nimport { variants, classNames, } from \"./index.js\";\nexport function variantProps(config) {\n    const variantClassName = variants(config);\n    return (props) => {\n        const result = {};\n        // Pass-through all unrelated props\n        for (let prop in props) {\n            if (config.variants && !(prop in config.variants)) {\n                result[prop] = props[prop];\n            }\n        }\n        // Add the optionally passed className prop for chaining\n        result.className = classNames.combine(variantClassName(props), props.className);\n        return result;\n    };\n}\nexport function styled(type, config) {\n    const styledProps = typeof config === \"string\"\n        ? variantProps({ base: config, variants: {} })\n        : variantProps(config);\n    const Component = forwardRef(({ as, ...props }, ref) => {\n        return createElement(as !== null && as !== void 0 ? as : type, { ...styledProps(props), ref });\n    });\n    return Component;\n}\n/**\n * No-op function to mark template literals as tailwind strings.\n */\nexport const tw = String.raw;\n","import { DataSeries } from '@birchill/jpdict-idb';\n\nexport const localizedDataSeriesKey: { [series in DataSeries]: string } = {\n  kanji: 'options_kanji_data_name',\n  radicals: 'options_bushu_data_name',\n  names: 'options_name_data_name',\n  words: 'options_words_data_name',\n};\n","export function classes(\n  ...classNames: Array<string | undefined | boolean>\n): string {\n  return classNames.filter(Boolean).join(' ');\n}\n","type LinkSpec = {\n  keyword: string;\n  href: string;\n};\n\ntype Props = {\n  text: string;\n  links: Array<LinkSpec>;\n};\n\nexport function Linkify(props: Props) {\n  const matchedReplacements: Array<{\n    index: number;\n    keyword: string;\n    href: string;\n  }> = [];\n\n  for (const link of props.links) {\n    const index = props.text.indexOf(link.keyword);\n    if (index !== -1) {\n      matchedReplacements.push({ index, ...link });\n    }\n  }\n  matchedReplacements.sort((a, b) => a.index - b.index);\n\n  let position = 0;\n  const parts: Array<string | LinkSpec> = [];\n\n  for (const replacement of matchedReplacements) {\n    if (position < replacement.index) {\n      parts.push(props.text.substring(position, replacement.index));\n    }\n\n    parts.push({ href: replacement.href, keyword: replacement.keyword });\n\n    position = replacement.index + replacement.keyword.length;\n  }\n\n  if (position < props.text.length) {\n    parts.push(props.text.substring(position, props.text.length));\n  }\n\n  return (\n    <>\n      {parts.map((part) =>\n        typeof part === 'string' ? (\n          part\n        ) : (\n          <a\n            key={part.keyword}\n            href={part.href}\n            target=\"_blank\"\n            rel=\"noreferrer\"\n          >\n            {part.keyword}\n          </a>\n        )\n      )}\n    </>\n  );\n}\n","// Our special date formatting that is a simplified ISO 8601 in local time\n// without seconds.\nexport function formatDate(date: Date): string {\n  const pad = (n: number) => (n < 10 ? '0' + n : n);\n  return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(\n    date.getDate()\n  )} ${pad(date.getHours())}:${pad(date.getMinutes())}`;\n}\n\nexport function formatSize(sizeInBytes: number): string {\n  const kilobyte = 1024;\n  const megabyte = kilobyte * 1024;\n  const gigabyte = megabyte * 1024;\n  const terabyte = gigabyte * 1024;\n\n  // We don't bother localizing any of this. Anyone able to make sense of a\n  // file size, can probably understand an English file size prefix.\n  if (sizeInBytes >= terabyte) {\n    return (sizeInBytes / terabyte).toFixed(3) + 'Tb';\n  }\n  if (sizeInBytes >= gigabyte) {\n    return (sizeInBytes / gigabyte).toFixed(2) + 'Gb';\n  }\n  if (sizeInBytes >= megabyte) {\n    return (sizeInBytes / megabyte).toFixed(1) + 'Mb';\n  }\n  if (sizeInBytes >= kilobyte) {\n    return Math.round(sizeInBytes / kilobyte) + 'Kb';\n  }\n\n  return sizeInBytes + ' bytes';\n}\n","import {\n  type DataSeriesState,\n  type DataVersion,\n  MajorDataSeries,\n  allDataSeries,\n  allMajorDataSeries,\n} from '@birchill/jpdict-idb';\nimport { VariantPropsOf, variantProps } from 'classname-variants/react';\nimport { RenderableProps } from 'preact';\nimport { useEffect, useState } from 'preact/hooks';\n\nimport { JpdictState } from '../background/jpdict';\nimport { localizedDataSeriesKey } from '../common/data-series-labels';\nimport { useLocale } from '../common/i18n';\nimport { classes } from '../utils/classes';\nimport { isFirefox } from '../utils/ua-utils';\n\nimport { Linkify } from './Linkify';\nimport { formatDate, formatSize } from './format';\n\ntype Props = {\n  dbState: JpdictState;\n  devMode?: boolean;\n  onCancelDbUpdate?: () => void;\n  onDeleteDb?: () => void;\n  onUpdateDb?: () => void;\n};\n\nexport function DbStatus(props: Props) {\n  return (\n    <div class=\"flex flex-col gap-4 py-4\">\n      <DbSummaryBlurb />\n      <DbSummaryStatus\n        dbState={props.dbState}\n        onCancelDbUpdate={props.onCancelDbUpdate}\n        onUpdateDb={props.onUpdateDb}\n      />\n      {props.devMode && (\n        <div class=\"rounded-lg border border-solid border-red-900 bg-red-50 px-4 py-2 text-red-900 dark:border-red-200/50 dark:bg-red-900/30 dark:text-red-50\">\n          <span>Database testing features: </span>\n          <button onClick={props.onDeleteDb}>Delete database</button>\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction DbSummaryBlurb() {\n  const { t } = useLocale();\n\n  const attribution = t('options_data_source');\n  const license = t('options_edrdg_license');\n  const licenseKeyword = t('options_edrdg_license_keyword');\n  const accentAttribution = t('options_accent_data_source');\n  const strokeAttribution = t('options_stroke_data_source');\n\n  return (\n    <>\n      <p class=\"m-0\">\n        <Linkify\n          text={attribution}\n          links={[\n            {\n              keyword: 'JMdict/EDICT',\n              href: 'https://www.edrdg.org/wiki/index.php/JMdict-EDICT_Dictionary_Project',\n            },\n            {\n              keyword: 'KANJIDIC',\n              href: 'https://www.edrdg.org/wiki/index.php/KANJIDIC_Project',\n            },\n            {\n              keyword: 'JMnedict/ENAMDICT',\n              href: 'https://www.edrdg.org/enamdict/enamdict_doc.html',\n            },\n          ]}\n        />\n        <Linkify\n          text={license}\n          links={[\n            {\n              keyword: 'Electronic Dictionary Research and Development Group',\n              href: 'https://www.edrdg.org/',\n            },\n            {\n              keyword: licenseKeyword,\n              href: 'https://www.edrdg.org/edrdg/licence.html',\n            },\n          ]}\n        />\n      </p>\n      <p class=\"m-0\">{accentAttribution}</p>\n      <p class=\"m-0\">\n        <Linkify\n          text={strokeAttribution}\n          links={[\n            {\n              keyword: 'KanjiVG',\n              href: 'https://kanjivg.tagaini.net',\n            },\n            {\n              keyword: 'Creative Commons Attribution-Share Alike 3.0',\n              href: 'https://creativecommons.org/licenses/by-sa/3.0/',\n            },\n          ]}\n        />\n      </p>\n    </>\n  );\n}\n\nfunction DbSummaryStatus(props: {\n  dbState: JpdictState;\n  onCancelDbUpdate?: () => void;\n  onUpdateDb?: () => void;\n}) {\n  const { t } = useLocale();\n\n  if (props.dbState.updateState.type === 'idle') {\n    return (\n      <IdleStateSummary dbState={props.dbState} onUpdateDb={props.onUpdateDb} />\n    );\n  }\n\n  if (props.dbState.updateState.type === 'checking') {\n    return (\n      <DbSummaryContainer>\n        <div>{t('options_checking_for_updates')}</div>\n        <CancelUpdateButton onClick={props.onCancelDbUpdate} />\n      </DbSummaryContainer>\n    );\n  }\n\n  const {\n    dbState: {\n      updateState: {\n        series,\n        totalProgress,\n        version: { major, minor, patch },\n      },\n    },\n  } = props;\n  const versionString = `${major}.${minor}.${patch}`;\n\n  const progressAsPercent = Math.round(totalProgress * 100);\n  const dbLabel = t(localizedDataSeriesKey[series]);\n\n  return (\n    <DbSummaryContainer>\n      <div>\n        <progress\n          class=\"mb-2 block\"\n          max={100}\n          id=\"update-progress\"\n          value={totalProgress * 100}\n        />\n        <label class=\"block italic\" for=\"update-progress\">\n          {t('options_downloading_data', [\n            dbLabel,\n            versionString,\n            String(progressAsPercent),\n          ])}\n        </label>\n      </div>\n      <CancelUpdateButton onClick={props.onCancelDbUpdate} />\n    </DbSummaryContainer>\n  );\n}\n\nconst dbSummaryContainerProps = variantProps({\n  base: 'flex flex-wrap items-center gap-x-4 gap-y-2 [&>:first-child]:grow',\n  variants: {\n    errorClass: {\n      none: '',\n      warning: classes(\n        'rounded-lg border border-solid px-4 py-2',\n        // Light mode\n        'border-yellow-800 bg-yellow-50 text-yellow-800',\n        // Dark mode\n        'dark:border-yellow-400/50 dark:bg-yellow-900/50 dark:text-yellow-50'\n      ),\n      error: classes(\n        'rounded-lg border border-solid px-4 py-2',\n        // Light mode\n        'border-red-900 bg-red-50 text-red-900',\n        // Dark mode\n        'dark:border-red-200/50 dark:bg-red-900/30 dark:text-red-50'\n      ),\n    },\n  },\n  defaultVariants: {\n    errorClass: 'none',\n  },\n});\n\nfunction DbSummaryContainer(\n  props: RenderableProps<VariantPropsOf<typeof dbSummaryContainerProps>>\n) {\n  return <div {...dbSummaryContainerProps(props)}>{props.children}</div>;\n}\n\nfunction IdleStateSummary(props: {\n  dbState: JpdictState;\n  onUpdateDb?: () => void;\n}) {\n  const { t } = useLocale();\n  const isUnavailable = allDataSeries.some(\n    (series) => props.dbState[series].state === 'unavailable'\n  );\n\n  const errorDetails = useErrorDetails(props.dbState);\n  if (errorDetails) {\n    const { class: errorClass, errorMessage, nextRetry } = errorDetails;\n    return (\n      <DbSummaryContainer errorClass={errorClass}>\n        <div>{errorMessage}</div>\n        {nextRetry && (\n          <div class=\"grow self-start\">\n            {t('options_db_update_next_retry', formatDate(nextRetry))}\n          </div>\n        )}\n        <UpdateButton\n          label={isUnavailable ? 'retry' : 'check'}\n          lastCheck={props.dbState.updateState.lastCheck}\n          onClick={props.onUpdateDb}\n        />\n      </DbSummaryContainer>\n    );\n  }\n\n  return (\n    <DbSummaryContainer>\n      <div class=\"grid auto-cols-fr grid-flow-col grid-rows-[repeat(2,_auto)] gap-x-2 sm:gap-x-4\">\n        {allMajorDataSeries.map((series) => {\n          const versionInfo = props.dbState[series].version;\n          return versionInfo ? (\n            <DataSeriesVersion series={series} version={versionInfo} />\n          ) : null;\n        })}\n      </div>\n      <div class=\"mt-2\">\n        <UpdateButton\n          label={isUnavailable ? 'retry' : 'check'}\n          lastCheck={props.dbState.updateState.lastCheck}\n          onClick={props.onUpdateDb}\n        />\n      </div>\n    </DbSummaryContainer>\n  );\n}\n\nfunction useErrorDetails(dbState: JpdictState): {\n  class: 'warning' | 'error';\n  errorMessage: string;\n  nextRetry?: Date;\n} | null {\n  const { t } = useLocale();\n\n  const { updateError } = dbState;\n  const quota = useStorageQuota(updateError?.name === 'QuotaExceededError');\n\n  // Offline errors\n  if (updateError?.name === 'OfflineError') {\n    return { class: 'warning', errorMessage: t('options_offline_explanation') };\n  }\n\n  // Quote exceeded errors have a special message.\n  if (updateError?.name === 'QuotaExceededError' && quota !== undefined) {\n    return {\n      class: 'error',\n      errorMessage: t('options_db_update_quota_error', formatSize(quota)),\n      nextRetry: updateError.nextRetry,\n    };\n  }\n\n  // Generic update errors\n  if (updateError && updateError?.name !== 'AbortError') {\n    return {\n      class: 'error',\n      errorMessage: t('options_db_update_error', updateError.message),\n      nextRetry: updateError.nextRetry,\n    };\n  }\n\n  // Check if we have any version info\n  const hasVersionInfo = allMajorDataSeries.some(\n    (series) => !!dbState[series].version\n  );\n  if (hasVersionInfo) {\n    return null;\n  }\n\n  // Otherwise, return a suitable summary error\n  const summaryStates: Array<[DataSeriesState, string]> = [\n    ['init', 'options_database_initializing'],\n    [\n      'unavailable',\n      isFirefox()\n        ? 'options_database_unavailable_firefox'\n        : 'options_database_unavailable',\n    ],\n    ['empty', 'options_no_database'],\n  ];\n  for (const [state, key] of summaryStates) {\n    if (allMajorDataSeries.some((series) => dbState[series].state === state)) {\n      return {\n        class: 'error',\n        errorMessage: t(key),\n      };\n    }\n  }\n\n  return null;\n}\n\nfunction useStorageQuota(enable: boolean): number | undefined {\n  const [quota, setQuota] = useState<number | undefined>(undefined);\n\n  useEffect(() => {\n    if (!enable) {\n      setQuota(undefined);\n      return;\n    }\n\n    navigator.storage\n      .estimate()\n      .then(({ quota }) => {\n        if (typeof quota !== 'undefined') {\n          // For Firefox, typically origins get a maximum of 20% of the global\n          // limit. When we have unlimitedStorage permission, however, we can\n          // use up to the full amount of the global limit. The storage API,\n          // however, still returns 20% as the quota, so multiplying by 5 will\n          // give the actual quota.\n          if (isFirefox()) {\n            quota *= 5;\n          }\n        }\n        setQuota(quota);\n      })\n      .catch(() => {\n        // Ignore. This UA likely doesn't support the navigator.storage API\n      });\n  }, [enable]);\n\n  return quota;\n}\n\nfunction DataSeriesVersion(props: {\n  series: MajorDataSeries;\n  version: DataVersion;\n}) {\n  const { t } = useLocale();\n\n  const titleKeys: { [series in MajorDataSeries]: string } = {\n    kanji: 'options_kanji_data_title',\n    names: 'options_name_data_title',\n    words: 'options_words_data_title',\n  };\n  const { major, minor, patch, lang } = props.version;\n  const titleString = t(\n    titleKeys[props.series],\n    `${major}.${minor}.${patch} (${lang})`\n  );\n\n  const sourceNames: { [series in MajorDataSeries]: string } = {\n    kanji: 'KANJIDIC',\n    names: 'JMnedict/ENAMDICT',\n    words: 'JMdict/EDICT',\n  };\n\n  const { databaseVersion, dateOfCreation } = props.version;\n\n  const sourceName = sourceNames[props.series];\n  let sourceString;\n  if (databaseVersion && databaseVersion !== 'n/a') {\n    sourceString = t('options_data_series_version_and_date', [\n      sourceName,\n      databaseVersion,\n      dateOfCreation,\n    ]);\n  } else {\n    sourceString = t('options_data_series_date_only', [\n      sourceName,\n      dateOfCreation,\n    ]);\n  }\n\n  return (\n    <>\n      <div>{titleString}</div>\n      <div class=\"text-sm text-zinc-500 dark:text-zinc-400\">{sourceString}</div>\n    </>\n  );\n}\n\nfunction UpdateButton(props: {\n  label: 'retry' | 'check';\n  lastCheck?: Date | null;\n  onClick?: () => void;\n}) {\n  const { t } = useLocale();\n\n  const buttonLabel = t(\n    props.label === 'retry'\n      ? 'options_update_retry_button_label'\n      : 'options_update_check_button_label'\n  );\n\n  return (\n    <div>\n      <button type=\"button\" onClick={props.onClick}>\n        {buttonLabel}\n      </button>\n      {props.lastCheck && (\n        <div class=\"mt-1.5 text-xs italic\">\n          {t('options_last_database_check', formatDate(props.lastCheck))}\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction CancelUpdateButton(props: { onClick?: () => void }) {\n  const { t } = useLocale();\n\n  return (\n    <button type=\"button\" onClick={props.onClick}>\n      {t('options_cancel_update_button_label')}\n    </button>\n  );\n}\n","import { JpdictState } from '../background/jpdict';\n\nexport const notifyDbStateUpdated = (state: JpdictState) => ({\n  type: 'dbstateupdated' as const,\n  state,\n});\n\nexport type DbStateUpdatedMessage = ReturnType<typeof notifyDbStateUpdated>;\n\nexport const updateDb = () => ({\n  type: 'updatedb' as const,\n});\n\nexport const cancelDbUpdate = () => ({\n  type: 'cancelupdatedb' as const,\n});\n\nexport const deleteDb = () => ({\n  type: 'deletedb' as const,\n});\n\nexport type DbListenerMessage =\n  | ReturnType<typeof notifyDbStateUpdated>\n  | ReturnType<typeof updateDb>\n  | ReturnType<typeof cancelDbUpdate>\n  | ReturnType<typeof deleteDb>;\n","import Bugsnag from '@birchill/bugsnag-zero';\nimport { useCallback, useEffect, useRef, useState } from 'preact/hooks';\nimport browser, { Runtime } from 'webextension-polyfill';\n\nimport { JpdictState } from '../background/jpdict';\nimport {\n  DbStateUpdatedMessage,\n  cancelDbUpdate,\n  deleteDb,\n  updateDb,\n} from '../common/db-listener-messages';\nimport { isObject } from '../utils/is-object';\n\nconst initialDbstate: JpdictState = {\n  words: {\n    state: 'init',\n    version: null,\n  },\n  kanji: {\n    state: 'init',\n    version: null,\n  },\n  radicals: {\n    state: 'init',\n    version: null,\n  },\n  names: {\n    state: 'init',\n    version: null,\n  },\n  updateState: { type: 'idle', lastCheck: null },\n};\n\nexport function useDb(): {\n  dbState: JpdictState;\n  startDatabaseUpdate: () => void;\n  cancelDatabaseUpdate: () => void;\n  deleteDatabase: () => void;\n} {\n  const [dbState, setDbState] = useState<JpdictState>(initialDbstate);\n  const browserPortRef = useRef<Runtime.Port | undefined>(undefined);\n\n  useEffect(() => {\n    let browserPort = browser.runtime.connect(undefined, { name: 'options' });\n    browserPortRef.current = browserPort;\n\n    const onMessage = (event: unknown) => {\n      if (isDbStateUpdatedMessage(event)) {\n        // For Runtime.Port.postMessage Chrome appears to serialize objects\n        // using JSON serialization (not structured cloned). As a result, any\n        // Date objects will be transformed into strings.\n        //\n        // Ideally we'd introduce a new type for these deserialized objects that\n        // converts `Date` to `Date | string` but that is likely to take a full\n        // day of TypeScript wrestling so instead we just manually reach into\n        // this object and convert the fields known to possibly contain dates\n        // into dates.\n        if (typeof event.state.updateState.lastCheck === 'string') {\n          event.state.updateState.lastCheck = new Date(\n            event.state.updateState.lastCheck\n          );\n        }\n        if (typeof event.state.updateError?.nextRetry === 'string') {\n          event.state.updateError.nextRetry = new Date(\n            event.state.updateError.nextRetry\n          );\n        }\n\n        setDbState(event.state);\n      }\n    };\n\n    // It's possible this might be disconnected on iOS which doesn't seem to\n    // keep inactive ports alive. I've observed this happening on Chrome too.\n    //\n    // Note that according to the docs, this should not be called when _we_ call\n    // disconnect():\n    //\n    //  https://developer.chrome.com/docs/extensions/mv3/messaging/#port-lifetime\n    //\n    // Nevertheless, we check that `browserPort` is not undefined before trying\n    // to re-connect just in case some browsers behave differently here.\n    const onDisconnect = (port: Runtime.Port) => {\n      // Firefox annotates `port` with an `error` but Chrome does not.\n      const error =\n        isObject((port as any).error) &&\n        typeof (port as any).error.message === 'string'\n          ? (port as any).error.message\n          : browser.runtime.lastError;\n      Bugsnag.leaveBreadcrumb(\n        `Options page disconnected from background page${\n          error ? `: ${error}` : ''\n        }`\n      );\n      browserPortRef.current = undefined;\n\n      // Wait a moment and try to reconnect\n      setTimeout(() => {\n        try {\n          // Check that browserPort is still set to _something_. If it is\n          // undefined it probably means we are shutting down.\n          if (!browserPort) {\n            Bugsnag.leaveBreadcrumb(\n              'Not reconnecting to background page because we are probably shutting down'\n            );\n            return;\n          }\n          browserPort = browser.runtime.connect(undefined, { name: 'options' });\n          browserPortRef.current = browserPort;\n          Bugsnag.leaveBreadcrumb(\n            'Options page reconnected to background page'\n          );\n\n          browserPort.onMessage.addListener(onMessage);\n          browserPort.onDisconnect.addListener(onDisconnect);\n        } catch (e) {\n          void Bugsnag.notify(e);\n        }\n      }, 700);\n    };\n\n    browserPort.onMessage.addListener(onMessage);\n    browserPort.onDisconnect.addListener(onDisconnect);\n\n    window.addEventListener('unload', () => {\n      browserPort?.disconnect();\n      browserPortRef.current = undefined;\n    });\n\n    return () => {\n      browserPort?.disconnect();\n      browserPortRef.current = undefined;\n    };\n  }, []);\n\n  const startDatabaseUpdate = useCallback(() => {\n    browserPortRef.current?.postMessage(updateDb());\n  }, []);\n\n  const cancelDatabaseUpdate = useCallback(() => {\n    browserPortRef.current?.postMessage(cancelDbUpdate());\n  }, []);\n\n  const deleteDatabase = useCallback(() => {\n    browserPortRef.current?.postMessage(deleteDb());\n  }, []);\n\n  return { dbState, startDatabaseUpdate, cancelDatabaseUpdate, deleteDatabase };\n}\n\nfunction isDbStateUpdatedMessage(\n  event: unknown\n): event is DbStateUpdatedMessage {\n  return (\n    isObject(event) &&\n    typeof (event as any).type === 'string' &&\n    (event as any).type === 'dbstateupdated'\n  );\n}\n","import { useLocale } from '../common/i18n';\nimport { getReleaseStage } from '../utils/release-stage';\n\nimport { DbStatus } from './DbStatus';\nimport { SectionHeading } from './SectionHeading';\nimport { useDb } from './use-db';\n\nexport function DictionaryDataSettings() {\n  const { t } = useLocale();\n  const { dbState, startDatabaseUpdate, cancelDatabaseUpdate, deleteDatabase } =\n    useDb();\n  const releaseStage = getReleaseStage();\n\n  return (\n    <>\n      <SectionHeading>{t('options_dictionary_data_heading')}</SectionHeading>\n      <div class=\"py-4\">\n        <DbStatus\n          dbState={dbState}\n          devMode={releaseStage === 'development'}\n          onCancelDbUpdate={cancelDatabaseUpdate}\n          onDeleteDb={deleteDatabase}\n          onUpdateDb={startDatabaseUpdate}\n        />\n      </div>\n    </>\n  );\n}\n","import Bugsnag from '@birchill/bugsnag-zero';\nimport type { JSX } from 'preact';\nimport { useCallback } from 'preact/hooks';\n\nimport {\n  DbLanguageId,\n  dbLanguageMeta,\n  isDbLanguageId,\n} from '../common/db-languages';\nimport { useLocale } from '../common/i18n';\nimport { classes } from '../utils/classes';\n\ntype Props = {\n  dictLang: DbLanguageId;\n  onChangeDictLang: (lang: DbLanguageId) => void;\n};\n\nexport function DictionaryLanguageSettingsForm(props: Props) {\n  const { t } = useLocale();\n\n  const onChange = useCallback(\n    (event: JSX.TargetedEvent<HTMLSelectElement>) => {\n      const value = event.currentTarget.value;\n      if (!isDbLanguageId(value)) {\n        const msg = `Got unexpected language code: ${value}`;\n        console.error(msg);\n        void Bugsnag.notify(new Error(msg));\n        return;\n      }\n\n      props.onChangeDictLang(value);\n    },\n    [props.onChangeDictLang]\n  );\n\n  return (\n    <>\n      <select id=\"lang\" class=\"w-40\" name=\"lang\" onChange={onChange}>\n        {dbLanguageMeta.map(([id, data]) => {\n          let label = data.name;\n          if (data.hasWords && !data.hasKanji) {\n            label += t('options_lang_words_only');\n          } else if (!data.hasWords && data.hasKanji) {\n            label += t('options_lang_kanji_only');\n          }\n          return (\n            <option key={id} value={id} selected={id === props.dictLang}>\n              {label}\n            </option>\n          );\n        })}\n      </select>\n      <div\n        class={classes(\n          'mt-4 rounded-lg border border-solid px-4 py-2 leading-normal',\n          'border-yellow-800 bg-yellow-50 text-yellow-800',\n          'dark:border-yellow-400/50 dark:bg-yellow-900/50 dark:text-yellow-50'\n        )}\n      >\n        <p>{t('options_lang_warning_please_note')}</p>\n        <ul>\n          <li>{t('options_lang_warning_other_lang_when_available')}</li>\n          <li>{t('options_lang_warning_always_en')}</li>\n          <li>{t('options_lang_warning_names_en_only')}</li>\n          <li>{t('options_lang_warning_change_lang_redownload')}</li>\n          <li>{t('options_lang_warning_temporary_en_fallback')}</li>\n        </ul>\n      </div>\n    </>\n  );\n}\n","import { useCallback } from 'preact/hooks';\n\nimport type { Config } from '../common/config';\nimport { DbLanguageId } from '../common/db-languages';\nimport { useLocale } from '../common/i18n';\n\nimport { DictionaryLanguageSettingsForm } from './DictionaryLanguageSettingsForm';\nimport { SectionHeading } from './SectionHeading';\nimport { useConfigValue } from './use-config-value';\n\ntype Props = {\n  config: Config;\n};\n\nexport function DictionaryLanguageSettings(props: Props) {\n  const { t } = useLocale();\n  const dictLang = useConfigValue(props.config, 'dictLang');\n  const onChangeDictLang = useCallback(\n    (value: DbLanguageId) => {\n      props.config.dictLang = value;\n    },\n    [props.config]\n  );\n\n  return (\n    <>\n      <SectionHeading>\n        {t('options_dictionary_language_heading')}\n      </SectionHeading>\n      <div class=\"py-4\">\n        <DictionaryLanguageSettingsForm\n          dictLang={dictLang}\n          onChangeDictLang={onChangeDictLang}\n        />\n      </div>\n    </>\n  );\n}\n","import type { ComponentProps, JSX } from 'preact';\nimport { forwardRef } from 'preact/compat';\nimport { useId } from 'preact/hooks';\n\nimport { classes } from '../utils/classes';\n\ntype InputProps = Omit<\n  ComponentProps<'input'>,\n  'id' | 'type' | 'class' | 'className'\n> & { label?: string };\n\nexport const IconRadio = forwardRef<HTMLInputElement, InputProps>(\n  (props: InputProps, ref) => {\n    const id = useId();\n\n    return (\n      <div>\n        <input\n          ref={ref}\n          id={id}\n          type=\"radio\"\n          class=\"peer sr-only\"\n          {...{ ...props, children: undefined }}\n        />\n        <label\n          class={classes(\n            'peer-focus-visible:outline-auto group cursor-pointer rounded-md border border-solid',\n            'text-center transition duration-300',\n            !props.checked &&\n              'opacity-50 grayscale hover:opacity-100 hover:grayscale-0 active:opacity-100 active:grayscale-0',\n            props.label\n              ? 'flex flex-col items-center overflow-hidden rounded-md border-zinc-500 bg-white dark:border-zinc-100/20 dark:bg-zinc-900'\n              : 'border-transparent'\n          )}\n          for={id}\n        >\n          <div\n            class={\n              props.label\n                ? 'w-full bg-zinc-100 group-hover:bg-zinc-200 dark:bg-zinc-800 dark:group-hover:bg-zinc-700'\n                : ''\n            }\n          >\n            {props.children}\n          </div>\n          {!!props.label && (\n            <div class=\"flex w-full items-center gap-1.5 border-0 border-t border-solid border-t-zinc-500 px-2 py-1.5 dark:border-t-zinc-100/20\">\n              <Radio checked={props.checked} />\n              {props.label}\n            </div>\n          )}\n        </label>\n      </div>\n    );\n  }\n);\n\nfunction Radio(props: {\n  checked?: boolean | JSX.SignalLike<boolean | undefined>;\n}) {\n  return (\n    <span\n      class={classes(\n        'inline-block size-4 rounded-full border border-solid border-zinc-500 bg-zinc-100 dark:border-zinc-600 dark:bg-zinc-700',\n        props.checked\n          ? 'border-blue-700 bg-white shadow-[inset_0_0_0_2.5px_theme(colors.blue.500)] dark:bg-zinc-900'\n          : 'group-hover:bg-zinc-200 dark:group-hover:bg-zinc-600'\n      )}\n    />\n  );\n}\n","import { HighlightStyle } from '../common/content-config-params';\nimport { useLocale } from '../common/i18n';\n\nimport { IconRadio } from './IconRadio';\n\ntype Props = {\n  onChange: (value: HighlightStyle | 'none') => void;\n  value: HighlightStyle | 'none';\n};\n\nexport function HighlightStyleRadio(props: Props) {\n  const { t } = useLocale();\n\n  return (\n    <div class=\"grid w-max grid-cols-3 gap-2\">\n      <IconRadio\n        checked={props.value === 'none'}\n        label={t('options_highlight_style_none')}\n        name=\"highlightStyle\"\n        onChange={() => props.onChange('none')}\n        value=\"none\"\n      >\n        <HighlightPreview />\n      </IconRadio>\n      <IconRadio\n        checked={props.value === 'yellow'}\n        label={t('options_highlight_style_yellow')}\n        name=\"highlightStyle\"\n        onChange={() => props.onChange('yellow')}\n        value=\"yellow\"\n      >\n        <HighlightPreview rangeClass=\"bg-yellow-300 text-black\" />\n      </IconRadio>\n      <IconRadio\n        checked={props.value === 'blue'}\n        label={t('options_highlight_style_blue')}\n        name=\"highlightStyle\"\n        onChange={() => props.onChange('blue')}\n        value=\"blue\"\n      >\n        <HighlightPreview rangeClass=\"bg-blue-600 text-white\" />\n      </IconRadio>\n    </div>\n  );\n}\n\nfunction HighlightPreview(props: { rangeClass?: string }) {\n  return (\n    <div class=\"flex items-center justify-center px-2 py-4 text-[15px] min-[300px]:text-[20px] min-[400px]:min-h-[calc(48px+16px*2)] min-[400px]:min-w-[calc(48px+32px*2)] min-[400px]:text-[25px]\">\n      <span class=\"fade-ends-x\">\n        <span class={props.rangeClass}></span>\n      </span>\n    </div>\n  );\n}\n","import { useLocale } from '../common/i18n';\nimport { classes } from '../utils/classes';\n\nimport { IconRadio } from './IconRadio';\n\ntype Props = {\n  onChange: (value: 'default' | 'sky') => void;\n  value: 'default' | 'sky';\n};\n\nexport function ToolbarIconRadio(props: Props) {\n  const { t } = useLocale();\n\n  return (\n    <div class=\"grid w-max grid-cols-2 gap-2\">\n      <IconRadio\n        checked={props.value === 'default'}\n        label={t('options_toolbar_icon_classic_label')}\n        name=\"toolbarIcon\"\n        onChange={() => props.onChange('default')}\n        value=\"default\"\n      >\n        <IconPreview\n          alt={t('options_toolbar_icon_default_alt')}\n          checked={props.value === 'default'}\n          src=\"/images/10ten.svg\"\n        />\n      </IconRadio>\n      <IconRadio\n        checked={props.value === 'sky'}\n        label={t('options_toolbar_icon_kanji_label')}\n        name=\"toolbarIcon\"\n        onChange={() => props.onChange('sky')}\n        value=\"sky\"\n      >\n        <IconPreview\n          alt={t('options_toolbar_icon_sky_alt')}\n          checked={props.value === 'sky'}\n          src=\"/images/10ten-sky.svg\"\n        />\n      </IconRadio>\n    </div>\n  );\n}\n\nfunction IconPreview(props: { alt: string; checked: boolean; src: string }) {\n  return (\n    <div class=\"align-center px-[32px] py-[16px]\">\n      <img\n        class={classes(\n          'h-[48px] w-[48px] drop-shadow-[0px_1px_1px_rgba(0,0,0,0.25)]',\n          props.checked && 'dark:drop-shadow-[0_0_3px_rgba(255,255,255,0.5)]'\n        )}\n        src={props.src}\n        alt={props.alt}\n      />\n    </div>\n  );\n}\n","import { HighlightStyle } from '../common/content-config-params';\nimport { useLocale } from '../common/i18n';\n\nimport { CheckboxRow } from './CheckboxRow';\nimport { HighlightStyleRadio } from './HighlightStyleRadio';\nimport { ToolbarIconRadio } from './ToolbarIconRadio';\n\ntype Props = {\n  contextMenuEnable: boolean;\n  highlightStyle: HighlightStyle | 'none';\n  onChangeContextMenuEnable: (value: boolean) => void;\n  onChangeHighlightStyle: (value: HighlightStyle | 'none') => void;\n  onChangeToolbarIcon: (value: 'default' | 'sky') => void;\n  supportsCssHighlight: boolean;\n  toolbarIcon: 'default' | 'sky';\n};\n\nexport function GeneralSettingsForm(props: Props) {\n  const { t } = useLocale();\n\n  return (\n    <div class=\"flex flex-col gap-3\">\n      <p class=\"m-0\">{t('options_toolbar_icon_label')}</p>\n      <ToolbarIconRadio\n        value={props.toolbarIcon}\n        onChange={props.onChangeToolbarIcon}\n      />\n      {props.supportsCssHighlight && (\n        <>\n          <p class=\"m-0\">{t('options_highlight_style_label')}</p>\n          <HighlightStyleRadio\n            value={props.highlightStyle}\n            onChange={props.onChangeHighlightStyle}\n          />\n        </>\n      )}\n      {/* Make sure there is a bit of a gap between the graphical radio\n        buttons and the checkbox(es) */}\n      <div />\n      {!props.supportsCssHighlight && (\n        <CheckboxRow>\n          <input\n            id=\"highlightText\"\n            name=\"highlightText\"\n            type=\"checkbox\"\n            checked={props.highlightStyle !== 'none'}\n            onChange={(e) =>\n              props.onChangeHighlightStyle(\n                e.currentTarget.checked ? 'yellow' : 'none'\n              )\n            }\n          />\n          <label for=\"highlightText\">\n            {t('options_highlight_matched_text')}\n          </label>\n        </CheckboxRow>\n      )}\n      <CheckboxRow>\n        <input\n          id=\"contextMenuEnable\"\n          name=\"contextMenuEnable\"\n          type=\"checkbox\"\n          checked={props.contextMenuEnable}\n          onChange={(e) =>\n            props.onChangeContextMenuEnable(e.currentTarget.checked)\n          }\n        />\n        <label for=\"contextMenuEnable\">\n          {t('options_show_context_menu_item')}\n        </label>\n      </CheckboxRow>\n    </div>\n  );\n}\n","import { useCallback, useState } from 'preact/hooks';\n\nimport type { Config } from '../common/config';\nimport { HighlightStyle } from '../common/content-config-params';\nimport { useLocale } from '../common/i18n';\n\nimport { GeneralSettingsForm } from './GeneralSettingsForm';\nimport { SectionHeading } from './SectionHeading';\nimport { useConfigValue } from './use-config-value';\n\ntype Props = {\n  config: Config;\n};\n\nexport function GeneralSettings(props: Props) {\n  const { t } = useLocale();\n\n  const toolbarIcon = useConfigValue(props.config, 'toolbarIcon');\n  const onChangeToolbarIcon = useCallback(\n    (value: 'default' | 'sky') => {\n      props.config.toolbarIcon = value;\n    },\n    [props.config]\n  );\n\n  const noTextHighlight = useConfigValue(props.config, 'noTextHighlight');\n  const rawHighlightStyle = useConfigValue(props.config, 'highlightStyle');\n  const highlightStyle = noTextHighlight ? 'none' : rawHighlightStyle;\n\n  const onChangeHighlightStyle = useCallback(\n    (value: HighlightStyle | 'none') => {\n      if (value === 'none') {\n        props.config.noTextHighlight = true;\n      } else {\n        props.config.highlightStyle = value;\n        props.config.noTextHighlight = false;\n      }\n    },\n    [props.config]\n  );\n\n  const contextMenuEnable = useConfigValue(props.config, 'contextMenuEnable');\n  const onChangeContextMenuEnable = useCallback(\n    (value: boolean) => {\n      props.config.contextMenuEnable = value;\n    },\n    [props.config]\n  );\n\n  const [supportsCssHighlight] = useState(\n    CSS.supports('selector(::highlight(yer))')\n  );\n\n  return (\n    <>\n      <SectionHeading>{t('options_general_heading')}</SectionHeading>\n      <div class=\"py-4\">\n        <GeneralSettingsForm\n          contextMenuEnable={contextMenuEnable}\n          highlightStyle={highlightStyle}\n          onChangeContextMenuEnable={onChangeContextMenuEnable}\n          onChangeHighlightStyle={onChangeHighlightStyle}\n          onChangeToolbarIcon={onChangeToolbarIcon}\n          supportsCssHighlight={supportsCssHighlight}\n          toolbarIcon={toolbarIcon}\n        />\n      </div>\n    </>\n  );\n}\n","import { useMemo } from 'preact/hooks';\n\nimport { DbLanguageId } from '../common/db-languages';\nimport { useLocale } from '../common/i18n';\nimport {\n  type ReferenceAbbreviation,\n  getReferenceLabelsForLang,\n} from '../common/refs';\n\nimport { CheckboxRow } from './CheckboxRow';\n\ntype Props = {\n  dictLang: DbLanguageId;\n  enabledReferences: Array<ReferenceAbbreviation>;\n  showKanjiComponents: boolean;\n  onToggleReference: (ref: ReferenceAbbreviation, value: boolean) => void;\n  onToggleKanjiComponents: (value: boolean) => void;\n};\n\nexport function KanjiReferenceSettingsForm(props: Props) {\n  const { t } = useLocale();\n  const lang = t('lang_tag');\n\n  const references = useMemo(() => {\n    return [\n      {\n        ref: 'kanjiComponents',\n        full: t('options_kanji_components'),\n      },\n      ...getReferenceLabelsForLang(props.dictLang, t),\n    ];\n  }, [props.dictLang, lang]);\n\n  const enabledReferences = useMemo(\n    () => new Set(props.enabledReferences),\n    [props.enabledReferences]\n  );\n\n  // We want to match the arrangement of references when they are displayed,\n  // that is, in a vertically flowing grid. See comments where we generate the\n  // popup styles for more explanation.\n  const gridTemplateRows = `repeat(${Math.ceil(\n    references.length / 2\n  )}, minmax(min-content, max-content))`;\n\n  return (\n    <div\n      class=\"grid w-[95%] grid-cols-[minmax(250px,1fr)] gap-x-4 gap-y-3 sm:grid-flow-col sm:grid-cols-[repeat(2,minmax(250px,1fr))]\"\n      style={{ gridTemplateRows }}\n    >\n      {references.map(({ ref, full }) => (\n        <CheckboxRow key={ref}>\n          <input\n            type=\"checkbox\"\n            id={`ref-${ref}`}\n            name={ref}\n            checked={\n              ref === 'kanjiComponents'\n                ? props.showKanjiComponents\n                : enabledReferences.has(ref as ReferenceAbbreviation)\n            }\n            onClick={(event) => {\n              const value = event.currentTarget.checked;\n              if (ref === 'kanjiComponents') {\n                props.onToggleKanjiComponents(value);\n              } else {\n                props.onToggleReference(ref as ReferenceAbbreviation, value);\n              }\n            }}\n          />\n          <label class=\"cursor-pointer select-none\" for={`ref-${ref}`}>\n            {full}\n          </label>\n        </CheckboxRow>\n      ))}\n    </div>\n  );\n}\n","import { useCallback } from 'preact/hooks';\n\nimport type { Config } from '../common/config';\nimport { useLocale } from '../common/i18n';\nimport type { ReferenceAbbreviation } from '../common/refs';\n\nimport { KanjiReferenceSettingsForm } from './KanjiReferenceSettingsForm';\nimport { SectionHeading } from './SectionHeading';\nimport { useConfigValue } from './use-config-value';\n\ntype Props = {\n  config: Config;\n};\n\nexport function KanjiReferenceSettings(props: Props) {\n  const { t } = useLocale();\n  const dictLang = useConfigValue(props.config, 'dictLang');\n  const enabledReferences = useConfigValue(props.config, 'kanjiReferences');\n  const showKanjiComponents = useConfigValue(\n    props.config,\n    'showKanjiComponents'\n  );\n  const onToggleReference = useCallback(\n    (ref: ReferenceAbbreviation, value: boolean) => {\n      props.config.updateKanjiReferences({ [ref]: value });\n    },\n    [props.config]\n  );\n  const onToggleKanjiComponents = useCallback(\n    (value: boolean) => {\n      props.config.showKanjiComponents = value;\n    },\n    [props.config]\n  );\n\n  return (\n    <>\n      <SectionHeading>{t('options_kanji_dictionary_heading')}</SectionHeading>\n      <div class=\"py-4\">\n        <KanjiReferenceSettingsForm\n          dictLang={dictLang}\n          enabledReferences={enabledReferences}\n          showKanjiComponents={showKanjiComponents}\n          onToggleReference={onToggleReference}\n          onToggleKanjiComponents={onToggleKanjiComponents}\n        />\n      </div>\n    </>\n  );\n}\n","// Various common definitions used for the keys supported in copy mode.\n\nexport type CopyType = 'entry' | 'tab' | 'word';\n\ninterface CopyKey {\n  type: CopyType;\n  key: string;\n  optionsString: string;\n  popupString: string;\n}\n\nexport const CopyKeys: Array<CopyKey> = [\n  {\n    type: 'entry',\n    key: 'e',\n    optionsString: 'options_popup_copy_entry',\n    popupString: 'content_copy_keys_entry_label',\n  },\n  {\n    type: 'tab',\n    key: 't',\n    optionsString: 'options_popup_copy_fields',\n    popupString: 'content_copy_keys_fields_label',\n  },\n  {\n    type: 'word',\n    key: 'w',\n    optionsString: 'options_popup_copy_word_kanji',\n    popupString: 'content_copy_keys_word_label',\n  },\n];\n\nexport const CopyKanjiKeyStrings: Pick<CopyKey, 'popupString'> = {\n  popupString: 'content_copy_keys_kanji_label',\n};\n\nexport const CopyNextKeyStrings: Pick<\n  CopyKey,\n  'optionsString' | 'popupString'\n> = {\n  optionsString: 'options_popup_copy_next',\n  popupString: 'content_copy_keys_next_label',\n};\n","import type { ComponentProps, RenderableProps } from 'preact';\nimport { forwardRef } from 'preact/compat';\nimport { useId } from 'preact/hooks';\n\nimport { classes } from '../utils/classes';\n\ntype KeyboxProps = {\n  label: string;\n  isMac?: boolean;\n};\n\nexport function KeyBox(props: KeyboxProps) {\n  return (\n    <kbd\n      class={classes(\n        'font-inherit my-0.5 inline-flex h-9 min-w-[2.5em] p-2 text-sm',\n        'flex-col items-center justify-center',\n        'rounded-lg border border-solid border-zinc-400 bg-white dark:bg-zinc-800',\n        'border-b-[3px] border-b-zinc-500'\n      )}\n    >\n      {translateKey(props.label, !!props.isMac)}\n    </kbd>\n  );\n}\n\nfunction translateKey(key: string, isMac: boolean) {\n  if (!isMac) {\n    return key;\n  }\n\n  switch (key) {\n    case 'Command':\n      return '';\n\n    case 'Ctrl':\n      return 'Control';\n\n    case 'Alt':\n      return '';\n\n    default:\n      return key;\n  }\n}\n\ntype CheckboxProps = Omit<\n  ComponentProps<'input'>,\n  'type' | 'class' | 'className'\n>;\n\nexport const KeyCheckbox = forwardRef<\n  HTMLInputElement,\n  RenderableProps<CheckboxProps>\n>((props: CheckboxProps, ref) => {\n  const id = useId();\n\n  // If we use align-items: normal etc. the checkboxes line up with the label\n  // text nicely but we want to use align-items: baseline (`items-baseline`) so\n  // that we can line up any descriptive text with the checkbox labels (i.e.\n  // make this flexbox container into a container that \"participates in baseline\n  // alignment\" (https://drafts.csswg.org/css-flexbox-1/#baseline-participation).\n  //\n  // Doing that, however, pushes the checkboxes up a bit so they no longer\n  // appear vertically centered with the label text. To fix that we nudge the\n  // checkboxes down a bit with `translate-y-0.5` which seems to do the trick in\n  // at least Firefox and Chrome.\n  return (\n    <div class=\"flex items-baseline gap-1\">\n      <input\n        class=\"translate-y-0.5 [&:disabled+label]:opacity-50 [&:not(:checked)+label]:opacity-50\"\n        id={props.id || id}\n        type=\"checkbox\"\n        ref={ref}\n        {...props}\n      />\n      <label for={props.id || id}>{props.children}</label>\n    </div>\n  );\n});\n\ntype InputProps = Omit<ComponentProps<'input'>, 'class' | 'className'>;\n\nexport const KeyInput = forwardRef<HTMLInputElement, InputProps>(\n  (props: InputProps, ref) => {\n    return (\n      <input\n        class={classes(\n          'transparent-caret font-inherit my-0.5 h-9 w-20 p-2 text-center text-sm',\n          'rounded-lg border border-solid border-zinc-400 bg-white dark:bg-zinc-800',\n          'border-b-[3px] border-b-zinc-500 disabled:opacity-50'\n        )}\n        ref={ref}\n        {...props}\n      />\n    );\n  }\n);\n","import { useRef } from 'preact/hooks';\n\nimport { CopyKeys, CopyNextKeyStrings } from '../common/copy-keys';\nimport { useLocale } from '../common/i18n';\nimport { PopupKeys, type StoredKeyboardKeys } from '../common/popup-keys';\nimport { classes } from '../utils/classes';\n\nimport { KeyBox, KeyCheckbox } from './KeyBox';\nimport { NewBadge } from './NewBadge';\n\nconst newKeys = ['expandPopup'];\n\ntype Props = {\n  isMac: boolean;\n  keys: StoredKeyboardKeys;\n  onUpdateKey: (key: keyof StoredKeyboardKeys, value: Array<string>) => void;\n};\n\nexport function PopupKeysForm(props: Props) {\n  const hasClipboardApi =\n    navigator.clipboard && typeof navigator.clipboard.writeText === 'function';\n\n  return (\n    <div class=\"grid-cols-keys grid items-baseline gap-x-8 gap-y-2\">\n      {PopupKeys.filter(\n        (key) => key.name !== 'startCopy' || hasClipboardApi\n      ).map((key) => (\n        <PopupKey\n          isMac={props.isMac}\n          key={key.name}\n          keys={key.keys}\n          l10nKey={key.l10nKey}\n          name={key.name}\n          onUpdate={props.onUpdateKey}\n          value={props.keys[key.name]}\n        />\n      ))}\n    </div>\n  );\n}\n\nfunction PopupKey(props: {\n  isMac: boolean;\n  keys: Array<string>;\n  l10nKey: string;\n  name: keyof StoredKeyboardKeys;\n  onUpdate: (key: keyof StoredKeyboardKeys, value: Array<string>) => void;\n  value: Array<string>;\n}) {\n  const { t } = useLocale();\n\n  const keysRef = useRef<HTMLDivElement>(null);\n\n  const onClick = () => {\n    const checkboxes = [\n      ...(keysRef.current?.querySelectorAll<HTMLInputElement>(\n        'input[type=checkbox]'\n      ) || []),\n    ];\n    const value = checkboxes\n      .filter((checkbox) => checkbox.checked)\n      .map((checkbox) => checkbox.value);\n    props.onUpdate(props.name, value);\n  };\n\n  return (\n    <>\n      <div class=\"flex flex-wrap items-baseline gap-x-2\" ref={keysRef}>\n        {props.keys.map((key, i) => {\n          const checked = props.value.includes(key);\n          const priorEnabled = props.keys\n            .slice(0, i)\n            .some((key) => props.value.includes(key));\n          const orEnabled = checked && priorEnabled;\n\n          return (\n            <>\n              {i > 0 && (\n                <span class={classes('italic', !orEnabled && 'opacity-50')}>\n                  {t('options_key_alternative')}\n                </span>\n              )}\n              <KeyCheckbox checked={checked} onClick={onClick} value={key}>\n                {props.name === 'movePopupDownOrUp' ? (\n                  (() => {\n                    const [down, up] = key.split(',', 2);\n                    return (\n                      <>\n                        <KeyBox label={down} />\n                        <span class=\"mx-2\">/</span>\n                        <KeyBox label={up} />\n                      </>\n                    );\n                  })()\n                ) : (\n                  <KeyBox label={key} isMac={props.isMac} />\n                )}\n              </KeyCheckbox>\n            </>\n          );\n        })}\n      </div>\n      <div>\n        {t(props.l10nKey)}\n        {newKeys.includes(props.name) && (\n          <NewBadge expiry={new Date('2023-10-10')} />\n        )}\n        {/* For the copy key we show the other copy-related keys as a\n            reference. */}\n        {props.name === 'startCopy' && (\n          <ul class=\"m-0 mt-4 flex list-none flex-col gap-2 p-0\">\n            {[\n              ...CopyKeys,\n              {\n                key: props.keys[0],\n                optionsString: CopyNextKeyStrings.optionsString,\n              },\n            ].map(({ key, optionsString }) => (\n              <li key={key} class=\"flex list-none items-baseline gap-3\">\n                <KeyBox label={key} />\n                {t(optionsString)}\n              </li>\n            ))}\n          </ul>\n        )}\n      </div>\n    </>\n  );\n}\n","import { useRef } from 'preact/hooks';\n\nimport { useLocale } from '../common/i18n';\n\nimport { KeyBox, KeyCheckbox } from './KeyBox';\n\nexport type HoldToShowSetting = {\n  alt: boolean;\n  ctrl: boolean;\n};\n\ntype Props = {\n  isMac: boolean;\n  holdToShowKeys: HoldToShowSetting;\n  holdToShowImageKeys: HoldToShowSetting;\n  onChangeHoldToShowKeys: (value: HoldToShowSetting) => void;\n  onChangeHoldToShowImageKeys: (value: HoldToShowSetting) => void;\n};\n\nexport function ShowPopupKeysForm(props: Props) {\n  const { t } = useLocale();\n\n  return (\n    <fieldset class=\"border border-solid border-zinc-300 px-6 py-3 dark:border-zinc-500\">\n      <p class=\"my-3 italic leading-6\">{t('options_show_popup_explanation')}</p>\n      <div class=\"grid auto-cols-max items-center gap-x-8\">\n        <div class=\"col-span-2\">{t('options_show_popup_text_subheading')}</div>\n        <KeyCheckboxes\n          isMac={props.isMac}\n          value={props.holdToShowKeys}\n          onChange={props.onChangeHoldToShowKeys}\n        />\n        <div>\n          <svg\n            viewBox=\"0 0 120 90\"\n            class=\"w-24 text-zinc-400 dark:text-zinc-300\"\n          >\n            <use href=\"#text-with-cursor\" />\n          </svg>\n        </div>\n        <div class=\"col-span-2\">\n          {t('options_show_popup_images_subheading')}\n        </div>\n        <KeyCheckboxes\n          isMac={props.isMac}\n          value={props.holdToShowImageKeys}\n          onChange={props.onChangeHoldToShowImageKeys}\n        />\n        <div>\n          <svg\n            viewBox=\"0 0 120 90\"\n            class=\"w-24 text-zinc-400 dark:text-zinc-300\"\n          >\n            <use href=\"#image-with-cursor\" />\n          </svg>\n        </div>\n      </div>\n    </fieldset>\n  );\n}\n\ntype KeyCheckboxesProps = {\n  isMac: boolean;\n  value: HoldToShowSetting;\n  onChange: (value: HoldToShowSetting) => void;\n};\n\nfunction KeyCheckboxes(props: KeyCheckboxesProps) {\n  const altRef = useRef<HTMLInputElement>(null);\n  const ctrlRef = useRef<HTMLInputElement>(null);\n  const onChange = () => {\n    props.onChange({\n      alt: altRef.current?.checked ?? false,\n      ctrl: ctrlRef.current?.checked ?? false,\n    });\n  };\n\n  return (\n    <div class=\"flex items-baseline gap-2\">\n      <KeyCheckbox checked={props.value.alt} onClick={onChange} ref={altRef}>\n        <KeyBox label=\"Alt\" isMac={props.isMac} />\n      </KeyCheckbox>\n      <span class={!props.value.alt || !props.value.ctrl ? 'opacity-50' : ''}>\n        +\n      </span>\n      <KeyCheckbox checked={props.value.ctrl} onClick={onChange} ref={ctrlRef}>\n        <KeyBox label=\"Ctrl\" isMac={props.isMac} />\n      </KeyCheckbox>\n    </div>\n  );\n}\n","const PRIMARY_MODIFIERS = ['Ctrl', 'Alt', 'MacCtrl'] as const;\n\ntype PrimaryModifier = (typeof PRIMARY_MODIFIERS)[number];\n\nconst SECONDARY_MODIFIERS = [...PRIMARY_MODIFIERS, 'Shift'] as const;\n\ntype SecondaryModifier = (typeof SECONDARY_MODIFIERS)[number];\n\n// Conversion from various input formats to standard modifier syntax.\n//\n// We use lowercase for the inputs to make it easier to do a case-insensitive\n// comparison with input from the user since at least Edge in some locales seems\n// to uppercase modifiers.\nconst MODIFIER_MAP: { [key: string]: SecondaryModifier } = {\n  ctrl: 'Ctrl',\n  command: 'Ctrl',\n  '': 'Ctrl',\n  strg: 'Ctrl',\n  alt: 'Alt',\n  '': 'Alt',\n  alternatif: 'Alt',\n  macctrl: 'MacCtrl',\n  '': 'MacCtrl',\n  shift: 'Shift',\n  '': 'Shift',\n};\n\nconst MEDIA_KEYS = [\n  'MediaNextTrack',\n  'MediaPlayPause',\n  'MediaPrevTrack',\n  'MediaStop',\n];\n\nexport type CommandParams = {\n  ctrl?: boolean;\n  alt?: boolean;\n  shift?: boolean;\n  macCtrl?: boolean;\n  key: string;\n};\n\nexport class CommandError extends Error {\n  // This is just an l10n key\n  code: string;\n  // And these are substitutions\n  substitutions: string | Array<string> | undefined;\n\n  constructor(\n    code: string,\n    substitutions?: string | Array<string> | undefined,\n    ...params: any[]\n  ) {\n    super(...params);\n    Object.setPrototypeOf(this, CommandError.prototype);\n\n    if (typeof (Error as any).captureStackTrace === 'function') {\n      (Error as any).captureStackTrace(this, CommandError);\n    }\n\n    this.name = 'CommandError';\n    this.code = code;\n    this.substitutions = substitutions;\n  }\n}\n\nexport class Command {\n  #modifier?: PrimaryModifier;\n  #secondaryModifier?: SecondaryModifier;\n  #key: string;\n\n  constructor(\n    key: string,\n    modifier?: PrimaryModifier,\n    secondaryModifier?: SecondaryModifier\n  ) {\n    this.#key = key;\n    this.#modifier = modifier;\n    this.#secondaryModifier = secondaryModifier;\n  }\n\n  static fromString(value: string): Command {\n    value = value.trim();\n\n    if (MEDIA_KEYS.includes(value)) {\n      return new Command(value);\n    }\n\n    // Normally keys take the form Alt+Ctrl+R etc. but Chrome on Mac represents\n    // the different modifiers as .\n    const parts: Array<string> = value\n      .split(/([])|\\+/)\n      .filter(Boolean)\n      .map((key) => key.trim())\n      .map((key) => MODIFIER_MAP[key.toLowerCase()] || key);\n\n    // Validate we have a suitable number of components.\n    if (!parts.length || parts.length > 3) {\n      throw new CommandError('error_command_could_not_parse', value);\n    }\n\n    // The last part is the key\n    let key = parts.pop();\n    if (!key?.length) {\n      throw new CommandError('error_command_has_no_key');\n    }\n\n    // Single character keys should be uppercase\n    if (key.length === 1) {\n      key = key.toUpperCase();\n    }\n\n    // We need at least one modifier unless the key is a function key\n    if (!isFunctionKey(key) && !parts.length) {\n      throw new CommandError('error_command_is_missing_modifier_key');\n    }\n\n    // Swap the primary and secondary modifiers if necessary\n    //\n    // We've seen this on Chrome which can produce K\n    let [primary, secondary] = parts;\n    if (\n      primary &&\n      !isPrimaryModifier(primary) &&\n      secondary &&\n      isPrimaryModifier(secondary)\n    ) {\n      [primary, secondary] = [secondary, primary];\n    }\n\n    // Now validate our modifiers\n    let modifier: PrimaryModifier | undefined;\n    if (primary) {\n      if (!isPrimaryModifier(primary)) {\n        throw new CommandError(\n          'error_command_disallowed_modifier_key',\n          primary\n        );\n      }\n\n      modifier = primary;\n    }\n\n    let secondaryModifier: SecondaryModifier | undefined;\n    if (secondary) {\n      if (!isSecondaryModifier(secondary)) {\n        throw new CommandError(\n          'error_command_disallowed_modifier_key',\n          secondary\n        );\n      }\n\n      secondaryModifier = secondary;\n    }\n\n    // There are a few other checks we _could_ do such as:\n    //\n    // - Checking that we don't have BOTH Ctrl and Command (since Ctrl maps to\n    //   Command on Macs and Command doesn't exist on other platforms).\n    // - Checking that we don't use MacCtrl or Command on non-Mac platforms.\n    //\n    // However, since we no longer sync toggle keys, they can only be set by\n    // our UI or the browser UI, presumably both of which ensure the key is\n    // valid for the above cases.\n\n    return new Command(key, modifier, secondaryModifier);\n  }\n\n  static fromParams(params: CommandParams): Command {\n    if (MEDIA_KEYS.includes(params.key)) {\n      if (params.alt || params.ctrl || params.shift) {\n        throw new CommandError('error_command_media_key_with_modifier_key');\n      }\n      return new Command(params.key);\n    }\n\n    let key = params.key.trim();\n    if (key.length === 1) {\n      key = key.toUpperCase();\n    }\n\n    if (!key.length) {\n      throw new CommandError('error_command_has_no_key');\n    }\n\n    if (!isFunctionKey(key) && !(params.alt || params.ctrl || params.macCtrl)) {\n      throw new CommandError('error_command_is_missing_modifier_key');\n    }\n\n    // Function key + Shift only is not allowed\n    if (\n      isFunctionKey(key) &&\n      params.shift &&\n      !(params.alt || params.ctrl || params.macCtrl)\n    ) {\n      throw new CommandError('error_command_disallowed_modifier_key', 'Shift');\n    }\n\n    const modifierCount = [\n      params.alt ? 1 : 0,\n      params.shift ? 1 : 0,\n      params.ctrl ? 1 : 0,\n      params.macCtrl ? 1 : 0,\n    ].reduce((value, currentValue) => currentValue + value);\n    if (modifierCount > 2) {\n      throw new CommandError('error_command_too_many_modifiers');\n    }\n\n    let modifier: PrimaryModifier | undefined;\n    if (params.alt) {\n      modifier = 'Alt';\n    } else if (params.ctrl) {\n      modifier = 'Ctrl';\n    } else if (params.macCtrl) {\n      modifier = 'MacCtrl';\n    }\n\n    let secondaryModifier: SecondaryModifier | undefined;\n    if (modifier) {\n      if (params.ctrl && modifier !== 'Ctrl') {\n        secondaryModifier = 'Ctrl';\n      } else if (params.macCtrl && modifier !== 'MacCtrl') {\n        secondaryModifier = 'MacCtrl';\n      } else if (params.shift) {\n        secondaryModifier = 'Shift';\n      }\n    }\n\n    return new Command(key, modifier, secondaryModifier);\n  }\n\n  isValid(): boolean {\n    return isValidKey(this.#key);\n  }\n\n  // This should be taken to mean \"Command\" when on Mac\n  get ctrl(): boolean {\n    return this.#modifier === 'Ctrl' || this.#secondaryModifier === 'Ctrl';\n  }\n\n  get alt(): boolean {\n    return this.#modifier === 'Alt' || this.#secondaryModifier === 'Alt';\n  }\n\n  get shift(): boolean {\n    return this.#secondaryModifier === 'Shift';\n  }\n\n  get macCtrl(): boolean {\n    return (\n      this.#modifier === 'MacCtrl' || this.#secondaryModifier === 'MacCtrl'\n    );\n  }\n\n  get key(): string {\n    return this.#key;\n  }\n\n  toString(): string {\n    const parts: Array<string> = [];\n    if (this.#modifier) {\n      parts.push(this.#modifier!);\n    }\n    if (this.#secondaryModifier) {\n      parts.push(this.#secondaryModifier!);\n    }\n    parts.push(this.#key!);\n\n    return parts.join('+');\n  }\n}\n\nfunction isPrimaryModifier(key: string): key is PrimaryModifier {\n  return PRIMARY_MODIFIERS.includes(key as PrimaryModifier);\n}\n\nfunction isSecondaryModifier(key: string): key is SecondaryModifier {\n  return SECONDARY_MODIFIERS.includes(key as PrimaryModifier);\n}\n\nconst isFunctionKey = (key: string) => /^F([1-9]|(1[0-2]))$/.test(key);\n\nconst SPECIAL_KEYS = [\n  'Comma',\n  'Period',\n  'Home',\n  'End',\n  'PageUp',\n  'PageDown',\n  'Space',\n  'Insert',\n  'Delete',\n  'Up',\n  'Down',\n  'Left',\n  'Right',\n];\n\nexport const isValidKey = (key: string): boolean =>\n  /^[A-Z0-9]$/.test(key) || isFunctionKey(key) || SPECIAL_KEYS.includes(key);\n","import type { JSX } from 'preact';\nimport { useEffect, useRef, useState } from 'preact/hooks';\n\nimport { useLocale } from '../common/i18n';\n\nimport { KeyBox, KeyCheckbox, KeyInput } from './KeyBox';\nimport { Linkify } from './Linkify';\nimport {\n  Command,\n  CommandError,\n  type CommandParams,\n  isValidKey,\n} from './commands';\n\nexport const ResetShortcut = Symbol('reset');\n\ntype Props = {\n  disabled?: 'chrome' | 'edge' | 'other';\n  isMac: boolean;\n  onChangeToggleKey: (key: Command | typeof ResetShortcut | undefined) => void;\n  toggleKey?: Command;\n};\n\nexport function ToggleKeyForm(props: Props) {\n  const { t } = useLocale();\n  const [toggleKeyError, setToggleKeyError] = useState<string | undefined>(\n    undefined\n  );\n\n  const altKeyRef = useRef<HTMLInputElement>(null);\n  const macCtrlKeyRef = useRef<HTMLInputElement>(null);\n  const ctrlKeyRef = useRef<HTMLInputElement>(null);\n  const shiftKeyRef = useRef<HTMLInputElement>(null);\n  const keyRef = useRef<HTMLInputElement>(null);\n\n  // Track the form state separately to the input toggle key because we want to\n  // allow the form state to be invalid (e.g. the user might clear one modifier\n  // before setting another meaning that the state is temporarily invalid).\n  const [formState, setFormState] = useState<CommandParams>({\n    alt: !!props?.toggleKey?.alt,\n    macCtrl: !!props?.toggleKey?.macCtrl,\n    ctrl: !!props?.toggleKey?.ctrl,\n    shift: !!props?.toggleKey?.shift,\n    key: props.toggleKey?.key || '',\n  });\n  const isEmpty =\n    !formState.alt &&\n    !formState.macCtrl &&\n    !formState.ctrl &&\n    !formState.shift &&\n    !formState.key.length;\n\n  // Any time the input toggle key changes, however, we should reset the form\n  // state to match and clear any error.\n  useEffect(() => {\n    setFormState({\n      alt: !!props?.toggleKey?.alt,\n      macCtrl: !!props?.toggleKey?.macCtrl,\n      ctrl: !!props?.toggleKey?.ctrl,\n      shift: !!props?.toggleKey?.shift,\n      key: props.toggleKey?.key || '',\n    });\n    setToggleKeyError(undefined);\n  }, [props.toggleKey]);\n\n  const onToggleKeyChange = () => {\n    const params: CommandParams = {\n      alt: altKeyRef.current?.checked,\n      ctrl: ctrlKeyRef.current?.checked,\n      macCtrl: macCtrlKeyRef.current?.checked,\n      shift: shiftKeyRef.current?.checked,\n      key: keyRef.current?.value || '',\n    };\n    setFormState(params);\n\n    try {\n      const command = Command.fromParams(params);\n      if (!command.isValid()) {\n        setToggleKeyError(t('error_command_key_is_not_allowed', command.key));\n        return;\n      }\n\n      props.onChangeToggleKey(command);\n      setToggleKeyError(undefined);\n    } catch (e) {\n      setToggleKeyError(\n        e instanceof CommandError\n          ? t(e.code, e.substitutions)\n          : e.message || String(e)\n      );\n    }\n  };\n\n  const onToggleKeyDown = (e: JSX.TargetedKeyboardEvent<HTMLInputElement>) => {\n    let key = e.key;\n\n    // Translate single letter keys to uppercase.\n    if (e.key.length === 1) {\n      key = key.toUpperCase();\n    }\n\n    // For keys like , or . we want to use event.code instead.\n    key = isValidKey(e.code) ? e.code : key;\n\n    // For the arrow keys we need to translate ArrowLeft to Left etc.\n    if (key.startsWith('Arrow')) {\n      key = key.slice('Arrow'.length);\n    }\n\n    if (!isValidKey(key)) {\n      // Most printable keys are one character in length so make sure we don't\n      // allow the default action of adding them to the text input. For other\n      // keys we don't handle though (e.g. Tab) we probably want to allow the\n      // default action (except Backspace).\n      if (e.key.length === 1 || e.key === 'Backspace') {\n        e.preventDefault();\n      }\n      return;\n    }\n\n    e.currentTarget.value = key;\n    e.preventDefault();\n\n    onToggleKeyChange();\n  };\n\n  return (\n    <>\n      <div class=\"flex flex-row-reverse flex-wrap items-center justify-end gap-x-6 gap-y-2\">\n        <div class=\"flex grow flex-wrap gap-x-6\">\n          <div class=\"w-min grow\">\n            {t('command_toggle_description')}\n            {!!toggleKeyError?.length && (\n              <div\n                class=\"bg-warning-red ml-2 inline-block size-6 bg-cover bg-no-repeat align-top\"\n                id=\"toggle-key-icon\"\n                title={toggleKeyError}\n              />\n            )}\n          </div>\n          {!props.disabled && (\n            <div>\n              <button\n                class=\"cursor-pointer appearance-none rounded-md border-none bg-transparent p-0.5 text-zinc-500 hover:bg-zinc-100 hover:text-zinc-600 dark:text-zinc-400 dark:hover:bg-zinc-700 dark:hover:text-zinc-300\"\n                disabled={!!props.disabled}\n                title={\n                  isEmpty\n                    ? t('options_restore_toggle_shortcut')\n                    : t('options_disable_toggle_shortcut')\n                }\n                type=\"button\"\n                onClick={() => {\n                  props.onChangeToggleKey(isEmpty ? ResetShortcut : undefined);\n                  setToggleKeyError(undefined);\n                }}\n              >\n                {isEmpty ? (\n                  <svg class=\"block size-5 fill-current\" viewBox=\"0 0 16 16\">\n                    <path d=\"M8.54,2.11l.66-.65A.78.78,0,0,0,9.2.38a.76.76,0,0,0-1.08,0L6.19,2.31A.81.81,0,0,0,6,2.55a.8.8,0,0,0-.06.3A.72.72,0,0,0,6,3.14a.74.74,0,0,0,.17.25L8.12,5.32a.73.73,0,0,0,.54.22.76.76,0,0,0,.54-.22.78.78,0,0,0,0-1.08l-.58-.58A4.38,4.38,0,1,1,3.68,8.82a.76.76,0,0,0-1.5.28,5.92,5.92,0,1,0,6.36-7Z\" />\n                    <circle cx={2.673} cy={6.71} r={0.965} />\n                  </svg>\n                ) : (\n                  <svg class=\"block size-5\" viewBox=\"0 0 24 24\">\n                    <path\n                      d=\"M6 18L18 6M6 6l12 12\"\n                      stroke=\"currentColor\"\n                      strokeWidth={3}\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                    />\n                  </svg>\n                )}\n              </button>\n            </div>\n          )}\n        </div>\n        <div class=\"flex flex-wrap gap-2\">\n          <KeyCheckbox\n            checked={formState.alt}\n            disabled={!!props.disabled}\n            onClick={onToggleKeyChange}\n            ref={altKeyRef}\n          >\n            <KeyBox label=\"Alt\" isMac={props.isMac} />\n            <span class=\"ml-2\">+</span>\n          </KeyCheckbox>\n          {props.isMac && (\n            <KeyCheckbox\n              checked={formState.macCtrl}\n              disabled={!!props.disabled}\n              onClick={onToggleKeyChange}\n              ref={macCtrlKeyRef}\n            >\n              <KeyBox label=\"Ctrl\" isMac={props.isMac} />\n              <span class=\"ml-2\">+</span>\n            </KeyCheckbox>\n          )}\n          <KeyCheckbox\n            checked={formState.ctrl}\n            disabled={!!props.disabled}\n            onClick={onToggleKeyChange}\n            ref={ctrlKeyRef}\n          >\n            <KeyBox\n              // A few notes about modifier keys on Mac\n              //\n              // In DOM, `ctrlKey` corresponds to \"Control\" on Mac (and \"Ctrl\"\n              // on PC).\n              // `metaKey` represents the \"Command\" () key.\n              // Ref: https://w3c.github.io/uievents/#dom-keyboardevent-ctrlkey\n              //\n              // In Web extension command shortcuts, \"Ctrl\" is mapped to\n              // \"Command\".\n              // `macCtrl` is used for \"Control\".\n              // Ref: https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/manifest.json/commands#key_combinations\n              //\n              // This deviation probably makes sense in the context of\n              // specifying a cross-platform keyboard shortcut because if your\n              // shortcut is Ctrl+R on Windows it would most naturally be +R\n              // on Mac.\n              //\n              // Now, for the shortcut keys _we_ handle (i.e. the popup shortcut\n              // keys) we use DOM conventions. That is, we pass \"Ctrl\" to the\n              // content script and have it check if `ctrlKey` is true.\n              //\n              // As a result, when we describe these keys to the user, they\n              // should show \"Control\", and that's what KeyBox does when it sees\n              // a label of \"Ctrl\".\n              //\n              // However, for the special case of the toggle key, the \"Ctrl\" we\n              // get from the manifest/browser etc. should be shown as \"Command\".\n              label={props.isMac ? 'Command' : 'Ctrl'}\n              isMac={props.isMac}\n            />\n            <span class=\"ml-2\">+</span>\n          </KeyCheckbox>\n          <KeyCheckbox\n            checked={formState.shift}\n            disabled={!!props.disabled}\n            onClick={onToggleKeyChange}\n            ref={shiftKeyRef}\n          >\n            <KeyBox label=\"Shift\" isMac={props.isMac} />\n            <span class=\"ml-2\">+</span>\n          </KeyCheckbox>\n          <KeyInput\n            disabled={!!props.disabled}\n            onKeyDown={onToggleKeyDown}\n            onCompositionStart={(\n              event: JSX.TargetedEvent<HTMLInputElement>\n            ) => {\n              event.currentTarget.value = '';\n            }}\n            onCompositionEnd={(event: JSX.TargetedEvent<HTMLInputElement>) => {\n              event.currentTarget.value =\n                event.currentTarget.value.toUpperCase();\n              onToggleKeyChange();\n            }}\n            ref={keyRef}\n            size={1}\n            type=\"text\"\n            value={formState.key || ''}\n          />\n        </div>\n      </div>\n      {!!props.disabled && (\n        <div\n          class=\"my-2 rounded-lg border border-solid border-zinc-500 px-4 py-2\"\n          onClick={handleChromeLinks}\n        >\n          <Linkify\n            text={t(\n              props.disabled === 'chrome'\n                ? 'options_browser_commands_no_toggle_key_chrome'\n                : props.disabled === 'edge'\n                  ? 'options_browser_commands_no_toggle_key_edge'\n                  : 'options_browser_commands_no_toggle_key'\n            )}\n            links={[\n              {\n                keyword: 'chrome://extensions/shortcuts',\n                href: 'chrome://extensions/shortcuts',\n              },\n              {\n                keyword: 'edge://extensions/shortcuts',\n                href: 'edge://extensions/shortcuts',\n              },\n            ]}\n          />\n        </div>\n      )}\n    </>\n  );\n}\n\ndeclare const chrome: any;\n\nfunction handleChromeLinks(e: MouseEvent) {\n  if (\n    e.target instanceof HTMLAnchorElement &&\n    (e.target.href.startsWith('chrome://') ||\n      e.target.href.startsWith('edge://'))\n  ) {\n    chrome.tabs.create({ url: e.target.href });\n    e.preventDefault();\n  }\n}\n","import { useLocale } from '../common/i18n';\nimport { StoredKeyboardKeys } from '../common/popup-keys';\n\nimport { PopupKeysForm } from './PopupKeysForm';\nimport { type HoldToShowSetting, ShowPopupKeysForm } from './ShowPopupKeysForm';\nimport { ResetShortcut, ToggleKeyForm } from './ToggleKeyForm';\nimport type { Command } from './commands';\n\ntype Props = {\n  holdToShowImageKeys: HoldToShowSetting;\n  holdToShowKeys: HoldToShowSetting;\n  isMac: boolean;\n  onChangeHoldToShowImageKeys: (value: HoldToShowSetting) => void;\n  onChangeHoldToShowKeys: (value: HoldToShowSetting) => void;\n  onChangeToggleKey: (key: Command | typeof ResetShortcut | undefined) => void;\n  onUpdatePopupKey: (\n    name: keyof StoredKeyboardKeys,\n    keys: Array<string>\n  ) => void;\n  popupKeys: StoredKeyboardKeys;\n  toggleKey?: Command;\n  toggleKeyDisabled?: 'chrome' | 'edge' | 'other';\n};\n\nexport function KeyboardSettingsForm(props: Props) {\n  const { t } = useLocale();\n\n  return (\n    <>\n      <ToggleKeyForm\n        disabled={props.toggleKeyDisabled}\n        isMac={props.isMac}\n        onChangeToggleKey={props.onChangeToggleKey}\n        toggleKey={props.toggleKey}\n      />\n      <p>{t('options_show_popup_subheading')}</p>\n      <ShowPopupKeysForm\n        holdToShowImageKeys={props.holdToShowImageKeys}\n        holdToShowKeys={props.holdToShowKeys}\n        isMac={props.isMac}\n        onChangeHoldToShowImageKeys={props.onChangeHoldToShowImageKeys}\n        onChangeHoldToShowKeys={props.onChangeHoldToShowKeys}\n      />\n      <p>{t('options_popup_keys_subheading')}</p>\n      <PopupKeysForm\n        isMac={props.isMac}\n        keys={props.popupKeys}\n        onUpdateKey={props.onUpdatePopupKey}\n      />\n    </>\n  );\n}\n","import Bugsnag from '@birchill/bugsnag-zero';\nimport { useCallback, useEffect, useMemo, useState } from 'preact/hooks';\nimport browser, { type Commands } from 'webextension-polyfill';\n\nimport type { Config } from '../common/config';\nimport { useLocale } from '../common/i18n';\nimport { StoredKeyboardKeys } from '../common/popup-keys';\nimport { isChromium, isEdge, isMac, isSafari } from '../utils/ua-utils';\n\nimport { KeyboardSettingsForm } from './KeyboardSettingsForm';\nimport { SectionHeading } from './SectionHeading';\nimport type { HoldToShowSetting } from './ShowPopupKeysForm';\nimport { ResetShortcut } from './ToggleKeyForm';\nimport { Command, CommandError } from './commands';\nimport { useConfigValue } from './use-config-value';\n\nconst mac = isMac();\n\ntype CommandChangeCallback = Parameters<\n  Commands.Static['onChanged']['addListener']\n>[0];\n\nexport function KeyboardSettings(props: { config: Config }) {\n  const { t } = useLocale();\n\n  //\n  // Toggle key\n  //\n\n  const [toggleKey, setToggleKey] = useState<Command | undefined>(undefined);\n\n  // Fetch the current toggle key when the component mounts and set up a\n  // listener to update the toggle key when it changes.\n  useEffect(() => {\n    void getToggleKey().then((toggleKey) => setToggleKey(toggleKey));\n\n    if (!browser.commands || typeof browser.commands.onChanged !== 'object') {\n      return;\n    }\n\n    const listener: CommandChangeCallback = (changeInfo) => {\n      if (\n        changeInfo.name !==\n        (__MV3__ ? '_execute_action' : '_execute_browser_action')\n      ) {\n        return;\n      }\n\n      try {\n        setToggleKey(\n          changeInfo.newShortcut\n            ? Command.fromString(changeInfo.newShortcut)\n            : undefined\n        );\n      } catch (e) {\n        console.error(`Failed to parse key: ${changeInfo.newShortcut}`);\n        const error =\n          e instanceof CommandError\n            ? browser.i18n.getMessage(e.code, e.substitutions)\n            : e;\n        void Bugsnag.notify(error);\n      }\n    };\n\n    browser.commands.onChanged.addListener(listener);\n\n    return () => {\n      browser.commands.onChanged.removeListener(listener);\n    };\n  }, []);\n\n  const onChangeToggleKey = (\n    key: Command | typeof ResetShortcut | undefined\n  ) => {\n    void (async () => {\n      try {\n        if (key === ResetShortcut) {\n          await browser.commands.reset(\n            __MV3__ ? '_execute_action' : '_execute_browser_action'\n          );\n          setToggleKey(await getToggleKey());\n        } else {\n          await browser.commands.update({\n            name: __MV3__ ? '_execute_action' : '_execute_browser_action',\n            shortcut: key ? key.toString() : '',\n          });\n          setToggleKey(key);\n        }\n      } catch (e) {\n        console.error(`Failed to set toggle key to ${key?.toString()}`, e);\n        void Bugsnag.notify(e);\n\n        // Set the key back to its previous value\n        setToggleKey(await getToggleKey());\n      }\n    })();\n  };\n\n  const [toggleKeyDisabled] = useState<undefined | 'chrome' | 'edge' | 'other'>(\n    () => {\n      // Disable any controls associated with configuring browser.commands if the\n      // necessary APIs are not available.\n      const canConfigureCommands =\n        browser.commands &&\n        typeof browser.commands.update === 'function' &&\n        typeof browser.commands.reset === 'function';\n\n      if (canConfigureCommands) {\n        return undefined;\n      }\n\n      if (isEdge()) {\n        return 'edge';\n      }\n\n      if (isChromium()) {\n        return 'chrome';\n      }\n\n      return 'other';\n    }\n  );\n\n  //\n  // Hold-to-show keys\n  //\n\n  const [holdToShowKeys, setHoldToShowKeys] = useHoldToShowKeysSetting(\n    props.config,\n    'holdToShowKeys'\n  );\n  const [holdToShowImageKeys, setHoldToShowImageKeys] =\n    useHoldToShowKeysSetting(props.config, 'holdToShowImageKeys');\n\n  //\n  // Popup keys\n  //\n\n  const popupKeys = useConfigValue(props.config, 'keys');\n  const onUpdatePopupKey = useCallback(\n    (key: keyof StoredKeyboardKeys, value: Array<string>) => {\n      props.config.updateKeys({ [key]: value });\n    },\n    [props.config]\n  );\n\n  return (\n    <>\n      <SectionHeading>{t('options_keyboard_heading')}</SectionHeading>\n      <div class=\"py-4\">\n        <KeyboardSettingsForm\n          holdToShowKeys={holdToShowKeys}\n          holdToShowImageKeys={holdToShowImageKeys}\n          isMac={mac}\n          toggleKey={toggleKey}\n          toggleKeyDisabled={toggleKeyDisabled}\n          onChangeToggleKey={onChangeToggleKey}\n          onChangeHoldToShowKeys={setHoldToShowKeys}\n          onChangeHoldToShowImageKeys={setHoldToShowImageKeys}\n          onUpdatePopupKey={onUpdatePopupKey}\n          popupKeys={popupKeys}\n        />\n      </div>\n    </>\n  );\n}\n\nasync function getToggleKey(): Promise<Command | undefined> {\n  // Firefox for Android does not support the browser.commands API at all\n  // but probably not many people want to use keyboard shortcuts on Android\n  // anyway so we can just return null from here in that case.\n  if (!browser.commands) {\n    return undefined;\n  }\n\n  const commands = await browser.commands.getAll();\n\n  // Safari (14.1.1) has a very broken implementation of\n  // chrome.commands.getAll(). It returns an object but it has no properties\n  // and is not iterable.\n  //\n  // There's not much we can do in that case so we just hard code the default\n  // key since Safari also has no way of changing shortcut keys. Hopefully\n  // Safari will fix chrome.commands.getAll() before or at the same time it\n  // provides a way of re-assigning shortcut keys.\n  //\n  // (See notes below for more recent versions of Safari.)\n  if (\n    typeof commands === 'object' &&\n    typeof commands[Symbol.iterator] !== 'function'\n  ) {\n    return new Command('R', 'MacCtrl', 'Ctrl');\n  }\n\n  for (const command of commands) {\n    if (\n      command.name ===\n        (__MV3__ ? '_execute_action' : '_execute_browser_action') &&\n      command.shortcut\n    ) {\n      try {\n        return Command.fromString(command.shortcut);\n      } catch (e) {\n        console.error(`Failed to parse key: ${command.shortcut}`);\n        const error =\n          e instanceof CommandError\n            ? browser.i18n.getMessage(e.code, e.substitutions)\n            : e;\n        void Bugsnag.notify(error);\n      }\n    }\n  }\n\n  // In Safari 17.1, getAll returns an array of opaque WBSWebExtensionCommand\n  // objects.\n  //\n  // Again, just return the hard-coded default key in this case.\n  if (isSafari()) {\n    return new Command('R', 'MacCtrl', 'Ctrl');\n  }\n\n  return undefined;\n}\n\nfunction useHoldToShowKeysSetting(\n  config: Config,\n  key: 'holdToShowKeys' | 'holdToShowImageKeys'\n): [HoldToShowSetting, (value: HoldToShowSetting) => void] {\n  const value = useConfigValue(config, key);\n\n  const setting = useMemo(() => {\n    const parts: Array<string> =\n      typeof value === 'string'\n        ? value.split('+').map((part) => part.trim().toLowerCase())\n        : [];\n    return {\n      ctrl: parts.includes('ctrl'),\n      alt: parts.includes('alt'),\n    };\n  }, [value]);\n\n  const setValue = useCallback(\n    (value: HoldToShowSetting) => {\n      const parts = [];\n      if (value.ctrl) {\n        parts.push('Ctrl');\n      }\n      if (value.alt) {\n        parts.push('Alt');\n      }\n      config[key] = parts.length ? parts.join('+') : null;\n    },\n    [config, key]\n  );\n\n  return [setting, setValue];\n}\n","import { useEffect, useMemo, useState } from 'preact/hooks';\n\nexport function useHasMouse(): boolean {\n  const mql = useMemo(\n    () => window.matchMedia('(any-hover:hover), (any-pointer:fine)'),\n    []\n  );\n  const [hasMouse, setHasMouse] = useState(mql.matches);\n\n  useEffect(() => {\n    const onMqlChange = (evt: MediaQueryListEvent) => {\n      setHasMouse(evt.matches);\n    };\n\n    mql.addEventListener('change', onMqlChange);\n    return () => {\n      mql.removeEventListener('change', onMqlChange);\n    };\n  }, []);\n\n  return hasMouse;\n}\n","import { useEffect, useMemo, useState } from 'preact/hooks';\n\nimport { isTouchDevice } from './device';\n\nexport function useHasTouch(): boolean {\n  const mql = useMemo(() => window.matchMedia('(any-pointer:coarse)'), []);\n  const [hasCoarsePointer, setHasCoarsePointer] = useState(mql.matches);\n\n  useEffect(() => {\n    const onMqlChange = (evt: MediaQueryListEvent) => {\n      setHasCoarsePointer(evt.matches);\n    };\n\n    mql.addEventListener('change', onMqlChange);\n    return () => {\n      mql.removeEventListener('change', onMqlChange);\n    };\n  }, []);\n\n  return useMemo(() => isTouchDevice(), [hasCoarsePointer]);\n}\n","export function getThemeClass(theme: string): string {\n  if (theme !== 'default') {\n    return `theme-${theme}`;\n  }\n\n  // It is up to the call site to register for media query updates if they\n  // need to respond to dark mode changes. Generally, e.g. for popups etc.,\n  // however, the usage of this value is short-lived enough that it's not\n  // needed.\n  if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\n    return 'theme-black';\n  }\n\n  return 'theme-light';\n}\n","import { useEffect, useMemo, useState } from 'preact/hooks';\n\nimport { getThemeClass } from './themes';\n\nexport function useThemeClass(theme: string): string {\n  const [darkMode, setDarkMode] = useState(false);\n\n  // Only register for dark mode changes if the theme is the default one.\n  useEffect(() => {\n    if (theme !== 'default') {\n      return;\n    }\n\n    const onMqlChange = (evt: MediaQueryListEvent) => {\n      setDarkMode(evt.matches);\n    };\n\n    const mql = window.matchMedia('(prefers-color-scheme: dark)');\n    mql.addEventListener('change', onMqlChange);\n    setDarkMode(mql.matches);\n\n    return () => {\n      mql.removeEventListener('change', onMqlChange);\n    };\n  }, [theme]);\n\n  return useMemo(() => getThemeClass(theme), [darkMode, theme]);\n}\n","import { useLocale } from '../common/i18n';\nimport { useThemeClass } from '../utils/use-theme-class';\n\nimport { IconRadio } from './IconRadio';\n\ntype Props = {\n  onChange: (enabled: boolean) => void;\n  theme: string;\n  value: boolean;\n};\n\nexport function MouseInteractivityRadio(props: Props) {\n  const { t } = useLocale();\n  const themeClass = useThemeClass(props.theme);\n\n  return (\n    <div class=\"grid w-max grid-cols-1 gap-2 min-[400px]:grid-cols-2\">\n      <IconRadio\n        checked={!props.value}\n        label={t('options_mouse_interactivity_disable')}\n        name=\"mouseInteractivity\"\n        onChange={() => props.onChange(false)}\n        value=\"disable\"\n      >\n        <div class=\"flex items-center justify-center px-4 py-3\">\n          <svg\n            class={`${themeClass} w-[150px] select-none drop-shadow-[0_1px_1px_rgba(0,0,0,0.25)]`}\n            viewBox=\"0 0 200 150\"\n          >\n            <use href=\"#interactivity-disabled-popup\" />\n          </svg>\n        </div>\n      </IconRadio>\n      <IconRadio\n        checked={props.value}\n        label={t('options_mouse_interactivity_enable')}\n        name=\"mouseInteractivity\"\n        onChange={() => props.onChange(true)}\n        value=\"enable\"\n      >\n        <div class=\"flex items-center justify-center px-4 py-3\">\n          <svg\n            class={`${themeClass} w-[150px] select-none drop-shadow-[0_1px_1px_rgba(0,0,0,0.25)]`}\n            viewBox=\"0 0 200 150\"\n          >\n            <use href=\"#interactivity-enabled-popup\" />\n          </svg>\n        </div>\n      </IconRadio>\n    </div>\n  );\n}\n","import type { RenderableProps } from 'preact';\n\nimport { TabDisplay } from '../common/content-config-params';\nimport { useLocale } from '../common/i18n';\nimport { useThemeClass } from '../utils/use-theme-class';\n\nimport { IconRadio } from './IconRadio';\n\ntype Props = {\n  onChange: (value: TabDisplay) => void;\n  theme: string;\n  value: TabDisplay;\n};\n\nexport function TabDisplayRadio(props: Props) {\n  const { t } = useLocale();\n  const themeClass = useThemeClass(props.theme);\n\n  return (\n    <>\n      {/* SVG defs */}\n      <svg class=\"sr-only\" role=\"presentation\">\n        <defs>\n          <clipPath id=\"popup-outline\">\n            <rect x=\"1\" y=\"1\" rx=\"5\" width=\"46\" height=\"46\" />\n          </clipPath>\n          <rect id=\"tabicon-popup\" x=\"1\" y=\"1\" rx=\"5\" width=\"46\" height=\"46\" />\n        </defs>\n      </svg>\n      <div class=\"grid w-max grid-cols-[repeat(1,80px)] gap-2 min-[300px]:grid-cols-[repeat(2,100px)] min-[440px]:grid-cols-[repeat(4,100px)] min-[600px]:grid-cols-[repeat(4,120px)]\">\n        <IconRadio\n          checked={props.value === 'top'}\n          label={t('options_tab_position_top')}\n          name=\"tabDisplay\"\n          onChange={() => props.onChange('top')}\n          value=\"top\"\n        >\n          <PopupIconBase themeClass={themeClass}>\n            <rect\n              class=\"fill-[--cell-highlight-bg] stroke-[--border-color] stroke-[0.5px]\"\n              clipPath=\"url(#popup-outline)\"\n              x=\"16\"\n              y=\"1\"\n              width=\"32\"\n              height=\"8\"\n            />\n          </PopupIconBase>\n        </IconRadio>\n        <IconRadio\n          checked={props.value === 'left'}\n          label={t('options_tab_position_left')}\n          name=\"tabDisplay\"\n          onChange={() => props.onChange('left')}\n          value=\"left\"\n        >\n          <PopupIconBase themeClass={themeClass}>\n            <rect\n              class=\"fill-[--cell-highlight-bg] stroke-[--border-color] stroke-[0.5px]\"\n              clipPath=\"url(#popup-outline)\"\n              x=\"0\"\n              y=\"8\"\n              width=\"8\"\n              height=\"40\"\n            />\n          </PopupIconBase>\n        </IconRadio>\n        <IconRadio\n          checked={props.value === 'right'}\n          label={t('options_tab_position_right')}\n          name=\"tabDisplay\"\n          onChange={() => props.onChange('right')}\n          value=\"right\"\n        >\n          <PopupIconBase themeClass={themeClass}>\n            <rect\n              class=\"fill-[--cell-highlight-bg] stroke-[--border-color] stroke-[0.5px]\"\n              clipPath=\"url(#popup-outline)\"\n              x=\"40\"\n              y=\"8\"\n              width=\"8\"\n              height=\"40\"\n            />\n          </PopupIconBase>\n        </IconRadio>\n        <IconRadio\n          checked={props.value === 'none'}\n          label={t('options_tab_position_none')}\n          name=\"tabDisplay\"\n          onChange={() => props.onChange('none')}\n          value=\"none\"\n        >\n          <PopupIconBase themeClass={themeClass} />\n        </IconRadio>\n      </div>\n    </>\n  );\n}\n\ntype IconProps = {\n  themeClass: string;\n};\n\nfunction PopupIconBase(props: RenderableProps<IconProps>) {\n  return (\n    <div class=\"flex items-center justify-center px-4 py-3\">\n      <svg\n        class={`${props.themeClass} size-12 drop-shadow-[0_1px_1px_rgba(0,0,0,0.25)]`}\n        viewBox=\"0 0 48 48\"\n      >\n        <use\n          class=\"fill-[--bg-color] stroke-[--border-color] stroke-[0.5px]\"\n          href=\"#tabicon-popup\"\n        />\n        {props.children}\n      </svg>\n    </div>\n  );\n}\n","import type { JSX } from 'preact';\n\nimport { TabDisplay } from '../common/content-config-params';\nimport { useLocale } from '../common/i18n';\n\nimport { CheckboxRow } from './CheckboxRow';\nimport { MouseInteractivityRadio } from './MouseInteractivityRadio';\nimport { TabDisplayRadio } from './TabDisplayRadio';\n\ntype Props = {\n  enableTapLookup: boolean;\n  hasMouse: boolean;\n  hasTouch: boolean;\n  mouseInteractivity: boolean;\n  onChangeEnableTapLookup: (value: boolean) => void;\n  onChangeMouseInteractivity: (value: boolean) => void;\n  onChangeTabDisplay: (value: TabDisplay) => void;\n  tabDisplay: TabDisplay;\n  theme: string;\n};\n\nexport function PopupInteractivitySettingsForm(props: Props) {\n  const { t } = useLocale();\n\n  return (\n    <div class=\"flex flex-col gap-4\">\n      {props.hasMouse && (\n        <div class=\"flex flex-col gap-4\">\n          <p class=\"m-0\">{t('options_mouse_interactivity_label')}</p>\n          <MouseInteractivityRadio\n            onChange={props.onChangeMouseInteractivity}\n            theme={props.theme}\n            value={props.mouseInteractivity}\n          />\n        </div>\n      )}\n      {props.hasTouch && (\n        <div class=\"my-1\">\n          <CheckboxRow>\n            <input\n              checked={props.enableTapLookup}\n              id=\"enableTapLookup\"\n              name=\"enableTapLookup\"\n              onClick={(event: JSX.TargetedEvent<HTMLInputElement>) => {\n                props.onChangeEnableTapLookup(event.currentTarget.checked);\n              }}\n              type=\"checkbox\"\n            />\n            <label class=\"cursor-pointer select-none\" for=\"enableTapLookup\">\n              {t('options_touch_enable_tap_lookup')}\n            </label>\n          </CheckboxRow>\n        </div>\n      )}\n      <div class=\"flex flex-col gap-4\">\n        <p class=\"m-0\">{t('options_tab_position_label')}</p>\n        <TabDisplayRadio\n          onChange={props.onChangeTabDisplay}\n          theme={props.theme}\n          value={props.tabDisplay}\n        />\n      </div>\n    </div>\n  );\n}\n","import { useCallback } from 'preact/hooks';\n\nimport type { Config } from '../common/config';\nimport { TabDisplay } from '../common/content-config-params';\nimport { useLocale } from '../common/i18n';\nimport { useHasMouse } from '../utils/use-has-mouse';\nimport { useHasTouch } from '../utils/use-has-touch';\n\nimport { PopupInteractivitySettingsForm } from './PopupInteractivitySettingsForm';\nimport { SectionHeading } from './SectionHeading';\nimport { useConfigValue } from './use-config-value';\n\ntype Props = {\n  config: Config;\n};\n\nexport function PopupInteractivitySettings(props: Props) {\n  const { t } = useLocale();\n  const hasMouse = useHasMouse();\n  const hasTouch = useHasTouch();\n  const theme = useConfigValue(props.config, 'popupStyle');\n\n  const mouseInteractivity = useConfigValue(props.config, 'popupInteractive');\n  const onChangeMouseInteractivity = useCallback(\n    (value: boolean) => {\n      props.config.popupInteractive = value;\n    },\n    [props.config]\n  );\n\n  const enableTapLookup = useConfigValue(props.config, 'enableTapLookup');\n  const onChangeEnableTapLookup = useCallback(\n    (value: boolean) => {\n      props.config.enableTapLookup = value;\n    },\n    [props.config]\n  );\n\n  const tabDisplay = useConfigValue(props.config, 'tabDisplay');\n  const onChangeTabDisplay = useCallback(\n    (value: TabDisplay) => {\n      props.config.tabDisplay = value;\n    },\n    [props.config]\n  );\n\n  return (\n    <>\n      <SectionHeading>\n        {t('options_popup_interactivity_heading')}\n      </SectionHeading>\n      <div class=\"py-4\">\n        <PopupInteractivitySettingsForm\n          enableTapLookup={enableTapLookup}\n          hasMouse={hasMouse}\n          hasTouch={hasTouch}\n          mouseInteractivity={mouseInteractivity}\n          onChangeEnableTapLookup={onChangeEnableTapLookup}\n          onChangeMouseInteractivity={onChangeMouseInteractivity}\n          onChangeTabDisplay={onChangeTabDisplay}\n          tabDisplay={tabDisplay}\n          theme={theme}\n        />\n      </div>\n    </>\n  );\n}\n","import type { ComponentProps } from 'preact';\nimport { forwardRef } from 'preact/compat';\nimport { useId } from 'preact/hooks';\n\nimport type {\n  AccentDisplay,\n  FontFace,\n  FontSize,\n  PartOfSpeechDisplay,\n} from '../common/content-config-params';\nimport { useLocale } from '../common/i18n';\nimport { classes } from '../utils/classes';\nimport { useThemeClass } from '../utils/use-theme-class';\n\ntype Props = {\n  accentDisplay: AccentDisplay;\n  fontFace: FontFace;\n  fontSize: FontSize;\n  onChangeTheme: (theme: string) => void;\n  posDisplay: PartOfSpeechDisplay;\n  showBunproDecks: boolean;\n  showDefinitions: boolean;\n  showPriority: boolean;\n  showRomaji: boolean;\n  showWaniKaniLevel: boolean;\n  theme: string;\n};\n\nexport function PopupThemeRadio(props: Props) {\n  return (\n    <div class=\"grid grid-cols-1 sm:grid-cols-2\">\n      {['default', 'light', 'blue', 'lightblue', 'black', 'yellow'].map(\n        (theme) => (\n          <PopupRadio\n            key={theme}\n            name=\"popupStyle\"\n            value={theme}\n            checked={props.theme === theme}\n            onChange={() => props.onChangeTheme(theme)}\n          >\n            {theme === 'default' ? (\n              <div class=\"stacked\">\n                <PopupPreview {...props} theme=\"light\" />\n                <div class=\"cover-tl flex\">\n                  <PopupPreview {...props} theme=\"black\" />\n                </div>\n              </div>\n            ) : (\n              <PopupPreview {...props} theme={theme} />\n            )}\n          </PopupRadio>\n        )\n      )}\n    </div>\n  );\n}\n\ntype InputProps = Omit<\n  ComponentProps<'input'>,\n  'id' | 'type' | 'class' | 'className'\n>;\n\nconst PopupRadio = forwardRef<HTMLInputElement, InputProps>(\n  (props: InputProps, ref) => {\n    const id = useId();\n\n    return (\n      <div>\n        <input\n          ref={ref}\n          id={id}\n          type=\"radio\"\n          class=\"peer sr-only\"\n          {...{ ...props, children: undefined }}\n        />\n        <label\n          class={classes(\n            'peer-focus-visible:outline-auto group block cursor-pointer rounded-md border border-solid p-2',\n            'border-transparent text-center transition duration-300',\n            props.checked\n              ? 'border-zinc-300 bg-zinc-200 dark:border-zinc-500 dark:bg-zinc-600'\n              : 'opacity-50 hover:opacity-100 active:opacity-100'\n          )}\n          for={id}\n        >\n          {props.children}\n        </label>\n      </div>\n    );\n  }\n);\n\ntype PopupPreviewProps = {\n  accentDisplay: AccentDisplay;\n  fontFace: FontFace;\n  fontSize: FontSize;\n  posDisplay: PartOfSpeechDisplay;\n  showBunproDecks: boolean;\n  showDefinitions: boolean;\n  showPriority: boolean;\n  showWaniKaniLevel: boolean;\n  showRomaji: boolean;\n  theme: string;\n};\n\nfunction PopupPreview(props: PopupPreviewProps) {\n  const { t } = useLocale();\n  const themeClass = useThemeClass(props.theme);\n\n  return (\n    <div\n      class={classes(\n        themeClass,\n        'window inline-block min-w-[180px] py-2 text-left',\n        props.fontFace === 'bundled' && 'bundled-fonts',\n        props.fontSize !== 'normal' && `font-${props.fontSize}`\n      )}\n    >\n      <div class=\"entry\">\n        <div>\n          <span class=\"w-kanji\">\n            \n            {props.showPriority && <Star />}\n            {props.showWaniKaniLevel && (\n              <span class=\"wk-level\">\n                <span>21</span>\n              </span>\n            )}\n            {props.showBunproDecks && (\n              <span class=\"bp-tag -vocab\">\n                <span>{t('popup_bp_vocab_tag', ['3'])}</span>\n              </span>\n            )}\n          </span>\n          <span class=\"w-kana\">\n            {renderKana(props.accentDisplay)}\n            {props.showPriority && <Star />}\n          </span>\n          {props.showRomaji && (\n            <span class=\"w-romaji\" lang=\"ja\">\n              rikai\n            </span>\n          )}\n        </div>\n        {props.showDefinitions && (\n          <span class=\"w-def\" lang=\"en\">\n            {renderPos(props.posDisplay)}\n            {'\\u200bunderstanding'}\n          </span>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction Star() {\n  return (\n    <svg class=\"svgicon opacity-50\" viewBox=\"0 0 98.6 93.2\">\n      <path d=\"M98 34a4 4 0 00-3-1l-30-4L53 2a4 4 0 00-7 0L33 29 4 33a4 4 0 00-3 6l22 20-6 29a4 4 0 004 5 4 4 0 002 0l26-15 26 15a4 4 0 002 0 4 4 0 004-4 4 4 0 000-1l-6-29 22-20a4 4 0 001-5z\" />\n    </svg>\n  );\n}\n\nfunction renderKana(accentDisplay: AccentDisplay) {\n  switch (accentDisplay) {\n    case 'downstep':\n      return '';\n\n    case 'binary':\n    case 'binary-hi-contrast':\n      return (\n        <span\n          class={classes(\n            'w-binary',\n            accentDisplay === 'binary-hi-contrast' ? '-hi-contrast' : ''\n          )}\n        >\n          <span class=\"h-l\"></span>\n          <span class=\"l\"></span>\n        </span>\n      );\n\n    case 'none':\n      return '';\n  }\n}\n\nfunction renderPos(posDisplay: PartOfSpeechDisplay) {\n  const { t } = useLocale();\n\n  switch (posDisplay) {\n    case 'expl':\n      return (\n        <span\n          class=\"w-pos tag\"\n          lang={t('lang_tag')}\n        >{`${t('pos_label_n')},  ${t('pos_label_vs')}`}</span>\n      );\n\n    case 'code':\n      return <span class=\"w-pos tag\">n, vs</span>;\n\n    case 'none':\n      return null;\n  }\n}\n","import type {\n  AccentDisplay,\n  AutoExpandableEntry,\n  FontFace,\n  FontSize,\n  PartOfSpeechDisplay,\n} from '../common/content-config-params';\nimport { useLocale } from '../common/i18n';\n\nimport { CheckboxRow } from './CheckboxRow';\nimport { NewBadge } from './NewBadge';\nimport { PopupThemeRadio } from './PopupThemeRadio';\n\ntype Props = {\n  accentDisplay: AccentDisplay;\n  autoExpand: Array<AutoExpandableEntry>;\n  fontFace: FontFace;\n  fontSize: FontSize;\n  onChangeAccentDisplay: (value: AccentDisplay) => void;\n  onChangeAutoExpand: (entry: AutoExpandableEntry, checked: boolean) => void;\n  onChangeFontFace: (value: FontFace) => void;\n  onChangeFontSize: (value: FontSize) => void;\n  onChangePosDisplay: (value: PartOfSpeechDisplay) => void;\n  onChangeShowBunproDecks: (value: boolean) => void;\n  onChangeShowDefinitions: (value: boolean) => void;\n  onChangeShowPriority: (value: boolean) => void;\n  onChangeShowRomaji: (value: boolean) => void;\n  onChangeShowWaniKaniLevel: (value: boolean) => void;\n  onChangeTheme: (theme: string) => void;\n  posDisplay: PartOfSpeechDisplay;\n  showBunproDecks: boolean;\n  showDefinitions: boolean;\n  showPriority: boolean;\n  showRomaji: boolean;\n  showWaniKaniLevel: boolean;\n  theme: string;\n};\n\nexport function PopupStyleForm(props: Props) {\n  const { t } = useLocale();\n\n  return (\n    <>\n      <div class=\"mx-auto w-fit pb-6\">\n        <PopupThemeRadio {...props} />\n      </div>\n      <div class=\"flex flex-col gap-3 pb-6\">\n        <CheckboxRow>\n          <input\n            id=\"showPriority\"\n            name=\"showPriority\"\n            type=\"checkbox\"\n            checked={props.showPriority}\n            onChange={(e) =>\n              props.onChangeShowPriority(e.currentTarget.checked)\n            }\n          />\n          <label for=\"showPriority\">{t('options_show_priority')}</label>\n        </CheckboxRow>\n        <CheckboxRow>\n          <input\n            id=\"showWaniKaniLevel\"\n            name=\"showWaniKaniLevel\"\n            type=\"checkbox\"\n            checked={props.showWaniKaniLevel}\n            onChange={(e) =>\n              props.onChangeShowWaniKaniLevel(e.currentTarget.checked)\n            }\n          />\n          <label for=\"showWaniKaniLevel\">\n            {t('options_show_wanikani_levels')}\n          </label>\n        </CheckboxRow>\n        <CheckboxRow>\n          <input\n            id=\"showBunproDecks\"\n            name=\"showBunproDecks\"\n            type=\"checkbox\"\n            checked={props.showBunproDecks}\n            onChange={(e) =>\n              props.onChangeShowBunproDecks(e.currentTarget.checked)\n            }\n          />\n          <label for=\"showBunproDecks\">{t('options_show_bunpro_decks')}</label>\n        </CheckboxRow>\n        <CheckboxRow>\n          <input\n            id=\"showRomaji\"\n            name=\"showRomaji\"\n            type=\"checkbox\"\n            checked={props.showRomaji}\n            onChange={(e) => props.onChangeShowRomaji(e.currentTarget.checked)}\n          />\n          <label for=\"showRomaji\">{t('options_show_romaji')}</label>\n        </CheckboxRow>\n        <CheckboxRow>\n          <input\n            id=\"showDefinitions\"\n            name=\"showDefinitions\"\n            type=\"checkbox\"\n            checked={props.showDefinitions}\n            onChange={(e) =>\n              props.onChangeShowDefinitions(e.currentTarget.checked)\n            }\n          />\n          <label for=\"showDefinitions\">{t('options_show_definitions')}</label>\n        </CheckboxRow>\n      </div>\n      <div class=\"grid w-fit grid-cols-[repeat(2,auto)] items-baseline gap-4\">\n        <label for=\"accentDisplay\">{t('options_accent_display_label')}</label>\n        <select\n          id=\"accentDisplay\"\n          name=\"accentDisplay\"\n          onChange={(evt) => {\n            props.onChangeAccentDisplay(\n              evt.currentTarget.value as AccentDisplay\n            );\n          }}\n        >\n          <option\n            value=\"downstep\"\n            selected={props.accentDisplay === 'downstep'}\n          >\n            {t('options_accent_display_downstep')}\n          </option>\n          <option value=\"binary\" selected={props.accentDisplay === 'binary'}>\n            {t('options_accent_display_binary')}\n          </option>\n          <option\n            value=\"binary-hi-contrast\"\n            selected={props.accentDisplay === 'binary-hi-contrast'}\n          >\n            {t('options_accent_display_binary_high_contrast')}\n          </option>\n          <option value=\"none\" selected={props.accentDisplay === 'none'}>\n            {t('options_accent_display_none')}\n          </option>\n        </select>\n        <label for=\"posDisplay\">{t('options_pos_display_label')}</label>\n        <select\n          id=\"posDisplay\"\n          name=\"posDisplay\"\n          onChange={(evt) => {\n            props.onChangePosDisplay(\n              evt.currentTarget.value as PartOfSpeechDisplay\n            );\n          }}\n        >\n          <option value=\"expl\" selected={props.posDisplay === 'expl'}>\n            {t('options_pos_display_expl')}\n          </option>\n          <option value=\"code\" selected={props.posDisplay === 'code'}>\n            {t('options_pos_display_code')}\n          </option>\n          <option value=\"none\" selected={props.posDisplay === 'none'}>\n            {t('options_pos_display_none')}\n          </option>\n        </select>\n        <label for=\"fontSize\">{t('options_font_size_label')}</label>\n        <select\n          id=\"fontSize\"\n          name=\"fontSize\"\n          onChange={(evt) => {\n            props.onChangeFontSize(evt.currentTarget.value as FontSize);\n          }}\n        >\n          <option value=\"normal\" selected={props.fontSize === 'normal'}>\n            {t('options_font_size_normal')}\n          </option>\n          <option value=\"large\" selected={props.fontSize === 'large'}>\n            {t('options_font_size_large')}\n          </option>\n          <option value=\"xl\" selected={props.fontSize === 'xl'}>\n            {t('options_font_size_xl')}\n          </option>\n        </select>\n        <label for=\"fontFace\">\n          {t('options_font_face_label')}\n          <NewBadge expiry={new Date('2024-08-15')} />\n        </label>\n        <select\n          id=\"fontFace\"\n          name=\"fontFace\"\n          onChange={(evt) => {\n            props.onChangeFontFace(evt.currentTarget.value as FontFace);\n          }}\n        >\n          <option value=\"bundled\" selected={props.fontFace === 'bundled'}>\n            {t('options_font_face_bundled')}\n          </option>\n          <option value=\"system\" selected={props.fontFace === 'system'}>\n            {t('options_font_face_system')}\n          </option>\n        </select>\n        <div>{t('options_expand_all_entries')}</div>\n        <div class=\"flex gap-5 px-2 pt-1\">\n          <CheckboxRow>\n            <input\n              id=\"expandWords\"\n              name=\"expandWords\"\n              type=\"checkbox\"\n              checked={props.autoExpand.includes('words')}\n              onChange={(e) =>\n                props.onChangeAutoExpand('words', e.currentTarget.checked)\n              }\n            />\n            <label for=\"expandWords\">{t('options_expand_words_label')}</label>\n          </CheckboxRow>\n          <CheckboxRow>\n            <input\n              id=\"expandKanji\"\n              name=\"expandKanji\"\n              type=\"checkbox\"\n              checked={props.autoExpand.includes('kanji')}\n              onChange={(e) =>\n                props.onChangeAutoExpand('kanji', e.currentTarget.checked)\n              }\n            />\n            <label for=\"expandKanji\">{t('options_expand_kanji_label')}</label>\n          </CheckboxRow>\n        </div>\n      </div>\n    </>\n  );\n}\n","import { useCallback } from 'preact/hooks';\n\nimport type { Config } from '../common/config';\nimport type {\n  AccentDisplay,\n  AutoExpandableEntry,\n  FontFace,\n  FontSize,\n  PartOfSpeechDisplay,\n} from '../common/content-config-params';\nimport { useLocale } from '../common/i18n';\n\nimport { PopupStyleForm } from './PopupStyleForm';\nimport { SectionHeading } from './SectionHeading';\nimport { useConfigValue } from './use-config-value';\n\ntype Props = {\n  config: Config;\n};\n\nexport function PopupStyleSettings(props: Props) {\n  const { t } = useLocale();\n\n  const theme = useConfigValue(props.config, 'popupStyle');\n  const onChangeTheme = useCallback(\n    (value: string) => {\n      props.config.popupStyle = value;\n    },\n    [props.config]\n  );\n\n  const showPriority = useConfigValue(props.config, 'showPriority');\n  const onChangeShowPriority = useCallback(\n    (value: boolean) => {\n      props.config.showPriority = value;\n    },\n    [props.config]\n  );\n\n  const waniKaniVocabDisplay = useConfigValue(\n    props.config,\n    'waniKaniVocabDisplay'\n  );\n  const onChangeShowWaniKaniLevel = useCallback(\n    (value: boolean) => {\n      props.config.waniKaniVocabDisplay = value ? 'show-matches' : 'hide';\n    },\n    [props.config]\n  );\n\n  const showBunproDecks = useConfigValue(props.config, 'bunproDisplay');\n  const onChangeShowBunproDecks = useCallback(\n    (value: boolean) => {\n      props.config.bunproDisplay = value;\n    },\n    [props.config]\n  );\n\n  const showRomaji = useConfigValue(props.config, 'showRomaji');\n  const onChangeShowRomaji = useCallback(\n    (value: boolean) => {\n      props.config.showRomaji = value;\n    },\n    [props.config]\n  );\n\n  const showDefinitions = !useConfigValue(props.config, 'readingOnly');\n  const onChangeShowDefinitions = useCallback(\n    (value: boolean) => {\n      props.config.readingOnly = !value;\n    },\n    [props.config]\n  );\n\n  const accentDisplay = useConfigValue(props.config, 'accentDisplay');\n  const onChangeAccentDisplay = useCallback(\n    (value: AccentDisplay) => {\n      props.config.accentDisplay = value;\n    },\n    [props.config]\n  );\n\n  const autoExpand = useConfigValue(props.config, 'autoExpand');\n  const onChangeAutoExpand = useCallback(\n    (type: AutoExpandableEntry, value: boolean) => {\n      props.config.toggleAutoExpand(type, value);\n    },\n    [props.config]\n  );\n\n  const posDisplay = useConfigValue(props.config, 'posDisplay');\n  const onChangePosDisplay = useCallback(\n    (value: PartOfSpeechDisplay) => {\n      props.config.posDisplay = value;\n    },\n    [props.config]\n  );\n\n  const fontSize = useConfigValue(props.config, 'fontSize');\n  const onChangeFontSize = useCallback(\n    (value: FontSize) => {\n      props.config.fontSize = value;\n    },\n    [props.config]\n  );\n\n  const fontFace = useConfigValue(props.config, 'fontFace');\n  const onChangeFontFace = useCallback(\n    (value: FontFace) => {\n      props.config.fontFace = value;\n    },\n    [props.config]\n  );\n\n  return (\n    <>\n      <SectionHeading>{t('options_popup_style_heading')}</SectionHeading>\n      <div class=\"py-4\">\n        <PopupStyleForm\n          accentDisplay={accentDisplay}\n          autoExpand={autoExpand}\n          fontFace={fontFace}\n          fontSize={fontSize}\n          onChangeAccentDisplay={onChangeAccentDisplay}\n          onChangeAutoExpand={onChangeAutoExpand}\n          onChangeFontFace={onChangeFontFace}\n          onChangeFontSize={onChangeFontSize}\n          onChangePosDisplay={onChangePosDisplay}\n          onChangeShowBunproDecks={onChangeShowBunproDecks}\n          onChangeShowDefinitions={onChangeShowDefinitions}\n          onChangeShowPriority={onChangeShowPriority}\n          onChangeShowRomaji={onChangeShowRomaji}\n          onChangeShowWaniKaniLevel={onChangeShowWaniKaniLevel}\n          onChangeTheme={onChangeTheme}\n          posDisplay={posDisplay}\n          showBunproDecks={showBunproDecks}\n          showDefinitions={showDefinitions}\n          showPriority={showPriority}\n          showRomaji={showRomaji}\n          showWaniKaniLevel={waniKaniVocabDisplay === 'show-matches'}\n          theme={theme}\n        />\n      </div>\n    </>\n  );\n}\n","import type { JSX } from 'preact';\nimport { useCallback } from 'preact/hooks';\n\nimport { useLocale } from '../common/i18n';\n\nexport type ShowPuckSetting = 'auto' | 'show' | 'hide';\n\ntype Props = {\n  showPuck: ShowPuckSetting;\n  onChange: (value: ShowPuckSetting) => void;\n};\n\nconst labelKeys: Record<ShowPuckSetting, string> = {\n  auto: 'options_show_puck_option_auto',\n  show: 'options_show_puck_option_show',\n  hide: 'options_show_puck_option_hide',\n};\n\nexport function PuckSettingsForm(props: Props) {\n  const { t } = useLocale();\n\n  const onChange = useCallback(\n    (event: JSX.TargetedEvent<HTMLInputElement>) => {\n      const setting = event.currentTarget.value as ShowPuckSetting;\n      props.onChange(setting);\n    },\n    [props.onChange]\n  );\n\n  return (\n    <>\n      <p class=\"mt-0\">{t('options_show_puck_label')}</p>\n      {(['auto', 'show', 'hide'] as const).map((value) => (\n        <>\n          <input\n            type=\"radio\"\n            name=\"showPuck\"\n            id={`showPuck-${value}`}\n            value={value}\n            onChange={onChange}\n            checked={props.showPuck === value}\n          />\n          <label class=\"ml-1 mr-2\" for={`showPuck-${value}`}>\n            {t(labelKeys[value])}\n          </label>\n        </>\n      ))}\n    </>\n  );\n}\n","import { useCallback } from 'preact/hooks';\n\nimport type { Config } from '../common/config';\nimport { useLocale } from '../common/i18n';\n\nimport { PuckSettingsForm, type ShowPuckSetting } from './PuckSettingsForm';\nimport { SectionHeading } from './SectionHeading';\nimport { useConfigValue } from './use-config-value';\n\ntype Props = {\n  config: Config;\n};\n\nexport function PuckSettings(props: Props) {\n  const { t } = useLocale();\n  const showPuck = useConfigValue(props.config, 'showPuck');\n  const onChangeShowPuck = useCallback(\n    (value: ShowPuckSetting) => {\n      props.config.showPuck = value;\n    },\n    [props.config]\n  );\n\n  return (\n    <>\n      <SectionHeading>{t('options_lookup_puck_heading')}</SectionHeading>\n      <div class=\"py-4\">\n        <PuckSettingsForm showPuck={showPuck} onChange={onChangeShowPuck} />\n      </div>\n    </>\n  );\n}\n","import { useLocale } from '../common/i18n';\n\nimport { NewBadge } from './NewBadge';\n\ntype Props = {\n  selectedUnits: 'metric' | 'imperial';\n  onChange: (currency: string) => void;\n};\n\nexport function UnitSettingsForm(props: Props) {\n  const { t } = useLocale();\n\n  const options = [\n    ['metric', t('options_units_metric_label')],\n    ['imperial', t('options_units_imperial_label')],\n  ];\n\n  return (\n    <>\n      <label for=\"preferredUnits\">{t('options_units_label')}</label>\n      <NewBadge expiry={new Date('2024-09-30')} />\n      <select\n        id=\"preferredUnits\"\n        name=\"preferredUnits\"\n        onInput={(event) => {\n          props.onChange(event.currentTarget.value);\n        }}\n      >\n        {options.map(([value, label]) => (\n          <option\n            key={value}\n            value={value}\n            selected={value === props.selectedUnits}\n          >\n            {label}\n          </option>\n        ))}\n      </select>\n    </>\n  );\n}\n","import { useCallback } from 'preact/hooks';\n\nimport type { Config } from '../common/config';\nimport { useLocale } from '../common/i18n';\n\nimport { SectionHeading } from './SectionHeading';\nimport { UnitSettingsForm } from './UnitSettingsForm';\nimport { useConfigValue } from './use-config-value';\n\ntype Props = {\n  config: Config;\n};\n\nexport function UnitSettings(props: Props) {\n  const { t } = useLocale();\n  const preferredUnits = useConfigValue(props.config, 'preferredUnits');\n\n  const onChangeUnits = useCallback(\n    (value: 'metric' | 'imperial') => {\n      props.config.preferredUnits = value;\n    },\n    [props.config]\n  );\n\n  if (!preferredUnits) {\n    return null;\n  }\n\n  return (\n    <>\n      <SectionHeading>{t('options_unit_conversion_heading')}</SectionHeading>\n      <div class=\"py-4\">\n        <UnitSettingsForm\n          selectedUnits={preferredUnits}\n          onChange={onChangeUnits}\n        />\n      </div>\n    </>\n  );\n}\n","import type { Config } from '../common/config';\nimport { I18nProvider } from '../common/i18n';\nimport { possiblyHasPhysicalKeyboard } from '../utils/device';\n\nimport { CopySettings } from './CopySettings';\nimport { CurrencySettings } from './CurrencySettings';\nimport { DictionaryDataSettings } from './DictionaryDataSettings';\nimport { DictionaryLanguageSettings } from './DictionaryLanguageSettings';\nimport { GeneralSettings } from './GeneralSettings';\nimport { KanjiReferenceSettings } from './KanjiReferenceSettings';\nimport { KeyboardSettings } from './KeyboardSettings';\nimport { PopupInteractivitySettings } from './PopupInteractivitySettings';\nimport { PopupStyleSettings } from './PopupStyleSettings';\nimport { PuckSettings } from './PuckSettings';\nimport { UnitSettings } from './UnitSettings';\n\ntype Props = {\n  config: Config;\n};\n\nexport function OptionsPage(props: Props) {\n  const hasKeyboard = possiblyHasPhysicalKeyboard();\n\n  return (\n    <I18nProvider>\n      <div class=\"mx-auto max-w-[780px] px-6 pt-6\">\n        <GeneralSettings config={props.config} />\n        <PopupStyleSettings config={props.config} />\n        <PopupInteractivitySettings config={props.config} />\n        <CurrencySettings config={props.config} />\n        <UnitSettings config={props.config} />\n        {hasKeyboard && <KeyboardSettings config={props.config} />}\n        <CopySettings config={props.config} />\n        <PuckSettings config={props.config} />\n        <DictionaryLanguageSettings config={props.config} />\n        <KanjiReferenceSettings config={props.config} />\n        <DictionaryDataSettings />\n      </div>\n    </I18nProvider>\n  );\n}\n","/// <reference path=\"../common/constants.d.ts\" />\nimport { h, render } from 'preact';\n\nimport { Config } from '../common/config';\nimport { startBugsnag } from '../utils/bugsnag';\nimport {\n  isChromium,\n  isEdge,\n  isFenix,\n  isFirefox,\n  isSafari,\n} from '../utils/ua-utils';\n\nimport { OptionsPage } from './OptionsPage';\nimport './options.css';\n\nstartBugsnag();\n\nconst config = new Config();\n\nfunction completeForm() {\n  // UA-specific styles\n\n  // We only add the 'firefox' class on desktop Firefox since Fenix doesn't\n  // include browser styles.\n  if (isFirefox() && !isFenix()) {\n    document.documentElement.classList.add('firefox');\n  }\n  if (isChromium()) {\n    document.documentElement.classList.add('chromium');\n  }\n  if (isEdge()) {\n    document.documentElement.classList.add('edge');\n  }\n  if (isSafari()) {\n    document.documentElement.classList.add('safari');\n  }\n\n  const container = document.getElementById('container')!;\n  render(h(OptionsPage, { config }), container);\n}\n\nwindow.onload = async () => {\n  await config.ready;\n  completeForm();\n};\n"],"names":["jsonEqualish","actual","expected","Object","is","objEquiv","a","b","Date","getTime","Array","isArray","constructor","Error","aKeys","definedKeys","bKeys","length","sort","i","key","keys","filter","globalThis","chrome","runtime","id","browser","CHROME_SEND_MESSAGE_CALLBACK_NO_RESPONSE_MESSAGE","wrapAPIs","extensionAPIs","apiMetadata","DefaultWeakMap","WeakMap","createItem","items","undefined","super","this","get","has","set","isThenable","value","then","makeCallback","promise","metadata","callbackArgs","lastError","reject","message","singleCallbackArg","resolve","pluralizeArguments","numArgs","wrapAsyncFunction","name","target","args","minArgs","maxArgs","Promise","fallbackToNoCallback","cbError","console","warn","noCallback","wrapMethod","method","wrapper","Proxy","apply","targetMethod","thisObj","call","hasOwnProperty","Function","bind","prototype","wrapObject","wrappers","cache","create","handlers","proxyTarget","prop","receiver","defineProperty","configurable","enumerable","desc","Reflect","deleteProperty","wrapEvent","wrapperMap","addListener","listener","hasListener","removeListener","onRequestFinishedWrappers","req","wrappedReq","getContent","onMessageWrappers","sender","sendResponse","didCallSendResponse","wrappedSendResponse","sendResponsePromise","response","result","err","isResultThenable","sendPromisedResult","msg","error","__mozWebExtensionPolyfillReject__","catch","wrappedSendMessageCallback","reply","wrappedSendMessage","apiNamespaceObj","wrappedCb","push","sendMessage","staticWrappers","devtools","network","onRequestFinished","onMessage","onMessageExternal","tabs","settingMetadata","clear","privacy","services","websites","module","exports","slice","options","vnodeId","rerenderQueue","prevDebounce","defer","depthSort","eventClock","eventProxy","eventProxyCapture","EMPTY_OBJ","EMPTY_ARR","IS_NON_DIMENSIONAL","assign","obj","props","removeNode","node","parentNode","removeChild","createElement","type","children","ref","normalizedProps","arguments","defaultProps","createVNode","original","vnode","__k","__","__b","__e","__d","__c","__v","__i","__u","Fragment","BaseComponent","context","getDomSibling","childIndex","sibling","updateParentDomPointers","child","base","enqueueRender","c","process","__r","debounceRendering","renderQueueLength","component","newVNode","oldVNode","oldDom","commitQueue","refQueue","shift","__P","diff","__n","namespaceURI","commitRoot","diffChildren","parentDom","renderResult","newParentVNode","oldParentVNode","globalContext","namespace","excessDomChildren","isHydrating","childVNode","newDom","firstChildDom","oldChildren","newChildrenLength","constructNewChildrenArray","applyRef","insert","nextSibling","skewedIndex","matchingIndex","oldChildrenLength","remainingOldChildren","skew","String","findMatchingIndex","unmount","parentVNode","contains","insertBefore","nodeType","toChildArray","out","some","x","y","setStyle","style","setProperty","test","dom","oldValue","useCapture","o","cssText","replace","toLowerCase","l","_attached","addEventListener","removeEventListener","e","removeAttribute","setAttribute","createEventProxy","eventHandler","_dispatched","event","tmp","isNew","oldProps","oldState","snapshot","clearProcessingException","newProps","isClassComponent","provider","componentContext","renderHook","count","newType","outer","render","contextType","__E","doRender","sub","state","__h","_sb","__s","getDerivedStateFromProps","componentWillMount","componentDidMount","componentWillReceiveProps","shouldComponentUpdate","componentWillUpdate","componentDidUpdate","getChildContext","getSnapshotBeforeUpdate","MODE_HYDRATE","indexOf","diffElementNodes","diffed","root","cb","newHtml","oldHtml","newChildren","inputValue","checked","localName","document","createTextNode","createElementNS","__m","data","childNodes","attributes","__html","innerHTML","hasRefUnmount","current","skipRemove","r","componentWillUnmount","replaceNode","firstChild","createContext","defaultValue","contextId","Consumer","contextValue","Provider","subs","ctx","_props","old","splice","errorInfo","ctor","handled","getDerivedStateFromError","setState","componentDidCatch","update","callback","s","forceUpdate","setTimeout","FetchDelivery","client","sendEvent","sentAt","toISOString","body","JSON","stringify","apiKey","payloadVersion","notifier","events","fetch","endpoints","notify","mode","credentials","headers","referrerPolicy","CircularReference","Symbol","AccessError","safeFilter","input","replacer","seen","depth","depthLimit","edgeIndex","edgesLimit","Infinity","replacement","includes","hasToJson","safeAccess","toJSON","copy","limit","Math","min","item","currentKey","pop","accessor","objectToString","toString","getPrototypeOf","ERROR_TYPE","isError","isObject","CHROME_IE_STACK_REGEXP","SAFARI_NATIVE_CODE_REGEXP","parseStack","stackString","partialResult","match","parseV8OrIE","parseFFOrSafari","reduce","stack","file","lineNumber","concat","columnNumber","filtered","split","line","map","sanitizedLine","location","tokens","locationParts","extractLocation","join","functionNameRegex","matches","urlLike","regExp","parts","exec","parseInt","col","toExceptions","maybeError","normalizeError","exceptions","makeException","getCauses","cause","backtrace","fromSimpleError","getStringMember","field","newError","stackOptions","errorClass","stacktrace","getStacktrace","self","navigator","getStackString","generateBacktrace","MAX_STACK_SIZE","curr","callee","_e","RegExp","$1","caller","browserNotifyUnhandledExceptions","load","evt","ErrorEvent","filename","Number","isSafeInteger","lineno","log","colno","firstStackFrame","notifyEvent","unhandled","severity","severityReason","browserNotifyUnhandledRejections","reason","consoleBreadcrumbs","methodsToHook","leaveBreadcrumb","arg","stringified","errorBreadcrumbs","addOnPostError","errorMessage","fetchBreadcrumbs","oldFetch","init","url","isRequest","handleFetchSuccess","handleFetchError","Request","startsWith","status","request","interactionBreadcrumbs","targetText","targetSelector","isHtmlElement","getNodeText","isElement","getNodeSelector","Node","ELEMENT_NODE","elem","text","textContent","innerText","truncate","trim","tagName","className","querySelectorAll","index","from","parentElement","ommision","navigationBreadcrumbs","drop","oldURL","relativeLocation","to","newURL","getCurrentState","href","history","Window","replaceState","wrapHistoryFn","fn","win","pushState","urlObj","URL","pathname","search","hash","orig","title","stateChangeToMetadata","currentPath","prevState","appStart","now","appDuration","addOnError","app","duration","reset","parseUserAgent","userAgent","matchedRule","matchUserAgent","os","detectOS","device","osName","detectAppleDevice","browserName","browserVersion","osVersion","manufacturer","model","userAgentRules","matched","regex","uaMatch","operatingSystemRules","maxTouchPoints","browserContextWithUaParser","uaParser","locale","language","languages","metaData","browserContext","deviceOrientation","orientation","screen","documentElement","clientWidth","clientHeight","limitEvents","n","window","_key","Map","entries","Set","values","truncateString","getOwnPropertyNames","ArrayBuffer","byteLength","maxLength","substring","breadcrumbs","breadcrumb","browserHandledRejectionBreadcrumbs","BugsnagStatic","config","delivery","errorCallbacks","postErrorCallbacks","plugins","start","onError","plugin","timestamp","maxBreadcrumbs","originalError","releaseStage","enabledReleaseStages","user","version","appVersion","appType","time","sortLast","callbackResult","eventForDelivery","payload","getUser","setUser","email","add","removeOnError","delete","removeOnPostError","getPlugin","find","setDelivery","Bugsnag","StructError","TypeError","failure","failures","cached","rest","path","explanation","isIterable","iterator","isNonArrayObject","print","shiftIterator","next","done","toFailure","struct","refinement","branch","toFailures","run","mask","coerce","coercer","validator","k","v","ts","t","refiner","Struct","schema","assert","validate","tuples","tuple","array","Element","enums","description","integer","isNaN","isInteger","literal","constant","optional","record","Key","Value","string","union","Structs","S","coerced","first","getSize","size","threshold","refine","exclusive","nonempty","FxLocalDataSchema","rates","updated","async","getLocalFxData","onUpdate","getStorageChangeCallback","fxData","fx","validated","onChange","changes","areaName","newValue","stripFields","fields","isFirefox","isFenix","isChromium","isEdge","isSafari","isMac","platform","isIOS","dbLanguages","dbLanguageMeta","hasWords","hasKanji","isDbLanguageId","ExtensionStorageError","params","setPrototypeOf","captureStackTrace","action","PopupKeys","enabledKeys","l10nKey","SUPPORTED_REFERENCES","getReferencesForLang","lang","REFERENCE_ABBREV_MAPPING","CO","H","L","E","KK","DK","N","NR","V","P","IN","I","U","Y","WK","convertLegacyReference","REFERENCE_LABELS","conning","full","short","sh_kk2","halpern_njecd","halpern_kkld_2ed","heisig6","henshall","busy_people","kanji_in_context","kodansha_compact","maniette","nelson_c","nelson_n","py","skip","sh_desc","wk","getReferenceLabelsForLang","getLabelForReference","localeCompare","OFF_BY_DEFAULT_REFERENCES","Config","readSettings","settings","localSettings","info","installType","getReleaseStage","getExtensionInstallId","internalUuid","host","storedInstallId","installid","installId","getRandomId","number","getRandomNumber","repeat","pow","MAX_SAFE_INTEGER","Uint8Array","crypto","getRandomValues","max","round","currentIndex","currentComponent","previousComponent","prevRaf","currentHook","afterPaintEffects","_options","oldBeforeDiff","oldBeforeRender","oldAfterDiff","oldCommit","oldBeforeUnmount","oldRoot","getHookState","hooks","__H","useState","initialState","useReducer","invokeOrReturn","reducer","hookState","_reducer","currentValue","__N","nextValue","_hasScuFromHooks","updateHookState","p","stateHooks","every","prevScu","shouldUpdate","forEach","hookItem","prevCWU","useEffect","argsChanged","_pendingArgs","useRef","initialValue","useMemo","factory","useCallback","useContext","useId","flushAfterPaintEffects","invokeCleanup","invokeEffect","requestAnimationFrame","afterNextFrame","hasErrored","HAS_RAF","raf","clearTimeout","timeout","cancelAnimationFrame","hook","comp","cleanup","oldArgs","newArgs","f","shallowDiffers","PureComponent","memo","comparer","nextProps","updateRef","Memoed","displayName","isReactComponent","__f","Component","isPureReactComponent","oldDiffHook","REACT_FORWARD_SYMBOL","for","forwardRef","Forwarded","$$typeof","mapFn","Children","only","normalized","toArray","oldCatchError","oldUnmount","detachedClone","detachedParent","effect","removeOriginal","originalParent","appendChild","Suspense","_suspenders","suspended","__a","lazy","loader","prom","Lazy","default","SuspenseList","_next","_map","__R","suspendingVNode","suspendingComponent","resolved","onResolved","onSuspensionComplete","suspendedVNode","__O","detachedComponent","fallback","list","revealOrder","ContextProvider","Portal","_this","container","_container","_temp","before","createPortal","el","containerInfo","delegated","unsuspend","wrappedUnsuspend","reverse","REACT_ELEMENT_TYPE","CAMEL_PROPS","ON_ANI","CAMEL_REPLACE","IS_DOM","onChangeInputType","parent","preactRender","hydrate","preactHydrate","writable","oldEventHook","empty","isPropagationStopped","cancelBubble","isDefaultPrevented","defaultPrevented","persist","nativeEvent","classNameDescriptorNonEnumberable","class","oldVNodeHook","isNonDashedType","lowerCased","multiple","selected","oldDiffed","__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED","ReactCurrentDispatcher","readContext","useDebugValue","useDeferredValue","useImperativeHandle","useInsertionEffect","useLayoutEffect","useSyncExternalStore","useTransition","createFactory","isValidElement","element","isFragment","isMemo","cloneElement","preactCloneElement","unmountComponentAtNode","findDOMNode","unstable_batchedUpdates","flushSync","StrictMode","startTransition","val","subscribe","getSnapshot","_useState","_instance","_getSnapshot","didSnapshotChange","inst","latestGetSnapshot","prevValue","createRef","isStaticChildren","__source","__self","langTag","i18nContext","I18nProvider","useLocale","isTouchDevice","PointerEvent","matchMedia","possiblyHasPhysicalKeyboard","desktopOsStrings","osString","highPriorityLabels","getReferenceValue","entry","rad","nelson","fromCodePoint","radChar","renderKanKen","misc","kk","jlpt","codePointAt","toUpperCase","refs","level","getTextToCopy","CheckboxRow","NewBadge","expiry","CopySettingsForm","simplifiedCopy","onChangeSimplifiedCopy","currentTarget","ent","bv","matchRange","g","str","pos","romaji","showRomaji","copyType","getMessage","includeAllSenses","includeLessCommonHeadwords","includePartOfSpeech","SectionHeading","useConfigValue","setValue","changeCallback","addChangeListener","removeChangeListener","CopySettings","copyHeadwords","copyPos","copySenses","CurrencySettingsForm","currencyNames","Intl","DisplayNames","currencies","label","of","onInput","selectedCurrency","CurrencySettings","fxCurrency","fxCurrencies","onChangeCurrency","instanceOfAny","object","constructors","idbProxyableTypes","cursorAdvanceMethods","getIdbProxyableTypes","IDBDatabase","IDBObjectStore","IDBIndex","IDBCursor","IDBTransaction","getCursorAdvanceMethods","advance","continue","continuePrimaryKey","transactionDoneMap","transformCache","reverseTransformCache","promisifyRequest","unlisten","success","wrap","cacheDonePromiseForTransaction","tx","complete","DOMException","idbProxyTraps","objectStoreNames","objectStore","replaceTraps","wrapFunction","func","unwrap","transformCachableValue","IDBRequest","readMethods","writeMethods","cachedMethods","getMethod","targetFuncName","useIndex","isWrite","storeName","transaction","store","all","oldTraps","advanceMethodProps","methodMap","advanceResults","ittrProxiedCursorToOriginalProxy","cursorIteratorTraps","cachedFunc","iterate","cursor","openCursor","proxiedCursor","isIteratorProp","asyncIterator","allDataSeries","allMajorDataSeries","safeInteger","VersionInfoStruct","major","minor","patch","databaseVersion","dateOfCreation","records","part","format","_","KanjiMetaSchema","bg","AccentSchema","ReadingMetaSchema","CrossReferenceSchema","sense","LangSourceSchema","src","wasei","WordSenseSchema","gt","kapp","rapp","dial","inf","xref","ant","lsrc","WordIdSchema","km","rm","NameTranslationSchema","det","cf","NameIdSchema","tr","ReadingsStruct","on","kun","na","RadicalStruct","var","MiscSchema","gr","sc","freq","jlptn","meta","KanjiIdSchema","m","m_lang","st","RadicalIdSchema","pua","posn","GlossTypes","GLOSS_TYPE_MAX","floor","log2","requestIdleCallback","cancelIdleCallback","combine","classes","Boolean","isBooleanVariant","variants","_a","getSelected","_b","defaultVariants","compoundVariants","isSelected","raw","variantProps","variantClassName","localizedDataSeriesKey","kanji","radicals","names","words","classNames","Linkify","matchedReplacements","link","links","keyword","position","rel","formatDate","date","pad","getFullYear","getMonth","getDate","getHours","getMinutes","formatSize","sizeInBytes","kilobyte","megabyte","gigabyte","terabyte","toFixed","DbStatus","DbSummaryBlurb","DbSummaryStatus","dbState","onCancelDbUpdate","onUpdateDb","devMode","onClick","onDeleteDb","attribution","license","licenseKeyword","accentAttribution","strokeAttribution","updateState","IdleStateSummary","DbSummaryContainer","CancelUpdateButton","versionString","progressAsPercent","totalProgress","dbLabel","series","dbSummaryContainerProps","none","warning","isUnavailable","errorDetails","useErrorDetails","nextRetry","UpdateButton","lastCheck","versionInfo","DataSeriesVersion","quota","useStorageQuota","updateError","hasVersionInfo","summaryStates","enable","setQuota","storage","estimate","titleKeys","titleString","sourceNames","sourceName","sourceString","buttonLabel","updateDb","cancelDbUpdate","deleteDb","initialDbstate","useDb","setDbState","browserPortRef","browserPort","isDbStateUpdatedMessage","onDisconnect","port","DictionaryDataSettings","cancelDatabaseUpdate","deleteDatabase","startDatabaseUpdate","DictionaryLanguageSettingsForm","onChangeDictLang","dictLang","DictionaryLanguageSettings","IconRadio","Radio","HighlightStyleRadio","HighlightPreview","rangeClass","ToolbarIconRadio","IconPreview","alt","GeneralSettingsForm","toolbarIcon","onChangeToolbarIcon","supportsCssHighlight","highlightStyle","onChangeHighlightStyle","contextMenuEnable","onChangeContextMenuEnable","GeneralSettings","noTextHighlight","rawHighlightStyle","CSS","supports","KanjiReferenceSettingsForm","references","enabledReferences","gridTemplateRows","ceil","showKanjiComponents","onToggleKanjiComponents","onToggleReference","KanjiReferenceSettings","updateKanjiReferences","CopyKeys","optionsString","popupString","CopyNextKeyStrings","KeyBox","translateKey","KeyCheckbox","KeyInput","newKeys","PopupKeysForm","hasClipboardApi","clipboard","writeText","PopupKey","onUpdateKey","keysRef","checkboxes","checkbox","priorEnabled","orEnabled","ShowPopupKeysForm","KeyCheckboxes","holdToShowKeys","onChangeHoldToShowKeys","viewBox","holdToShowImageKeys","onChangeHoldToShowImageKeys","altRef","ctrlRef","ctrl","PRIMARY_MODIFIERS","SECONDARY_MODIFIERS","MODIFIER_MAP","command","strg","alternatif","macctrl","MEDIA_KEYS","CommandError","code","substitutions","ResetShortcut","ToggleKeyForm","toggleKeyError","setToggleKeyError","altKeyRef","macCtrlKeyRef","ctrlKeyRef","shiftKeyRef","keyRef","formState","setFormState","toggleKey","macCtrl","isEmpty","onToggleKeyChange","Command","fromParams","isValid","onChangeToggleKey","onToggleKeyDown","isValidKey","preventDefault","disabled","d","cx","cy","stroke","strokeWidth","strokeLinecap","strokeLinejoin","onKeyDown","onCompositionStart","onCompositionEnd","handleChromeLinks","HTMLAnchorElement","KeyboardSettingsForm","toggleKeyDisabled","popupKeys","onUpdatePopupKey","mac","KeyboardSettings","setToggleKey","getToggleKey","changeInfo","__MV3__","newShortcut","fromString","useHasMouse","mql","hasMouse","setHasMouse","onMqlChange","useHasTouch","hasCoarsePointer","setHasCoarsePointer","getThemeClass","theme","useThemeClass","darkMode","setDarkMode","MouseInteractivityRadio","themeClass","TabDisplayRadio","role","rx","width","height","PopupIconBase","clipPath","PopupInteractivitySettingsForm","onChangeMouseInteractivity","mouseInteractivity","hasTouch","enableTapLookup","onChangeEnableTapLookup","onChangeTabDisplay","tabDisplay","PopupInteractivitySettings","popupInteractive","PopupThemeRadio","PopupRadio","onChangeTheme","PopupPreview","fontFace","fontSize","showPriority","Star","showWaniKaniLevel","showBunproDecks","renderKana","accentDisplay","showDefinitions","renderPos","posDisplay","PopupStyleForm","onChangeShowPriority","onChangeShowWaniKaniLevel","onChangeShowBunproDecks","onChangeShowRomaji","onChangeShowDefinitions","onChangeAccentDisplay","onChangePosDisplay","onChangeFontSize","onChangeFontFace","autoExpand","onChangeAutoExpand","PopupStyleSettings","popupStyle","waniKaniVocabDisplay","bunproDisplay","readingOnly","toggleAutoExpand","labelKeys","auto","show","hide","PuckSettingsForm","setting","showPuck","PuckSettings","onChangeShowPuck","UnitSettingsForm","selectedUnits","UnitSettings","preferredUnits","onChangeUnits","OptionsPage","hasKeyboard","startBugsnag","completeForm","classList","getElementById","h","onload","ready"],"mappings":"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"}