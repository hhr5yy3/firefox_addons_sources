!function(){"use strict";function e(e){const t=new Map,n=new Map,r=function(e){const t=new Set(["all","bookmark","browser_action","launcher","page_action","tab","tools_menu"]);return Object.values(e.ContextType).filter((e=>!t.has(e)))}(e);let a=1;return{create:function(s){const i=!1!==s.visible;delete s.visible,s.id=s.id||"WEBEXT_MENUS/"+a++,i&&e.create(Object.assign({},s));const c={id:s.id,rawOptions:s,visible:i,pendingVisible:null,prev:[],refreshed:!1};t.set(s.id,c);for(const e of(l=o(c),l.reduce(((e,t)=>("all"===t?r.forEach((t=>e.add(t))):e.add(t),e)),new Set))){const t=`${s.parentId}/${e}`,r=n.get(t);r&&c.prev.push(r),n.set(t,c)}var l;return s.id},update:function(n,r){const a=t.get(n);null!=r.visible&&(r.visible!==a.visible&&(a.pendingVisible=r.visible),delete r.visible);if(Object.assign(a.rawOptions,r),a.visible)return e.update(n,r)},commit:function(){for(const n of t.values())n.prev.some((e=>e.refreshed))&&(n.refreshed=!0,null==n.pendingVisible&&n.visible&&(e.remove(n.id),n.pendingVisible=!0)),!1===n.pendingVisible?(e.remove(n.id),n.visible=!1,n.pendingVisible=null):!0===n.pendingVisible&&(e.create(Object.assign({},n.rawOptions)),n.visible=!0,n.pendingVisible=null,n.refreshed=!0);for(const e of t.values())e.refreshed=!1}};function o(e){return e.rawOptions.contexts?e.rawOptions.contexts:null!=e.rawOptions.parentId?o(t.get(e.rawOptions.parentId)):["page"]}}class t extends pref002.E{constructor(){super(),this._tabId=null,this._tab=null,this._onActivated=this._onActivated.bind(this),this._onUpdated=this._onUpdated.bind(this),pref002.b.tabs.onActivated.addListener(this._onActivated);try{pref002.b.tabs.onUpdated.addListener(this._onUpdated,{properties:["url"]})}catch(e){/filters/.test(e.message)&&pref002.b.tabs.onUpdated.addListener(this._onUpdated)}}_onActivated({tabId:e}){this._tabId=e,pref002.b.tabs.get(e).then((t=>{this._onUpdated(e,null,t)}))}_onUpdated(e,t,n){if(this._tabId&&e===this._tabId){if(!n.url){if(!n.finalUrl)return void console.warn(`Tab ${e} has no url`);n.url=n.finalUrl}this._tab=n,this.emit("change")}}getTab(){return this._tab}destroy(){pref002.b.tabs.onActivated.removeListener(this._onActivated),pref002.b.tabs.onUpdated.removeListener(this._onUpdated)}isExtensionPage(){return!!this._tab&&this._tab.url.startsWith(pref002.b.runtime.getURL(""))}}const n=new t;var r;!function(e){e[e.LessThan=-1]="LessThan",e[e.EqualTo=0]="EqualTo",e[e.GreaterThan=1]="GreaterThan"}(r||(r={}));const a=env005.g(),o=new Map;function s(e,t=!1){const n={q:expandEnv003.d()},{blob:s,erase:i,oncomplete:c}=e;let l;return delete e.blob,delete e.erase,delete e.oncomplete,l=s?d(s):/^data:/.test(e.url)?fetch(e.url).then((e=>e.blob())).then(d):u().catch(f),n.q.promise.catch((()=>{})).then((function(){n.blobUrl&&(URL.revokeObjectURL(n.blobUrl),n.blobUrl=null);n.id&&o.delete(n);n.completed&&i&&pref002.b.downloads.erase({id:n.id}).catch(console.error);c&&c()})),t?n.q.promise:l;function d(t){return n.blobUrl=URL.createObjectURL(t),e.url=n.blobUrl,u().catch(f)}function f(e){throw n.q.reject(e),e}async function u(){const t=await a;e.url.startsWith("http")&&e.referrer&&"Firefox"===t.name&&function(e,t){const n=String(e).split("."),a=String(t).split(".");for(let e=0;e<Math.min(n.length,a.length);e++){const t=Number(n[e]),o=Number(a[e]);if(t>o)return r.GreaterThan;if(o>t)return r.LessThan;if(!isNaN(t)&&isNaN(o))return r.GreaterThan;if(isNaN(t)&&!isNaN(o))return r.LessThan}return r.EqualTo}(t.version,"70")>=0&&(e.headers||(e.headers=[]),e.headers.push({name:"Referer",value:e.referrer})),delete e.referrer;const s=await pref002.b.downloads.download(e);n.id=s,o.set(s,n)}}pref002.b.downloads.onChanged.addListener((function(e){const t=o.get(e.id);if(!t)return;const n=e.state&&e.state.current,r=e.error&&e.error.current;r?t.q.reject(r):"complete"===n&&(t.completed=!0,t.q.resolve())}));const i="undefined"!=typeof navigator&&/iP(hone|(o|a)d);/.test(navigator.userAgent);function c(e){return new Promise(((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error||new Error("IDB request failed"))}))}function l({name:e,version:t,onupgradeneeded:n,indexedDB:r=f()}){if(!e)throw new Error("missing storage name");if(!r)throw new Error("missing indexedDB");let a,o=0;return{use:s,startTransaction:function(e,t,n){return s((async r=>{const a=r.transaction(e,t),[o]=await Promise.all([n(a),new Promise(((e,t)=>{a.oncomplete=()=>e(),a.onerror=()=>t(a.error||new Error("IDB transaction failed"))}))]);return o}))}};async function s(s){o++,a||(a=new Promise(((a,o)=>{const s=r.open(e,t);s.onerror=()=>o(s.error||new Error("IDB open failed")),s.onsuccess=()=>a(s.result),s.onupgradeneeded=n})));const i=await a;let c,l;try{l=await s(i)}catch(e){c=e}if(o--,o||(i.close(),a=null),c)throw c;return l}}function d({name:e,conflictAction:t="throw",indexedDB:n}={}){const r=l({indexedDB:n,name:e,version:1,onupgradeneeded:function(e){e.oldVersion<1&&(e.target.result.createObjectStore("metadata"),e.target.result.createObjectStore("resource"))}}),a=new Map,o=index001.c(),s=index001.a();let d;return function(e){for(const[t,n]of Object.entries(e))e[t]=(...e)=>(d||(d=r.startTransaction(["metadata"],"readonly",(async e=>{const t=e.objectStore("metadata"),[n,r]=await Promise.all([c(t.getAllKeys()),c(t.getAll())]);for(let e=0;e<n.length;e++)a.set(n[e],r[e])}))),d.then((()=>n(...e))));return e}({set:function(e,n,c){return o.read((()=>s.write([e],(async()=>{const o=a.get(e);if(o){if("throw"===t)throw new Error(`idb-storage key conflict: ${e}`);if("ignore"===t)return o;if("stack"===t)return await u(e)}var s;"function"==typeof n&&({resource:n,meta:c}=await n()),c||(c={}),c.stack=0,i&&n instanceof Blob?(c.blobType=n.type,n=await(s=n,new Promise(((e,t)=>{const n=new FileReader;n.onload=()=>e(n.result),n.onerror=()=>t(n.error||new Error("failed to convert Blob to ArrayBuffer")),n.readAsArrayBuffer(s)})))):c.blobType=null,c.size=n.size||n.byteLength||n.length;const l=Object.assign({},o,c);return await r.startTransaction(["metadata","resource"],"readwrite",(t=>{const r=t.objectStore("metadata"),a=t.objectStore("resource");r.put(l,e),a.put(n,e)})),a.set(e,l),l}))))},delete:function(e){return f([e])},deleteMany:function(e){return f(e)},get:function(e){return o.read((()=>s.read([e],(async()=>{const t=a.get(e);if(!t)throw new Error(`missing key: ${e}`);const n=await r.startTransaction(["resource"],"readonly",(t=>c(t.objectStore("resource").get(e))));return null!=t.blobType?new Blob([n],{type:t.blobType}):n}))))},getMeta:function(e){return o.read((()=>s.read([e],(()=>{const t=a.get(e);if(!t)throw new Error(`missing key: ${e}`);return t}))))},stackUp:function(e){return o.read((()=>s.write([e],(()=>u(e)))))},clear:function(){return f([...a.keys()],!0)},clearAll:function(){return o.write((async()=>{await r.startTransaction(["metadata","resource"],"readwrite",(e=>{const t=e.objectStore("metadata"),n=e.objectStore("resource");t.clear(),n.clear()})),a.clear()}))}});function f(e,t=!1){return o.read((()=>s.write(new Set(e),(async()=>{const n=new Map;await r.startTransaction(["metadata","resource"],"readwrite",(r=>{const o=r.objectStore("metadata"),s=r.objectStore("resource");for(let r=0;r<e.length;r++){const i=a.get(e[r]);if(!i)continue;if(t||!i.stack){o.delete(e[r]),s.delete(e[r]),n.set(e[r],null);continue}const c=n.get(e[r])||Object.assign({},i);c.stack--,o.put(c,e[r]),n.set(e[r],c)}}));for(const[e,t]of n.entries())t?a.set(e,t):a.delete(e)}))))}async function u(e){const t=a.get(e);if(!t)throw new Error(`missing key: ${e}`);const n=Object.assign({},t);return n.stack++,await r.startTransaction(["metadata"],"readwrite",(t=>{t.objectStore("metadata").put(n,e)})),a.set(e,n),n}}function f(){return"undefined"!=typeof indexedDB?indexedDB:"undefined"!=typeof webkitIndexedDB?webkitIndexedDB:"undefined"!=typeof mozIndexedDB?mozIndexedDB:"undefined"!=typeof OIndexedDB?OIndexedDB:"undefined"!=typeof msIndexedDB?msIndexedDB:null}const u="undefined"!=typeof content&&content.XMLHttpRequest;function p(e,t,n=XMLHttpRequest){return new Promise(((r,a)=>{const o=new n;o.open("GET",e),o.responseType=t,o.onload=()=>{200===o.status?r(o):a(new Error(`Bad status ${o.status}: ${e}`))},o.onerror=()=>{a(new Error(`Failed to load: ${e}`))},o.ontimeout=()=>{a(new Error(`Connection timeout: ${e}`))},o.send()}))}function b(e,t){return p(e,t).catch((n=>{if(env005.I)return fetch(e,{mode:"cors",cache:"force-cache"}).then((n=>{if(!n.ok)throw new Error(`Bad status ${n.status}: ${e}`);return n[t]()})).then((e=>({response:e,getResponseHeader:()=>{}})));if(u)return p(e,t,u);throw n}))}function h(e){return new Promise((t=>setTimeout(t,e)))}let m=[];function g(){m=[...readline004.p(pref002.p.get("retryOnFailure"),2)].map(w)}function w(e){const t=new RegExp(e[0],"i"),n=e[1].split(/\s+/).map(Number);return{rx:t,max:n[0],delay:n[1],exp:n[2]}}pref002.p.ready().then((()=>{g(),pref002.p.on("change",(e=>{null!=e.retryOnFailure&&g()}))})),pref002.p.ready().then((()=>{I(),pref002.p.on("change",(e=>{null!=e.fetchDelay&&I()}))}));const v=index001.a({maxActiveReader:3});let y=[];function I(){const e=[];for(const t of readline004.p(pref002.p.get("fetchDelay"))){const[n,r]=t[0].trim().split(/\s+/),a=1e3*Number(r),o=y.find((e=>e.origin===n));e.push({...o,origin:n,delayMs:a})}y=e}async function x(e,t){const n=new URL(e).origin,r=y.find((e=>{return t=e.origin,r=n,t.includes("*")?new RegExp(`^${t.replace(/[-/\\^$+?.()|[\]{}]/g,"\\$&").replace(/\*/g,".*")}$`).test(r):t===r;var t,r}));return r?await v.write([r.origin],(async()=>{const e=(r.lastFetch||0)+r.delayMs-Date.now();var n;await(n=e>0?e:0,new Promise((e=>setTimeout(e,n))));try{return await t()}finally{r.lastFetch=Date.now()}})):await v.read([n],t)}const E=function(){const e=d({name:"image-cache",conflictAction:"stack"});return{add:function({url:n,tabId:r,frameId:a,referrer:o}){return e.set(n,(async()=>await x(n,(async()=>{const e=await async function(e,t){const n=m.find((e=>e.rx.test(t)));if(n){let t=n.delay;for(let r=0;r<n.max;r++){try{return await e()}catch(e){console.warn(e),console.warn(`try again after ${t}s`)}await h(1e3*t),t*=n.exp}}return await e()}((()=>t(n,r,a,o)),n),s=e.blob;delete e.blob;var i;return{resource:s,meta:Object.assign(e,await(i=s,new Promise(((e,t)=>{const n=new Image;function r(){n.remove(),URL.revokeObjectURL(n.src)}n.src=URL.createObjectURL(i),n.onerror=()=>{t(new Error("Failed to detect image dimension")),r()},n.onload=()=>{n.naturalWidth?e({width:n.naturalWidth,height:n.naturalHeight}):n.offsetWidth?e({width:n.offsetWidth,height:n.offsetHeight}):e({width:0,height:0}),r()},document.body.append(n)}))))}}))))},get:function(t){return e.get(t)},delete:function(t){return e.delete(t)},deleteMany:function(t){return e.deleteMany(t)},clearAll:function(){return e.clearAll()},fetchImage:t};async function t(e,t,n,r){return env005.I?await readline004.f(e,r):await async function(e,t,n,r){const a=await pref002.b.tabs.sendMessage(t,{method:"fetchImage",url:e,referrer:r},{frameId:n});if(a.blobUrl){const e=await b(a.blobUrl,"blob");a.blob=e.response,delete a.blobUrl,pref002.b.tabs.sendMessage(t,{method:"revokeURL",url:a.blobUrl},{frameId:n}).catch(console.error)}return a}(e,t,n,r)}}();let U=0;const T={PICK_FROM_CURRENT_TAB:{label:pref002.b.i18n.getMessage("commandPickFromHighlightedTab"),handler:async function(e){try{await D();const t=await pref002.b.tabs.query({currentWindow:!0,highlighted:!0}),n=await Promise.all(t.map((e=>P(e.id)))),r=n.findIndex((t=>t.tabId===e.id));n.unshift(n[r]),n.splice(r+1,1),await F({env:n[0].env,tabs:n},e)}catch(e){S(e)}}},PICK_FROM_RIGHT_TABS:{label:pref002.b.i18n.getMessage("commandPickFromRightTabs"),handler:B},PICK_FROM_RIGHT_TABS_EXCLUDE_CURRENT:{label:pref002.b.i18n.getMessage("commandPickFromRightTabsExcludeCurrent"),handler:function(e){return B(e,!0)}}};let k=0;const A=new Map,L=index001.c({maxActiveReader:5});var R;pref002.b.runtime.onMessage.addListener((R=(e,t)=>{switch(e.method){case"singleDownload":return e.tabId=t.tab.id,e.frameId=t.frameId,async function({url:e,env:t,tabId:n,frameId:r,referrer:a,alt:o}){let i;[t,i]=await Promise.all([t||pref002.b.tabs.sendMessage(n,{method:"getEnv"}),pref002.p.get("useCache")&&E.fetchImage(e,n,r,a).catch((e=>{throw S(e),e}))]),expandEnv003.e(t),expandEnv003.b(t,{url:e,base:i&&i.filename,alt:o});const c=pref002.p.get("filePatternStandaloneEnabled")&&t.pageContentType.startsWith("image/")?pref002.p.get("filePatternStandalone"):pref002.p.get("filePattern"),l=expandEnv003.a(c)(t);await s({url:e,blob:i&&i.blob,filename:l,saveAs:pref002.p.get("saveAs"),conflictAction:pref002.p.get("filenameConflictAction"),referrer:a,erase:"all"===pref002.p.get("clearDownloadHistory")},!0)}(e).catch($),!1;case"batchDownload":return async function({tabs:e,env:t,batchId:n}){const{cachedImages:r}=A.get(n);expandEnv003.e(t);const a=expandEnv003.a(pref002.p.get("filePatternBatch"));let o=0;const i=[];for(const n of e){pref002.p.get("isolateTabs")&&(Object.assign(t,n.env),o=0);for(const{url:e,filename:c,alt:l}of n.images){r.delete(e),expandEnv003.b(t,{url:e,index:o+1,base:c,alt:l});const n=a(t),d=0===o,f=L.read((async()=>{let t,r=await E.get(e);try{await s({url:e,blob:r,filename:n,saveAs:!1,conflictAction:pref002.p.get("filenameConflictAction"),erase:"all"===pref002.p.get("clearDownloadHistory")||"keepOne"===pref002.p.get("clearDownloadHistory")&&!d},!0)}catch(e){t=e}if(await E.delete(e),r=null,t)throw t}));i.push(f),o++}}Promise.all(i).catch($),pref002.p.get("closeTabsAfterSave")&&e.forEach((e=>pref002.b.tabs.remove(e.tabId)))}(e);case"closeTab":return e.tabId||(e.tabId=t.tab.id),function({tabId:e,opener:t}){t&&pref002.b.tabs.update(t,{active:!0}),pref002.b.tabs.remove(e)}(e);case"cacheImage":return E.add(e).then((t=>{const n=A.get(e.batchId);return n.cachedImages||(n.cachedImages=function(){const e=new Map;return{add:function(t){const n=e.get(t);e.set(t,(n||0)+1)},delete:function(t){const n=e.get(t);n>1?e.set(t,n-1):e.delete(t)},toList:function(){const t=[];for(const[n,r]of e.entries())for(let e=0;e<r;e++)t.push(n);return t}}}()),n.cachedImages.add(e.url),t}));case"getBatchData":return Promise.resolve(A.get(e.batchId));case"notifyError":return S(e.error);case"fetchImage":return readline004.f(e.url).then((e=>(env005.I&&e.blob&&(e.blobUrl=URL.createObjectURL(e.blob),delete e.blob),e)));case"revokeURL":return URL.revokeObjectURL(e.url);case"openDialog":return async function({type:e,title:t,text:n}){if("prompt"!==e)throw new Error(`Dialog ${e} is not supported`);const{resolve:r,promise:a}=expandEnv003.d(),o=U++,s=e=>{if("promptInit"===e.method&&e.id===o)return Promise.resolve({title:t,text:n});"promptResolve"===e.method&&e.id===o&&r(e.value)};let i;pref002.b.runtime.onMessage.addListener(s);try{return i=await pref002.b.windows.create({type:"popup",url:pref002.b.runtime.getURL(`dialog.html?id=${o}`),width:520,height:320}),await Promise.race([a,expandEnv003.w(i.tabs[0].id)])}catch(e){return console.error(e),null}finally{if(pref002.b.runtime.onMessage.removeListener(s),i)try{await pref002.b.windows.remove(i.id)}catch(e){console.warn(e)}}}(e);case"getCacheURL":return E.get(e.url).then((e=>URL.createObjectURL(e)))}},(...e)=>{try{const t=R(...e);return t&&t.catch?t.catch((e=>{throw console.error(e),e})):t}catch(e){throw console.error(e),e}})),pref002.b.browserAction.onClicked.addListener((e=>{T[pref002.p.get("browserAction")].handler(e)})),pref002.p.ready().then((()=>{function e(){pref002.b.browserAction.setTitle({title:T[pref002.p.get("browserAction")].label})}e(),pref002.p.on("change",(t=>{t.browserAction&&e()}))}));const M=[...[...Object.entries(T)].map((([e,{label:t,handler:n}])=>({title:t,onclick(e,t){n(t)},contexts:["browser_action"],oncontext:()=>pref002.p.get("browserAction")!==e}))),{type:"separator",contexts:["browser_action"]},{type:"checkbox",contexts:["browser_action"],title:pref002.b.i18n.getMessage("optionEnabledLabel"),checked:()=>pref002.p.get("enabled"),onclick(e){pref002.p.set("enabled",e.checked)}},...[...Object.values(T)].map((({label:e,handler:t})=>({title:e,onclick(e,n){t(n,e.frameId)},contexts:["page","image"],oncontext:()=>pref002.p.get("contextMenu")&&!n.isExtensionPage()}))),{title:pref002.b.i18n.getMessage("commandViewSourceElement"),onclick(e,t){pref002.b.tabs.sendMessage(t.id,{method:"viewSourceElementClicked",elementId:e.targetElementId}).catch(S)},contexts:["image"],oncontext:()=>n.isExtensionPage()}];let _;try{_=function(t,n){const r=function(){const e="undefined"!=typeof browser?browser:chrome;return e.menus||e.contextMenus}(),a=[],o=[],s=(null==n?function(e){let t;try{return t=e.create({visible:!1,title:"test_visible"},(()=>{const e="undefined"!=typeof browser?browser:chrome;e.runtime.lastError&&console.warn("failed to create menu when checking visible property",e.runtime.lastError)})),!0}catch(e){return!1}finally{null!=t&&e.remove(t)}}(r):n)?r:e(r);return function(){for(const e of t){const t=Object.assign({},e);"function"==typeof e.checked&&(delete t.checked,o.push(e)),e.oncontext?(delete t.oncontext,a.push(e),e.show=!1,t.visible=!1):e.show=!0,e.id=s.create(t)}}(),{update:function(){(function(){for(const e of a){const t=Boolean(e.oncontext());e.show!==t&&(e.show=t,s.update(e.id,{visible:t}))}s.commit&&s.commit()})(),function(){for(const e of o)s.update(e.id,{checked:e.checked()})}()}}}(M,!env005.I&&void 0)}catch(e){console.error(e)}_&&(pref002.p.ready().then((()=>{const e=["contextMenu","browserAction","enabled"];_.update(),pref002.p.on("change",(t=>{e.some((e=>null!=t[e]))&&_.update()}))})),n.on("change",(()=>_.update())));const O=function({file:e,enabled:t,onupdate:n}){const r=[16,32,64];let a,o,s;function i(e){const t=function(){if(!o){const e=document.createElement("canvas");o=e.getContext("2d")}return o}(),n={};for(const a of r)t.clearRect(0,0,a,a),t.drawImage(e,0,0,a,a),n[a]=t.getImageData(0,0,a,a);pref002.b.browserAction.setIcon({imageData:n})}return{update:function(){if(!t())return s=null,void pref002.b.browserAction.setIcon({path:e});(a||(a=fetch(e).then((e=>e.text()))),a).then((e=>{(e=n(e))!==s&&(s=e,function(e){return new Promise(((t,n)=>{const r=new Image;r.src=`data:image/svg+xml;charset=utf8;base64,${btoa(e)}`,r.onload=()=>{t(r)},r.onerror=()=>{n()}}))}(e).then(i))}))}}}({file:"images/icon.svg",enabled:()=>pref002.p.get("customIcon"),onupdate:e=>e.replace(/context-fill(?!-)/g,pref002.p.get("customIconColor"))});async function P(e,t=0){const n={tabId:e,frames:[],env:null};await Promise.all([async function(){const r=await pref002.b.tabs.sendMessage(e,{method:"getImages"},{frameId:t});n.frames.push({frameId:t,images:r})}(),async function(){const r=await pref002.b.tabs.sendMessage(e,{method:"getEnv"},{frameId:t});n.env=r}(),pref002.p.get("collectFromFrames")&&async function(){const r=await pref002.b.webNavigation.getAllFrames({tabId:e}).then((e=>{const n=new Map;for(const t of e)t.errorOccurred||t.parentFrameId>=0&&(n.has(t.parentFrameId)||n.set(t.parentFrameId,[]),n.get(t.parentFrameId).push(t.frameId));const r=[];return function e(t){r.push(t);const a=n.get(t);a&&a.forEach(e)}(t),r.slice(1)}));await Promise.all(r.map((t=>async()=>{try{const r=await pref002.b.tabs.sendMessage(e,{method:"getImages"},{frameId:t});n.frames.push({frameId:t,images:r})}catch(e){console.warn(e)}})))}()]);const r=n.frames.findIndex((e=>e.frameId===t));if(0!==r){const e=n.frames[r];n.frames[r]=n.frames[0],n.frames[0]=e}return n}function j(e,t=0){return pref002.b.tabs.sendMessage(e,{method:"getEnv"},{frameId:t}).then((t=>({tabId:e,env:t})))}function D(){return pref002.p.get("collectFromFrames")?pref002.b.permissions.request({permissions:["webNavigation"]}).then((e=>{if(!e)throw new Error("webNavigation permission is required for iframe information")})):Promise.resolve()}function B(e,t=!1){D().then((()=>pref002.b.windows.get(e.windowId,{populate:!0}))).then((({tabs:n})=>{const r=n.filter((t=>t.index>e.index&&!t.discarded&&!t.pinned&&!t.hidden));return Promise.all([t?j(e.id):P(e.id),...r.map((e=>P(e.id).catch(console.warn)))])})).then((n=>F({env:(n=n.filter(Boolean))[0].env,tabs:t?n.slice(1):n},e))).catch(S)}function S(e){console.error(e),pref002.b.notifications.create({type:"basic",title:"Image Picka",message:e.message||String(e),iconUrl:"images/icon.svg"})}function $(e){"Download canceled by the user"!==e.message&&(e.args?S(`${String(e.message||e)}\nurl: ${e.args[0]}\nfilename: ${e.args[1]}`):S(String(e.message||e)))}function F(e,t){if(!(()=>{for(const t of e.tabs)for(const e of t.frames)if(e.images.length)return!0;return!1})())throw new Error("No images found");for(const t of e.tabs){const e=new Set;for(const n of t.frames){const t=[];for(const r of n.images)e.has(r.url)||(e.add(r.url),t.push(r));n.images=t}}const n=k++;A.set(n,e);const r={url:`/picker.html?batchId=${n}`,openerTabId:t.id};env005.I&&(r.index=t.index+1),expandEnv003.c(r).then((()=>{if(A.delete(n),e.cachedImages)return E.deleteMany(e.cachedImages.toList())})).catch(console.error)}pref002.p.ready().then((()=>{O.update(),pref002.p.on("change",(e=>{null==e.customIcon&&null==e.customIconColor||O.update()}))})),pref002.b.commands.onCommand.addListener((e=>{pref002.b.tabs.query({active:!0,currentWindow:!0}).then((t=>T[e].handler(t[0]))).catch(S)})),E.clearAll()}();
//# sourceMappingURL=background.js.map
