class BaseRuntime{isAvailable=!0;sendMessage(e,n=0){throw new Error("No implementation for sendMessage")}connect(){throw new Error("No implementation for sendMessage")}onDisconnect(e){throw new Error("No implementation for sendMessage")}getManifest(){throw new Error("No implementation for sendMessage")}}class ChromeRuntime extends BaseRuntime{constructor(){super(),this.onMessage=chrome.runtime.onMessage,this.connect=chrome.runtime.connect,this.onConnect=chrome.runtime.onConnect,this.onDisconnect=chrome.runtime.onDisconnect,this.getURL=chrome.runtime.getURL,this.getManifest=chrome.runtime.getManifest,this.getBackgroundPage=chrome.runtime.getBackgroundPage}#sendMessageInternal(s,r={},i,o=0){return new Promise((n,t)=>{try{chrome.runtime.sendMessage({channel:s,...r},e=>{if(chrome.runtime.lastError){if(!(o<3))throw new Error("retry sendMessage failed");setTimeout(()=>{this.#sendMessageInternal(s,r,i,o+1).then(n).catch(t)},2e3)}else i&&i(e),n(e)})}catch(e){"Extension context invalidated."!==e.message&&"retry sendMessage failed"!==e.message||(this.isAvailable=!1),n(null)}})}sendMessage(i,o={}){return new Promise(async n=>{var e=JSON.stringify(o);if(67108864<e.length)try{var t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),r=await this.#sendMessageInternal(i,{blobUrl:s});URL.revokeObjectURL(s),n(r)}catch(e){const r=await this.#sendMessageInternal(i,o);n(r)}else{const r=await this.#sendMessageInternal(i,o);n(r)}})}}class BrowserRuntime extends BaseRuntime{constructor(){super(),this.onMessage=browser.runtime.onMessage,this.onConnect=browser.runtime.onConnect,this.onDisconnect=browser.runtime.onDisconnect,this.connect=browser.runtime.connect.bind(browser.runtime),this.getURL=browser.runtime.getURL.bind(browser.runtime),this.getManifest=browser.runtime.getManifest.bind(browser.runtime),browser.runtime.getBackgroundPage&&(this.getBackgroundPage=browser.runtime.getBackgroundPage.bind(browser.runtime))}sendMessage(e,s={},r){return new Promise((n,t)=>{browser.runtime.sendMessage({channel:e,...s}).then(e=>{r&&r(e),n(e)}).catch(e=>t(e))})}}class Runtime{runtime=null;constructor(){if("undefined"!=typeof browser&&void 0!==browser.runtime)this.runtime=new BrowserRuntime;else{if("undefined"==typeof chrome||!chrome.runtime)throw new Error("Runtime not found.");this.runtime=new ChromeRuntime}this.connect=this.runtime.connect,this.onConnect=this.runtime.onConnect,this.onDisconnect=this.runtime.onDisconnect,this.getURL=this.runtime.getURL,this.getManifest=this.runtime.getManifest,2===this.getManifest.manifest_version&&(eagle.env.isBackground()?this.onConnect.addListener(()=>{}):this.runtime.connect().onDisconnect.addListener(()=>{this.runtime.isAvailable=!1}))}get isAvailable(){return this.runtime.isAvailable}onMessage(e,r){this.runtime.onMessage.addListener((n,t,s)=>(n.channel===e&&(n.blobUrl?(async()=>{var e=await(await fetch(n.blobUrl)).json();r(e,t,s)})():r(n,t,s)),!0))}sendMessage(e,n={},t){return this.runtime.sendMessage(e,n,t)}async broadcast(n,t={}){(await eagle.tabs.query({})).forEach(e=>{eagle.tabs.sendMessage(e.id,n,t)}),eagle.runtime.sendMessage(n,t)}}eagle.runtime=new Runtime;