class CollectPreviewerSize{constructor(e,t){var i=CollectWindow.MAX_PREVIEW_WIDTH,o={width:0,height:0};return 0<e&&0<t?1<=(e/=t)?(o.width=i,o.height=i/e):(o.width=i*e,o.height=i):o.width=o.height=i,o}}class CollectWindowIframe{iframe;dialog;isReady=!1;constructor(e){var{width:t,height:i}=e,e=(this.meta=JSON.parse(JSON.stringify(e)),this.meta.previewerSize=new CollectPreviewerSize(t,i),jQuery(`<iframe id="eagle-extension-collect-window" src="${eagle.extension.path}collect-window/index.html"></iframe>`));return(t=jQuery('<dialog id="eagle-extension-collect-dialog" eagle-extension></dialog>')).append(e),t.appendTo("body"),this.dialog=t[0],this.iframe=e[0],document.body.classList.add("eagle-show-collect-window"),t[0].showModal(),this.isReady=!1,this.#setupReadyListener(),this}#setupReadyListener(){let t=window.addEventListener("message",e=>{e.source===this.iframe.contentWindow&&"iframe-ready"===e.data.channel&&(this.isReady=!0,window.removeEventListener("message",t))})}sendMessage(e){this.iframe.contentWindow.postMessage(e,"*")}#sendMeta(){this.sendMessage({channel:"preview-meta",...this.meta})}async loaded(){return this.isReady?Promise.resolve():new Promise(e=>{const t=()=>{this.isReady?(this.#sendMeta(),e()):setTimeout(t,100)};t()})}remove(){this.dialog.close(),document.body.removeChild(this.dialog),document.body.classList.remove("eagle-show-collect-window")}}class CollectWindowPreviewer{mainContainer;previewContainer;previewBox;resolutionDiv;hasParent=!1;constructor(e){var{type:e,src:t,width:i,height:o,parent:n}=e,i=new CollectPreviewerSize(i,o),o="image"===e||"save-url"===e?"img":e;return this.mainContainer=document.createElement("div"),this.mainContainer.id="eagle-extension-collect-preview",this.mainContainer.setAttribute("eagle-extension-locale",eagle.preference.getPreferredLocale()),this.mainContainer.setAttribute("eagle-extension",""),this.mainContainer.setAttribute("translate","no"),this.mainContainer.style.display="flex",this.mainContainer.style.opacity=0,this.previewContainer=document.createElement("div"),this.previewContainer.id="eagle-extension-collect-preview-container",this.previewBox=document.createElement("div"),this.previewBox.id="eagle-extension-collect-preview-box",(e=document.createElement(o)).style.width=i.width+"px",e.style.height=i.height+"px",e.style.aspectRatio=i.width+" / "+i.height,"video"===o&&(e.autoplay=!0,e.muted=!0,e.loop=!0,e.src=t),"audio"===o&&(e.controls=!0,e.autoplay=!1,(i=document.createElement("source")).src=t,e.appendChild(i)),"img"===o&&(e.src=t),this.previewBox.appendChild(e),this.previewContainer.appendChild(this.previewBox),"audio"!==o&&(this.resolutionDiv=document.createElement("div"),this.resolutionDiv.classList.add("resolution"),this.resolutionDiv.style.display="none",this.previewBox.appendChild(this.resolutionDiv)),this.mainContainer.appendChild(this.previewContainer),(n?(this.hasParent=!0,n):document.body).appendChild(this.mainContainer),this}setResolution(e,t){this.resolutionDiv.textContent=e+"Ã—"+t,this.resolutionDiv.style.display="flex"}setPreviewContainerSize({depth:e}){this.previewContainer.removeAttribute("class"),this.previewContainer.classList.add("depth-"+e)}show(){this.mainContainer.style.opacity=1}remove(){this.hasParent||document.body.removeChild(this.mainContainer)}}class CollectWindow{collectWindowIframe;collectWindowPreviewer;listener;static MAX_PREVIEW_WIDTH=207;constructor(){this.collectWindowIframe=null,this.collectWindowPreviewer=null,this.#registerEventListener()}async open(t){this.collectWindowIframe||(this.collectWindowIframe=new CollectWindowIframe(t),this.collectWindowPreviewer=new CollectWindowPreviewer({...t,parent:this.collectWindowIframe.dialog}),await this.collectWindowIframe.loaded(),this.collectWindowIframe.iframe.focus(),setTimeout(()=>{this.collectWindowPreviewer.show()},200),this.#waitForCollectItem().then(e=>{t.onCollect&&t.onCollect(e)}).catch(()=>{t.onCancel&&t.onCancel()}))}close(){this.collectWindowIframe&&this.collectWindowIframe.remove(),this.collectWindowPreviewer&&this.collectWindowPreviewer.remove(),this.collectWindowIframe=null,this.collectWindowPreviewer=null,this.listener&&window.removeEventListener("message",this.listener)}#waitForCollectItem(){return new Promise((i,o)=>{this.listener=window.addEventListener("message",e=>{if("collect-item"===e.data.channel){var t=e.data.result;if(t.folderID)throw new Error("choose");eagle.env.shouldShowNewCollectWindow()&&(t.forceOpenCollectModal=void 0,t.forceHideCollectModal=!0),i(t),window.removeEventListener("message",this.listener),this.close()}else"iframe-closed"===e.data.channel&&(o(),this.close())})})}#registerEventListener(){window.addEventListener("message",async e=>{if(this.collectWindowIframe&&!1!==e.isTrusted&&e.source===this.collectWindowIframe.iframe.contentWindow&&e.data.channel){var t=e.data.channel;if("open-create-folder-dialog"===t){var i=eagle.utils.deepClone(e.data.collectItem),o=e.data.item;if(null==(o=await eagle.dialog.showCreateFolderDialog(o.name?.trim())))this.collectWindowIframe.sendMessage({channel:"cancel-create-folder-dialog"});else{if(""==o.trim())return void alert("please input folder name");o=await eagle.folder.create(o),i.folderIDs=[o.id],window.postMessage({channel:"collect-item",result:i}),this.close()}}"update-previewer-position"==t&&(o=e.data.depth,this.collectWindowPreviewer.setPreviewContainerSize({depth:o}))}})}updateTheme(){this.collectWindowIframe&&this.collectWindowIframe.contentWindow.postMessage({channel:"update-theme"},"*")}updateResolution(e,t){this.collectWindowPreviewer&&0<e&&0<t&&this.collectWindowPreviewer.setResolution(e,t)}}eagle.collectWindow=new CollectWindow;