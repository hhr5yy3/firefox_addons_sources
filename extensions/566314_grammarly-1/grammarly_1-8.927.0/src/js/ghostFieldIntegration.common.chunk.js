(self.webpackChunk=self.webpackChunk||[]).push([[748],{38877:(e,t,s)=>{s.r(t),s.d(t,{GhostFieldIntegration:()=>q});var i=s(90023),n=s(56606),r=s(82418),a=s(49144),h=s(55446),c=s(73863),o=s(14275),l=s(27628),_=s(65647),d=s(18615),p=s(58303),g=s(5395),u=s(67325),v=s(20323),b=s(25770),S=s(98995),x=s(65258),C=s(79992),m=s(4603),k=s(15677),f=s(8923),y=s(11456),T=s(94353),w=s(75792),D=s(10846),A=s(27804),P=s(65485),E=s(94525),U=s(80649),F=s(45493),R=s(71666),B=s(92292),O=s(68857),G=s(34770),I=s(81259),M=s(4798),z=s(62549);class q{constructor({doc:e,textField:t,domain:s,layout:n,createCheckingService:o,state:l,gnar:_,felog:d,textObserver:g,experimentClient:u,createTextRevisionManager:v=(e=>O.n.create(e)),originalTextField:S=t,customizations:C={},mapChange:m=i.yR,integrationName:f}){this._initialSessionUUID=b.h.create(p.YP),this._disposables=[],this._checkingService=b.h.create(null),this._sduiBufferService=b.h.create(p.YP),this._publishedAckReceived=new a.X(!1),this._canDisposeCheckingService=new a.X(!1),this._canDisposeCheckingServicePromise=this._canDisposeCheckingService.pipe(h.h((e=>e)),c.q(1)).toPromise(),this._checkingStatus=b.h.create(E.Hq.idle),this._readyState=b.h.create(E.kQ.notReady),this._nativeSpellcheckEnabled=b.h.create(!1),this._generalScore=b.h.create(null),this._lowestGeneralScore=b.h.create(null),this._paragraphsCount=b.h.create(0),this._formattingSpansCount=b.h.create(0),this._requestAwaitService=new U.e,this._capiStartAckMessage=b.h.create(p.YP),this._isDisposed=!1,this._subs=[],this._domain=s,this._layout=n,this._createCheckingService=o,this._state=l,this._gnar=_,this._felog=d,this._textObserver=g,this._createTextRevisionManager=v,this._originalTextField=S,this._customizations=C,this._experimentClient=u,this._initialWebkitUserSelect=this._originalTextField.style.webkitUserSelect,this._mapChange=m,this._integrationName=f,this._textRevisionManager=this._createTextRevisionManager(g),this._disposables.push(this._textRevisionManager),this._disposables.push(this._alertProcessor),this._disposables.push(this._userEngagedByAlertsAcceptedService),this._doc=A.v.createOnCapi(e,{selectedLens:r.R.SpecialId.AllAlerts});const y=this._state.get().dynamicConfig.dlpEnabled&&"enabled"===this._experimentClient.getTreatment(I.p.ClientControlsDlpBuffering),T=this._experimentClient.isGateEnabled(M.K.TextChangeBufferUseLegacy),P=this._textObserver.getCurrentTextMap().getPlainText();this._alertProcessor=k.B.create(P,this._textRevisionManager,d,u.isGateEnabled(M.K.PreserveSameRangeAlerts),u.isGateEnabled(M.K.RemoveRevisionChangeStagedTextProperty));const F=R.ft,G=T?new B.R(this.getUnmappedTextObserver().contentChanges.async,y?void 0:(0,x.qw)(this._originalTextField),!!this._customizations.richText,F):new R.fM(this.getUnmappedTextObserver().contentChanges.async,this._alertProcessor,y?void 0:(0,x.qw)(this._originalTextField),!!this._customizations.richText,F,!this._experimentClient.isGateEnabled(M.K.TextChangeBufferDontFlushOnApply));this._textChangeBuffer=G,this._disposables.push(G),this._textFieldAttrs=new w.Y(this._originalTextField,{spellcheck:"false"}),this._subs.push((0,D.H)({checkingService:this._checkingService,highlights:this._highlights,layout:this._layout,experimentClient:this._experimentClient,getAlertById:e=>this._alertProcessor.alerts.getAlertById(e)}).subscribe()),this._disposables.push(this._textFieldAttrs),Promise.resolve().then((()=>this._delayedStart()))}_isGBSigninCheckTextDisabled(){var e;const{user:t,page:s}=this._state.get();return(0,F.K)(t,s)&&(null!==(e=s.hideGBSigninPopupTodayTimestamp)&&void 0!==e?e:0)>Date.now()-g.pU}_delayedStart(){const{user:e,page:t}=this._state.get();z.n.isEdcBlocked(e)||this._isGBSigninCheckTextDisabled()||this._startCheckingText(!0===t.showOnboarding)}update(e){const t=this._checkingService.get();if(z.n.isEdcBlocked(e.user)||this._isGBSigninCheckTextDisabled())return null!==t&&(this._alertProcessor.removeAllAlerts({_tag:f.i.reset}),t.closeConnection(),this._checkingService.set(null)),void this._state.set(e);if(null!==t){const s=e.user,i=e.dapi.dialectStrong,n=this._state.get(),r=n.user,a=n.dapi.dialectStrong;s.id!==r.id||s.type!==r.type?(t.reconnect(),this._alertProcessor.removeAllAlerts({_tag:f.i.reset})):i!==a&&this._doc.settings.modify((e=>{const t={...e.context,dialect:p.ij(i)};return{...e,context:t}}))}else"ready"===e.extensionFSM.stage&&this._startCheckingText(!0===e.page.showOnboarding);this._state.set(e)}dispose(){var e;this._isDisposed||(this._isDisposed=!0,this._subs.forEach((e=>e.unsubscribe())),this._originalTextField.style.webkitUserSelect=this._initialWebkitUserSelect,[...this._disposables,this._textObserver,this._layout.textField.scroller].forEach((e=>{try{null==e||e.dispose()}catch(e){}})),null===(e=this._checkingService.get())||void 0===e||e.dispose(),o.timer(1e3).pipe(l.c(this._publishedAckReceived)).subscribe((e=>{e||this._canDisposeCheckingService.next(!0)})))}_startCheckingText(e){if(null!==this._checkingService.get())return;const t=this._createCheckingService({doc:this._doc,mapChange:this._mapChange,integrationName:this._integrationName});this._checkingService.set(t),t.delayDisposeUntil(this._canDisposeCheckingServicePromise),this._subs.push(t.capiMessages.pipe(h.h((e=>"start"===e.action))).subscribe((e=>this._capiStartAckMessage.set(p.G(e))))),this._subs.push(t.capiEvents.pipe(h.h(n.hX.is("session_started"))).subscribe((e=>{this._initialSessionUUID.set(p.ij(e.sessionUuid))})));this._checkingFeatureImpl=new T.O(this._state.view("user"),this._alertProcessor,t,this.getUnmappedTextObserver(),this._textRevisionManager,(()=>{}),(e=>this._checkingStatus.set(e)),(e=>this._readyState.set(e)),(e=>{this._fieldIntegrationController.setSiteSettings(e),this._checkDocContextSubscription()}),(e=>{this._textFieldAttrs.setAttributes({spellcheck:e.toString()}),this._nativeSpellcheckEnabled.set(e)}),((e,t,s)=>{}),(e=>(0,i.zG)(u.cS)),!!this._customizations.richText,(e=>this._generalScore.set(e||null)),(e=>this._lowestGeneralScore.set(e||null)),(e=>this._paragraphsCount.set(e)),(e=>this._formattingSpansCount.set(e)),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(()=>{(0,m.OB)().bgRpc.api.refreshUser("not_authorized")}),(e=>{this._statisticsService.wordsCount.set(e.wordsCount),this._statisticsService.charsCount.set(e.charsCount),this._statisticsService.sessionStats.set(e.sessionStats)}),(e=>{}),(e=>{}),(()=>this._canDisposeCheckingService.next(!0)),this._requestAwaitService.requests,this._textChangeBuffer,this._experimentClient,this._sduiBufferService.get(),new S.R),this.addSubscription(this._alertProcessor.alerts.state.pipe(_.U(y.S.alertMapToCapiAlerts),h.h((e=>e.filter((e=>e.isHidden)).length>0)),d.P()).subscribe((()=>{const{upgradeHookExperiment:e,experimentGroup:t}=(0,P.o)(this._experimentClient);this._felog.upgradeHooksExp.upgradeHookFirstHiddenPremiumAlertReceived(e.name,t,this._domain)}))),this._checkingFeatureImpl.delayDisposeUntil(this._canDisposeCheckingServicePromise)}getUnmappedTextObserver(){return this._textObserver}addSubscription(e){this._isDisposed?e.unsubscribe():this._subs.push(e)}_checkDocContextSubscription(){var e;this._customizations.getDocEvents&&(null===(e=this._docEventsSubscription)||void 0===e||e.unsubscribe(),this._docEventsSubscription=this._customizations.getDocEvents(this._originalTextField).subscribe((e=>{var t,s;switch(e.type){case"docContextUpdated":{const s=this._sanitizeContextInfo(e.docContextInfo);(0,v.Qr)(s)||null===(t=this._checkingService.get())||void 0===t||t.updateContextInfo(s);break}case"published":null===(s=this._checkingService.get())||void 0===s||s.published();break;default:(0,C.vE)(e)}})),this._subs.push(this._docEventsSubscription))}_sanitizeContextInfo(e){const t=Object.keys(e),s=z.n.isGrammarlyEmployee(this._state.view("user").get());return t.reduce(((e,t)=>(G.t.fieldIsPrivate(t)&&!s&&delete e[t],e)),e)}}}}]);