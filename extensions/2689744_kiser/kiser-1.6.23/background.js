!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=76)}({0:function(e,t,r){"use strict";r.d(t,"v",(function(){return o})),r.d(t,"m",(function(){return i})),r.d(t,"n",(function(){return s})),r.d(t,"j",(function(){return a})),r.d(t,"b",(function(){return c})),r.d(t,"u",(function(){return u})),r.d(t,"x",(function(){return l})),r.d(t,"y",(function(){return d})),r.d(t,"l",(function(){return m})),r.d(t,"a",(function(){return h})),r.d(t,"f",(function(){return p})),r.d(t,"r",(function(){return f})),r.d(t,"t",(function(){return g})),r.d(t,"d",(function(){return b})),r.d(t,"c",(function(){return y})),r.d(t,"o",(function(){return v})),r.d(t,"p",(function(){return _})),r.d(t,"e",(function(){return T})),r.d(t,"k",(function(){return k})),r.d(t,"s",(function(){return w})),r.d(t,"i",(function(){return P})),r.d(t,"q",(function(){return x})),r.d(t,"g",(function(){return U})),r.d(t,"h",(function(){return j})),r.d(t,"w",(function(){return O}));var n=r(6);function o(e){throw e}function i(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];t.forEach(e=>chrome.tabs.executeScript({file:e}))}function s(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];t.forEach(e=>chrome.tabs.insertCSS({file:e}))}function a(e,t){return t=t?" !important":"",Object.keys(e).reduce((r,n)=>`${r} ${n}: ${e[n]} ${t};`,"")}function c(e,t,r,o,i,s){return new Promise(a=>{const c=document.createElement("canvas"),u=c.getContext("2d"),l=new Image;c.width=o,c.height=i,l.setAttribute("crossorigin","anonymous"),l.src=e,l.onload=()=>{u.drawImage(l,t,r,o,i,0,0,o,i);const e=c.toDataURL();Object(n.b)(e,s).then(t=>a(t||e))}})}function u(e,t){return Object.fromEntries(Object.entries(e).map((e,r)=>{let[n,o]=e;return[n,t(o,n,r)]}))}const l=e=>t=>(e(t),t),d=e=>t=>{throw e(t),t};function m(e){return(e=>e.json())(e).then(t=>e.ok?t:Promise.reject(t)).catch(t=>Promise.reject({...t,status:e.status}))}const h=e=>0===e.indexOf("//")?"http:"+e:e;function p(e,t){return t.reduce((t,r)=>({...t,[r]:e[r]}),{})}function f(){let e=null;return(t,r)=>function(){for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];clearTimeout(e),e=setTimeout(()=>r(...o),t)}}const g=()=>{};function b(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}function y(e,t){var r=null;return function(){clearTimeout(r);var n=arguments;r=setTimeout(()=>e.apply(this,n),t)}}function v(e){return["string","number"].includes(typeof e)}function _(e){return"string"==typeof e}function T(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const t=[];return document.querySelectorAll("[itemscope]").forEach((function(r,n){if(e.length>0&&!1===e.includes(r.getAttribute("itemtype")))return;const o={type:r.getAttribute("itemtype"),properties:{}};r.querySelectorAll("[itemprop]").forEach((function(e){let t=e.content||e.textContent||e.src||e.href;if(o.properties[e.getAttribute("itemprop")]?o.properties[e.getAttribute("itemprop")].push("string"==typeof t?t.trim():t):o.properties[e.getAttribute("itemprop")]=["string"==typeof t?t.trim():t],e.matches("[itemscope]")&&e.matches("[itemprop]")){const t={type:e.getAttribute("itemtype"),properties:{}};e.querySelectorAll("[itemprop]").forEach((function(e){const r=e.content||e.textContent||e.src;t.properties[e.getAttribute("itemprop")]=["string"==typeof r?r.trim():r]})),o.properties[e.getAttribute("itemprop")]=[t]}})),t.push(o)})),t}function k(e){let t=e;return/^(?:f|ht)tps?\:\/\//.test(e)||(t="http://"+e),t}function w(e,t){return void 0===e?t:e}function P(e){const t=e.match(".*://([^/]*)|([^/]*)");return(null==t?void 0:t[1])||(null==t?void 0:t[2])||null}function x(e){return["white","#fff","#ffffff"].includes(e.toLowerCase())}function U(e){return Array.isArray(e)?null==e?void 0:e[0]:e}function j(e){const t=document.getElementsByTagName("meta");for(let r=0;r<t.length;r++)if(e===t[r].name||e===t[r].getAttribute("property"))return t[r].getAttribute("content");return null}function O(e){return(new DOMParser).parseFromString(e,"text/html").body.textContent||""}},2:function(e,t,r){"use strict";var n=r(4);const o=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return"/api/auth"+(e?"?redirect="+encodeURIComponent(e):"")},i=`${n.c}://${n.a}`,s={urlUninstall:i+"/kiser/uninstall",urlOnboardingTriggerUrl:i+"/kiser/onboarding",urlKiserInstalled:i+"/kiser/installed",urlGetLists:i+"/api/kiser/lists",urlGetListsAuth:i+o("/api/kiser/lists"),urlGetTranslations:i+"/api/kiser/translations",urlFetchItem:(e,t,r)=>i+`/api/kiser/item/${r}/section/${t}/list/${e}`,urlFindItems:(e,t)=>i+`/api/kiser/list/${e}/section/${t}/items`,urlGetFolders:i+"/api/kiser/folder",urlLogin:i+"/extension-login",urlRegister:i+"/register",urlUpdateItem:(e,t,r)=>i+`/api/kiser/update-remote-item/${e}/section/${t}/list/${r}`,urlAddItem:i+"/api/kiser/add-remote-item",urlAddFolder:i+"/api/kiser/folder",urlUpgrade:i+"/profile/plans",urlFeatures:i+"/features-info",urlCheckPermission:e=>i+"/api/kiser/permission/"+e,urlFile:e=>i+"/file/"+e,urlAddSection:e=>e&&`${i}/api/kiser/list/${e}/add-section`,urlAddList:()=>i+"/api/kiser/add-list",appUrl:e=>i+(e?`/lists/${e}/edit`:"/lists"),baseUrl:i},a={urlUninstall:i+"/kiser/uninstall",urlOnboardingTriggerUrl:i+"/kiser/onboarding",urlKiserInstalled:i+"/kiser/installed",urlGetLists:i+"/api/lists",urlGetListsAuth:i+o("/api/lists"),urlGetTranslations:i+"/api/translations",urlFetchItem:(e,t,r)=>i+`/api/item/${r}/section/${t}/list/${e}`,urlFindItems:(e,t)=>i+`/api/list/${e}/section/${t}/items`,urlGetFolders:i+"/folder",urlLogin:i+"/extension-login",urlRegister:i+"/register",urlUpdateItem:(e,t,r)=>i+`/update-remote-item/${e}/section/${t}/list/${r}`,urlAddItem:i+"/add-remote-item",urlAddFolder:i+"/folder",urlUpgrade:i+"/profile/plans",urlFeatures:i+"/features-info",urlCheckPermission:e=>i+"/api/permission/"+e,urlFile:e=>i+"/file/"+e,urlAddSection:e=>e&&`${i}/api/list/${e}/add-section`,urlAddList:()=>i+"/api/add-list",appUrl:e=>i+(e?`/lists/${e}/edit`:"/lists"),baseUrl:i};var c;t.a={...(c=n.d,!0===c?s:a),browser:n.b,statusSentIcon:"icons/color-38.png",itemSaveKeys:["srcUrl","imageDataUrl","fallbackDataUrl","linkUrl","selectionText","notes","catalogNr","supplier","measure","size","unitPrice","saveToFavourites","selectedTags","selectedColors","selectedItem","selectedList","selectedFolder","selectedText","selectedSection","selectedCategory","supplierProductUid"],allItemKeys:["srcUrl","imageDataUrl","fallbackDataUrl","linkUrl","selectionText","notes","catalogNr","supplier","category","saveToFavourites","measure","size","unitPrice","selectedTags","selectedColors","temporaryTags","supplierProductUid"],defaults:{measure:1,selectedTags:[],selectedColors:[],temporaryTags:[]},basicKeys:["srcUrl","unitPrice","selectedList","selectedSection","selectedCategory","linkUrl","selectionText","notes","category","kiser_version","kiser_browser","supplierProductUid"],thumb_resize_width:512,kiser_version:n.e,kiser_browser:n.b}},32:function(e,t,r){var n=r(35);e.exports=function(e,t){return new Promise((function(r,o){var i,s=t||{};function a(e){o(e||new Error("Aborted"))}function c(e,t){e.bail?a(e):i.retry(e)?s.onRetry&&s.onRetry(e,t):o(i.mainError())}"randomize"in s||(s.randomize=!0),(i=n.operation(s)).attempt((function(t){var n;try{n=e(a,t)}catch(e){return void c(e,t)}Promise.resolve(n).then(r).catch((function(e){c(e,t)}))}))}))}},35:function(e,t,r){e.exports=r(36)},36:function(e,t,r){var n=r(37);t.operation=function(e){var r=t.timeouts(e);return new n(r,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],o=0;o<t.retries;o++)n.push(this.createTimeout(o,t));return e&&e.forever&&!n.length&&n.push(this.createTimeout(o,t)),n.sort((function(e,t){return e-t})),n},t.createTimeout=function(e,t){var r=t.randomize?Math.random()+1:1,n=Math.round(r*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return n=Math.min(n,t.maxTimeout)},t.wrap=function(e,r,n){if(r instanceof Array&&(n=r,r=null),!n)for(var o in n=[],e)"function"==typeof e[o]&&n.push(o);for(var i=0;i<n.length;i++){var s=n[i],a=e[s];e[s]=function(n){var o=t.operation(r),i=Array.prototype.slice.call(arguments,1),s=i.pop();i.push((function(e){o.retry(e)||(e&&(arguments[0]=o.mainError()),s.apply(this,arguments))})),o.attempt((function(){n.apply(e,i)}))}.bind(e,a),e[s].options=r}}},37:function(e,t){function r(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=r,r.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},r.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},r.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1)}var n=this;return this._timer=setTimeout((function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout((function(){n._operationTimeoutCb(n._attempts)}),n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)}),r),this._options.unref&&this._timer.unref(),!0},r.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){r._operationTimeoutCb()}),r._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},r.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},r.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},r.prototype.start=r.prototype.try,r.prototype.errors=function(){return this._errors},r.prototype.attempts=function(){return this._attempts},r.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,n=0;n<this._errors.length;n++){var o=this._errors[n],i=o.message,s=(e[i]||0)+1;e[i]=s,s>=r&&(t=o,r=s)}return t}},4:function(e){e.exports=JSON.parse('{"c":"https","a":"kislist.com","b":"firefox","e":"1.6.23","d":false}')},6:function(e,t,r){"use strict";function n(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"0.92";var n=document.createElement("canvas"),o=n.getContext("2d"),i=new Image;return i.src=e,new Promise(e=>{i.onload=function(){i.width>t?(n.width=i.width,n.height=i.height,o.drawImage(i,0,0),i.width>i.height?(n.height=i.height/i.width*t,n.width=t):(n.width=i.width/i.height*t,n.height=t),o.drawImage(n,0,0,n.width,n.height),o.drawImage(i,0,0,n.width,n.height),e(o.canvas.toDataURL("image/jpeg",r))):e(null)}})}function o(e,t){e.fillStyle="#fff",e.fillRect(0,0,t.width,t.height)}function i(e,t,r){return function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95;return new Promise((n,i)=>{var s=new Image;s.onload=function(){var e=document.createElement("canvas"),i=e.getContext("2d");e.width=s.width,e.height=s.height,i.drawImage(s,0,0),s.width>s.height?(e.height=s.height/s.width*t,e.width=t):(e.width=s.width/s.height*t,e.height=t),o(i,e),i.drawImage(s,0,0,e.width,e.height),i.canvas.toBlob(n,"image/jpeg",r)},s.onerror=e=>i(e),s.setAttribute("crossorigin","anonymous"),s.src=e})}(e,t,r).then(e=>{const t=new FileReader;return new Promise((r,n)=>{t.readAsDataURL(e),t.onloadend=function(){r(t.result)}})})}r.d(t,"b",(function(){return n})),r.d(t,"a",(function(){return i}))},76:function(e,t,r){"use strict";r.r(t);var n=r(0),o=r(2);function i(e){const t={...e};return t.headers={...t.headers},t}function s(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:n.v;return t={headers:{"Content-type":"application/json"},...t},fetch(e,i(t)).catch(r)}function a(e,t,r){return function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:n.v;return fetch(e,i(t)).catch(r)}(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},r)}function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.t;chrome.storage.local.get(r=>{let{isOptimal:n}=r;!0===n||!1===n?!0===n?e(!0):t(!1):s(o.a.urlCheckPermission("optimal")).then(r=>{let{result:n}=r;return!0===n?e(!0):t(!1)}).catch(t)})}function u(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.t;chrome.storage.local.get(r=>{let{isPremium:n}=r;!0===n||!1===n?!0===n?e(!0):t(!1):s(o.a.urlCheckPermission("premium")).then(r=>{let{result:n}=r;return!0===n?e(!0):t(!1)}).catch(t)})}var l=r(4),d=r(32),m=r.n(d);function h(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return m()(e,{retries:3,randomize:!1,minTimeout:750,...t})}function p(){throw{error:"fetch_data_error"}}function f(){throw{error:"connection_error"}}const g=[{id:"selection",title:"Wybierz nazwę produktu",contexts:["selection"]},{id:"img",title:"Dodaj obrazek",contexts:["image"]}],b={};function y(e){e.forEach(e=>chrome.contextMenus.create(e))}function v(){Object(n.m)("js/fetch-item-from-params.js")}function _(){T(e=>{const t=Object.keys(b).map(e=>Number(e)).filter(t=>t!==Number(e.id));t.length>0&&(C(t),t.forEach(()=>delete b[e])),u(v),Object(n.m)("js/action-menu.js"),Object(n.n)("css/action-menu.css")})}function T(e){chrome.tabs.query({active:!0,currentWindow:!0},t=>{let[r]=t;return e(r)})}function k(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];const n=r=>{const n=b[r]&&b[r][t]&&b[r][t];null==n||n.postMessage(e)};r.length>0?r.forEach(n):T(e=>e&&n(e.id))}function w(e){k({action:"do-reload-data",data:e.data},"appMenuPort")}function P(e){k({action:"update-image-data-url",url:e.url},"scrapperPort")}function x(){k({action:"scrap-data"},"scrapperPort")}function U(){chrome.storage.local.remove(o.a.allItemKeys),chrome.storage.local.remove(["srcUrl"]),k({action:"do-clear-data"},"appMenuPort")}function j(){k({action:"do-save-item"},"appMenuPort")}chrome.runtime.onConnect.addListener((function(e){return!1===b.hasOwnProperty(e.sender.tab.id)&&(b[e.sender.tab.id]={}),"scrapper"===e.name?(b[e.sender.tab.id].scrapperPort=e,void e.onDisconnect.addListener(()=>{b[e.sender.tab.id]&&b[e.sender.tab.id].scrapperPort&&delete b[e.sender.tab.id].scrapperPort})):"app-menu"===e.name?(b[e.sender.tab.id].appMenuPort=e,void e.onDisconnect.addListener(()=>{b[e.sender.tab.id]&&b[e.sender.tab.id].appMenuPort&&delete b[e.sender.tab.id].appMenuPort})):"screenshot-taker"===e.name?(b[e.sender.tab.id].screenshotTakerPort=e,void e.onDisconnect.addListener(()=>{b[e.sender.tab.id]&&b[e.sender.tab.id].screenshotTakerPort&&delete b[e.sender.tab.id].screenshotTakerPort})):"item-picker"===e.name?(b[e.sender.tab.id].itemPickerPort=e,void e.onDisconnect.addListener(()=>{b[e.sender.tab.id]&&b[e.sender.tab.id].itemPickerPort&&delete b[e.sender.tab.id].itemPickerPort})):void("picker-toolbox"===e.name&&(b[e.sender.tab.id].pickerToolboxPort=e,e.onDisconnect.addListener(()=>{b[e.sender.tab.id]&&b[e.sender.tab.id].pickerToolboxPort&&delete b[e.sender.tab.id].pickerToolboxPort}),e.onMessage.addListener(e=>{const t={"update-value":R,"update-image":E};t[e.msg]&&t[e.msg](e)})))}));const O=e=>{const{srcUrl:t}=e;T(e=>{let{url:r}=e;chrome.storage.local.set({srcUrl:t,linkUrl:r}),k({action:"do-update-image",srcUrl:t,linkUrl:r},"appMenuPort")})},A=e=>{const{selectionText:t}=e;chrome.storage.local.set({selectionText:t}),k({action:"do-update-text",selectionText:t},"appMenuPort")},I=()=>{chrome.tabs.query({url:`*://${l.a}/extension-login*`},e=>{chrome.storage.local.get(e=>{let{lastTab:t}=e;t&&(chrome.tabs.update(t,{active:!0}),chrome.storage.local.remove("lastTab"),_())}),chrome.tabs.remove(e.map(e=>e.id))})},L=function(e,t){c(()=>{Object(n.m)("screenshot/screenshot.js"),Object(n.n)("screenshot/screenshot.css"),C()})},M=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>{};c(()=>{chrome.tabs.captureVisibleTab(t=>Object(n.b)(t,e.x,e.y,e.width,e.height,o.a.thumb_resize_width).then(t=>{chrome.storage.local.set({srcUrl:t,linkUrl:e.linkUrl})}).then(_).then(r))})},C=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];k({action:"do-remove-screenshot-taker"},"screenshotTakerPort",e),k({action:"do-destroy-app-menu"},"appMenuPort",e),k({action:"do-remove-iframe"},"pickerToolboxPort",e),k({action:"do-remove-iframe"},"itemPickerPort",e),k({action:"do-remove-iframe"},"scrapperPort",e)},S=()=>{k({action:"do-remove-screenshot-taker"},"screenshotTakerPort")},$=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>{};T(e=>{let{url:t}=e;chrome.storage.local.set({linkUrl:t}),r(t)})},E=e=>{k({action:"do-update-image",srcUrl:e.srcUrl,linkUrl:e.linkUrl},"appMenuPort")},F=e=>{k({action:"do-update-text",selectionText:e.selectionText},"appMenuPort")},R=e=>{k({action:"do-update-value",key:e.key,value:e.value},"appMenuPort")},D=function(e,t){_()},K=()=>{k({action:"do-inject-quick-fill-menu"},"pickerToolboxPort")},z=()=>{k({action:"do-inject-picker-toolbox"},"pickerToolboxPort")},G=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>{};"premium"===e.type?u(r):"optimal"===e.type&&c(r)},N=e=>{"login"===e.type&&T(e=>chrome.storage.local.set({lastTab:e.id})),C();let t={login:o.a.urlLogin,register:o.a.urlRegister}[e.type];setTimeout(()=>chrome.tabs.create({url:t}),200)};function q(e,t,r,i){return function(e){return new Promise(t=>{c(()=>t(e),()=>t(Object(n.f)(e,o.a.basicKeys)))})}(t).then(t=>h(()=>a(e,t,f))).then(n.l).then(Object(n.x)(e=>r&&r(e))).then(Object(n.x)(e=>e.result&&function(e){chrome.browserAction.setIcon({tabId:e,path:o.a.statusSentIcon})}(i)))}const J=e=>e&&k({action:"do-show-errors",errorCode:e.error,errors:e.errors,errorMessage:e.message||e.error,status:e.status},"appMenuPort");function B(e){throw 403!==e.status&&401!==e.status||k({action:"do-sign-out"},"appMenuPort"),e}const W=(e,t,r)=>{chrome.storage.local.get(t=>{const i=t.rememberLastUsedList;(t=Object(n.f)(t,o.a.itemSaveKeys)).kiser_version=o.a.kiser_version,t.kiser_browser=o.a.kiser_browser;const s=e.itemKey?o.a.urlUpdateItem(e.itemKey,e.sectionKey,e.listId):o.a.urlAddItem;T(e=>{t.srcUrl=t.imageDataUrl||t.fallbackDataUrl,q(s,t,r,e.id).then(Object(n.x)(((e,t)=>()=>{!1===t&&chrome.storage.local.remove(["selectedList","selectedFolder"]),chrome.storage.local.remove(o.a.allItemKeys),chrome.storage.local.set({itemDataLoaded:!1,selectedItem:"__product_new__"}),chrome.storage.local.remove(["itemKey","sectionKey","listId"]),C([e])})(e.id,i))).catch(Object(n.y)(B)).catch(e=>{J(e),r({result:!1,data:e})})})})};function H(e){return new Promise(t=>{chrome.storage.local.get(r=>{let{lang:i,version:a}=r;return function(e,t,r,i){chrome.storage.local.get(a=>{let{translations:c}=a;c&&e.lang===t&&e.version===r?i({...e,translations:c}):s(o.a.urlGetTranslations,{},p).then(n.l).then(t=>{let{result:r}=t;chrome.storage.local.set({translations:r,lang:e.lang,version:e.version}),i({...e,translations:r})}).catch(Object(n.y)(B))})}(e,i,a,t)})})}function V(e,t,r){u(()=>{h(()=>s(o.a.urlFindItems(e.listId,e.sectionKey),{},f)).then(n.l).then(r).catch(Object(n.y)(B)).catch(Object(n.y)(()=>r([]))).catch(J)},()=>r([]))}function Q(e,t,r){chrome.storage.local.get(e=>{let{itemKey:t,listId:i,sectionKey:a}=e;t&&i&&a?h(()=>s(o.a.urlFetchItem(i,a,t),{},f)).then(n.l).then(r).catch(Object(n.y)(B)).catch(e=>{J(e),r({item:null,fetched:!1})}):r({item:null})})}function X(e){return 401===e.status||403===e.status?h(()=>s(o.a.urlGetListsAuth,{},p)):e}function Y(e){return new Promise(t=>{chrome.storage.local.get(["updates"],r=>{let n=r.updates;const o={};n=Array.isArray(n)?n:[],n.forEach(t=>{!1===e.removedUpdates.includes(t.id)&&(o[t.id]=t)}),e.updates.forEach(t=>{!1===e.removedUpdates.includes(t.id)&&(o[t.id]=t)}),chrome.storage.local.set({updates:Object.values(o)},()=>t(e))})})}const Z=(e,t,r)=>{new Promise(e=>{chrome.storage.local.get(["updates"],t=>{t.updates?e(t.updates):e(!1)})}).then(e=>{const t=new URL(o.a.urlGetLists);return Array.isArray(e)&&e.length>0&&t.searchParams.set("excluded_updates",e.map(e=>e.id).join(",")),t.toString()}).then(e=>h(()=>s(e,{},p))).then(X).then(n.l).then(H).then(e=>(chrome.storage.local.get(t=>{let{isPremium:r}=t;e.isPremium!==r&&function(e){chrome.contextMenus.removeAll(()=>y(e))}(g)}),e)).then(e=>new Promise(t=>{T(r=>{let{url:n}=r;return t({...e,currentPageUrl:n})})})).then(Y).then(e=>{chrome.storage.local.set({isPremium:e.isPremium,isOptimal:e.isOptimal,isTeamMember:e.isTeamMember,categories:e.categories,rememberLastUsedList:e.rememberLastUsedList}),r(e)}).catch(Object(n.y)(B)).catch(J)},ee=(e,t,r)=>{h(()=>a(o.a.urlAddFolder,{name:e.folderName},f)).then(n.l).then(e=>h(()=>s(o.a.urlGetFolders,{},p).then(n.l).then(t=>({folders:t.result,folderUid:e.folderUid})))).then(r).catch(Object(n.y)(B)).catch(Object(n.y)(()=>r(null))).catch(J)},te=(e,t,r)=>{h(()=>a(o.a.urlAddList(),{list_name:e.listName},f)).then(n.l).then(r).catch(Object(n.y)(B)).catch(Object(n.y)(()=>r(null))).catch(J)},re=(e,t,r)=>{h(()=>a(o.a.urlAddSection(e.listId),{section_name:e.sectionName},f)).then(n.l).then(r).catch(Object(n.y)(B)).catch(Object(n.y)(()=>r(null))).catch(J)};chrome.runtime.onInstalled.addListener(e=>(y(g),"install"===e.reason&&chrome.tabs.create({url:o.a.urlKiserInstalled,active:!0}),!1)),chrome.runtime.onMessage.addListener((function(e,t,r){const n={"close-login":I,"remove-iframe":C,"remove-screenshot-taker":S,"take-screenshot":L,"clear-data":U,"reload-data":x,"capture-fragment":M,"update-image":E,"update-text":F,"update-value":R,"fetch-initial-data":Z,"fetch-item-from-data":Q,"fetch-items":V,"add-section":re,"add-list":te,"add-folder":ee,"save-item":W,"show-menu":D,"check-permission":G,"update-current-url":$,authenticate:N,"inject-quick-fill-menu":K,"inject-picker-toolbox":z,"update-scrapped-data":w,"update-image-data-url":P};return n[e.msg]&&n[e.msg](e,t,r),!0})),chrome.commands.onCommand.addListener((function(e){const t={"select-pic":_,"clear-data":U,"save-item":j,"take-screenshot":L};t[e]&&t[e]()})),chrome.browserAction.onClicked.addListener((function(e){_()})),chrome.contextMenus.onClicked.addListener((function(e){const t={img:O,selection:A};t[e.menuItemId]&&t[e.menuItemId](e)}))}});