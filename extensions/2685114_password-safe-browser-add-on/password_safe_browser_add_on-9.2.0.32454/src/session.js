function Session(profileId,databaseId,databaseName,serverAddress,userName,password,onSessionExpired,psrApi){const _self=this;_self.connected=!1,_self.authToken=null,_self.profileId=profileId,_self.user=psrApi?psrApi.currentUser:null,_self.databaseId=databaseId,_self.databaseName=databaseName,_self.userName=userName,_self.serverAddress=serverAddress,_self.containers=[],_self.applications=[],_self.optionCanAddTemplate=!1,_self.psrApi=psrApi,_self.onSessionExpired=onSessionExpired,_self.containerCache=[],_self.mspExpiryDays=void 0,_self.lastMspExpiryDateCheck=0,_self.bannerIsClosed=!1,_self.color=void 0,_self.init=async function(){_self.psrApi.onSessionExpired=async session=>{_self.connected=!1,"function"==typeof _self.onSessionExpired&&await _self.onSessionExpired(session)},await _self.loadOptions(),_self.connected=!0},_self.loadContainers=function(){return _self.psrApi.containerManager.getContainerBrowserSsoList(!1).then(r=>{_self.containers=[];var cs=[];for(let i=0;i<r.length;i++){var container={};container.ContainerId=r[i].ContainerId,container.ContainerName=URIDecode(r[i].ContainerName)||"",container.ContainerUserName=URIDecode(r[i].ContainerUserName)||"",container.Autofill=r[i].Autofill,container.Autosubmit=r[i].Autosubmit,container.MatchSubdomain=r[i].MatchSubdomain,container.Urls=r[i].Urls,container.UrlsWithRegex=r[i].UrlsWithRegex,container.DatabaseName=_self.databaseName,container.ProfileId=_self.profileId,container.SortPriority=1e3,container.HasOtpField=r[i].HasOtpField,cs.push(container),_self.containers.push(container)}return cs}).catch(_self.serverCallFailed)},_self.loadOptions=function(){return Promise.all([_self.psrApi.optionManager.getOption("UserRightCanShareWebApps",_self.user),_self.psrApi.optionManager.getOption("SsoPasswordAddLastFormSelection",_self.user),_self.psrApi.optionManager.getOption("UserRightOptionCanShowPresetsInData",_self.user),_self.psrApi.optionManager.getOption("UserRightOptionSelectPresetTemplate",_self.user),_self.psrApi.optionManager.getOption("UserRightOptionCanUsePrivateData",_self.user)]).then(([canShareWebApps,lastFormSelection,userRightOptionCanShowPresetsInData,userRightOptionSelectPresetTemplate,userRightOptionCanUsePrivateData])=>{_self.optionCanAddTemplate=canShareWebApps.ValueBoolean,_self.lastSelectedFormId=lastFormSelection?lastFormSelection.ValueString:null,_self.userRightOptionCanShowPresetsInData=!!userRightOptionCanShowPresetsInData&&userRightOptionCanShowPresetsInData.ValueBoolean,_self.userRightOptionSelectPresetTemplate=!!userRightOptionSelectPresetTemplate&&userRightOptionSelectPresetTemplate.ValueBoolean,_self.userRightOptionCanUsePrivateData=!!userRightOptionCanUsePrivateData&&userRightOptionCanUsePrivateData.ValueBoolean}).catch(_self.serverCallFailed)},_self.setLastSelectedFormId=function(formId){return(_self.lastSelectedFormId=formId)?_self.psrApi.optionManager.updateStringOption("SsoPasswordAddLastFormSelection",null,0,formId,_self.user.Id):_self.psrApi.optionManager.deleteOption("SsoPasswordAddLastFormSelection",_self.user.Id)},_self.setDisabledUntilUtc=async function(disabledUntilUtc){try{await psrApi.optionManager.updateStringOption("MspBannerDisabled",null,0,disabledUntilUtc,_self.user.Id),_self.bannerIsClosed=!0}catch(error){}},_self.getRemainingMspDays=async function(){try{if(_self.mspExpiryDays&&_self.lastMspExpiryDateCheck===(new Date).getDate()&&!_self.bannerIsClosed)return _self.mspExpiryDays;_self.lastMspExpiryDateCheck=(new Date).getDate();var disabledUntilOption=await _self.psrApi.optionManager.getOption("MspBannerDisabled",_self.user);if(_self.bannerIsClosed=!!disabledUntilOption&&(new Date).getTime()<new Date(disabledUntilOption.ValueString).getTime(),_self.bannerIsClosed)return;var isMspLicense=await _self.psrApi.licenseManager.getServerLicenseIsMsp();if(!isMspLicense)return;var today,expiryDate,isBilledCustomer=await _self.psrApi.licenseManager.getCurrentCustomersIsBilled();if(isMspLicense&&!isBilledCustomer)return today=new Date,expiryDate=Date.parse(await _self.psrApi.licenseManager.getCurrentCustomersExpirationDateUtc()),_self.mspExpiryDays=Math.ceil((expiryDate-today.getTime())/864e5),_self.mspExpiryDays}catch(error){}},_self.getApplications=function(){return _self.psrApi.applicationManager.getApplicationListFilter(!0).then(filter=>{return filter.FilterGroups.find(fg=>fg.ApplicationTypeFilters).ApplicationTypeFilters.find(at=>"MtoApplicationWeb"===at.Ident).FilterActive=!0,_self.psrApi.applicationManager.getApplicationList(filter).then(applications=>(applications.forEach(application=>{var settings=JSON.parse(application.ApplicationSettings);if(settings&&null!=settings.Templates&&null!=settings.Templates.$values){let temp=[];settings.Templates.$values.forEach(t=>temp.push(t)),settings.Templates=temp}application.ApplicationSettings=settings,application.ApplicationSettings.ApplicationId=application.Id}),(_self.applications=applications).map(a=>a.ApplicationSettings))).catch(_self.serverCallFailed)}).catch(_self.serverCallFailed)},_self.loadForms=function(){return _self.psrApi.containerManager.getContainerListFilter(1,!0).then(listFilter=>_self.psrApi.containerManager.getContainerList(1,listFilter))},_self.addApplication=async function(fillScript){fillScript.Templates=JSON.parse(fillScript.Templates);var application={Name:getCompareUrl(fillScript.Url),ApplicationSettings:JSON.stringify(fillScript),ApplicationType:3};(!!fillScript.ApplicationId&&await _self.psrApi.applicationManager.getApplication(fillScript.ApplicationId)?(application.Id=fillScript.ApplicationId,application.DataStates=1,_self.psrApi.applicationManager.updateApplication(application).then(r=>log("application updated",r))):_self.psrApi.applicationManager.addApplication(application).then(r=>templates[templates.length-1].ApplicationId=r.Id)).catch(_self.serverCallFailed)},_self.searchForContainer=function(query){return _self.psrApi.containerManager.SearchContainersBrowserSsoList(query).then(r=>{for(let i=0;i<r.length;i++){var currentContainer=r[i];currentContainer.ProfileId=_self.profileId,currentContainer.DatabaseName=_self.databaseName,currentContainer.SortPriority=1e3,currentContainer.Color=_self.color}return r}).catch(_self.serverCallFailed)},_self.getContainer=async function(containerId){var now=new Date,cachedContainer=_self.containerCache.find(i=>i.Container.Id===containerId);return cachedContainer?(cachedContainer.TimeStamp<now&&(cachedContainer.Container=await _self.psrApi.containerManager.getContainer(containerId),cachedContainer.TimeStamp=now.setSeconds(now.getSeconds()+5)),cachedContainer.Container):(cachedContainer=await _self.psrApi.containerManager.getContainer(containerId),_self.containerCache.push({Container:cachedContainer,TimeStamp:now.setSeconds(now.getSeconds()+5)}),cachedContainer)},_self.decryptContainerItem=function(item,reason){return item?_self.psrApi.containerManager.decryptContainerItem(item,reason).catch(_self.serverCallFailed):null},_self.generateGoogleAuthenticatorOtp=function(item){return item?_self.psrApi.oneTimePasswordManager.generateGoogleAuthenticatorOtpAsPromise(item).catch(_self.serverCallFailed):null},_self.forkSession=function(clientInstanceId,clientType,clientVersion){return _self.psrApi.authenticationManagerV2.forkSession(clientInstanceId,clientType,clientVersion).then(s=>({session:s,userKeys:_self.psrApi.authenticationManagerV2.getUserKeys()}))},_self.isProtected=function(containerId){const getCurrentUserOrRoleRights=dataRights=>{var right=dataRights.find(r=>r.LegitimateId===_self.psrApi.currentUser.Id);return right?Promise.resolve([right]):_self.psrApi.roleManager.getUserRoles(_self.psrApi.currentUser.Id).then(userRoles=>Promise.resolve(dataRights.filter(r=>userRoles.map(ur=>ur.Id).some(id=>id===r.LegitimateId))))};return _self.getContainer(containerId).then(container=>container.Items.reduce((p,_,index)=>p.then(isProtected=>new Promise(resolve=>{var item;isProtected?resolve(isProtected):1!==(item=container.Items[index]).ContainerItemType&&10!==item.ContainerItemType?resolve(!1):_self.psrApi.rightManager.getLegitimateDataRights(item.Id).then(rights=>{rights=rights,getCurrentUserOrRoleRights(rights).then(rights=>!!rights.length&&rights.every(r=>r.SecuredData)).then(resolve)})})),Promise.resolve(!1))).catch(_self.serverCallFailed)},_self.addPassword=function(password,ouId,templateGroupId){password=Object.setPrototypeOf(password,new PsrApiTypes.PsrContainer);return password.Items.forEach(i=>Object.setPrototypeOf(i,new PsrApiTypes.PsrContainerItem)),_self.psrApi.containerManager.addContainer(password,ouId,null,templateGroupId).then(async password=>{var dataTags;return templateGroupId&&(dataTags=await _self.psrApi.templateManager.getHierarchyDataTagTemplate(ouId,PsrApiEnums.PsrEntityObjectType.EntityObjectTypePassword,password.BaseContainerId,templateGroupId)).length&&await _self.psrApi.tagManager.setDataTags(dataTags.reduce((prev,curr)=>prev.concat(curr.TagIds),[]).map(tId=>({TagId:tId})),password.Id),{Successful:!0,Password:password}}).catch(err=>({Successful:!1,Message:err}))},_self.isSealed=async function(password){if(password&&password.Items)for(var item of password.Items.filter(i=>1===i.ContainerItemType||10===i.ContainerItemType)){var sealId=(await _self.psrApi.rightManager.getLegitimateDataRights(item.Id)).reduce((prev,curr)=>null===prev?null:void 0===prev&&curr.SealId?curr.SealId:curr.SealId&&curr.SealId!==prev?null:prev,void 0);if(sealId){sealId=await _self.psrApi.sealManager.getSeal(sealId);if(sealId){sealId=await _self.psrApi.sealManager.getSealOpenType(sealId,item.Id,_self.psrApi.currentUser.Id);if(6!==sealId&&4!==sealId&&0!==sealId)return!0}}}return!1},_self.closeSession=function(){_self.psrApi.authenticationManagerV2.logout(),_self.connected=!1},_self.updateContainerWithDetectionResult=async function(containerId,detectionResult){containerId=await _self.psrApi.containerManager.getContainer(containerId);if(!containerId)throw new Error("No container found");if(await _self.isProtected(containerId.Id))throw new Error("Container protected");return _self.fillItemsOfType(detectionResult.fields,containerId.Items,["password"],[1,10]),_self.psrApi.containerManager.updateContainer(containerId)},_self.disableAutofillForContainer=async function(containerId){var container=await _self.psrApi.containerManager.getContainer(containerId);let group=1;container=await _self.psrApi.optionManager.getOption("ShowPasswordInAddon",container);container&&container.DataId===containerId&&(group=container.Group),await _self.psrApi.optionManager.updateBooleanOption("ShowPasswordInAddon","OptionCategorySso",group,!1,containerId)},_self.serverCallFailed=function(err){throw log("PsrApi failed",err),err.status&&200!==err.status&&500!==err.status&&showNotification(browser.i18n.getMessage("error_server_unreachable")),err},_self.createApi=function(){if(!_self.psrApi){let baseAddress=_self.serverAddress;baseAddress.startsWith("http")||(baseAddress="https://"+baseAddress),_self.psrApi=new PsrApi(baseAddress)}}(),_self.fillItemsOfType=function(fields,items,types,containerItemTypes){const filledFields=[];return fields.filter(f=>f.isRelevant).filter(f=>-1!==types.indexOf(f.type)).forEach((field,index)=>{var item=items.filter(i=>-1!==containerItemTypes.indexOf(i.ContainerItemType))[index];if(item)switch(filledFields.push(field),item.ContainerItemType){case 1:case 10:item.PlainTextValue=field.value,item.Quality=_self.psrApi.passwordManager.getPasswordStrength(field.value);break;default:item.Value=field.value}}),fields.filter(f=>-1===filledFields.indexOf(f))}}