function e(e){return new Date(+e-6e4*(new Date).getTimezoneOffset()).toJSON().slice(0,-5).replace("T"," ")}function t(e,t){return t&&("omniBlockList"===e||n(t))?"$base64:"+btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,(e,t)=>String.fromCharCode(parseInt(t,16)))):t}function n(e){if(null==H){let e=[];for(let t of v.h("omniBlockList").split("\n"))t.trim()&&"#"!==t[0]&&e.push(t);H=e.length>0&&new RegExp(e.map(e=>e.replace(/[$()*+.?\[\\\]\^{|}]/g,"\\$&")).join("|"),"")}return false!==H&&H.test(e)}function o(e){return e instanceof Array&&(e=e.join("\n").trimRight()),(e=e.replace(/\r\n?/g,"\n").replace(/\xa0/g," ")).replace(/^\$base64:(.*)/gm,(e,t)=>{try{return decodeURIComponent([].map.call(atob(t),e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))}catch(e){}return e})}async function i(t,n,i){let l=n.environment,r=l&&l.platform||"",s=l&&l.extension&&l.extension+""||"",a=parseFloat(s||0)||0,f=a>1?s.split(".",2).join("."):"",u=a>parseFloat(k.version);if(r&&(r=(""+r).slice(0,10)),!confirm(O("confirmImport",[O(true!==i?"backupFile":"recommendedFile"),f?O("fileVCVer").replace("*",f):"",(f?O("fileVCVer_2").replace("*",f):"")+(u?O("fileVCNewer"):""),r?O("filePlatform",[O(r)||r[0].toUpperCase()+r.slice(1)]):O("commonPlatform"),t?O("atTime",[e(t)]):O("before")])))return void(VApi&&VApi.h(1,0,O("cancelImport")));let c=new Date,m=N(c,false);Object.setPrototypeOf(n,null);{let e=n.firefox;e&&"object"==typeof e&&Object.assign(n,e)}if(null==n.vimSync){let e=v.h("vimSync"),t=e&&confirm(O("keepSyncing"));n.vimSync=t||null==e&&null,e&&console.log("Before importing: You chose to",t?"keep settings synced.":"stop syncing settings.")}let p=function(e,t,n,o){let i=arguments.length>3,l=i?o:n,r=["%s %c%s",e,"color:darkred",t];l="string"!=typeof l||l.length<=72?l:l.slice(0,71).trimRight()+" \u2026",i&&r.push(n),r.push(l),d++,console.log.apply(console,r)},d=0;console.group("Import settings at "+e(+c+1)),g(8),t>1e4?console.info("load settings saved at %c%s%c.","color:darkblue",e(t),"color:auto"):console.info("load the settings:",i?"recommended.":"saved before.");let y=e=>e.split(/\s+/g).forEach(e=>e&&delete n[e]);y("name time environment author description chrome chromium firefox edge safari");for(let e in n)"@"===e[0]&&delete n[e];let w=e=>{let t=n[e];"string"==typeof t&&t.includes("extension://",2)&&(/^moz-/.test(t)||delete n[e])};w("vomnibarPage"),w("newTabUrl");let h=j(),S=v.r,C=V.D;for(let e in h)h[e]===S[e]||e in n||(n[e]=null);y("findModeRawQueryList innerCSS findCSS omniCSS newTabUrl_f vomnibarPage_f\n      focusNewTabContent dialogMode"),y("i18n_f");let A={__proto__:null,extWhiteList:"extAllowList",phraseBlacklist:"omniBlockList"};for(let e in A)e in n&&(n[A[e]]=n[e],delete n[e]);if(null==n.keyLayout){let e=n[T[0]],t=n[T[1]],o=n[T[2]];if(void 0!==e||void 0!==t||void 0!==o){let i;e=null!==e?e+"":e,t=null!==t?t+"":t,o=null!==o?o+"":o,i=null==e?4:"2"===e||"true"===e?1:"1"===e?12:4,i|=null==t||1===i?0:"2"===t||"true"===t?16:"1"===t?512:0,i|=null==o?0:"2"===o?128:"1"===o?64:0,i|=256,n.keyLayout=i}}for(let e of T)delete n[e];n.vimSync!==v.h("vimSync")&&(p("import","vimSync",n.vimSync),await v.p("vimSync",n.vimSync),await C.vimSync.w());{let e=C.keyMappings;void 0!==e&&(delete C.keyMappings,C.keyMappings=e)}if(await Promise.all(Object.values(C).map(async e=>{let t=e.y,i=n[t];if(delete n[t],t in S)return null==i?i=S[t]:("string"==typeof S[t]&&(i=o(i)),i=await e.B(i)),e.F(await e.E(),i)?e.O?void 0:e.w():(p("import",t,i),await v.p(t,i),t in v.f&&V.j.push(t),await e.w(),e.m())})).catch(e=>{p("[ERROR] importing options failed","cause:",e)}),await Promise.all(Object.keys(n).map(async e=>{let t=n[e];if(null==t)if(e in S){if(t=S[e],v.h(e)!==t)return p("reset",e,t),v.p(e,t)}else if(e.includes("|"))return p("remove",e,"(from local)"),b(28,{key:e,val:null});if("string"==typeof S[e]&&(t=o(t)),e in S){if(v.h(e)!==t)return p("update",e,t),v.p(e,t)}else if(e.includes("|"))return t=""+t,p("save",e,t),b(28,{key:e,val:t})})).catch(e=>{p("[ERROR] saving fields failed","cause:",e)}),g(0,8),await 0,_.onclick(false),d<=0)console.info("no differences found.");else if(m.options>0){let e=P(m.text);console.info("[message] you may recover old configuration of %d option(s), by open the %s URL below ON THIS TAB:\n%c%s",m.options,e.slice(0,5),"color: #15c;",e)}console.info("import settings: finished."),console.groupEnd();let L=VApi&&VApi.y().r;L&&L.querySelector("#HCls")&&B("force"),VApi&&VApi.h(1,0,O("importOK"))}function l(e,t,n){let o=null,l=null,s="";try{let e=r(n?t:t.replace(/\xa0/g," "));e instanceof Error?l=e:e?o=e:s=O("notJSON")}catch(e){l=e}if(null!=l){s=l?(l.message||l)+"":O("exc")+(""!==l?l:O("unknown"));let e=/^(\d+):(\d+)$/.exec(s);s=e?O("JSONParseError",[e[1],e[2]]):s}if(!o)return alert(s);if(e=+new Date(o.time||("object"==typeof e?+e:e))||0,"Vimium C"!==o.name&&"Vimium++"!==o.name||e<1e4&&e>0)return s=O("notVCJSON"),alert(s);let a=V.D.keyMappings.T?Promise.resolve():p("./options_checker.js"),f=e,u=o;a.then(()=>{setTimeout(i,17,f,u,n)})}function r(e){function t(){return/a?/.test("")}function n(e){let t=e.length;for(;f.length<t;f+=f);return f.slice(0,t)}let o=/[^\r\n]+/g,i=/\b(?:position (\d+)|line (\d+) column (\d+))/,l=/"(?:\\[^\r\n]|[^"\\\r\n])*"|'(?:\\[^\r\n]|[^'\\\r\n])*'|(?:\/\/|#)[^\r\n]*|\/\*[^]*?\*\//g;if(!e||!(e=e.trimRight()))return null;let r,s,a,f=" ";try{let i=JSON.parse(e.replace(l,e=>{let t=e[0];return"/"===t||"#"===t?e.startsWith("/*")?e.replace(o,n):n(e):e}));return t(),i}catch(e){if(r=i.exec(e+""),t(),!r||!r[0])throw e}if(r[2])s=+r[2],a=+r[3];else if(+r[1]>0){let t=e.includes("\r")?e.includes("\r\n")?"\r\n":"\r":"\n",n=e.slice(0,+r[1]).split(t);s=n.length,a=n[s-1].length+1}else s=a=1;return new SyntaxError(s+":"+a)}import{CurCVer_ as s,CurFFVer_ as a,OnChrome as f,OnEdge as u,OnFirefox as c,$ as m,import2_ as p,OnSafari as d,enableNextTick_ as g,isVApiReady_ as y,simulateClick_ as w,post_ as b,prevent_ as h}from"./async_bg.js";import{bgSettings_ as v,ExclusionRulesOption_ as S,Option_ as V,oTrans_ as O,getSettingsCache_ as j}from"./options_base.js";import{exportBtn_ as C,saveBtn_ as _}from"./options_defs.js";import{manifest_ as k}from"./options_permissions.js";import{delayed_task as A,clear_delayed_task as L,onHash_ as R,noBlobSupport_cr_mv2_ as x}from"./options_wnd.js";let T=["ignoreKeyboardLayout","ignoreCapsLock","mapModifier"],P=e=>{let t=new Blob([e],{type:"application/json",endings:"native"});return URL.createObjectURL(t)},B=e=>{if(!VApi||!VApi.z)return void y.then(B.bind(null,e));let t,n=VApi.y().r,o=false;if(e&&"force"!==e&&h(e),n&&(t=n.querySelector("#HCls"))){if("force"!==e&&null!=n.querySelector(".HelpCommandName"))return void w(t);let i=n.querySelector("#HDlg"),l=i&&i.parentElement||i;o=!!l&&l.remove!==HTMLElement.prototype.remove,l&&(l.remove=HTMLElement.prototype.remove)}VApi.r[0](40,{i:1,q:[{n:24,q:null}]},o||"#commands"===location.hash?()=>{let e=VApi&&VApi.y(),t=e&&e.r&&e.r.querySelector("#HDlg");if(!t)return;let n=t.parentElement||t;n.remove=()=>{HTMLElement.prototype.remove.call(n),location.hash="","none"!=m("#optionalPermissionsBox").style.display&&R("#optionalPermissions")}}:()=>{})};m("#showCommands").onclick=B,S.prototype.oe=function(e){if(e&&this.ie)return;let t,n,o=this.z(),i=/^([:^]?[a-z\-?*]+:\/\/)?((?:[^\/]|\/])+)(\/[^\]].*|\/?$)/;for(let e of o)(n=i.exec(t=e.pattern.replace("(?:[^./]+\\.)*?","*.")))&&n[1]&&n[2]&&(t=n[3]?n[3].replace(/\\\./g,"."):"",n=n[2].replace(/\\\./g,".").split("."),n.reverse(),t=n.join(".")+t),e.le=t;if(o.sort((e,t)=>e.le<t.le?-1:e.le===t.le?0:1),this.N(o),this.v(),!e)return;let l=this;this.ie=setTimeout((e,t)=>{e.firstChild.data=t,l.ie=0},1e3,e,e.firstChild.data),e.firstChild.data=O("3_2")},m("#exclusionSortButton").onclick=function(){V.D.exclusionRules.oe(this)};let E="",N=(e,n)=>{let o;o=Object.create(null),o.name="Vimium C",n||(o["@time"]=e.toLocaleString(),o.time=e.getTime()),o.environment={extension:k.version,platform:v.o},o.environment.firefox=a;let i=j(),l=v.r,r=Object.keys(i).sort();H=null;for(let e of r){let n=i[e],r=l[e];n!==r&&("string"!=typeof r?o[e]=n:n.includes("\n")?(o[e]=n.split("\n").map(n=>t(e,n))).push(""):o[e]=t(e,n))}if(H=null,null!=o.keyLayout){let e=o.keyLayout;9&e&&(o[T[0]]=8&e?1:2),528&e&&(o[T[1]]=512&e?1:2),192&e&&(o[T[2]]=64&e?1:2)}let s=JSON.stringify(o,null,"\t")+"\n",f=s.split("\n");for(let e=0;e<f.length;e++)if(f[e].replace(/[\u4e00-\u9fff]/g,"  ").length+1>120&&/^\s+"\w+":/.test(f[e])){let t=f[e].split(":",1)[0]+":",n=f[e].slice(t.length).trimLeft();n=n.replace(/[\u4e00-\u9fff]/g,"  ").length+4>120?n:"\t\t"+n,f[e]=t+"\n"+n}return s=f.join("\n"),"win"===o.environment.platform&&(s=s.replace(/\n/g,"\r\n")),{text:s,options:r.length}};C.onclick=t=>{E&&(URL.revokeObjectURL(E),E="");let n=new Date,o=!!t&&(t.ctrlKey||t.metaKey||t.shiftKey),i=N(n,o).text,l=e(n),r="vimium_c-";r+=o?"settings":l.replace(/[\-:]/g,"").replace(" ","_"),r+=".json";{let e=document.createElement("a");e.download=r,e.href=P(i),w(e),E=e.href}console.info("EXPORT settings to %c%s%c at %c%s%c.","color:darkred",r,"color:auto","color:darkblue",l,"color:auto")};let H=null,D=m("#settingsFile");D.onclick=null,D.onchange=function(){let e=this.files[0];if(this.value="",!e)return;let t=V.D.vimSync.S?102400:10485760;if(e.size&&e.size>t)return void alert(O("JSONTooLarge",[e.name,t/1024]));let n=new FileReader,o=e.lastModified||e.lastModifiedDate||0;n.onload=function(){return l(o,this.result,false)},n.readAsText(e)};let F=m("#importOptions");F.onclick=null,F.onchange=function(){m("#importButton").focus(),"exported"!==this.value?fetch("../settings-template.json").then(e=>e.text()).then(e=>l(0,e,true)):w(D)},A&&(()=>{let e=A;L();let t=m(e[0]);t.onclick&&t.onclick(e[1])})();