/*
 * content-script.js 
 *
 * Copyright (c) 2015-2019 by Pulse Secure, LLC. All rights reserved
 *
 */
var myPort=null;var resp=null;var handshake=0;var PSAL_EVENT_MSG="pulsePsalMsg";var PSAL_DATA="DATA";var PSAL_EVENT_RESPONSE="pulsePsalResp";myPort=browser.runtime.connect({name:"port-from-cs"});myPort.onMessage.addListener(handleBSMessage);browser.runtime.onMessage.addListener(notifyPage);function constructRespMsg(type,message){var resp={type:type,message:message};return resp}function notifyPage(request,sender,sendResponse){console.log("got msg from background script");console.log(request.message);var resp=constructRespMsg("status","installed");var psalMsgEvent=new CustomEvent(PSAL_EVENT_RESPONSE,{detail:resp});window.dispatchEvent(psalMsgEvent)}function handleBSMessage(request,sender,sendResponse){console.log("Rcvd message :"+request.type);switch(request.type){case"HANDSHAKE":if("PSAL_HELLO_WEBPAGE"==request.message){var version=browser.runtime.getManifest().version;window.postMessage({type:"status",text:"psal_installed",version:version});handshake=1}break;case"ERROR":console.log("handle response: "+request.message);window.postMessage({type:"error",text:"psal_not_installed"});break;default:break}}const psalExtensionInterface={psalExtnInvoke:function(){try{console.log("Extension Invoked");var resp=constructRespMsg("HANDSHAKE","WEBPAGE_HELLO_PSAL");myPort.postMessage(resp)}catch(error){if(browser.runtime.lastError){console.log("Error while sending handshake message",+browser.runtime.lastError);var resp=constructRespMsg("error",browser.runtime.lastError.message);window.postMessage(resp)}}}};window.wrappedJSObject.psalExtensionInterface=cloneInto(psalExtensionInterface,window,{cloneFunctions:true});window.addEventListener(PSAL_EVENT_MSG,function(event){console.log("Content script received a message ");var msg=event.detail;if(msg.type&&msg.type==PSAL_DATA){try{myPort=browser.runtime.connect({name:"port-from-cs"});myPort.onMessage.addListener(handleBSMessage);var resp=constructRespMsg(msg.type,msg.message);myPort.postMessage(resp)}catch(error){if(browser.runtime.lastError){console.log("ERROR",browser.runtime.lastError.message);var resp=constructRespMsg("error",browser.runtime.lastError.message);window.postMessage(resp)}}}},false);