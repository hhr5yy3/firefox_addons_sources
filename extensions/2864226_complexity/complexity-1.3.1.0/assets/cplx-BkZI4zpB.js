import{d,E as p,g,c as u}from"./cplx-CVsLL7Ku.js";import{A as o}from"./cplx-Cdcyb6EG.js";var l=class{constructor(e){if(e==="<all_urls>")this.isAllUrls=!0,this.protocolMatches=[...l.PROTOCOLS],this.hostnameMatch="*",this.pathnameMatch="*";else{const t=/(.*):\/\/(.*?)(\/.*)/.exec(e);if(t==null)throw new r(e,"Incorrect format");const[i,a,h,m]=t;f(e,a),v(e,h),this.protocolMatches=a==="*"?["http","https"]:[a],this.hostnameMatch=h,this.pathnameMatch=m}}includes(e){if(this.isAllUrls)return!0;const t=typeof e=="string"?new URL(e):e instanceof Location?new URL(e.href):e;return!!this.protocolMatches.find(i=>{if(i==="http")return this.isHttpMatch(t);if(i==="https")return this.isHttpsMatch(t);if(i==="file")return this.isFileMatch(t);if(i==="ftp")return this.isFtpMatch(t);if(i==="urn")return this.isUrnMatch(t)})}isHttpMatch(e){return e.protocol==="http:"&&this.isHostPathMatch(e)}isHttpsMatch(e){return e.protocol==="https:"&&this.isHostPathMatch(e)}isHostPathMatch(e){if(!this.hostnameMatch||!this.pathnameMatch)return!1;const t=[this.convertPatternToRegex(this.hostnameMatch),this.convertPatternToRegex(this.hostnameMatch.replace(/^\*\./,""))],i=this.convertPatternToRegex(this.pathnameMatch);return!!t.find(a=>a.test(e.hostname))&&i.test(e.pathname)}isFileMatch(e){throw Error("Not implemented: file:// pattern matching. Open a PR to add support")}isFtpMatch(e){throw Error("Not implemented: ftp:// pattern matching. Open a PR to add support")}isUrnMatch(e){throw Error("Not implemented: urn:// pattern matching. Open a PR to add support")}convertPatternToRegex(e){const i=this.escapeForRegex(e).replace(/\\\*/g,".*");return RegExp(`^${i}$`)}escapeForRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},n=l;n.PROTOCOLS=["http","https","file","ftp","urn"];var r=class extends Error{constructor(e,t){super(`Invalid match pattern "${e}": ${t}`)}};function f(e,t){if(!n.PROTOCOLS.includes(t)&&t!=="*")throw new r(e,`${t} not a valid protocol (${n.PROTOCOLS.join(", ")})`)}function v(e,t){if(t.includes(":"))throw new r(e,"Hostname cannot include a port");if(t.includes("*")&&t.length>1&&!t.startsWith("*."))throw new r(e,"If using a wildcard (*), it must go at the start of the hostname")}const L=[new n(o["perplexity-ai"].globalMatches[0]),new n(o["perplexity-ai"].globalMatches[1])],c=async()=>{const e=await chrome.permissions.contains({permissions:["scripting","webNavigation"]}),t=(await p.get()).preloadTheme,i=o.BROWSER==="chrome";return e&&t&&i},M=e=>L.some(t=>t.includes(e));class s{static instance;themeConfig={chosenThemeId:"",css:""};isListenerActive=!1;constructor(){this.setupListeners()}async setupListeners(){const t=(await p.get()).theme;this.updateThemeConfig({chosenThemeId:t,css:await g(t)}),this.initPermissionsEventListener(),await this.tryActivateNavigationListener()}async tryActivateNavigationListener(){const t=await c();t&&!this.isListenerActive?this.activateNavigationListener():!t&&this.isListenerActive&&this.deactivateNavigationListener()}initPermissionsEventListener(){u.listen(t=>{t.preloadTheme!=null&&this.tryActivateNavigationListener()}),chrome.permissions.onAdded.addListener(()=>{this.tryActivateNavigationListener()}),chrome.permissions.onRemoved.addListener(()=>{this.tryActivateNavigationListener()})}activateNavigationListener(){this.deactivateNavigationListener(),chrome.webNavigation.onCommitted.addListener(this.preloadTheme,{url:[{hostContains:"perplexity.ai"}]}),this.isListenerActive=!0}deactivateNavigationListener(){chrome.webNavigation.onCommitted.removeListener(this.preloadTheme),this.isListenerActive=!1}preloadTheme=async t=>{if(await c()&&!(t.frameId!==0||!M(t.url)))try{await chrome.scripting.insertCSS({target:{tabId:t.tabId},css:this.themeConfig.css})}catch(i){console.error("Failed to apply theme:",i)}};static getInstance(){return s.instance==null&&(s.instance=new s),s.instance}async updateThemeConfig(t){this.themeConfig=t}}const[R,T]=d("PplxThemePreloaderService",()=>s.getInstance());export{T as g,R as r};
