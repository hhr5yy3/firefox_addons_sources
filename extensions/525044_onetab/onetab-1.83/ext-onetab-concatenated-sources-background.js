// Copyright 2023 OneTab Ltd.  All rights reserved.
const ct="1.83",ke=!1,De=!1,Fe=!1,Re=!1,ve=!1,Be=!0,D=!!navigator.userAgent.match(/Mobile/i),dt="about:",m="about:blank",Wt="https://www.one-tab.com",Le=!1,jt=!1,At=!1,c=chrome.runtime.getURL("onetab.html"),j=c.substring(0,c.length-"onetab.html".length);let ht=!1;async function Z(){return ht?(await chrome.permissions.getAll()).permissions.includes("tabGroups")&&chrome.tabGroups:!1}async function Ot(){if(!ht||At)return!1;try{return await chrome.permissions.request({permissions:["tabGroups"]})}catch(i){return console.log('chrome.permissions.request for "tabGroups" permission failed with error:'),console.log(i),!1}}function Ue(i){let t=H(i);return t.toLowerCase().startsWith("www.")?t.substring("www.".length):t}function H(i){return i?(i.indexOf("//")===0&&(i="http:"+i),i.indexOf("://")===-1&&(i="http://"+i),i=i.substring(i.indexOf("://")+"://".length),i.indexOf("/")!==-1&&(i=i.substring(0,i.indexOf("/"))),i.indexOf(":")!==-1&&(i=i.substring(0,i.indexOf(":"))),i.indexOf("?")!==-1&&(i=i.substring(0,i.indexOf("?"))),i.indexOf("#")!==-1&&(i=i.substring(0,i.indexOf("#"))),i.toLowerCase()):"undefined"}function Ne(i){return i.indexOf("://")===-1?"https://":(i=i.substring(0,i.indexOf("://")+"://".length),i.toLowerCase())}let Ct=["com","co.uk","org.uk","net","org","de","ru","info","xyz","nl"];function $e(i){let t=H(i);try{for(let e in Ct){let a="."+Ct[e];if(Qt(t,a)){for(t=t.substring(0,t.length-a.length);t.indexOf(".")!==-1;)t=t.substring(t.indexOf(".")+1);t=t+a;break}}return t.indexOf("www.")===0&&(t=t.substring("www.".length)),t}catch{return t}}function Ht(i){i.noCacheRandom=Jt()}function Jt(){return new Date().getTime()+Math.round(Math.random()*1e4)+""}async function qt(i,t){Ht(t);let e=JSON.stringify(t);return await(await Vt(i,e)).json()}async function Vt(i,t){let e={};t?(e.method="POST",e.body=t):e.method="GET",e.headers=new Headers,e.headers.append("Content-Type","text/json");let a=await fetch(i,e);if(a.status===200)return a;throw new Error("http response code"+a.status)}function Kt(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,i=>{let t=Math.random()*16|0;return(i=="x"?t:t&3|8).toString(16)})}const zt="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split("");function tt(i,t){let e=zt,a=[],s=0;for(t=t||e.length,i=i||22,s=0;s<i;s++)a[s]=e[0|Math.random()*t];return a.join("")}function v(){return tt()}function bt(){return v()}function je(i){return i==null?"":i.replace(/^\s+/,"").replace(/\s+$/,"")}function He(i,t){return i?.length>t&&(i=i.substring(0,t)+"…"),i}function _t(...i){return(t,e)=>i.reduce((a,s)=>a||s(t,e),0)}function Je(i){return(t,e)=>i(t)-i(e)}function ft(i){return(t,e)=>i(e)-i(t)}const Tt=(i,t)=>!!t.starred-!!i.starred||i.starred&&t.starred&&t.starredDate-i.starredDate||t.createDate-i.createDate;function et(i){return i||(i=""),i.replace(/[\x00-\x1F\x7F-\x9F]/g,"")}function Qt(i,t){return i?i.indexOf(t,i.length-t.length)!==-1:!1}const Xt={restoreWindow:"newWindow",pinnedTabs:"ignore",startupLaunch:"displayOneTab",restoreRemoval:"default",duplicates:"allow",pinned:"true"};function P(i,t){return t[i]?t[i]:Xt[i]}function qe(i,t,e){i.parentNode&&i.remove(),t.insertBefore(i,e===void 0||e>=t.children.length||t.children.length===0?null:t.children[Math.max(0,e)])}function Yt(i,t){return Zt("div",i,t)}function Zt(i,t,e){return te(void 0,i,t,e)}function te(i,t,e,a){let s=t===void 0?i:document.createElement(t),n={},o={};if(e){e.style&&Object.assign(s.style,e.style);for(let u of Object.keys(e))u!=="style"&&u!=="children"&&u!=="child"&&u!=="init"&&(s[u]=e[u]),(u==="role"||u==="placeholder")&&s.setAttribute(u,e[u]);if(e.children){let u=Object.entries(e.children);for(const[w,d]of u)d instanceof HTMLElement?s.appendChild(d):(s.appendChild(d?.p?.o??d.o),d.u&&(Object.assign(o,d.u),o[w]=d));for(const[w,d]of u)n[w]=d,o[w]=d}if(e.l){let u=e.l;n.l=u,s.appendChild(u instanceof HTMLElement?u:u?.p?.o??u.o)}}t!==void 0&&i&&i.appendChild(s);let l={o:s,u:o};return Object.assign(l,n),a&&Object.assign(l,a),e?.init&&e.init(l),l}const Et="about:reader?url=";function O(i){return i?i.indexOf(":")===-1?"https://"+i:i.indexOf(Et)===0?decodeURIComponent(i.substring(Et.length)):i.startsWith(`${j}placeholder.html?`)?new URLSearchParams(i.substring(i.indexOf("?"))).get("url"):i:""}function Ve(i){let t=i.match(/\d+/);if(t)return parseInt(t[0])}const Pt=[...new Array(30)].map((i,t)=>parseInt(10+Math.pow(1.6,t)));function*pt(i){let t=0;for(;Pt.slice(0,t).reduce((e,a)=>e+a,0)<i;)yield Pt[t++]}async function yt(i,t,e){let a=0;for(let s of pt(i)){if(await e(a))return;await h(s),a+=s}throw new Error(`Timeout waiting for condition ${t}`)}function M(i){let t=chrome.i18n.getMessage(i);return t||(console.log("No translation available for: "+i),i)}function K(i,t,e){return t&&((i||"").toLowerCase().startsWith("file:")||z(i))?e?`data:text/html, <html><body><div id="placeholderUrl">${i}</div></body></html>`:`${j}placeholder.html?url=${encodeURI(i)}`:i}async function at(){try{return jt||!0}catch(i){return console.log(i),!0}}function z(i){for(let t of ee)if(i.startsWith(t))return!0;return!!(!i||i===""||i.startsWith("chrome-devtools:"))}const ee=["javascript:","about:",...["chrome://","edge://","data:"].filter(i=>!0),...["edge://","chrome://"].map(i=>["newtab","new-tab-page","print","network-error","badcastcrash","inducebrowsercrashforrealz","crash","crashdump","kill","hang","shorthang","gpuclean","gpucrash","gpuhang","memory-exhaust","memory-pressure-critical","memory-pressure-moderate","ppapiflashcrash","ppapiflashhang","quit","restart"].map(t=>`${i}${t}/`)).flat()];async function h(i){return new Promise(t=>setTimeout(t,i))}class ae{async put(t,e){await chrome.storage.local.set({[t]:e})}async get(t){return(await chrome.storage.local.get([t]))[t]}async remove(t){return await chrome.storage.local.remove(t)}}const ie=new ae;function S(){return ie}const se="undefined-34LKmiHxP3Mu48u8qrDaHf";function mt(i,t,e){return Array.isArray(i)?i.map(a=>mt(a,t,e)):typeof i=="object"&&i!==null?Object.fromEntries(Object.entries(i).map(([a,s])=>[a,mt(s,t,e)])):i===t?e:i}const C="c",x="e",B="tg";class ne{async put(t,e){await chrome.storage.session.set({[t]:e})}async get(t){return(await chrome.storage.session.get([t]))[t]}async getAll(){return await chrome.storage.session.get(null)}async remove(t){return await chrome.storage.session.remove(t)}async clearAll(){await chrome.storage.session.clear()}}class re{async put(t,e){await S().put("sessionStore",{...await this.getAll(),[t]:e})}async get(t){return(await this.getAll())[t]}async getAll(){return await S().get("sessionStore")??{}}async remove(t){let e=await this.getAll();delete e[t],await S().put("sessionStore",e)}async clearAll(){await S().remove("sessionStore")}}const oe=chrome.storage.session?new ne:new re;function E(){return oe}function kt(){return navigator.userAgent.includes(" Edg/")}async function Dt(i){let[t]=await chrome.tabs.query({windowId:i.windowId,active:!0});t&&t.id!==i.id?(await chrome.tabs.update(i.id,{active:!0}),await chrome.tabs.update(t.id,{active:!0})):console.log("No active tab found")}function Ke(i,t){let e,a;return arguments.length===1?(e=i,a=e!==void 0):(a=i,e=t),a?[e]:[]}function ze({id:i,display:t,marginTop:e="16px",marginBottom:a="16px",marginLeft:s=0,marginRight:n=0,color:o="var(--border-color)",I:l,P:u,F:w}={}){return Yt({...i&&{id:i},...u&&{className:"hideIfInLastSection"},...w&&{className:"hideIfInLastSubsection"},style:{...t&&{display:t},marginTop:e,marginBottom:a,marginLeft:s,marginRight:n,borderBottom:`1px solid ${o}`,...l}})}function _e(i){return[`
`,"\v","\f","\r","","\u2028","\u2029"].some(t=>t===i)}const le=["\v","\f","\r","","\u2028","\u2029"];function Qe(i){return i?(i=i.replaceAll(`\r
`,`
`),le.forEach(t=>i=i.replaceAll(t,`
`)),i):""}class it{constructor(t={}){this.Ft=[],this.locked=!1,this.debug=!1,this.Ut=t}async jt(){if(this.debug&&console.log(`lock ${this.Ut.label}: begin acquire attempt, queue len: ${this.Ft.length}`),this.locked){if(this.debug&&console.log(`lock ${this.Ut.label}: waiting to acquire, queue len: ${this.Ft.length}`),this.Ut.mi)for(this.debug&&this.Ft.length>0&&console.log(`lock ${this.Ut.label}: rejecting ${this.Ft.length} queuers`);this.Ft.length>0;)this.Ft.shift().resolve(!1);let t=await new Promise((e,a)=>{this.Ft.push({resolve:e,reject:a})});return this.debug&&(t?console.log(`lock ${this.Ut.label}: acquired after waiting, queue len: ${this.Ft.length}`):console.log(`lock ${this.Ut.label}: acquisition rejected`)),t}else return this.locked=!0,this.debug&&console.log(`lock ${this.Ut.label}: acquired, queue len: ${this.Ft.length}`),!0}release(){this.debug&&console.log(`lock ${this.Ut.label}: begin release, queue len: ${this.Ft.length}`),this.Ft.length===0?this.locked=!1:(this.Ft.shift().resolve(!0),this.debug&&console.log(`lock ${this.Ut.label}: waiting thread notified. queue len: ${this.Ft.length}`)),this.debug&&console.log(`lock ${this.Ut.label}: released. queue len: ${this.Ft.length}`)}}class N{static ea=6e4;static getKey(t){return`sessionStoreLock-${t}`}static async ga(t){let e=await E().get(N.getKey(t)),a=new Date().getTime();return e&&a-e>N.ea&&(console.log(`Warning: timed out sessionStore lock for id ${t}`),await N.release(t)),!!(e&&a-e<N.ea)}static async jt(t){return await this.ga(t)?!1:(await E().put(N.getKey(t),new Date().getTime()),!0)}static async release(t){await E().remove(N.getKey(t))}}class ${constructor(){this.Ma=[],this.aa=new it({label:"openOneTabOnStartLock"}),this.ia=new it({label:"duplicateCheck"}),this.sa=new it({label:"stateLock"}),this.Ht=new it({label:"settingsLock"})}async A(){return{pong:String(ct)}}async Sa(){await this.Ht.jt();try{let t=await S().get("extensionKey");return t||(t=Kt(),await S().put("extensionKey",t)),t}finally{this.Ht.release()}}async ze(t){let e=await st(!1);for(let a=0;a<e.length;a++)await this.Re({Oe:e[a],Me:!0,Be:t,ft:a===0})}async qt(t){let e=me(t),a=!0;try{await yt(1e3,t+" tabs completed loading",async()=>!(await g()).find(l=>l.status==="loading"&&l.title===e.substring(e.indexOf("://")+"://".length)))}catch{console.log("showOrRefreshAndFocusScriptPage loading wait failed")}let s=await g(),n=s.filter(l=>[l.url,l.pendingUrl].some(u=>u===e)),o=n.length>0?n[0]:void 0;n.length>1&&n.filter(l=>l!==o).forEach(l=>I(l)),o?(a&&de(o),o=s.find(l=>[l.url,l.pendingUrl].some(u=>u===e)),await U(o)):await nt(e,!1,!0)}async na(t,e){if(D){let y=t.tabsMeta.filter(T=>!z(T.url)),f=[];for(const[T,A]of y.entries()){let L={active:D&&T===0,url:A.url};try{f.push(await F(L))}catch(R){console.log(R)}await chrome.tabs.update(f[0].id,{active:!0})}return}let a=await at(),s=await Z(),n=s&&t.groupType==="tabGroup",o=t.tabsMeta.filter(y=>!z(y.url)),l=await this.getSettings(),u=P("restoreWindow",l);e==="currentWindow"&&(u="currentWindow"),e==="newWindow"&&(u="newWindow");let d=(await J()).tabs.filter(y=>!(y.pinned||G(y.url)||ue(y.url))).length,b=[],p;if(u==="currentWindow"||u==="newWindow"&&e!=="newWindow"&&d===0){p=await q(!1);for(const[y,f]of o.entries()){let T={active:D&&y===0,url:K(f.url,a)};p!==void 0&&(T.windowId=p.id),T.pinned=!n&&!!f.pinned;try{let A=await F(T);b.push(A)}catch(A){console.log(A)}}}else{let{Ie:y,Pe:f}=await gt(o.map(T=>({...T,pinned:!n&&T.pinned})));p=y,b.push(...f)}if(n){let y=await chrome.tabs.group({createProperties:{windowId:p.id},tabIds:b.map(T=>T.id)}),f={};t.color&&(f.color=t.color),t.label&&(f.title=t.label),Object.keys(f).length>0&&s&&await chrome.tabGroups.update(y,f)}await this.Ga()}async lt(t){let e=await this.getState(),a=t.split(`
`),s=new Date().getTime(),n=()=>({createDate:s--,tabsMeta:[],id:tt()}),o=n(),l=[];for(let d of a)if(!d)o.tabsMeta.length>0&&(l.push(o),o=n());else{let b,p;d.indexOf(" | ")!==-1?(b=O(d.substring(0,d.indexOf(" | "))),p=d.substring(d.indexOf(" | ")+" | ".length)):(b=O(d),p=H(b)),o.tabsMeta.push({id:v(),url:b,title:et(p)})}o.tabsMeta.length>0&&l.push(o);let u=Math.max(0,e.tabGroups.findIndex(d=>!d.starred)),w=l.map((d,b)=>({type:"createTabGroup",tabGroupId:d.id,tabGroup:d,index:u+b}));for(let d of w)await this.vt(d)}async vt(t,e){await this.sa.jt();try{let a=await this.getState();if(t.type==="createTabGroup")e?a.tabGroups.splice(a.tabGroups.findIndex(s=>s.id===t.tabGroupId),1):a.tabGroups.splice(t.index,0,t.tabGroup);else if(t.type==="createTabs"){let s=a.tabGroups.find(n=>n.id===t.tabGroupId);if(!e)s.tabsMeta.unshift(...t.newTabsMeta);else{let n=new Set(t.newTabsMeta.map(o=>o.id));s.tabsMeta=s.tabsMeta.filter(o=>!n.has(o.id))}}else if(t.type==="deleteTabs"){let s=a.tabGroups.find(n=>n.id===t.tabGroupId);if(e){let n=[];t.tabsMetaDeleted.forEach((o,l)=>n.push([o,t.tabIndicesDeleted[l]])),n.sort((o,l)=>o[1]-l[1]),n.forEach(([o,l])=>s.tabsMeta.splice(l,0,o))}else{let n=new Set(t.tabMetaIds);s.tabsMeta=s.tabsMeta.filter(o=>!n.has(o.id))}}else if(t.type==="deleteTabGroup")if(e)a.tabGroups.splice(Math.max(0,t.index),0,t.deletedTabGroup);else{let s=a.tabGroups.findIndex(n=>n.id===t.tabGroupId);a.tabGroups.splice(s,1)}else if(t.type==="updateTabGroup"){let s=e?"old":"new",n=e?"new":"old",o=a.tabGroups,l=o.find(w=>w.id===t.tabGroupId),u=t.propChanges;u.starred&&(l.starred=u.starred[s],l.starredDate=u.starredDate[s]),u.label&&(l.label=u.label[s]),u.locked&&(l.locked=u.locked[s]),u.groupType&&(l.groupType=u.groupType[s]),u.index&&o.splice(u.index[s],0,...o.splice(u.index[n],1))}else if(t.type==="reorderTab"){let s=a.tabGroups.find(u=>u.id===t.tabGroupId),n=s.tabsMeta.findIndex(u=>u.id===t.tabMetaId),o=s.tabsMeta[n],l=t.newIndex;e&&(l=n,n=t.newIndex),s.tabsMeta.splice(n,1),s.tabsMeta.splice(Math.min(l,s.tabsMeta.length),0,o)}else if(t.type==="moveTabBetweenTabGroups"){let s=a.tabGroups.findIndex(l=>l.id===t.sourceTabGroupId),n=a.tabGroups[s],o=a.tabGroups.find(l=>l.id===t.targetTabGroupId);if(e){let l=o.tabsMeta.findIndex(w=>w.id===t.tabMetaId),u=o.tabsMeta.splice(l,1)[0];t.deletedSourceTabGroup?a.tabGroups=a.tabGroups.splice(t.sourceTabGroupIndex,0,t.deletedSourceTabGroup):n.splice(t.sourceTabGroupTabIndex,0,u)}else{let l=n.tabsMeta.findIndex(w=>w.id===t.tabMetaId),u=n.tabsMeta.splice(l,1)[0];o.tabsMeta.splice(t.targetTabGroupTabIndex,0,u),t.deletedSourceTabGroup&&(a.tabGroups=a.tabGroups.filter(w=>w.id!==t.deletedSourceTabGroup.id))}}await this.Kt(a),await this.Ia(t,e)}finally{this.sa.release()}}async Wa(){let t=await this.getState(),e=[],a=new Date().getTime();for(let o=0;o<200;o++){let l={createDate:a--,tabsMeta:[],label:"tab group "+o,id:tt()};e.push(l);for(let u=0;u<20;u++)l.tabsMeta.push({id:v(),url:"https://en.wikipedia.org/wiki/"+(20*o+u),title:"wikipedia "+(20*o+u)})}let s=Math.max(0,t.tabGroups.findIndex(o=>!o.starred)),n=e.map((o,l)=>({type:"createTabGroup",tabGroupId:o.id,tabGroup:o,index:s+l}));for(let o of n)await this.vt(o);await this.ft()}async Ga(){if((await r.ra())?.pinned)return;if((await this.getState()).tabGroups.map(a=>a.tabsMeta.length).reduce((a,s)=>a+s,0)===0){let s=(await g()).find(n=>G(n.url));s&&await I(s)}}async getSettings(){let t=await S().get("settings");return t?JSON.parse(t):{}}async Ue(t,e){await this.Ht.jt();try{let a=await this.getSettings();a[t]=e,await this._e(a)}finally{this.Ht.release()}}async _e(t){await S().put("settings",JSON.stringify(t))}async Aa(t){let e=await this.getSettings();return P(t,e)}async getState(){let t=await S().get("state");return t?JSON.parse(t):{}}async Kt(t){await this.oa(t);let e=await S().get("state"),a=e;await S().put("state",JSON.stringify(t)),e=await S().get("state");try{JSON.parse(e)}catch{await S().put("state",a),console.log("Could not store extension state")}finally{}}async la(t,e,a){let s={id:v(),url:O(t),title:et(e)};await this.ua(s,a)}async Oa(t,e){if(G(t.url))return;let a={id:v(),url:O(t.url),title:et(t.title)};["pinned","incognito"].filter(s=>t[s]).forEach(s=>a[s]=t[s]),await this.ua(a,e),await I(t)}async ua(t,e){if(t={...t},t.url=O(t.url),z(t.url)){console.log(`Cannot import tabs of this type: ${t.url}`);return}let a=await this.getState();if(e===void 0){let s=a.tabGroups.find(n=>!n.starred&&!n.locked);if(s)await this.vt({type:"createTabs",tabGroupId:s.id,newTabsMeta:[t]});else{s={id:v(),tabsMeta:[t],createDate:new Date().getTime()};let n=Math.max(0,a.tabGroups.findIndex(o=>!o.starred));await this.vt({type:"createTabGroup",tabGroupId:s.id,tabGroup:s,index:n})}}else await this.vt({type:"createTabs",tabGroupId:e,newTabsMeta:[t]})}Vt(t,e,a){return t.pinned&&P("pinnedTabs",a)==="ignore"||G(e)||e.indexOf("chrome-devtools://")===0}Ca(t,e,a){return we(e)&&!G(e)||z(e)||P("duplicates",a)==="reject"&&t.tabGroups.some(s=>s.tabsMeta.some(n=>O(n.url)===e))}async Fe(){return((await this.getState())?.tabGroups??[]).filter(a=>a.label&&a.label!=="")}async Re({Oe:t,Me:e,Be:a,ft:s}){if(!t.length)return;const n=Symbol();let o=await Z(),l=o?await chrome.tabGroups.query({windowId:t[0].windowId}):[],u=await this.getSettings(),w=await this.getState(),d=new Set((await g()).map(f=>f.id)),b=t.filter(f=>d.has(f.id)&&(!e||!this.wa(O(f.url),u)));b.sort((f,T)=>f.index-T.index);let p=[],y=[];for(let f of b){let T=f.url;!T&&f.pendingUrl&&(T=f.pendingUrl);let A=O(T);if(!this.Vt(f,A,u)){y.push(f);let L=p.find(R=>R[n]===f.groupId);if(!this.Ca(w,A,u)&&!(L?.tabsMeta??[]).some(R=>R.url===A)){let R={id:v(),url:A,title:et(f.title)};if(f.pinned&&(R.pinned=!0),!L){let wt=o&&f.groupId!==chrome.tabGroups.TAB_GROUP_ID_NONE&&l.find($t=>$t.id===f.groupId);L={[n]:f.groupId,id:v(),tabsMeta:[],createDate:new Date().getTime(),...wt?{groupType:"tabGroup",color:wt.color,label:wt.title}:{}},p.push(L)}L.tabsMeta.push(R)}}}for(let f of p)delete f[n];if(p.length)if(a===void 0){let f=Math.max(0,w.tabGroups.findIndex(A=>!A.starred)),T=0;for(let A of p)await this.vt({type:"createTabGroup",tabGroupId:A.id,tabGroup:A,index:f+T++})}else{let f=p.flatMap(T=>T.tabsMeta);await this.vt({type:"createTabs",tabGroupId:a,newTabsMeta:f})}y.length===0?await r.ft(!1,void 0):await be(y,s)}wa(t,e){return this.Ge(H(t),e)}Ge(t,e){if(e.excludedDomains){for(let a of e.excludedDomains)if(a===t)return!0}return!1}async ca(t){await this.Ht.jt();try{let e=await this.getSettings();this.Ge(t,e)||(e.excludedDomains||(e.excludedDomains=[]),e.excludedDomains.push(t),await this._e(e))}finally{this.Ht.release()}}async Qe(t){await this.Ht.jt();try{let e=await this.getSettings();if(!e.excludedDomains)return;e.excludedDomains=e.excludedDomains.filter(a=>a!==t),await this._e(e)}finally{this.Ht.release()}}async oa(t){let e=!1;return t.tabGroups.forEach(a=>{a.tabsMeta&&a.tabsMeta.some(s=>!s)&&(a.tabsMeta=a.tabsMeta.filter(s=>s),e=!0)}),t.tabGroups.some(a=>!a.tabsMeta||!a.tabsMeta.length)&&(e=!0,t.tabGroups=t.tabGroups.filter(a=>a.tabsMeta&&a.tabsMeta.length)),e&&console.log("State fixed"),e}async Ea(){await S().get("installDate")||await S().put("installDate",new Date().getTime());let e=await this.getState();e.tabGroups||(e.tabGroups=[],await this.Kt(e)),await this.oa(e)&&await this.Kt(e),[...e.tabGroups].sort(Tt).every((a,s)=>a===e.tabGroups[s])||(console.log("Tabgroups correctly reordered"),e.tabGroups.sort(Tt),await this.Kt(e))}async Pa(t){(await chrome.windows.get(t)).incognito&&(t=void 0),await this.ft(!1,t)}async Se(t,e){let{activeTab:a}=await _(e?.windowId);await this.Oa(a,t)}async ka(t,e,a){let n=t.linkUrl,o=t.frameId,l=o!==void 0?[o]:[],u=t.linkTitle;if(u||(u=t.linkText),u||(u="untitled"),u)await this.la(n,u,a);else{await chrome.scripting.executeScript({target:{tabId:e.id,frameIds:l},files:["ext-onetab-concatenated-sources-contentscript.js"]});let w=await new Promise((b,p)=>{chrome.tabs.sendMessage(e.id,{type:"getLinkTitle",url:n},{frameId:o},y=>{chrome.runtime.lastError?p(chrome.runtime.lastError.message):b(y.title)})});await this.la(n,w,a);let d="Pbclevtug BarGno Ygq jjj.bar-gno.pbz"}}async je(t,e){let{tabs:a,activeTab:s}=await _(e?.windowId),n=a.filter(o=>o.groupId===s.groupId);if(n.length===1&&G(s.url)){let o=a.find(l=>l.groupId!==s.groupId);o&&(n=a.filter(l=>l.groupId===o.groupId))}await this.Re({Oe:n,Me:!0,Be:t,ft:!0})}async Ee(t,e){let{tabs:a,activeTab:s}=await _(e?.windowId);a=a.filter(o=>o.groupId===s.groupId);let n=[];if(s){for(let o of a)parseInt(o.index)!==parseInt(s.index)&&n.push(o);n.length>0&&await this.Re({Oe:n,Me:!0,Be:t,ft:!1})}else console.log("no active tab")}async da(t,e){let{tabs:a,activeTab:s}=await _(e?.windowId);a=a.filter(o=>o.groupId===s.groupId);let n=[];if(s){for(let o of a)parseInt(o.index)<parseInt(s.index)&&n.push(o);n.length>0&&await this.Re({Oe:n,Me:!0,Be:t,ft:!1})}}async ha(t,e){let{tabs:a,activeTab:s}=await _(e?.windowId);a=a.filter(o=>o.groupId===s.groupId);let n=[];if(s){for(let o of a)parseInt(o.index)>parseInt(s.index)&&n.push(o);n.length>0&&await this.Re({Oe:n,Me:!0,Be:t,ft:!1})}}async Bt(){return await r.Aa("pinned")==="true"}async xi(t){await this.ia.jt();try{if(await Mt(t)===void 0)return!1;let a=(await g()).filter(n=>G(n.url)&&n.id!==t),s;if(s=a,await Promise.all(s.slice(1).map(n=>xt(n.id))),s.length){let n=s[0];return await U(n),await ot(n.id),await xt(t),!0}else return await ot(t),!1}catch(e){return console.log(e),!1}finally{this.ia.release()}}async ft(t,e){if(D){let l=await g(),u=l.find(w=>[w.url,w.pendingUrl].some(d=>G(d)));if(u){await chrome.tabs.update(u.id,{active:!0});let w=l.filter(d=>d.id!==u.id&&[d.url,d.pendingUrl].some(b=>G(b)));await Promise.all(w.map(d=>I(d)))}else await F({url:c,active:!0});return}let a=!t,s=await g(),n=await q(!1),o=s.filter(l=>[l.url,l.pendingUrl].some(u=>G(u))).sort(_t(ft(l=>l.windowId===e),ft(l=>!!l.active),...n&&!n?.incognito?[ft(l=>l.windowId===n.id)]:[])).find(()=>!0);if(o)await Promise.all(s.filter(l=>!(l.pinned&&!1)&&[l.url,l.pendingUrl].some(u=>G(u))&&l.id!==o.id).map(l=>I(l))),a&&await U(o);else{let l={url:c,...await this.Bt()?{pinned:!0,index:0}:{},active:a},u=!1;if(e!==void 0)l.windowId=e;else{let w=n;if(w?.incognito&&(w=(await k(!1)).find(d=>!d.incognito)),w)l.windowId=w.id;else{u=!0;let d=await vt({});if(d?.id){let b=await E().get("lastCreateNewWindowTrigger");b&&new Date().getTime()-b<5e3||(await E().put("lastCreateNewWindowTrigger",new Date().getTime()),await this.ft(t,d.id))}}}u||await F(l)}}static zt(t,e,a,s){t[e]={old:a[e],new:s[e]}}async gi(t,e){let s=(await this.getState()).tabGroups,n=s.find(u=>u.id===t),o={},l=!1;if(e.hasOwnProperty("starred")&&($.zt(o,"starred",n,e),$.zt(o,"starredDate",n,e)),e.hasOwnProperty("label")&&($.zt(o,"label",n,e),l=!0),e.hasOwnProperty("locked")&&$.zt(o,"locked",n,e),e.hasOwnProperty("groupType")&&$.zt(o,"groupType",n,e),e.hasOwnProperty("starred")){n.starred=e.starred,n.starredDate=e.starredDate;let u=s.findIndex(d=>d.id===t),w=[...s].sort(Tt).findIndex(d=>d.id===t);o.index={old:u,new:w}}await this.vt({type:"updateTabGroup",tabGroupId:t,propChanges:o}),l&&Y()}async Mi(t,e){let s=(await this.getState()).tabGroups,n=s.findIndex(b=>b.id===t),o=s[n],l=JSON.parse(JSON.stringify(o)),u=o.tabsMeta.find(b=>b.id===e),w=o.tabsMeta.findIndex(b=>b.id===e);o.tabsMeta.length===1&&o.tabsMeta[0].id===e?(await this.vt({type:"deleteTabGroup",tabGroupId:o.id,deletedTabGroup:l,index:n}),o.label&&Y()):await this.vt({type:"deleteTabs",tabGroupId:o.id,tabMetaIds:[e],tabsMetaDeleted:[u],tabIndicesDeleted:[w]})}async Si(t,e,a){let s=await this.getState(),n=s.tabGroups.findIndex(l=>l.id===t),o=s.tabGroups[n];await this.vt({type:"deleteTabGroup",tabGroupId:o.id,deletedTabGroup:o,index:n}),o.label&&Y(),e&&await this.na(o,a)}async Gi(t,e,a){let n=(await this.getState()).tabGroups.find(w=>w.id===t),o=n.tabsMeta.findIndex(w=>w.id===e),l=n.tabsMeta[o],u;a!==void 0?u=n.tabsMeta.filter(w=>w.id!==e).findIndex(w=>w.id===a):u=Math.max(0,n.tabsMeta.length-1),await this.vt({type:"reorderTab",tabMetaId:l.id,tabGroupId:n.id,oldIndex:o,newIndex:u})}async Ii(t,e,a,s){let n=await this.getState(),o=n.tabGroups.findIndex(f=>f.id===t),l=n.tabGroups[o],u=JSON.parse(JSON.stringify(l)),w=l.tabsMeta.findIndex(f=>f.id===a),d=n.tabGroups.find(f=>f.id===e),b;s!==void 0?b=d.tabsMeta.findIndex(f=>f.id===s):b=d.tabsMeta.length;let p=l.tabsMeta.length===1&&l.tabsMeta[0].id===a,y={type:"moveTabBetweenTabGroups",tabMetaId:a,sourceTabGroupId:l.id,targetTabGroupId:d.id,sourceTabGroupTabIndex:w,targetTabGroupTabIndex:b,sourceTabGroupIndex:o};p&&(y.deletedSourceTabGroup=u),await this.vt(y),p&&l.label&&Y()}Wi(t){this.Ma=[t]}async ra(){return(await chrome.tabs.query({})).find(t=>t.url?.startsWith(c))}async Ia(t,e){let a={Ai:t,undo:e},s=await this.ra();if(s){kt()&&+new Date-(await E().get("aliveIndicator")??0)>2e4&&await Dt(s);try{let n=!1;kt()&&setTimeout(()=>{n||Dt(s)},1e3);let o=await chrome.tabs.sendMessage(s.id,{type:"stateChange",k:a});return n=!0,o}catch{}}}async Oi(t,e){let a=new Set(t||[]),s=await qt(Wt+"/api/createPage",{key:await r.Sa(),tabGroups:(await this.getState()).tabGroups.filter(n=>e||a.has(n.id))});await nt(s.url,!1,!0)}async Ci(t,e){let n=(await r.getState()).tabGroups.find(o=>o.id===t);await r.na(n,e)}async Da(){return await nt(...arguments)}async Fa(){return await F(...arguments)}async Ei(){return await gt(...arguments)}async yt(t,e){e||(e={});let a=(await g()).find(s=>G(s.url));if(!a)throw new Error("OneTab tab not found");try{return await new Promise((s,n)=>{chrome.tabs.sendMessage(a.id,{type:t,...e},o=>{chrome.runtime.lastError?n(chrome.runtime.lastError.message):o&&o.error?n(o.error):s(o)})})}catch(s){throw new Error(s)}}async kt(){return await E().get("contextMenuState")??{}}async Xe(t){await E().put("contextMenuState",t)}async Ra(){await S().put("lastSeenVersion","restoreTest"),await Nt()}async va(t){await new Ut().ba(t)}async Ba(t,e){for(let a=0;a<t;a++)await new Ut().ba(e)}async fa(){let t=await r.getSettings();return P("oneTabTabState",t)||{}}async Ye(t){await r.Ue("oneTabTabState",t)}async Pi(t){let e=await this.fa();Object.entries(t).forEach(([a,s])=>e[a]=s),await this.Ye(e)}}async function Ft(){return new Promise((i,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{chrome.runtime.lastError?t(chrome.runtime.lastError.message):e&&e.length===1?i(e[0]):t("No current tab found")})})}function ue(i){return!!(i===""||ge.some(t=>i.indexOf(t)===0))}function G(i){return i&&i.indexOf(c)===0}function we(i){return i&&i.indexOf(j)===0}async function _(i){if(i!==void 0){let t=await chrome.tabs.query({windowId:i});return{tabs:t,activeTab:t.find(e=>e.active)}}else return await J()}async function J(){return new Promise((i,t)=>{(async()=>{let e={};if(chrome.windows){let a=await q(!1);if(a===void 0){i(void 0);return}e={windowId:a.id}}chrome.tabs.query(e,a=>{if(chrome.runtime.lastError)t(chrome.runtime.lastError.message);else{let s;for(let n of a)if(n.active){s=n;break}i({tabs:a,activeTab:s})}})})()})}async function ce(i){return new Promise((t,e)=>{(async()=>chrome.tabs.query({windowId:i},a=>{if(chrome.runtime.lastError)e(chrome.runtime.lastError.message);else{let s;for(let n of a)if(n.active){s=n;break}t({tabs:a,activeTab:s})}}))()})}async function g(){return new Promise((i,t)=>{chrome.tabs.query({},e=>{chrome.runtime.lastError?t(chrome.runtime.lastError.message):i(e)})})}async function st(i){let t;return chrome.windows&&(t=await q(!1)),new Promise((e,a)=>{chrome.tabs.query({},s=>{if(chrome.runtime.lastError)a(chrome.runtime.lastError.message);else{let n=new Map;for(let l of s){let u=l.windowId;i&&t&&u===t.id||(n.has(u)||n.set(u,[]),n.get(u).push(l))}let o=Array.from(n.values());e(o)}})})}async function de(i){return new Promise((t,e)=>{chrome.tabs.reload(i.id,{},()=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t()})})}async function I(i){return await xt(i.id)}async function xt(i){return new Promise((t,e)=>{chrome.tabs.remove(i,()=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError.message),t()})})}async function Rt(i){return new Promise((t,e)=>{chrome.windows.remove(i,()=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t()})})}function he(i,t){let e=new Map;return i.forEach(a=>{let s=a[t];e.has(s)||e.set(s,[]),e.get(s).push(a)}),e}async function be(i,t){if(i.length===0)return;if(D){await Promise.all(i.map(w=>I(w))),t&&await r.ft();return}let e=i.some(w=>!w.pinned)?i.find(w=>!w.pinned).windowId:i[0].windowId,a=!!(await k(!1)).find(w=>w.id===e).incognito,s=await g(),n=he(s,"windowId"),o=n.get(e).filter(w=>!w.pinned&&!i.some(d=>d.id===w.id)).length===0,l=n.get(e).filter(w=>!i.some(d=>d.id===w.id)).length>0,u=(await k(!0)).filter(w=>!w.incognito&&w.id!==e);if(u.length>0)if(!l||!1)t?await r.ft(!1,u[0].id):await U(u[0].tabs[0]),await Rt(e);else{if(t){let d=a?u[0].id:e;await r.ft(!1,d)}await Promise.all(i.map(d=>I(d)))}else t&&await r.ft(!1,a?void 0:e),await Promise.all(i.map(w=>I(w)))}async function U(i){return new Promise((t,e)=>{chrome.tabs.update(i.id,{active:!0},()=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):chrome.windows?chrome.windows.update(i.windowId,{focused:!0},()=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t()}):t()})})}async function F(i){return i={...i},chrome.windows||delete i.windowId,D&&delete i.pinned,new Promise((t,e)=>{chrome.tabs.create(i,a=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(a)})})}async function vt(i){return new Promise((t,e)=>{chrome.windows.create(i,a=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(a)})})}async function fe(i,t){return new Promise((e,a)=>{chrome.tabs.move(i,{index:t},()=>{chrome.runtime.lastError?a(chrome.runtime.lastError.message):e()})})}async function k(i){return new Promise((t,e)=>{chrome.windows.getAll({populate:!!i},a=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(a)})})}async function q(i){if(chrome.windows)return new Promise((t,e)=>{chrome.windows.getLastFocused({populate:!!i},a=>{chrome.runtime.lastError?t(void 0):t(a)})})}async function nt(i,t,e,a={}){if(a.url=i,a.pinned=!!t,a.active=!!e,chrome.windows){let s=await q(!1);s&&(a.windowId=s.id)}return await F(a)}async function gt(i){let t=await at(),e=await chrome.windows.create({url:K(i[0].url,t)}),a=[],s=await chrome.tabs.query({windowId:e.id}),n=!!i[0].pinned,o=s[s.length-1];n&&await chrome.tabs.update(o.id,{pinned:!0}),a.push(o);for(let l of i.slice(1)){let u=await F({url:K(l.url,t),pinned:!!l.pinned,windowId:e.id});a.push(u)}return{Ie:e,Pe:a}}function Te(){D||chrome.commands.onCommand.addListener(i=>{(async()=>(i==="display-onetab"&&await r.ft(),i==="send-current-tab-to-onetab"&&await r.Se(),i==="send-all-tabs-in-current-window-to-onetab"&&await r.je(),i==="send-all-tabs-in-all-windows-to-onetab"&&await r.ze(void 0),i==="send-all-tabs-except-this-to-onetab"&&await r.Ee(void 0,void 0)))()})}function pe(i){["onCreated","onUpdated","onMoved","onRemoved","onReplaced","onDetached","onAttached","onActivated"].forEach(t=>chrome.tabs[t]?.addListener(()=>i())),["onFocusChanged","onCreated","onRemoved"].forEach(t=>chrome.windows?.[t].addListener(()=>i()))}let rt;async function Bt(){if(rt)return rt.value;{let i=await E().get("oneTabTabId");return rt={value:i},i}}async function ot(i){rt={value:i},i===void 0?await E().remove("oneTabTabId"):await E().put("oneTabTabId",i)}async function lt(i){await r.Ue("pinned",`${!!i}`)}function ye(){chrome.tabs.onRemoved.addListener(async(i,{windowId:t,isWindowClosing:e})=>{i===await Bt()&&await ot(void 0)}),chrome.tabs.onUpdated.addListener(async(i,t,e)=>{try{let a=[e.url,e.pendingUrl].some(n=>G(n));i===await Bt()&&!a&&e.pinned&&(await ot(void 0),await Q(i,{pinned:!1})),a&&Object.hasOwn(t,"pinned")&&await lt(t.pinned)}catch(a){console.log(a)}})}function me(i){return chrome.runtime.getURL(i)}async function xe(){chrome.runtime.reload()}const ge=[...["newtab","home","welcome","welcomeback"].map(i=>"about:"+i),...["newtab","new-tab-page"].map(i=>dt+i+"/")];async function Mt(i){return new Promise((t,e)=>{chrome.tabs.get(i,a=>{chrome.runtime.lastError?t(void 0):t(a)})})}async function Lt(i){return new Promise((t,e)=>{chrome.tabs.query({},a=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(a.filter(s=>s.url===i))})})}async function St(i){let t=await Lt(i);if(t.length===0)throw new Error("No tab found with URL: "+i);if(t.length>1)throw new Error("More than one tab found with URL: "+i);return t[0]}async function Q(i,t){return new Promise((e,a)=>{chrome.tabs.update(i,t,()=>{chrome.runtime.lastError?a(chrome.runtime.lastError.message):e()})})}async function Gt(i,t){i!==void 0&&(t.parentId=i);let e={};return e.id=bt(),t.id=e.id,t.title!==void 0&&(t.title=String(t.title).replaceAll("&","&&")),await chrome.contextMenus.create(t),e}async function It(i,t){i[x]=+!!t,await chrome.contextMenus.update(i.id,{enabled:t})}async function Me(i,t){i[C]=+!!t,await chrome.contextMenus.update(i.id,{type:"checkbox",checked:t})}async function Se(i,t,e){e&&(i.title=t),await chrome.contextMenus.update(i.id,{title:t})}async function W(i,t,e){i!==void 0&&(e.parentId=i.id);let a={[C]:+!!e.checked,[x]:+!!e.enabled,id:bt().slice(0,10)};return t&&(a[B]=t,a[C]=1,a[x]=1),e.id=a.id,await chrome.contextMenus.create(e),a}async function Ge(){await chrome.contextMenus.removeAll()}async function ut(i){let t={type:"separator",contexts:["all"],id:bt().slice(0,10)};i&&(t.parentId=i.id),await chrome.contextMenus.create(t)}function Ie(i){i.rootContextMenu=void 0,i.displayOneTabMenu=void 0,i.namedTabGroupsMenu=void 0,i.sendAllTabsInCurrentWindowMenus=[],i.sendCurrentTabMenus=[],i.sendTabsToTheLeftMenus=[],i.sendTabsToTheRightMenus=[],i.sendAllTabsInAllWindowsMenus=[],i.sendTabsExceptThisMenus=[],i.sendThisWebLinkMenus=[],i.excludeWebSiteContextMenu=void 0,i.helpMenu=void 0}async function V(i,t){await Promise.all(i.map(e=>e.map(a=>It(a,t)).flat()))}async function X(){let i=await r.kt();if(i.rootContextMenu&&await q(!1)!==void 0)try{let t=await r.getSettings(),e=await st(!0),a=await J();if(!a)return;let{tabs:s,activeTab:n}=a,o=G(n.url);await It(i.displayOneTabMenu,!o);let l=O(n.url);await It(i.excludeWebSiteContextMenu,!o);let u=l&&l.toLowerCase().indexOf("http")===0?M("excludeDomainFromOneTab").replace("DOMAIN.COM",H(l)):M("excludeWebSiteFromOneTab");await Se(i.excludeWebSiteContextMenu,u,!0),await Me(i.excludeWebSiteContextMenu,r.wa(l,t));let w=!1,d=!1,b=!1,p=!1,y=!1;if(n){let f=parseInt(n.index);w=s.some(T=>parseInt(T.index)<f&&T.url&&!r.Vt(T,O(T.url),t)),d=s.some(T=>parseInt(T.index)>f&&T.url&&!r.Vt(T,O(T.url),t)),p=s.some(T=>T.url&&!r.Vt(T,O(T.url),t)),b=s.some(T=>T.id!==n.id&&T.url&&!r.Vt(T,O(T.url),t))}y=e.some(f=>f.some(T=>T.url&&!r.Vt(T,O(T.url),t))),await V([i.sendAllTabsInCurrentWindowMenus.slice(0,1)],p),await V([i.sendCurrentTabMenus.slice(0,1)],!(o||!p)),await V([i.sendTabsToTheLeftMenus.slice(0,1)],w),await V([i.sendTabsToTheRightMenus.slice(0,1)],d),await V([i.sendAllTabsInAllWindowsMenus.slice(0,1)],y),await V([i.sendTabsExceptThisMenus.slice(0,1)],b),await r.Xe(i)}catch{console.trace()}}async function Y(){if(!chrome.contextMenus)return;let i=await r.kt();await Ge(),Ie(i),await Ae(i),await r.Xe(i),await X()}async function We(){await r.Xe({})}async function Ae(i){i.rootContextMenu=await Gt(void 0,{type:"normal",contexts:["all"],title:"OneTab"}),i.displayOneTabMenu=await W(i.rootContextMenu,void 0,{type:"normal",title:M("displayOneTab"),contexts:["all"]});let t=await W(i.rootContextMenu,void 0,{type:"normal",title:M("sendAllTabsToOneTab"),contexts:["all"]});i.sendAllTabsInCurrentWindowMenus.push(t);let e=await W(i.rootContextMenu,void 0,{type:"normal",title:M("sendThisWebLinkToOneTab"),contexts:["link"]});i.sendThisWebLinkMenus.push(e),await ut(i.rootContextMenu);let a=await W(i.rootContextMenu,void 0,{type:"normal",title:M("sendOnlyThisTabToOneTab"),contexts:["all"]});i.sendCurrentTabMenus.push(a);let s=await W(i.rootContextMenu,void 0,{type:"normal",title:M("sendAllTabsExceptThisToOneTab"),contexts:["all"]});i.sendTabsExceptThisMenus.push(s);let n=await W(i.rootContextMenu,void 0,{type:"normal",title:M("sendLeftTabsToOneTab"),contexts:["all"]});i.sendTabsToTheLeftMenus.push(n);let o=await W(i.rootContextMenu,void 0,{type:"normal",title:M("sendRightTabsToOneTab"),contexts:["all"]});i.sendTabsToTheRightMenus.push(o);let l=await W(i.rootContextMenu,void 0,{type:"normal",title:M("sendAllTabsAllWindowsToOneTab"),contexts:["all"]});i.sendAllTabsInAllWindowsMenus.push(l),await ut(i.rootContextMenu),i.excludeWebSiteContextMenu=await W(i.rootContextMenu,void 0,{type:"checkbox",checked:!1,contexts:["all"],title:M("excludeWebSiteFromOneTab")}),i.excludeWebSiteContextMenu.title=M("excludeWebSiteFromOneTab");let w=(await r.getState()).tabGroups;w||(w=[]),w=w.slice(0,500);let d=w.filter(b=>b.label&&b.label!=="");if(d.length){await ut(i.rootContextMenu),i.namedTabGroupsMenu=await Gt(i.rootContextMenu.id,{type:"normal",contexts:["all"],title:M("namedTabGroups")});for(let b of d){let p=await Gt(i.namedTabGroupsMenu.id,{type:"normal",contexts:["all"],title:b.label});i.sendAllTabsInCurrentWindowMenus.push(await W(p,b.id,{type:"normal",title:M("sendAllTabsToPlaceholder").replace("PLACEHOLDER",b.label),contexts:["all"]})),i.sendThisWebLinkMenus.push(await W(p,b.id,{type:"normal",title:M("sendThisWebLinkToPlaceholder").replace("PLACEHOLDER",b.label),contexts:["link"]})),i.sendCurrentTabMenus.push(await W(p,b.id,{type:"normal",title:M("sendOnlyThisTabToPlaceholder").replace("PLACEHOLDER",b.label),contexts:["all"]})),d.length&&(i.sendTabsExceptThisMenus.push(await W(p,b.id,{type:"normal",title:M("sendAllTabsExceptThisTabToPlaceholder").replace("PLACEHOLDER",b.label),contexts:["all"]})),i.sendTabsToTheLeftMenus.push(await W(p,b.id,{type:"normal",title:M("sendLeftTabsToPlaceholder").replace("PLACEHOLDER",b.label),contexts:["all"]})),i.sendTabsToTheRightMenus.push(await W(p,b.id,{type:"normal",title:M("sendRightTabsToPlaceholder").replace("PLACEHOLDER",b.label),contexts:["all"]})))}}await ut(i.rootContextMenu),i.helpMenu=await W(i.rootContextMenu,void 0,{type:"normal",title:M("help"),contexts:["all"]})}class Ut{async ba(t){try{if(!At&&ht&&!await Z())throw new Error("Need tab groups permission");for(let e=0;e<2;e++){await this.Ct(m);let a=e===0;await lt(a),console.log(`begin tests with pinned: ${a}`),await this.La(t.pdfFileUrl),await this.Ua(a),await this.Na(),await Z()&&(await this.$a(),await this.ja()),await this.Ha(),await this.Ja(),await this.qa(),await this.Va(),await this.Ka(),a&&await this.za(),await this._a(),await this.Qa(),await this.Xa(),await this.Ya(),await this.Ta({ctrlKey:!0}),await this.Ta({metaKey:!0}),await this.Za(),await this.ti(),await this.ei(),await this.ai(),await this.ii(),await this.si(),await this.ni(),await this.ri(),await this.oi(),await this.li(),await this.ui(),await this.wi(),console.log(`tests completed with pinned: ${a}`)}console.log("all tests completed")}finally{let e=dt+"extensions/";e=m,await this.Ct(e);let a=await r.getState();a.tabGroups=a.tabGroups.filter(s=>s.tabsMeta.every(n=>!(n.title.startsWith("t---")||n.title.startsWith("PIN::t---")||n.url.startsWith("http://localhost")||n.url===t.pdfFileUrl))),await r.Kt(a),await lt(!0),console.log("done.")}}async Ha(){let t=await r.Bt();console.log("begin testAutoUnPin");let e={bt:[this.Tt(),this.Tt(),this.Tt()]};await this.Gt(e,!0),await r.ft(),await this.Mt();let a=await St(c);this.assert((await Mt(a.id)).pinned===t),await Q(a.id,{url:this.Tt()}),await h(200),this.assert(!(await Mt(a.id)).pinned),await r.ft(),await this.Mt();let s=await St(c);this.assert(s.pinned===t)}async Ja(){console.log("begin testDuplicateOneTabTabAdded");let t={bt:[this.Tt(),this.Tt(),this.Tt()]};await this.Gt(t,!0),await r.ft(),await this.Mt();let a=(await St(c)).id;await F({url:c}),await F({url:c}),await h(500),this.assert((await Lt(c)).length===1),await this.Dt(c),this.assert((await Ft()).id===a)}async Xa(){console.log("begin testSimulateRestoreClick"),await this.Ct(m);let t={bt:[this.Tt(),this.Tt(),this.Tt(),this.Tt()]};await this.Gt(t,!0),await r.ft(),await this.Mt(),await r.je(),await r.yt("clickTab",{url:t.bt[0],Wt:{}}),await this.It({bt:[c,t.bt[0]]}),await this.Dt(c),await r.yt("clickTab",{url:t.bt[1],Wt:{shiftKey:!0}}),await this.ci(t.bt[1]),await this.Nt(t.bt[1]),await r.yt("clickTab",{url:t.bt[2],Wt:{ctrlKey:!0}}),await h(300),await this.Dt(c),await h(1e3),await this.St({bt:[c,t.bt[0],t.bt[2]]}),await r.yt("clickTab",{url:t.bt[3],Wt:{metaKey:!0}}),await h(300),await this.Dt(c),await h(1e3),await this.St({bt:[c,t.bt[0],t.bt[2],t.bt[3]]}),await this.Ot(0,[t.bt[1],t.bt[2],t.bt[3]])}async ei(){console.log("begin testTabsAddedToExistingGroup"),await this.Ct(m);let t={bt:[this.Tt(),this.Tt(),this.Tt()]};await this.Gt(t,!0),await r.ft(),await this.Mt();let e=await r.Bt();await this.It({bt:e?[c,...t.bt]:[...t.bt,c]}),await r.je(),await this.Ot(0,[...t.bt]),await this.It({bt:[c]});let a={bt:[this.Tt()]};await this.Gt(a,!1),await this.It({bt:[c,a.bt[0]]}),await this.Rt(a.bt[0]),await r.Se(),await h(200),await this.Ot(0,[a.bt[0],...t.bt])}async Ya(){console.log("begin testSimulateRestoreTabGroupClick"),await this.Ct(m);let t={bt:[this.Tt(),this.Tt(),this.Tt()]};await this.Gt(t,!0),await r.ft(),await this.Mt(),await h(200),await r.je(),await this.Ot(0,[...t.bt]),await this.It({bt:[c]}),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:t.bt[0],Wt:{}}),await h(200),await this.Jt(0,t.bt[0]),await this.It({bt:[c,...t.bt]}),await this.Dt(c)}async Ta(t){console.log("begin testSimulateRestoreTabGroupCtrlOrMetaClick"),await this.Ct(m);let e={bt:[this.Tt(),this.Tt(),this.Tt()]};await this.Gt(e,!0),await r.ft(),await this.Mt(),await h(200),await r.je(),await h(200),await this.Ot(0,[...e.bt]),await this.It({bt:[c]}),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:e.bt[0],Wt:t}),await h(200),await this.Ot(0,[...e.bt]),await this.It({bt:[c,...e.bt]}),await this.Dt(c)}async Za(){console.log("begin testSimulateRestoreTabGroupShiftClick"),await this.Ct(m);let t={bt:[this.Tt(),this.Tt(),this.Tt()]};await this.Gt(t,!0),await r.ft(),await this.Mt(),await h(200),await r.je(),await this.Ot(0,[...t.bt]),await this.It({bt:[c]}),await this.Mt(),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:t.bt[0],Wt:{shiftKey:!0}}),await this.Ot(0,[...t.bt]),await this.It({bt:[...t.bt],other:[[c]]})}async ti(){console.log("begin testSimulateDeleteTabGroupClick"),await this.Ct(m);let t={bt:[this.Tt(),this.Tt(),this.Tt()]};await this.Gt(t,!0),await r.ft(),await this.Mt(),await h(200),await r.je(),await h(200),await this.Ot(0,[...t.bt]),await this.$t(t.bt,0,!0),await this.di(t.bt[0]),await this.Mt(),await r.yt("clickTabGroupButton",{Et:"deleteAllButton",At:t.bt[0]}),await h(200),await this.Jt(0,t.bt[0]),await h(200),await this.hi(t.bt[0])}async Jt(t){let e=await r.yt("getVisibleStructure");this.assert(e.tabGroups.every(a=>!a.tabs.some(s=>s===t)))}async Ot(t,e){await h(200);let a=await r.yt("getVisibleStructure"),s=a.tabGroups.findIndex(n=>!n.Ze);this.assert(this.pa([e],a.tabGroups.slice(s+t,s+t+1).map(n=>n.tabs)),`assertUnstarredTabGroup fail: expected: ${e}`)}async Qa(){console.log("begin testOneTabTabUpdated"),await this.Ct(m);let t={bt:[this.Tt(),this.Tt()],gt:[[this.Tt(),this.Tt()],[this.Tt(),this.Tt()]]};await this.Gt(t,!0),await r.ft(!1),await this.Mt();let e=await r.Bt();await this.St({bt:e?[c,...t.gt[1]]:[...t.gt[1],c],other:[t.bt,...t.gt.slice(0,-1)]}),await r.ze(),await this.Mt();let a=await r.yt("getVisibleStructure");this.Lt(a.bi,a.tabGroups.reduce((n,o)=>n+o.fi,0),"visible total tab count === summed visible tabgroup counts"),this.Lt(a.bi,a.tabGroups.reduce((n,o)=>n+o.tabs.length,0),"visible total tab count === summed visible tabs"),this.assert(a.tabGroups.every(n=>n.fi===n.tabs.length));let s=a.tabGroups.findIndex(n=>!n.Ze);this.assert(a.tabGroups.every((n,o)=>o<s&&n.Ze||o>=s&&!n.Ze)),this.assert(this.pa([t.bt,...t.gt],a.tabGroups.slice(s,s+3).map(n=>n.tabs)))}pa(t,e){return t.map(a=>a.join(" ")).sort().join(`
`)===e.map(a=>a.join(" ")).sort().join(`
`)}async _a(){if(console.log("begin testOneTabTabComms"),await r.ft(!1),await this.Mt(),!(await r.yt("ping")).pong)throw new Error("comms test failed")}async Na(){console.log("begin testBrowserActionClick"),await this.Ct(m);let t={bt:[this.Tt(),this.Tt()],gt:[[this.Tt(),this.Tt()]]};await this.Gt(t,!0),await this.St({bt:t.gt[0],other:[t.bt]}),await this.Pt(),await this.Mt();let e=await r.Bt();await this.St({bt:e?[c,...t.bt]:[...t.bt,c],other:[]})}async $a(){console.log("begin testBrowserGroupSaveAndRestore");let t=[{$e:3,_t:[0,1,2],Qt:[3,4,5],He:!0,Je:async()=>await this.Pt()},{$e:1,_t:[3,4,5],Qt:[0,1,2],He:!1,Je:async()=>await this.Pt()},{$e:5,_t:[0,1,2,5],Qt:[3,4],He:!0,Je:async()=>(await r.da(),await r.ft())},{$e:3,_t:[0,1,2,3],Qt:[4,5],He:!0,Je:async()=>(await r.ha(),await r.ft())}];for(let e of t){await this.Ct(m);let a={bt:[this.Tt(),this.Tt(),this.Tt(),this.Tt(),this.Tt(),this.Tt()]},s=await this.Gt(a,!0);await this.St({bt:a.bt}),await chrome.tabs.group({createProperties:{windowId:s.bt[0].windowId},tabIds:s.bt.map(o=>o.id).slice(3)}),await this.Rt(a.bt[e.$e]),await e.Je(),await this.Mt();let n=await r.Bt();await this.St({bt:n?[c,...e._t.map(o=>a.bt[o])]:[...e._t.map(o=>a.bt[o]),c]}),await this.$t(e.Qt.map(o=>a.bt[o]),0,!0),await this.Mt(),this.assert((await r.yt("getTabGroupElementDisplayed",{Xt:"tabGroupImg",At:a.bt[e.Qt[0]]})).he===e.He)}}async ja(){console.log("begin testBrowserGroupSaveAndRestore2"),await this.Ct(m);let t={bt:[this.Tt(),this.Tt(),this.Tt(),this.Tt(),this.Tt(),this.Tt()],gt:[[this.Tt(),this.Tt()]]},e=await this.Gt(t,!0);await this.St({bt:t.gt[0],other:[t.bt]}),await chrome.tabs.group({createProperties:{windowId:e.bt[0].windowId},tabIds:e.bt.map(s=>s.id).slice(1,3)}),await chrome.tabs.group({createProperties:{windowId:e.bt[0].windowId},tabIds:e.bt.map(s=>s.id).slice(4,6)}),await r.ze(),await r.ft(),await this.Mt();let a=await r.Bt();await this.St({bt:[c]}),await this.$t([0,1].map(s=>t.gt[0][s]),0,!0),await this.$t([0,3].map(s=>t.bt[s]),1,!0),await this.$t([1,2].map(s=>t.bt[s]),2,!0),await this.$t([4,5].map(s=>t.bt[s]),3,!0),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:t.bt[4],Wt:{}}),await h(200),await this.Jt(0,t.bt[4]),await this.Jt(0,t.bt[5]),await this.It({bt:[c,...t.bt.slice(4)]}),await this.Dt(c)}async qa(){console.log("begin testContextMenus"),await this.Ct(m);let t={bt:[this.Tt(),this.Tt()],gt:[[this.Tt(),this.Tt()],[this.Yt(),this.Tt(),this.Tt()]]};await this.Gt(t,!0),await this.St({bt:t.gt[1],other:[t.bt,t.gt[0]]});let e=500;const a=(l,u,w)=>{const d=l[u].length;this.assert(d>0),this.assert(l[u][0][x]===+w)};await this.Rt(t.bt[0]),await h(e),await X();let s=await r.kt();a(s,"sendTabsToTheLeftMenus",!1),a(s,"sendTabsToTheRightMenus",!0),a(s,"sendAllTabsInAllWindowsMenus",!0),a(s,"sendTabsExceptThisMenus",!0),a(s,"sendAllTabsInCurrentWindowMenus",!0),this.assert(s.displayOneTabMenu[x]),this.assert(s.excludeWebSiteContextMenu[x]),this.assert(!s.excludeWebSiteContextMenu[C]),this.assert(s.excludeWebSiteContextMenu.title==="Exclude localhost from OneTab"),await this.Rt(t.bt[1]),await h(e),s=await r.kt(),a(s,"sendTabsToTheLeftMenus",!0),a(s,"sendTabsToTheRightMenus",!1),a(s,"sendAllTabsInAllWindowsMenus",!0),a(s,"sendTabsExceptThisMenus",!0),a(s,"sendAllTabsInCurrentWindowMenus",!0),a(s,"sendCurrentTabMenus",!0),this.assert(s.displayOneTabMenu[x]),this.assert(s.excludeWebSiteContextMenu[x]),this.assert(!s.excludeWebSiteContextMenu[C]),this.assert(s.excludeWebSiteContextMenu.title==="Exclude localhost from OneTab"),await this.Rt(t.gt[0][0]),await h(e),s=await r.kt(),a(s,"sendTabsToTheLeftMenus",!1),a(s,"sendTabsToTheRightMenus",!0),a(s,"sendAllTabsInAllWindowsMenus",!0),a(s,"sendTabsExceptThisMenus",!0),a(s,"sendAllTabsInCurrentWindowMenus",!0),a(s,"sendCurrentTabMenus",!0),this.assert(s.displayOneTabMenu[x]),this.assert(s.excludeWebSiteContextMenu[x]),this.assert(!s.excludeWebSiteContextMenu[C]),this.assert(s.excludeWebSiteContextMenu.title==="Exclude localhost from OneTab"),await this.Rt(t.gt[1][1]),await h(e),s=await r.kt(),a(s,"sendTabsToTheLeftMenus",!1),a(s,"sendTabsToTheRightMenus",!0),a(s,"sendAllTabsInAllWindowsMenus",!0),a(s,"sendTabsExceptThisMenus",!0),a(s,"sendAllTabsInCurrentWindowMenus",!0),a(s,"sendCurrentTabMenus",!0),this.assert(s.displayOneTabMenu[x]),this.assert(s.excludeWebSiteContextMenu[x]),this.assert(!s.excludeWebSiteContextMenu[C]),this.assert(s.excludeWebSiteContextMenu.title==="Exclude localhost from OneTab"),await r.ft(),await this.Mt();let n=await this.Zt();await fe(n.id,0);let o=await r.Bt();await this.St({bt:o?[c,...t.gt[1]]:[...t.gt[1],c],other:[t.bt,t.gt[0]]}),await this.Dt(c),await this.Mt(),await h(5*e),s=await r.kt(),o?(a(s,"sendTabsToTheLeftMenus",!1),a(s,"sendTabsToTheRightMenus",!0)):(a(s,"sendTabsToTheLeftMenus",!0),a(s,"sendTabsToTheRightMenus",!1)),a(s,"sendAllTabsInAllWindowsMenus",!0),a(s,"sendTabsExceptThisMenus",!0),a(s,"sendAllTabsInCurrentWindowMenus",!0),a(s,"sendCurrentTabMenus",!1),this.assert(!s.displayOneTabMenu[x]),this.assert(!s.excludeWebSiteContextMenu[x]),await this.Rt(t.gt[1][0]),await h(e),s=await r.kt(),a(s,"sendTabsToTheLeftMenus",!1),a(s,"sendTabsToTheRightMenus",!0),a(s,"sendAllTabsInAllWindowsMenus",!0),a(s,"sendTabsExceptThisMenus",!0),a(s,"sendAllTabsInCurrentWindowMenus",!0),a(s,"sendCurrentTabMenus",!0),this.assert(s.displayOneTabMenu[x]),this.assert(s.excludeWebSiteContextMenu[x]),this.assert(!s.excludeWebSiteContextMenu[C]),this.assert(s.excludeWebSiteContextMenu.title==="Exclude localhost from OneTab"),await this.Rt(t.gt[0][0]),await this.Dt(t.gt[0][0]),await r.ft(),await this.Dt(c),await this.Rt(t.gt[1][0]),await this.Dt(t.gt[1][0]),await this.Nt(t.gt[1][1]),await this.Nt(t.gt[1][2]),await h(e),s=await r.kt(),a(s,"sendTabsToTheLeftMenus",!1),a(s,"sendTabsToTheRightMenus",!1),a(s,"sendAllTabsInAllWindowsMenus",!0),a(s,"sendTabsExceptThisMenus",!1),a(s,"sendAllTabsInCurrentWindowMenus",!1),a(s,"sendCurrentTabMenus",!1),this.assert(s.displayOneTabMenu[x]),this.assert(s.excludeWebSiteContextMenu[x]),this.assert(!s.excludeWebSiteContextMenu[C]),this.assert(s.excludeWebSiteContextMenu.title==="Exclude localhost from OneTab"),await this.Nt(t.gt[1][0]),await h(e),s=await r.kt(),a(s,"sendAllTabsInCurrentWindowMenus",!1),await Promise.all((await g()).filter(l=>l.url!==c&&l.url!==t.bt[0]).map(l=>I(l))),await this.Rt(t.bt[0]),await h(e),s=await r.kt(),a(s,"sendAllTabsInAllWindowsMenus",!1)}async Va(){console.log("begin testExcludeWebSiteContextMenu"),await this.Ct(m),await r.Qe("127.0.0.1");let t={bt:[this.Tt("127.0.0.1"),this.Tt()],gt:[[this.Tt(),this.Tt()],[this.Tt(),this.Tt("127.0.0.1"),this.Tt()]]};await this.Gt(t,!0),await this.St({bt:t.gt[1],other:[t.bt,...t.gt.slice(0,-1)]}),await h(1e3);let e=await r.kt();this.assert(e.excludeWebSiteContextMenu[x]),this.assert(!e.excludeWebSiteContextMenu[C]),this.Lt(e.excludeWebSiteContextMenu.title,"Exclude localhost from OneTab"),await this.Rt(t.gt[1][1]),await h(1e3),e=await r.kt(),this.assert(e.excludeWebSiteContextMenu[x]),this.assert(!e.excludeWebSiteContextMenu[C]),this.Lt(e.excludeWebSiteContextMenu.title,"Exclude 127.0.0.1 from OneTab"),await r.ca("127.0.0.1");{let a=await r.getSettings(),s=r.Ge("127.0.0.1",a);this.assert(s)}await this.Rt(t.bt[1]),await h(1e3),e=await r.kt(),this.assert(e.excludeWebSiteContextMenu[x]),this.assert(!e.excludeWebSiteContextMenu[C]),this.Lt(e.excludeWebSiteContextMenu.title,"Exclude localhost from OneTab"),await this.Rt(t.bt[0]),await h(1e3),e=await r.kt(),this.assert(e.excludeWebSiteContextMenu[x]),this.assert(e.excludeWebSiteContextMenu[C]),this.Lt(e.excludeWebSiteContextMenu.title,"Exclude 127.0.0.1 from OneTab"),await r.Qe("127.0.0.1"),await X(),await h(1e3),e=await r.kt(),this.assert(e.excludeWebSiteContextMenu[x]),this.assert(!e.excludeWebSiteContextMenu[C]),this.Lt(e.excludeWebSiteContextMenu.title,"Exclude 127.0.0.1 from OneTab")}async Ka(){console.log("begin testIgnoreOneTabContentPages");let t={bt:[this.Tt(),this.Tt()]};await this.Gt(t,!0),await r.qt("import-export.html"),await r.qt("options.html"),await r.qt("import-export.html"),await r.qt("options.html");let e={gt:[[this.Tt(),this.Tt()]]};await this.Gt(e,!1),await r.qt("import-export.html"),await r.qt("options.html"),await this.Nt(e.gt[0][0]),await this.Nt(e.gt[0][1]),await this.St({bt:[...t.bt,j+"import-export.html",j+"options.html"]}),await this.Pt(),await this.St({bt:[c]})}async za(){console.log("begin testExistingOneTabSwitchedTo");let t={bt:[this.Tt()],gt:[[this.Tt(),this.Tt()],[this.Tt(),this.Tt(),this.Tt()]]};await this.Gt(t,!0),await this.St({bt:t.gt[1],other:[t.bt,...t.gt.slice(0,-1)]}),await r.ft();let e=await r.Bt();await this.St({bt:e?[c,...t.gt[1]]:[...t.gt[1],c],other:[t.bt,...t.gt.slice(0,-1)]}),await this.Rt(t.bt[0]),await this.Dt(t.bt[0]),await r.ft(!0),await this.Dt(t.bt[0]),await r.ft(),await this.Dt(c),await this.St({bt:e?[c,...t.gt[1]]:[...t.gt[1],c],other:[t.bt,...t.gt.slice(0,-1)]})}async Di(){console.log("begin safariPinnedTabsTest"),await this.Ct(m);let t={bt:[this.Tt(),this.Tt()],gt:[[this.Tt(),this.Tt()]]};await this.Gt(t,!0),await this.St({bt:t.gt[0],other:[t.bt]});let e=await k(!0),a=e.find(o=>o.focused),s=e.find(o=>!o.focused),n=200;await h(n),await r.ft(),await this.Mt(),await h(n),this.Lt((await k(!0)).find(o=>o.focused).id,a.id),await U(a.tabs[1]),await h(n),await r.ft(),await h(n),this.Lt((await k(!0)).find(o=>o.focused).id,a.id),await U(s.tabs[1]),await h(n),await r.ft(),await h(n),this.Lt((await k(!0)).find(o=>o.focused).id,s.id)}async ai(){console.log("begin testPinnedTabsOption"),await this.Ct(m);let t=await r.getSettings(),e=P("pinnedTabs",t);try{await r.Ue("pinnedTabs","ignore");let a={bt:[this.Yt(),this.Tt()]};await this.Gt(a,!0),await this.St({bt:a.bt}),await this.Pt(),await h(500);let s=await r.Bt();s?(await h(500),await this.St({bt:[c,a.bt[0]]},!0)):await this.St({bt:[a.bt[0],c]}),await this.Nt(a.bt[0]),await this.St({bt:[c]}),await r.Ue("pinnedTabs","allow"),await this.Gt(a,!0),await this.St({bt:a.bt}),await this.Pt(),await h(100),await this.St({bt:[c]}),await this.$t(a.bt,0,!0),await r.yt("clickTab",{url:a.bt[0],Wt:{}}),await this.It({bt:s?[c,a.bt[0]]:[a.bt[0],c]}),await this.Ti(a.bt[0])}finally{await r.Ue("pinnedTabs",e)}}async ii(){console.log("begin testPinnedTabsOption2"),await this.Ct(m);let t=await r.getSettings(),e=P("pinnedTabs",t);try{await r.Ue("pinnedTabs","allow");let a={bt:[this.Yt(),this.Yt()]};await this.Gt(a,!0),await this.St({bt:a.bt}),await this.Pt(),await this.St({bt:[c]});let s={bt:[this.Tt()]};await this.Gt(s,!1),await this.St({bt:[c,...s.bt]}),await this.Mt(),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:a.bt[0],Wt:{}}),await this.It({bt:[...a.bt],other:[[c,...s.bt]]}),await this.Pt(),await this.Ot(0,[...a.bt]),await this.Nt(s.bt[0]),await this.St({bt:[c]}),await this.Mt(),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:a.bt[0],Wt:{}});let n=await r.Bt();await this.It({bt:n?[c,...a.bt]:[...a.bt,c]})}finally{await r.Ue("pinnedTabs",e)}}async si(){console.log("begin testPinnedTabsOption3"),await this.Ct(m);let t=await r.getSettings(),e=P("pinnedTabs",t);try{await r.Ue("pinnedTabs","allow");let a={bt:[this.Yt()]};await this.Gt(a,!0),await this.St({bt:a.bt}),await this.Pt(),await this.St({bt:[c]});let s={bt:[this.Tt()]};await this.Gt(s,!1),await this.St({bt:[c,...s.bt]}),await this.Mt(),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:a.bt[0],Wt:{}}),await this.It({bt:[...a.bt],other:[[c,...s.bt]]}),await this.Pt(),await this.Ot(0,[...a.bt]),await this.Nt(s.bt[0]),await this.St({bt:[c]}),await this.Mt(),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:a.bt[0],Wt:{}});let n=await r.Bt();await this.It({bt:n?[c,...a.bt]:[...a.bt,c]})}finally{await r.Ue("pinnedTabs",e)}}async ni(){console.log("begin testRestoreRemovalOption"),await this.Ct(m);let t=await r.getSettings(),e=P("restoreRemoval",t);try{await r.Ue("restoreRemoval","default");let a={bt:[this.Tt(),this.Tt()]};await this.Gt(a,!0),await this.Pt(),await this.Mt(),await h(200),await this.Ot(0,[...a.bt]),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:a.bt[0],Wt:{}}),await this.It({bt:[c,...a.bt]}),await this.Jt(a.bt[0]),await r.Ue("restoreRemoval","keep"),await this.Pt(),await this.Mt(),await this.Ot(0,[...a.bt]),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:a.bt[0],Wt:{}}),await this.It({bt:[c,...a.bt]}),await this.Ot(0,[...a.bt])}finally{await r.Ue("restoreRemoval",e)}}async ri(){console.log("begin testDuplicatesOption"),await this.Ct(m);let t=await r.getSettings(),e=P("restoreRemoval",t);try{await r.Ue("restoreRemoval","default");let a={bt:[this.Tt(),this.Tt()]};await this.Gt(a,!0),await this.Pt(),await this.Mt(),await h(200),await this.Ot(0,[...a.bt]),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:a.bt[0],Wt:{}}),await this.It({bt:[c,...a.bt]}),await this.Jt(a.bt[0]),await r.Ue("restoreRemoval","keep"),await this.Pt(),await this.Mt(),await this.Ot(0,[...a.bt]),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:a.bt[0],Wt:{}}),await this.It({bt:[c,...a.bt]}),await this.Ot(0,[...a.bt])}finally{await r.Ue("restoreRemoval",e)}}async oi(){console.log("begin testRestoreWindowOption"),await this.Ct(m);let t=await r.getSettings(),e=P("restoreWindow",t);try{await r.Ue("restoreWindow","newWindow");let a={bt:[this.Tt(),this.Tt()]};await this.Gt(a,!0),await this.Pt(),await this.Mt(),await this.It({bt:[c]}),await this.Ot(0,[...a.bt]),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:a.bt[0],Wt:{}}),await this.It({bt:[c,...a.bt]}),await this.Pt(),await this.It({bt:[c]}),await this.Ot(0,[...a.bt]);let s={bt:[this.Tt()]};await this.Gt(s,!1),await r.ft(),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:a.bt[0],Wt:{}}),await this.It({bt:[...a.bt],other:[[c,...s.bt]]}),await r.Ue("restoreWindow","newWindowAlways"),await this.Pt(),await this.Mt(),await this.Nt(s.bt[0]),await this.It({bt:[c]}),await this.Ot(0,[...a.bt]),await r.ft(),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:a.bt[0],Wt:{}}),await this.It({bt:[...a.bt],other:[[c]]}),await this.Pt(),await this.Mt(),await this.It({bt:[c]}),await this.Ot(0,[...a.bt]),await r.Ue("restoreWindow","currentWindow"),await r.ft(),await this.Gt(s,!1),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:a.bt[0],Wt:{}}),await this.It({bt:[c,s.bt[0],...a.bt]})}finally{await r.Ue("restoreWindow",e)}}async li(){console.log("begin testLockUnlock"),await this.Ct(m);let t={bt:[this.Tt(),this.Tt()]};await this.Gt(t,!0),await this.Pt(),await this.Mt(),await this.It({bt:[c]}),await this.Ot(0,[...t.bt]),await h(150),this.assert(!(await r.yt("getTabGroupElementDisplayed",{Xt:"lockImg",At:t.bt[0]})).he),this.assert(!(await this.Ve(t.bt[0])).starred),await r.yt("clickTabGroupButton",{Et:"moreButton",At:t.bt[0],Wt:{}}),await r.yt("clickTabGroupButton",{Et:"toggleLockTabGroupButton",At:t.bt[0],ya:"mousedown",Wt:{}}),await h(150),this.assert((await this.Ve(t.bt[0])).locked),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:t.bt[0],Wt:{}}),await h(200),await this.It({bt:[c,...t.bt]}),await this.Ot(0,[...t.bt]),await r.yt("clickTabGroupButton",{Et:"deleteAllButton",At:t.bt[0]}),await h(200),await this.Ot(0,[...t.bt]),await r.yt("clickTab",{url:t.bt[0],Wt:{}}),await h(200),await this.Ot(0,[...t.bt]),this.assert((await r.yt("getTabGroupElementDisplayed",{Xt:"lockImg",At:t.bt[0]})).he)}async ui(){console.log("begin testStarUnstar"),await this.Ct(m);let t={bt:[this.Tt(),this.Tt()]};await this.Gt(t,!0),await this.Pt(),await this.Mt(),await this.It({bt:[c]}),await h(200),await this.Ot(0,[...t.bt]);let e={bt:[this.Tt(),this.Tt()]};await this.Gt(e,!0),await this.Pt(),await this.Mt(),await h(200),await this.It({bt:[c]}),await this.Ot(0,[...e.bt]);let a=await r.yt("getVisibleStructure"),s=a.tabGroups.findIndex(u=>u.tabs.some(w=>w===t.bt[0])),n=a.tabGroups.findIndex(u=>u.tabs.some(w=>w===e.bt[0]));this.assert(s>0),this.assert(!(await r.yt("getTabGroupElementDisplayed",{Xt:"starImg",At:t.bt[0]})).he),await r.yt("clickTabGroupButton",{Et:"moreButton",At:t.bt[0],Wt:{}}),await h(300),await r.yt("clickTabGroupButton",{Et:"toggleStarTabGroupButton",At:t.bt[0],ya:"mousedown",Wt:{}}),await h(1200),this.assert((await r.yt("getTabGroupElementDisplayed",{Xt:"starImg",At:t.bt[0]})).he),a=await r.yt("getVisibleStructure");let o=a.tabGroups.findIndex(u=>u.tabs.some(w=>w===t.bt[0]));this.assert(o===0),this.assert(o===await this.ma(t.bt[0])),this.assert((await this.Ve(t.bt[0])).starred),await r.yt("clickTabGroupButton",{Et:"moreButton",At:t.bt[0],Wt:{}}),await r.yt("clickTabGroupButton",{Et:"toggleStarTabGroupButton",At:t.bt[0],ya:"mousedown",Wt:{}}),await h(600),a=await r.yt("getVisibleStructure");let l=a.tabGroups.findIndex(u=>u.tabs.some(w=>w===t.bt[0]));this.assert(s===l),this.assert(s===await this.ma(t.bt[0])),this.assert(!(await this.Ve(t.bt[0])).starred),this.assert(!(await r.yt("getTabGroupElementDisplayed",{Xt:"starImg",At:t.bt[0]})).he)}async La(t){console.log("begin testFileUrls");let e;try{await this.Ct(m);let a={bt:[t]};await this.Gt(a,!0),await this.St({bt:[t]}),await this.Pt(),await this.Mt(),await this.$t([t],0,!0);let s=K(t,await at());await r.yt("clickTab",{url:s,Wt:{}})}catch(a){e=String(a)}this.assert(()=>e.includes("Illegal URL"))}async ki(t){console.log("begin testPdfPlaceholders"),await this.Ct(m);let e=K(t,await at());this.assert(t!==e&&!e.startsWith("file://"),"pdfFilePlaceholderUrl not determined correctly");let a={bt:[t]};await this.Gt(a,!0),await this.St({bt:[t]}),await this.Pt(),await h(200),await this.St({bt:[c]}),await this.Mt(),await this.$t([t],0,!0),await r.yt("clickTab",{url:e,Wt:{}}),await this.It({bt:[c,e]}),await this.Pt(),await this.$t([t],0,!0),await h(200),await r.yt("clickTabGroupButton",{Et:"restoreAllButton",At:e,Wt:{}}),await h(200),await this.Jt(0,e),await this.Jt(0,t),await this.It({bt:[c,e]})}async wi(){await r.ft(),await this.Mt();let t=await r.yt("testExtFavIconLoad");this.assert(t.success)}async Zt(){let t=(await g()).filter(a=>G(a.url));this.pi(t.length,0,"cannot find any onetab tab");let e=t[0];return this.Lt(t.length,1,"there should only be exactly one onetab tab"),e}async Ua(t){console.log("begin testPreserveLastOneTabTabPinnedState"),await r.ft(),await this.Mt();let e=await this.Zt(),a=e.pinned,s=500;a||(await Q(e.id,{pinned:!0}),await h(s),await I(e),await h(s),await r.ft(),await this.Mt(),e=await this.Zt(),await h(s),this.assert(e.pinned)),a&&(await Q(e.id,{pinned:!1}),await h(200),await I(e),await r.ft(),await this.Mt(),e=await this.Zt(),this.assert(!e.pinned),await Q(e.id,{pinned:!0}),await h(200),await I(e),await h(200),await r.ft(),await this.Mt(),await h(200),e=await this.Zt(),this.assert(e.pinned)),await lt(t)}async $t(t,e,a){let s=await r.getState();a&&(e+=s.tabGroups.findIndex(o=>!o.starred));let n=s.tabGroups.some((o,l)=>e!==void 0&&e!==l?!1:o.tabsMeta.every((u,w)=>{let d=t[w];if(d.includes(":3000/?title=")){let b=this.ta(d,"title")===u.title;return this.ta(d,"title").startsWith("PIN::")&&!u.pinned&&(b=!1),b||console.log(`assertStoredTabGroup mismatch: ${this.ta(d,"title")} vs ${u.title}`),b}else return d===u.url}));this.assert(n,`assertStoredTabGroup fail, expected: ${t} at index ${e}`)}async di(t){let e=await r.getState();this.assert(e.tabGroups.some(a=>a.tabsMeta.some(s=>s.url===t)))}async hi(t){let e=await r.getState();this.assert(!e.tabGroups.some(a=>a.tabsMeta.some(s=>s.url===t)))}async ma(t){return(await r.getState()).tabGroups.findIndex(e=>e.tabsMeta[0].url===t)}async Ve(t){return(await r.getState()).tabGroups.find(e=>e.tabsMeta[0].url===t)}ta(t,e){t=t.substring(t.indexOf("?")+1);let a=t.split("&");for(let s in a){let n=a[s].split("=");if(n[0]===e)return decodeURIComponent(n[1])}}async Ct(t){let a=(await g()).filter(n=>n.url&&!(n.title&&n.title.startsWith("t---")||n.title&&n.title.startsWith("PIN::t---")||n.title&&n.title.startsWith("localhost:"))&&![n.url,n.pendingUrl].some(o=>[j,dt,"file://"].some(l=>o&&o.startsWith(l))));if(a=a.filter(n=>!n.url.startsWith("http://localhost")),a.length>0)throw console.log(a),new Error(`Non-empty tabs found, aborting browser reset. ${a.map(n=>n.url).join(",")}`);let s=await k(!0);if(s.length===0)console.log("resetToSingleEmptyTabOpen: no open windows"),await vt({url:t});else{s.slice(1).forEach(u=>Rt(u.id));let n=s[0],{tabs:o,activeTab:l}=await ce(n.id);await F({windowId:n.id,url:t}),await Promise.all(o.map(u=>I(u)))}await this.Ke()}async Ke(){(await g()).some(t=>t.url==="about:blank")&&await h(200),await yt(1e4,"waitForAllTabsLoaded",async()=>!(await g()).some(t=>t.status==="loading"))}async Gt(t,e){let a={bt:[],gt:[]},s=[];if(e&&(s=await g()),t.bt)for(let n=0;n<t.bt.length;n++)a.bt.push(await this.openTab(t.bt[n]));if(t.gt)for(let n=0;n<t.gt.length;n++){let{Ie:o,Pe:l}=await this.yi(t.gt[n]);a.gt.push(l)}return await Promise.all(s.map(n=>I(n))),await this.Ke(),a}async It(t){await this.Ke(),await yt(1e4,"waitForAndAssertTabStructure",async e=>{try{return await this.St(t),!0}catch(a){return e>3e3&&console.log(a),!1}})}async Ti(t){let e=await st();this.assert(e.some(a=>a.some(s=>[s.url,s.pendingUrl].some(n=>n===t)&&s.pinned)))}async St(t,e){if(!t.bt&&!t.other)throw new Error("invalid tabStruct");await this.Ke();let a=await st(!0);if(!await J())throw new Error("No lastFocusedWindow found");let n=(await J()).tabs;if(t.bt){let o=n.map(u=>[u.url,u.pendingUrl].find(w=>w)).join(" , "),l=t.bt.join(" , ");if(o!==l){let u=`No match for tabs in last focused window (actual, expected): 
${o}

${l}`;throw new Error(u)}}if(t.other){let o=a.map(u=>u.map(w=>[w.url,w.pendingUrl].find(d=>d)).join(" , ")).sort().join(`
`),l=t.other.map(u=>u.join(" , ")).sort().join(`
`);if(o!==l){let u=`No match for tabs in non focused windows (actual, expected):
${o}

${l}`;throw new Error(u)}}}async ci(t){for(let e of pt(5e3))try{await this.Dt(t);return}catch{await h(e)}throw new Error("waitForAndAssertActiveTab failed after time-out")}async Mt(){for(let t of pt(1e4)){try{if((await g()).some(e=>G(e.url)))try{await r.yt("ping");return}catch{}}catch(e){console.log(e)}t>200&&console.log(`waitForOneTabTabExistsAndRespondsToRpc pause for: ${t}`),await h(t)}throw new Error("waitForOneTabTabExistsAndRespondsToRpc failed after time-out")}async Dt(t){let e=(await Ft()).url;if(e!==t)throw new Error(`active tab not as expected (actual, expected): "${e}", "${t}"`)}async openTab(t){return await r.Da(t,t.includes("?title="+encodeURIComponent("PIN::")))}async yi(t){let{Ie:e,Pe:a}=await gt(t.map(s=>({url:s,pinned:s.includes("?title="+encodeURIComponent("PIN::"))})));return{Ie:e,Pe:a}}async Pt(){await r.je(void 0)}async Rt(t){await U((await g()).find(e=>e.url===t))}async Nt(t){let e=(await g()).find(a=>a.url===t);if(!e)throw new Error("Could not find tab with URL: "+t);await I(e)}xa(t,e){return e||(e="localhost"),`http://${e}:3000/?title=${encodeURIComponent(t)}`}Tt(t){return this.xa(this.uuid(),t)}Yt(t){return this.xa("PIN::"+this.uuid(),t)}uuid(){return"t---"+tt(6,16).toLowerCase()}assert(t,e){if(!t)throw new Error("Assertion failed"+(e?" "+e:""))}Lt(t,e,a){if(t!==e)throw new Error(`Assertion failed, ${t} !== ${e}, ${a}`)}pi(t,e,a){if(!(t>e))throw new Error(`Assertion failed, ! (${t} > ${e}), ${a}`)}}let r=new $;Oe();async function Nt(){let t=(await g()).find(a=>G(a.url)),e=t?{index:t.index,windowId:t.windowId,pinned:t.pinned,active:t.active,updateDate:new Date().getTime(),updateEvent:"onUpdateAvailable"}:{};await r.Ye(e),await xe()}function Oe(){Ee(),chrome.runtime.onUpdateAvailable&&chrome.runtime.onUpdateAvailable.addListener(async()=>{await Nt()}),chrome.runtime.onInstalled.addListener(async a=>{await i()}),chrome.runtime.onStartup.addListener(async()=>{await i()});async function i(){try{D&&await chrome.action.setPopup({popup:"popup-mobile.html"}),await r.Ea(),await E().clearAll(),await We(),await Ce(),await Y()}catch(a){console.log("onStartup exception"),console.log(a)}}async function t(a){await Ot(),await r.je(void 0,a)}D||chrome.action.onClicked.addListener(async a=>t(a));const e={displayOneTabMenu:async(a,s,n)=>await r.Pa(s?.windowId),sendAllTabsInCurrentWindowMenus:async(a,s,n)=>await r.je(n[[B]],s),sendThisWebLinkMenus:async(a,s,n)=>await r.ka(a,s,n[[B]]),sendCurrentTabMenus:async(a,s,n)=>await r.Se(n[[B]],s),sendTabsExceptThisMenus:async(a,s,n)=>await r.Ee(n[[B]],s),sendTabsToTheLeftMenus:async(a,s,n)=>await r.da(n[[B]],s),sendTabsToTheRightMenus:async(a,s,n)=>await r.ha(n[[B]],s),sendAllTabsInAllWindowsMenus:async(a,s,n)=>await r.ze(n[[B]]),helpMenu:async(a,s,n)=>await nt(Wt+"/help",!1,!0),excludeWebSiteContextMenu:async(a,s,n)=>{let o=await r.getSettings(),l=H(O((await J()).activeTab.url));r.Ge(l,o)?await r.Qe(l):await r.ca(l),await X()}};chrome.contextMenus?.onClicked.addListener(async(a,s)=>{await Ot();let n=a.menuItemId,o=await r.kt(),l=Object.entries(o).find(([u,w])=>{let d=Array.isArray(w)?w.find(b=>b.id===n):w;return d&&d.id===n});if(l){let[u,w]=l,d=Array.isArray(w)?w.find(p=>p.id===n):w,b=Object.entries(e).find(([p,y])=>p===u);if(b){let[,p]=b;await p(a,s,d)}else console.log(`no actionMenuItemType matched for menuItemType: ${u}`)}else console.log(`contextMenuState item not found for menuItemId ${n}`)}),Te(),D||(pe(()=>X()),ye())}async function Ce(){if(D)return;let i=await S().get("lastSeenVersion");if(String(ct)!==String(i)){await S().put("lastSeenVersion",ct);let t=await r.fa();(await k(!1)).some(e=>!e.incognito)&&t.windowId&&new Date().getTime()-(t.updateDate||0)<1e3*30&&(await Promise.all((await g()).filter(s=>G(s.url)).map(s=>I(s))),(await k(!1)).find(s=>!s.incognito&&s.id===t.windowId)&&await r.Fa({windowId:t.windowId,index:t.index,url:c,active:!!t.active,pinned:!!t.pinned})),await r.Ye({})}else{let t=await r.getSettings();(await r.getState()).tabGroups.map(s=>s.tabsMeta.length).reduce((s,n)=>s+n,0)>0&&P("startupLaunch",t)==="displayOneTab"&&((await k(!1)).find(s=>!s.incognito)?await r.ft(!0):chrome.windows.onCreated.addListener(async s=>{try{await r.aa.jt(),await E().get("openOneTabOnStartTriggered")||(await k(!1)).find(n=>!n.incognito)&&(await E().put("openOneTabOnStartTriggered","true"),await r.ft(!0))}finally{r.aa.release()}}))}}function Ee(){chrome.runtime.onMessage.addListener((i,t,e)=>{if(t.id===chrome.runtime.id&&i.v)return r[i.type]?r[i.type].constructor.name==="AsyncFunction"?(i.args&&(i.args=mt(i.args,se,void 0)),r[i.type](...i.args).then(a=>{e({result:a})}).catch(a=>{a.stack&&console.log(a.stack),e({C:a})}),!0):(e(r[i.type](...i.args)),!1):(e({C:"No such core method found"}),!1)})}async function Xe(){return;try{if(!await Pe())return;await Promise.all((await g()).filter(i=>i.pinned&&!i.pendingUrl&&!i.url).map(async i=>{await I(i)}))}catch(i){console.log("cleanupSafariTabs exception"),console.log(i)}}async function Pe(){return((await chrome.permissions.getAll())?.origins??[]).includes("*://*/*")}globalThis.populateWithTestData=async()=>{await r.Wa(),console.log("populateWithTestData done")},globalThis.testRestoreOnVersionUpdate=async()=>{await r.Ra()},globalThis.runTestSuite=async i=>{await r.va(i)},globalThis.loopTestSuite=async(i,t)=>{await r.Ba(i,t)};
