(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{195:function(t,e,i){},196:function(t,e,i){},197:function(t,e,i){"use strict";i(195)},198:function(t,e,i){"use strict";var s=i(3),a=i.n(s),n=i(4),r=i.n(n),o=i(6),l=i.n(o),c=i(13),h=i.n(c),u=function(){function t(){a()(this,t),this.db=new h.a("asset_caches",{revs_limit:1}),this.maxLimit=2e3,this.init()}return r()(t,[{key:"init",value:function(){return this.db.createIndex({index:{fields:["cached_at"]}})}},{key:"checkLimitationAndRemove",value:function(){var t=this;this.db.allDocs().then((function(e){var i=e.rows.length-t.maxLimit;i>0&&t.db.find({selector:{cached_at:{$gte:null}},sort:[{cached_at:"asc"}],limit:i}).then((function(e){e.docs.forEach((function(e){t.db.remove(e).catch((function(t){console.log(t)}))}))}))}))}},{key:"putAsset",value:function(t,e){var i=this;return this.checkLimitationAndRemove(),new Promise((function(s){i.db.get(t).then((function(){s()})).catch((function(){s(i.db.put({_id:t,asset:e,cached_at:parseInt((Date.now()+"").substr(0,10))}))}))}))}},{key:"retrieveAsset",value:function(t){var e=this;return new Promise((function(i,s){e.db.get(t).then((function(t){i(t)})).catch((function(t){s(t)}))}))}}]),t}(),d=function(){function t(){a()(this,t),this.assetCacheRepo=new u,this.cachedAssets=new Map,this.cachedLimit=1e3}return r()(t,[{key:"getCache",value:function(t){var e=this;return new Promise((function(i){e.cachedAssets.size>e.cachedLimit&&e.cachedAssets.delete(e.cachedAssets.entries().next()),e.cachedAssets.has(t)?i(e.cachedAssets.get(t)):e.assetCacheRepo.retrieveAsset(t).then((function(s){e.cachedAssets.has(t)||e.cachedAssets.set(t,s.asset.data),i(s.asset.data)})).catch((function(s){console.log(s),e.fetchAsset(t).then((function(s){if(s.length<=102400)return e.assetCacheRepo.putAsset(t,{url:t,data:s}),void i(s);i(s)})).catch((function(e){i(t)}))}))}))}},{key:"fetchAsset",value:function(t){return new Promise((function(e,i){var s=new XMLHttpRequest;s.open("GET",t),s.responseType="blob",s.onload=function(){if(200===s.status){var t=new FileReader;t.onloadend=function(){e(t.result)},t.readAsDataURL(s.response)}else i(Error("Cannot fetch asset from remote"))},s.onerror=function(t){i(t)},s.send()}))}}],[{key:"getInstance",value:function(){return t.instance||(t.instance=new t),t.instance}}]),t}();l()(d,"instance",void 0);var m={props:{placeholder:{required:!1,type:String,default:""},src:{required:!0,type:String},defaultImage:{type:String,default:"data:image/gif;base64,R0lGODlhAQABAIAAAN/f3wAAACH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS41LWMwMTQgNzkuMTUxNDgxLCAyMDEzLzAzLzEzLTEyOjA5OjE1ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjhFRUMzOEMwMDY4QjExRUFCMTUwRDEyRjc1QThERDhDIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjhFRUMzOEMxMDY4QjExRUFCMTUwRDEyRjc1QThERDhDIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OEVFQzM4QkUwNjhCMTFFQUIxNTBEMTJGNzVBOEREOEMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OEVFQzM4QkYwNjhCMTFFQUIxNTBEMTJGNzVBOEREOEMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4B//79/Pv6+fj39vX08/Lx8O/u7ezr6uno5+bl5OPi4eDf3t3c29rZ2NfW1dTT0tHQz87NzMvKycjHxsXEw8LBwL++vby7urm4t7a1tLOysbCvrq2sq6qpqKempaSjoqGgn56dnJuamZiXlpWUk5KRkI+OjYyLiomIh4aFhIOCgYB/fn18e3p5eHd2dXRzcnFwb25tbGtqaWhnZmVkY2JhYF9eXVxbWllYV1ZVVFNSUVBPTk1MS0pJSEdGRURDQkFAPz49PDs6OTg3NjU0MzIxMC8uLSwrKikoJyYlJCMiISAfHh0cGxoZGBcWFRQTEhEQDw4NDAsKCQgHBgUEAwIBAAAh+QQAAAAAACwAAAAAAQABAAACAkQBADs="},mode:{required:!1,type:String,default:"image"},cacheService:{type:Object,default:function(){return d.getInstance()}}},data:function(){return{imageSrc:null}},computed:{usedSrc:function(){return this.imageSrc||this.placeholder}},watch:{src:function(t){var e=this;this.imageSrc=this.defaultImage,this.cacheService.getCache(t).then((function(t){e.imageSrc=t}))}},mounted:function(){var t=this;this.cacheService.getCache(this.src).then((function(e){t.imageSrc=e}))}},v=(i(197),i(1)),f=Object(v.a)(m,(function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"cacheable-image"},["image"===this.mode?e("img",{attrs:{src:this.usedSrc}}):"background"===this.mode?e("div",{staticClass:"cacheable-image-bg",style:{backgroundImage:"url("+this.usedSrc+")"}}):this._e()])}),[],!1,null,null,null);e.a=f.exports},199:function(t,e,i){"use strict";i(196)},200:function(t,e,i){"use strict";var s={props:{title:String}},a=(i(199),i(1)),n=Object(a.a)(s,(function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"page-title__wrap"},[e("h1",[this._v(this._s(this.title))])])}),[],!1,null,"72d44518",null);e.a=n.exports},202:function(t,e,i){},206:function(t,e,i){"use strict";i(202)},209:function(t,e,i){"use strict";i.r(e);i(201);var s=i(204),a=i(200),n=i(198),r=(i(8),i(166)),o=i(0),l=i.n(o),c={components:{"page-title":a.a,"cacheable-image":n.a,"recycle-scroller":s.a},data:function(){return{total:0,historyItems:[],totalLoaded:0,offset:0,step:50,disableBlurOnR:!1,loading:!1,allLoaded:!1,confirmDialog:!1,illustDeleteReady:null,searchQuery:"",searchTimeout:null,enableSaveVisitHistory:!0,unlimitedStoragePermission:null}},created:function(){this.windowScrollEventBinded=!1,this.illustHistoryPort=r.a.getInstance(),this.illustHistoryPort.port.onMessage.addListener(this.handleIllustHistoryPortResponse),this.enableSaveVisitHistory=this.browserItems.enableSaveVisitHistory,this.unlimitedStoragePermission=this.browserItems.unlimitedStoragePermission,this.latestListDate=null,"zh_CN"===this.$i18n.locale?(this.dateFormat="YYYY[年]MMMMDD[日] dddd",this.timeFormat="A h:mm"):(this.dateFormat="dddd, MMMM DD, YYYY",this.timeFormat="h:mmA")},beforeMount:function(){browser.storage.local.set({visitHistoryType:"list"}),this.illustHistoryPort.countItems({endkey:"_"})},mounted:function(){this.getHistoryItems()},beforeDestroy:function(){window.removeEventListener("scroll",this.handleScroll)},computed:{statusNotice:function(){return this.historyItems.length<=0?"There is no any history":""},importProgress:function(){return 0===this.importTotal?"":" ("+this.importedCount+"/"+this.importTotal+")"},disableBlurOnRText:function(){return this.tl(this.disableBlurOnR?"_enable_mask":"_disable_mask")},displayWorkTypeLabel:function(){return this.browserItems.displayWorkTypeLabel},coverSize:function(){var t,e;switch(this.browserItems.workCoverSize){case 1:t=80;break;case 2:t=110;break;case 3:t=150}return e={width:Math.floor(1.25*t),height:t},this.historyItems.forEach((function(t){void 0===t.time&&(t.size=e.height+10)})),e}},watch:{searchQuery:function(t){var e=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout((function(){e.historyItems=[],e.totalLoaded=0,e.offset=0,t.trim().length>0?e.searchHistoryItems():e.getHistoryItems()}),800)}},methods:{caseDate:function(t){return l.a.unix(t).format(this.timeFormat)},caseWorkUrl:function(t){return t.isNovel?"https://www.pixiv.net/novel/show.php?id="+t.id.substr(1):"https://www.pixiv.net/en/artworks/"+t.id},caseWorkType:function(t){if(t.isNovel)return"Novel";var e=t.type;return 1==e?"Manga":2==e?"Ugoira":0==e?"Illustration":"Unkown"},caseUserUrl:function(t){return"https://www.pixiv.net/member.php?id=".concat(t)},handleScroll:function(){document.documentElement.scrollHeight-window.innerHeight-window.scrollY<window.innerHeight/2&&!this.loading&&!this.allLoaded&&(this.searchQuery.trim().length>0?this.searchHistoryItems():this.getHistoryItems())},openInNew:function(t){window.open(this.caseWorkUrl(t))},handleIllustHistoryPortResponse:function(t,e){if(this.illustHistoryPort.isChannel(t.channel,"items-count"))this.total=t.data.count;else if(this.illustHistoryPort.isChannel(t.channel,"items-list")){if(this.windowScrollEventBinded||(window.addEventListener("scroll",this.handleScroll),this.windowScrollEventBinded=!1),void 0===t.error&&t.data.dataset&&t.data.dataset.length>0){this.totalLoaded+=t.data.dataset.length;for(var i=0;i<t.data.dataset.length;i++){var s=t.data.dataset[i];if(s.size=this.coverSize.height+10,null===this.latestListDate){this.latestListDate=new Date(1e3*s.viewed_at),this.latestListDate.setHours(0),this.latestListDate.setMinutes(0),this.latestListDate.setSeconds(0),this.latestListDate.setMilliseconds(0);var a=this.latestListDate.getTime();t.data.dataset.splice(i,0,{id:a,time:a,size:50}),i++}else{var n=new Date(1e3*s.viewed_at);if(this.latestListDate.getTime()>n.getTime()){n.setHours(0),n.setMinutes(0),n.setSeconds(0),n.setMilliseconds(0);var r=n.getTime();t.data.dataset.splice(i,0,{id:r,time:r,size:50}),this.latestListDate=n,i++}}}this.historyItems=this.historyItems.concat(t.data.dataset),t.data.dataset.length<this.step?this.allLoaded=!0:this.offset+=this.step}this.loading=!1}if(void 0!==t.data.error)throw t.data.error},deleteOne:function(t){this.confirmDialog=!0,this.illustDeleteReady=t},deleteIllust:function(){this.confirmDialog=!1,this.illustHistoryPort.deleteIllustHistory(this.illustDeleteReady),this.historyItems.splice(this.historyItems.indexOf(this.illustDeleteReady),1),this.total--},getHistoryItems:function(){this.loading=!0,this.illustHistoryPort.listItems({limit:this.step,skip:this.offset})},searchHistoryItems:function(){this.loading=!0,this.illustHistoryPort.searchItems({limit:this.step,skip:this.offset,extra:{query:this.searchQuery.toLowerCase()}})},disableBlurOnRClicked:function(){this.disableBlurOnR=!this.disableBlurOnR},formatDate:function(t){return l()(t).format(this.dateFormat)}}},h=(i(206),i(1)),u=Object(h.a)(c,(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"container container--small page-history"},[t.enableSaveVisitHistory?t._e():i("v-alert",{attrs:{value:!0,type:"warning"}},[t._v(t._s(t.tl("_save_visit_history_has_been_disabled")))]),t._v(" "),i("div",{staticClass:"history__header"},[i("v-text-field",{staticClass:"search-panel",attrs:{label:"Solo","single-line":"",solo:"",flat:"",placeholder:t.tl("_search_history")},model:{value:t.searchQuery,callback:function(e){t.searchQuery=e},expression:"searchQuery"}})],1),t._v(" "),i("div",{staticClass:"history__header-action"},[i("v-btn",{attrs:{flat:"",icon:""},on:{click:t.disableBlurOnRClicked}},[i("v-icon",[t._v(t._s(t.disableBlurOnR?"visibility":"visibility_off"))])],1)],1),t._v(" "),t.historyItems.length>0?i("v-layout",{staticClass:"history-items",attrs:{row:"",wrap:""}},[i("recycle-scroller",{staticClass:"scroller",attrs:{items:t.historyItems,"page-mode":"","key-field":"id"},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.item;return[s.time?i("div",{staticClass:"history-date"},[t._v("\n        "+t._s(t.formatDate(s.time))+"\n      ")]):i("div",{staticClass:"history-item",style:{height:t.coverSize.height+"px"}},[i("div",{staticClass:"history-item__thumb",style:{width:t.coverSize.width+"px",height:t.coverSize.height+"px"},on:{click:function(e){return t.openInNew(s)}}},[i("cacheable-image",{staticClass:"history-item__thumb-body",class:{"history-item__thumb-body--blur":s.r&&!t.disableBlurOnR},attrs:{src:s.isNovel?s.image:s.images.thumb,mode:"background"}})],1),t._v(" "),i("div",{staticClass:"history-item__info"},[i("div",{staticClass:"history-item__info-entity history-item__info-entity--blod"},[t.displayWorkTypeLabel?i("span",{staticClass:"history-item__info-badge",class:"history-item__info-badge--type"+(s.isNovel?"-novel":s.type)},[t._v(t._s(t.caseWorkType(s)))]):t._e(),t._v(" "),i("a",{staticClass:"maintitle",attrs:{href:t.caseWorkUrl(s),target:"_blank"}},[t._v(t._s(s.title))])]),t._v(" "),i("div",{staticClass:"history-item__info-entity history-item__info-entity--blod"},[s.userId?i("a",{staticClass:"subtitle",attrs:{href:t.caseUserUrl(s.userId),target:"_blank"}},[t._v(t._s(s.userName))]):i("span",[t._v("-")])]),t._v(" "),i("div",{staticClass:"history-item__info-entity history-item__info-entity--sub"},[t._v(t._s(t.caseDate(s.viewed_at))),i("span",{staticStyle:{"margin-left":"15px"}},[t._v(t._s(t.caseWorkUrl(s)))])])]),t._v(" "),i("div",{staticClass:"history-item__actions"},[i("v-btn",{staticClass:"history-item__actions-btn",attrs:{flat:"",icon:"",small:""},on:{click:function(e){return t.deleteOne(s)}}},[i("svg",{staticClass:"c01204",attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 2048 2048",width:"16",height:"16"}},[i("path",{attrs:{d:"M1115 1024l690 691-90 90-691-690-691 690-90-90 690-691-690-691 90-90 691 690 691-690 90 90-690 691z"}})])])],1)])]}}],null,!1,2295990716)})],1):t._e(),t._v(" "),!t.loading&&t.statusNotice?i("p",{staticClass:"history__status-notice"},[t._v("\n    "+t._s(t.statusNotice)+"\n  ")]):t._e(),t._v(" "),t.loading?i("div",{staticStyle:{"text-align":"center",clear:"both","margin-top":"20px"}},[i("v-progress-circular",{attrs:{indeterminate:"",color:"primary"}})],1):t._e(),t._v(" "),i("v-dialog",{attrs:{width:"500"},model:{value:t.confirmDialog,callback:function(e){t.confirmDialog=e},expression:"confirmDialog"}},[i("v-card",[i("v-card-title",[t._v(t._s(t.tl("_notice")))]),t._v(" "),i("v-card-text",[i("p",{staticStyle:{"font-size":"14px"}},[t._v(t._s(t.tl("_this_operation_cannot_be_reversed_are_you_sure")))])]),t._v(" "),i("v-card-actions",[i("v-spacer"),t._v(" "),i("v-btn",{attrs:{color:"error"},on:{click:t.deleteIllust}},[t._v(t._s(t.tl("_delete")))]),t._v(" "),i("v-btn",{on:{click:function(e){t.confirmDialog=!1}}},[t._v(t._s(t.tl("_keep")))])],1)],1)],1)],1)}),[],!1,null,null,null);e.default=u.exports}}]);