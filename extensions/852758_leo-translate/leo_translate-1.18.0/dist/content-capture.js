(()=>{"use strict";const t=Object.freeze({contextCapturing:!1,contextAutoTranslate:!1,doubleClick:!0,doubleClickCtrl:!1,doubleClickAlt:!1,doubleClickMeta:!1,hoverTranslation:!1,hoverTimeout:300,hoverAlt:!0,hoverCtrl:!1,hoverShift:!1,theme:"blackberry",audioAutoPlay:!1});function e(e,n){return void 0!==e[n]?e[n]:t[n]}const n={getOption(t){return this.getAllOptions().then((e=>e[t]))},getAllOptions:()=>new Promise((n=>{chrome.storage.local.get({options:"{}"},(o=>{let r={};o&&"object"==typeof o&&(r="string"==typeof o.options?JSON.parse(o.options):o.options);const i={};for(const n of Object.keys(t))i[n]=e(r,n);return n(i)}))})),setAllOptions:t=>new Promise((e=>chrome.storage.local.set({options:JSON.stringify(t)},e)))};class o{constructor(t,e,n){this.selection=t,this.behind=e,this.ahead=n}getSentence(){let t=0,e="";const n=this.allSentences;for(let o=0;o<n.length&&(e=n[o],t+=e.length,!(t>this.behind.length));o++);return e}get joinedContext(){return this.behind+this.selection+this.ahead}get allSentences(){return this.joinedContext.replace(/(.*?(?:\.|!|\?)(?:(?= +[A-Z0-9])|$))/g,"$1"+o.DELIMITER).split(o.DELIMITER)}static get DELIMITER(){return"|leo-translate-delimiter|"}}class r{constructor(t){this.range=t}getContext(){if(null===this.range)return null;const t=this.range.toString(),e=t.length,n=r.LIMIT-e;let i="",s="",l="";return e>=r.LIMIT?i=t.substr(0,r.LIMIT):(i=t,this.range.startContainer.nodeType===Node.TEXT_NODE?s=this.range.startOffset-n>=0?this.range.startContainer.textContent.substr(this.range.startOffset-n,n):this.gatherText(this.range.startContainer,this.range.startContainer.textContent.substr(0,this.range.startOffset),r.BACKWARD_DIRECTION,!0):this.range.endContainer.nodeType===Node.ELEMENT_NODE&&(s=this.gatherText(this.range.startContainer.childNodes[this.range.startOffset],"",r.BACKWARD_DIRECTION,!0)),this.range.endContainer.nodeType===Node.TEXT_NODE?l=this.range.endOffset+n<=this.range.endContainer.textContent.length-1?this.range.endContainer.textContent.substr(this.range.endOffset,n):this.gatherText(this.range.endContainer,this.range.endContainer.textContent.substr(this.range.endOffset),r.FORWARD_DIRECTION,!0):this.range.endContainer.nodeType===Node.ELEMENT_NODE&&(l=this.gatherText(this.range.endContainer.childNodes[this.range.endOffset],"",r.FORWARD_DIRECTION,!0))),new o(i,s,l)}gatherText(t,e,n,o=!1){const i=t=>n===r.BACKWARD_DIRECTION?t.previousSibling:t.nextSibling;if(-1===[r.BACKWARD_DIRECTION,r.FORWARD_DIRECTION].indexOf(n))throw new Error(`Invalid direction "${n}"`);if(r.isBlock(t)||"br"===t.nodeName.toLowerCase())return"";const s=r.LIMIT-e.length;if(s<1)throw new Error("The text is longer than LIMIT");if(!o&&t.nodeType===Node.TEXT_NODE){const o=t.textContent;n===r.BACKWARD_DIRECTION?e=o.substr(-1*s,s)+e:n===r.FORWARD_DIRECTION&&(e+=o.substr(0,s))}if(e.length>=r.LIMIT)return e;let l;if(null!==(l=(a=t).childNodes.length>0?a.childNodes[n===r.BACKWARD_DIRECTION?a.childNodes.length-1:0]:null)||null!==(l=i(t)))return r.isBlock(l)||"br"===l.nodeName.toLowerCase()?e:this.gatherText(l,e,n);{let o=t.parentNode;for(;null!==o&&!r.isBlock(o)&&"body"!==o.nodeName.toLowerCase();){if(l=i(o),null!==l){if(r.isBlock(l))break;return this.gatherText(l,e,n)}o=o.parentNode}}var a;return e}static isBlock(t){if(t.nodeType!==Node.ELEMENT_NODE)return!1;const e=window.getComputedStyle(t).getPropertyValue("display");return-1===["inline","inline-block"].indexOf(e)}static get LIMIT(){return 128}static get FORWARD_DIRECTION(){return"forward"}static get BACKWARD_DIRECTION(){return"backward"}}const i={getAll:()=>new Promise((t=>chrome.storage.local.get({hoverExcluded:[]},(e=>t(e.hoverExcluded))))),setAll:t=>new Promise((e=>chrome.storage.local.set({hoverExcluded:t},e))),clear(){return this.setAll([])}};function s(t){return/[a-zA-Z-']/.test(t)}const l="proxy-content-open-popup";let a,c={};function u([t,e]){c=t;let n=Array.isArray(e)&&-1!==e.indexOf(window.location.host);c.hoverTranslation&&!n||!c.hoverTranslation&&n?document.body.addEventListener("mousemove",d):document.body.removeEventListener("mousemove",d)}function d(t){clearTimeout(a),a=setTimeout((function(){if((c.hoverAlt||c.hoverCtrl||c.hoverShift)&&!(function(t){return c.hoverAlt&&t.altKey}(t)||function(t){return c.hoverCtrl&&t.ctrlKey}(t)||function(t){return c.hoverShift&&t.shiftKey}(t)))return;const e=function({offsetNode:t,offset:e},n,o){if(t.nodeType!==Node.TEXT_NODE)return null;let r,i;const l=document.createRange();for(r=e;r>0&&s(t.nodeValue[r])&&s(t.nodeValue[r-1]);r--);for(i=e;i<t.nodeValue.length&&s(t.nodeValue[i]);i++);l.setStart(t,r),l.setEnd(t,i);const a=l.getBoundingClientRect();return a.top<o&&a.bottom>o&&a.left<n&&a.right>n?l:null}(document.caretPositionFromPoint(t.x,t.y),t.x,t.y),n=null!==e?e.toString():null;null!==n&&n.length>0&&g(n,e)}),c.hoverTimeout)}function h(){const t=window.getSelection(),e=t.toString().trim();(function(t){return/.*[a-zA-Z].*/.test(t)})(e)&&t.rangeCount>0&&g(e,t.getRangeAt(0))}function g(t,e){const n=e.getBoundingClientRect(),o={id:l,text:t,context:"",rect:{top:n.top,bottom:n.bottom,left:n.left}};c.contextCapturing&&(o.context=new r(e).getContext().getSentence()),f(o)}function f(t){t.frameIndex=C(),chrome.runtime.sendMessage(t)}function C(){let t=-1;for(let e=0;e<window.top.frames.length;e++)window.top.frames[e]===self&&(t=e);return t}function T(){Promise.all([n.getAllOptions(),i.getAll()]).then(u)}T(),document.documentElement.addEventListener("mousedown",(function(t){0===t.button?f({id:"proxy-content-close-popup"}):2===t.button&&f({id:"proxy-content-mouse",x:t.clientX,y:t.clientY})})),document.documentElement.addEventListener("dblclick",(function(t){c.doubleClick&&(!(c.doubleClickCtrl||c.doubleClickAlt||c.doubleClickMeta)||function(t){return c.doubleClickAlt&&t.altKey}(t)||function(t){return c.doubleClickCtrl&&t.ctrlKey}(t)||function(t){return c.doubleClickMeta&&t.metaKey}(t))&&h()})),chrome.runtime.onMessage.addListener((function(t){"proxy-content-refresh-popup"===t.id&&t.frameIndex===C()?h():"proxy-content-refresh-options"===t.id&&T()}))})();