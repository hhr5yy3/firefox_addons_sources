var highlights=[],highlight_id=0;function highlightRegex(e){return new RegExp(e.replace(/[.*+?|()\[\]{}\\$^]/g,"\\$&"),"ig")}function doHighlight(e,t,n,i,o,r,O,a,l,D,h,M){for(var g,d,s,c,m=document,p=("string"==typeof e&&(e=m.getElementById(e)),"string"==typeof i&&(i=highlightRegex(i)),o=o||0,r=r||0,[]),u=[],v=0,f=e.childNodes.length,N=0,C=[],w=!1;;){for(;v<f;)3===(d=e.childNodes[v++]).nodeType?"a"==d.parentNode.tagName.toLowerCase()&&"ipfootnote_ref"==d.parentNode.className||(p.push({i:N,n:d}),g=d.nodeValue,u.push(g),N+=g.length):1!==d.nodeType||0<=d.tagName.search(/^(script|style)$/i)||"sup"==d.tagName.toLowerCase()&&null!=d.getAttribute("data-footnote-ref")&&0==d.getAttribute("data-footnote-ref").indexOf("#ipfootnote")||(d.tagName.search(/^(a|b|basefont|bdo|big|em|font|i|s|small|span|strike|strong|su[bp]|tt|u)$/i)<0&&(u.push(" "),N++),(s=d.childNodes.length)&&(C.push({n:e,l:f,i:v}),e=d,f=s,v=0));if(!C.length)break;e=(c=C.pop()).n,f=c.l,v=c.i}if(p.length){var E,_,b,y,A,H,B,x,P,S,T,I,k,u=normalizeQuotes(u.join(""));p.push({i:u.length});for(var R=null,L=0;L<=r&&((R=i.exec(u))&&!(R.length<=o)&&R[o].length);L++);if(R){for(_=R.index,E=1;E<o;E++)_+=R[E].length;for(b=_+R[o].length,y=0,A=p.length;y<A;)_<p[L=y+A>>1].i?A=L:y=_>=p[L+1].i?L+1:A=L;for(H=y;H<p.length;)if(g=(e=(S=p[H]).n).nodeValue,B=e.parentNode,x=e.nextSibling,I=_-S.i,S=Math.min(b,p[H+1].i)-S.i,T=null,0<I&&(T=g.substring(0,I)),I=g.substring(I,S),k=null,S<g.length&&(k=g.substr(S)),T?e.nodeValue=T:B.removeChild(e),"bigfoot-footnote__button"!=B.className&&((P=m.createElement("span")).appendChild(m.createTextNode(I)),P.className=t,P.setAttribute("rel",n),P.setAttribute("data-api-id",O),P.addEventListener("click",M,!1),B.insertBefore(P,x)),k&&(a&&(newNodeContainer=createNoteIconAndPopover(n,l,h,r),B.insertBefore(newNodeContainer,x),w=!0),P=m.createTextNode(k),B.insertBefore(P,x),p[H]={n:P,i:b}),b<=p[++H].i)return void(a&&!w&&(newNodeContainer=createNoteIconAndPopover(n,l,h,r),B.insertBefore(newNodeContainer,x),w=!0))}}}function normalizeQuotes(e){return e.replace(/[‘|’]/g,"'").replace(/[“|”]/g,'"')}function normalizeText(e){return normalizeQuotes(e.trim().replace(/[.*+?|()\[\]{}\\$^]/g,"\\$&").replace(/\s+/g,"\\s+"))}function addHighlight(e,t,n,i,o){highlights.push({apiID:e,localID:t,text:n,position:i,note:o})}function quickHighlight(e,t,n,i,o,r){normalizedTextToFind=normalizeText(t),search_for=new RegExp(normalizedTextToFind,"ig"),doHighlight(document.body,"instapaper-highlight highlight-"+e,e,search_for,0,n,i,o,r,normalizedTextToFind,t,highlightTapped),addHighlight(i,e,t,n,r)}function createNoteIconAndPopover(e,t,n,i){(newNode=document.createElement("span")).setAttribute("id","ipnote-"+e),newNode.className="instapaper-ipicon instapaper-ipnote",newNode.setAttribute("rel",e),newNode.setAttribute("data-highlight",n),newNode.setAttribute("data-position",i),newNode.addEventListener("click",noteTapped,!1),t?newNode.setAttribute("data-comment",t):newNode.setAttribute("data-comment",""),(newNodeContainer=document.createElement("span")).setAttribute("id","ipnote-container-"+e),newNodeContainer.className="ipnote-container",newNodeContainer.appendChild(newNode),(commentPopover=document.createElement("div")).setAttribute("id","comment-popover-"+e),commentPopover.setAttribute("rel",e),commentPopover.className="ipnote-popover",(arrow=document.createElement("div")).className="arrow",commentPopover.appendChild(arrow),(commentEditHeader=document.createElement("div")).className="header",(cancelButton=document.createElement("div")).className="cancel-button",cancelButton.setAttribute("rel",e),cancelButton.addEventListener("click",noteCancelTapped,!1),cancelButton.appendChild(document.createTextNode("Cancel")),commentEditHeader.appendChild(cancelButton),(saveButton=document.createElement("div")).className="save-button",saveButton.setAttribute("rel",e),saveButton.appendChild(document.createTextNode("Save")),saveButton.addEventListener("click",noteSaveTapped,!1),commentEditHeader.appendChild(saveButton),commentPopover.appendChild(commentEditHeader);n=t&&0<t.length?"Comment":"New Note";return(title=document.createElement("div")).className="ipnote-title",title.setAttribute("id","ipnote-title-"+e),title.appendChild(document.createTextNode(n)),commentEditHeader.appendChild(title),(commentTextArea=document.createElement("textarea")).setAttribute("id","comment-textarea-"+e),commentTextArea.value=t||"",commentPopover.appendChild(commentTextArea),newNodeContainer.appendChild(commentPopover),newNodeContainer}function htmlDecode(e){var t=document.createElement("div");return t.innerHTML=e,0===t.childNodes.length?"":t.childNodes[0].nodeValue}function highlightWithJson(e){for(var t=0;t<e.length;t++)try{var n=htmlDecode(e[t].text);n.length&&quickHighlight(highlight_id++,n,e[t].position,e[t].highlight_id,e[t].note&&0<e[t].note.length,htmlDecode(e[t].note))}catch(e){}}function indexOfSelectedTextOccurrence(){for(var e=textSelection(),t=e.getRangeAt(0),n=document.createRange(),i=(n.setStartBefore(document.body),n.setEnd(t.startContainer,t.startOffset),n.toString()),o=highlightRegex(e.toString()),r=0;o.exec(i);)r++;return r}function createHighlight(){window.highlights_this_month+=1,highlightSelection(!1),hideHighlightPopovers()}function createNote(){window.highlights_this_month+=1;var e=highlightSelection(!0);hideHighlightPopovers(),showNotePopover(e)}function highlightSelection(e){var t=textSelection();if(t&&!(t.toString().length<=1)){for(var n=[],i=document.getElementsByClassName("instapaper-highlight"),o=0;o<i.length;o++){var r=parseInt(i[o].getAttribute("rel"));t.containsNode&&t.containsNode(i[o],!1)&&-1==n.indexOf(r)&&n.push(r)}var a=t.toString(),l=highlight_id++,h=indexOfSelectedTextOccurrence();quickHighlight(l,a,h,-1,e);for(o=0;o<n.length;o++)removeHighlight(n[o]);return clearSelection(),e||postHighlight(l,a,h,void 0),l}console.log("No selection")}function removeHighlightWithClass(e,t){for(var n=document.getElementsByClassName(e),i=0;i<n.length;i++)removeClass(n[i],t)}function removeFromHighlightArray(e){for(var t=0;t<window.highlights.length;t++)if(window.highlights[t].localID==e){window.highlights.splice(t,1);break}}function removeHighlightWithAPI(e,t){for(var n=document.getElementsByClassName("highlight-"+e),i=-1,o=0;o<n.length;o++)try{i=n[o].getAttribute("data-api-id"),removeClass(n[o],"instapaper-highlight"),n[o].removeAttribute("rel"),n[o].removeAttribute("data-api-id"),n[o].removeEventListener("click",highlightTapped)}catch(e){}removeNote(e),-1!=i&&t&&(--window.highlights_this_month,chrome.runtime.sendMessage({message:"remove_highlight",highlight_id:i}));for(o=0;o<n.length;o++)n[o].removeAttribute("class")}function removeHighlight(e){removeHighlightWithAPI(e,!0)}function removeNote(e){e=document.getElementById("ipnote-container-"+e);e&&e.parentNode.removeChild(e)}highlight_id=0;function highlightTapped(e){e.stopPropagation();for(var e=e.target,t=e.getBoundingClientRect().top,n=e.getBoundingClientRect().left,i=e.getBoundingClientRect().right,o=document.getElementsByClassName("highlight-"+e.getAttribute("rel")),r=0;r<o.length;r++){var a=o[r].getBoundingClientRect();a.top<t&&(t=a.top),a.left<n&&(n=a.left),a.right>i&&(i=a.right)}hideHighlightPopovers(),(highlight_delete_popover=document.getElementById("highlight_delete_popover")).style.top=window.pageYOffset+t-50+"px",highlight_delete_popover.style.left=(n+i)/2+"px",addClass(highlight_delete_popover,"reveal"),highlight_delete_popover.setAttribute("data-highlight-id",e.getAttribute("rel")),highlight_delete_popover.setAttribute("data-api-id",e.getAttribute("data-api-id"))}function noteTapped(e){e.stopPropagation();var e=e.target.getAttribute("rel"),t=document.getElementById("comment-popover-"+e);hasClass(t,"showing")&&shouldDismissPopover(e)?(hideHighlightPopovers(),removeClass(t,"showing")):(hideHighlightPopovers(),addClass(t,"showing"),document.getElementById("comment-textarea-"+e).focus())}function noteCancelTapped(e){e.stopPropagation();var t=e.target.getAttribute("rel"),e=document.getElementById("comment-popover-"+t),n=document.getElementById("ipnote-"+t),i=n.getAttribute("data-comment");i&&0!=i.length?(document.getElementById("comment-textarea-"+t).value=i,removeClass(e,"showing")):(n.style.display="none",removeHighlightWithClass("highlight-"+t,"highlight"),removeClass(e,"showing"),setTimeout(function(){removeHighlight(t)},500))}function noteSaveTapped(e){var t=e.target.getAttribute("rel"),e=document.getElementById("ipnote-"+t),n=document.getElementById("comment-popover-"+t),i=e.getAttribute("data-comment"),o=i&&0<i.length,r=document.getElementById("comment-textarea-"+t).value;o||0!=r.length?(e.setAttribute("data-comment",r),o?i==r?removeClass(n,"showing"):(updateNote(t,r),removeClass(n,"showing"),0==r.length&&setTimeout(function(){removeNote(t)},350)):(o=e.getAttribute("data-highlight"),i=e.getAttribute("data-position"),document.getElementById("ipnote-title-"+t).innerText="Comment",postHighlight(t,o,i,r),removeClass(n,"showing"))):alert("Your note is empty!")}function textSelection(){return window.getSelection?window.getSelection():document.getSelection?document.getSelection():document.selection||void 0}function clearSelection(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()}function ancestor(e,t){for(;(e=e.parentElement)&&!e.classList.contains(t););return e}function shouldDismissPopover(e){var t=document.getElementById("comment-textarea-"+e),e=document.getElementById("ipnote-"+e).getAttribute("data-comment");return e&&e.length&&e==t.value}function dismissCommentPopovers(e){if(!ancestor(e.target,"ipnote-popover"))for(var t=document.getElementsByClassName("ipnote-popover showing"),n=0;n<t.length;n++)shouldDismissPopover(t[n].getAttribute("rel"))&&removeClass(t[n],"showing")}function bannedElements(){banned=[];for(var e=document.getElementById("titlebar"),t=(null!=e&&banned.push(e),document.getElementsByClassName("bigfoot-footnote__content")),n=0;n<t.length;n++)banned.push(t[n]);return banned}function isParentEditable(e){return null!=e&&-1==["BODY","HTML"].indexOf(e.tagName)&&(null!=e.getAttribute("contenteditable")||-1!=["INPUT","TEXTAREA"].indexOf(e.tagName)||isParentEditable(e.parentNode))}function isValidForPopover(){var e,t;return!!window.instapaperHighlightsBookmarkId&&!!document.getElementById("highlight_create_popover")&&!(!(e=textSelection())||e.toString().length<=1||e.toString().split(/\s+/).length<4||(t=window.location.hostname,-1!=["docs.google.com","mail.google.com","facebook.com","twitter.com","x.com","instapaper.com"].indexOf(t))||isParentEditable(e.getRangeAt(0).commonAncestorContainer.parentNode))}function isValidHighlightSelection(){var e=textSelection();if(!e||e.toString().length<=1)return!1;for(var t=bannedElements(),n=0;n<t.length;n++)if(e.containsNode&&(e.containsNode(t[n],!1)||e.containsNode(t[n],!0)))return!1;for(var i=document.getElementsByClassName("ipnote-popover showing"),n=0;n<i.length;n++){var o=i[n].getAttribute("rel"),r=document.getElementById("comment-textarea-"+o),o=document.getElementById("ipnote-"+o).getAttribute("data-comment");if(o&&o.length&&o!=r.value)return!1}for(var a=document.getElementsByClassName("instapaper-highlight"),n=0;n<a.length;n++)if(e.containsNode&&!e.containsNode(a[n],!1)&&e.containsNode(a[n],!0))return!1;return!0}function isValidSelectionForContextMenu(){var e=textSelection();return!(!e||e.toString().length<=1||!(e=e.getRangeAt(0))||e.startContainer.parentNode==e.endContainer.parentNode&&"A"===e.startContainer.parentNode.tagName)&&isValidHighlightSelection()}function checkForValidHighlightSelection(e,t){setTimeout(function(){isValidHighlightSelection()&&null!=window.instapaperHighlightsBookmarkId?(hideHighlightPopovers(),e.altKey?chrome.runtime.sendMessage({message:"storage",keys:["highlights_enabled","highlight_quick"]}).then(e=>{e.highlights_enabled&&e.highlight_quick&&createHighlight()}):isValidForPopover()&&chrome.runtime.sendMessage({message:"storage",keys:["highlights_enabled","highlight_menu"]}).then(e=>{var t;e.highlights_enabled&&e.highlight_menu&&(e=textSelection().getRangeAt(0).getBoundingClientRect(),t=window.pageYOffset+e.top-50+"px",showHighlightCreatePopover(e.left+e.width/2+"px",t))})):t&&hideHighlightPopovers()},0)}function showHighlightCreatePopover(e,t){var n=document.getElementById("highlight_create_popover");n.style.top=t,n.style.left=e,addClass(n,"reveal")}function hideHighlightPopovers(){var e=document.getElementById("highlight_create_popover"),t=document.getElementById("highlight_delete_popover");e&&removeClass(e,"reveal"),t&&removeClass(t,"reveal")}function addClass(e,t){e.className+=" "+t}function removeClass(e,t){for(var n="",i=e.className.split(" "),o=0;o<i.length;o++)i[o]!=t&&(n+=i[o],o!=i.length-1)&&(n+=" ");e.className=n}function toggleClass(e,t){(hasClass(e,t)?removeClass:addClass)(e,t)}function hasClass(e,t){return-1!=e.className.indexOf(t)}function updateNote(e,t){e=document.getElementsByClassName("highlight-"+e)[0],e=e?e.getAttribute("data-api-id"):void 0;e?chrome.runtime.sendMessage({message:"update_note",api_id:e,note:t}):alert("There was an error updating your comment, please try again!")}function selectionHTML(){var e=window.getSelection().getRangeAt(0),t=document.createElement("span");return t.appendChild(e.cloneContents()),t.innerHTML}function getElementByXpath(e){return document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}function dropEmptyElems(e){if(null==e)return null;for(var t=[],n=0;n<e.childNodes.length;n++)3!=(childNode=e.childNodes[n]).nodeType&&(null!=childNode.innerText&&!hasClass(childNode,"ipnote")&&0!=childNode.innerText.replace(/(\r\n|\n|\r)/gm," ").trim().length||t.push(childNode),childNode.childNodes.length)&&dropEmptyElems(childNode);for(n=0;n<t.length;n++)(emptyElem=t[n]).parentNode&&emptyElem.parentNode.removeChild(emptyElem);return e}function dataBeforeSelection(){var e=window.getSelection().getRangeAt(0),t=document.createRange(),n=document.getElementById("story"),i=getElementByXpath('//div[@id="story"]/div/small/em[starts-with(text(), "HolyParser")]/../..'),i=(i?t.setStartAfter(i):t.setStartBefore(n),t.setEnd(e.startContainer,e.startOffset),t.toString().replace("CancelSaveComment"," ").replace(/(\r\n|\n|\r)/gm," ").trim()),n=(200<i.length&&(i=i.substr(i.length-200,200)),document.createElement("span")),e=dropEmptyElems(t.cloneContents()),t=(n.appendChild(e),n.innerHTML);return{text:i,html:t=200<t.length?t.substr(t.length-200,200):t}}function dataAfterSelection(){var e=window.getSelection().getRangeAt(0),t=document.createRange(),n=document.getElementById("story"),i=n,n=(0<n.childNodes.length&&(i=n.childNodes[n.childNodes.length-1]),t.setStart(e.endContainer,e.endOffset),t.setEndAfter(i),t.toString().replace("CancelSaveComment"," ").replace(/(\r\n|\n|\r)/gm," ").trim()),e=document.createElement("span"),i=dropEmptyElems(t.cloneContents());return e.appendChild(i),{text:n.substr(0,200),html:e.innerHTML.substr(0,200)}}function postHighlight(e,t,n,i){chrome.runtime.sendMessage({message:"create_highlight",bookmark_id:window.instapaperHighlightsBookmarkId,local_id:e,text:t,position:n,comment:i})}function showNotePopover(e){var t=document.getElementById("comment-popover-"+e);t&&setTimeout(function(){addClass(t,"showing"),document.getElementById("comment-textarea-"+e).focus()},10)}function deleteHighlight(e){var t=document.getElementById("highlight_delete_popover");removeHighlight(t.getAttribute("data-highlight-id")),t.classList.remove("reveal"),e.stopPropagation()}function createPopover(e){var t=document.createElement("div");return t.setAttribute("id",e),t.setAttribute("class","highlight_popover"),t.onmousedown=function(e){return e.stopPropagation(),!1},t}function createPopoverButton(e,t,n){var i=document.createElement("a"),e=(i.setAttribute("class",e),document.createElement("span"));return e.setAttribute("class",t),i.appendChild(e),n&&(t=document.createTextNode(n),i.appendChild(t)),i}function createPopoverArrow(){var e=document.createElement("div");return e.setAttribute("class","highlight_arrow"),e}function insertHighlightDeletePopover(){var e=createPopover("highlight_delete_popover"),t=createPopoverButton("highlight_button highlight_left_button highlight_right_button","instapaper-ipicon instapaper-ipicon-delete-dark"," Remove Note ");e.appendChild(t),e.appendChild(createPopoverArrow()),e.onclick=deleteHighlight,document.body.appendChild(e)}function insertHighlightCreatePopover(){var e=createPopover("highlight_create_popover"),t=createPopoverButton("highlight_button highlight_left_button","instapaper-ipicon instapaper-ipicon-highlights-dark",void 0),n=(t.onclick=createHighlight,createPopoverButton("highlight_button highlight_right_button","instapaper-ipicon instapaper-ipicon-note-create",void 0));n.onclick=createNote,e.appendChild(t),e.appendChild(n),e.appendChild(createPopoverArrow()),e.onclick=deleteHighlight,document.body.appendChild(e)}function setHighlightApiID(e,t){for(var n=document.getElementsByClassName("highlight-"+e),i=0;i<n.length;i++)n[i].setAttribute("data-api-id",t)}document.addEventListener("click",function(e){dismissCommentPopovers(e),checkForValidHighlightSelection(e,!0)},!1),document.addEventListener("mouseup",function(e){checkForValidHighlightSelection(e,!1)},!1),document.addEventListener("touchend",function(e){checkForValidHighlightSelection(e,!1)},!1),window.addEventListener("resize",function(e){hideHighlightPopovers(),dismissCommentPopovers(e)}),chrome.runtime.onMessage.addListener(function(e,t,n){if("highlights_response"==e.message)for(var i=e.highlights,o=0;o<i.length;o++){var r=i[o];quickHighlight(highlight_id++,r.text,0,r.id,null!=r.note,r.note)}else if("highlight_selection"==e.message)createHighlight();else if("note_selection"==e.message)createNote();else if("highlight_created"==e.message)setHighlightApiID(e.local_id,e.api_id);else if("highlight_error"==e.message){var a=e.note?"note":"highlight";removeHighlight(e.local_id),alert("There was an error creating that "+a+". ("+e.code+")")}else if("highlight_premium"==e.message)removeHighlight(e.local_id),window.instapaperShowPremiumModal("Sorry! You've exceeded your limit of 5 free notes per month. Upgrade to Premium for...");else if("bookmarklet_status"==e.message&&"success"==e.status&&!e.link_save){a=JSON.parse(e.response);if(0<(i=(i=a.highlights)||[]).length){if(0<highlight_id){for(o=0;o<highlight_id;o++)removeHighlightWithAPI(o,!1);highlight_id=0}clearSelection()}window.highlights_this_month=a.num_highlights_this_month;for(o=0;o<i.length;o++){r=i[o];quickHighlight(highlight_id++,r.text,r.position,r.highlight_id,null!=r.note,r.note)}insertHighlightCreatePopover(),insertHighlightDeletePopover()}}),document.addEventListener("selectionchange",function(e){var t=isValidSelectionForContextMenu();chrome.runtime.sendMessage({message:"valid_selection",valid:t})});
