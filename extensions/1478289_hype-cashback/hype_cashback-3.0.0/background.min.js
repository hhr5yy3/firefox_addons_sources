const baseUrl="https://www.hype.it/offerte",buyonMerchantsEndpoint="https://api.buyon.it/buyon/merchants?campaign=hype";function getBuyonMerchants(e=!1){return new Promise((n=>{chrome.storage.local.get("buyonMerchants",(t=>{if(t.buyonMerchants&&!e){let e=JSON.parse(t.buyonMerchants);n(e)}else{let e=new Request(buyonMerchantsEndpoint);fetch(e).then((e=>e.text())).then((e=>{let t=parseBuyonMerchants(e);setBuyonMerchants(t),chrome.storage.local.set({buyonmerchants:e}),n(t)}))}}))}))}function setBuyonMerchants(e){return new Promise((n=>{chrome.storage.local.set({buyonMerchants:JSON.stringify(e)},(()=>{n()}))}))}function parseBuyonMerchants(e){let n=JSON.parse(e),t={};for(let e=0;e<n.length;e++){let o=n[e],r=o.UrlToolbar.split("|");for(let e=0;e<r.length;e++){let n=r[e].replace(/^\.+|\.+$/g,""),s=removeExtension(n);s&&(t[s]={id:o.Id,idTdMerchant:o.IdTdMerchant,name:o.Name,cashback:0==o.NoCashback?`${o.SalesCommission.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}${currencySymbol(o.CommissionCurrency)}`:"",hostname:n,domainKey:s})}}return t}function currencySymbol(e){return"eur"===e?"€":"usd"===e?"$":"gbp"===e?"£":e}function initAlarm(){chrome.alarms.clearAll((()=>{chrome.alarms.create("refresh",{periodInMinutes:30}),chrome.alarms.create("wakeup",{periodInMinutes:3})}))}function getHostname(e){if(null==e)return null;let n=e.match(/:\/\/(www[0-9]?\.)?(.[^/:]+)/i);return null!=n&&n.length>2&&"string"==typeof n[2]&&n[2].length>0?n[2]:null}function getHostnameWithoutExtension(e){return removeExtension(getHostname(e))}function removeExtension(e){if(null==e)return null;let n=e.split(".");return n.length>2&&"co"==n[n.length-2]?n.slice(0,n.length-2).join("."):n.slice(0,n.length-1).join(".")}function getDomain(e){let n=getHostname(e),t=n;if(null!=n){let e=n.split(".").reverse();null!=e&&e.length>1&&(t=`${e[1]}.${e[0]}`,-1!=n.toLowerCase().indexOf(".co.")&&e.length>2&&(t=`${e[2]}.${t}`))}return t}function matchMerchant(e,n){let t=getHostnameWithoutExtension(e);return t in n?n[t]:(t=removeExtension(getDomain(e)),t in n?n[t]:null)}initAlarm(),getBuyonMerchants(!0),chrome.browserAction.onClicked.addListener((()=>{chrome.tabs.create({url:baseUrl})})),chrome.runtime.onMessage.addListener(((e,n,t)=>("close"==e.command&&chrome.storage.session.get("closed",(n=>{let t=n.closed?n.closed:[];t.includes(e.id)||(t.push(e.id),chrome.storage.session.set({closed:t}))})),"check"==e.command&&chrome.storage.local.get({openNewWindow:!0},(o=>{chrome.tabs.get(n.tab.id,(async()=>{let n=await getBuyonMerchants(),r=matchMerchant(e.url,n);null!=r&&"HYPE"!=r.name?chrome.storage.session.get("closed",(n=>{let s=n.closed?n.closed:[];if(e.fromHype&&(s.push(r.id),chrome.storage.session.set({closed:s})),s.includes(r.id))t(null);else{let e={merchant:r,openNewWindow:o.openNewWindow};t(e)}})):t(null)}))})),!0)));