const aBrowser=chrome||browser;let clockifyOrigins=[];document.addEventListener("DOMContentLoaded",initLoad),document.getElementById("settings__permissions-container").addEventListener("click",(e=>{"INPUT"===e.target.tagName&&"checkbox"===e.target.type&&save_permissions()})),aBrowser.runtime.onMessage.addListener(((e,t,s)=>{"closeOptionsPage"===e.eventName&&window.close()}));const integrationsTab=document.getElementById("integrationsTab");function createOriginList(){fetch("integrations/integrations.json").then((e=>e.json())).then((e=>{clockifyOrigins=e,addIntegrationsInPermissionsIfNewIntegrationsExist(clockifyOrigins);let t,s=document.createElement("select");s.id="origins",s.style.minHeight="2em",s.style.marginRight="10px";let n=document.getElementById("settings__permissions-container");n.style.height="500px",n.style.width="500px",n.style.overflowY="scroll",n.style.border="1px solid #bbb",n.style.borderRadius="2px";for(let i in e){if(!e[i].script.includes("custom-")){const t=addCheckbox(i,e[i]);n.appendChild(t)}createOriginListForCustomDomain(e,i,t,s)}addGenericIntegrationToList(t,s),replaceContent("#settings__custom-domains__origins-container",s),setTimeout((()=>restore_options()),0)}))}function createOriginListForCustomDomain(e,t,s,n){(s=document.createElement("option")).id="origin",s.value=t,s.setAttribute("data-id",t),s.textContent=e[t].name,n.appendChild(s)}function addGenericIntegrationToList(e,t){(e=document.createElement("option")).id="origin",e.value="generic-integration",e.setAttribute("data-id","generic-integration"),e.textContent="Generic integration",t.appendChild(e)}function initLoad(){aBrowser.storage.local.get(["locale_messages","lang"],(async e=>{await clockifyLocales.onProfileLangChange(e.lang);const t=document.createElement("script");t.src="contentScripts/clockifyLocales.js",document.body.appendChild(t),t.onload=()=>{aBrowser.storage.local.get("token",(e=>{e.token&&(integrationsTab.innerText=clockifyLocales.INTEGRATIONS,document.getElementById("h11").innerText=`Clockify - ${clockifyLocales.INTEGRATIONS}`,document.getElementById("h21").innerText=clockifyLocales.ENABLE_INTEGRATIONS,document.getElementById("p11").innerText=clockifyLocales.ENABLE_TOOLS+"\n"+clockifyLocales.ENABLE_ALL_INTEGRATIONS,document.getElementById("enable-all").innerText=clockifyLocales.ENABLE_ALL,document.getElementById("disable-all").innerText=clockifyLocales.DISABLE_ALL,document.getElementById("custom-domains").innerText=clockifyLocales.CUSTOM_DOMAINS,document.getElementById("tool-hosted").innerText=clockifyLocales.HOSTED_ON_CUSTOM_DOMAIN+"\n"+clockifyLocales.ENTER_DOMAIN_NAME+"\n"+clockifyLocales.PORTS_NOT_SUPPORTED,document.getElementById("add-custom-domain").innerText=clockifyLocales.ADD,document.getElementById("custom-domain-url").placeholder=clockifyLocales.CUSTOM_DOMAINS+" url")}))}})),aBrowser.storage.local.get(["permissions","userId"],(e=>{const{userId:t}=e;let{permissions:s}=e;s||(s=[]);let n=s.filter((e=>e.userId===t));if(n.length>0)createOriginList(),showCustomDomains();else{n={userId:t,permissions:[]};for(let e in clockifyOrigins){const t=clockifyOrigins[e];n.permissions.push({domain:e,isEnabled:!0,script:t.script,name:t.name,isCustom:!0})}s.push(n),aBrowser.storage.local.set({permissions:s},(()=>{createOriginList(),showCustomDomains()}))}}))}function restore_options(){aBrowser.storage.local.get(["permissions","userId"],(e=>{const{userId:t}=e;if(e&&e.permissions&&e.permissions.length>0){const s=e.permissions.filter((e=>e.userId===t))[0];if(!s)return;const n=s.permissions.filter((e=>!e.isCustom&&!e.script.includes("custom-")));for(let e in n){const t=document.getElementById(n[e].domain);t&&(t.checked=n[e].isEnabled)}}}))}function save_permissions(){aBrowser.storage.local.get(["permissions","userId"],(e=>{const{userId:t}=e;if(e&&e.permissions&&e.permissions.length>0){const s=e.permissions,n=e.permissions.filter((e=>e.userId===t))[0];if(!n)return;const i=n.permissions.filter((e=>!e.isCustom&&!e.script.includes("custom-")));for(let e in i){let t=i[e];const s=document.getElementById(i[e].domain);s&&(t.isEnabled=s.checked)}aBrowser.storage.local.set({permissions:s})}}))}function addCustomDomain(){aBrowser.storage.local.get(["permissions","userId"],(e=>{const{userId:t}=e;let s=extractCustomDomain(document.getElementById("custom-domain-url").value);const n=document.querySelector("#origins").value,i=e.permissions,o=e.permissions.filter((e=>e.userId===t))[0];let r={};if(o){for(let e in clockifyOrigins)if(e===n){r.domain=s,r.isEnabled=!0,r.script=clockifyOrigins[e].script,r.name=clockifyOrigins[e].name,r.isCustom=!0,r.urlPattern=`*://${s}/*`,o.permissions.unshift(r);break}"generic-integration"===n&&(r.domain=s,r.isEnabled=!0,r.script="generic-integration.js",r.name=s,r.isCustom=!0,r.urlPattern=`*://${s}/*`,o.permissions.unshift(r))}aBrowser.storage.local.set({permissions:i},(()=>{document.getElementById("custom-domain-url").value="",showCustomDomains()}))}))}function showCustomDomains(){let e,t,s=document.createElement("ul");s.id="custom-permissions-list",s.className="settings__custom-domains__custom-origin-list",aBrowser.storage.local.get(["permissions","userId"],(n=>{const{userId:i}=n;n.permissions.filter((e=>e.userId===i))[0].permissions.filter((e=>e.isCustom)).forEach((n=>{e=document.createElement("li"),t=document.createElement("a"),t.className="settings__custom_domains__remove",t.textContent="delete",e.appendChild(t),t=document.createElement("strong"),t.textContent=n.domain,e.appendChild(t),e.appendChild(document.createTextNode(" - ")),t=document.createElement("i"),t.textContent=n.name,e.appendChild(t),s.appendChild(e)})),s.childNodes.length>0?replaceContent("#settings__custom-domains__custom-perm-container",s):document.getElementById("settings__custom-domains__custom-perm-container").childNodes.length>0&&document.getElementById("settings__custom-domains__custom-perm-container").removeChild(document.getElementById("custom-permissions-list"))}))}function removeCustomDomain(e){let t,s;"settings__custom_domains__remove"===e.target.className&&(s=e.target.parentNode,t=s.querySelector("strong").textContent,aBrowser.storage.local.get(["permissions","userId"],(e=>{const{userId:s}=e,n=e.permissions,i=e.permissions.filter((e=>e.userId===s))[0].permissions;i.splice(i.findIndex((e=>e.isCustom&&e.domain===t)),1),aBrowser.storage.local.set({permissions:n},(()=>{showCustomDomains()}))})))}function filterPermissions(e){let t,s=document.getElementById("settings__permissions-container");for(let n in s.getElementsByTagName("div"))if(isNaN(n)||(t=s.childNodes[n]),t){const s=t.getElementsByTagName("input")[0],n=e.target.value?.toLowerCase();s.id.includes(n)?t.style.display="block":t.style.display="none"}}function addCheckbox(e,t){let s=document.createElement("div"),n=document.createElement("label"),i=document.createElement("input");return s.id="div-"+e,s.style.display="flex",s.style.alignItems="center",s.style.borderBottom="1px solid #e8e8e8",i.type="checkbox",i.id=e,s.appendChild(i),n.style.display="inline-block",n.style.marginLeft="15px",n.textContent=t.name+" - "+e,s.appendChild(n),s}function enableAllOrigins(){for(let e in clockifyOrigins){const t=document.getElementById(e);t&&(t.checked=!0)}save_permissions()}function disableAllOrigins(){for(let e in clockifyOrigins){const t=document.getElementById(e);t&&(t.checked=!1)}save_permissions()}function replaceContent(e,t){const s=document.querySelector(e);for(;s.firstChild;)s.removeChild(s.firstChild);s.appendChild(t)}function extractCustomDomain(e){return e.includes("://")?e=e.split("://")[1]:e.includes("/")&&(e=e.split("/")[0]),e}function openTab(e){let t,s,n,i;for(i=e.target.textContent.trim().toLowerCase(),s=document.getElementsByClassName("settings__content"),t=0;t<s.length;t++)s[t].style.display="none";for(n=document.getElementsByClassName("settings__tablinks"),t=0;t<n.length;t++)n[t].className=n[t].className.replace(" active","");document.getElementById(i).style.display="block",e.currentTarget.className+=" active"}function addIntegrationsInPermissionsIfNewIntegrationsExist(e){aBrowser.storage.local.get(["permissions","userId"],(e=>{const{userId:t}=e;let s=e.permissions;const n=s.filter((e=>e.userId===t))[0],i=n.permissions.map((e=>e.domain));for(let e in clockifyOrigins)if(!i.includes(e)){let t={};t.domain=e,t.isEnabled=!0,t.script=clockifyOrigins[e].script,t.name=clockifyOrigins[e].name,t.isCustom=!1,n.permissions.push(t)}s=s.map((e=>(e.userId===t&&(e.permissions=n.permissions),e))),aBrowser.storage.local.set({permissions:s})}))}integrationsTab.className+=" active",document.getElementById("enable-all").addEventListener("click",enableAllOrigins),document.getElementById("disable-all").addEventListener("click",disableAllOrigins),document.getElementById("permission-filter").addEventListener("keyup",filterPermissions),document.getElementById("add-custom-domain").addEventListener("click",addCustomDomain),document.querySelector("#settings__custom-domains__custom-perm-container").addEventListener("click",removeCustomDomain),integrationsTab.addEventListener("click",openTab);