var ADDON_HOST=browser.runtime.getURL(""),SIDEBAR_URL=browser.runtime.getURL("/sidebar/sidebar.html"),GROUP_URL=browser.runtime.getURL("/sidebery/group.html"),GROUP_URL_LEN=GROUP_URL.length,URL_URL=browser.runtime.getURL("/sidebery/url.html"),URL_URL_LEN=URL_URL.length,SETUP_URL=browser.runtime.getURL("/page.setup/setup.html"),SEARCH_URL=browser.runtime.getURL("/popup.search/search.html");var IMG_RE=/(\.png|\.jpe?g|\.gif|\.webp|\.svg)([?#].*)?$/i,VID_RE=/(\.mp4|\.webm)([?#].*)?$/i,MUS_RE=/(\.mp3|\.flac)([?#].*)?$/i,FILE_RE=/(^file:.*|\.pdf)([?#].*)?$/;var NOID=-1;var UNDERSCORE_RE=/_/g;async function sleep(ms=1e3){return new Promise(wakeup=>{setTimeout(wakeup,ms)})}function toCSSVarName(key){return`--${key.replace(UNDERSCORE_RE,"-")}`}var SIZE=Math.trunc(16*window.devicePixelRatio),THRESHOLD_BYTES_DIFF=150*window.devicePixelRatio;function getFavPlaceholder(url){if(url.startsWith("m")){if(url.startsWith(GROUP_URL))return"#icon_group";if(url.startsWith(URL_URL))return"#icon_link_favicon";if(url.startsWith(SETUP_URL))return"#icon_settings"}if(IMG_RE.test(url))return"#icon_img";if(VID_RE.test(url))return"#icon_vid";if(MUS_RE.test(url))return"#icon_music";if(FILE_RE.test(url))return"#icon_local_file";if(url.startsWith("a")){if(url.startsWith("about:new")||url.startsWith("about:bla"))return"#icon_ff";if(url.startsWith("about:pre")||url.startsWith("about:con"))return"#icon_pref";if(url.startsWith("about:add"))return"#icon_addons";if(url.startsWith("about:per"))return"#icon_perf";if(url.startsWith("about:dev"))return"#icon_code";if(url.startsWith("about:proc"))return"#icon_perf";if(url.startsWith("about:prot"))return"#icon_dashboard";if(url.startsWith("about:debug"))return"#icon_dev"}return"#icon_ff"}function applyThemeSrcVars(parsed,rootEl){if(rootEl||(rootEl=document.getElementById("root")??void 0),!!rootEl)for(let prop of Object.keys(parsed.vars)){let value=parsed.vars[prop];value?rootEl.style.setProperty(toCSSVarName("s_"+prop),value):rootEl.style.removeProperty(toCSSVarName("s_"+prop))}}async function loadCustomGroupCSS(){let stored=await browser.storage.local.get("groupCSS");applyCustomCSS(stored.groupCSS)}function applyCustomCSS(css){if(css==null)return;let customStyleEl=document.getElementById("custom_css");if(!customStyleEl)customStyleEl=document.createElement("style"),customStyleEl.id="custom_css",customStyleEl.type="text/css",customStyleEl.rel="stylesheet",document.head.appendChild(customStyleEl);else for(;customStyleEl.lastChild;)customStyleEl.removeChild(customStyleEl.lastChild);css&&customStyleEl.appendChild(document.createTextNode(css))}function getInstanceName(instance){return instance===2?"sidebar":instance===0?"bg":instance===3?"setup":instance===1?"group":instance===6?"proxy":instance===5?"url":instance===4?"search":instance===7?"preview":"unknown"}var _type="unknown",_winId="",_tabId="";function setInstanceType(type){_type=getInstanceName(type)}function setWinId(id){id!==NOID&&(_winId=`:${id}`)}function setTabId(id){id!==NOID&&(_tabId=`:${id}`)}function warn(msg,...args){console.warn(`[${_type}${_winId}${_tabId}] ${msg}`,...args)}function err(msg,err2){msg=`[${_type}${_winId}${_tabId}] ${msg}
`,err2!==void 0?console.error(msg,err2):console.error(msg)}var MSG_CONFIRMATION_MAX_DELAY=5e3,CONNECT_CONFIRMATION_MAX_DELAY=5e3,actions,_localType=-1,_localWinId=NOID,_localTabId=NOID,state={bgConnection:void 0,searchPopupConnections:new Map,sidebarConnections:new Map,setupPageConnections:new Map,groupPageConnections:new Map,previewConnection:void 0};function setInstanceType2(type){_localType=type}function setWinId2(id){_localWinId=id}function setTabId2(id){_localTabId=id}function getConnection(type,id){if(type===0&&state.bgConnection)return state.bgConnection;if(type===2)return state.sidebarConnections.get(id);if(type===3)return state.setupPageConnections.get(id);if(type===4)return state.searchPopupConnections.get(id);if(type===1)return state.groupPageConnections.get(id);if(type===7)return state.previewConnection}function createConnection(type,id){let connection={type,id,reconnectCount:0};return type===0?state.bgConnection=connection:type===2?state.sidebarConnections.set(id,connection):type===3?state.setupPageConnections.set(id,connection):type===4?state.searchPopupConnections.set(id,connection):type===1?state.groupPageConnections.set(id,connection):type===7&&(state.previewConnection=connection),connection}var connectingTimeout;function connectTo(dstType,dstWinId=NOID,dstTabId=NOID){let srcType=_localType,srcWinId=_localWinId,srcTabId=_localTabId,toBg=dstType===0,toSidebar=dstType===2,toSetup=dstType===3,toSearch=dstType===4,toGroup=dstType===1,toPreview=dstType===7,id;if(toBg||toPreview)id=NOID;else if((toSidebar||toSearch)&&dstWinId!==NOID)id=dstWinId;else if((toSetup||toGroup)&&dstTabId!==NOID)id=dstTabId;else{err("IPC.connectTo: No destination id");return}let portNameData={srcType,dstType};srcWinId!==NOID&&(portNameData.srcWinId=srcWinId),srcTabId!==NOID&&(portNameData.srcTabId=srcTabId),dstWinId!==NOID&&(toSidebar||toSearch)&&(portNameData.dstWinId=dstWinId),dstTabId!==NOID&&(toSetup||toGroup)&&(portNameData.dstTabId=dstTabId);let portNameJson=JSON.stringify(portNameData),connection,connectionIsNew=!1,existedConnection=getConnection(dstType,id);existedConnection?connection=existedConnection:(connectionIsNew=!0,connection=createConnection(dstType,id)),connection.localPort&&connection.localPort.disconnect(),connection.localPort=browser.runtime.connect({name:portNameJson}),connection.postListener=msg=>{onPostMsg(msg,connection.localPort)},connection.localPort.onMessage.addListener(connection.postListener),connection.disconnectListener=port=>{port.onMessage.removeListener(connection.postListener),port.onDisconnect.removeListener(connection.disconnectListener),resolveUnfinishedCommunications(port),connection.localPort=void 0;let connectionIsRemoved=!1;if(connection.remotePort||(connectionIsRemoved=!0,toBg?state.bgConnection=void 0:toSidebar?state.sidebarConnections.delete(dstWinId):toSetup?state.setupPageConnections.delete(dstTabId):toSearch?state.searchPopupConnections.delete(dstWinId):toGroup?state.groupPageConnections.delete(dstTabId):toPreview&&(state.previewConnection=void 0)),connectionIsRemoved){let handlers=disconnectionHandlers.get(dstType);handlers&&handlers.forEach(cb=>cb(connection.id))}toBg&&connection.reconnectCount++<3&&(clearTimeout(connectingTimeout),connectingTimeout=setTimeout(()=>connectTo(dstType,dstWinId),120))},connection.localPort.onDisconnect.addListener(connection.disconnectListener),clearTimeout(connectingTimeout),connectingTimeout=setTimeout(()=>{connection.localPort&&!connection.localPort.error?connection.reconnectCount=0:err("IPC.connectTo: Cannot reconnect")},120);let conConfirmId=toBg?-1:-2,timeout=setTimeout(()=>{warn("IPC.connectTo: No confirmation:",getInstanceName(dstType)),msgsWaitingForAnswer.delete(conConfirmId)},CONNECT_CONFIRMATION_MAX_DELAY);return msgsWaitingForAnswer.set(conConfirmId,{timeout,portName:"",ok:()=>{if(connectionIsNew){let handlers=connectionHandlers.get(dstType);handlers&&handlers.forEach(cb=>cb(connection.id))}}}),connection.localPort}function bg(action,...args){let msg={dstType:0,action,args};return request(msg,2)}var msgsWaitingForAnswer=new Map,msgCounter=1;async function request(msg,autoConnectMode){if(msg.dstType===void 0)return Promise.reject("IPC.request: No dstType");let id=NOID;msg.dstType===2&&msg.dstWinId!==void 0?id=msg.dstWinId:msg.dstType===3&&msg.dstTabId!==void 0?id=msg.dstTabId:msg.dstType===4&&msg.dstWinId!==void 0?id=msg.dstWinId:msg.dstType===1&&msg.dstTabId!==void 0&&(id=msg.dstTabId);let connection=getConnection(msg.dstType,id),port=connection?.localPort??connection?.remotePort;return new Promise((ok,err2)=>{if(msg.dstType===void 0)return err2("IPC.request: No dstType");if(!port||port.error){if(autoConnectMode===0)return err2("IPC.request: No port");if(port?.error&&err("IPC.request: Target port has an error:",port?.error),port=void 0,autoConnectMode===2&&(warn("IPC.request: Cannot find appropriate port, trying to reconnect..."),port=connectTo(msg.dstType,msg.dstWinId,msg.dstTabId)),!port||port.error)return port?.error&&err("IPC.request: Target port has error:",port?.error),err2(`IPC.request: Cannot get target port for "${getInstanceName(msg.dstType)}"`)}let msgId=msgCounter++;msg.id=msgId;try{port.postMessage(msg)}catch(e){if(warn("IPC.request: Got error on postMessage, trying to reconnect...",e),port=connectTo(msg.dstType,msg.dstWinId,msg.dstTabId),!port||port.error)return port?.error&&err("IPC.request: Target port has error:",port?.error),err2(`IPC.request: Cannot get target port for "${getInstanceName(msg.dstType)}"`);try{port?.postMessage(msg)}catch(e2){let dstTypeName=getInstanceName(msg.dstType);return err(`IPC.request: Cannot post message to "${dstTypeName}":`,e2),err2(`IPC.request: Cannot post message to "${dstTypeName}": ${String(e2)}`)}}let timeout=setTimeout(async()=>{if(warn("IPC.request: No confirmation:",getInstanceName(msg.dstType),msg.action),msgsWaitingForAnswer.delete(msgId),port&&(port.error={message:"No confirmation"}),autoConnectMode===2)try{ok(await request(msg,0))}catch(e){err2(e)}else err2("IPC.request: No confirmation")},MSG_CONFIRMATION_MAX_DELAY);msgsWaitingForAnswer.set(msgId,{timeout,ok,err:err2,portName:port.name})})}var connectionHandlers=new Map;var disconnectionHandlers=new Map;function runActionFor(msg){if(msg.action!==void 0&&actions){let action=actions[msg.action];if(action)return msg.arg?action(msg.arg):msg.args?action(...msg.args):action()}}var runningAsyncActions=new Map;async function onPostMsg(msg,port){if(msg<0){let waiting=msgsWaitingForAnswer.get(msg);waiting&&(clearTimeout(waiting.timeout),waiting.ok&&waiting.ok(),msgsWaitingForAnswer.delete(-1));return}if(typeof msg=="number"){let waiting=msgsWaitingForAnswer.get(msg);waiting&&clearTimeout(waiting.timeout);return}if(!msg.action&&msg.id){let waiting=msgsWaitingForAnswer.get(msg.id);waiting&&(clearTimeout(waiting.timeout),msg.error&&waiting.err?waiting.err(msg.error):waiting.ok&&waiting.ok(msg.result),msgsWaitingForAnswer.delete(msg.id));return}let result,error;try{result=runActionFor(msg)}catch(err2){error=String(err2),err(`IPC.onPostMsg: Error on running "${String(msg.action)}" action:`,err2)}if(msg.id&&port)if(result instanceof Promise){let msgId=msg.id;try{port.postMessage(msgId)}catch(err2){err(`IPC.onPostMsg: Error on sending "${String(msg.action)}" action confirm:`,err2);return}let finalResult,error2;try{runningAsyncActions.set(msgId,port.name),finalResult=await result}catch(err2){error2=String(err2)}if(runningAsyncActions.has(msgId))runningAsyncActions.delete(msgId);else return;try{port.postMessage({id:msgId,result:finalResult,error:error2})}catch(err2){err(`IPC.onPostMsg: Error on sending "${String(msg.action)}" action result:`,err2);return}}else try{port.postMessage({id:msg.id,result,error})}catch(err2){err(`IPC.onPostMsg: Error on sending "${String(msg.action)}" action result:`,err2)}}function resolveUnfinishedCommunications(port){for(let[msgId,waiting]of msgsWaitingForAnswer)waiting.portName===port.name&&(clearTimeout(waiting.timeout),waiting.err&&waiting.err("IPC: Target disconnected"),msgsWaitingForAnswer.delete(msgId));for(let[msgId,portName]of runningAsyncActions)portName===port.name&&runningAsyncActions.delete(msgId)}var PIN_SCREENSHOT_QUALITY=90,SCREENSHOT_QUALITY=25,tabsBoxEl,newTabEl,groupWinId,groupTabId,groupTabIndex,groupLayout,pinTab,tabs,groupLen,groupParentId,screenshots;function waitDOM(){return new Promise(res=>{document.readyState!=="loading"?res():document.addEventListener("DOMContentLoaded",()=>res())})}function waitInitData(){return new Promise((ok,err2)=>{if(window.sideberyInitData)return ok();window.onSideberyInitDataReady=ok,setTimeout(()=>err2("GroupPage: No initial data (sideberyInitData)"),2e3)})}async function main(){setInstanceType2(1),setInstanceType(1);try{await Promise.all([waitDOM(),waitInitData()])}catch(e){err("Group page: Initialization error:",e);let warnEl=document.getElementById("disconnected_warn");warnEl&&(warnEl.textContent=browser.i18n.getMessage("group_disconnected_warn")),document.body.setAttribute("data-disconnected","true");return}let initData=window.sideberyInitData;groupWinId=initData.winId??-1,groupTabId=initData.tabId??-1,setWinId2(groupWinId),setTabId2(groupTabId),setWinId(groupWinId),setTabId(groupTabId),initData.theme?document.body.setAttribute("data-theme",initData.theme):warn("Cannot init sidebery theme"),initData.frameColorScheme?document.body.setAttribute("data-frame-color-scheme",initData.frameColorScheme):warn("Cannot set frame color scheme"),initData.toolbarColorScheme?document.body.setAttribute("data-toolbar-color-scheme",initData.toolbarColorScheme):warn("Cannot set toolbar color scheme"),initData.parsedTheme?applyThemeSrcVars(initData.parsedTheme):warn("Cannot apply firefox theme colors"),loadCustomGroupCSS(),groupLayout=initData.groupLayout??"grid",document.body.setAttribute("data-layout",groupLayout),document.body.setAttribute("data-animations",initData.animations?"fast":"none");let title=parseUrl()?.title??"",titleEl=document.getElementById("title");if(titleEl.value=title,document.title=title||"‎",!initData.groupInfo){warn("No group info");let warnEl=document.getElementById("disconnected_warn");warnEl&&(warnEl.textContent=browser.i18n.getMessage("group_disconnected_warn")),document.body.setAttribute("data-disconnected","true");return}if(connectTo(0,groupWinId,groupTabId),screenshots={},tabs=initData.groupInfo.tabs||[],groupTabIndex=initData.groupInfo.index||0,groupLen=initData.groupInfo.len||0,groupParentId=initData.groupInfo.parentId,pinTab=initData.groupInfo.pin,titleEl.addEventListener("input",onTitleChange),pinTab&&(document.body.setAttribute("data-pin","true"),document.title=pinTab.title,updatePinnedTab(pinTab,event=>onTabClick(event,pinTab))),tabsBoxEl=document.getElementById("tabs"),!tabsBoxEl)throw new Error("Cannot get tabs container element");for(;tabsBoxEl.lastChild;)tabsBoxEl.removeChild(tabsBoxEl.lastChild);for(let tab of tabs)createTabEl(tab,event=>onTabClick(event,tab)),tab.el&&tabsBoxEl.appendChild(tab.el);createNewTabButton(),document.body.addEventListener("mousedown",e=>{e.button===2&&groupParentId!==void 0&&groupParentId!==NOID&&(e.preventDefault(),bg("tabsApiProxy","update",groupParentId,{active:!0}))}),document.body.addEventListener("contextmenu",e=>e.preventDefault()),browser.runtime.onMessage.addListener(onGroupMsg),updateScreenshots()}function parseUrl(){let hash;try{hash=decodeURIComponent(window.location.hash.slice(1))}catch(e){err("parseUrl: Cannot decode URI component",e);return}return{title:hash.split(":id:")[0].trim()}}var onTitleChangeTimeout;function onTitleChange(e){clearTimeout(onTitleChangeTimeout),onTitleChangeTimeout=setTimeout(()=>{let normTitle=e.target.value.trim();document.title=normTitle||"‎",window.location.hash=`#${encodeURIComponent(normTitle)}`},500)}function onGroupMsg(msg){let i;if(msg.index!==void 0&&(groupTabIndex=msg.index),msg.len!==void 0&&(groupLen=msg.len),msg.parentId!==void 0&&(groupParentId=msg.parentId),msg.title!==void 0){let normTitle=msg.title.trim();document.title=normTitle||"‎";let titleEl=document.getElementById("title");titleEl&&(titleEl.value=normTitle),window.location.hash=`#${encodeURIComponent(normTitle)}`}if(msg.tabs!==void 0){for(i=0;i<msg.tabs.length;i++){let newTab=msg.tabs[i],oldTab=tabs[i];oldTab?updateTab(oldTab,newTab):(createTabEl(newTab,event=>onTabClick(event,newTab)),newTab.el&&(newTabEl.before(newTab.el),tabs[i]=newTab))}for(;i<tabs.length;i++)tabs[i].el?.remove(),tabs.splice(i,1)}msg.pin&&(pinTab=msg.pin,pinTab&&(document.body.setAttribute("data-pin","true"),document.title=pinTab.title,updatePinnedTab(pinTab,event=>onTabClick(event,pinTab)))),msg.createdTab&&onTabCreated(msg.createdTab),msg.updatedTab&&onTabUpdated(msg.updatedTab),msg.removedTab!==void 0&&onTabRemoved(msg.removedTab)}async function onTabCreated(tab){if(createTabEl(tab,event=>onTabClick(event,tab)),!tab.el)return;let index=tab.index-groupTabIndex-1;if(index===-1||index===tabs.length)newTabEl.before(tab.el),tabs.push(tab);else if(index>=0&&index<tabs.length)tabs[index].el?.before(tab.el),tabs.splice(index,0,tab);else{warn("Cannot add new tab: Wrong index");return}groupLen++,await sleep(256),takeScreenshot(tab,SCREENSHOT_QUALITY)}function onTabUpdated(upd){let tab=tabs.find(t=>t.id===upd.id);if(!tab?.el)return;let normURL;try{normURL=decodeURI(upd.url)}catch{normURL=upd.url}tab.el.title=normURL,tab.el.setAttribute("data-status",upd.status??""),upd.status==="complete"&&(tab.el.setAttribute("data-fav",String(!!upd.favIconUrl)),tab.favEl&&(tab.favEl.style.backgroundImage=`url(${upd.favIconUrl})`),tab.favIconUrl=upd.favIconUrl,takeScreenshot(tab,SCREENSHOT_QUALITY)),tab.titleEl&&(tab.titleEl.textContent=upd.title),tab.title=upd.title,tab.urlEl&&(upd.url.startsWith("moz-ext")?tab.urlEl.textContent="":tab.urlEl.textContent=normURL),tab.url=upd.url,tab.favPlaceholderSvgEl&&setSvgId(tab.favPlaceholderSvgEl,getFavPlaceholder(upd.url)),tab.el.setAttribute("data-discarded",String(upd.discarded)),tab.discarded=upd.discarded,tab.el.setAttribute("data-lvl",String(upd.lvl)),tab.lvl=upd.lvl}function onTabRemoved(id){let index=tabs.findIndex(t=>t.id===id);index!==-1&&(tabs[index].el?.remove(),tabs.splice(index,1),groupLen--,groupLen===0&&window.location.search.includes("pin=")&&bg("tabsApiProxy","remove",groupTabId))}function createNewTabButton(){tabsBoxEl&&(newTabEl=document.createElement("div"),newTabEl.classList.add("new-tab"),newTabEl.title=browser.i18n.getMessage("group_new_tab_tooltip"),tabsBoxEl.appendChild(newTabEl),newTabEl.addEventListener("mousedown",event=>{event.stopPropagation(),event.preventDefault(),bg("tabsApiProxy","create",{windowId:groupWinId,index:groupTabIndex+groupLen+1,openerTabId:groupTabId,active:event.button===0})}),newTabEl.addEventListener("mouseup",event=>{event.stopPropagation(),event.preventDefault()}))}function createTabEl(info,clickHandler){let normURL;try{normURL=decodeURI(info.url)}catch{normURL=info.url}info.el=document.createElement("div"),info.el.classList.add("tab"),info.el.title=normURL,info.el.setAttribute("data-lvl",String(info.lvl)),info.el.setAttribute("data-discarded",String(info.discarded)),info.el.setAttribute("data-fav",String(!!info.favIconUrl)),info.bgEl=document.createElement("div"),info.bgEl.classList.add("bg"),info.el.appendChild(info.bgEl),info.favEl=document.createElement("div"),info.favEl.classList.add("fav"),info.favEl.style.backgroundImage=`url(${info.favIconUrl})`,info.el.appendChild(info.favEl),info.favPlaceholderEl=document.createElement("div"),info.favPlaceholderEl.classList.add("fav-placeholder");let iconId=getFavPlaceholder(info.url);info.favPlaceholderSvgEl=createSvgIcon(iconId),info.favPlaceholderEl.appendChild(info.favPlaceholderSvgEl),info.el.appendChild(info.favPlaceholderEl);let infoEl=document.createElement("div");infoEl.classList.add("info"),info.el.appendChild(infoEl),info.titleEl=document.createElement("h3"),info.titleEl.classList.add("tab-title"),info.titleEl.textContent=info.title,infoEl.appendChild(info.titleEl),info.urlEl=document.createElement("a"),info.urlEl.classList.add("tab-url"),info.urlEl.setAttribute("href",info.url),info.urlEl.addEventListener("click",e=>e.preventDefault()),info.url.startsWith("moz-ext")?info.urlEl.textContent="":info.urlEl.textContent=normURL,infoEl.appendChild(info.urlEl);let ctrlsEl=document.createElement("div");ctrlsEl.classList.add("ctrls"),info.el.appendChild(ctrlsEl);let discardBtnEl=createTabButton("#icon_discard","discard-btn",event=>{event.stopPropagation(),bg("tabsApiProxy","discard",info.id)});discardBtnEl.title=browser.i18n.getMessage("group_tab_discard_tooltip"),ctrlsEl.appendChild(discardBtnEl);let reloadBtnEl=createTabButton("#icon_reload","reload-btn",event=>{event.stopPropagation(),(event.button===0||event.button===1)&&bg("tabsApiProxy","reload",info.id)});reloadBtnEl.title=browser.i18n.getMessage("group_tab_reload_tooltip"),ctrlsEl.appendChild(reloadBtnEl);let closeBtnEl=createTabButton("#icon_close","close-btn",event=>{event.stopPropagation(),bg("tabsApiProxy","remove",info.id)});closeBtnEl.title=browser.i18n.getMessage("group_tab_close_tooltip"),ctrlsEl.appendChild(closeBtnEl),info.el.addEventListener("mousedown",e=>e.stopPropagation()),info.el.addEventListener("click",clickHandler)}var pinnedTabEventsListeners=!1;function updatePinnedTab(info,clickHandler){info.el=document.getElementById("pinned_tab"),info.el&&(info.el.title=info.url,info.bgEl=document.getElementById("pinned_tab_bg"),info.titleEl=document.getElementById("pinned_tab_title"),info.titleEl&&(info.titleEl.textContent=info.title),info.urlEl=document.getElementById("pinned_tab_url"),info.urlEl&&(info.urlEl.textContent=info.url),pinnedTabEventsListeners||(info.el.addEventListener("mousedown",e=>e.stopPropagation()),info.el.addEventListener("click",clickHandler),pinnedTabEventsListeners=!0))}function createTabButton(svgId,className,clickHandler){let btnEl=document.createElement("div");btnEl.classList.add("tab-btn",className);let svgEl=createSvgIcon(svgId);return btnEl.appendChild(svgEl),btnEl.addEventListener("click",clickHandler),btnEl}function createSvgIcon(svgId){let svgEl=document.createElementNS("http://www.w3.org/2000/svg","svg");svgEl.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink");let useEl=document.createElementNS("http://www.w3.org/2000/svg","use");return useEl.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",svgId),svgEl.appendChild(useEl),svgEl}function setSvgId(svgEl,svgId){let useEl=svgEl.childNodes[0];useEl&&useEl.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",svgId)}async function takeScreenshot(tab,quality=90){if(tab.discarded){let screen=screenshots[tab.url];tab.bgEl&&screen?tab.bgEl.style.backgroundImage=`url(${screen})`:tab.bgEl&&tab.favIconUrl&&(tab.bgEl.style.backgroundImage=`url(${tab.favIconUrl})`,tab.bgEl.style.filter="blur(8px)",groupLayout==="list"&&(tab.bgEl.style.left="-4px"));return}else tab.bgEl&&(tab.bgEl.style.filter="none",groupLayout==="list"&&(tab.bgEl.style.left="0"));try{let screen=await bg("tabsApiProxy","captureTab",tab.id,{format:"jpeg",quality});tab.bgEl&&(tab.bgEl.style.backgroundImage=`url(${screen})`),screenshots[tab.url]=screen}catch{let screen=screenshots[tab.url];tab.bgEl&&screen&&(tab.bgEl.style.backgroundImage=`url(${screen})`)}}async function updateScreenshots(){let newScreenshots={};pinTab&&(takeScreenshot(pinTab,PIN_SCREENSHOT_QUALITY),await takeScreenshot(pinTab,PIN_SCREENSHOT_QUALITY),newScreenshots[pinTab.url]=screenshots[pinTab.url]);for(let tab of tabs)await takeScreenshot(tab,SCREENSHOT_QUALITY),newScreenshots[tab.url]=screenshots[tab.url];screenshots=newScreenshots}function onTabClick(event,tab){tab&&(event.stopPropagation(),bg("tabsApiProxy","update",tab.id,{active:!0}))}function updateTab(oldTab,newTab){let titleChanged=oldTab.title!==newTab.title,urlChanged=oldTab.url!==newTab.url;oldTab.el&&(titleChanged&&oldTab.titleEl&&(oldTab.titleEl.textContent=newTab.title),urlChanged&&oldTab.urlEl&&(newTab.url.startsWith("moz-ext")?oldTab.urlEl.textContent="":oldTab.urlEl.textContent=newTab.url,oldTab.urlEl.setAttribute("href",newTab.url),oldTab.el.title=newTab.url,oldTab.favPlaceholderSvgEl&&setSvgId(oldTab.favPlaceholderSvgEl,getFavPlaceholder(newTab.url))),oldTab.lvl!==newTab.lvl&&oldTab.el.setAttribute("data-lvl",String(newTab.lvl)),oldTab.discarded!==newTab.discarded&&oldTab.el.setAttribute("data-discarded",String(newTab.discarded)),oldTab.favIconUrl!==newTab.favIconUrl&&oldTab.favEl&&(oldTab.el.setAttribute("data-fav",String(!!newTab.favIconUrl)),oldTab.favEl.style.backgroundImage=`url(${newTab.favIconUrl})`),Object.assign(oldTab,newTab),(titleChanged||urlChanged)&&takeScreenshot(oldTab,SCREENSHOT_QUALITY))}main();
