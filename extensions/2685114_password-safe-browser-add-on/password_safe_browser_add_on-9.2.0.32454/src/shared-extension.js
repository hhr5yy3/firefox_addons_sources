window.browser=window.msBrowser||window.browser||window.chrome;const migration89=new Promise((resolve,reject)=>{let request=indexedDB.open("extensionDB");request.onupgradeneeded=function(){var db=request.result,profiles=(db.createObjectStore("options"),db.createObjectStore("profiles",{autoIncrement:!0}));profiles.createIndex("color","color"),profiles.createIndex("profileId","profileId",{unique:!0}),profiles.createIndex("profileName","profileName"),profiles.createIndex("databaseName","databaseName"),profiles.createIndex("userName","userName"),profiles.createIndex("endpoint","endpoint"),profiles.createIndex("webClientUrl","webClientUrl"),db.createObjectStore("urlsBlockedFromAddPassword",{autoIncrement:!0}).createIndex("url","url"),resolve()},request.onsuccess=function(){resolve()},request.onerror=function(){reject(request.error)}}),containerItemTypes=["{ContainerItemText}","{ContainerItemPassword}","{ContainerItemDate}","{ContainerItemCheck}","{ContainerItemUrl}","{ContainerItemEmail}","{ContainerItemPhone}","{ContainerItemList}","{ContainerItemHeader}","{ContainerItemMemo}","{ContainerItemPasswordMemo}","{ContainerItemInt}","{ContainerItemDecimal}","{ContainerItemUserName}","{ContainerItemIp}","{ContainerItemHostName}"],databaseProfileColors=["#9575CD","#7986CB","#64B5F6","#4DD0E1","#4DB6AC","#81C784","#FFF176","#FFB74D","#E57373","#F06292","#90A4AE"],CLIENT_VERSION="8.2.1.12720",OPTION_AUTOFILL="option_autofill",OPTION_AUTOSUBMIT="option_autosubmit",OPTION_BLOCKTIME_DEFAULT=1e4,OPTION_BADGE_COLOR="#686868",COMMAND_PORT_EXCHANGE="PortExchangeCommand",COMMAND_INIT_EXTENSION="InitExtensionCommand",COMMAND_GENERATE_KEY="GenerateKeyCommand",COMMAND_CONNECTION_CHANGED="ConnectionChangedCommand",COMMAND_SAVE_TEMPLATE="SaveTemplateCommand",COMMAND_AUTOFILL="AutofillCommand",COMMAND_RELOAD_CONTAINERS="ReloadSsoContainersCommand",COMMAND_INIT_SUCCESSFUL="InitSuccessfulCommand",MSG_CREATE_TEMPLATE="CreateTemplate",MSG_REQUEST_DOM="RequestDom",MSG_REQUEST_AUTOFILL="RequestAutofill",MSG_CLEAR_VALUES="ClearValues",MSG_EDIT_TEMPLATE="EditTemplate",CONNECT_INTERVAL=1500,MAX_CONTAINERS=100,ADD_PASSWORD_DEBOUNCE_TIMEOUT=2e3,UNLOCKED_ICON_SET={16:"/img/icon_16.png",19:"/img/icon_19.png",24:"/img/icon_24.png",32:"/img/icon_32.png",48:"/img/icon_48.png",64:"/img/icon_64.png",128:"/img/icon_128.png",256:"/img/icon_256.png",512:"/img/icon_512.png"},LOCKED_ICON_SET={16:"/img/icon_locked_16.png",19:"/img/icon_locked_19.png",24:"/img/icon_locked_24.png",32:"/img/icon_locked_32.png",48:"/img/icon_locked_48.png",64:"/img/icon_locked_64.png",128:"/img/icon_locked_128.png",256:"/img/icon_locked_256.png",512:"/img/icon_locked_512.png"};var nextContextForNewTab,sessions=[],containers=[],containersFromLastServerQuery=[],templates=[],globalConfig={Applications:[]},rsa=null,aes=null,optionCanAddTemplate=!1,optionPredefined=!0,activeTab=null,madeNewTab=!1,blockedUrls=[],showTemplateInfo=!1,nextStepState={},nextContextToUseState={},lastFilledStateAutoSubmit={},blockedFills={},browserName=getBrowserName().toLowerCase();let refreshing=!1,openInWebClientProfileId=null;function getErrorText(error){if(null==error)return browser.i18n.getMessage("error_login_unknown");if("ExceptionCode"in error){var translated=browser.i18n.getMessage("error_"+error.ExceptionCode);if(null!=translated&&""!=translated)return translated}return"FaultCode"in error&&"PsrFaultCodeUserIsExpired"===error.FaultCode?browser.i18n.getMessage("error_login_user_expired"):error.Message||error.message}function returnProtocol(url){return url?url.startsWith("http://")?"http://":url.startsWith("https://")?"https://":"":""}function getDomainName(hostName){return hostName.substring(hostName.lastIndexOf(".",hostName.lastIndexOf(".")-1)+1)}function compareUrls(container,urlA,urlB,exactMatch){return!(urlA&&urlB&&((urlA=urlA.toLowerCase())===(urlB=urlB.toLowerCase())?(container.SortPriority=1,0):(protocolA=returnProtocol(urlA),protocolB=returnProtocol(urlB),hostnameA=getCompareUrl(urlA),hostnameB=getCompareUrl(urlB),urlA=protocolA+hostnameA,urlB=protocolB+hostnameB,!urlA||!urlB||(urlA===urlB?(container.SortPriority=1,0):exactMatch&&""!==protocolB||(hostnameA===hostnameB?(container.SortPriority=2,0):exactMatch&&2<urlB.split(".").length||(0===urlA.indexOf("www.")&&(urlA=urlA.slice(4,urlA.length)),0===urlB.indexOf("www.")&&(urlB=urlB.slice(4,urlB.length)),exactMatch&&2<urlB.split(".").length)||(domainNameA=getDomainName(urlA),domainNameB=getDomainName(urlB),domainNameA!==domainNameB)||(container.SortPriority=3,0))))))}async function log(...args){await mv.getStoreEntry("option_logging")&&console.log(...args)}async function logVerbose(...args){await mv.getStoreEntry("option_logging")&&console.debug(...args)}function generateUuid(){let d=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+16*Math.random())%16|0;return d=Math.floor(d/16),("x"===c?r:3&r|8).toString(16)})}function getBrowserName(){var ua=navigator.userAgent,userAgentMatches=ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(userAgentMatches[1]))return"IE "+(/\brv[ :]+(\d+)/g.exec(ua)||[]||"");if("Chrome"===userAgentMatches[1]){var matches=ua.match(/\b(OPR|Edge)\/(\d+)/);if(matches)return matches.slice(1).join(" ").replace("OPR","Opera")}let browserName=userAgentMatches[2]?userAgentMatches[1]:navigator.appName,browserVersion=userAgentMatches[2]||navigator.appVersion;-1!==ua.toLowerCase().indexOf("edge/")&&(browserName="Edge"),-1!==ua.toLowerCase().indexOf("edg/")&&(browserName="Edge (Chromium)");matches=ua.match(/version\/(\d+)/i);return matches&&(browserVersion=matches[1]),browserName+" "+browserVersion}function getMatchingContainersForUrl(containers,url){return containers&&url?containers.filter(c=>containerMatchesUrl(c,url)):[]}function hasAnyMatchingContainerForUrl(containers,url){return!!containers&&!!url&&containers.some(c=>containerMatchesUrl(c,url))}function containerMatchesUrl(container,url){return container.Urls&&container.Urls.some(curl=>compareUrls(container,url,curl,container.MatchSubdomain))||container.UrlsWithRegex&&container.UrlsWithRegex.some(curl=>{try{var jsRegex=curl.replace(/\//g,"\\/");return new RegExp(jsRegex,"i").test(url)}catch(err){return!1}})}function getContainer(containers,url){containers=getMatchingContainersForUrl(containers,url);if(!containers||!containers.length)return null;url=containers.filter(c=>c.Autofill);if(0===url.length)return null;if(1<url.length)throw new Error("no distinct autofill container");return url[0]}function getTemplatesForUrl(url){const urlTemplates=templates.concat(globalConfig.Applications);if(0!==urlTemplates.length){var matchingTemplates=[];for(let i=0;i<urlTemplates.length;i++)try{(urlTemplates[i].IsUrlRegex?()=>{try{var jsRegex=urlTemplates[i].Url.replace(/\//g,"\\/");return new RegExp(jsRegex,"i").test(url)}catch(err){return!1}}:()=>{var trimmedUrl;return-1!==url.indexOf(urlTemplates[i].Url)||(trimmedUrl=urlTemplates[i].Url.replace(/\/*$/g,""),-1!==url.indexOf(trimmedUrl))})()&&matchingTemplates.push(urlTemplates[i])}catch(err){url==urlTemplates[i].Url&&matchingTemplates.push(urlTemplates[i])}return matchingTemplates}}function makeValidUrl(url){return url=/^https?:\/\//i.test(url)?url:"http://"+url}function orderByRelevance(containers,count){containers=containers.sort(function(c1,c2){return c1.SortPriority===c2.SortPriority?c1.ContainerName.localeCompare(c2.ContainerName):c1.SortPriority-c2.SortPriority});return null!=count?containers.splice(0,count):containers}function setBadge(url){isServerConnected(sessions)&&null!=url&&null!=containers?setBadgeNumber(getMatchingContainersForUrl(containers,url).length):browser.browserAction.setBadgeText({text:""})}function setBadgeNumber(number){number&&0!==number&&"0"!==number?browser.browserAction.setBadgeText({text:""+number}):browser.browserAction.setBadgeText({text:""})}function getActiveTab(callback){browser.tabs.query({active:!0,currentWindow:!0},function(arrayOfTabs){arrayOfTabs=arrayOfTabs[0];arrayOfTabs&&(arrayOfTabs.isWebClientLoggedIn=tabIdToLoggedInWebClient[arrayOfTabs.id]),callback(arrayOfTabs)})}function showNotification(msg){var notificationId,isChrome,title;-1!==browserName.indexOf("edge")&&-1===browserName.indexOf("chromium")||(title=browser.i18n.getMessage("extension_title"),notificationId=Math.floor(1e6*Math.random())+"",isChrome=-1!==browserName.indexOf("chrome"),browser.notifications&&(title={type:"basic",iconUrl:browser.extension.getURL("../img/icon_64.png"),title:title,message:msg},isChrome||delete title.buttons,browser.notifications.create(notificationId,title)))}function getUrlParameter(name,url){url=url||location.href,name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");name=new RegExp("[\\?&]"+name+"=([^&#]*)").exec(url);return null==name?null:name[1]}function showHelp(){var helpUrl=browser.i18n.getMessage("help_url");browser.tabs.create({url:helpUrl})}async function loadDatabaseProfiles(){return getStoreIndexedDBrecords("profiles")}async function getStoreIndexedDBrecords(store){return await migration89,new Promise((resolve,reject)=>{const request=indexedDB.open("extensionDB");request.onsuccess=function(){const gRequest=request.result.transaction(store,"readonly").objectStore(store).getAll();gRequest.onsuccess=function(){resolve(gRequest.result)},gRequest.onerror=function(){reject(gRequest.error)}}})}async function getIndexedDBrecord(store,key,index){return await migration89,new Promise((resolve,reject)=>{const request=indexedDB.open("extensionDB");request.onsuccess=()=>{var st=request.result.transaction(store,"readonly").objectStore(store);let gRequest;(gRequest=(void 0!==index?st.index(index):st).get(key)).onsuccess=function(){resolve(gRequest.result)},gRequest.onerror=function(){reject(gRequest.error)}},request.onerror=function(){reject(reject.error)}})}async function deleteIndexedDBrecord(store,key,index){return await migration89,new Promise((resolve,reject)=>{const request=indexedDB.open("extensionDB");request.onsuccess=function(){const st=request.result.transaction(store,"readwrite").objectStore(store);if(void 0!==index){const prequest=st.index(index).openKeyCursor(IDBKeyRange.only(key));prequest.onsuccess=function(){var cursor=prequest.result;cursor&&(st.delete(cursor.primaryKey),cursor.continue),resolve()},prequest.onerror=function(){reject(prequest.error)}}else{const dRequest=st.delete(key);dRequest.onsuccess=function(){resolve()},dRequest.onerror=function(){reject(dRequest.error)}}}})}async function updateIndexedDBrecord(store,index,key,value){return await migration89,new Promise((resolve,reject)=>{const request=indexedDB.open("extensionDB");request.onsuccess=function(){const pcursor=request.result.transaction(store,"readwrite").objectStore(store).index(index).openCursor(IDBKeyRange.only(key));pcursor.onsuccess=function(){var cursor=pcursor.result;if(cursor){const urequest=cursor.update(value);urequest.onsuccess=function(){resolve()},urequest.onerror=function(){reject(urequest.error)}}resolve()},pcursor.onerror=function(){reject(pcursor.error)}},request.onerror=function(){reject(reject.error)}})}async function saveIndexedDBrecord(store,value,key){return await migration89,new Promise((resolve,reject)=>{const request=indexedDB.open("extensionDB");request.onsuccess=function(){var st=request.result.transaction(store,"readwrite").objectStore(store);let sRequest;(sRequest=void 0!==key?st.put(value,key):st.put(value)).onsuccess=function(){resolve()},sRequest.onerror=function(){reject(sRequest.error)}},request.onerror=function(){reject(reject.error)}})}async function loadDatabaseProfile(profileId){return getIndexedDBrecord("profiles",profileId,"profileId")}async function saveDatabaseProfile(profile){return saveIndexedDBrecord("profiles",profile)}async function updateDatabaseProfile(profile){return updateIndexedDBrecord("profiles","profileId",profile.profileId,profile)}async function addOrUpdateDatabaseProfile(profile){await getIndexedDBrecord("profiles",profile.profileId,"profileId")?await updateDatabaseProfile(profile):await saveDatabaseProfile(profile)}async function getCrossClientAuthActive(){var activeState=await getIndexedDBrecord("options","cross_client_auth");return!activeState||"true"===activeState}async function setCrossClientAuthActive(crossClientActive){return saveIndexedDBrecord("options",crossClientActive.toString(),"cross_client_auth")}async function deleteDatabaseProfile(profileId){await deleteIndexedDBrecord("profiles",profileId,"profileId");profileId=await loadDatabaseProfiles();profileId.length?await saveIndexedDBrecord("options",profileId[0].profileId,"lastProfileSelection"):await deleteIndexedDBrecord("options","lastProfileSelection")}function isServerConnected(sessions){return null!=sessions&&0!=sessions.length&&0!==sessions.filter(s=>!!s.connected).length}function isLoggedIn(sessions,profileId){return!!isServerConnected(sessions)&&null!=sessions.find(s=>s.profileId==profileId&&s.connected)}function componentToHex(c){c=c.toString(16);return 1==c.length?"0"+c:c}function getColorByString(text){if(!text||"string"!=typeof text)return getRandomColor();let hash=Math.abs(getHashCode(text)).toString();for(;hash.length<9;)hash+="0";var text=Math.floor(.255*Number.parseInt(hash.substring(0,3))),g=Math.floor(.255*Number.parseInt(hash.substring(3,6))),b=Math.floor(.255*Number.parseInt(hash.substring(6,9)));return"#"+componentToHex(text)+componentToHex(g)+componentToHex(b)}function getHashCode(text){let hash=0;if(text&&0!=text.length)for(let i=0;i<text.length;i++){var char=text.charCodeAt(i);hash=(hash<<5)-hash+char,hash&=hash}return hash}function getRandomColor(){var number=Math.round(1e3*Math.random()/100);return databaseProfileColors[number]}function isUrlBlocked(url){return-1<blockedUrls.indexOf(url)}function blockUrl(url){blockedUrls.push(url),window.setTimeout(function(){var i=blockedUrls.indexOf(url);-1<i&&blockedUrls.splice(i,1)},OPTION_BLOCKTIME_DEFAULT)}function isEdgeExtension(){return-1!==browserName.indexOf("edge")}async function getUrlsBlockedFromAddPassword(){const urlsBlockedFromAddPassword=[];return(await getStoreIndexedDBrecords("urlsBlockedFromAddPassword")).forEach(url=>{urlsBlockedFromAddPassword.push(url.url)}),urlsBlockedFromAddPassword}function ab2b64(buffer){let binary="";var bytes=new Uint8Array(buffer),len=bytes.byteLength;for(let i=0;i<len;i++)binary+=String.fromCharCode(bytes[i]);return window.btoa(binary)}function b642ab(base64){var binaryString=window.atob(base64),len=binaryString.length,bytes=new Uint8Array(len);for(let i=0;i<len;i++)bytes[i]=binaryString.charCodeAt(i);return bytes.buffer}function b64toUint8Array(base64){return new Uint8Array(b642ab(base64))}function getItemValue(container,itemTypeString,reason){return itemTypeString?new Promise(function(resolve,reject){let session=findSession(container.Id);if(null!=session){let containerItem=null,itemType=containerItemTypes.indexOf(itemTypeString);if(-1===itemType){let searchName=itemTypeString.substring(1,itemTypeString.length-1);containerItem=container.Items.find(item=>item.Name===searchName),itemType=containerItem.ContainerItemType}else(containerItem=container.Items.find(item=>item.ContainerItemType==itemType))&&containerItem.Value||(5===itemType&&(containerItem=container.Items.find(item=>13==item.ContainerItemType)),13===itemType&&(containerItem=container.Items.find(item=>5==item.ContainerItemType)));null==containerItem?reject("Could not find containerItem"):1===itemType||10===itemType?session.decryptContainerItem(containerItem,reason).then(val=>resolve(val)):2===itemType?resolve(containerItem.ValueDateUtc):3===itemType?resolve(convertToString(containerItem.ValueBool)):8===itemType?resolve(containerItem.Name):11===itemType?resolve(convertToString(containerItem.ValueInt)):12===itemType?resolve(convertToString(containerItem.ValueDecimal)):16===itemType?session.decryptContainerItem(containerItem,reason).then(val=>session.generateGoogleAuthenticatorOtp(val).then(token=>resolve(token.OneTimePassword))):resolve(containerItem.Value)}}):Promise.resolve("")}function convertToString(num){return null!=num?String(num):null}function findSession(containerId){const container=containers.find(c=>c.ContainerId===containerId)||containersFromLastServerQuery.find(c=>c.ContainerId===containerId);if(container)return sessions.find(s=>s.profileId===container.ProfileId)}async function getTrustedSessionByContainerId(containerId){const session=findSession(containerId);if(session){let trustedProfiles=await loadDatabaseProfiles();if(trustedProfiles=trustedProfiles.filter(p=>p.webClientUrl)){containerId=trustedProfiles.find(p=>session.profileId===p.profileId);if(containerId)return{session:session,profile:containerId}}}}function getItemData(containerId,reason,itemType,callback){let session=findSession(containerId);if(null==session)return null;session.getContainer(containerId).then(container=>{if(container&&container.Items){const item=container.Items.find(c=>c.ContainerItemType==itemType);null==item?16==itemType&&callback(null,null):16==itemType?session.decryptContainerItem(item,reason).then(val=>{val?session.generateGoogleAuthenticatorOtp(val).then(token=>{callback(item.Name,token)}):callback(item.Name,null)}):1==itemType?session.decryptContainerItem(item,reason).then(val=>callback(item.Name,val)):callback(item.Name,item.Value)}})}async function isSecretReasonRequired(containerId,itemType=1){var session=findSession(containerId);return null==session?null:(session=await session.getContainer(containerId))&&session.Items?null!=(containerId=session.Items.find(i=>i.ContainerItemType===itemType))&&containerId.SecretValueRequiredReason:void 0}function isProtected(containerId){var session=findSession(containerId);return session?session.isProtected(containerId):Promise.resolve(!0)}async function isSealed(containerId){var session=findSession(containerId);return session?session.isSealed(await session.getContainer(containerId)):Promise.resolve(!0)}String.prototype.replaceAll=function(search,replace){return void 0===replace?this.toString():this.replace(new RegExp("["+search+"]","g"),replace)},String.prototype.format=function(){let args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return void 0!==args[number]?args[number]:match})};