const browserName=navigator.userAgent.toLowerCase().indexOf("firefox")>-1?"firefox":"chrome",buyonMerchantsEndpoint="https://api.buyon.it/buyon/merchants",buyonBaseUrl="https://www.buyon.it",giftcardMerchantsEndpoint="https://api.buyon.it/buyon/giftcard/merchants",giftcardBaseUrl="https://www.buyon.it/gift-card",codicescontoMerchantsEndpoint=`https://admin.codicesconto.com/api/publisher/extension/merchant/?browser=${browserName}`,codicescontoBaseUrl="https://www.codicesconto.com",pricetrackerSitesEndpoint="https://api.buyon.it/buyon/price-tracker-sites",pricetrackerProductEndpoint="https://api.buyon.it/buyon/price-tracker-product",cookieBlacklistEndpoint="https://api.buyon.it/buyon/cookie-blacklist",hotelProvidersEndpoint="https://api.buyon.it/buyon/hotel/providers",flightProvidersEndpoint="https://api.buyon.it/buyon/flight/providers";let stopClearCookies=!1,restoredTrackingTabId=-1,closingTrackingTab=!1,cache={buyonMerchants:null,codicescontoMerchants:null,giftcardMerchants:null,pricetrackerSites:null,trackingInfo:null,hotelProviders:null,flightProviders:null},navigationHistory={};function getTrackingInfo(){return new Promise((e=>{cache.trackingInfo?e(cache.trackingInfo):e({buyingMerchantKey:null,whitelistedTabs:{},blacklistedTabs:[],dismissLostTrackingAlert:!1})}))}function setTrackingInfo(e){return new Promise((t=>{cache.trackingInfo=e,t()}))}function getBuyonMerchants(e=!1){return new Promise((t=>{!cache.buyonMerchants||e?chrome.storage.local.get("buyonMerchants",(r=>{if(r.buyonMerchants&&!e)cache.buyonMerchants=JSON.parse(r.buyonMerchants),t(cache.buyonMerchants);else{let e=new Request(buyonMerchantsEndpoint);fetch(e).then((e=>e.text())).then((async e=>{let r=parseBuyonMerchants(e);cache.buyonMerchants=r,await setBuyonMerchants(r),t(r)}))}})):t(cache.buyonMerchants)}))}function setBuyonMerchants(e){return new Promise((t=>{chrome.storage.local.set({buyonMerchants:JSON.stringify(e)},(()=>{t()}))}))}function parseBuyonMerchants(e){let t=JSON.parse(e),r={};for(let e=0;e<t.length;e++){let n=t[e],i=n.UrlToolbar.split("|");for(let e=0;e<i.length;e++){let t=i[e].replace(/^\.+|\.+$/g,""),a=removeExtension(t);a&&(r[a]={id:n.Id,idTdMerchant:n.IdTdMerchant,name:n.Name,url:`${buyonBaseUrl}/negozi/cashback-${n.SeoName}`,cashback:0==n.NoCashback?`${n.SalesCommission.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}${currencySymbol(n.CommissionCurrency)}`:"",noDeeplink:n.NoDeeplink,showOnExtension:n.ShowOnExtension,hostname:t,domainKey:a})}}return r}function currencySymbol(e){return"eur"===e?"€":"usd"===e?"$":"gbp"===e?"£":e}function getPricetrackerSites(e=!1){return new Promise((t=>{!cache.pricetrackerSites||e?chrome.storage.local.get("pricetrackerSites",(r=>{if(r.pricetrackerSites&&!e)cache.pricetrackerSites=JSON.parse(r.pricetrackerSites),t(cache.pricetrackerSites);else{let e=new Request(pricetrackerSitesEndpoint);fetch(e).then((e=>e.text())).then((async e=>{let r=parsePricetrackerSites(e);cache.pricetrackerSites=r,await setPricetrackerSites(r),t(r)}))}})):t(cache.pricetrackerSites)}))}function setPricetrackerSites(e){return new Promise((t=>{chrome.storage.local.set({pricetrackerSites:JSON.stringify(e)},(()=>{t()}))}))}function parsePricetrackerSites(e){let t=JSON.parse(e),r={};for(let e=0;e<t.length;e++){let n=t[e],i=n.UrlToolbar.split("|");for(let e=0;e<i.length;e++){let t=removeExtension(i[e].replace(/^\.+|\.+$/g,""));t&&(r[t]={idMerchant:n.IdMerchant,priceRule:n.PriceRule,productIdRule:n.ProductIdRule,hasFeed:n.HasFeed})}}return r}function getGiftcardMerchants(e=!1){return new Promise((t=>{!cache.giftcardMerchants||e?chrome.storage.local.get("giftcardMerchants",(r=>{if(r.giftcardMerchants&&!e)cache.giftcardMerchants=JSON.parse(r.giftcardMerchants),t(cache.giftcardMerchants);else{let e=new Request(giftcardMerchantsEndpoint);fetch(e).then((e=>e.text())).then((async e=>{let r=parseGiftcardMerchants(e);cache.giftcardMerchants=r,await setGiftcardMerchants(r),t(r)}))}})):t(cache.giftcardMerchants)}))}function setGiftcardMerchants(e){return new Promise((t=>{chrome.storage.local.set({giftcardMerchants:JSON.stringify(e)},(()=>{t()}))}))}function parseGiftcardMerchants(e){let t=JSON.parse(e),r={};for(let e=0;e<t.length;e++){let n=t[e];r[getHostnameWithoutExtension(n.Url)]={id:n.Id,name:n.Name,realUrl:`${giftcardBaseUrl}/${n.Slug}`,url:n.Url,cashback:n.Cashback,currency:n.Currency}}return r}function getCodicescontoMerchants(e=!1){return new Promise((t=>{!cache.codicescontoMerchants||e?chrome.storage.local.get("codicescontoMerchants",(r=>{if(r.codicescontoMerchants&&!e)cache.codicescontoMerchants=JSON.parse(r.codicescontoMerchants),t(cache.codicescontoMerchants);else{let e=new Request(codicescontoMerchantsEndpoint);fetch(e).then((e=>e.text())).then((async e=>{let r=parseCodicescontoMerchants(e);cache.codicescontoMerchants=r,await setCodicescontoMerchants(r),t(r)}))}})):t(cache.codicescontoMerchants)}))}function setCodicescontoMerchants(e){return new Promise((t=>{chrome.storage.local.set({codicescontoMerchants:JSON.stringify(e)},(()=>{t()}))}))}function parseCodicescontoMerchants(e){let t=JSON.parse(e).results,r={};for(let e=0;e<t.length;e++){let n=t[e],i=n.url.split(";");for(let e=0;e<i.length;e++){let t=getDomain(i[e]),a=getHostnameWithoutExtension(i[e]);n.total_codes>0&&!(a in r)&&(r[a]={id:n.id,name:n.name,realUrl:`${codicescontoBaseUrl}/${n.slug}`,url:i[e],domain:t,totalEntries:n.total_entries,totalCodes:n.total_codes})}}return r}function getCookieBlacklist(e=!1){return new Promise((t=>{if(cache.cookieBlacklist&&!e)return void t(cache.cookieBlacklist);let r=new Request(cookieBlacklistEndpoint);fetch(r).then((e=>{if(!e.ok)throw new Error;return e.text()})).then((async e=>{let r=e.split("\n"),n=[];for(let e=0;e<r.length;e++){if(""==r[e])continue;let t=r[e].split("!"),i=t[0].split("@"),a=i[0],o=i.length>1?i[1]:null,c=t.length>1?t[1].split(","):[];n.push({domain:a,name:o,exceptions:c})}cache.cookieBlacklist=n,t(n)}))}))}function getHotelProviders(e=!1){return new Promise((t=>{!cache.hotelProviders||e?chrome.storage.local.get("hotelProviders",(r=>{if(r.hotelProviders&&!e)cache.hotelProviders=JSON.parse(r.hotelProviders),t(cache.hotelProviders);else{let e=new Request(hotelProvidersEndpoint);fetch(e).then((e=>e.text())).then((async e=>{let r=parseHotelProviders(e);cache.hotelProviders=r,await setHotelProviders(r),t(r)}))}})):t(cache.hotelProviders)}))}function setHotelProviders(e){return new Promise((t=>{chrome.storage.local.set({hotelProviders:JSON.stringify(e)},(()=>{t()}))}))}function parseHotelProviders(e){let t=JSON.parse(e),r={};for(let e=0;e<t.length;e++){let n=t[e],i=getHostnameWithoutExtension(n.Url);i&&(r[i]={name:n.Name,url:`${buyonBaseUrl}/hotel`,cashback:n.Cashback>0?`${n.Cashback.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}${currencySymbol(n.CashbackCurrency)}`:"",noDeeplink:!0,showOnExtension:n.ShowOnExtension})}return r}function getFlightProviders(e=!1){return new Promise((t=>{!cache.flightProviders||e?chrome.storage.local.get("flightProviders",(r=>{if(r.flightProviders&&!e)cache.flightProviders=JSON.parse(r.flightProviders),t(cache.flightProviders);else{let e=new Request(flightProvidersEndpoint);fetch(e).then((e=>e.text())).then((async e=>{let r=parseFlightProviders(e);cache.flightProviders=r,await setFlightProviders(r),t(r)}))}})):t(cache.flightProviders)}))}function setFlightProviders(e){return new Promise((t=>{chrome.storage.local.set({flightProviders:JSON.stringify(e)},(()=>{t()}))}))}function parseFlightProviders(e){let t=JSON.parse(e),r={};for(let e=0;e<t.length;e++){let n=t[e],i=getHostnameWithoutExtension(n.Url);i&&(r[i]={name:n.Name,url:`${buyonBaseUrl}/voli`,cashback:n.Cashback>0?`${n.Cashback.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}${currencySymbol(n.CashbackCurrency)}`:"",noDeeplink:!0,showOnExtension:n.ShowOnExtension})}return r}function clearCookies(){return new Promise((async e=>{stopClearCookies=!1;let t=await getCookieBlacklist();for(let e=0;e<t.length;e++){let r=!0;for(chrome.cookies.getAll({domain:t[e].domain,name:t[e].name},(async n=>{for(var i=0;i<n.length&&!stopClearCookies;i++){t[e].exceptions.includes(n[i].name)||await chrome.cookies.remove({url:`https://${n[i].domain}${n[i].path}`,name:n[i].name})}r=!1}));r;)await new Promise((e=>setTimeout(e,10)));if(stopClearCookies)break}e()}))}function checkCookie(e){if(e){let t=+new Date;1e3*e.expirationDate<t&&(e=null)}return e}function initAlarm(){chrome.alarms.clearAll((()=>{chrome.alarms.create("refresh",{periodInMinutes:30}),chrome.alarms.create("wakeup",{periodInMinutes:3})}))}function getHostname(e){if(null==e)return null;let t=e.match(/:\/\/(www[0-9]?\.)?(.[^/:]+)/i);return null!=t&&t.length>2&&"string"==typeof t[2]&&t[2].length>0?t[2]:null}function getHostnameWithoutExtension(e){return removeExtension(getHostname(e))}function removeExtension(e){if(null==e)return null;let t=e.split(".");return t.length>2&&"co"==t[t.length-2]?t.slice(0,t.length-2).join("."):t.slice(0,t.length-1).join(".")}function getDomain(e){let t=getHostname(e),r=t;if(null!=t){let e=t.split(".").reverse();null!=e&&e.length>1&&(r=`${e[1]}.${e[0]}`,-1!=t.toLowerCase().indexOf(".co.")&&e.length>2&&(r=`${e[2]}.${r}`))}return r}function matchMerchant(e,t){let r=getHostnameWithoutExtension(e);return r in t?t[r]:(r=removeExtension(getDomain(e)),r in t?t[r]:null)}function activatePrivacySettings(){"chrome"==browserName&&(chrome.privacy.websites.thirdPartyCookiesAllowed.set({value:!0}),chrome.privacy.websites.doNotTrackEnabled.set({value:!1})),"firefox"==browserName&&(chrome.privacy.websites.cookieConfig.set({value:{behavior:"allow_all"}}),chrome.privacy.websites.trackingProtectionMode.set({value:"never"}),chrome.privacy.websites.resistFingerprinting.set({value:!1}))}function clearPrivacySettings(){"chrome"==browserName&&(chrome.privacy.websites.thirdPartyCookiesAllowed.clear({}),chrome.privacy.websites.doNotTrackEnabled.clear({})),"firefox"==browserName&&(chrome.privacy.websites.cookieConfig.clear({}),chrome.privacy.websites.trackingProtectionMode.clear({}),chrome.privacy.websites.resistFingerprinting.clear({}))}function getBuyOnOptions(){return new Promise((e=>{chrome.storage.local.get({navigationData:!0,privacy:!1,amazonExtra:!0,bookingExtra:!0},(t=>{chrome.permissions.contains({permissions:["privacy"]},(r=>{t.privacy=r,e(t)}))}))}))}function getWebAppCookie(){return new Promise((e=>{chrome.cookies.get({name:"eid",url:buyonBaseUrl},(t=>{t=checkCookie(t),e(t)}))}))}function getBuyingCookie(){return new Promise((e=>{chrome.cookies.get({name:"buying",url:buyonBaseUrl},(t=>{t=checkCookie(t),e(t)}))}))}function removeBuyingCookie(){return new Promise((e=>{chrome.cookies.remove({name:"buying",url:buyonBaseUrl},(()=>{e()}))}))}function getTicketCookie(e){return new Promise((t=>{chrome.cookies.get({name:"ticket"+e,url:buyonBaseUrl},(e=>{e=checkCookie(e),t(e)}))}))}function removeWebAppCookie(){return new Promise((e=>{chrome.cookies.remove({name:"eid",url:buyonBaseUrl},(()=>{e()}))}))}function checkBuyingUser(){return new Promise((e=>{chrome.cookies.get({name:"bu",url:buyonBaseUrl},(t=>{t=checkCookie(t),e(null!==t)}))}))}function getBuyonTab(){return new Promise((e=>{chrome.tabs.query({url:`${buyonBaseUrl}/*`},(t=>{e(t.length>0?t[0]:null)}))}))}function updatePrivacy(){return new Promise((e=>{chrome.permissions.contains({permissions:["privacy"]},(async t=>{if(t){await getBuyonTab()?activatePrivacySettings():clearPrivacySettings()}e()}))}))}function handleRestoredTrackingTab(e){-1==restoredTrackingTabId||restoredTrackingTabId!=e.id||closingTrackingTab||(closingTrackingTab=!0,setTimeout((()=>{chrome.tabs.remove(restoredTrackingTabId),restoredTrackingTabId=-1,closingTrackingTab=!1}),100))}function checkTrackingTab(e,t){return new Promise((async r=>{if(t.startsWith(buyonBaseUrl))return void r(null);if(!await getBuyingCookie())return void r(null);let n=await getTrackingInfo(),i=!1;e.id in n.whitelistedTabs||e.openerTabId&&e.openerTabId in n.whitelistedTabs&&!n.blacklistedTabs.includes(e.id)?n.whitelistedTabs[e.id]=t:i=!0,await setTrackingInfo(n),r({isWhitelisted:e.id in n.whitelistedTabs,lostTrackingAlert:i&&!n.dismissLostTrackingAlert&&removeExtension(getDomain(t))==n.buyingMerchantKey})}))}function getPricetrackerSiteData(e,t){return new Promise((async r=>{let n=await getPricetrackerSites(),i=matchMerchant(t,n),a=matchMerchant(t,e);r(i&&a?{merchant:a,site:i}:null)}))}function getPricetrackerProductData(e,t,r){return new Promise((async n=>{let i=new Request(`${pricetrackerProductEndpoint}?idMerchant=${e}&productId=${encodeURIComponent(t)}&price=${r}`);fetch(i).then((e=>e.text())).then((e=>{let t=JSON.parse(e),r={found:t.Found,id:t.Id,alternative:null};t.Alternative&&(r.alternative={id:t.Alternative.Id,source:t.Alternative.Source,price:t.Alternative.Price,merchantName:t.Alternative.MerchantName,withCashback:t.Alternative.WithCashback}),n(r)}))}))}function getCashbackData(e,t,r,n,i,a,o){return new Promise((async c=>{let s=await getTrackingInfo(),l=await getBuyingCookie();if(null==l&&(s.buyingMerchantKey=null,await setTrackingInfo(s)),l&&"3809"==l.value)return void c(null);if(l&&"3968"==l.value)return void c(null);let h=matchMerchant(o,e);if(h&&""!=h.cashback){let e=null!=await getWebAppCookie();e&&(s.buyingMerchantKey=h.domainKey,s.whitelistedTabs={},s.blacklistedTabs=[],s.whitelistedTabs[a.id]=o,s.dismissLostTrackingAlert=!1,restoredTrackingTabId=-1,await setTrackingInfo(s),await removeWebAppCookie()),await checkBuyingUser()||h.showOnExtension||l?c({buyon:{fromBuyon:e,sameSite:s.buyingMerchantKey==h.domainKey,merchant:h}}):c(null)}else if(h=matchMerchant(o,n)){await checkBuyingUser()||h.showOnExtension||l?c({buyon:{fromBuyon:!1,sameSite:!1,merchant:h}}):c(null)}else if(h=matchMerchant(o,i)){await checkBuyingUser()||h.showOnExtension||l?c({buyon:{fromBuyon:!1,sameSite:!1,merchant:h}}):c(null)}else(h=matchMerchant(o,t))?c({giftcard:{merchant:h}}):(h=matchMerchant(o,r))?c({codicesconto:{merchant:h}}):c(null)}))}function canSaveNavigationHistory(){return new Promise((async e=>{if(await getBuyonTab()){let t=await getBuyingCookie();if(t){let r=await getTicketCookie(t.value);r&&e(r.value)}}e(null)}))}async function addNavigationHistory(e,t,r,n,i){return new Promise((async a=>{null==navigationHistory[n]&&(navigationHistory[n]=[]);let o=new Date;navigationHistory[n].push({date:o.toISOString(),whitelist:i,tabId:t,url:e,title:r}),a()}))}async function handleRequest(e,t,r){let n=await getBuyonMerchants(),i=await getGiftcardMerchants(),a=await getCodicescontoMerchants(),o=await getHotelProviders(),c=await getFlightProviders();if("cashback-data"==e.command)if(await updatePrivacy(),t&&t.tab)if(t.tab.id==restoredTrackingTabId)handleRestoredTrackingTab(t.tab),r(!0);else{let s=await getCashbackData(n,i,a,o,c,t.tab,e.url),l=await canSaveNavigationHistory();if(l){let r=await getTrackingInfo(),n=t?t.tab.id:0;await addNavigationHistory(e.url,n,e.title,l,n in r.whitelistedTabs)}let h=await checkTrackingTab(t.tab,e.url);s&&(s.trackingTabData=h),r(s)}else r(!0);else if("merchant-data"==e.command)if(t&&t.tab){let t=matchMerchant(e.url,n),i=!1;if(t&&""==t.cashback){let t=await getBuyOnOptions(),n=getHostnameWithoutExtension(e.url);("amazon"==n&&!t.amazonExtra||"booking"==n&&!t.bookingExtra)&&(r(null),i=!0)}i||r(t)}else r(!0);else if("price-tracker-site-data"==e.command){r(await getPricetrackerSiteData(n,e.url))}else if("price-tracker-product-data"==e.command){r(await getPricetrackerProductData(e.idMerchant,e.productId,e.price))}else if("options"==e.command){let t=await getBuyOnOptions();r({source:"ext",command:e.command,success:!0,options:t})}else if("clear-cookies"==e.command)await clearCookies(),r({source:"ext",command:e.command,success:!0});else if("stop-clear-cookies"==e.command)stopClearCookies=!0,r({source:"ext",command:e.command,success:!0});else if("open-options"==e.command)e.option?chrome.storage.local.set(e.option):chrome.runtime.openOptionsPage(),r(!0);else if("open-buyon-url"==e.command)chrome.tabs.query({url:`${buyonBaseUrl}/*`},(e=>{e.length>0?chrome.tabs.update(e[0].id,{active:!0}):chrome.tabs.create({url:buyonBaseUrl})})),r(!0);else if("close-buyon-alert"==e.command){let e=await getTrackingInfo();e.dismissLostTrackingAlert=!0,e.whitelistedTabs={},await setTrackingInfo(e),await removeBuyingCookie(),r(!0)}else if("restore-tracking"==e.command){let t=await getTrackingInfo();if(t.buyingMerchantKey){let r=await getBuyingCookie();if(r){let i=await getTicketCookie(r.value);if(i){let r=`${buyonBaseUrl}/goingagain?merchant=${n[t.buyingMerchantKey].idTdMerchant}&ticket=${i.value}`;chrome.tabs.create({active:!e.hidden,url:r},(async r=>{e.hidden?restoredTrackingTabId=r.id:(t.whitelistedTabs[r.id]="*",await setTrackingInfo(t))}))}}}r(!0)}else if("get-navigation-data"==e.command){let t=await getBuyOnOptions();if(t.navigationData){let n={info:{browserName:browserName,version:chrome.runtime.getManifest().version,options:t},history:navigationHistory[e.ticketNumber]?navigationHistory[e.ticketNumber]:[]};r({source:"ext",command:e.command,success:!0,data:JSON.stringify(n)})}else r({source:"ext",command:e.command,success:!1,data:null})}else r(!0)}initAlarm(),removeWebAppCookie(),getBuyonMerchants(!0),getGiftcardMerchants(!0),getCodicescontoMerchants(!0),getPricetrackerSites(!0),getCookieBlacklist(!0),getHotelProviders(!0),getFlightProviders(!0),chrome.alarms.onAlarm.addListener((async e=>{"refresh"==e.name&&(await getBuyonMerchants(!0),await getGiftcardMerchants(!0),await getCodicescontoMerchants(!0),await getPricetrackerSites(!0),await getCookieBlacklist(!0),await getHotelProviders(!0),await getFlightProviders(!0))})),chrome.tabs.onCreated.addListener((async e=>{if("chrome://newtab/"==(e.pendingUrl?e.pendingUrl:e.url)){let t=await getTrackingInfo();t.blacklistedTabs.push(e.id),await setTrackingInfo(t)}})),chrome.browserAction.onClicked.addListener((()=>{chrome.tabs.create({url:`${buyonBaseUrl}?utm_source=buyon&utm_medium=extension&utm_campaign=${browserName}&utm_term=home&utm_content=button`})})),chrome.runtime.onMessage.addListener(((e,t,r)=>!(!e||!e.command)&&(handleRequest(e,t,r),!0)));