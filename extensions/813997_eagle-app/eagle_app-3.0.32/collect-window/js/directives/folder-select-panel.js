class FolderSelectPanel extends SelectPanel{originalParams;searchKeyword;collapsedFolderIds={};rawData;onChanged;onOpenItem;onCreateItem;onLibrarySwitching;onLibrarySwitched;onLibrarySwitchClosed;listData={};isMultipleSelect=!1;static open(e){angular.element("html").scope().$broadcast("FOLDER.SELECT.PANEL.OPEN",e)}constructor(e){super(e),this.collapsedFolderIds={}}init(e){this.originalParams=e,super.init(e),this.reset(),this.initRawData(e),this.updateItemList(),this.onChanged=e.onChanged||(()=>{}),this.onOpenItem=e.onOpenItem||(()=>{}),this.onCreateItem=e.onCreateItem||(()=>{}),this.onLibrarySwitching=e.onLibrarySwitching||(()=>{}),this.onLibrarySwitched=e.onLibrarySwitched||(()=>{}),this.onLibrarySwitchClosed=e.onLibrarySwitchClosed||(()=>{})}reset(){if(super.reset(),localStorage["eagle.folderSelectPanel.collapsedFolderIds"])try{this.collapsedFolderIds=JSON.parse(localStorage["eagle.folderSelectPanel.collapsedFolderIds"])}catch(e){this.collapsedFolderIds={}}this.listData.selectedIds={},this.listData.currentTab="ALL",this.rawData={folders:[],selectedIds:{},recentFolderOrders:{},folderList:[],foldersMap:{},foldersDepthMap:{}}}initRawData(e){let c={};this.rawData={folders:e.folders||[],selectedIds:e.selectedIds||{},recentFolderOrders:e.recentFolderOrders||{},folderList:[],foldersMap:{},folderItemsMap:{},foldersDepthMap:{}},this.listData.maxDepth=0,eagle.utils.tree.walk(this.rawData.folders,"children",(e,t,s)=>{var{id:a,name:i,icon:l,iconColor:r,pinyin:d}=e,o=(this.rawData.folderList.push(e),this.rawData.foldersMap[a]=e,this.rawData.foldersDepthMap[a]=s,t&&c[t.id]?[...c[t.id],e.iconColor||"normal"]:[e.iconColor||"normal"]),n=(c[e.id]=o,e.children&&0<e.children.length),i={type:"folder",id:a,name:i,pinyin:d,path:this.getFolderParentPath(e),extendTags:e.extendTags,icon:l,iconColor:r,depth:this.rawData.foldersDepthMap[a],size:27,parent:t?.id,parentItem:this.rawData.folderItemsMap[t?.id],guidelines:o,hasChildren:n};this.rawData.folderItemsMap[a]=i,this.listData.maxDepth<s&&(this.listData.maxDepth=s)}),this.listData.selectedIds={...this.rawData.selectedIds}}updateItemList(e=!1){e||(this.listData.currentIndex=-1),this.listData.items=[];const l=this.listData.searchKeyword;var t=this.rawData.folderList;let r=""!==l,d=[],o=[],n=5;if(d.push({type:"all",size:27,name:"All"}),t.forEach(e=>{var{id:e,name:t}=e,s=this.rawData.folderItemsMap[e],a={...s},i=this.listData.selectedIds[e];i&&n++,(0<=this.rawData.recentFolderOrders[e]||i)&&((e={...s}).depth=0,e.isRecent=!0,o.push(e)),(l||this.isVisible(a))&&d.push(a),t===l&&(r=!1)}),o=(o=(o=o.sort((e,t)=>(e=this.rawData.recentFolderOrders[e.id])<(t=this.rawData.recentFolderOrders[t.id])?-1:t<e?1:0)).sort((e,t)=>this.rawData.selectedIds[e.id]&&!this.rawData.selectedIds[t.id]?-1:!this.rawData.selectedIds[e.id]&&this.rawData.selectedIds[t.id]?1:0)).sort((e,t)=>this.listData.selectedIds[e.id]&&!this.listData.selectedIds[t.id]?-1:!this.listData.selectedIds[e.id]&&this.listData.selectedIds[t.id]?1:0),"ALL"===this.listData.currentTab){let e=this.filterByKeyword(o);e=e.slice(0,n),d=this.filterByKeyword(d),""!==l&&(d=d.filter(t=>!e.find(e=>e.id===t.id))),0<e.length?0<d.length?this.listData.items=[...e,{type:"separator",size:5},...d]:this.listData.items=[...e]:this.listData.items=[...d]}else"RECENT"===this.listData.currentTab?(o=this.filterByKeyword(o),this.listData.items=[...o.slice(0,20)]):"SELECTED"===this.listData.currentTab&&(d=d.filter(e=>this.listData.selectedIds[e.id]),this.listData.items=[...d]);r&&(0<this.listData.items.length?this.listData.items=[...this.listData.items,{type:"separator",size:5},{type:"create",size:27,name:l}]:this.listData.items=[{type:"create",size:27,name:l}]),this.listData.items.forEach((e,t)=>{e.index=t}),e||(""!==l&&0<this.listData.items.length?this.listData.currentIndex=0:this.listData.currentIndex=-1)}isVisible(e){var t;return!(e=e.parent)||!!(t=this.rawData.folderItemsMap[e])&&!this.collapsedFolderIds[e]&&this.isVisible(t)}filterByKeyword(e){if(0!==this.listData.searchKeyword.length){const s=chineseConvert.tw2cn(this.listData.searchKeyword.trim());var t=(e=e.map(e=>{var t=chineseConvert.tw2cn(e.name);return 30<=e.name.length?{item:e,name:t,search:[t]}:{item:e,name:t,search:[t,...new Set(cartesianProduct(pinyinlite(t,{keepUnrecognized:!0}).filter(e=>0<e.length)).map(e=>e.join(" ")))]}}).map(e=>({item:e,name:`${e.name??""} `+(e.keywords??""),score:Math.max(...e.search.map(e=>e.score(s)))})).filter(e=>0<e.score).sort((e,t)=>t.score-e.score).map(function(e){return e.item.item})).reduce((e,t)=>((t.name.toLowerCase().startsWith(this.listData.searchKeyword.toLowerCase())?e.startWithKeyword:e.notStartWithKeyword).push(t),e),{startWithKeyword:[],notStartWithKeyword:[]});e=[...t.startWithKeyword,...t.notStartWithKeyword]}return e}getCallbackResult(){var e,t=this.rawData.selectedIds,s=this.listData.selectedIds;return t=Object.entries(t),e=Object.entries(s),{isDirty:!(t.length===e.length&&t.every(([e,t])=>s[e]===t)),selectedFolderIds:{...this.listData.selectedIds},deselectedFolderIds:Object.entries(this.rawData.selectedIds).reduce((e,[t])=>(this.listData.selectedIds[t]||(e[t]=!0),e),{})}}getFolderParentPath(e){var e=this.rawData.foldersMap[e.parent],t=this.rawData.foldersMap[e?.parent],s=this.rawData.foldersMap[t?.parent],e=e?.name,t=t?.name;let a="";return(s=s?.name)&&t&&e?a=`../<span>${t}</span>/<span>${e}</span>`:!s&&t&&e?a=`<span>${t}</span>/<span>${e}</span>`:s||t||!e||(a=""+e),a}close(){}onTabKey(){}openItem(e){this.collectItem(e)}collectItem(e){"create"===e.type?this.onCreateItem(e):this.onOpenItem(e)}collectItems(e){this.onOpenItem(e)}getSelectedItems(){return Object.keys(this.listData.selectedIds)}selectItem(e){this.listData.selectedIds[e.id]=!this.listData.selectedIds[e.id]}openItemSubmenu(t){t.isRecent?ContextMenu.open({items:[{label:i18n.__("selectFolderPanel.context.removeHistory"),click:()=>{$bodyScope.removeRecentFolder(t.id,()=>{var e={...this.listData.selectedIds};this.reset(),this.init(this.originalParams),this.listData.selectedIds=e,this.updateItemList()})}}],onClosed:()=>{this.focusSearchInput()}}):ContextMenu.open({items:[{label:i18n.__("selectFolderPanel.context.addChilderFolder"),icon:"ic-folder-new-sub-folder.svg",click:()=>{this.createFolder("",e=>{$bodyScope.createFolder({name:e,parentID:t.id,callback:e=>{this.onCreatedFolder(e)}})})}},{label:i18n.__("selectFolderPanel.context.addSiblingFolder"),icon:"ic-expand-same.svg",click:()=>{this.createFolder("",e=>{$bodyScope.createFolder({name:e,sibling:t,callback:e=>{this.onCreatedFolder(e)}})})}}],onClosed:()=>{this.focusSearchInput()}})}changeTab(e){this.listData.currentTab=e,this.updateItemList()}keywordChanged(){this.updateItemList(),this.scrollToTop()}scrollToTop(){$("folder-select-panel select-panel-list").scrollTop(0)}isItemSelectable(e){return{folder:!0,create:!0,all:!0}[e.type]}createFolder(e="",t){swal({html:`
				<div class="alert">
					<div class="alert-icon create"></div>
					<h4 class="alert-title">${i18n.__("selectFolderPanel.createFolder.title")}</h4>
				</div>
			`,showCloseButton:!1,showCancelButton:!0,allowOutsideClick:!1,focusConfirm:!0,focusCancel:!1,padding:24,width:400,customClass:"alert-box",input:"text",inputPlaceholder:i18n.__("selectFolderPanel.createFolder.placeholder"),inputValue:e,cancelButtonColor:"#777777",confirmButtonText:i18n.__("selectFolderPanel.createFolder.button"),cancelButtonText:i18n.__("general.cancel")}).then(e=>{t(e),this.focusSearchInput()},()=>{this.focusSearchInput()})}onCreatedFolder(e){var t={...this.listData.selectedIds};t[e.id]=!0,this.reset(),this.init(this.originalParams),this.listData.selectedIds=t,this.updateItemList()}toggleExpand(e){this.collapsedFolderIds[e.id]?this.expand(e):this.collapse(e)}expand(e){delete this.collapsedFolderIds[e.id],this.updateItemList(!0);try{localStorage["eagle.folderSelectPanel.collapsedFolderIds"]=JSON.stringify(this.collapsedFolderIds)}catch(e){}}collapse(e){this.collapsedFolderIds[e.id]=!0,this.updateItemList(!0);try{localStorage["eagle.folderSelectPanel.collapsedFolderIds"]=JSON.stringify(this.collapsedFolderIds)}catch(e){}}onLeftKey(){var e=this.listData.items[this.listData.currentIndex];e&&"folder"===e.type&&this.collapse(e)}onRightKey(){var e=this.listData.items[this.listData.currentIndex];e&&"folder"===e.type&&this.expand(e)}}EagleApp.directive("folderSelectPanel",["$timeout",i=>({restrict:"E",templateUrl:"js/directives/folder-select-panel.html",replace:!1,scope:{theme:"=theme"},link:s=>{s.isMultipleSelectMode=!1,s.isCmdOrCtrlPress=!1,s.isMac=eagle.env.os.isMac,document.addEventListener("keydown",e=>{"Meta"!==e.key&&"Control"!==e.key||(s.isCmdOrCtrlPress=!0)}),document.addEventListener("keyup",e=>{"Meta"!==e.key&&"Control"!==e.key||(s.isCmdOrCtrlPress=!1)});const a=new FolderSelectPanel({scope:s,panelSelector:"#folder-select-panel",searchInputSelector:"#folder-select-panel-search-input",onSelectChanged:e=>{"keyboard"===e.type&&s.$broadcast("VS-REPEAT-AUTO-SCROLL",e.index)}});s.$on("FOLDER.SELECT.PANEL.OPEN",(e,t)=>{a.init(t),i(()=>{a.open()},50),Object.assign(s,{collapsedFolderIds:a.collapsedFolderIds,listData:a.listData,toggleExpand:e=>{a.toggleExpand(e)},expand:e=>{a.expand(e)},collapse:e=>{a.collapse(e)},selectItem:e=>{a.selectItem(e),s.$evalAsync()},clickItem:e=>{s.isCmdOrCtrlPress&&(s.isMultipleSelectMode=!0),s.isMultipleSelectMode?a.selectItem(e):a.collectItem(e)},collectItems:()=>{var e=a.getSelectedItems();a.collectItems(e)},openItemSubmenu:e=>{a.openItemSubmenu(e)},hoverItem:e=>{a.hoverItem(e.index)},close:()=>{a.close()},focusSearchInput:()=>{a.focusSearchInput()},changeTab:e=>{a.changeTab(e)},onLibrarySwitching:()=>{a.onLibrarySwitching()},onLibrarySwitched:()=>{a.onLibrarySwitched()},onLibrarySwitchClosed:()=>{a.onLibrarySwitchClosed()}})})}})]);