const minutesSymbol="m";let breakButtons,long,breakOverButtons,lastIntervalId=null;async function breakIntervalAlarm(){const{start:e,pomodoroBreakLength:t,pomodoroForUser:o,description:r}=await localStorage.getItem("breakIntervalProps");let a=await localStorage.getItem("breakCounter");const n=new Date(e);let s=0;const i=setInterval((()=>{s++;const e=new Date,c=e.getTime()-n.getTime();updateBadgeTime(c,t),c>=t?(clearInterval(i),o.isAutomaticStartStop?continueLastEntryAndNotify(o,e):createBreakOverNotification(o),"Pomodoro break"===r&&o.isLongBreakEnabled?a++:a=0,localStorage.setItem("breakCounter",a)):s>40&&clearInterval(i)}),1e3);lastIntervalId=i}async function pomodoroIntervalAlarm(){const{start:e,pomodoroForUser:t}=await localStorage.getItem("pomodoroIntervalProps"),o=await localStorage.getItem("breakCounter"),r=new Date(e);let a=0;const n=setInterval((()=>{a++;const e=new Date,s=e.getTime()-r.getTime();updateBadgeTime(s,60*t.timerInterval*1e3),s>=60*t.timerInterval*1e3?(clearInterval(n),t.isLongBreakEnabled&&o>=t.breakCounter?t.isAutomaticStartStop?startBreakAndNotify("Pomodoro long break",t,e):createLongBreakNotification(t):t.isAutomaticStartStop?startBreakAndNotify("Pomodoro break",t,e):createBreakNotification(t)):a>40&&clearInterval(n)}),1e3);lastIntervalId=n}async function getPomodoroForUser(){const e=await localStorage.getItem("userId"),t=await localStorage.getItem("permanent_pomodoro");return t?JSON.parse(t).find((t=>t.userId===e)):null}function setBreakBadge(e,t){const o="Pomodoro break"===t?e.shortBreak:e.longBreak;setTimeout((()=>{aBrowser.action.setBadgeText({text:`${o}m`}),console.log("setBreakBadge",o),this.isChrome()||aBrowser.action.setBadgeTextColor({color:"#FFFFFF"}),aBrowser.action.setBadgeBackgroundColor({color:"#FFC107"})}),2e3)}function setActiveBadge(e){setTimeout((()=>{e&&aBrowser.action.setBadgeText({text:`${e}m`}),this.isChrome()||aBrowser.action.setBadgeTextColor({color:"#FFFFFF"}),aBrowser.action.setBadgeBackgroundColor({color:"#0288D1"})}),2e3)}function updateBadgeTime(e,t){let o=Math.ceil((t-e)/6e4);o<=0&&(o=t/6e4),aBrowser.action.setBadgeText({text:`${o}m`})}function removeBadge(){aBrowser.action.setBadgeText({text:""})}async function addPomodoroTimer(){if(!await aBrowser.alarms.get("pomodoroInterval")){const e=await localStorage.getItem("userId"),t=await localStorage.getItem("permanent_pomodoro"),o=!!t&&JSON.parse(t).find((t=>t.userId===e));if(o&&o.enabled){let{entry:e,error:t}=await TimeEntry.getEntryInProgress();if(t&&(e=null),aBrowser.storage.local.set({timeEntryInProgress:e}),!e)return;this.setActiveBadge(o.timerInterval),localStorage.setItem("pomodoroIntervalProps",{start:e.timeInterval.start,pomodoroForUser:o}),aBrowser.alarms.create("pomodoroInterval",{periodInMinutes:1,when:Date.now()+3e4})}else this.removeBadge()}}function removePomodoroInterval(){aBrowser.alarms.clear("pomodoroInterval")}function removeBreakInterval(){aBrowser.alarms.clear("breakInterval")}function clearTimeoutForRemovingNotification(e,t){const o=setTimeout((()=>{this.clearNotification(e),this.clearTimeout(o)}),1e3*t)}function removeAllPomodoroTimers(){this.removePomodoroInterval(),this.removeBreakInterval(),this.clearBreakOverNotification(),this.clearBreakNotification(),this.clearLongBreakNotification(),void 0!==lastIntervalId&&lastIntervalId&&clearInterval(lastIntervalId)}function clearBreakOverNotification(){this.clearNotification("breakOver")}function clearBreakNotification(){this.clearNotification("pomodoroBreak")}function clearLongBreakNotification(){this.clearNotification("pomodoroLongBreak")}async function startBreakAndNotify(e,t,o){this.removePomodoroInterval(),await this.startBreak(e,o),this.notifyAboutStartingBrake(e,t)}function continueLastEntryAndNotify(e,t){this.removeBreakInterval(),this.continueLastEntryByPomodoro(t),this.notifyThatBreakIsOver(e)}function notifyAboutStartingBrake(e,t){const o="Pomodoro break"===e?t.shortBreak:t.longBreak,r={type:"basic",iconUrl:"./assets/icons/64x64.png",title:clockifyLocales.POMODORO_TIMER,message:clockifyLocales.POMODORO_BREAK_STARTED(o)};this.createNotification("pomodoroBreakNotify",r),this.clearTimeoutForRemovingNotification("pomodoroBreakNotify",10)}function notifyThatBreakIsOver(e){const t={type:"basic",iconUrl:"./assets/icons/64x64.png",title:clockifyLocales.POMODORO_TIMER,message:clockifyLocales.POMODORO_BREAK_ENDED};this.createNotification("pomodoroBreakOverNotify",t),this.clearTimeoutForRemovingNotification("pomodoroBreakOverNotify",10)}async function createBreakNotification(e){breakButtons=[clockifyLocales.STOP_TIMER,"Start break"];const t=await localStorage.getItem("breakCounter");this.removePomodoroInterval();const o=[{title:breakButtons[0]},{title:breakButtons[1]}],r={type:"basic",iconUrl:"./assets/icons/64x64.png",title:clockifyLocales.POMODORO_TIMER,message:clockifyLocales.POMODORO_TAKE_BREAK(e.timerInterval)};this.isChrome()?(r.buttons=o,r.requireInteraction=!0):r.message=r.message+" "+clockifyLocales.CLICK_HERE_TO_START_BREAK,e.isLongBreakEnabled&&(r.message=r.message+" "+clockifyLocales.SESSION(t+1)),this.createNotification("pomodoroBreak",r)}function createBreakOverNotification(e){breakOverButtons=[clockifyLocales.START_TIMER,"Continue last"],this.removeBreakInterval();const t=[{title:breakOverButtons[0]},{title:breakOverButtons[1]}],o={type:"basic",iconUrl:"./assets/icons/64x64.png",title:clockifyLocales.POMODORO_TIMER,message:clockifyLocales.POMODORO_TIME_TO_WORK};this.isChrome()?(o.buttons=t,o.requireInteraction=!0):o.message=o.message+" "+clockifyLocales.CLICK_HERE_TO_START_TIMER,this.createNotification("breakOver",o)}function createLongBreakNotification(e){longBreakButtons=[clockifyLocales.STOP_TIMER,"Start long break"],this.removePomodoroInterval();const t=[{title:longBreakButtons[0]},{title:longBreakButtons[1]}],o={type:"basic",iconUrl:"./assets/icons/64x64.png",title:clockifyLocales.POMODORO_TIMER,message:clockifyLocales.POMODORO_TAKE_LONG_BREAK(e.timerInterval)};this.isChrome()?(o.buttons=t,o.requireInteraction=!0):o.message=o.message+" "+clockifyLocales.CLICK_HERE_TO_START_LONG_BREAK,this.createNotification("pomodoroLongBreak",o)}async function startBreak(e,t){const o=!0,r=!0,a=await getPomodoroForUser();this.setBreakBadge(a,e),aBrowser.storage.local.get(["timeEntryInProgress"],(async({timeEntryInProgress:n})=>{let{projectId:s,task:i,billable:c,tags:l}=n;if(a&&a.isDefaultProjectEnabled){const{defaultProject:e}=await DefaultProject.getStorage(o);if(e.project.id===DefaultProjectEnums.LAST_USED_PROJECT);else{let{projectDB:e,taskDB:t,msg:r,msgId:a}=await DefaultProject.getProjectTaskFromDB(o);e&&(s=e.id,i=t)}}const m=await TimeEntry.endInProgress({timeEntry:Object.assign({},n,{isWebSocketHeader:r}),end:t}),d=m&&m.error;if("Pomodoro break"===e?this.clearBreakNotification():this.clearLongBreakNotification(),d&&400===d.status){const{entry:t,error:o}=await TimeEntry.saveEntryOfflineAndStopItByDeletingIt(n,new Date,r);this.startBreakTimer(e,r,{projectId:s,task:i,billable:c,tags:l})}else this.startBreakTimer(e,r,{projectId:s,task:i,billable:c,tags:l})}))}async function startBreakTimer(e,t,o){const{data:r,error:a}=await TimeEntry.startTimer(e,Object.assign({},o,{isWebSocketHeader:t}),!0);if(r&&r.id){aBrowser.storage.local.set({timeEntryInProgress:r});const t=await getPomodoroForUser(),o="Pomodoro break"===e?60*t.shortBreak*1e3:60*t.longBreak*1e3;localStorage.setItem("breakIntervalProps",{start:r.timeInterval.start,pomodoroForUser:t,pomodoroBreakLength:o,description:e}),aBrowser.alarms.create("breakInterval",{periodInMinutes:1,when:Date.now()+3e4})}else aBrowser.storage.local.set({timeEntryInProgress:null})}async function stopTimerByPomodoro(){const e=await TimeEntry.endInProgress(),t=e&&e.error;this.clearNotification("pomodoroBreak"),this.clearNotification("pomodoroLongBreak"),this.restartPomodoro(),t&&400===t.status&&aBrowser.storage.local.get(["timeEntryInProgress"],(async e=>{const{entry:t,error:o}=await TimeEntry.saveEntryOfflineAndStopItByDeletingIt(e.timeEntryInProgress,new Date)})),setTimeEntryInProgress(null),aBrowser.action.setIcon({path:iconPathEnded})}async function startTimerByPomodoro(){const e=!0,t=await TimeEntry.endInProgress(),o=t&&t.error;this.clearNotification("breakOver"),o&&400===o.status?aBrowser.storage.local.get(["timeEntryInProgress"],(async t=>{const{entry:o,error:r}=await TimeEntry.saveEntryOfflineAndStopItByDeletingIt(t.timeEntryInProgress,new Date,e);this.startNewEntryTimer(e)})):this.startNewEntryTimer(e)}async function startNewEntryTimer(e){const t=await getPomodoroForUser();this.setActiveBadge(t.timerInterval);const{data:o,error:r}=await TimeEntry.startTimer("",e);if(o&&o.id){const e=await getPomodoroForUser();aBrowser.storage.local.set({timeEntryInProgress:o}),localStorage.setItem("pomodoroIntervalProps",{start:o.timeInterval.start,pomodoroForUser:e}),aBrowser.alarms.create("pomodoroInterval",{periodInMinutes:1,when:Date.now()+3e4})}}async function continueLastEntryByPomodoro(e){const t=await getPomodoroForUser();this.setActiveBadge(t.timerInterval);const{entry:o,error:r}=await TimeEntry.getLastPomodoroEntry(),a=!0,n=await TimeEntry.endInProgress({timeEntry:Object.assign({},o,{isWebSocketHeader:a}),end:e}),s=n&&n.error;this.clearNotification("breakOver"),s&&400===s.status?aBrowser.storage.local.get(["timeEntryInProgress"],(async e=>{const{entry:t,error:r}=await TimeEntry.saveEntryOfflineAndStopItByDeletingIt(e.timeEntryInProgress,new Date,a);continueLastEntryTimer(o,a)})):continueLastEntryTimer(o,a)}async function continueLastEntryTimer(e,t){const{data:o,error:r}=await TimeEntry.startTimer(e.description,{projectId:e.projectId,task:e.taskId?{id:e.taskId}:null,billable:e.billable,tags:e.tagIds?e.tagIds.map((e=>({id:e}))):null,isWebSocketHeader:t},!0);if(o&&o.id){const e=await getPomodoroForUser();aBrowser.storage.local.set({timeEntryInProgress:o}),localStorage.setItem("pomodoroIntervalProps",{start:o.timeInterval.start,pomodoroForUser:e}),aBrowser.alarms.create("pomodoroInterval",{periodInMinutes:1,when:Date.now()+3e4})}}function restartPomodoro(){this.removeAllPomodoroTimers(),this.removeBadge(),localStorage.setItem("breakCounter",0)}aBrowser.alarms.onAlarm.addListener((async e=>{switch(lastIntervalId&&(clearInterval(lastIntervalId),lastIntervalId=null),e.name){case"breakInterval":breakIntervalAlarm();break;case"pomodoroInterval":pomodoroIntervalAlarm()}})),aBrowser.runtime.onMessage.addListener(((e,t,o)=>{switch(e.eventName){case"addPomodoroTimer":this.addPomodoroTimer();break;case"restartPomodoro":case"entryEnded":this.restartPomodoro();break;case"removeBadge":this.removeBadge();break;case"entryStarted":if(/Pomodoro (?:long )?break/.test(e.options.entry.description))return;this.addPomodoroTimer()}}));