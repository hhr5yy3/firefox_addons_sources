/*******************************************************
* Copyright (C) 2018-2024 WP Interactive Media, Inc. - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
*******************************************************/
(()=>{"use strict";const e=chrome.runtime.id,t=["bpgopfmgmnojmhnhmgpfmpnookgbmkko","oocalimimngaihdkbihfgmpkcpnmlaoa","igbncjcgfkfnfgbaieiimpfkobabmkce"],n="redirectDataMap",o="Failed to read chrome storage. Please refresh the page and try again";var i=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const r=new class{getItemsAsync(e){return i(this,void 0,void 0,(function*(){return new Promise(((t,n)=>{chrome.storage.local.get(e,(e=>{chrome.runtime.lastError?(console.log(chrome.runtime.lastError),n(new Error(o))):t(e)}))}))}))}getStorageUse(){return i(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{chrome.storage.local.getBytesInUse(null,(n=>{chrome.runtime.lastError?(console.log(chrome.runtime.lastError),t(new Error(o))):e(n)}))}))}))}getAllItemsAsync(){return i(this,void 0,void 0,(function*(){return yield browser.storage.local.get()}))}};Object.freeze(r);const s=r;var c=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const a=new class{setItemsAsync(e){return c(this,void 0,void 0,(function*(){return new Promise(((t,n)=>{chrome.storage.local.set(e,(()=>{chrome.runtime.lastError?n(new Error("Failed to write to chrome storage. Please refresh the page and try again")):t()}))}))}))}};Object.freeze(a);const d=a;var u;!function(e){e.REGISTER="register",e.PARTY_START="party_start",e.PARTY_JOIN="party_join",e.PARTY_END="party_end",e.PARTY_SHARE="party_share"}(u||(u={}));var l=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const f=new class{getRedirectDataForTabAsync(e){return l(this,void 0,void 0,(function*(){const t=(yield s.getItemsAsync([n])).redirectDataMap,o=this.t(e);if(t&&t[o]){const e=t[o];if(this.o(e))return e}}))}deleteRedirectDataForTabAsync(e){return l(this,void 0,void 0,(function*(){const t=(yield s.getItemsAsync([n])).redirectDataMap,o=this.t(e);t&&t[o]&&delete t[o],yield d.setItemsAsync({[n]:t})}))}t(e){return e}storeRedirectDataForTabAsync(e,t){return l(this,void 0,void 0,(function*(){console.log("store data for tab "+e);const o=this.t(t);let i=yield s.getItemsAsync([n]);i[o]=e,i=this.i(i),yield d.setItemsAsync({[n]:i})}))}i(e){return function(e,t){const n={};let o;for(o in e)e.hasOwnProperty(o)&&t(e[o])&&(n[o]=e[o]);return n}(e,this.o)}o(e){const t=e.date;return void 0!==t&&"number"==typeof t&&t<=Date.now()&&Date.now()-t<108e5}};Object.freeze(f);const h=f,v="Service_Background",m="Iframe";class w{constructor(e,t,n){this.sender=e,this.target=t,this.type=n}}class y extends w{constructor(e,t,n){super(e,t,n),this.type=n}}var p;!function(e){e.JOIN_SESSION="joinSession",e.ACCEPT_DROPIN="acceptDropin",e.SET_STATUS_TYPE="setStatusType",e.GET_STATUS_TYPE="getStatusType",e.GET_VIDEO_DATA="getVideoData",e.LOAD_SESSION="loadSession",e.NO_SESSION_DATA="noSessionData",e.ON_NOTIF="onNotif",e.FORWARD_TO_SIDEBAR="forwardToSidebar",e.TEARDOWN="teardown",e.ON_VIDEO_UPDATE="onVideoUpdate",e.SOCKET_LOST_CONNECTION="socketLostConnection",e.REBOOT="socketReconnect",e.LOG_EVENT="logEvent",e.LOG_EXPERIMENT="logExperiment",e.STAY_ALIVE="stayAlive",e.LOAD_CHAT_WINDOW="loadChatWindow",e.RESET_CHAT_WINDOW="resetChatWindow",e.HIDE_CHAT_WINDOW="hideChatWindow",e.SET_USER_PRESENCE="setUserPresence",e.TOGGLE_OPEN_PARTY="toggleOpenParty",e.GET_ACTIVE_PARTY="getActiveParty",e.GET_TAB_ID="getTabId",e.SET_ACTIVE_PARTY="setActiveParty",e.FULLSCREEN_WINDOW="fullscreenWindow",e.MAX_WINDOW="maxWindow",e.GET_EXPERIMENT_FLAG="getExpFlag",e.USER_LIST="userList",e.USER_AUTHENTICATED="userAuthenticated",e.BLOCK_CSP="blockCSP",e.REDIRECT_DATA_SET="redirectDataSet",e.LOAD_NETFLIX_DATA="loadNetflixData"}(p||(p={}));class g extends y{constructor(e,t,n){super(e,t,p.LOG_EVENT),this.data=n,this.sender=e,this.target=t}}var b=console.log.bind(window.console),x=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const S=new class{addListener(e){browser.runtime.onMessage.addListener(e),chrome.runtime.onMessage.addListener(e)}removeListener(e){chrome.runtime.onMessage.removeListener(e)}sendMessageToTabAsync(e,t,n=2e4){return x(this,void 0,void 0,(function*(){{const o=setTimeout((()=>{throw console.log("send timeout"),new Error("send timeout")}),n),i=yield browser.tabs.sendMessage(t,e);if(browser.runtime.lastError)throw b(browser.runtime.lastError.message+JSON.stringify(e)),new Error(browser.runtime.lastError.message);return clearTimeout(o),i}}))}u(t,n){return x(this,void 0,void 0,(function*(){return new Promise(((o,i)=>{let r=null;n&&(r=setTimeout((()=>{i({error:"Send Message Timeout"})}),n));try{chrome.runtime.sendMessage(e,t,(e=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError.message+JSON.stringify(t)),r&&clearTimeout(r),o(e)}))}catch(e){r&&clearTimeout(r),i(e)}}))}))}},T=S;class P extends y{constructor(e,t,n){super(e,t,p.LOG_EXPERIMENT),this.data=n}}var A,D,k;!function(e){e.DO_AUTH_SIGN_IN="doAuthSignIn",e.DO_APPLE_SIGN_IN="doAppleSignIn",e.GET_AUTH_TOKEN="getAuthToken",e.SIGN_OUT="signOut"}(A||(A={}));class I extends w{constructor(e,t,n){super(e,t,n),this.type=n}}class _ extends I{constructor(e,t){super(e,t,A.DO_AUTH_SIGN_IN)}}class C extends I{constructor(e,t){super(e,t,A.GET_AUTH_TOKEN)}}class E extends I{constructor(e,t){super(e,t,A.SIGN_OUT)}}class R extends y{constructor(e,t){super(e,t,p.GET_ACTIVE_PARTY)}}class M extends y{constructor(e,t,n){super(e,t,p.ACCEPT_DROPIN),this.data=n}}!function(e){e.WITH_ACTIVITY="with_activity",e.NO_ACTIVITY="no_activity",e.OFFLINE="offline"}(D||(D={}));class O extends y{constructor(e,t,n){super(e,t,p.SET_STATUS_TYPE),this.data=n}}!function(e){e.SET_USER_LIST="setUserList",e.SET_CONNECTION_ID="setConnectionId",e.LOAD_INIT_DATA="loadInitData",e.SET_PAGE_TITLE="setPageTitle",e.ADD_GIF_MESSAGE="addGifMessage",e.SIDEBAR_MESSAGING_READY="sidebarMessagingReady",e.RESET_VIEW="resetView",e.HIDE_CHAT="hideChat",e.ON_UPDATE_SETTINGS="onUpdateSettings",e.PREVIEW_REACTION="previewReaction",e.UPDATE_SETTINGS="updateSettings",e.SET_REACTIONS_ACTIVE="setReactionsActive",e.ON_FOCUS="onSidebarFocus",e.SET_USER_ICON_URL="setUserIconUrl",e.ADD_MESSAGE="addMessage",e.CLEAR_MESSAGES="clearMessages",e.SET_PRESENCE_MESSAGE="setPresenceMessage",e.ON_PAGE_CLICK="onPageClick",e.ON_PURCHASE="onPurchase",e.DISPLAY_MODAL="displayModal",e.OPEN_TAB="openTab",e.ON_CHROME_STORAGE_UPDATE="onChromeStorageUpdate",e.ON_WEB_RTC="onWebRTC"}(k||(k={}));var N=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const j="https://www.netflix.com/watch/*";let G,U,F="new";"http://localhost:3000"===window.origin||window.origin.match(/^https:\/\/[^.]*\.(?:(?:tele\.pe)|(?:teleparty\.com)|(?:netflixparty\.com))$/);function V(e){return"https://www.tele.pe"===e.origin&&(F="old"),function(e){if(null!=t.find((t=>e.origin===`chrome-extension://${t}`)))return!0;return null!=e.origin.match(/^https:\/\/[^.]*\.(?:(?:tele\.pe)|(?:teleparty\.com)|(?:netflixparty\.com))$/)}(e)}function L(e,t){return N(this,void 0,void 0,(function*(){const n=yield $();n&&(yield h.storeRedirectDataForTabAsync(e,n));const{sessionId:o,service:i}=e,r=new g(m,v,{sessionId:o,eventType:`redirect-${F}-${i}-firefox`}),s=new g(m,v,{name:"user_click",action:{description:`redirect-${F}-${i}-firefox`}});try{yield T.u(s,2500),yield T.u(r,2500)}finally{t("resolveRedirect")}}))}function $(){return N(this,void 0,void 0,(function*(){return yield T.u(new y(m,v,p.GET_TAB_ID))}))}console.log("Connect Loaded",window.origin,window.location),navigator.serviceWorker&&navigator.serviceWorker.addEventListener("message",(e=>{console.log(e),parent.postMessage(e.data,"*")})),window.addEventListener("message",(function(e){var t;try{if(V(e)){const t=e.data;if(t&&t.type&&!t.from_connect){const n=function(e){return t=>{var n;if(e.data.callbackId){const n={callbackId:e.data.callbackId,data:t,from_connect:!0};try{window.parent.postMessage(n,e.origin)}catch(e){}}else null===(n=window.parent)||void 0===n||n.postMessage(Object.assign(Object.assign({},t),{from_connect:!0}),e.origin)}}(e);if("Content_Script"===t.target||t.target===v)!function(e,t){N(this,void 0,void 0,(function*(){const n=yield T.u(e);t(n)}))}(t,n);else if("SetRedirectData"==t.type)console.log("Got setRedirectData message",t),T.u({sender:m,target:v,type:p.BLOCK_CSP}),L(t.data,n);else if(t.sessionId)L(t,n);else{if("GetPermissions"===t.type)return void n(!0);if("CheckHasPermissions"===t.type)return void n(!0);"logExperiment"===t.type?function(e,t){N(this,void 0,void 0,(function*(){const{experimentName:n,experimentVersion:o,event:i}=e,r=new P(m,v,{experimentName:n,experimentVersion:o,eventType:i});try{yield T.u(r,2500)}finally{t()}}))}(t.data,n):"logEvent"===t.type?function(e,t){N(this,void 0,void 0,(function*(){const n=new g(m,v,e.event);try{T.u(n,2500)}finally{t()}}))}(t.data,n):"SetPermId"===t.type?function(e){N(this,void 0,void 0,(function*(){const t=yield s.getAllItemsAsync();t.userId||(t.userId=e)}))}(t.data):"storeExperimentVersion"===t.type?function(e,t){var n;N(this,void 0,void 0,(function*(){const{experimentName:o,experimentVersion:i}=e,r=yield s.getItemsAsync(["experiments"]),c=null!==(n=r.experiments)&&void 0!==n?n:{};c[o]=i;try{yield d.setItemsAsync({experiments:c})}finally{t()}}))}(t.data,n):"GetPermId"===t.type?function(e){N(this,void 0,void 0,(function*(){const t=(yield s.getAllItemsAsync()).userId;e(t)}))}(n):"GetActiveNetflixTabs"===t.type?function(e){chrome.tabs.query({url:j},(t=>{e(t)}))}(n):"CloseNetflixTabs"===t.type?function(e){chrome.tabs.query({url:j},(t=>{const n=t.map((e=>e.id)).filter((e=>!!e));chrome.tabs.remove(n),e()}))}(n):"AddSidebarHandler"===t.type?function(e,t){N(this,void 0,void 0,(function*(){console.log("add sidebar handler"),G=e,U=yield $(),t(U)}))}(e.origin,n):"DoGoogleAuth"===t.type?function(e){N(this,void 0,void 0,(function*(){const t=new _(m,v);yield T.u(t),e()}))}(n):"DoSignOut"===t.type?function(e){N(this,void 0,void 0,(function*(){const t=new E(m,v);yield T.u(t),e()}))}(n):"GetAuthToken"===t.type?function(e){N(this,void 0,void 0,(function*(){const t=new C(m,v),n=yield T.u(t);e(n)}))}(n):"LoadSessionTab"===t.type?function(e,t){N(this,void 0,void 0,(function*(){chrome.tabs.create(e.tabData,(t=>N(this,void 0,void 0,(function*(){const n=t.id;n&&(yield h.storeRedirectDataForTabAsync(e.sessionData,n))}))))}))}(t.data):"GetActiveParty"===t.type?function(e){N(this,void 0,void 0,(function*(){const t=new R(m,v),n=yield T.u(t);e(n)}))}(n):"AcceptDropin"===t.type?function(e){N(this,void 0,void 0,(function*(){const t=e.sessionId;T.u(new M(m,v,{sessionId:t}))}))}(t.data):"SetStatusType"===t.type?function(e){N(this,void 0,void 0,(function*(){const t=e.type;T.u(new O(m,v,t))}))}(t.data):"GetStatusType"==t.type?function(e){N(this,void 0,void 0,(function*(){const t=yield T.u(new y(m,v,p.GET_STATUS_TYPE));e(t)}))}(n):console.log("Unsupported Operation "+t.type)}}}}catch(n){n&&n.message.includes("Extension context invalidated")&&(null===(t=window.top)||void 0===t||t.postMessage("tp_reload",e.origin))}}),!1),T.addListener((function(e,t,n){var o;return"TP_Sidebar"!==e.target||(null===(o=t.tab)||void 0===o?void 0:o.id)!==U&&e.tabId!==U?(e.type===k.ON_PURCHASE&&null!=G&&window.parent.postMessage(e,G),!1):null!=G?(window.parent.postMessage(e,G),n(),!0):(console.warn("Not ready yet"),n(),!0)}))})();