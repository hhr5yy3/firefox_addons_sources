// Copyright (c) Zanger LLC. All rights reserved.

(function(){"use strict";var scope;if((typeof exports)!=="undefined"){scope=exports;}
else{scope={};window.scope.persistentRndStorage=scope;}
const settings=require("./settings");const logging=require("./logging");scope.persistentRnd=Object.create(null);scope.persistentIncognitoRnd=Object.create(null);scope.init=function init(){logging.message("initializing persistent rng storage");logging.notice("build persistent storage");if(settings["canvas.storePersistentRnd"]){try{let storedData=JSON.parse(settings["canvas.persistentRndStorage"]);for(var domain in storedData){var value=storedData[domain];if(Array.isArray(value)&&value.length===128&&value.every(function(value){return typeof value==="number"&&value>=0&&value<256;})){scope.persistentRnd[domain]=value;}}}
catch(e){}}
else{settings["canvas.persistentRndStorage"]="";settings["canvas.lastPersistentRndClearing"]=Date.now();}
registerTimeout();logging.notice("register settings change event listener");settings.on(["canvas.persistentRndClearIntervalValue","canvas.persistentRndClearIntervalUnit"],function(){window.clearTimeout(clearTimeout);registerTimeout();});settings.on("canvas.storePersistentRnd",function({newValue}){settings["canvas.persistentRndStorage"]=newValue?JSON.stringify(scope.persistentRnd):"";});};const getInterval=function(){var units={seconds:1000,minutes:60*1000,hours:60*60*1000,days:24*60*60*1000,weeks:7*24*60*60*1000,months:30*24*60*60*1000,years:365*24*60*60*1000,};return function getInterval(){return settings["canvas.persistentRndClearIntervalValue"]*units[settings["canvas.persistentRndClearIntervalUnit"]]||0;};}();browser.windows.onRemoved.addListener(function(){browser.windows.getAll().then(function(windows){if(windows.every(function(window){return!window.incognito;})){clearIncognito();}});});let clearTimeout;function registerTimeout(){var interval=getInterval();if(interval>0){var timeout=settings["canvas.lastPersistentRndClearing"]+interval-Date.now();logging.message("registering persistent rng data clearing timeout. Clearing in ",timeout,"ms");if(timeout>1073741824){clearTimeout=window.setTimeout(registerTimeout,1073741824);}
else{clearTimeout=window.setTimeout(clear,timeout);}}}
function broadcast(data){browser.tabs.query({}).then(function(tabs){tabs.forEach(function(tab){browser.tabs.sendMessage(tab.id,data);});});}
function clearIncognito(){scope.persistentIncognitoRnd=Object.create(null);settings["canvas.persistentIncognitoRndStorage"]=JSON.stringify(scope.persistentIncognitoRnd);}
function clear(){logging.verbose("domain rnd cleared");scope.persistentRnd=Object.create(null);settings["canvas.persistentRndStorage"]=JSON.stringify(scope.persistentRnd);settings["canvas.lastPersistentRndClearing"]=Date.now();clearIncognito();registerTimeout();broadcast({"canvasBlocker-clear-domain-rnd":true});}
function setDomainData(domain,incognito,rnd){logging.verbose("got new domain rnd for ",domain," (incognito:",incognito,"):",rnd);if(incognito){scope.persistentIncognitoRnd[domain]=rnd;settings["canvas.persistentIncognitoRndStorage"]=JSON.stringify(scope.persistentIncognitoRnd);}
else{scope.persistentRnd[domain]=rnd;settings["canvas.persistentRndStorage"]=JSON.stringify(scope.persistentRnd);}
broadcast({"canvasBlocker-set-domain-rnd":{domain,incognito,rnd}});}
scope.clear=clear;scope.setDomainData=setDomainData;}());