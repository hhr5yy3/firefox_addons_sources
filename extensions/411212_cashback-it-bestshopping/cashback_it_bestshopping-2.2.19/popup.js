const searchIcon=document.getElementById("search_icon"),langOption=(searchIcon.addEventListener("click",FocusTheSearch),document.getElementById("lang")),searchInput=(langOption.addEventListener("change",ChangeLanguage),document.getElementById("search-list")),btnshop=(searchInput.addEventListener("keyup",SearchOnList),document.getElementById("btn-shop")),btnsuper=(btnshop.addEventListener("click",ShowShop),btnshop.classList.add("buttonSelected"),document.getElementById("btn-superCashback")),btnfavorite=document.getElementById("btn-favorite"),btnsettings=document.getElementById("btn-settings"),btnprofile=(btnsettings.addEventListener("click",ToggleSettings),document.getElementById("btn-profile")),divHomepage=(btnprofile.addEventListener("click",ToggleProfile),document.getElementById("homepage")),divProfile=document.getElementById("profile"),divSettings=document.getElementById("settings"),divFavorite=document.getElementById("favorite"),loginLink=document.getElementById("login"),loading=(loginLink.addEventListener("click",ShowLoginPage),document.getElementById("loading")),merchantList=document.getElementById("merchantList"),hpLink=document.getElementById("homepage_link"),profileLink=(hpLink.addEventListener("click",ShowHomePage),document.getElementById("profile_link")),faqLink=(profileLink.addEventListener("click",ShowProfilePage),document.getElementById("faq_link")),privacyLink=(faqLink.addEventListener("click",ShowFaqPage),document.getElementById("privacy_link")),hl1=(privacyLink.addEventListener("click",ShowPrivacyPage),document.getElementById("header_logo1")),hl2=(hl1.addEventListener("click",ShowHomePage),document.getElementById("header_logo2")),feedbackLink=(hl2.addEventListener("click",ShowHomePage),document.getElementById("feedback_link")),permission=(feedbackLink.addEventListener("click",ShowFeedbackPage),document.getElementById("permission")),checkbox=(permission.addEventListener("click",requestPermissions),document.getElementById("serpInput")),noFavorite=document.getElementById("noFavorite"),merchantFavoriteList=document.getElementById("merchantFavoriteList"),lbl_cashwait=document.getElementById("lbl_cashwait"),lbl_cashgain=document.getElementById("lbl_cashgain"),lbl_bonus=document.getElementById("lbl_bonus"),lbl_bonusValue=document.getElementById("lbl_bonusValue"),lbl_serp=document.getElementById("lbl_serp"),lbl_serpDesc=document.getElementById("lbl_serpDesc"),img_animal=document.getElementById("animalLevel"),cashWaiting=document.getElementById("valueOrange"),cashEarned=document.getElementById("valueGreen");var isBlinkedTab=!1,isMerchantBlinked="",messages_label="";function Init(){browser.storage.sync.get("language",function(e){var t;null==e.language?(t=navigator.language||navigator.userLanguage,"IT"==(userL=t.split("-")[1])&&"EN"==userL||(userL="IT"),browser.storage.sync.set({language:userL},function(){}),langOption.value="IT"):"IT"==e.language?langOption.value="IT":"EN"==e.language?langOption.value="EN":"LA"==e.language&&(langOption.value="LA")}),browser.storage.sync.get("serpOption",function(e){1==e.serpOption?checkbox.checked=!0:0==e.serpOption?checkbox.checked=!1:browser.storage.sync.set({serpOption:!0},function(){checkbox.checked=!0})}),ChangeLanguage()}function FocusTheSearch(){searchInput.focus()}function ChangeLanguage(){"IT"==langOption.value?messages_label=MESSAGES.IT:"EN"==langOption.value?messages_label=MESSAGES.EN:"LA"==langOption.value&&(messages_label=MESSAGES.LA),browser.storage.sync.set({language:langOption.value},function(){btnshop.innerHTML=messages_label.message.SHOPS_MAIN,btnsuper.innerHTML=messages_label.message.SHOPS_SUPER_CASHBACK,btnfavorite.innerHTML=messages_label.message.SHOPS_PREFERRED,searchInput.placeholder=messages_label.message.SEARCH_PLACEHOLDER,lbl_cashwait.innerHTML=messages_label.message.LABEL_PENDING,lbl_cashgain.innerHTML=messages_label.message.LABEL_EARNED,lbl_bonus.innerHTML=messages_label.message.LABEL_PERCENTAGE,noFavorite.innerHTML=messages_label.message.LABEL_SHOW_HERE_PREFERRED,lbl_serp.innerHTML=messages_label.message.LABEL_SERP_ALERT,lbl_serpDesc.innerHTML=messages_label.message.LABEL_SERP_MESSAGE,hpLink.innerHTML=messages_label.message.LABEL_HOMEPAGE,profileLink.innerHTML=messages_label.message.LABEL_PROFILE,faqLink.innerHTML=messages_label.message.LABEL_FAQ,privacyLink.innerHTML=messages_label.message.LABEL_PRIVACY,feedbackLink.innerHTML=messages_label.message.LABEL_FEEDBACK,permission.innerHTML=messages_label.message.LABEL_PERMISSION,lbl_bonusValue.innerHTML=lbl_bonusValue.innerHTML.replace(".",messages_label.message.POINTER),lbl_bonusValue.innerHTML=lbl_bonusValue.innerHTML.replace(",",messages_label.message.POINTER),cashEarned.innerHTML=cashEarned.innerHTML.replace(".",messages_label.message.POINTER),cashEarned.innerHTML=cashEarned.innerHTML.replace(",",messages_label.message.POINTER),cashWaiting.innerHTML=cashWaiting.innerHTML.replace(".",messages_label.message.POINTER),cashWaiting.innerHTML=cashWaiting.innerHTML.replace(",",messages_label.message.POINTER),loading.style.display="block",merchantList.style.display="none",browser.storage.local.get(["jsonResponse"],function(e){""==e.jsonResponse||null==e.jsonResponse?DownloadJSONlist():ParseAndFillList(data=JSON.parse(e.jsonResponse))})}),searchInput.value=""}function ToggleSettings(){"true"==divSettings.getAttribute("hidden")?(divSettings.setAttribute("hidden","false"),divProfile.setAttribute("hidden","true"),divFavorite.setAttribute("hidden","true"),divProfile.style.display="none",divHomepage.style.display="none",divFavorite.style.display="none",divSettings.style.display="block",btnshop.classList.remove("buttonSelected")):(divSettings.setAttribute("hidden","true"),divProfile.setAttribute("hidden","true"),divFavorite.setAttribute("hidden","true"),divHomepage.style.display="block",divSettings.style.display="none",divProfile.style.display="none",divFavorite.style.display="none",btnshop.classList.add("buttonSelected")),btnsuper.classList.remove("buttonSelected"),btnfavorite.classList.remove("buttonSelected")}function ToggleProfile(){"true"==divProfile.getAttribute("hidden")?(browser.storage.local.get("isUser",function(t){browser.storage.local.get("isLogged",function(e){if(e.isLogged){e=e.isLogged.split("|");switch(document.getElementById("login").innerHTML=t.isUser,"0"==e[3]?cashWaiting.innerHTML="&euro; 0,00":cashWaiting.innerHTML="&euro; "+e[3],"0"==e[0]?cashEarned.innerHTML="&euro; 0,00":cashEarned.innerHTML="&euro; "+e[0],img_animal.style.backgroundImage="url('https://s3-images.bestshopping.com/ml/l/"+e[2]+".png')",e[2]){case"1":lbl_bonusValue.innerHTML="0.00%";break;case"2":lbl_bonusValue.innerHTML="1.33%";break;case"3":lbl_bonusValue.innerHTML="2.66%";break;case"4":lbl_bonusValue.innerHTML="4.00%";break;case"5":lbl_bonusValue.innerHTML="5.33%";break;case"6":lbl_bonusValue.innerHTML="6.66%";break;case"7":lbl_bonusValue.innerHTML="8.00%";break;case"8":lbl_bonusValue.innerHTML="9.33%";break;case"9":lbl_bonusValue.innerHTML="10.66%";break;case"10":lbl_bonusValue.innerHTML="12.00%";break;case"11":lbl_bonusValue.innerHTML="13.33%";break;case"12":lbl_bonusValue.innerHTML="14.50%";break;case"13":lbl_bonusValue.innerHTML="16.00%";break;case"14":lbl_bonusValue.innerHTML="17.33%"}cashWaiting.innerHTML=cashWaiting.innerHTML.replace(".",messages_label.message.POINTER),cashEarned.innerHTML=cashEarned.innerHTML.replace(".",messages_label.message.POINTER),lbl_bonusValue.innerHTML=lbl_bonusValue.innerHTML.replace(".",messages_label.message.POINTER)}else loginLink.innerHTML=messages_label.message.LABEL_ACCEDI})}),divProfile.setAttribute("hidden","false"),divSettings.setAttribute("hidden","true"),divFavorite.setAttribute("hidden","true"),divSettings.style.display="none",divHomepage.style.display="none",divFavorite.style.display="none",divProfile.style.display="block",btnshop.classList.remove("buttonSelected")):(divSettings.setAttribute("hidden","true"),divProfile.setAttribute("hidden","true"),divFavorite.setAttribute("hidden","true"),divHomepage.style.display="block",divFavorite.style.display="none",divProfile.style.display="none",divSettings.style.display="none",btnshop.classList.add("buttonSelected")),btnsuper.classList.remove("buttonSelected"),btnfavorite.classList.remove("buttonSelected")}function ShowShop(){var e,t,n;for(btnshop.classList.add("buttonSelected"),btnsuper.classList.remove("buttonSelected"),btnfavorite.classList.remove("buttonSelected"),divSettings.setAttribute("hidden","true"),divProfile.setAttribute("hidden","true"),divFavorite.setAttribute("hidden","true"),divHomepage.style.display="block",divSettings.style.display="none",divProfile.style.display="none",divFavorite.style.display="none",document.getElementById("search-list").value.toUpperCase(),t=(e=document.getElementById("merchantList")).getElementsByClassName("Nmerchant"),n=0;n<t.length;n++)t[n].parentElement.style.display="flex";searchInput.value="",e.scrollTop=0}function ShowSuperCashback(){var e,t,n,s;for(btnshop.classList.remove("buttonSelected"),btnsuper.classList.add("buttonSelected"),btnfavorite.classList.remove("buttonSelected"),divSettings.setAttribute("hidden","true"),divProfile.setAttribute("hidden","true"),divFavorite.setAttribute("hidden","true"),divHomepage.style.display="block",divSettings.style.display="none",divProfile.style.display="none",divFavorite.style.display="none",document.getElementById("search-list").value.toUpperCase(),t=(e=document.getElementById("merchantList")).getElementsByClassName("Nmerchant"),s=0;s<t.length;s++)n=t[s].getAttribute("issupercashback"),t[s].parentElement.style.display="true"==n?"flex":"none";searchInput.value="",e.scrollTop=0}function ShowFavorite(){btnshop.classList.remove("buttonSelected"),btnsuper.classList.remove("buttonSelected"),btnfavorite.classList.add("buttonSelected"),divSettings.setAttribute("hidden","true"),divProfile.setAttribute("hidden","true"),divFavorite.setAttribute("hidden","false"),divHomepage.style.display="none",divSettings.style.display="none",divProfile.style.display="none",divFavorite.style.display="block",browser.storage.local.get("prefCookie",function(e){if(e.prefCookie){var a=e.prefCookie.split(";");let t="";for(let e=0;e<a.length;e++)if(""!=a[e]){var i,l=a[e].toUpperCase(),o=document.getElementById("merchantList"),r=o.getElementsByClassName("Nmerchant");for(d=0;d<r.length;d++)-1<((i=r[d]).textContent||i.innerText).toUpperCase().indexOf(l)&&(t+="<li class='libutton' style='display: flex;'>"+r[d].parentElement.innerHTML+"</li>");o.scrollTop=0}merchantFavoriteList.innerHTML=t;var c=merchantFavoriteList.getElementsByClassName("libutton");let n,s;for(var d=0;d<c.length;d++)!function(e){c[e].addEventListener("click",function(){n=c[e].querySelector(".Nmerchant").getAttribute("affiliate_url"),s=c[e].querySelector(".Nmerchant").getAttribute("toolbar_disabled"),SetIsFromJump(n,s)})}(d);noFavorite.style.display="none"}else merchantFavoriteList.innerHTML="",noFavorite.style.display="block"})}function ShowLoginPage(){window.open("https://it.bestshopping.com/profilo.html","_blank"),window.close()}function ShowHomePage(){window.open("https://it.bestshopping.com/","_blank"),window.close()}function ShowProfilePage(){window.open("https://it.bestshopping.com/profilo.html","_blank"),window.close()}function ShowFaqPage(){window.open("https://it.bestshopping.com/cos-e-il-cashback-e-come-funziona.html#faq","_blank"),window.close()}function ShowPrivacyPage(){window.open("https://it.bestshopping.com/html/toolbar-cashback-faq.html#privacy","_blank"),window.close()}function ShowFeedbackPage(){window.open("https://form.jotform.com/POINTERSRL/memo-feedback","_blank"),window.close()}function SearchOnList(e){for(var t,n=("string"==typeof e||e instanceof String?String(e):document.getElementById("search-list").value).toUpperCase(),s=document.getElementById("merchantList").getElementsByClassName("Nmerchant"),a=0;a<s.length;a++)-1<((t=s[a]).textContent||t.innerText).toUpperCase().indexOf(n)?s[a].parentElement.style.display="":s[a].parentElement.style.display="none"}function DownloadJSONlist(){browser.storage.local.get(["jsonResponse"],function(e){var t;""!=e.jsonResponse&&null!=e.jsonResponse?ParseAndFillList(data=JSON.parse(e.jsonResponse)):((t=new XMLHttpRequest).open("GET","https://rapi.bestshopping.com/api/v1/cashback/new?fields=merchant_id%2Cname%2Clabel%2Ctoolbar_blank%2Ccashback_label%2Caffiliate_url%2Clogo_url%2Ctoolbar_url_v2%2Cis_supercashback%2Ctoolbar_blank%2Ctoolbar_disabled&sort=-popularity&AccessKeyId=7b57608020a2b70c2812b77325b6eb90",!0),t.onload=function(){var e;200<=t.status&&t.status<400&&(e=JSON.parse(t.responseText),browser.storage.local.set({jsonResponse:t.responseText},function(){}),ParseAndFillList(e))},t.send())})}function ParseAndFillList(e){var t=document.getElementById("merchantList"),n="";e.forEach(function(e){var t=e.cashback_label.replace("Cashback","");"IT"==langOption.value&&(t=t.replace(".",",")),""==n?n="<li class='libutton'><div class='headCategory'>"+e.label+"</div><hr color='#ebebeb' width='80%'><div class='Nmerchant' isSupercashback='"+e.is_supercashback+"' affiliate_url='"+e.affiliate_url+"' toolbar_disabled='"+e.toolbar_disabled+"' style='visibility: hidden;'>"+e.name+"</div><div class='merchantBgImg' style='background-image: url("+e.logo_url+")'></div><div class='merchantType'>"+messages_label.message.CASHBACK+"</div><div class='merchantPerc'>"+t+"</div></li>":n+="<li class='libutton'><div class='headCategory'>"+e.label+"</div><hr color='#ebebeb' width='80%'><div class='Nmerchant' isSupercashback='"+e.is_supercashback+"' affiliate_url='"+e.affiliate_url+"' toolbar_disabled='"+e.toolbar_disabled+"' style='visibility: hidden;'>"+e.name+"</div><div class='merchantBgImg' style='background-image: url("+e.logo_url+")'></div><div class='merchantType'>"+messages_label.message.CASHBACK+"</div><div class='merchantPerc'>"+t+"</div></li>"}),t.innerHTML=n,btnsuper.addEventListener("click",ShowSuperCashback),btnfavorite.addEventListener("click",ShowFavorite),ShowAffiliatePage()}function ShowAffiliatePage(){var t=document.getElementsByClassName("libutton");let n,s;for(var e=0;e<t.length;e++)!function(e){t[e].addEventListener("click",function(){n=t[e].querySelector(".Nmerchant").getAttribute("affiliate_url"),s=t[e].querySelector(".Nmerchant").getAttribute("toolbar_disabled"),SetIsFromJump(n,s)})}(e);loading.style.display="none",merchantList.style.display="block",1==isBlinkedTab&&SearchOnList(isMerchantBlinked)}function SetIsFromJump(e,t){var n=new URL(e).searchParams,s=new URLSearchParams(n).get("merchant");browser.storage.local.set({isAcompetitor:!1},function(){}),1==t||s.toLowerCase().includes("buonispesa")||s.toLowerCase().includes("ricarica")||s.toLowerCase().includes("carteregalo")?window.open(e+"&jo=true","_blank"):(window.open(e+"&jo=true","_blank"),browser.storage.local.get("merchantKeyJump",function(e){null==e.merchantKeyJump||""==e.merchantKeyJump||"undefined"==e.merchantKeyJump?browser.storage.local.set({merchantKeyJump:s},function(){}):(String(e.merchantKeyJump).split(","),browser.storage.local.set({merchantKeyJump:e.merchantKeyJump+","+s},function(){})),browser.storage.local.set({isFromJump:!0},function(){})}),window.close())}Init(),checkbox.addEventListener("change",e=>{e.currentTarget.checked?browser.storage.sync.set({serpOption:!0},function(){}):browser.storage.sync.set({serpOption:!1},function(){})}),document.addEventListener("keydown",function(){searchInput.focus()});const permissionsToRequest={origins:["<all_urls>","https://*.google.com/*","https://*.google.it/*","https://*.bing.com/*","https://*.search.yahoo.com/*","https://*.bestshopping.com/*"]};async function requestPermissions(){var e=await browser.permissions.request(permissionsToRequest);(e=e)&&((e=document.getElementById("permission")).innerHTML="",e.classList.add("activated")),await browser.permissions.getAll()}