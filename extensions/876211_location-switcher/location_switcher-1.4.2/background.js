"use strict";var currentTabURL="",userDefinedLocations=[],sourceLocation="",destinationLocations=[],locationIcons={},darkThemeEnabled=!1,sortEnabled=!1,forcePopupEnabled=!1;const darkFillColor="#b1b1b1";function getNextLocation(){browser.tabs.query({active:!0,currentWindow:!0}).then(tabs=>{const tabId=tabs[0].id;currentTabURL=tabs[0].url,sourceLocation="",destinationLocations=[],browser.pageAction.hide(tabId);var icon="icons/default.svg",source="";for(source in locationIcons)if(currentTabURL.startsWith(source)){icon=locationIcons[source];break}for(source in icon=(icon=icon.replace("icons/light/","icons/")).replace("icons/dark/","icons/"),userDefinedLocations)if(currentTabURL.startsWith(source))return browser.pageAction.show(tabId),sourceLocation=source,destinationLocations=userDefinedLocations[source],updateIcon(tabId,icon,darkThemeEnabled),void(destinationLocations.length>1||forcePopupEnabled?(sortEnabled&&destinationLocations.sort(),browser.pageAction.setPopup({tabId:tabId,popup:"popup/popup.html"}),browser.pageAction.setTitle({tabId:tabId,title:destinationLocations.length+" locations"})):(destinationLocations=[currentTabURL.replace(sourceLocation,destinationLocations[0]).replace(/(https?:\/\/)|(\/)+/g,"$1$2")],browser.pageAction.setPopup({tabId:tabId,popup:""}),browser.pageAction.setTitle({tabId:tabId,title:destinationLocations[0]})));updateIcon(-1,icon,darkThemeEnabled)})}function b64EncodeUnicode(str){return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,function(match,p1){return String.fromCharCode("0x"+p1)}))}function updateIcon(tabId,iconPath,darkMode){if(-1==tabId)return;const request=new XMLHttpRequest;request.onload=(()=>{if("blob"===request.responseType){const reader=new FileReader;reader.onload=(()=>{replaceTabIconWithBase64(tabId,reader.result)}),reader.readAsDataURL(request.response)}else{var svg=darkMode?request.response.replace(/#666666/g,darkFillColor):request.response;svg="data:image/svg+xml;base64,"+b64EncodeUnicode(svg),replaceTabIconWithBase64(tabId,svg)}}),request.open("GET",iconPath,!0),iconPath.startsWith("icons/")||(request.responseType="blob"),request.send()}function replaceTabIconWithBase64(tabId,str){const ctx=document.createElement("canvas").getContext("2d"),img=new Image;img.onload=(()=>{ctx.drawImage(img,0,0,19,19),browser.pageAction.setIcon({tabId:tabId,imageData:ctx.getImageData(0,0,19,19)})}),img.src=str}function getUserPreference(){browser.storage.sync.get(null).then(res=>{if(res.data){let total=res.data.length||0;for(var i=0;i<total;i++){if(!!res.data[i][4])continue;let source=res.data[i][0],target=res.data[i][1],loop=!!res.data[i][2],icon=res.data[i][3]||"icons/default.svg";void 0===userDefinedLocations[source]&&(userDefinedLocations[source]=[]),userDefinedLocations[source].push(target),loop&&(void 0===userDefinedLocations[target]&&(userDefinedLocations[target]=[]),userDefinedLocations[target].push(source),void 0===locationIcons[target]&&(locationIcons[target]=icon)),void 0===locationIcons[source]&&(locationIcons[source]=icon)}}darkThemeEnabled=!!res.darkThemeEnabled,sortEnabled=!!res.sortEnabled,forcePopupEnabled=!!res.forcePopupEnabled})}getUserPreference(),browser.tabs.onUpdated.addListener((tabId,changeInfo)=>{changeInfo.status&&changeInfo.url&&getNextLocation()}),browser.tabs.onActivated.addListener(()=>{getNextLocation()}),browser.pageAction.onClicked.addListener((tab,data)=>{let openInNewTab=!1;1==data.button&&0==data.modifiers.length?openInNewTab=!0:0==data.button&&1==data.modifiers.length&&(data.modifiers.includes("Command")||data.modifiers.includes("Ctrl")||data.modifiers.includes("MacCtrl"))&&(openInNewTab=!0),openInNewTab?browser.tabs.query({currentWindow:!0}).then(tabs=>{let id=!1;for(var index in tabs)if(tabs[index].url==destinationLocations[0]){id=tabs[index].id;break}id?browser.tabs.update(id,{active:!0}).then(()=>{browser.tabs.reload(id,{bypassCache:!0})}):browser.tabs.create({active:!0,url:destinationLocations[0]})}):browser.tabs.update({url:destinationLocations[0]})}),browser.runtime.onMessage.addListener((request,sender,sendResponse)=>{request.action&&"getTabLocations"==request.action&&sendResponse({url:currentTabURL,source:sourceLocation,destinations:destinationLocations,icons:locationIcons,dark:darkThemeEnabled})});