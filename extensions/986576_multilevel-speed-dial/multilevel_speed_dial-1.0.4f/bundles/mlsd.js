!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);const o="_",r="el",i="number",l=0,s=1,d=2,m=3,c=0,a=1,u=2,g=3;var b=function(e){this.type=l,this.number=e},y=b;let f,p,h;function B(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}b.prototype.parseObj=function(e){return new b(e.number)},b.prototype.onClicked=function(e){return!!J(e,[document.getElementById(r+o+this.number),document.getElementById("hdr"+o+this.number),document.getElementById("fico"+o+this.number),document.getElementById("cap"+o+this.number),document.getElementById("mture"+o+this.number),document.getElementById(i+o+this.number)])&&(this.action(),!0)},b.prototype.action=function(){G(this,R.CREATE)},b.prototype.getInitHtml=function(e){e=e||this.number;let t=document.createElement("div");return t.className="element",t.id=r+o+e,t.draggable="true",t},b.prototype.getInnerHtml=function(){let e=document.createElement("div");e.className="elementMiniature",e.id="mture"+o+this.number;let t=document.createElement("label");t.className="elementNumber",t.setAttribute("tag","common"),t.id=i+o+this.number,t.textContent=this.number,e.appendChild(t);let n=document.createDocumentFragment();return n.appendChild(e),n},b.prototype.bindHtml=function(){let e=document.getElementById(r+o+this.number);e.onclick=b.prototype.onClicked.bind(this),e.ondragstart=b.prototype.onDragStart.bind(this),e.ondragenter=b.prototype.onDragEnter.bind(this),e.ondragleave=b.prototype.onDragLeave.bind(this),e.ondragover=b.prototype.onDragOver.bind(this),e.ondrop=b.prototype.onDrop.bind(this)},b.prototype.onDragStart=function(e){if(this.type!=l&&this.type!=m){let t=Array.from(D);t.push(this.number),e.dataTransfer.setData("srcPath",JSON.stringify(t)),e.dataTransfer.setData("",JSON.stringify(t)),e.dataTransfer.effectAllowed="move",h=!1,p=0}},b.prototype.onDragEnter=function(e){e.preventDefault(),++p;let t=Array.from(D);t.push(this.number);let n=B(t,JSON.parse(e.dataTransfer.getData("srcPath")));if(!h&&!n){let t=new Date;f=t.getTime(),h=!0,e.currentTarget.style.borderStyle="dashed"}},b.prototype.onDragLeave=function(e){e.preventDefault(),0==--p&&(h=!1,e.currentTarget.style.borderStyle="solid")},b.prototype.onDragOver=function(e){e.preventDefault(),e.dataTransfer.dropEffect="move";let t=Array.from(D);if(t.push(this.number),!B(t,JSON.parse(e.dataTransfer.getData("srcPath")))&&(this.type==m||this.type==d)){let e=new Date;if(e.getTime()-f>1e3){f=e.getTime(),S[this.type](this).action(),p=0}}},b.prototype.onDrop=function(e){if(e.preventDefault(),this.type!=m){let t=Array.from(D);t.push(this.number),t=t.join("/");let n=JSON.parse(e.dataTransfer.getData("srcPath")),o=n.join("/");if(o.startsWith(t)&&o.length>t.length)e.currentTarget.style.borderStyle="solid",alert(browser.i18n.getMessage("ohnonono"));else{let e=Array.from(D);e.push(this.number),_(n,e)}}};var E=function(e){y.call(this,e),this.caption="",this.icon=null,this.isCaptionHidden=!1,this.isMiniatureHidden=!1};(E.prototype=Object.create(y.prototype)).constructor=E;var I=E;E.prototype.parseObj=function(e){let t=new E(e.number),n=y.prototype.parseObj.call(this,e);return Object.assign(t,n),t.type=e.type,t.caption=e.caption,t.icon=e.icon,t.isCaptionHidden=e.isCaptionHidden,t.isMiniatureHidden=e.isMiniatureHidden,t},E.prototype.getInnerHtml=function(){let e=document.createElement("div");e.className="elementHeader",e.id="hdr"+o+this.number;let t=document.createElement("img");t.id="fico"+o+this.number,t.src=this.icon,e.appendChild(t);let n=document.createElement("label");n.className="elementCaption",n.id="cap"+o+this.number,this.isCaptionHidden||(n.textContent=this.caption),e.appendChild(n);let r=document.createElement("img");r.className="elementButton",r.id="ribtn"+o+this.number,r.src="icons/refresh.svg",e.appendChild(r),r.onclick=function(){this.refresh(0,!1)}.bind(this);let i=document.createElement("img");i.className="elementButton",i.id="editbtn"+o+this.number,i.src="icons/edit.svg",e.appendChild(i),i.onclick=function(){G(this,R.EDIT)}.bind(this);let l=document.createElement("img");l.className="elementButton",l.id="rmvbtn"+o+this.number,l.src="icons/delete.svg",e.appendChild(l),l.onclick=function(){if(confirm(browser.i18n.getMessage("rlyDeleteElement",[this.number,this.caption]))){let e=new y(this.number);$(D,e)}}.bind(this);let s=y.prototype.getInnerHtml.call(this);s.insertBefore(e,s.children[0]);s.getElementById("mture"+o+this.number);return s},E.prototype.refresh=function(e,t){ee(D,this.number)};var k=function(e,t){I.call(this,e),this.type=s,this.url=t,this.icon=null,this.caption=null,this.miniature=null};(k.prototype=Object.create(I.prototype)).constructor=k;var w=k;k.prototype.parseObj=function(e){let t=new k(e.number,e.url),n=I.prototype.parseObj.call(this,e);return Object.assign(t,n),t.miniature=e.miniature,t},k.prototype.action=function(){},k.prototype.getInitHtml=function(){let e=document.createElement("a");return e.className="element",e.id=r+o+this.number,e.href=this.url,e.draggable="true",e},k.prototype.getInnerHtml=function(){let e=I.prototype.getInnerHtml.call(this),t=e.getElementById("hdr"+o+this.number),n=e.getElementById("editbtn"+o+this.number),r=document.createElement("img");return r.className="elementButton",r.id="rdbtn"+o+this.number,r.src="icons/refresh-delayed.svg",t.insertBefore(r,n),r.onclick=function(){this.refresh(3e3,!0)}.bind(this),this.isCaptionHidden||(e.getElementById("cap"+o+this.number).textContent=this.caption),e.getElementById("fico"+o+this.number).src=this.icon,this.isMiniatureHidden||(e.getElementById("mture"+o+this.number).style.backgroundImage="url('"+this.miniature+"')"),e},k.prototype.refresh=function(e,t){let n=Array.from(D);document.getElementById(i+o+this.number).textContent="...",I.prototype.refresh.call(this),Y(this.url,e,t).then(function(e){if(this.caption=e.title||this.caption,this.icon=e.favicon||this.icon,this.miniature=e.screenshot||this.miniature,this.miniature){let e=new Image;const t=this;e.onload=function(){if(e.width>480){const n=480*e.height/e.width;t.miniature=function(e,t,n){let o=document.createElement("img");o.src=e;let r=document.createElement("canvas");return r.width=t,r.height=n,r.getContext("2d").drawImage(o,0,0,t,n),r.toDataURL("image/jpeg",25)}(t.miniature,480,n)}$(n,t)},e.src=this.miniature}}.bind(this),U).then(function(){document.getElementById(i+o+this.number).textContent=this.number}.bind(this))};const v="#f9f9fa",T="#38383d";async function C(){let e;return await browser.storage.local.get(["settings"]).then(function(t){t.settings&&(e=t.settings.darkTheme?T:v)}),e}var L=function(e){y.call(this,e),this.type=m};(L.prototype=Object.create(y.prototype)).constructor=L;var M=L;L.prototype.parseObj=function(e){return new L(e.number)},L.prototype.action=function(){D.pop(),W(te(D))},L.prototype.getInnerHtml=function(){let e=y.prototype.getInnerHtml.call(this),t=e.getElementById(i+o+this.number);return t.setAttribute("tag","backstep"),t.textContent="←",e};var P=function(e,t,n=3,o=3,r=c,i=null,l=""){I.call(this,e),this.type=d,this.caption=t,this.icon="icons/folder.svg",this.rows=n>0?n:1,this.cols=o>0?o:1,this.bgtype=r,this.bgdata=i,this.bgviewstr=l;let s=this.rows*this.cols;this.elements=new Array(s);for(let e=0;e<s-1;++e)this.elements[e]=new y(e+1);this.number>0?this.elements[s-1]=new M(s):this.elements[s-1]=new y(s)};(P.prototype=Object.create(I.prototype)).constructor=P;var A=P;P.prototype.parseObj=function(e){let t=new P(e.number,e.caption,e.rows,e.cols,e.bgtype,e.bgdata,e.bgviewstr),n=I.prototype.parseObj.call(this,e);return Object.assign(t,n),t.elements=e.elements,t},P.prototype.action=function(){D.push(this.number),W(this)},P.prototype.getInnerHtml=function(){let e=I.prototype.getInnerHtml.call(this),t=e.getElementById("hdr"+o+this.number),n=e.getElementById("ribtn"+o+this.number),r=document.createElement("img");if(r.className="elementButton",r.style.width="var(--iconSize)",r.src="data:image/gif;base64,R0lGODlhAQABAPAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==",r.style.cursor="initial",t.insertBefore(r,n),!this.isMiniatureHidden){let t=e.getElementById("mture"+o+this.number);switch(this.bgtype){case c:C().then(function(e){t.style.backgroundColor=e}),t.style.backgroundImage="";break;case a:t.style.backgroundColor=this.bgdata,t.style.backgroundImage="";break;case u:case g:t.style.backgroundColor="",t.style.backgroundImage="url('"+this.bgdata+"')"}}return e};const H={showNumbers:!0,roundCorners:!1,darkTheme:!1,doPageFocus:!0,newTabActive:!0,kbdnavOn:!0};Object.freeze(H),n.d(t,"AssignmentMode",function(){return R}),n.d(t,"ElementFactoryByType",function(){return S}),n.d(t,"currPath",function(){return D}),n.d(t,"initFolderForm",function(){return N}),n.d(t,"updateGridSizeChangedListener",function(){return F}),n.d(t,"onPromiseFailed",function(){return U}),n.d(t,"buildPage",function(){return W}),n.d(t,"swapElements",function(){return _}),n.d(t,"verifyTarget",function(){return J}),n.d(t,"showAssignmentForm",function(){return G}),n.d(t,"readFile",function(){return X}),n.d(t,"getPagePreviewInfo",function(){return Y}),n.d(t,"overwriteElement",function(){return $}),n.d(t,"restoreElement",function(){return ee}),n.d(t,"getFolderByPath",function(){return te}),n.d(t,"remoteImageToBase64",function(){return ne});const R={CREATE:0,EDIT:1};Object.freeze(R);const S={[l]:y.prototype.parseObj,[s]:w.prototype.parseObj,[d]:A.prototype.parseObj,[m]:M.prototype.parseObj};Object.freeze(S);let O,x,D=[],j=!0;function N(e){document.getElementById("gridSizeLabel").textContent=browser.i18n.getMessage("gridSize")+": ",document.getElementById("bgLabel").innerHTML+=browser.i18n.getMessage("background")+":",document.getElementById("defaultBgLabel").innerHTML+=browser.i18n.getMessage("default"),document.getElementById("colorBgLabel").innerHTML+=browser.i18n.getMessage("color")+": ",document.getElementById("imgLocalBgLabel").innerHTML+=browser.i18n.getMessage("imageLocal")+": ",document.getElementById("fakeBgimgPickerBtn").value=browser.i18n.getMessage("browse"),document.getElementById("fakeBgimgPickerLabel").textContent=browser.i18n.getMessage("nofilechosen"),document.getElementById("imgRemoteBgLabel").innerHTML+=browser.i18n.getMessage("imageRemote")+": ";let t=function(){document.getElementById("bgcolorPicker").disabled=!document.getElementById("colorBgRb").checked,document.getElementById("bgimgPicker").disabled=!document.getElementById("imgLocalBgRb").checked,document.getElementById("fakeBgimgPickerBtn").disabled=!document.getElementById("imgLocalBgRb").checked,document.getElementById("bgimgUrlTf").disabled=!document.getElementById("imgRemoteBgRb").checked};document.getElementsByName("bgtype").forEach(function(e){e.oninput=t});let n=document.getElementById("bgimgPicker");document.getElementById("fakeBgimgPickerBtn").onclick=function(){n.click()},n.onchange=function(){n.files.length>0?document.getElementById("fakeBgimgPickerLabel").textContent=n.files[0].name:document.getElementById("fakeBgimgPickerLabel").textContent=browser.i18n.getMessage("nofilechosen")},F(e)}function F(e){let t=function(){const t=document.getElementById("rowsOld").value*document.getElementById("colsOld").value,n=document.getElementById("rowsSpin").value*document.getElementById("colsSpin").value;if(n<t){let o,r=document.getElementById("numberTf");o=e?e.elements:te(D||[]).elements[r.value-1].elements;let i=0,l=0;const m=n-(r?1:0);for(let e=m;e<t;++e)switch(o[e].type){case s:++i;break;case d:++l}if(i+l>0){let e=function(e){const t=browser.i18n.getMessage("@@ui_locale");return t.startsWith("ru")?e%100!=11&&e%10==1?browser.i18n.getMessage("endingCase1"):(e%100<12||e%100>14)&&e%10>=2&&e%10<=4?browser.i18n.getMessage("endingCase2"):browser.i18n.getMessage("endingCase0"):t.startsWith("en")?1==e?"":"s":void 0};const t=e(i),n=e(l);document.getElementById("elemsWillBeLostLabel").textContent=browser.i18n.getMessage("elemsWillBeLost",[m,i,t,l,n]),document.getElementById("elemsWillBeLostLabel").style.display="initial"}else document.getElementById("elemsWillBeLostLabel").textContent="",document.getElementById("elemsWillBeLostLabel").style.display="none"}else document.getElementById("elemsWillBeLostLabel").textContent="",document.getElementById("elemsWillBeLostLabel").style.display="none"};document.getElementsByName("gridSize").forEach(function(e){e.oninput=t})}function U(e){console.log(browser.i18n.getMessage("errMsg")+": "+e)}function W(e){let t=document.getElementById("background");switch(e.bgtype){case c:C().then(function(e){t.style.backgroundColor=e}),t.style.backgroundImage="";break;case a:t.style.backgroundColor=e.bgdata,t.style.backgroundImage="";break;case u:case g:t.style.backgroundColor="",t.style.backgroundImage="url('"+e.bgdata+"')"}let n=document.getElementById("grid");n.innerHTML="";for(let t=0;t<e.rows;++t){let o=n.insertRow(t);for(let n=0;n<e.cols;++n){let r=o.insertCell(n),i=e.cols*t+n+1;r.appendChild(y.prototype.getInitHtml(i)),z(e.elements[i-1])}}let r,l=e.rows*e.cols;for(r=0;l>1;++r)l/=10;window.onresize=function(){let e=document.getElementById(i+o+"1"),t=e.style.display;e.style.display="flex";let n=Math.min(.9*e.offsetWidth/r,e.offsetHeight);document.documentElement.style.setProperty("--numberFontSize",n+"px"),e.style.display=t,Q()},window.onresize()}function z(e){e=function(e){e instanceof y||(e=S[e.type](e));return e}(e);let t=document.getElementById(r+o+e.number),n=t.parentElement;t.remove();let i=e.getInitHtml();i.appendChild(e.getInnerHtml()),n.appendChild(i),e.bindHtml()}function _(e,t){let n=e.pop(),o=t.pop(),r=te(e),i=te(t),l=r.elements[n-1];r.elements[n-1]=i.elements[o-1],i.elements[o-1]=l,r.elements[n-1].number=n,i.elements[o-1].number=o,q(e,D)&&z(r.elements[n-1]),q(t,D)&&z(i.elements[o-1]),browser.storage.local.set({structure:O})}function q(e,t){if(e.length!=t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!=t[n])return!1;return!0}function J(e,t){return e=window.event||e,t.some(function(t){return e.target===t})}function G(e,t){if(window.getSelection().removeAllRanges(),document.getElementById("assignmentForm").reset(),document.getElementById("bgimgBase64").value="",document.getElementById("bgimgPicker").required=!0,document.getElementById("numberTf").value=e.number,document.getElementById("elemsWillBeLostLabel").textContent="",document.getElementById("elemsWillBeLostLabel").style.display="none",document.getElementById("imgLocalBgSpinner").style.display="none",document.getElementById("fakeBgimgPickerLabel").textContent=browser.i18n.getMessage("nofilechosen"),t==R.CREATE)document.getElementById("modeTf").value=R.CREATE,document.getElementById("bookmarkSettings").disabled=!1,document.getElementById("folderSettings").disabled=!0,document.getElementById("bookmarkRb").checked=!0,document.getElementById("defaultBgRb").checked=!0,document.getElementById("bgcolorPicker").disabled=!0,document.getElementById("bgimgPicker").disabled=!0,document.getElementById("fakeBgimgPickerBtn").disabled=!0,document.getElementById("bgimgUrlTf").disabled=!0;else if(t==R.EDIT){if(document.getElementById("modeTf").value=R.EDIT,document.getElementById("bookmarkSettings").disabled=!(document.getElementById("bookmarkRb").checked=e.type==s||e.type==l),document.getElementById("folderSettings").disabled=!(document.getElementById("folderRb").checked=e.type==d),e.type==s)document.getElementById("urlTf").value=e.url,document.getElementById("defaultBgRb").checked=!0,document.getElementById("bgcolorPicker").disabled=!(document.getElementById("colorBgRb").checked=!1),document.getElementById("bgimgPicker").disabled=!(document.getElementById("imgLocalBgRb").checked=!1),document.getElementById("fakeBgimgPickerBtn").disabled=!(document.getElementById("imgLocalBgRb").checked=!1),document.getElementById("bgimgUrlTf").disabled=!(document.getElementById("imgRemoteBgRb").checked=!1);else if(e.type==d)switch(document.getElementById("folderNameTf").value=e.caption,document.getElementById("rowsSpin").value=e.rows,document.getElementById("colsSpin").value=e.cols,document.getElementById("rowsOld").value=e.rows,document.getElementById("colsOld").value=e.cols,document.getElementById("defaultBgRb").checked=e.bgtype==c,document.getElementById("bgcolorPicker").disabled=!(document.getElementById("colorBgRb").checked=e.bgtype==a),document.getElementById("bgimgPicker").disabled=!(document.getElementById("imgLocalBgRb").checked=e.bgtype==u),document.getElementById("fakeBgimgPickerBtn").disabled=!(document.getElementById("imgLocalBgRb").checked=e.bgtype==u),document.getElementById("bgimgUrlTf").disabled=!(document.getElementById("imgRemoteBgRb").checked=e.bgtype==g),e.bgtype){case a:document.getElementById("bgcolorPicker").value=e.bgdata;break;case u:0==e.bgviewstr.length?(document.getElementById("bgimgPicker").required=!0,document.getElementById("bgimgBase64").value=""):(document.getElementById("bgimgPicker").required=!1,document.getElementById("bgimgBase64").value=e.bgdata,document.getElementById("fakeBgimgPickerLabel").textContent=e.bgviewstr);break;case g:0==e.bgviewstr.length?(document.getElementById("bgimgUrlTf").value="",document.getElementById("bgimgUrlTf").required=!0,document.getElementById("bgimgBase64").value=""):(document.getElementById("bgimgUrlTf").value=e.bgviewstr,document.getElementById("bgimgUrlTf").required=!1,document.getElementById("bgimgBase64").value=e.bgdata)}document.getElementById("hideCaptionChb").checked=e.isCaptionHidden,document.getElementById("hideMiniatureChb").checked=e.isMiniatureHidden}if(document.getElementById("curtain").style.display="flex",document.getElementById("background").style.WebkitFilter="contrast(0.25)",Q(),document.getElementById("bookmarkRb").checked)document.getElementById("urlTf").focus();else{if(!document.getElementById("folderRb").checked)throw-1;document.getElementById("folderNameTf").focus()}}function Q(){let e=document.getElementById("assignmentFormContainer");let t=Math.min(window.innerWidth/(e.offsetWidth+8),window.innerHeight/(e.offsetHeight+8));t>1?t=1:t<.75&&(t=.75),document.documentElement.style.setProperty("--assignmentFormScale",t)}function K(){document.getElementById("curtain").style.display="none",document.getElementById("background").style.WebkitFilter=""}function V(e){e.preventDefault(),K(),async function(e){let t=null,n=parseInt(document.getElementById("numberTf").value);if(document.getElementById("bookmarkRb").checked){let e=document.getElementById("urlTf").value;/^https?:\/\//i.test(e)||(e="http:"+(e.startsWith("//")?"":"//")+e),t=new w(n,e)}else{if(!document.getElementById("folderRb").checked)throw-1;{let o,r,i,l=document.getElementById("folderNameTf").value,s=parseInt(document.getElementById("rowsSpin").value),b=parseInt(document.getElementById("colsSpin").value);if(document.getElementById("defaultBgRb").checked)o=c,r=null,i="";else if(document.getElementById("colorBgRb").checked)o=a,r=document.getElementById("bgcolorPicker").value,i="";else if(document.getElementById("imgLocalBgRb").checked){o=u;const e=document.getElementById("bgimgPicker");if(e.files.length>0){let t=e.files[0];document.getElementById("imgLocalBgSpinner").style.display="initial",await X(t,document.getElementById("imgLocalBgSpinner"),!0).then(function(e){r=e},U),i=e.files[0].name}else r=document.getElementById("bgimgBase64").value,i=document.getElementById("fakeBgimgPickerLabel").textContent}else document.getElementById("imgRemoteBgRb").checked&&(o=g,await ne(document.getElementById("bgimgUrlTf").value).then(function(e){r=e},U),i=document.getElementById("bgimgUrlTf").value);if(t=new A(n,l,s,b,o,r,i),e){let e=te(D,O).elements[n-1];if(e.type==d){let n=s*b;const o=Math.min(e.elements.length,n);for(let n=0;n<o;++n)t.elements[n]=e.elements[n];let r=function(e){for(let t=0;t<e.elements.length;++t)if(e.elements[t].type==m)return t;return-1}(t);r>=0&&r+1<n&&(t.elements[r]=new y(r+1)),t.elements[n-1]=new M(n)}}}}return t.isCaptionHidden=document.getElementById("hideCaptionChb").checked,t.isMiniatureHidden=document.getElementById("hideMiniatureChb").checked,t}(+document.getElementById("modeTf").value==R.EDIT).then(function(e){$(D,e),e instanceof w&&e.refresh()})}function X(e,t,n){return new Promise((o,r)=>{let i=new FileReader;i.onloadend=function(){t&&(t.style.display="none"),o&&i.result?o(i.result):r&&r(browser.i18n.getMessage("unableToLoadFile"))},n?i.readAsDataURL(e):i.readAsText(e)})}function Y(e,t,n){return t=t||0,n=n||!1,new Promise((o,r)=>{browser.tabs.create({url:e,active:n}).then(function(e){n||browser.permissions.contains({permissions:["tabHide"]}).then(function(t){t&&browser.tabs.hide(e.id)});let i=!1,l=function(n,s,d){!i&&n==e.id&&s.status&&"complete"==s.status&&(i=!0,browser.tabs.get(n).then(function(e){let n={title:e.title,favicon:e.favIconUrl,screenshot:null};setTimeout(function(){browser.tabs.captureTab(e.id,{format:"jpeg",quality:25}).then(function(e){n.screenshot=e},r).then(function(){browser.tabs.remove(e.id),browser.tabs.onUpdated.removeListener(l),o(n)},function(){r(browser.i18n.getMessage("unableToGetPageInfo"))})},t)},r))};browser.tabs.onUpdated.addListener(l)},r)})}function Z(e){J(e,[document.getElementById("curtain")])&&K()}function $(e,t){let n=Array.from(e);te(n,O).elements[t.number-1]=t,q(n,D)&&z(t),browser.storage.local.set({structure:O})}function ee(e,t){let n=Array.from(e);browser.storage.local.get("structure").then(function(e){let o=te(n,e.structure).elements[t-1];te(n,O).elements[o.number-1]=o,q(n,D)&&z(o)},U)}function te(e,t){let n=t||O;for(let t=0;t<e.length;++t)n=n.elements[e[t]-1];return n}function ne(e){return new Promise((t,n)=>{let o=document.createElement("img");o.onload=function(){let e=function(e){let t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),t.toDataURL("image/jpeg",25)}(o);t(e)},o.onerror=function(){n(browser.i18n.getMessage("unableToLoadFile"))},o.src=e})}window.onload=function(){browser.storage.local.get(["structure","settings"]).then(function(e){!function(e){e.structure?O=e.structure:(O=new A(-1,browser.i18n.getMessage("extensionName")),browser.storage.local.set({structure:O}));x=function(e){let t={};e.settings&&(t=e.settings);let n=!1;for(let e in H)e in t||(t[e]=H[e],n=!0);return n&&browser.storage.local.set({settings:t}),t}(e),document.documentElement.style.setProperty("--elementNumberDisplay",x.showNumbers?"flex":"none"),document.documentElement.style.setProperty("--elementBorderRadius",x.roundCorners?"8px":"2px"),function(e){e?(document.documentElement.style.setProperty("--backgroundColor","var(--grey-70)"),document.documentElement.style.setProperty("--textColor","var(--grey-10)"),document.documentElement.style.setProperty("--inputsColor","var(--grey-60)"),document.documentElement.style.setProperty("--curtainColor","var(--grey-90-a90)"),document.documentElement.style.setProperty("--togglesColor","var(--grey-90-a50)")):(document.documentElement.style.setProperty("--backgroundColor","var(--grey-10)"),document.documentElement.style.setProperty("--textColor","var(--grey-90)"),document.documentElement.style.setProperty("--inputsColor","var(--white-100)"),document.documentElement.style.setProperty("--curtainColor","var(--grey-90-a60)"),document.documentElement.style.setProperty("--togglesColor","var(--grey-90-a10)"))}(x.darkTheme)}(e),j&&W(O)},U),document.getElementById("cellAssignmentTitle").textContent=browser.i18n.getMessage("cellAssignmentTitle")+" - "+browser.i18n.getMessage("extensionName"),document.getElementById("cellNumberLabel").textContent=browser.i18n.getMessage("cellNumber")+":",document.getElementById("cellTypeLabel").textContent=browser.i18n.getMessage("cellType")+":",document.getElementById("bookmarkLabel").innerHTML+=browser.i18n.getMessage("bookmark"),document.getElementById("folderLabel").innerHTML+=browser.i18n.getMessage("folder"),document.getElementById("generalSettingsLabel").textContent=browser.i18n.getMessage("generalSettings"),document.getElementById("hideCaptionLabel").innerHTML+=browser.i18n.getMessage("hideCaption"),document.getElementById("hideMiniatureLabel").innerHTML+=browser.i18n.getMessage("hideMiniature"),document.getElementById("bookmarkSettingsLabel").textContent=browser.i18n.getMessage("bookmarkSettings"),document.getElementById("urlLabel").innerHTML+=browser.i18n.getMessage("url")+": ",document.getElementById("folderSettingsLabel").innerHTML+=browser.i18n.getMessage("folderSettings")+":",document.getElementById("folderNameLabel").innerHTML+=browser.i18n.getMessage("folderName")+": ",document.getElementById("okBtn").value=browser.i18n.getMessage("ok"),document.getElementById("cancelBtn").value=browser.i18n.getMessage("cancel"),document.getElementById("bgimgUrlTf").title=browser.i18n.getMessage("imgUrlRequired"),document.getElementById("assignmentForm").onsubmit=V,document.getElementById("curtain").onclick=Z;let e=function(){if(document.getElementById("bookmarkSettings").disabled=!document.getElementById("bookmarkRb").checked,document.getElementById("folderSettings").disabled=!document.getElementById("folderRb").checked,document.getElementById("bookmarkRb").checked)document.getElementById("urlTf").focus();else{if(!document.getElementById("folderRb").checked)throw-1;document.getElementById("folderNameTf").focus()}};document.getElementsByName("elementType").forEach(function(t){t.oninput=e}),N(),document.getElementById("urlTf").oninput=function(){let e=document.getElementById("urlSuggectionsDL"),t=document.getElementById("urlTf");e.innerHTML="",browser.permissions.contains({permissions:["history"]}).then(function(n){n&&browser.history.search({text:t.value,startTime:0,maxResults:20}).then(function(t){e.innerHTML="";for(let n of t){let t=document.createElement("option");t.value=n.url,e.appendChild(t)}},U)})},document.getElementById("cancelBtn").onclick=K},browser.runtime.onMessage.addListener(function(e,t,n){switch(e.command){case 2:"string"===(typeof e.path).toLowerCase()&&(e.path=e.path.split("/")),e.path=e.path.filter(e=>""!=e);let t=e.folder||te(e.path);D=e.path,j=!1,W(t)}})}]);