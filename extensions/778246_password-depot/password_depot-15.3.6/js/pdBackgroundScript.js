function ApplicationInitDebugPhase(){return Promise.resolve(!0)}function log(){}var Options={set(n){return this.get().then(e=>{for(var t in n)e[t]=n[t];chrome.storage.local.set(e,function(){return!0})})},get(){return new Promise(function(t,e){chrome.storage.local.get({debugUseDevUrl:!1,socketPortNumber:"25109",isAutoFill:!1,ignoredUrls:[]},function(e){t(e)})})}},Emitter={events:[],on:function(e,t){var n=!1;for(event in this.events)event==t&&(n=!0);n||(this.events[t]={},this.events[t].targets=[]),this.events[t].targets.push(e)},emit:function(n,i){var s=null;return this.events[n]?this.events[n].targets.forEach(e=>{var t="_onEvent"+n;e[t]?(e=e[t](i),s=s||e):log("ERROR: emit: target has no method "+t)}):log("ERROR: emit: event is not registered by any target "+n),s}},Messenger={_methodPrefix:"_onMessage_",_receivers:[],_frameIds:[],_promises:[],_registerHandlers(){chrome.runtime.onMessage.addListener(this._onMessage.bind(this)),chrome.runtime.onMessageExternal.addListener(this._onMessage.bind(this))},initialize:function(){this._registerHandlers(),this.addReceiver("Messenger",this),Emitter.on(this,"TabDestroyed")},addReceiver:function(e,t){this._receivers[e]=t},_onEventTabDestroyed:function(e){this._onContextDestroy(e)},_onContextDestroy:function(e){this._promises[e]&&(log("Messenger._onContextDestroy releasing  tab info"+e),delete this._promises[e])},_onMessage:function(e,i,t){var n;if("object"!=typeof e?log(n="Got non-object message",e):e.action?"string"!=typeof e.action&&log(n="Wrong action type",e):log(n="Message has no action",e),n)return t({error:n});var[s,r]=e.action.split("."),o=Promise.resolve();if("self"===s)o=o.then(()=>{new Promise((t,n)=>{chrome.tabs.sendMessage(i.tab.id,Object.assign({},e,{action:r}),{frameId:0},e=>chrome.runtime.lastError?n(chrome.runtime.lastError):e.error?n(e.error):void t(e.data))});return!0});else{var a=this._methodPrefix+r;if(this._receivers[s]?r?this._receivers[s][a]||log(n=`Receiver '${s}' has no method '${r}'`):log(n="Empty method name",e):log(n=`Got no receiver '${s}'`),n)return t({error:n});o=o.then(()=>{i.tab&&(i.tab.frameId=i.tab.frameId||i.frameId);try{return e.data?e.data.cmd=r:e.data={cmd:r},_result=this._receivers[s][a](e.data,i,t)}catch(e){console.log(e)}})}return log(`Messenger._onMessage: receving action '${e.action}'`),o.then(e=>{t({ok:!0,data:e})},e=>{if("object"==typeof e&&e.message)return t({error:e.message});t({error:e})}),!0},sendToMainPage:function(i,e,s,r){return new Promise(function(t,n){chrome.tabs.sendMessage(i,{name:e,action:s,data:r},{frameId:0},function(e){chrome.runtime.lastError?(log("got error "+chrome.runtime.lastError.message+" "+i),n(new Error("Can't send "+s+" to tab "+i))):t(e)})})},sendToFrame:function(i,e,s,r,o){return new Promise(function(t,n){chrome.tabs.sendMessage(i,{name:s,action:r,data:o},{frameId:e},function(e){chrome.runtime.lastError?(log("got error "+chrome.runtime.lastError.message+" "+i),n(new Error("Can't send "+r+" to tab "+i))):t(e)})})},sendToSidebar:function(i,s,e){return new Promise(function(t,n){log("sending "+s+" to Sidebar frameId="+Injector.getSidebarFrameId()),chrome.tabs.sendMessage(i,{action:s,data:e},{frameId:Injector.getSidebarFrameId()},function(e){chrome.runtime.lastError?(log("got error "+chrome.runtime.lastError.message+" "+i),n(new Error("Can't send "+s+" to tab "+i))):t(e)})})},_rememberFramePromise:function(e,t,n){this._promises[e]||(this._promises[e]=[]),this._promises[e][t]=n},getLastFrameResolveMethod(e,t){return this._promises[e][t]},sendToFrameByName:function(i,s,r,o){return new Promise((t,n)=>{this._rememberFramePromise(i,s,t);var e=setInterval(()=>{this._frameIds[i]&&this._frameIds[i][s]&&(clearInterval(e),chrome.tabs.sendMessage(i,{action:r,name:s,data:o},{frameId:this._frameIds[i][s]},e=>chrome.runtime.lastError?n(chrome.runtime.lastError):e.error?(log("got error",e.error),n(new Error(e.error))):t(e)))},200)})},_onMessage_mainScriptReady:function(e,t,n){return Emitter.emit("MainScriptReady",{tabId:t.tab.id,from:t})},_onMessage_newFrame:function(e,t,n){var i=t.tab.id;return this._frameIds[i]||(this._frameIds[i]=[]),this._frameIds[i][e.name]=t.frameId,log("Messenger._onMessage_newFrame: newFrame: "+e.name+" "+t.frameId),"ok-new-frame-"+t.frameId}};Messenger.initialize();let WS_HOST="ws://127.0.0.1";var websocketMgr={_ws:null,_connected:!1,_msgToSend:null,initialize:function(i){try{return this._connected=!1,this.installListenerForPortchange(),new Promise(async(t,n)=>{var e=await Options.get();this._ws||(this._ws=new WebSocket(WS_HOST+":"+e.socketPortNumber)),this._msgToSend=i,this._ws.onopen=()=>this.onOpen(t,n),this._ws.onclose=()=>{this.onClose()},this._ws.onerror=e=>this.onError(e,t,n),this._ws.onmessage=e=>this.onMessage(e)})}catch(e){log(e),this._ws=null}},installListenerForPortchange:function(){chrome.storage.onChanged.addListener((e,t)=>{for(key in e){var n=e[key];"socketPortNumber"==key&&(log('Storage key "%s" in namespace "%s" changed. Old value was "%s", new value is "%s".',key,t,n.oldValue,n.newValue),this._ws&&delete this._ws,this.initialize(this._msgToSend))}})},onOpen:function(e,t){try{log("Socket opened"),this._connected=!0,this._msgToSend&&this.send(this._msgToSend)}catch(e){log(e),this._connected=!1,t(e)}finally{e(!0)}},onClose:function(){log("Socket closed");try{this._connected=!1,delete this._ws}catch(e){console.error(e)}Emitter.emit("ClientCommunicationLoss",{})},onError:function(e,t,n){try{this._connected=!1}catch(e){console.error(e)}n(e)},onMessage:function(e){if(e)try{var t=JSON.parse(e.data);t&&Emitter.emit("WebsocketMessage",t)}catch(e){}},send:function(e){e.clientVersion="V12",this._connected&&this._ws.readyState==this._ws.OPEN?(this._ws.send(JSON.stringify(e)),log("websocketMgr.send:",JSON.stringify(e))):this.initialize(e)}};let TIME_TO_CONNECT=2e3;var nativeMessenger={_port:null,_debug:!0,_timerId:-1,_promise:null,initialize:function(i){this._debug&&log("nativeMessenger.initialize: entering");try{return this._promise=new Promise((e,t)=>{var n;this._port=browser.runtime.connectNative("de.acebit.passworddepot"),this._port?(this._port.onMessage.addListener(e=>this._onMessage(e)),this._port.onDisconnect.addListener(n=()=>this._onDisconnectedInitial(e)),this._timerId=setTimeout(()=>{log("nativeMessenger: port connected"),e(!0),this._port.onDisconnect.removeListener(n),this._port.onDisconnect.addListener(()=>this._onDisconnected()),this.send(i)},TIME_TO_CONNECT)):console.error("initialize: native port is null!!")}),this._promise}catch(e){console.error(e),this._port=null}return this._port},_onMessage:function(e){if(this._debug&&log("nativeMessenger._onMessage: ",e),e)try{"checkState"==e.cmd&&(this._state=e.state),Emitter.emit("NativeMessage",e)}catch(e){console.error(e)}},clear:function(){log("nativeMessenger.clear: client is exiting"),this._port=null},_onDisconnectedInitial:function(e){log("nativeMessenger._onDisconnectedInitial: port disconnected"),this._port=null,clearTimeout(this._timerId),e(!1)},_onDisconnected:function(){log("nativeMessenger._onDisconnected: port disconnected"),this._port=null,Emitter.emit("ClientCommunicationLoss",{})},getPort:function(){return this._port},send:function(e){this._debug&&log("nativeMessenger.send:",e),this._port.postMessage(e)}},DELAY_ACCEPTED=2e3;let ERROR_NATIVEAPP_NORESPONSE=1,COMM_TYPE_SOCKET=0,COMM_TYPE_NATIVEAPP=1,SOCKET_RETRY_TIMER=2e3;var proxyMgr={_activeRequests:[],_debug:!0,_state:"",_commType:-1,_initialMsg:null,_clientVersion:"",initialize:function(e){this._initialMsg=e,this._debug&&log("proxyMgr.initialize: entering"),Messenger.addReceiver("proxyMgr",this),Emitter.on(this,"WebsocketMessage"),Emitter.on(this,"NativeMessage"),Emitter.on(this,"ClientCommunicationLoss"),this.initializeCommunication(e).then(e=>{})},setClientVersion:function(e){log("setClientVersion: "+e),this._clientVersion=e},initializeCommunication:function(t){return log("proxyMgr: initializing communication..."),nativeMessenger.initialize(t).then(e=>e?(this._commType=COMM_TYPE_NATIVEAPP,this.setClientVersion("V11"),!0):websocketMgr.initialize(t).then(e=>(this._commType=COMM_TYPE_SOCKET,this.setClientVersion("V10"),e)).catch(e=>!1))},setState:function(e){this._state=e},send:function(e){switch(this._commType){case COMM_TYPE_NATIVEAPP:nativeMessenger.send(e);break;case COMM_TYPE_SOCKET:websocketMgr.send(e)}},relay:function(i,s){this._debug&&log("proxyMgr.relay:",i);try{var e=Math.pow(2,32),r=Math.floor(Math.random()*e);return new Promise((e,t)=>{var n=setTimeout(()=>{log("relay: DELAY_ACCEPTED exceeded "+DELAY_ACCEPTED),delete this._activeRequests[r],e({error:ERROR_NATIVEAPP_NORESPONSE,msg:"Timeout exceeded for native app response",clientVersion:this._clientVersion}),Emitter.emit("ClientState",{clientState:"dead"})},DELAY_ACCEPTED);this._activeRequests[r]={resolve:e,message:i,timerId:n},i.requestId=r,s&&(i.tabId=s.tab?s.tab.id:"from_popup_html",i.frameId=s.frameId||"from_popup_html"),this.send(i)})}catch(e){log(".relay: EXCEPTION ",e)}},_onEventClientCommunicationLoss:function(e){Emitter.emit("ClientState",{clientState:"dead"}),this.initializeCommunication(this._initialMsg)},_onEventWebsocketMessage:function(t){this._debug&&log("proxyMgr._onEventWebsocketMessage: ",t),"checkState"==t.cmd&&(nativeMessenger.setState(message.state),t.version)&&this.setClientVersion("V12"),chrome.tabs.query({active:!0,currentWindow:!0},e=>{Messenger.sendToMainPage(e[0].id,"pdContentScript",t.cmd,t)})},_onEventWebsocketMessage:function(t){if(this._debug&&log("proxyMgr._onEventWebsocketMessage: ",t),"checkState"==t.cmd){if(t.clientVersion)try{this.setClientVersion("V"+t.clientVersion.substr(0,2))}catch(e){console.log("EXCEPTION: invalid client version",t.clientVersion)}Emitter.emit("ClientState",{clientState:1==t.clientAlive?t.state:"dead"})}this._resolveEvent(t)},_onEventNativeMessage:function(e){this._debug&&log("proxyMgr._onEventNativeMessage: ",e),"checkState"==e.cmd&&Emitter.emit("ClientState",{clientState:1==e.clientAlive?e.state:"dead"}),this._resolveEvent(e)},_resolveEvent:function(e){this._debug&&log("proxyMgr._resolveEvent: ",e.state);try{var t,n;this._activeRequests[e.requestId]?(t=this._activeRequests[e.requestId].resolve,n=this._activeRequests[e.requestId].timerId,clearTimeout(n),t?(e.clientVersion=this._clientVersion,t(e),delete this._activeRequests[e.requestId]):console.error("proxyMgr._resolveEvent: resolve method undefined")):(this._debug&&log("proxyMgr._resolveEvent: unsollicitated:",e),"checkState"!=e.cmd||e.clientAlive||this._commType==COMM_TYPE_NATIVEAPP&&nativeMessenger.clear(),Emitter.emit("ClientMessage",e))}catch(e){console.error("proxyMgr._resolveEvent",e)}},_onMessage_getClientVersion:function(e,t){return log("_onMessage_getClientVersion..."),{version:this._clientVersion}},_onMessage_showPD:function(){return proxyMgr.relay({cmd:"showPD"},null).then(e=>e)}},IconApplicationMgr={_states:new Map,set:async function(e){var t,n,i,s=this._states.get(e.clientState);s?3==chrome.runtime.getManifest().manifest_version?(i=await(await fetch(chrome.runtime.getURL(s))).blob(),i=await createImageBitmap(i),(n=(t=new OffscreenCanvas(i.width,i.height)).getContext("2d")).drawImage(i,0,0),i=n.getImageData(0,0,t.width,t.height),chrome.action.setIcon({imageData:i})):chrome.browserAction.setIcon({path:s},function(){}):log("Weird: can't find an icon for state "+e.clientState)},setIconMap:function(e){this._states=e}},addonMgr={_credential:{},_tmpCredential:{},_tempBrowserPassword:"",_isSingleForm:!1,initialize:function(){proxyMgr.initialize({cmd:"checkState"}),Messenger.addReceiver("addonMgr",this),IconApplicationMgr.setIconMap(new Map([["ready","icons/48.png"],["running","icons/48.png"],["locked","icons/48off.png"],["dead","icons/48off.png"]])),Emitter.on(this,"ClientMessage"),Emitter.on(this,"ClientState"),setInterval(this._checkClientState,3e3)},browserIconClicked:function(){},_onMessage_clearClipboard:function(e,t){setTimeout(()=>{var e=document.createElement("input");e.setAttribute("value"," "),document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)},e.interval)},_onMessage_isIgnoredURL:function(e,t){return proxyMgr.relay(e,t).then(e=>e)},_onMessage_editEntry:function(e){return proxyMgr.relay(e,null).then(e=>e)},_onMessage_genPassword:function(e,t){return proxyMgr.relay(e,t).then(e=>e)},_onMessage_searchEntries:function(e){return proxyMgr.relay(e,null).then(e=>e)},_onMessage_checkState:function(e,t){return proxyMgr.relay(e,t).then(e=>e)},_onMessage_queryURL:function(e,t){return proxyMgr.relay(e,t).then(e=>e)},_onMessage_loadWebForm:function(e,t){return proxyMgr.relay(e,t).then(e=>e)},_onMessage_postWebForm:function(e,t){return log("_onMessage_postWebForm: relaying ",e.xml),proxyMgr.relay(e,t).then(e=>e),!0},_onMessage_ignore:function(e,t){proxyMgr.relay(e,t).then(e=>e)},_onMessage_saveCredential:function(e,t){log("_onSaveCredential"),this._credential[e.stitle]=e},_onMessage_removeCredential:function(e){try{this._credential[e.stitle]&&(this._credential[e.stitle]=null),this._tmpCredential[e.stitle]&&(this._tmpCredential[e.stitle]=null)}catch(e){}},_onMessage_getCredential:function(e){try{return this._credential[e.stitle]?this._credential[e.stitle]:null}catch(e){return null}},_onMessage_saveTmpCredential:function(e){this._tmpCredential[e.stitle]=e},_onMessage_getTmpCredential:function(e){try{return this._tmpCredential[e.stitle]?this._tmpCredential[e.stitle]:null}catch(e){return null}},_onMessage_saveTempBrowserPassword:function(e){this._tempBrowserPassword=e},_onMessage_getTempBrowserPassword:function(){return this._tempBrowserPassword},_onMessage_setSingleForm:function(){this._isSingleForm=!0},_onMessage_getSingleForm:function(){return this._isSingleForm},_onMessage_removeSingleForm:function(){this._isSingleForm=!1},_onMessage_getClientVersion:function(){return proxyMgr._clientVersion},_onEventClientMessage:function(e){"loadWebForm"===e.cmd&&Messenger.sendToFrame(e.tabId,e.frameId,"ContentScript",e.cmd,e)},_onEventClientState:function(e){log("_onEventClientState",e),chrome.runtime.sendMessage({msg:"onClientState",data:{version:proxyMgr._clientVersion,value:e}}),"V12"!=proxyMgr._clientVersion&&"V14"!=proxyMgr._clientVersion?IconApplicationMgr.set({clientState:"ready"}):IconApplicationMgr.set(e)},_checkClientState:function(){log(proxyMgr._clientVersion),"V12"!=proxyMgr._clientVersion&&"V14"!=proxyMgr._clientVersion||proxyMgr.relay({cmd:"checkState"},null).then(e=>{})}};addonMgr.initialize();