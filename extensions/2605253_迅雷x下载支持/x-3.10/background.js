!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=3)}([function(e,t){var n=function(){};function i(e){var t=Date.now();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(t+=performance.now()),"xxxxxxxxxxxxxxx".replace(/[x]/g,function(e){var n=(t+36*Math.random())%36|0;return t=Math.floor(t/36),rc=("x"===e?n:3&n|8).toString(36),Math.random()>.5?rc:rc.toUpperCase()})+e}n.prototype.attachEvent=function(e,t,n,i){if(this[t]||(this[t]=[]),!(this[t]instanceof Array))return!1;for(var r=0;r<this[t].length;r++)if(this[t][r].o==e&&this[t][r].f==n)return!0;return this[t].push({o:e,f:n,t:i}),!0},n.prototype.detachEvent=function(e,t,n){if(!(this[t]&&this[t]instanceof Array))return!1;for(var i=0;i<this[t].length;i++)if(this[t][i].o==e&&this[t][i].f==n)return this[t].splice(i,1),0==this[t].length&&delete this[t],!0;return!1},n.prototype.fireEvent=function(e){if(!(this[e]&&this[e]instanceof Array))return!1;for(var t=[].slice.call(arguments),n=this[e].slice(0),i=!1,r=0;r<n.length&&("number"==typeof n[r].t?n[r].f.delayApply(n[r].t,n[r].o,t.slice(1)):i|=n[r].f.apply(n[r].o,t.slice(1)),!i);r++);return i},e.exports={EventContainer:n,generalWebPeerId:i,getWebPeerId:function(e,t){browser.storage.local.get("__XLWebPeerId__",function(n){if(n&&n.__XLWebPeerId__)t(n.__XLWebPeerId__);else{var r=i(e);browser.storage.local.set({__XLWebPeerId__:r}),t(r)}})},Ajax:function(e){(e=e||{}).data=e.data||{};var t=e.jsonp?jsonp(e):t(e);function t(e){e.type=(e.type||"GET").toUpperCase(),e.data=function(e){var t=[];for(var n in e)t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}(e.data);var t=new XMLHttpRequest;t.onreadystatechange=function(){if(4==t.readyState){var n=t.status;if(n>=200&&n<300){var i="",r=t.getResponseHeader("Content-type");i=-1!==r.indexOf("xml")&&t.responseXML?t.responseXML:-1!==r.toLowerCase().indexOf("application/json")?JSON.parse(t.responseText):t.responseText,e.success&&e.success(i)}else e.error&&e.error(n)}},"GET"==e.type?(e.data.length>0?t.open(e.type,e.url+"?"+e.data,!0):t.open(e.type,e.url,!0),t.send(null)):(t.open(e.type,e.url,!0),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),t.send(e.data))}}}},function(e,t,n){var{EventContainer:i}=n(0);function r(){this.nativePort=null,this.eventContainer=new i,this.selfQuit=!1,this.callbackMap={},this.callbackIdIndex=1}r.prototype={onNativeMessage:function(e){var t=e.callbackId;if(t){var n=this.callbackMap[t];n&&(n.f.apply(n.o,[!0,e.result,e.paramters]),this.callbackMap[t]=void 0)}},onDisconnect:function(){this.selfQuit||(this.nativePort=null),this.eventContainer.fireEvent("OnDisconnect",this.selfQuit)},attachConnectEvent:function(e,t){this.eventContainer.attachEvent(e,"OnConnect",t)},attachDisconnectEvent:function(e,t){this.eventContainer.attachEvent(e,"OnDisconnect",t)},attachNativeMessage:function(e,t){this.eventContainer.attachEvent(e,"OnNativeMessage",t)},postMessage:function(e,t,n,i){if(null!=this.nativePort){var r=void 0;i&&(r=this.callbackIdIndex++);var s={funcName:e,paramters:t,callbackId:r};this.nativePort.postMessage(s),i&&(this.callbackMap[r]={o:n,f:i})}else i&&i.apply(n,[!1])},sendQuit:function(){this.nativePort&&(this.selfQuit=!0,this.postMessage("ChromeQuit",[]),this.nativePort=null)},isConnected:function(){return!!this.nativePort},connect:function(){var e=!1;do{if(this.nativePort){e=!0;break}if(this.nativePort=browser.runtime.connectNative("com.xunlei.thunder"),null==this.nativePort){this.eventContainer.fireEvent("OnConnect",!1);break}var t=this;this.nativePort.onMessage.addListener(function(e){t.onNativeMessage(e)}),this.nativePort.onDisconnect.addListener(function(){t.onDisconnect()}),this.eventContainer.fireEvent("OnConnect",!0),e=!0}while(0);return e}};var s=new r;e.exports={XLNativeMessage:s}},function(e,t,n){var{getWebPeerId:i,Ajax:r}=n(0),{XLNativeMessage:s}=n(1),o=void 0,a=function(e,t,n,i,s,a){var l="http://stat.download.xunlei.com:8099/?xlbtid=1&aid="+e+"&id="+t+"&peerid="+s+"&userid=&referfrom=100001&OS=win&OSversion="+a+"&productname=ThunderX&productversion="+i+"&pluginVersion="+o;n&&n.length>0&&(l+="&"+n),r({url:l,type:"GET",success:function(e){},error:function(e){}})},l=function(e,t,n){var r=s.isConnected();r||s.connect(),s.postMessage("GetThunderInfo",[],void 0,function(r,s,o){if(r){var l=s[0].peerId,c=s[0].osVersion,u=s[0].thunderVersion;a(e,t,n,u,l,c)}else i("Q",function(i){a(e,t,n,"",i,"")})}),r||s.sendQuit()};e.exports={stat:function(e,t,n){o?l(e,t,n):r({url:browser.extension.getURL("manifest.json"),type:"GET",success:function(i){o=i.version,l(e,t,n)},error:function(e){}})}}},function(e,t,n){n(0),n(1),n(2),e.exports=n(4)},function(e,t,n){var{XLNativeMessage:r}=n(1),{stat:s}=n(2);function o(){this.headers={},this.headers["user-agent"]="",this.headers.referer="",this.headers.cookie="",this.headers["content-type"]="",this.headers["content-disposition"]="",this.headers.host="",this.headers["content-length"]=0,this.headers["access-control-allow-origin"]="",this.url="",this.fileName="",this.ext="",this.postData="",this.tabId=void 0}function a(){this.pluginEnabled=!0,this.exception=!1,this.moniterDynamicLinks=!1,this.blackListWebsiteArray,this.blackListPageArray,this.monitorEmule=!1,this.monitorMagnet=!1,this.monitorTradition=!1,this.monitorIE=!1,this.enabledCapture=!0,this.monitorDemains,this.filterDemains,this.monitorFileExts,this.bUseChromeDownloadAPI=!!browser.downloads}a.prototype={MIME_TYPE_ARRAY:["video/x-flv","video/flv","video/mp4","video/x-mp4","video/mpeg","video/f4v","application/octet-stream","video/x-matroska","video/x-webm","audio/x-webm","audio/mp4","video/quicktime","video/x-ms-wmv","audio/webm","video/webm","video/f4f","audio/mpeg","application/vnd.apple.mpegurl","application/x-mpegURL","vnd.apple.mpegURL","application/xml"],SUPPORT_MEDIA_EXT_ARRAY:["swf","mp3","wma","wmv","mpg","wav","flv","f4v","3gp","mp4","rm","rmvb","mpeg","webm","hlv","mkv","ts"],SUPPORT_REQUEST_TYPE_ARRAY:["main_frame","sub_frame","object","xmlhttprequest","other","media"],requestItems:{},blockDownload:!1,tabUrls:{},currentTabId:void 0,bFirefox:!!navigator.userAgent.toUpperCase().indexOf("FIREFOX"),isSupportRequestType:function(e){for(var t in e=e.toLowerCase(),this.SUPPORT_REQUEST_TYPE_ARRAY)if(e===this.SUPPORT_REQUEST_TYPE_ARRAY[t])return!0;return!1},isFrameRequestType:function(e){return"main_frame"===e||"sub_frame"===e},isSupportContentType:function(e){for(var t in e=e.toLowerCase(),this.MIME_TYPE_ARRAY)if(e.toLowerCase()===this.MIME_TYPE_ARRAY[t])return!0;return!1},isSupportMediaExt:function(e){for(var t in e=e.toLowerCase(),this.SUPPORT_MEDIA_EXT_ARRAY)if(e.toLowerCase()===this.SUPPORT_MEDIA_EXT_ARRAY[t])return!0;return!1},getDispositionFileName:function(e){var t=new RegExp("filename[^;=\n]*=((['\"]).*?|[^;\n]*)").exec(e);if(null===t)return"";var n=t[1];return n=(n=n.replace(/"([^"]*)"/g,"$1")).replace("UTF-8''",""),decodeURIComponent(n.replace(/\+/g,""))},getFileNameExt:function(e){var t="";if(e.length>0){var n=e.lastIndexOf(".");-1!==n&&(t=(t=e.substr(n)).toLowerCase())}return t},getUrlFileName:function(e){var t=e.replace(/\?.*$/,"").replace(/.*\//,"");return decodeURIComponent(t)},isValidDownload:function(e){var t="",n=e.headers["content-disposition"];if(n.length>0&&(t=this.getDispositionFileName(n)),0===t.length&&(t=this.getUrlFileName(e.url)),0===t.length)return!1;e.fileName=t;var i=e.headers["content-type"];if(-1!==i.indexOf("text/")&&(-1===i.indexOf("text/multipart")||0===t.length))return!1;var r=this.getFileNameExt(t);return e.ext=r,!!this.canDownload(e)&&this.isMonitorFileExt(r)},updateContextMenu:function(e){browser.contextMenus.update("ThunderContextMenu",{enabled:e})},updataToolbarBadgeText:function(e,t){var n={text:e,tabId:t};browser.browserAction.setBadgeText(n)},updataToolbarTips:function(e,t){var n={title:e,tabId:t};browser.browserAction.setTitle(n)},updateBrowserActionIcon:function(e,t){var n={path:e,tabId:t};browser.browserAction.setIcon(n)},setToolbarEnableStatus:function(e){this.updateBrowserActionIcon("images/icon19_normal.png",e),this.updataToolbarTips("迅雷Firefox支持",e),this.updataToolbarBadgeText("",e)},setToolbarDisableStatus:function(e){this.updateBrowserActionIcon("images/icon19_disabled.png",e),this.updataToolbarTips("迅雷Firefox支持已被禁用",e),this.updataToolbarBadgeText("",e)},setToolbarExceptionStatus:function(){this.updateBrowserActionIcon("images/icon19_normal.png"),this.updataToolbarTips("迅雷Firefox支持出现异常"),this.updataToolbarBadgeText("!")},setToolbarPageDisableStatus:function(e){this.updateBrowserActionIcon("images/icon19_pageDisable.png",e),this.updataToolbarTips("当前页面已禁用迅雷Firefox支持",e),this.updataToolbarBadgeText("",e)},invokeThunder:function(e){var t=e.headers.referer||"";t=(t=(t=(t=(t=(t=(t=(t=t.concat("#@$@#")).concat(1,"#@$@#")).concat(e.url,"#@$@#")).concat(e.fileName,"#@$@#")).concat("","#@$@#")).concat(e.headers.cookie,"#@$@#")).concat("","#@$@#")).concat("","#@$@#"),r.connect(),s(1022,918),r.postMessage("DownLoadByThunder",[t]),r.sendQuit()},downloadByThunder:function(e,t){if(t.headers.referer&&0!==t.headers.referer.length)this.invokeThunder(t);else if(void 0===e||e<0)this.invokeThunder(t);else{var n=this;browser.tabs.executeScript(e,{code:"document.referrer;"},function(i){i||(i=""),Array.isArray(i)&&i.length>0&&(i=i[0]),t.headers.referer=i,0===t.headers.referer.length?browser.tabs.executeScript(e,{code:"document.location.href;"},function(e){e||(e=""),Array.isArray(e)&&e.length>0&&(e=e[0]),t.headers.referer=e,n.invokeThunder(t)}):n.invokeThunder(t)})}},enumTabSetEnabled:function(e){var t=this;browser.tabs.query({active:!0},function(n){if(n)for(var i=0;i<n.length;i++){var r=n[i],s=!t.checkIsWebsiteInUserBlackList(r.url),o=!t.checkIsPageInUserBlackList(r.url);t.setToolbarStatus(t.exception,e,s,o,r.id)}})},setPluginEnabled:function(e){r.connect(),browser.tabs.query({active:!0},function(t){if(t)for(var n=0;n<t.length;n++){var i=t[n];browser.tabs.sendMessage(i.id,{name:"UpdatePluginEnabled",enable:e})}}),this.pluginEnabled=e,this.enumTabSetEnabled(e),this.updateContextMenu(e),r.postMessage("SetPluginEnabled",[e]),r.sendQuit()},setMoniterDynamicLinks:function(e){r.connect(),browser.tabs.query({active:!0},function(t){if(t)for(var n=0;n<t.length;n++){var i=t[n];browser.tabs.sendMessage(i.id,{name:"UpdateMoniterDynamicLinks",enable:e})}}),this.moniterDynamicLinks=e,r.postMessage("SetMoniterDynamicLinks",[e]),r.sendQuit()},onAddBlackListPage:function(e,t,n){e&&t[0].retVal&&(browser.tabs.query({active:!0},e=>{if(e)for(var t=0;t<e.length;t++){var i=e[t];i.url===n[0]&&(browser.tabs.sendMessage(i.id,{name:"UpdatePageEnabled",enable:!1}),this.setToolbarStatus(this.exception,this.pluginEnabled,!0,!1,i.id))}}),this.blackListPageArray[this.blackListPageArray.length]=n[0]),r.sendQuit()},addBlackListPage:function(e,t){for(var n in r.connect(),this.blackListPageArray)if(this.blackListPageArray[n]===e)return;r.postMessage("AddBlackListPage",[e],this,this.onAddBlackListPage)},onRemoveBlackListPage:function(e,t,n){if(e&&t[0].retVal)for(var i in browser.tabs.query({active:!0},e=>{if(e)for(var t=0;t<e.length;t++){var i=e[t];i.url===n[0]&&(browser.tabs.sendMessage(i.id,{name:"UpdatePageEnabled",enable:!0}),this.setToolbarStatus(this.exception,this.pluginEnabled,!0,!0,i.id))}}),this.blackListPageArray)this.blackListPageArray[i]===n[0]&&delete this.blackListPageArray[i];r.sendQuit()},removeBlackListPage:function(e,t){for(var n in r.connect(),this.blackListPageArray)if(this.blackListPageArray[n]===e){r.postMessage("RemoveBlackListPage",[e],this,this.onRemoveBlackListPage);break}},onAddBlackListWebsite:function(e,t,n){e&&t[0].retVal&&(browser.tabs.query({active:!0},e=>{if(e)for(var t=0;t<e.length;t++){var i=e[t];n[0]&&i.url&&0===i.url.toLowerCase().indexOf(n[0].toLowerCase())&&(browser.tabs.sendMessage(i.id,{name:"UpdateWebsiteEnabled",enable:!1}),this.setToolbarStatus(this.exception,this.pluginEnabled,!1,!0,i.id))}}),this.blackListWebsiteArray[this.blackListWebsiteArray.length]=n[0]),r.sendQuit()},addBlackListWebsite:function(e,t){for(var n in r.connect(),this.blackListWebsiteArray)if(this.blackListWebsiteArray[n]===e)return;r.postMessage("AddBlackListWebsite",[e],this,this.onAddBlackListWebsite)},onRemoveBlackListWebsite:function(e,t,n){if(e&&t[0].retVal)for(var i in browser.tabs.query({active:!0},e=>{if(e)for(var t=0;t<e.length;t++){var i=e[t];if(n[0]&&i.url&&0===i.url.toLowerCase().indexOf(n[0].toLowerCase())){browser.tabs.sendMessage(i.id,{name:"UpdateWebsiteEnabled",enable:!0});var r=!this.checkIsPageInUserBlackList(i.url);this.setToolbarStatus(this.exception,this.pluginEnabled,!0,r,i.id)}}}),this.blackListWebsiteArray)this.blackListWebsiteArray[i]===n[0]&&delete this.blackListWebsiteArray[i];r.sendQuit()},removeBlackListWebsite:function(e,t,n,i){for(var s in r.connect(),this.blackListWebsiteArray)if(this.blackListWebsiteArray[s]===e){r.postMessage("RemoveBlackListWebsite",[e],this,this.onRemoveBlackListWebsite);break}},checkIsWebsiteInUserBlackList:function(e){var t=!1;for(var n in this.blackListWebsiteArray)if(0===e.indexOf(this.blackListWebsiteArray[n])){t=!0;break}return t},checkIsPageInUserBlackList:function(e){var t=!1;for(var n in this.blackListPageArray)if(e===this.blackListPageArray[n]){t=!0;break}return t},canDownload:function(e){var t=e.tabId,n=e.url;e.ext;if(!this.pluginEnabled)return!1;if(!this.enabledCapture)return!1;var i="";return i=this.tabUrls[t]&&""!==this.tabUrls[t]?"about:blank"===this.tabUrls[t].toLowerCase()&&e.headers.referer?e.headers.referer||"":this.tabUrls[t]:e.headers.referer||"",!this.checkIsWebsiteInUserBlackList(i)&&(!this.checkIsPageInUserBlackList(i)&&!!this.isMoniterUrl(t,n,i))},isValidUrlAndMonitorProtocol:function(e){if(0===e.length)return!1;var t=e,n=t.indexOf(":");if(-1===n)return!1;var i=t.substr(0,n+1).toUpperCase();if(""===i)return!1;var r=!0;return-1!=="ED2K://".indexOf(i)?!1===this.monitorEmule&&(r=!1):-1!=="MAGNET:?".indexOf(i)?!1===this.monitorMagnet&&(r=!1):-1!=="HTTP://HTTPS://FTP://THUNDER://MMS://MMST://RTSP://RTSPU://XLAPP://".indexOf(i)?!1===this.monitorTradition&&(r=!1):r=!1,r},isMonitorDomain:function(e){if(0===e.length)return!0;var t=new Array,n=this.monitorDemains.split("||");for(var i in n){var r=n[i].slice(2).trimRight("|");t.push(r)}var s=!0,o=e;for(var a in t)if(t[a].length>0&&-1!==o.indexOf(t[a])){s=!1;break}return s},isFilterDomain:function(e){if(0===e.length)return!1;if(0===this.filterDemains.length)return!1;var t=new Array,n=this.filterDemains.split("||");for(var i in n){var r=n[i].slice(2).toLowerCase().trimRight("|");t.push(r)}var s=!1,o=e.toLowerCase();for(var a in t)if(t[a]>0&&-1!==o.indexOf(t[a])){s=!0;break}return s},getExtensionFileName:function(e){var t=e.replace(/(\\+)/g,"#").split("#"),n=t[t.length-1].split(".");return n[n.length-1]},isMonitorFileExt:function(e){var t=!1;return 0!==e.length&&(e=e.toLowerCase(),e+=";",-1!==this.monitorFileExts.indexOf(e)&&(t=!0),t)},isMoniterUrl:function(e,t,n){return 0!==t.length&&(!1!==this.monitorIE&&(!1!==this.isValidUrlAndMonitorProtocol(t)&&(0===n.length&&(n=t),!1!==this.isMonitorDomain(n)&&!this.isFilterDomain(n))))},onIsDownloadURL:function(e,t,n){if(e){if(t[0].retVal){var i=new o;i.url=n[0],i.headers.cookie=n[1],i.headers.referer=n[2],this.invokeThunder(i)}else window.open(n[0]);r.sendQuit()}},onBeforeSendHeaders:function(e){do{if(this.moniterDynamicLinks&&!this.bFirefox)break;if(!this.isSupportRequestType(e.type))break;var t=this.requestItems[e.requestId];t||(t=new o,this.requestItems[e.requestId]=t),t.tabId=e.tabId;var n=e.url;t.url&&0!==t.url.length||(t.url=n);for(var i=0;i<e.requestHeaders.length;++i){var r=e.requestHeaders[i].name.toLowerCase(),s=e.requestHeaders[i].value;switch(r){case"user-agent":t.headers["user-agent"]=s;break;case"referer":t.headers.referer=s;break;case"cookie":t.headers.cookie=s;break;case"content-type":t.headers["content-type"]=s}}}while(0);return{}},onHeadersReceived:function(e){do{if(this.moniterDynamicLinks&&!this.bFirefox)break;var t=e.statusCode;if(t>=300&&t<400&&304!==t)break;if(0===e.statusLine.indexOf("HTTP/1.1 204 Intercepted by the Xunlei Advanced Integration"))break;var n=e.type;if(!this.isSupportRequestType(n))break;var i=e.url,r=this.requestItems[e.requestId];r?delete this.requestItems[e.requestId]:(r=new o).tabId=e.tabId;for(var s=0;s<e.responseHeaders.length;++s){var a=e.responseHeaders[s].name.toLowerCase(),l=e.responseHeaders[s].value;switch(a){case"referer":r.headers.referer=l;break;case"set-cookie":0===r.headers.cookie.length?r.headers.cookie=l:r.headers.cookie=r.headers.cookie+"; "+l;break;case"access-control-allow-origin":originHender="Origin: "+l;break;case"host":r.headers.host=l;break;case"content-disposition":r.headers["content-disposition"]=l;break;case"content-length":r.headers["content-length"]=l;break;case"content-type":r.headers["content-type"]=l}}if(0===i.length&&(i=host),r.url=i,!this.isFrameRequestType(n)){0===r.fileName.length&&(r.fileName=this.getUrlFileName(r.url));var c=this.getFileNameExt(r.fileName);if(0===c.length){var u=this.getUrlFileName(r.url);c=this.getFileNameExt(u)}var d=r.headers["content-type"];if(0===d.length&&!this.isSupportMediaExt(c))break;if(parseInt(r.headers["content-length"])<2052||"swf"===c)break;if(this.isSupportContentType(d))break;break}if(!this.isValidDownload(r))break;if(2!==Math.round(e.statusCode/100)&&"other"===n)break;return this.blockDownload=!0,this.downloadByThunder(e.tabId,r),browser.tabs.query({active:!0},t=>{if(t)for(var n=0;n<t.length;++n){var i=t[n];if("about:blank"===i.url&&i.id===e.tabId){browser.tabs.remove(i.id);break}}}),{redirectUrl:"about:blank"}}while(0);return{}},onTabCreated:function(e){e.url?this.tabUrls[e.id]=e.url:e.openerTabId&&this.tabUrls[e.openerTabId]&&(this.tabUrls[e.id]=this.tabUrls[e.openerTabId])},onTabActivated:function(e){browser.tabs.sendMessage(e.tabId,{name:"OnActivated",tabId:e.tabId}),this.currentTabId=e.tabId},onTabRemoved:function(e,t){e in this.requestItems&&delete this.requestItems[e],e in this.tabUrls&&delete this.tabUrls[e]},onTabUpdated:function(e,t,n){t.url&&(this.tabUrls[e]=t.url)},onQueryAllTabs:function(e){if(e&&e.length>0)for(var t=0;t<e.length;++t)this.tabUrls[e[t].id]=e[t].url},cancelChromeDownload:function(e){browser.downloads.cancel(e.id),browser.downloads.erase({id:e.id},function(e){}),e.url!==e.referrer&&("about:blank"===e.url?browser.tabs.query({active:!0},function(e){if(e)for(var t=0;t<e.length;t++)if(""===e[t].url){browser.tabs.remove(e[t].id);break}}):""!==e.referrer&&browser.tabs.query({url:e.url},function(e){e&&e[0]&&browser.tabs.remove(e[0].id)}))},tryDownload:function(e){do{var t=e.url;e.finalUrl&&(t=e.finalUrl);var n=new o;if(n.url=t,n.headers.referer=e.referrer,!this.canDownload(n))break;if(this.cancelChromeDownload(e),""===e.referrer){this.invokeThunder(n);break}var i=this;browser.tabs.query({url:e.referrer},function(e){e&&e[0]?browser.tabs.sendMessage(e[0].id,{name:"GetCookie"},function(e){var t="";e&&e.cookie&&(t=e.cookie),n.headers.cookie=t,i.invokeThunder(n)}):i.invokeThunder(n)})}while(0)},onDownloadCreated:function(e){do{if("complete"===e.state||"interrupted"===e.state)break;if(this.blockDownload)this.blockDownload=!1,this.cancelChromeDownload(e);else if(this.moniterDynamicLinks&&!this.bFirefox)if(""===e.referrer){var t=this;browser.tabs.query({active:!0},function(n){if(n)for(var i=0;i<n.length;i++){var r=n[i];if(0!==r.url.indexOf("moz-extension://")){e.referrer=r.url,t.tryDownload(e);break}}})}else this.tryDownload(e)}while(0)},registerEventListener:function(){var e=this;browser.runtime.onMessage.addListener(function(t,n,i){if("xl_download"===t.name){var s=new o;s.url=t.link,s.headers.cookie=t.cookie,s.headers.referer=t.referurl,e.invokeThunder(s)}else if("EnabledCapture"===t.name)this.enabledCapture=t.capture;else if("CheckActivated"===t.name)browser.tabs.query({url:t.url},function(e){if(e)for(var t=0;t<e.length;t++){var n=e[t];n.active&&browser.tabs.sendMessage(n.id,{name:"OnActivated",tabId:n.id})}});else if("CheckEnabled"===t.name){var a=e.pluginEnabled,l=!e.checkIsWebsiteInUserBlackList(t.url),c=!e.checkIsPageInUserBlackList(t.url);i({bPlugin:a,bWebsite:l,bPage:c}),t.topFrame&&e.setToolbarStatus(e.exception,e.pluginEnabled,l,c,t.tabId)}else"CheckbMoniterDynamicLinks"===t.name?i({bMoniterDynamicLinks:e.moniterDynamicLinks}):"xl_check_url"===t.name?r.postMessage("IsDownloadURL",[t.link,t.cookie,t.referurl],e,e.onIsDownloadURL):"GetConfig"===t.name&&i({bMonitorEmule:e.monitorEmule,bMonitorMagnet:e.monitorMagnet,bMonitorTradition:e.monitorTradition,bMonitorIE:e.monitorIE,monitorDemains:e.monitorDemains,filterDemains:e.filterDemains,monitorFileExts:e.monitorFileExts})}),this.bUseChromeDownloadAPI&&browser.downloads.onCreated.addListener(function(t){return e.onDownloadCreated(t)}),browser.webRequest&&(browser.webRequest.onHeadersReceived.addListener(function(t){return e.onHeadersReceived(t)},{urls:["<all_urls>"]},["blocking","responseHeaders"]),browser.webRequest.onBeforeSendHeaders.addListener(function(t){return e.onBeforeSendHeaders(t)},{urls:["<all_urls>"]},["blocking","requestHeaders"])),browser.tabs&&(browser.tabs.onCreated.addListener(function(t){return e.onTabCreated(t)}),browser.tabs.onActivated.addListener(function(t){e.onTabActivated(t)}),browser.tabs.onRemoved.addListener(function(t,n){e.onTabRemoved(t,n)}),browser.tabs.onUpdated.addListener(function(t,n,i){e.onTabUpdated(t,n,i)}),browser.tabs.query({},function(t){e.onQueryAllTabs(t)}))},setToolbarStatus:function(e,t,n,i,r){do{if(e){this.setToolbarExceptionStatus();break}if(!t){this.setToolbarDisableStatus(r);break}if(n&&i){this.setToolbarEnableStatus(r);break}this.setToolbarPageDisableStatus(r);break}while(0)},onStartupThunder:function(e,t){var n=this;browser.cookies.getAll({url:e.linkUrl},function(t){var r="";for(i in t)r=r.concat(t[i].name,"=",t[i].value,"; ");var s=new o;s.url=e.linkUrl,s.headers.cookie=r,s.headers.referer=e.pageUrl,n.invokeThunder(s)})},createContextMenu:function(e){var t=this,n={id:"ThunderContextMenu",type:"normal",title:browser.i18n.getMessage("context_title"),contexts:["link"],onclick:function(e,n){t.onStartupThunder(e,n)},enabled:e};browser.contextMenus.create(n,function(){})},onGetMoniterDynamicLinks:function(e,t,n){e&&(this.moniterDynamicLinks=t[0].retVal,s(1022,917,"value1="+(this.moniterDynamicLinks?"1":"0")))},onGetBlackListWebsites:function(e,t,n){e&&(t[0].retVal?this.blackListWebsiteArray=t[1].blackList:this.blackListWebsiteArray=[])},onGetBlackListPages:function(e,t,n){e&&(t[0].retVal?this.blackListPageArray=t[1].blackList:this.blackListPageArray=[])},onGetIsMonitorProtocol:function(e,t,n){e&&t[0].retVal&&("MonitorEmule"===n[0]?this.monitorEmule=t[1].value:"MonitorMagnet"===n[0]?this.monitorMagnet=t[1].value:"MonitorTradition"===n[0]?this.monitorTradition=t[1].value:"MonitorIE"===n[0]&&(this.monitorIE=t[1].value))},onGetFiters:function(e,t,n){e&&(t[0].retVal&&("MonitorDemain"===n[0]?this.monitorDemains=t[1].value:"FilterDemain"===n[0]?this.filterDemains=t[1].value:"MonitorFileExt"===n[0]&&(this.monitorFileExts=t[1].value)),r.sendQuit())},onGetPluginEnabled:function(e,t,n){do{if(!e)break;this.pluginEnabled=t[0].retVal,this.updateContextMenu(this.pluginEnabled),this.pluginEnabled?this.setToolbarEnableStatus():this.setToolbarDisableStatus(),r.postMessage("GetMoniterDynamicLinks",[],this,this.onGetMoniterDynamicLinks),r.postMessage("GetBlackListWebsites",[],this,this.onGetBlackListWebsites),r.postMessage("GetBlackListPages",[],this,this.onGetBlackListPages),r.postMessage("GetIsMonitorProtocol",["MonitorEmule"],this,this.onGetIsMonitorProtocol),r.postMessage("GetIsMonitorProtocol",["MonitorMagnet"],this,this.onGetIsMonitorProtocol),r.postMessage("GetIsMonitorProtocol",["MonitorTradition"],this,this.onGetIsMonitorProtocol),r.postMessage("GetIsMonitorProtocol",["MonitorIE"],this,this.onGetIsMonitorProtocol),r.postMessage("GetFiters",["MonitorDemain"],this,this.onGetFiters),r.postMessage("GetFiters",["FilterDemain"],this,this.onGetFiters),r.postMessage("GetFiters",["MonitorFileExt"],this,this.onGetFiters),s(1022,916,"value1="+(this.pluginEnabled?"1":"0"))}while(0)},feedback:function(){r.connect(),r.postMessage("GetThunderInfo",[],void 0,function(e,t,n){var i="",r="";e&&(i=t[0].peerId,r=t[0].thunderVersion);var s="http://misc-xl9-ssl.xunlei.com/client/view/dist/1.0/feedback.html?version="+r+"&pid="+i;browser.tabs.create({url:s},function(){})}),r.sendQuit()},onDisconnect:function(e){e||(this.pluginEnabled=!1,this.exception=!0,this.setToolbarExceptionStatus(),browser.tabs.query({currentWindow:!0},function(e){for(var t in e)browser.tabs.sendMessage(e[t].id,{name:"UpdatePluginEnabled",enable:this.pluginEnabled})}))},init:function(){r.attachDisconnectEvent(this,this.onDisconnect),r.connect()?r.postMessage("GetPluginEnabled",[],this,this.onGetPluginEnabled):(this.pluginEnabled=!1,this.exception=!0,this.setToolbarExceptionStatus(),s(1022,919)),this.createContextMenu(!1),this.registerEventListener(),s(1022,920)}};var l=new a;l.init(),window.onFeedback=function(){l.feedback()},window.setPluginEnabled=function(e){l.setPluginEnabled(e)},window.setMoniterDynamicLinks=function(e){l.setMoniterDynamicLinks(e)},window.removeBlackListPage=function(e,t){l.removeBlackListPage(e,t)},window.removeBlackListWebsite=function(e,t,n,i){l.removeBlackListWebsite(e,t,n,i)},window.addBlackListPage=function(e,t){l.addBlackListPage(e,t)},window.addBlackListWebsite=function(e,t){l.addBlackListWebsite(e,t)},window.isException=function(){return l.exception},window.isPluginEnabled=function(){return l.pluginEnabled},window.isUseChromeDownloadAPI=function(){return l.bUseChromeDownloadAPI},window.isMoniterDynamicLinks=function(){return l.moniterDynamicLinks},window.checkIsWebsiteInUserBlackList=function(e){return l.checkIsWebsiteInUserBlackList(e)},window.checkIsPageInUserBlackList=function(e){return l.checkIsPageInUserBlackList(e)}}]);
//# sourceMappingURL=background.js.map