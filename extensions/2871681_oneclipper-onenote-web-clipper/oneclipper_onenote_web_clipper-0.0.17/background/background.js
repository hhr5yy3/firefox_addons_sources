var L=chrome.tabs.query.bind(chrome.tabs),l=chrome.storage.sync.get.bind(chrome.storage.sync),p=chrome.storage.sync.set.bind(chrome.storage.sync),pt=chrome.storage.session.get.bind(chrome.storage.session),gt=chrome.storage.session.set.bind(chrome.storage.session);var D=new Set(["webp","avif","heic","heif","svg+xml","tiff"]);async function N(t){try{let e=await fetch(t);if(e.ok)return await e.json();at(e,t.url)}catch(e){console.error(e),g(e)}}async function at(t,e){if(t.status===401)return w();let n=t.headers.get("content-type")==="application/json"?(await t.json()).error:await t.text();t.status>=400&&g(n)}async function I(){let t=`${d}/notebooks?$expand=sections,sectionGroups($expand=sections)&$select=id,displayName`,e=await h(),o=new Request(t,{method:"GET",headers:e}),n=await N(o);if(!n)return;let a=n.value.map(s=>({id:s.id,name:s.displayName})),r={notebooks:a,openNotebook:a[0]?.id};return n.value.forEach(s=>{r[s.id]=s.sections.map(c=>({id:c.id,name:c.displayName}))}),r.lastSectionId=r[a[0]?.id]?.[0]?.id,await setStore(r),a}async function P(t){let e=`${d}/notebooks/${t}/sections?$select=id,displayName`,o=await h(),n=new Request(e,{method:"GET",headers:o}),a=await N(n);if(!a)return;let r=a.value.map(s=>({id:s.id,name:s.displayName}));return setStore({[t]:r,lastSectionId:r[0].id}),r}async function u(t){let e=`${d}/sections/${t}/pages?$select=id,title`,o=await h(),n=new Request(e,{method:"GET",headers:o}),a=await N(n);if(!a)return;let r=a.value;return setStore({[t]:r}),r}async function v(){try{if(await w(),await chrome.storage.local.remove(["openNotebook","lastSectionId","lastPageId"]),(await I()).length===0)return;let{lastSectionId:e}=await getStore("lastSectionId"),o=await u(e);T(o)}catch(t){console.error(t),chrome.runtime.sendMessage({msg:"notifyError",error:t.message})}}var j=async()=>(await chrome.tabs.query({currentWindow:!0,active:!0}))[0];async function B(t){let e=(await l("oneAccounts")).oneAccounts??{},o=btoa(crypto.getRandomValues(new Uint8Array(16))),n=crypto.randomUUID(),a={name:"Account "+(Object.keys(e).length+1),SUN_RAY:n,OAT_KTC:o};e[t]=a,p({oneAccounts:e,openAccountId:t})}async function H(){try{return await chrome.permissions.contains({origins:["https://chatgpt.com/*"]})?!0:(await chrome.runtime.openOptionsPage(),await new Promise(e=>setTimeout(e,1e3)),await chrome.runtime.sendMessage("requestChatGPTPermission"))}catch(t){console.error(t)}}async function F(t){let e=(await getStore(t))[t];if(!e)return;let o=(await getStore("lastSectionId")).lastSectionId;e.forEach(async n=>{let a=await u(n.id);a&&n.id===o&&C(a)})}async function W(t){let e;try{e=await(await fetch(t)).blob()}catch{let n=new URL(t).origin+"/*";await chrome.permissions.contains({origins:[n]})||(await chrome.runtime.openOptionsPage(),await new Promise(r=>setTimeout(r,1e3)),await chrome.runtime.sendMessage("requestHostPermission")),e=await(await fetch(t)).blob()}try{let o=await createImageBitmap(e),n=new OffscreenCanvas(o.width,o.height);return n.getContext("bitmaprenderer").transferFromImageBitmap(o),o.close(),await n.convertToBlob({type:"image/png"})}catch(o){o.stack+=`
Request URL: ${t}
method:convertImageFormat`,console.error(o)}}async function f(t,...e){let o=await j();if(o.url.startsWith("http"))try{return(await chrome.scripting.executeScript({target:{tabId:o.id},func:t,args:e}))[0].result}catch(n){console.warn(n)}}async function K(t,e,o,n){e??=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0].id;let a={tabId:e};n>0&&(a.frameIds=[n]);let r=()=>chrome.scripting.executeScript({target:a,func:t}).catch(s=>console.warn(s));try{await chrome.tabs.sendMessage(e,o)??await r()}catch{await r().catch(c=>console.warn(c))}}async function $(...t){let e=await j();if(e.url.startsWith("http"))try{await chrome.scripting.executeScript({target:{tabId:e.id},files:t})}catch(o){o.message.includes("Extension manifest must request permission")&&(await chrome.runtime.openOptionsPage(),await new Promise(a=>setTimeout(a,1e3)),await chrome.runtime.sendMessage("requestHostPermission")&&await chrome.scripting.executeScript({target:{tabId:e.id},files:t})),console.warn(o)}}async function g(t){t&&(await chrome.runtime.openOptionsPage(),await new Promise(e=>setTimeout(e,1e3)),chrome.runtime.sendMessage({msg:"reportBug",error:{message:t.message,stack:t.stack}}))}async function G(){let{createCropUI:t}=await import(chrome.runtime.getURL("/scripts/screenshot/crop-box.js")),e=await t();document.body.appendChild(e)}async function A(){let t=getSelection();if(t.isCollapsed)return;let e=t.getRangeAt(0),o=new Set(["BLOCKQUOTE","PRE","OL","UL"]),n=e.commonAncestorContainer.nodeType===1?e.commonAncestorContainer:e.commonAncestorContainer.parentElement,a=o.has(n.parentElement.tagName)?n.parentElement.tagName:n.tagName,r=document.createElement(a.toLowerCase());r.appendChild(e.cloneContents()),chrome.runtime.sendMessage({htmlContent:r.outerHTML})}function M(t,e){if(globalThis.toast)return globalThis.toast(t);let o=document.createElement("output");o.id="one-snackbar",o.hidden=!0,document.body.appendChild(o);let n=new CSSStyleSheet;n.insertRule(`#one-snackbar {
        min-width: 20ch;
        font-size: 20px;
        background-color: #333;
        color: rgb(255, 208, 0);
        text-align: center;
        border-radius: 12px;
        padding: 4px 8px;
        position: fixed;
        z-index: 1000;
        margin-inline: auto;
		inset-inline: 0;
        bottom: 20px;
        width: max-content;
        translate: 0 200%;
        animation: in-out 5s ease-out;

		&.error {
			top: 20px;
			bottom: unset;
			background-color: red;
			color: white;
			translate: 0 -200%;
		}
    }`),n.insertRule("@keyframes in-out { 10%, 90% { translate: 0 0; } }"),document.adoptedStyleSheets.push(n),globalThis.toast=(a,r)=>{o.className=r?"error":"",o.hidden=!1,o.innerText=a,setTimeout(()=>o.hidden=!0,5100)},toast(t,e)}async function V(){chrome.contextMenus.create({id:"oneNoteClip",title:i18n("clip_to_onenote"),contexts:["selection","link","image"]}),z("createPage",i18n("create_new_page")),chrome.storage.local.remove("cxtMenuIds").then(async()=>{let t=(await getStore("lastSectionId")).lastSectionId;if(!t)return;let e=(await getStore(t))[t]??await u(t);e&&C(e)})}async function T(t){let{cxtMenuIds:e}=await getStore("cxtMenuIds");if(e&&Array.isArray(e))for(let o of e)chrome.contextMenus.remove(o,()=>chrome.runtime.lastError);await chrome.storage.local.remove("cxtMenuIds"),t&&C(t)}async function C(t){let{cxtMenuIds:e}=await getStore("cxtMenuIds");t.forEach(n=>{e?.includes(n.id)||z(n.id,n.title)});let o=t.map(n=>n.id);await setStore({cxtMenuIds:o})}async function q(t,e){chrome.contextMenus.create({id:t,parentId:"oneNoteClip",title:e.slice(0,24),contexts:["selection","image","link"]},async()=>{if(chrome.runtime.lastError)return console.log(chrome.runtime.lastError.message);let o=(await getStore("cxtMenuIds")).cxtMenuIds??[];o.indexOf(t)===-1||o.push(t),await setStore({cxtMenuIds:o})})}function z(t,e){e&&chrome.contextMenus.create({id:t,parentId:"oneNoteClip",title:e.slice(0,24),contexts:["selection","image","link"]},()=>chrome.runtime.lastError&&console.log(chrome.runtime.lastError))}async function J(t){chrome.contextMenus.remove(t,()=>chrome.runtime.lastError&&console.log(chrome.runtime.lastError))}var k={oneNoteClip:async(t,e)=>{let o=t.menuItemId;if(t.selectionText)setStore({lastPageId:o}),K(A,e,"highlightTxt",t.frameId);else if(t.linkUrl)b(`<a href='${t.linkUrl}'>${t.linkUrl}</a>`,o);else if(t.srcUrl)try{let n=t.srcUrl.split("?")[0],a=n.slice(n.lastIndexOf(".")+1);D.has(a)?await rt(t.srcUrl,o):await b(`<img src='${t.srcUrl}' />`,o),f(M,chrome.i18n.getMessage("image_inserted"))}catch(n){f(M,n.message)}},write_review:(t,e)=>chrome.tabs.create({url:"https://addons.mozilla.org/en-US/firefox/addon/oneclipper-onenote-web-clipper/reviews/",index:e.index+1})};async function rt(t,e){let o=t.split("?")[0],n=o.slice(o.lastIndexOf("/")+1),a=await W(t);if(!a)return f(M,"Failed to fetch image");e==="createPage"?await E(a,n):await U(a,n,e)}var d="https://graph.microsoft.com/v1.0/me/onenote";async function y(t){let e=t.clone();try{let o=await fetch(t);if(o.ok)return await o.text();st(o,e)}catch(o){o.stack+=`
Request URL: ${t.url}`,g(o),console.error(o)}}async function st(t,e){if(t.status===401){let a=await w();return e.headers.set("Authorization","Bearer "+a),fetch(e).catch(r=>console.error(r))}let n=t.headers.get("content-type")==="application/json"?(await t.json()).error:await t.text();if(t.status===404&&n.code==="20102"){let a=new RegExp(/pages\/([^\/]+)/),r=e.url.match(a)?.[1];if(r){J(r);let{lastSectionId:s}=await getStore("lastSectionId");getStore([s]).then(({[s]:i})=>{let m=i.findIndex(S=>S.id===r);m===-1||i.splice(m,1),setStore({[s]:i})}),chrome.runtime.sendMessage({msg:"deletePage",pageId:r}).catch(()=>{});let c=(await L({active:!0,currentWindow:!0}))[0].id;return chrome.tabs.sendMessage(c,{msg:"deletePage",pageId:r}).catch(()=>{})}}t.status>=400&&(n.stack=`
Request url:${e.url}
code:${n.code}`,g(n))}async function w(){let t="https://cloud.oneclipper-firefox.noterail.co/api/get-onenote-token",e="https://oneclipper-deno.deno.dev/api/get-onenote-token",{oneAccounts:o,openAccountId:n}=await l(["oneAccounts","openAccountId"]),a=new Headers({"User-Key":n});try{await fetch(t,{method:"OPTIONS"})}catch{}async function r(){let c=await fetch(t,{headers:a}),i=await c.text();return c.ok&&await s(i),i}async function s(c){o[n].ONT_ACTK=c,o[n].refreshAt=Date.now()+3e6,await p({oneAccounts:o})}try{return await r()}catch{try{return await new Promise(i=>setTimeout(i,500)),await r()}catch(i){if(await new Promise(m=>setTimeout(m,200)),o[n].refreshAt>Date.now())return o[n].ONT_ACTK;console.error(i)}}}async function h(t){let{oneAccounts:e,openAccountId:o}=await l(["oneAccounts","openAccountId"]),{ONT_ACTK:n,refreshAt:a}=e[o],r=Date.now()<a?n:await w(),s=new Headers({Authorization:"Bearer "+r});return t&&s.append("Content-Type",t),s}async function R(t,e,o){e??=(await getStore("lastSectionId")).lastSectionId;let n=`${d}/sections/${e}/pages`,a=await h("text/html"),r=`<html>
		<head>
			<title>${o??new Date().toISOString()}</title>
			<meta name="created" content="${new Date().toISOString()}" />
		</head>
		<body>${t}</body>
  	</html>`,s=new Request(n,{method:"POST",headers:a,body:r}),c=await y(s);return c&&await X(c,e)}async function Y(t,e,o){let n=`${d}/sections/${o}/pages`,a=await h(),r=new Blob([t],{type:"text/html"}),s=new FormData;s.append("Presentation",r),e.forEach((m,S)=>s.append(S,m));let c=new Request(n,{method:"POST",headers:a,body:s}),i=await y(c);return i&&await X(i,o)}async function E(t,e){e??=(await chrome.tabs.query({currentWindow:!0,active:!0}))[0].title;let o=(await getStore("lastSectionId")).lastSectionId;if(!o)return;let n=`<html>
		<head>
			<title>${e}</title>
			<meta name="created" content="${new Date().toISOString()}" />
		</head>
		<body>
    		<img src="name:${e}" alt="screenshot: ${e} "/>
		</body>
  	</html>`;return await Y(n,new Map([[e,t]]),o)}async function Q(t,e){let o=t.slice(t.lastIndexOf("/")+1),n=`<html>
		<head>
			<title>${o}</title>
			<meta name="created" content="${new Date().toISOString()}" />
		</head>
		<body>
    		<img data-render-src="name:${o}" alt="PDF ${o}"/>
		</body>
  	</html>`,a=await(await fetch(t)).blob();return await Y(n,new Map([[o,a]]),e)}async function X(t,e){try{let o=JSON.parse(t),a={id:o.id,title:o.title,path:""},r=(await getStore([e]))[e]??[];return r.push(a),await setStore({[e]:r,lastPage:a,lastPageId:a.id}),q(a.id,a.title),a}catch(o){console.error(o)}}async function b(t,e){if(e==="createPage")return R(t);if(e||=(await getStore("lastPageId")).lastPageId,!e)throw new Error(i18n("pageId_is_missing"));setStore({lastPageId:e});let o=`${d}/pages/${e}/content`,n=await h("application/json"),a=[{target:"body",action:"append",content:t}],r=new Request(o,{method:"PATCH",headers:n,body:JSON.stringify(a)});return await y(r)}async function Z(t,e,o){if(e||=(await getStore("lastPageId")).lastPageId,!e)throw new Error(i18n("pageId_is_missing"));let n=`${d}/pages/${e}/content`,a=await h(),r=[{target:"body",action:"append",content:t}],s=new Blob([JSON.stringify(r)],{type:"application/json"}),c=new FormData;c.append("Presentation",s),o.forEach((m,S)=>c.append(S,m));let i=new Request(n,{method:"PATCH",headers:a,body:c});return await y(i)}async function U(t,e,o){if(o||=(await getStore("lastPageId")).lastPageId,!o)throw new Error(i18n("pageId_is_missing"));let n=`${d}/pages/${o}/content`,a=await h(),r=[{target:"body",action:"append",content:`<img src='name:${e}' alt='' />`}],s=new Blob([JSON.stringify(r)],{type:"application/json"}),c=new FormData;c.append("Commands",s),c.append(e,t);let i=new Request(n,{method:"PATCH",headers:a,body:c});return await y(i)}async function tt(t,e){if(e||=(await getStore("lastPageId")).lastPageId,!e)throw new Error(i18n("pageId_is_missing"));let o=await(await fetch(t)).blob(),n=`${d}/pages/${e}/content`,a=await h(),r=t.slice(t.lastIndexOf("/")+1),s=[{target:"body",action:"append",content:`<img data-render-src='name:${r}' alt='' />`}],c=new Blob([JSON.stringify(s)],{type:"application/json"}),i=new FormData;i.append("Commands",c),i.append(r,o);let m=new Request(n,{method:"PATCH",headers:a,body:i});return await y(m)}async function et(){try{return await chrome.permissions.contains({origins:["<all_urls>"]})?!0:(await chrome.runtime.openOptionsPage(),await new Promise(e=>setTimeout(e,1e3)),await chrome.runtime.sendMessage("requestHostPermission"))}catch(t){console.error(t)}}async function O(t,e,o){if(e.status==="complete"){if(!o.url)return;let n=o.url.split("#",1)[0].slice(8,100);if(!((await getStore(n))[n]!==void 0))return;chrome.scripting.executeScript({target:{tabId:t,allFrames:!0},func:A}).catch(r=>o.url.startsWith("https://chromewebstore.google.com/")||console.error(r))}}var _=class{constructor(e,o,n){this.coordinate=e,this.screenHeight=o,this.tabId=n}async captureVisibleScreen(){try{let e=await chrome.tabs.captureVisibleTab({format:"png"});return await(await fetch(e)).blob()}catch{return await new Promise(o=>setTimeout(o,1e3)),await this.captureVisibleScreen()}}async captureScreenshot(){let e=0,o=this.coordinate,n=o.height,a=new OffscreenCanvas(o.width,o.height),r=a.getContext("2d");for(;n>0;){let s=await this.captureVisibleScreen(),c=Math.min(this.screenHeight,n),i=await createImageBitmap(s,o.x,0,o.width,c);r.drawImage(i,0,e),i.close(),n-=c,e+=c,n>0&&(await chrome.tabs.sendMessage(this.tabId,{msg:"scroll",top:c}),await new Promise(m=>setTimeout(m,100)))}return await a.convertToBlob({type:"image/png"})}async captureViewportShot(){let e=this.coordinate,o=await chrome.tabs.captureVisibleTab({format:"png"}),n=await(await fetch(o)).blob(),a=await createImageBitmap(n,e.x,e.y,e.width,e.height),r=new OffscreenCanvas(e.width,e.height);return r.getContext("bitmaprenderer").transferFromImageBitmap(a),a.close(),await r.convertToBlob({type:"image/png"})}async captureAndUpload({withinViewPort:e,pageId:o}){try{let n=e?await this.captureViewportShot():await this.captureScreenshot(),a=Date.now().toString();return o==="createPage"?await E(n):await U(n,a,o),setStore({lastPageId:o}),"success"}catch(n){console.error(n),g(n)}}};var{version:ct,short_name:it,update_url:mt}=chrome.runtime.getManifest(),ot=!mt;function x(t){if(ot)return console.error(t);let e="https://bug-collector.noterail.workers.dev/collect-bug",o={id:1,extId:chrome.runtime.id,extName:it,extVersion:ct,message:t.message??t.reason,stack:t.stack,browserOs:navigator.userAgent,catchedAt:new Date().toISOString()},n=new Request(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});fetch(n).then(a=>a.text()).then(a=>console.log(a)).catch(a=>console.log(a))}if(!ot){self.addEventListener("error",x),self.addEventListener("unhandledrejection",x);let t={apply:function(o,n,a){return x(a[0]),o.call(n,...a)}};console.error=new Proxy(console.error,t)}globalThis.getStore=chrome.storage.local.get.bind(chrome.storage.local);globalThis.setStore=chrome.storage.local.set.bind(chrome.storage.local);globalThis.i18n=chrome.i18n.getMessage.bind(void 0);var nt={captureShot:(t,e)=>new _(t.coordinate,t.screenHeight,e.tab.id).captureAndUpload(t),switchNotebook:(t,e)=>P(t.notebookId).then(o=>u(o[0].id)),getNoteBookList:()=>I(),getNoteBookSections:t=>P(t.notebookId),getSectionPages:t=>u(t.sectionId),toggle_highlight:t=>t.hightlightOn?chrome.tabs.onUpdated.addListener(O):chrome.tabs.onUpdated.removeListener(O),replacePageCxtMenu:t=>T(t.pages),insert_pdf_file:t=>t.sectionId?Q(t.srcUrl,t.sectionId):tt(t.srcUrl,t.pageId),switchAccount:()=>v()};chrome.runtime.onMessage.addListener((t,e,o)=>{if(t.htmlContent)return(t.sectionId?R(t.htmlContent,t.sectionId,t.pageTitle):t.images?Z(t.htmlContent,t.pageId,t.images):b(t.htmlContent,t.pageId)).then(o).catch(a=>o({errCaused:a.message})),!0;if(nt[t.msg])return nt[t.msg](t,e).then(o).catch(n=>o({errCaused:n.message})),!0;if(t==="checkPermission")return et().then(o).catch(n=>o({errCaused:n.message})),!0;if(t==="chatGpt_permission")return H().then(o).catch(n=>o({errCaused:n.message})),!0;t.error?(t.error.stack+=e.tab.url,x(t.error)):t==="onenote-connected"&&dt()});getStore("hightlightOn").then(({hightlightOn:t})=>{t&&chrome.tabs.onUpdated.addListener(O)});chrome.contextMenus.onClicked.addListener((t,e)=>{k[t.parentMenuItemId]?k[t.parentMenuItemId](t,e.id):k[t.menuItemId](t,e.id)});var lt={screenshot:()=>f(G),clip_article:()=>$("scripts/clip-site/clip-article.js"),multi_select_text:()=>$("scripts/clip-site/manual-clip-site.js")};chrome.commands.onCommand.addListener(t=>lt[t]?.());chrome.runtime.onStartup.addListener(async()=>{let{oneAccounts:t,openAccountId:e}=await l(["oneAccounts","openAccountId"]);if(t[e].UDI_TKN===void 0)return;let{openNotebook:o}=await getStore("openNotebook");o&&(await w(),F(o))});async function dt(){let t=await I(),e=await P(t[0].id);setStore({lastSectionId:e[0].id}),u(e[0].id)}async function ht(t,e,o){if(e.origin==="https://cloud.oneclipper-firefox.noterail.co"){if(t.msg==="setConnectedOnenote"){let{oneAccounts:n,openAccountId:a}=await l(["oneAccounts","openAccountId"]);n[a].UDI_TKN=t.token,await p({oneAccounts:n}),v(),chrome.tabs.remove(e.tab.id),chrome.runtime.sendMessage("onenote-connected").catch(r=>{})}o({success:!0,msg:"authentication success"})}}chrome.runtime.onMessageExternal.addListener(ht);var ut=({reason:t})=>{async function e(){let n=location.origin,a=crypto.randomUUID();setStore({extOrigin:n,extUserId:a,"enableCtrl+Copy":!1,theme:{fontSize:16,fontFamily:"",background:"none",textColor:""}}),p({articleClipType:"full_page",fileNameFormat:"date-pageTitle",OTA_KI:crypto.randomUUID(),VM_CTY:crypto.randomUUID(),TAG_ORE:crypto.randomUUID()});let r=crypto.randomUUID();await B(r),chrome.commands.getAll(async c=>{let i=[];for(let m of c)m.shortcut===""&&i.push(m);i.length===0||await chrome.storage.local.set({missingShortcuts:i}),chrome.tabs.create({url:"/guide/welcome-guide.html"})});let s=`https://cloud.oneclipper-firefox.noterail.co/remove-user-on-uninstall?e=${chrome.runtime.id}&u=${r}&eu=${a}`;chrome.runtime.setUninstallURL(s)}t==="install"&&e(),t==="update"&&o();async function o(){if(chrome.tabs.create({url:"/guide/changelog.html"}),chrome.contextMenus.create({id:"write_review",title:"\u{1F31F} "+chrome.i18n.getMessage("write_review"),contexts:["action"]},()=>chrome.runtime.lastError),(await l("oneAccounts")).oneAccounts)return;let{TAG_ORE:n,onenote:a}=await l(["TAG_ORE","onenote"]);await B(n);let{oneAccounts:r}=await l("oneAccounts"),s=r[n];s&&(s.UDI_TKN=a),p({oneAccounts:r})}V()};chrome.runtime.onInstalled.addListener(ut);export{dt as onOneNoteConnected,ut as setInstallation};
