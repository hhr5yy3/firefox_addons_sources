(()=>{"use strict";function t(t){return document.querySelector(t)}function i(t){return document.querySelectorAll(t)}function e(t,...e){e.forEach((e=>{"string"==typeof e?i(e).forEach((i=>i.classList.add(t))):e.classList.add(t)}))}function s(t,...e){e.forEach((e=>{"string"==typeof e?i(e).forEach((i=>i.classList.remove(t))):e.classList.remove(t)}))}const n=browser;(new class{constructor(){this.resultContent=null,this.winW=window.innerWidth,this.winH=window.innerHeight,this.x1=this.x2=this.winW/2,this.y1=this.y2=this.winH/2,this.mouseX=this.mouseY=null,this.isScanning=!1,this.scroll={top:0,left:0},this.minFactor=.2,this.maxFactor=10,this.numLevel=30,this.distance=(this.maxFactor-this.minFactor)/this.numLevel,this.baseScanSize=this.getBaseScanSize(),this.setScaleLevel(10)}getBaseScanSize(){return Math.min(window.outerWidth,window.outerHeight)/10*1.1}setScaleLevel(t){t<0&&(t=0),t>this.numLevel&&(t=this.numLevel),this.scaleLevel=t;const i=this.minFactor+this.distance*this.scaleLevel;this.scanSize=this.baseScanSize*i}handleKeyUp(t){"Escape"===t.key&&(t.preventDefault(),t.stopPropagation(),this.hide())}handleWindowResize(t){const i=window.innerWidth,e=window.innerHeight,s=(this.x1+this.x2)/2*i/this.winW,n=(this.y1+this.y2)/2*e/this.winH;this.winW=i,this.winH=e;const o=this.baseScanSize;this.baseScanSize=this.getBaseScanSize();const h=this.baseScanSize/o;this.setScaleLevel(this.scaleLevel*h);const a=(this.x2-this.x1)*h/2,r=(this.y2-this.y1)*h/2;this.x1=s-a,this.y1=n-r,this.x2=s+a,this.y2=n+r,this.updateSpotLight()}async initConnection(){return[this.pickerLoaderPort,this.scroll]=await new Promise((t=>{window.onmessage=i=>{"PICKER_SHOW"===i.data?.action&&t([i.ports[0],i.data.scroll])}})),this.pickerLoaderPort?await this.validateSecret()?(this.handleWindowResize(),!0):(console.error("picker frame secret validation failed"),!1):(console.error("picker frame received no port"),!1)}async init(){(window===window.top||await this.initConnection())&&(function(t){const i=t.innerHTML,e={version:n.runtime.getManifest().version};t.parentElement.innerHTML=i.replace(/{{__MSG_(\w+)__}}/g,(function(t,i,s){const o=e[i]||n.i18n.getMessage(i);return i.endsWith("html")?o:o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}))}(t("#template")),this.domMask=t("#mask"),this.domSpotlight=t("#spotlight"),this.domTips=t("#tips"),this.domX=t("#x-mark"),this.domResult=t("#result"),this.updateSpotLight(this.winW/2,this.winH/2),document.addEventListener("keyup",(t=>this.handleKeyUp(t))),window.addEventListener("resize",(t=>this.handleWindowResize(t))),this.domResult.addEventListener("mousedown",(t=>t.stopPropagation())),this.domResult.addEventListener("click",(t=>{t.stopPropagation()})),this.domX.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),this.hide()})),this.domMask.addEventListener("click",(t=>{this.isScanning||(this.isScanning=!0,this.scan())})),this.domMask.addEventListener("mouseenter",(t=>{this.isScanning||(this.mouseX=t.clientX,this.mouseY=t.clientY,this.updateSpotLight(t.clientX,t.clientY))})),this.domMask.addEventListener("mousemove",(t=>{this.isScanning||(this.mouseX=t.clientX,this.mouseY=t.clientY,this.updateSpotLight(t.clientX,t.clientY))})),this.domMask.addEventListener("mouseleave",(t=>{this.isScanning||(this.mouseX=t.clientX,this.mouseY=t.clientY,this.updateSpotLight(0,0,0,0))})),this.domMask.addEventListener("wheel",(t=>{t.preventDefault(),t.stopPropagation(),this.isScanning||(this.setScaleLevel(this.scaleLevel+(t.deltaY>0?-1:1)),this.updateSpotLight(t.clientX,t.clientY,void 0,void 0,".1s"))})),this.domTips.addEventListener("click",(t=>{t.stopPropagation()})),t("#copy-btn").addEventListener("click",(()=>this.copyResult())),t("#rescan-btn").addEventListener("click",(t=>{this.isScanning=!1,e("hidden","#captured"),e("hidden",this.domResult),s("showing-result",this.domMask),this.updateSpotLight(t.clientX,t.clientY)})),t("#open-link-btn").addEventListener("click",(()=>this.hide())))}updateSpotLight(t,i,e,s,n,o,h){this.nextSpotlightState=[t,i,e,s,n,o,h],this.renderSpotlightTimer||(this.renderSpotlightTimer=requestAnimationFrame((()=>this.renderSpotlight())))}renderSpotlight(){if(!this.nextSpotlightState)return;let[t,i,n,o,h,a,r]=this.nextSpotlightState;this.renderSpotlightTimer=this.nextSpotlightState=null,void 0!==t&&void 0!==i&&(void 0!==n&&void 0!==o||(n=o=this.scanSize),this.x1=Math.floor(t-n/2),this.y1=Math.floor(i-o/2),this.x2=Math.floor(this.x1+n),this.y2=Math.floor(this.y1+o));let d=this.hideOrShowUiElements();d=d||this.x1===this.x2&&this.y1===this.y2;const c=d?{x1:0,y1:0,x2:0,y2:0}:{x1:this.x1,x2:this.x2,y1:this.y1,y2:this.y2};d?e("off",this.domSpotlight):s("off",this.domSpotlight),h?(this.domMask.style.transitionDuration=h,this.domMask.style.transitionProperty=a||"all",this.domMask.style.transitionTimingFunction=r||"ease-out"):(this.domMask.style.transitionProperty="",this.domMask.style.transitionDuration="",this.domMask.style.transitionTimingFunction=""),this.domMask.style.backgroundColor="transparent",this.domMask.style.borderTopWidth=Math.max(0,c.y1)+"px",this.domMask.style.borderBottomWidth=Math.max(0,this.winH-c.y2)+"px",this.domMask.style.borderLeftWidth=Math.max(0,c.x1)+"px",this.domMask.style.borderRightWidth=Math.max(0,this.winW-c.x2)+"px"}hideOrShowUiElements(){const t={x:this.mouseX,y:this.mouseY,width:0,height:0},i={x:this.x1,y:this.y1,width:this.x2-this.x1,height:this.y2-this.y1};let e=!1;const s=[this.domTips,this.domX];for(const n of s){const s=n.getBoundingClientRect(),o=this.collides(s,i),h=this.collides(s,t),a=o&&!h;n.style.opacity=a?"0":"1",e=e||h}return e}collides(t,i){const e=t.x,s=t.y,n=t.x+t.width,o=t.y+t.height,h=i.x,a=i.y,r=i.x+i.width,d=i.y+i.height;return!(n<h||r<e||o<a||d<s)}hide(){this.pickerLoaderPort&&this.pickerLoaderPort.postMessage({action:"PICKER_CLOSE"})}copyResult(){if(!this.resultContent)return;let t;t=window===window.top?navigator.clipboard.writeText(this.resultContent):new Promise(((t,i)=>{this.pickerLoaderPort||i(new Error("Connection port is not set"));const e=s=>{const n=s.data?.action;"PICKER_COPY_TEXT_OK"===n&&t(),"PICKER_COPY_TEXT_ERROR"!==n&&"PICKER_COPY_TEXT_OK"!==n||(this.pickerLoaderPort&&this.pickerLoaderPort.removeEventListener("message",e),i(new Error("Copy failed")))};this.pickerLoaderPort.addEventListener("message",e),this.pickerLoaderPort.postMessage({action:"PICKER_COPY_TEXT",text:this.resultContent}),this.pickerLoaderPort.start()})),t.then((()=>{e("hidden","#copy-btn"),s("hidden","#copied-message"),setTimeout((()=>{e("hidden","#copied-message"),s("hidden","#copy-btn")}),2e3)}))}async scan(){let t;e("hidden",this.domResult),e("loading",this.domMask),this.resultContent=null;let i="",o="",h=!1;const a=Math.max(this.x1,0),r=Math.max(this.y1,0),d={x:a,y:r,width:Math.min(this.x2,this.winW)-a,height:Math.min(this.y2,this.winH)-r};try{const e=await n.runtime.sendMessage({action:"BG_CAPTURE",rect:d,scroll:this.scroll,devicePixelRatio:window.devicePixelRatio});h=!e.err,t=e.image,h&&e.result&&e.result.length?this.resultContent=i=e.result[0].content:o=n.i18n.getMessage("unable_to_decode_qr_code")}catch(t){console.error("picker frame error: ",t),o=t?t.toString():"Unknown error"}finally{s("loading",this.domMask)}this.showResult(o,i,t,h)}validateSecret(){const t=new URL(location.href).searchParams.get("secret");return!!t&&n.runtime.sendMessage({action:"BG_VALIDATE_PICKER_SECRET",secret:t})}showResult(i,n,o,h){e("showing-result",this.domMask);const a=t("#result-content");i?(a.innerText="",a.placeholder=i):(a.innerText=n,a.placeholder="");const r=t("#spotlight").getBoundingClientRect(),d=this.domMask.getBoundingClientRect();if(o){const[i,e]=[r.width,r.height],n=.5*d.width,h=.8*d.width,a=.25*d.height,c=.4*d.height,l=i<h?i<n?n/i:1:h/i,p=e<c?e<a?a/e:1:c/e,m=Math.min(l,p),[u,g]=[i*m,e*m];t("#captured").src=o,s("hidden","#captured"),this.updateSpotLight(d.width/2,d.height/2-g/2-.05*d.height,u,g,".2s","all","ease-out")}s("hidden",this.domResult);const c=t("#copy-btn");n?s("hidden",c):e("hidden",c);const l=t("#open-link-btn");/^https?:\/\//i.test(n)?(l.href=n,s("hidden",l)):e("hidden",l),n?a.select():a.focus()}}).init()})();