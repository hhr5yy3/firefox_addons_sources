var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s])}return t};function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)}const TAB_FOCUS_EVENTS={TAB_ACTIVATED:"tabActivated",TAB_UPDATE:"tabUpdated",WINDOW_CHANGE:"windowFocusChange"};class ContentStateHandler{constructor(t){this.store=t,this.queryRequestBuffer={},this.shouldInject=this.shouldInjectScripts(),this.toggleSlider=_.throttle(this.toggleSlider.bind(this),800),webextApi.browserAction.onClicked.addListener(this.toggleSlider),webextApi.tabs.onActivated.addListener(this.onFocusChanged.bind(this,TAB_FOCUS_EVENTS.TAB_ACTIVATED)),webextApi.windows.onFocusChanged.addListener(this.onFocusChanged.bind(this,TAB_FOCUS_EVENTS.WINDOW_CHANGE)),webextApi.tabs.onUpdated.addListener(this.onFocusChanged.bind(this,TAB_FOCUS_EVENTS.TAB_UPDATE)),setTimeout(this.showPinWotPopup.bind(this),ONE_HOUR)}shouldInjectScripts(){var t=this.store.getState();const e=t.firstRunDate;return t.version.isFirstTimeUser&&Date.now()-e<2*ONE_HOUR}handleNextPopupState(t){setTimeout(()=>{this.doHandleNextPopupState(t)},200)}async doHandleNextPopupState(t){var e=await getCurrentTab();const r=e.url,s=e.id;if(!this.isValidPageForContent(r))return this.setSystemPopUpState(s);const o=this.store.getState(),i=o.settings.protection,n=i&&!o.user.isPremiumUser;if(!t&&n&&this.shouldShowSpecialOffer(o))return this.setUpgradePopupState(s);this.setNormalPopupState(s,t,i)}shouldShowSpecialOffer(t){const e=t.remoteConfig.features.specialOffer,r=t.firstRunDate;var s=t.settings.upgradePopUp;const o=s.numberOfShow;if(s.show||!e||!e.enable||!e.options||1!==e.options.length)return!1;const i=e.options[0].promptCycleDays;if(o>=i.length)return!1;return Date.now()-r>i[o]*ONE_DAY}setUpgradePopupState(t){webextApi.browserAction.setBadgeText({text:"1"}),webextApi.browserAction.setPopup({tabId:t,popup:"offering.html"})}setNormalPopupState(t,e,r){const s=r?"":"popup.html";if(webextApi.browserAction.setPopup({tabId:t,popup:s}),e){const t=this.store.getState().settings.upgradePopUp.show;if(webextApi.browserAction.setBadgeText({text:""}),t)return this.store.dispatch(upgradePopUpData({show:!1})),void 0;this.store.dispatch(OptOutPopUp("default"))}}setSystemPopUpState(t){webextApi.browserAction.setPopup({tabId:t,popup:"systempage.html"})}setErrorState(t){webextApi.browserAction.setPopup({tabId:t,popup:"error.html"})}toggleSlider(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";webextApi.tabs.query({active:!0,currentWindow:!0},e=>{if(!e)return;const r=e[0];if(!r)return;const s={action:TOGGLE_WOT_SLIDER};"string"==typeof t&&(s.section=t),webextApi.tabs.sendMessage(r.id,s,t=>{if(webextApi.runtime.lastError||t!==TOGGLE_WOT_SLIDER)return WotApi.reportError({response:t||"no response from tab",tab:r.url,source:"toggle slider"});webextApi.browserAction.setBadgeText({text:""})})})}async showPinWotPopup(){if(this.store.getState().pinWotPopup.popupWasShown)return;var t=await getCurrentTab();const e=t.url,r=t.id;this.isValidPageForContent(e)?webextApi.tabs.sendMessage(r,{action:SHOW_PIN_WOT_POPUP},t=>{t||setTimeout(this.showPinWotPopup.bind(this),ONE_MINUTE)}):setTimeout(this.showPinWotPopup.bind(this),ONE_MINUTE)}async onFocusChanged(t,e,r){if((e="object"==typeof e?e.tabId:e)<0)return;if(t===TAB_FOCUS_EVENTS.TAB_UPDATE&&"complete"!==r.status)return;var s=await getCurrentTab();const o=s.url,i=s.id;if(!i||e!==i)return;if(!this.isValidPageForContent(o))return this.setSystemPopUpState(i);if(!await this.pingToActiveTab(i)){if(!(this.shouldInject&&t!==TAB_FOCUS_EVENTS.TAB_UPDATE))return this.setErrorState(i);await this.injectContentScripts(i,o)}await this.doHandleNextPopupState()}async pingToActiveTab(t){return await new Promise(t=>setTimeout(t,1e3)),new Promise(e=>{try{webextApi.tabs.sendMessage(t,{action:PING},async t=>{webextApi.runtime.lastError&&e(!1),e(t===PONG)})}catch(t){e(!1)}})}isValidPageForContent(t){if(!t||!t.startsWith("http"))return!1;return!["https://chrome.google.com/webstore/","https://microsoftedge.microsoft.com/addons","https://addons.mozilla.org","https://addons.opera.com"].some(e=>t.startsWith(e))&&!/^https?:\/\/localhost/.test(t)}async injectContentScripts(t,e){const r=new Promise(e=>{webextApi.tabs.sendMessage(t,{action:PING},async t=>{if(webextApi.runtime.lastError&&console.log("error in inject",webextApi.runtime.lastError),t===PONG)return e(!0);e(!1)})});if(await r)return Promise.resolve();const s=webextApi.runtime.getManifest(),o=[];for(const t of s.content_scripts)if(this.normalizeRegexp(t.matches).test(e)){for(const e of t.js||[]){if(!e)return;o.push(webextApi.tabs.executeScript({file:e,allFrames:t.all_frames,runAt:t.run_at}))}for(const e of t.css||[]){if(!e)return;o.push(webextApi.tabs.insertCSS({file:e,allFrames:t.all_frames,runAt:t.run_at}))}}return Promise.all(o)}retryQueryData(){webextApi.tabs.query({active:!0,currentWindow:!0},t=>{if(!t)return;const e=t[0];if(!e)return;const r=e.url,s=(new PiFilter).filterAll(r),o={subtrgt:s,sublast:s,subref:"",nt:"retry",atm:["exthead"],epochtime:Date.now(),ch:6,sg:"аc8bb819d",vmt:6,dm:21,vv:1,wp0:1,delta:"AАEAАAAАAАQTCwJQEАAАAАAАAАAАAАAАAАAАAАAАAАA="};this.fetchRating(o)})}extractLinks(t){const e=t.lk;if(!e)return[];try{return Array.from(new Set(JSON.parse(e)[1].data.org.map(t=>getCleanDomain(t.url))))}catch(t){return[]}}fetchRating(t,e){if(!t.subtrgt)return;Object.keys(t).forEach(e=>{const r=t[e];"string"==typeof r&&r.includes("%")&&(t[e]=decodeURIComponent(r))});const r=[getEncodedDomain(t.subtrgt)].concat(_toConsumableArray(this.extractLinks(t))),s=r[0],o=_extends({},t,{target:s,links:r});this.store.dispatch(getRating(o,e))}normalizeRegexp(t){return new RegExp(t.join("|").replace(/\./g,"\\.").replace(/\*/g,".*"))}}