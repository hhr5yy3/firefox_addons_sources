const treeUtil=eagle.utils.tree;class ContextMenu{static open(e){angular.element("html").scope().$broadcast("CONTEXTMENU.OPEN",e)}static close(){angular.element("html").scope().$broadcast("CONTEXTMENU.CLOSE")}}angular.module("contextMenu",["i18n"]).directive("contextMenuItems",()=>({restrict:"E",templateUrl:"js/directives/context-menu-items.html",scope:{menu:"=",activeMenu:"=",searchKeyword:"=",theme:"=theme"},replace:!1,link:(e,t,n)=>{e.toggleItem=e.$parent.toggleItem,e.openItem=e.$parent.openItem,e.openMore=e.$parent.openMore,e.hoverItem=e.$parent.hoverItem,e.sortableOptions=e.$parent.sortableOptions}})).directive("contextMenu",["$timeout",g=>({restrict:"E",templateUrl:"js/directives/context-menu.html",replace:!1,scope:{theme:"=theme"},link:(u,e,t)=>{let n,i,s,a,r="",o=null;u.sortableOptions={distance:10,animation:200,disabled:!1,helper:"clone",update:(e,t)=>{setTimeout(()=>{s&&s(a.items)},1)}};const c=e.find("> .context-menu"),l=e.find("input[type='search']"),d=(l.on("focus",()=>{c.hasClass("open")||f()}),()=>{var e,t;0<u.activeMenu.currentIndex&&(e=u.activeMenu.currentIndex-1,t=u.activeMenu.items[e])&&(u.activeMenu.currentIndex=e,h(t)||d())}),m=()=>{var e,t;u.activeMenu.currentIndex<u.activeMenu.items.length-1&&(e=u.activeMenu.currentIndex+1,t=u.activeMenu.items[e])&&(u.activeMenu.currentIndex=e,h(t)||m())},p=e=>{e?.submenu&&(u.activeMenu=e.submenu,u.activeMenu.currentIndex=0)},h=e=>"toggle"===e.role||!e.role&&!e.disabled,M=e=>{e&&!e?.submenu&&(e?.click&&e.click(e),e?.keepOpen?void 0!==e.checked&&(e.checked=!e.checked):u.close())},v=(n,i)=>{var s=$(window).width(),a=$(window).height(),r=c.width(),o=c.height(),l=u.displayMenu.showSearch?36:0;if(i<5&&(o<34+l||r<90))v(n,i+1);else{let e=windowMouseX+10,t=windowMouseY-10;windowMouseX+r>s&&(e=windowMouseX-r-5),windowMouseY+o>a-20?t=(t=a-o-20)<20?20:t:windowMouseY-56<0&&(t=36),c.css({left:e+"px",top:t+"px"}),i=a-l-t-20,c.find(".context-menu-items").css({maxHeight:i+"px"}),n()}},b=()=>{c.find(".context-menu-items").css("max-height",""),u.searchKeyword="",u.displayMenu={},u.activeMenu=null,c.removeClass("open"),f(),i()},w=()=>{l.focus()},f=()=>{l.blur()};let x=!1;u.$on("CONTEXTMENU.OPEN",(e,t)=>{t.items=t.items.filter(e=>!1!==e.visible),treeUtil.walk(t,"items",function(e,t){e.submenu&&(e.submenu.items=e.submenu.items.filter(e=>!1!==e.visible))}),a=t,u.sortableOptions={distance:10,animation:200,handle:t.sortableHelper?".drag-helper":void 0,disabled:!1,helper:"clone",update:(e,t)=>{setTimeout(()=>{s&&s(a.items)},1)}},u.width=t.width||"auto",u.displayMenu=t,u.displayMenu.currentIndex=-1,u.activeMenu=t,n=t.onOpened||(()=>{}),i=t.onClosed||(()=>{}),s=t.onSorted||(()=>{}),g(()=>{v(()=>{c.addClass("open"),n(),setTimeout(w,50)},0)},50)}),u.$on("CONTEXTMENU.CLOSE",e=>{b()}),Object.assign(u,{searchKeyword:"",menu:null,activeMenu:null,focusSearchInput:w,onSearchKeydown:e=>{var t,n=u?.activeMenu?.currentIndex,i=u?.activeMenu?.items?u.activeMenu.items[n]:null;switch(e.keyCode){case 13:e.preventDefault(),x=!0;break;case 38:e.preventDefault(),d();break;case 40:e.preventDefault(),m();break;case 37:u.activeMenu=a;break;case 39:p(i);break;case 27:e.preventDefault();break;default:u.displayMenu.showSearch||(e.stopPropagation(),e.preventDefault(),r+=String.fromCharCode(e.keyCode).toLowerCase(),clearTimeout(o),o=setTimeout(()=>{r=""},500),0<=(t=u.activeMenu.items.findIndex(e=>e?.label?.toLowerCase().startsWith(r)))&&(u.activeMenu.currentIndex=t))}},onSearchKeyup:e=>{var t=u?.activeMenu?.items[u.activeMenu.currentIndex];switch(e.keyCode){case 32:u.displayMenu.showSearch||(e.preventDefault(),M(t));break;case 13:x&&(M(t),x=!1);break;case 27:e.preventDefault(),b()}},onSearchChange:()=>{u.displayMenu.showSearch&&(""!==u.searchKeyword?(u.displayMenu=(()=>{const n=(t,n)=>{if(t){if(!n)return t;let e=t.filter(e=>{return 0<=(`${e.label??""} `+(e.keywords??"")).toLowerCase().indexOf(n.toLowerCase())});return e=(e=(e=e.filter(e=>!e.role||"toggle"===e.role)).filter(e=>!e.submenu)).filter(e=>!e.disabled)}};let i={items:[],showSearch:!0,currentIndex:0},e=n(a.items,u.searchKeyword);return i.items=[...e],a.items.forEach(t=>{if(t?.submenu?.items){let e=n(t.submenu.items,u.searchKeyword);0<e.length&&(e=0<i.items.length?[{role:"separator"},{role:"label",label:t.label},...e]:[{role:"label",label:t.label},...e],i.items=[...i.items,...e])}}),i.currentIndex=i.items.findIndex(e=>h(e))||0,i})(),u.sortableOptions.disabled=!0):(u.displayMenu=a,u.displayMenu.currentIndex=-1,u.sortableOptions.disabled=!1),u.activeMenu=u.displayMenu)},openItem:M,openMore:e=>{e?.more&&e.more(e)},toggleItem:e=>{e.pinned=!e.pinned,e?.toggle&&e.toggle(e.pinned)},hoverItem:(e,t)=>{t.currentIndex=e,t=(u.activeMenu=t).items[e],p(t)},close:b})}})]).directive("autoPositionContextMenu",["$timeout",n=>({restrict:"A",link:(e,d)=>{var t=()=>{var n=$("#submenu-placeholder").parent();if(n.length){var{top:i,left:s}=n.position(),{top:a,left:r}=n.offset(),o=a+d.height(),l=r+n.outerWidth()+d.outerWidth(),u=$(window).height()-20,c=$(window).width()-20;let e=0,t=0;u<o&&(e=o-u),c<l&&(t=n.outerWidth()+d.outerWidth()),o=i-(e=Math.min(e,a)),c=Math.max(20-r,s+n.outerWidth()-t-4),d.css({opacity:1,top:o+"px",left:c+"px"}),d.find(".context-menu-items").css({maxHeight:u-e+"px"})}};n(t,50),$(window).off("resize.submenu").on("resize.submenu",t)}})]);