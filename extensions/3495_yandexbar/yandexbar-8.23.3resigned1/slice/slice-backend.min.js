var requirejs,require,define;!function(a){function b(a,b){return r.call(a,b)}function c(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=p.map,q=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(a=a.split("/"),g=a.length-1,p.nodeIdCompat&&t.test(a[g])&&(a[g]=a[g].replace(t,"")),a=n.slice(0,n.length-1).concat(a),k=0;k<a.length;k+=1)if("."===(m=a[k]))a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||q)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if((e=o[n.slice(0,l).join("/")])&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&q&&q[d]&&(i=q[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function d(b,c){return function(){var d=s.call(arguments,0);return"string"!=typeof d[0]&&1===d.length&&d.push(null),k.apply(a,d.concat([b,c]))}}function e(a){return function(b){return c(b,a)}}function f(a){return function(b){n[a]=b}}function g(c){if(b(o,c)){var d=o[c];delete o[c],q[c]=!0,j.apply(a,d)}if(!b(n,c)&&!b(q,c))throw new Error("No "+c);return n[c]}function h(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function i(a){return function(){return p&&p.config&&p.config[a]||{}}}var j,k,l,m,n={},o={},p={},q={},r=Object.prototype.hasOwnProperty,s=[].slice,t=/\.js$/;l=function(a,b){var d,f=h(a),i=f[0];return a=f[1],i&&(i=c(i,b),d=g(i)),i?a=d&&d.normalize?d.normalize(a,e(b)):c(a,b):(a=c(a,b),f=h(a),i=f[0],a=f[1],i&&(d=g(i))),{f:i?i+"!"+a:a,n:a,pr:i,p:d}},m={require:function(a){return d(a)},exports:function(a){var b=n[a];return void 0!==b?b:n[a]={}},module:function(a){return{id:a,uri:"",exports:n[a],config:i(a)}}},j=function(c,e,h,i){var j,k,p,r,s,t,u=[],v=typeof h;if(i=i||c,"undefined"===v||"function"===v){for(e=!e.length&&h.length?["require","exports","module"]:e,s=0;s<e.length;s+=1)if(r=l(e[s],i),"require"===(k=r.f))u[s]=m.require(c);else if("exports"===k)u[s]=m.exports(c),t=!0;else if("module"===k)j=u[s]=m.module(c);else if(b(n,k)||b(o,k)||b(q,k))u[s]=g(k);else{if(!r.p)throw new Error(c+" missing "+k);r.p.load(r.n,d(i,!0),f(k),{}),u[s]=n[k]}p=h?h.apply(n[c],u):void 0,c&&(j&&j.exports!==a&&j.exports!==n[c]?n[c]=j.exports:p===a&&t||(n[c]=p))}else c&&(n[c]=h)},requirejs=require=k=function(b,c,d,e,f){if("string"==typeof b)return m[b]?m[b](c):g(l(b,c).f);if(!b.splice){if(p=b,p.deps&&k(p.deps,p.callback),!c)return;c.splice?(b=c,c=d,d=null):b=a}return c=c||function(){},"function"==typeof d&&(d=e,e=f),e?j(a,b,c,d):setTimeout(function(){j(a,b,c,d)},4),k},k.config=function(a){return k(a)},requirejs._defined=n,define=function(a,c,d){if("string"!=typeof a)throw new Error("See almond README: incorrect module build, no module name");c.splice||(d=c,c=[]),b(n,a)||b(o,a)||(o[a]=[a,c,d])},define.amd={jQuery:!0}}(),require.config({baseUrl:"./",paths:{slice:".","browser-adapter":"adapter/adapter",api:"adapter/api/",jade:"common-libs/jade-runtime",react:"common-libs/react.min",jquery:"common-libs/jquery"}}),define("main-adapter",function(){}),define("api/dispatcher",[],function(){function a(){this._observers={}}var b="<empty>";return a.prototype={constructor:a,notify:function(a,c,d){var e=!1,f=this._observers[a||b];return f&&f.forEach(function(b){var f=[c,d];a&&f.unshift(a),b.callback.apply(b.ctx,f)&&(e=!0)}),e},notifyAsync:function(a,b,c){var d=this;setTimeout(function(){d.notify(a,b,c)},1)},addListener:function(a,c,d){return c?(a=a||b,(this._observers[a]=this._observers[a]||[]).push({callback:c,ctx:d||null}),c):null},clear:function(){this._observers={}},removeListener:function(a,c,d){if(a=a||b,c){var e=this._observers[a];e&&(d=d||null,this._observers[a]=e.filter(function(a){return!(a.callback===c&&d==a.ctx)}))}else delete this._observers[a]}},a}),define("browser-adapter",["require","api/dispatcher"],function(a){"use strict";function b(){this._dispatcher=new c,this._bg=null,this._bgApi=null,this._isBackground=null,this._isVisible=null}var c=a("api/dispatcher"),d="__slice_visible_state",e={CHROME:"chrome",YABROWSER:"yabrowser",OPERA:"opera",CHROMIUM:"chromium",FIREFOX:"firefox",userAgent:window.navigator.userAgent,vendor:window.navigator.vendor,appVersion:window.navigator.appVersion,isChrome:function(){return/Google Inc/.test(this.vendor)&&/Chrome/.test(this.userAgent)&&!/MRCHROME|Comodo/.test(this.userAgent)},isYabrowser:function(){return/YaBrowser/.test(this.appVersion)},isOpera:function(){return/OPR\//.test(this.appVersion)},isFirefox:function(){return/Gecko\/[\d.]* Firefox\/[\d.]*/.test(this.userAgent)},get:function(){return this.isFirefox()?this.FIREFOX:this.isOpera()?this.OPERA:this.isYabrowser()?this.YABROWSER:this.isChrome()?this.CHROME:this.CHROMIUM}};return b.prototype={constructor:b,browser:e.get(),adapterType:"chrome",init:function(a){if(this.isUnsupported=!this._isSupport(),this.isUnsupported)return a();this._storageEventHandler=this._storageEventHandler.bind(this),this._helperPlatformListener=this._helperPlatformListener.bind(this),chrome.runtime.getBackgroundPage(this._initializePage.bind(this,a))},_initializePage:function(a,b){b&&(this._bg=b,this._bgApi=this._bg.api,this._isBackground=this._bg===window,this._isVisible=!this._isBackground,chrome.runtime.onMessage.addListener(this._helperPlatformListener),this._isBackground&&this._initBgApi(),a())},_initBgApi:function(){window.addEventListener("storage",this._storageEventHandler),this._bgApi.init(this)},getProductInfo:function(){var a=chrome.runtime.getManifest().version,b=a.split(".");return b&&b.length>2&&(a=b[0]+"."+b[1]),{version:a}},sendMessage:function(a,b,c,d){this.isUnsupported||(c&&d&&(c=c.bind(d)),this._notifyAllInThisContext(a,b,c),this._sendMessageToOtherAdapters(a,b,c))},sendOuterMessage:function(a,b,c,d){this.sendMessage(a,b,c,d)},_sendMessageToOtherAdapters:function(a,b,c){var d={topic:a,data:b,options:this._createMessageOptions()};chrome.runtime.sendMessage(d,c)},_helperPlatformListener:function(a,b,c){if(this._isMessageFromSlice(a)&&!this._isMessageFromSameContext(a)){var d=a.topic||a.message||a,e=a.data;this._notifyAllInThisContext(d,e,c)}},_notifyAllInThisContext:function(a,b,c){this._dispatcher.notifyAsync(a,b,c),this._isBackground&&this._bgApi.notifyNano(a,b,c)},_isMessageFromSlice:function(a){return a&&a.options&&a.options.fromSlice},_isMessageFromSameContext:function(a){return a&&a.options&&a.options.isBackground===this._isBackground},_createMessageOptions:function(){return{fromSlice:!0,isBackground:this._isBackground}},addListener:function(a,b,c){return this._dispatcher.addListener(a,b,c)},removeListener:function(a,b,c){this._dispatcher.removeListener(a,b,c)},notifyAsync:function(a,b,c){this._dispatcher.notifyAsync(a,b,c)},getOption:function(a){return this._bgApi.options.get(a)},setOption:function(a,b){return this._bgApi.options.set(a,b)},getLang:function(){return this._bgApi.i18n.locale},getBrandId:function(){return this._bgApi.branding.getId()},getUI:function(){return this._bgApi.config.getUI()},log:function(a){this._bgApi&&this._bgApi.logger.log(a)},error:function(a){this._bgApi&&this._bgApi.logger.error(a)},logObj:function(a,b){b&&console.log(b+":"),console.log(a)},getCookie:function(a,b,c,d,e,f,g){this._bgApi.cookie.get(a,b,c,d,f,g)},getString:function(a){return this._bgApi.i18n.getString(a)},openSettings:function(){this._bgApi.openSettings()},navigate:function(a,b){this._bgApi.navigate(a,b),e.isFirefox()&&window.setTimeout(function(){window.close()},0)},createXHR:function(){return new this._bg.XMLHttpRequest},resizeWindowTo:function(a,b){},isWindowVisible:function(){return this._isVisible},clear:function(){this._storageEventHandler&&(window.removeEventListener("storage",this._storageEventHandler),this._storageEventHandler=null),this._helperPlatformListener&&(chrome.runtime.onMessage.removeListener(this._helperPlatformListener),this._helperPlatformListener=null,this._isBackground||localStorage.setItem(d,"0"))},initSliceShowEvent:function(){this._isBackground||localStorage.setItem(d,"1")},getNotificationManager:function(){return this._bgApi.notify},getSlicePath:function(){return chrome.extension.getURL("slice/")},getCurrentTabUrl:function(a){this._bgApi.getCurrentTabUrl(a)},isCurrentWindowMinimized:function(a){this._bgApi.isCurrentWindowMinimized(a)},getWebSocket:function(){return this._bg.WebSocket},sendClickerStatistics:function(a){return this._bgApi.sendClickerStatistics(a),!0},setWindowStyle:function(a){},_isSupport:function(){return chrome&&chrome.runtime&&chrome.runtime.getBackgroundPage&&chrome.runtime.onMessage},_storageEventHandler:function(a){if(a.key===d){var b="1"===a.newValue;b!==this._isVisible&&(this._isVisible=b,this.sendMessage("slice-event-"+(b?"show":"hide")))}}},new b}),define("api/messages",["browser-adapter"],function(a){return{addListeners:function(b){if(b&&b.observers)for(var c in b.observers)b.observers.hasOwnProperty(c)&&"function"==typeof b.observers[c]&&a.addListener(c,b.observers[c],b)},removeListeners:function(b){if(b&&b.observers)for(var c in b.observers)b.observers.hasOwnProperty(c)&&"function"==typeof b.observers[c]&&a.removeListener(c,b.observers[c],b)}}}),define("api/manager",["browser-adapter","api/dispatcher","api/messages"],function(a,b,c){var d={};return d.onReady=function(){function e(){function b(){var a=f;f=null,a.notify("ready")}g?window.onload=null:document.removeEventListener("DOMContentLoaded",e,!1),a.init?a.init(b):b()}var f=new b,g=/MSIE\s+8/i.test(navigator.userAgent);return"loading"!==document.readyState?e():g?window.onload=e:document.addEventListener("DOMContentLoaded",e,!1),function(a,b){"function"!=typeof a&&(b=a,a=function(){"function"==typeof this.init&&!1===this.init()||(c.addListeners(this),"function"==typeof this.finalize&&d.onExit(this.finalize,this))}),f?f.addListener("ready",a,b):a.call(b)}}(),d.onExit=function(){function c(){d&&a&&(d.notify("exit"),d=null,a.clear(),a=null)}var d=new b;return window.onunload=c,window.onbeforeunload=c,function(a,b){d&&d.addListener("exit",a,b)}}(),d}),define("api/branding",["browser-adapter"],function(a){function b(){return a.getBrandId()}function c(){return a.browser}function d(){return a.adapterType}function e(){return a.getLang()}function f(a){return a&&"[object RegExp]"===Object.prototype.toString.call(a)}var g={domains:{ya:"yandex.ru",locale:{be:{ya:"yandex.by"},uk:{ya:"yandex.ua"},kk:{ya:"yandex.kz"}}},branding:{tb:{domains:{ya:"yandex.com.tr"}},ua:{domains:{ya:"yandex.ua"}}}},h=null,i={getDomain:function(a){return h||(h={notLocalized:i.brandingObject(g,!0,!1),full:i.brandingObject(g,!0)}),h[a?"full":"notLocalized"].domains.ya},_funcReplaceTLD:function(a,b){return i.getDomain(!!b)},brandingUrl:function(a){return a?a.replace(/\byandex\.\{tld((-kubr)?)\}/,i._funcReplaceTLD):""},brandingObject:function(a,g,h){function j(a,b,c,d,e){var f=a;if(d){if(!a[d])return b;if(f=a[d][e],"string"==typeof f&&(f=a[d][f]),g||delete a[d],!f)return b;f=k(f)}for(var h=Object.keys(f),i=0;i<h.length;++i){var j=h[i];c.hasOwnProperty(j)||o[j]||(c[j]=!0,b[j]=k(f[j]))}return b}function k(a){if("string"==typeof a)return i.brandingUrl(a);if(!a||!l&&!h&&!m||"object"!=typeof a)return a;if(f(a))return a;var b;if(Array.isArray(a)){b=g?[]:a;for(var c=0;c<a.length;++c)b[c]=k(a[c]);return b}var d={};return b=g?{}:a,j(a,b,d,"browser",m),j(a,b,d,"adapter",n),j(a,b,d,"branding",l),j(a,b,d,"locale",h),j(a,b,d)}var l=b();!1!==h&&(h=h||e());var m=c(),n=d(),o={browser:!0,locale:!0,branding:!0,adapter:!0};return k(a)}};return i}),define("api/stat",["browser-adapter"],function(a){function b(b){a.log("[api/stat]: "+b)}return{_statName:null,log:function(c){if(!a.sendClickerStatistics({cid:c.cid,param:c.param,statisticsId:this._statName})){var d=c.dtype,e=c.pid,f=c.cid,g=c.param;if(void 0===d&&(d="stred"),void 0===e&&(e=12),"string"!=typeof d)throw new TypeError("Invalid dtype type ('"+typeof d+"')");if(!d)throw new RangeError("dtype is empty string");if("number"!=typeof e)throw new TypeError("Wrong pid type ('"+typeof e+"'). Number required.");if(e<0)throw new RangeError("Invalid pid value ("+e+")");if("number"!=typeof f)throw new TypeError("Wrong cid type ('"+typeof f+"'). Number required.");if(f<=0)throw new RangeError("Invalid cid value ("+f+")");var h=a.getProductInfo();g=a.browser+"."+this._statName+"."+(h?h.version.replace(/\./g,"-")+".":"")+g;var i="https://clck.yandex.ru/click/dtype="+encodeURIComponent(d)+"/pid="+e+"/cid="+f+"/path="+encodeURIComponent(g),j="",k=["dtype","pid","cid","param"];for(var l in c)if(c.hasOwnProperty(l)&&-1===k.indexOf(l)){var m=c[l];"*"!==l?i+="/"+l+"="+encodeURIComponent(m):j=m}i+="/*"+j,b("stat log "+i);var n=a.createXHR();n.open("GET",i,!0),n.send()}},logWidget:function(a){this.log({cid:72359,param:a})},logNotification:function(a){this.log({cid:72358,param:a})},setStatName:function(a){this._statName=a||null}}}),define("slice/locale",[],function(){return{be:{addmail:"Далучыць іншую скрыню","addmail.desc":"вы заўсёды зможаце ў наладах пошты",attach:"З укладаннем",continuewm:"Працягваць работу з поштай",create:"Напісаць",delete:"Выдаліць","error.net":"Няма далучэння да інтэрнета","error.refresh":"Падчас абнаўлення адбылася памылка","ft.unread":"Непрачытаныя",login_other:"Увайсці ў іншую паштовую скрыню",logo:"Яндекс.Пошта",logout:"Выхад",logout_all:"Выйсці з усіх скрыняў","mail.wait":"Секундачку...",mails:"Далучаныя паштовыя скрыні","month.g1":"студзеня","month.g10":"кастрычніка","month.g11":"лістапада","month.g12":"снежня","month.g2":"лютага","month.g3":"сакавіка","month.g4":"красавіка","month.g5":"траўня","month.g6":"чэрвеня","month.g7":"ліпеня","month.g8":"жніўня","month.g9":"верасня",nounread:"Новых лістоў няма",refresh:"Абнавіць",retry:"Паспрабуйце яшчэ раз",setreaded:"Пазначыць як прачытанае",settings:"Наладкі віджэта",spam:"Пазначыць як спам",total:"усяго <i18n:param>count</i18n:param>","tt.create":"Напісаць новы ліст","tt.logo":"Перайсці ў Я.Пошту","tt.refresh":"Абнавіць спіс лістоў",wait:"Секундачку...",inbox:"Уваходныя",markasread:"Прачытана",markasspam:"Гэта спам!",reply:"Адказаць","new-messages-plural":"{N} новае паведамленне;{N} новыя паведамленні;{N} новых паведамленняў",hide:"Скрыть",show:"Показать",login:"Увайсці",logout1:"Выйсці"},en:{addmail:"You can always add another mailbox","addmail.desc":"in the mail settings menu",attach:"With attachment",continuewm:"Continue managing your mail",create:"Compose",delete:"Remove","error.net":"No internet connection","error.refresh":"An error occurred while updating","ft.unread":"Unread",login_other:"Log in to another account",logo:"Yandex.Mail",logout:"Log out",logout_all:"Log out of all mail accounts","mail.wait":"Just a sec...",mails:"Mailboxes","month.g1":"January","month.g10":"October","month.g11":"November","month.g12":"December","month.g2":"February","month.g3":"March","month.g4":"April","month.g5":"May","month.g6":"June","month.g7":"July","month.g8":"August","month.g9":"September",nounread:"You have no new messages",refresh:"Update",retry:"Try again",setreaded:"Mark as read",settings:"Widget settings",spam:"Mark as spam",total:"<i18n:param>count</i18n:param> in total","tt.create":"Compose message","tt.logo":"Go to Yandex.Mail","tt.refresh":"Refresh message list",wait:"Please wait...",inbox:"Inbox",markasread:"Mark as read",markasspam:"Spam!",reply:"Reply","new-messages-plural":"{N} new message;{N} new messages;{N} new messages",hide:"Скрыть",show:"Показать",login:"Log in",logout1:"Log out"},kk:{addmail:"Басқа жәшікті қосу","addmail.desc":"сіз әрдайым пошта баптауларынан таба аласыз",attach:"Тіркемелері бар",continuewm:"Поштамен жұмысты жалғастыру",create:"Жазу",delete:"Жою","error.net":"Интернетке қосылыс жоқ","error.refresh":"Жаңарту барысында қате кетті","ft.unread":"Оқылмағандар",login_other:"Басқа пошта жәшігіне кіру",logo:"Яндекс.Пошта",logout:"Шығу",logout_all:"Барлық жәшіктен шығу","mail.wait":"Бір сәт күтіңіз...",mails:"Кірістірілген пошта жәшіктері","month.g1":"қаңтар","month.g10":"қазан","month.g11":"қараша","month.g12":"желтоқсан","month.g2":"ақпан","month.g3":"наурыз","month.g4":"сәуір","month.g5":"мамыр","month.g6":"маусым","month.g7":"шілде","month.g8":"тамыз","month.g9":"қыркүйек",nounread:"Жаңа хат жоқ",refresh:"Жаңарту",retry:"Тағы сынап көріңіз",setreaded:"Оқылған деп белгілеу",settings:"Виджеттің баптаулары",spam:"Спам деп белгілеу",total:"барлығы <i18n:param>count</i18n:param>","tt.create":"Жаңа хат жазу","tt.logo":"Я.Поштаға өту","tt.refresh":"Хаттар тізімін жаңарту",wait:"Бір сәт күтіңіз...",inbox:"Кіріс",markasread:"Оқылған",markasspam:"Бұл спам!",reply:"Жауап беру","new-messages-plural":"{N} жаңа хабарлама;{N} жаңа хабарлама;{N} жаңа хабарлама",hide:"Скрыть",show:"Показать",login:"Войти",logout1:"Выйти"},ru:{addmail:"Подключить другой ящик","addmail.desc":"вы всегда сможете в настройках почты",attach:"С вложением",continuewm:"Продолжить работу с почтой",create:"Написать",delete:"Удалить",reply:"Ответить","error.net":"Нет подключения к интернету","error.refresh":"При обновлении произошла ошибка","ft.unread":"Непрочитанные",login_other:"Войти в другой почтовый ящик",logo:"Яндекс.Почта",logout:"Выход",logout_all:"Выйти из всех ящиков","mail.wait":"Секундочку...",mails:"Подключенные почтовые ящики","month.g1":"января","month.g10":"октября","month.g11":"ноября","month.g12":"декабря","month.g2":"февраля","month.g3":"марта","month.g4":"апреля","month.g5":"мая","month.g6":"июня","month.g7":"июля","month.g8":"августа","month.g9":"сентября",nounread:"Новых писем нет",refresh:"Обновить",retry:"Попробуйте еще раз",setreaded:"Отметить как прочитанное",markasread:"Прочитано",settings:"Настройки виджета",spam:"Отметить как спам",markasspam:"Это спам!",total:"всего <i18n:param>count</i18n:param>","tt.create":"Написать новое письмо","tt.logo":"Перейти в Я.Почту","tt.refresh":"Обновить список писем",wait:"Секундочку...",inbox:"Входящие","new-messages-plural":"{N} новое сообщение;{N} новых сообщения;{N} новых сообщений",hide:"Скрыть",show:"Показать",login:"Войти",logout1:"Выйти"},tr:{addmail:"Başka e-posta hesabı bağla","addmail.desc":"mail ayarlarından her zaman yapılabilir",attach:"Ekli ",continuewm:"Mail'i kullanmaya devam et",create:"E-posta yaz ",delete:"Sil ","error.net":"İnternet bağlantısı yok","error.refresh":"Güncelleme sırasında hata oluştu","ft.unread":"Okunmamış ",login_other:"Diğer hesaba giriş yap",logo:"Yandex.Mail",logout:"Çıkış ",logout_all:"Tüm hesaplardan çıkış yap","mail.wait":"Bekleyin...",mails:"Bağlı e-posta hesapları","month.g1":"Ocak","month.g10":"Ekim","month.g11":"Kasım","month.g12":"Aralık","month.g2":"Şubat","month.g3":"Mart","month.g4":"Nisan","month.g5":"Mayıs","month.g6":"Haziran","month.g7":"Temmuz","month.g8":"Ağustos","month.g9":"Eylül",nounread:"Yeni e-posta yok",refresh:"Güncelle ",retry:"Tekrar deneyin",setreaded:"Okundu olarak işaretle",settings:"Widget ayarları ",spam:"Spam olarak işaretle",total:"toplam <i18n:param>count</i18n:param>","tt.create":"E-posta yaz","tt.logo":"Yandex.Mail'e git","tt.refresh":"Mesaj listesini güncelle",wait:"Lütfen bekleyin... ",inbox:"Gelen Kutusu",markasread:"Okunmuş",markasspam:"Spam!",reply:"Yanıtla","new-messages-plural":"{N} yeni mesaj;{N} yeni mesaj;{N} yeni mesaj",hide:"Gizle",show:"Göster",login:"Giriş yap",logout1:"Çıkış yap"},uk:{addmail:"Підключити іншу скриньку","addmail.desc":"ви завжди зможете в налаштуваннях пошти",attach:"Із вкладенням",continuewm:"Продовжити роботу з поштою",create:"Написати",delete:"Видалити","error.net":"Немає підключення до інтернету","error.refresh":"Під час оновлення сталася помилка","ft.unread":"Непрочитані",login_other:"Увійти в іншу поштову скриньку",logo:"Яндекс.Пошта",logout:"Вихід",logout_all:"Вийти з усіх скриньок","mail.wait":"Секундочку...",mails:"Підключені поштові скриньки","month.g1":"cічня","month.g10":"жовтня","month.g11":"листопада","month.g12":"грудня","month.g2":"лютого","month.g3":"березня","month.g4":"квітня","month.g5":"травня","month.g6":"червня","month.g7":"липня","month.g8":"серпня","month.g9":"вересня",nounread:"Нових листів немає",refresh:"Оновити",retry:"Спробуйте ще раз",setreaded:"Позначити як прочитане",settings:"Налаштування віджета",spam:"Позначити як спам",total:"всього <i18n:param>count</i18n:param>","tt.create":"Написати новий лист","tt.logo":"Перейти у Я.Пошту","tt.refresh":"Оновити список листів",wait:"Секундочку...",inbox:"Вхідні",markasread:"Прочитано",markasspam:"Це спам!",reply:"Відповісти","new-messages-plural":"{N} нове повідомлення;{N} нові повідомлення;{N} нових повідомлень",hide:"Приховати",show:"Показати",login:"Увійти",logout1:"Вийти"}}}),define("slice/logic/config",{statName:"yamail",URL_WEB:"https://mail.yandex.{tld-kubr}/",URL_COUNTER:"https://export.{passport}/for/counters.xml",URL_API:"https://mail.yandex.ru/api/",URL_COUNTERS_ALL:"https://mail.yandex.ru/api/v2/bar/counters?silent&multi",OAUTH:{CLIENT_ID:"49c545918c574ac28dd7d27e8297065a",CLIENT_SECRET:"813caaea334a4fb5be54a8b9af3f4c97"},UPDATE_TIME_MS:3e5,MESSAGES_TO_LOAD:40,MESSAGES_TO_DISPLAY:20,IGNORED_FOLDERS:["spam","archive","trash","sent","outbox","draft"],XIVA_RECONNECT_TIMEOUT_MS:6e4,XIVA_RECONNECT_MAX_TIMEOUT_MS:192e4,XIVA_PING_RECONNECT_TIMEOUT_MS:12e4,linkParam:"elmt=mail",LOGO_LANG:"ru",locale:{en:{LOGO_LANG:"en"},tr:{LOGO_LANG:"en"},uk:{LOGO_LANG:"uk"},be:{LOGO_LANG:"uk"},kk:{LOGO_LANG:"uk"}},branding:{tb:{LOGO_LANG:"en",URL_WEB:"https://mail.yandex.com.tr/",URL_COUNTERS_ALL:"https://mail.yandex.com.tr/api/v2/bar/counters?silent&multi",URL_API:"https://mail.yandex.com.tr/api/"},ua:{URL_WEB:"https://mail.yandex.ua/"}},adapter:{chrome:{linkParam:"origin=elmt_mailchrome"}}}),define("slice/adapter/main",["browser-adapter","api/manager","api/branding","api/stat","slice/locale","slice/logic/config"],function(a,b,c,d,e,f){b.onReady(function(){if(c.brandingObject(f),d.setStatName(f.statName),e&&void 0!==e.ru){var b=e[a.getLang()]||e.ru;a.getString=function(a,c){var d=b[a]||"";return d&&c?d.replace(/<i18n:param>([a-zA-Z0-9\._-]+)<\/i18n:param>/g,function(a,b){return c[b]}):d}}"function"==typeof jQuery&&jQuery.ajaxSetup({crossDomain:!1,xhr:function(){return a.createXHR()}})})}),define("api/dom",[],function(){function a(a){return String(a).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")}function b(b){return new RegExp("(^|\\s)"+a(b)+"(\\s|$)")}function c(a,b){for(var c=a.target||a.srcElement,d={self:b,target:c,event:a};c&&(!d.parent&&c.getAttribute("data-cmd-parent")&&(d.parent=c),d.param=d.param||c.getAttribute("data-cmd-param")||"",d.command=d.command||c.getAttribute("data-command")||"",c!=b);)c=c.parentNode;return d}return{getClickHandler:function(a){return function(b){b=b||window.event;var d=c(b,this);if(a.commands&&d.command&&a.commands[d.command])return b.stopPropagation?b.stopPropagation():b.cancelBubble=!0,a.commands[d.command].call(a,d)}},addClass:function(b,c){if(b&&c){if(b.classList)return void b.classList.add(c);var d=new RegExp("^(?!.*(^|\\s)"+a(c)+"(\\s|$))");b.className=b.className.replace(d,c+" ").trim()}},removeClass:function(a,c){if(a&&c){if(a.classList)return void a.classList.remove(c);var d=b(c);a.className=a.className.replace(d," ").trim()}},toggleClass:function(a,b){return!(!a||!b)&&(a.classList?a.classList.toggle(b):void(this.hasClass(a,b)?this.removeClass(a,b):this.addClass(a,b)))},hasClass:function(a,c){return!(!a||!c)&&(a.classList?a.classList.contains(c):b(c).test(a.className))},dragNDropCore:function(a){function b(b){if(e)return e.oldX=e.pageX,e.oldY=e.pageY,e.pageX=b.pageX,e.pageY=b.pageY,a.onmove.call(a.ctx,e,b),!1}function c(d){if(e)return document.removeEventListener("mousemove",b,!1),document.removeEventListener("mouseup",c,!1),a.onstop&&a.onstop.call(a.ctx,e,d),e=null,!1}function d(d){return c(),e={elem:this,target:d.target,startX:d.pageX,startY:d.pageY,pageX:d.pageX,pageY:d.pageY},a.start&&!1===a.start.call(a.ctx,e,d)?void(e=null):(document.addEventListener("mousemove",b,!1),document.addEventListener("mouseup",c,!1),d.stopPropagation(),d.preventDefault(),!1)}var e=null;if(a.elems.tagName)a.elems.addEventListener("mousedown",d,!1);else for(var f=0;f<a.elems.length;++f)a.elems[f].addEventListener("mousedown",d,!1)}}}),define("api/utils",["browser-adapter"],function(a){return{copy:function(a,b){if(b=b||{},a)for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},emptyFunc:function(){},navigate:function(b,c){if(b){var d=c&&c.shiftKey?"new window":"new tab";c&&(c.preventDefault?c.preventDefault():c.returnValue=!1),a.navigate(b,d)}},getParam:function(a,b){return(RegExp("[?&]"+a+"=([^&#]*)","i").exec(b||document.location.href)||"")[1]||""},debounce:function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)},h=c&&!d;clearTimeout(d),d=setTimeout(g,b),h&&a.apply(e,f)}}}}),define("api/http",["browser-adapter","api/utils"],function(a,b){function c(a,b){return a+"="+encodeURIComponent(b)}function d(a,b){return'Content-Disposition: form-data; name="'+a+'"\r\n\r\n'+b}function e(a,b){if(!a||"string"==typeof a)return a||"";var e=[],f=b?d:c;for(var g in a)if(a.hasOwnProperty(g)){var h=a[g];Array.isArray(h)?h.forEach(function(a){e.push(f(g,a))}):e.push(f(g,h))}if(b){var i="\r\n";return b+i+e.join(i+b+i)+i+b+"--"+i}return e.join("&")}function f(c){var d=a.createXHR(),f=c.multipart?"-----8a7gadg1ahSDCV"+Date.now():null,g=c.url,h=null,i=e(c.query),j=e(c.params,f?"--"+f:null);if(c.data&&(i=i||j,j=""),"POST"===c.method?h=c.data||j||"":(h=c.data||null,i=i||j),i&&(g+=(-1===g.indexOf("?")?"?":"&")+i),d.open(c.method,g,!c.sync),c.overrideMimeType&&d.overrideMimeType&&d.overrideMimeType(c.overrideMimeType),c.background)try{d.mozBackgroundRequest=!0}catch(a){}var k=b.copy(c.headers);if(!k["Content-Type"]){var l=c.contentType;l||"POST"!=c.method||(l=f?"multipart/form-data; boundary="+f:"application/x-www-form-urlencoded;  charset=UTF-8"),l&&(k["Content-Type"]=l)}for(var m in k)k.hasOwnProperty(m)&&d.setRequestHeader(m,k[m]);return{xhr:d,text:h}}function g(a,b){if("xml"==b){var c=a.responseXML;if(c)return c;throw"parse error"}var d=a.responseText;return"json"==b&&(d=JSON.parse(d)),d}function h(a){function c(b){d.xhr&&!d.aborted&&(d.aborted=b||"abort",d.xhr.abort(),i.call(j,0,d.aborted,d.xhr,a))}var d=f(a);if(!a.sync){var e=a.end||b.emptyFunc,h=a.callback||b.emptyFunc,i=a.errback||b.emptyFunc,j=a.ctx||a.scope||a,k=Date.now();d.xhr.onreadystatechange=function(){if(d.xhr&&4==d.xhr.readyState){var b=Date.now();if(e.call(j,d.xhr),d.timer&&(clearTimeout(d.timer),d.timer=null),!d.aborted){var c=d.xhr.status,f="error";if(c>=200&&c<400){var l="",m=!1;if("HEAD"===a.method)h.call(j,null,d.xhr,c,n);else{try{l=g(d.xhr,a.responseType),m=!0}catch(b){i.call(j,500,"parse error",d.xhr,a)}if(m){var n=null;if(a.getTimeDiff){var o=new Date(d.xhr.getResponseHeader("Date")).valueOf();n=o?Math.round((k+b)/2)-o:null}h.call(j,l,d.xhr,c,n)}}}else{try{f=d.xhr.statusText}catch(a){}i.call(j,c,f,d.xhr,a)}}d.xhr=null}}}if(d.xhr.send(d.text),a.sync)try{return g(d.xhr,a.responseType)}catch(a){return null}return a.timeout&&a.timeout>0&&(d.timer=setTimeout(function(){d.timer&&c("timeout")},a.timeout)),{abort:c}}return{HEAD:function(a){return a.method="HEAD",h(a)},GET:function(a){if(a.method="GET",a.noCache){var b=a.query||a.params||{};"string"==typeof b?b=b+"&_randomparameter="+Date.now():b._randomparameter=Date.now(),a.params?a.params=b:a.query=b}return h(a)},POST:function(a){return a.method="POST",h(a)},PATCH:function(a){return a.method="PATCH",h(a)},PUT:function(a){return a.method="PUT",h(a)}}}),define("api/xml",[],function(){var a=/&|  |<|>|\r\n|\n|"/g,b=/&amp;|&nbsp;|&lt;|&gt;|<(br|BR)\s*\/?>|&quot;/g,c={"&":"&amp;","  ":"&nbsp; ","<":"&lt;",">":"&gt;","\n":"<br />","\r\n":"<br />",'"':"&quot;"},d={"&amp;":"&","&nbsp;":" ","&lt;":"<","&gt;":">","<br />":"\n","<br/>":"\n","<br>":"\n","&quot;":'"'},e=function(a){return c[a]},f=function(a){return d[a.toLowerCase()]},g={escape:function(b){return b?String(b).replace(a,e):""},unescape:function(a){return a?String(a).replace(b,f):""},stringToXml:function(a){var b;return"function"==typeof DOMParser?b=(new DOMParser).parseFromString(a,"text/xml"):"function"==typeof ActiveXObject&&(b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(a)),b},select:function(a,b){return b=b||document,"function"==typeof Sizzle?Sizzle(a,b)[0]||null:b.querySelector(a)},selectAll:function(a,b){return b=b||document,"function"==typeof Sizzle?Sizzle(a,b):b.querySelectorAll(a)},getText:function(a,b){return a&&b&&(a=g.select(b,a)),a?a.textContent||a.innerText||a.firstChild&&a.firstChild.data||"":""},setText:function(a,b){a&&(a.textContent=b,a.innerText=b)},getAttr:function(a,b,c){return 2==arguments.length&&(c=b,b=null),a&&b&&(a=g.select(b,a)),a&&a.getAttribute(c)||""}};return g}),require(["slice/adapter/main"],function(){require(["slice/logic/main"])}),define("main-logic",function(){}),define("slice/common-logic/yauth",["browser-adapter"],function(a){function b(a){return a?a.id:""}function c(a,b){return b?b.replace("{passport}",a):""}function d(a,b){this.data={},this.requests={},this.isCurrent=!1,this.authorized=!1,this.setUserInfo(a,b)}function e(){this._users=[],this._userMap={},this._currentUser=null,this._domain=null}var f={USER_GET_ALL:"user:get-all",USER_TOKEN_CHANGE:"user:token-change",AUTH_LIST_UPDATED:"slice:auth:list-updated",AUTH_ADD_USER:"slice:auth:add-user",AUTH_REMOVE_USER:"slice:auth:remove-user",AUTH_CURRENT:"slice:auth:current",AUTH_LOGIN:"slice:auth:login",AUTH_LOGOUT:"slice:auth:logout"};return d.prototype={constructor:d,getUrl:function(a){return c(this.passport,a)},setUserInfo:function(a,b){var c=a.login.split("@"),d=c[1]||b,e=c[0]+"@"+d;this.login=c[0],this.domain=d,this.passport=b,this.email=e,this.displayName=a.displayName,this.email=e,this.id=a.uid,this.data.accessToken=a.token,this.login||(this.data.displayEmail=this.displayName)},setMessages:function(a,b){return b&&delete this.data.messages,this.data.messages&&(a=a.filter(this._filterMessage.bind(this))),a&&(this.data.messages=a.concat(this.data.messages||[])),!!a&&a.length>0},deleteMessageById:function(a){if(!this.data.messages)return!1;var b=this.data.messages.length;return this.data.messages=this.data.messages.filter(function(b){return b.id!==a}),b!==this.data.messages.length},updateToken:function(b){this.data.accessToken=b,a.sendOuterMessage(f.USER_TOKEN_CHANGE,{uid:this.id,token:this.data.accessToken})},_filterMessage:function(a){for(var b=0,c=this.data.messages.length;b<c;b++){if(this.data.messages[b].id===a.id)return!1}return!0}},e.prototype={constructor:e,init:function(){},observers:{"user:all":function(c,e){a.log("Yauth: catch user:all event"),a.log("Yauth: received domain - "+e.domain),this._domain=e.domain;var g,h,i=e.list,j=[],k=this._currentUser,l=null,m={addCount:0,removeCount:0,loginCount:0,logoutCount:0,currentChanged:!1};for(g=0;g<i.length;++g){var n=i[g];h=this.getUser(n.uid),h?h.setUserInfo(n,e.domain):(h=new d(n,e.domain),this._users.push(h),this._userMap[h.id]=h,m.addCount++,a.log("Add user with id: "+h.id),a.sendMessage(f.AUTH_ADD_USER,h.id)),h.authorized!=n.isAuthorized&&(h.authorized?j.push(h):(h.authorized=!0,m.loginCount++,a.log("Login user with id: "+h.id),a.sendMessage(f.AUTH_LOGIN,h.id))),h.id==e.defaultUid&&(l=h),h.isDeleted&&delete h.isDeleted,h.__handled=!0}for(l!=k&&(this._currentUser=l,m.currentChanged=!0,k&&(k.isCurrent=!1),l&&(l.isCurrent=!0),a.sendMessage(f.AUTH_CURRENT,{current:b(l),oldCurrent:b(k)})),g=0;g<j.length;++g)j[g].authorized=!1,m.logoutCount++,a.log("Logout user with id: "+h.id),a.sendMessage(f.AUTH_LOGOUT,j[g].id);for(g=this._users.length-1;g>=0;--g)h=this._users[g],h.__handled?delete h.__handled:(h.authorized&&(h.authorized=!1,m.logoutCount++,a.log("Logout user with id: "+h.id),a.sendMessage(f.AUTH_LOGOUT,h.id)),m.removeCount++,h.isDeleted=!0,a.log("Remove user with id: "+h.id),a.sendMessage(f.AUTH_REMOVE_USER,h.id));(m.addCount||m.removeCount||m.loginCount||m.logoutCount||m.currentChanged)&&a.sendMessage(f.AUTH_LIST_UPDATED,m)}},updateUserData:function(){a.sendOuterMessage(f.USER_GET_ALL)},getUser:function(a){return a&&this._userMap[a]||null},
getCurrentUser:function(){return this._currentUser},getUrl:function(a,b){var d;return d=a?a.passport:this._domain,c(d,b)},hasAuth:function(){return null!==this._currentUser},forEach:function(a,b,c){for(var d=0;d<this._users.length;++d){var e=this._users[d];e.isDeleted||a&&!e.authorized||b.call(c,e)}}},e}),define("slice/logic/yauth",["api/manager","slice/common-logic/yauth"],function(a,b){var c=new b;return a.onReady(c),c}),define("slice/logic/folders",["browser-adapter","api/xml"],function(a,b){return{parse:function(b,c,d){var e;try{e=this._parseFolders(b),c.call(d,null,e)}catch(b){a.log("getfolders error:",b,e),c.call(d,e)}},getFolderById:function(a,b){if(a)for(var c=0;c<a.length;c++)if(a[c].id===b)return a[c];return null},_parseFolders:function(a){for(var c=[],d=b.selectAll("folder",a),e=0;e<d.length;e++){var f=d[e],g=b.getText(f,"symbol"),h=b.getText(f,"name").split("|").pop();c.push({id:b.getText(f,"fid"),symbol:g,name:h})}return c}}}),define("slice/logic/messages",["browser-adapter","api/xml","slice/logic/yauth","slice/logic/config","slice/logic/folders"],function(a,b,c,d,e){return{parse:function(b,c,d){var e;try{e=this._parseMessages(b),c.call(d,null,e)}catch(f){e=this._parseError(b),a.log("parseMessages error:",e),c.call(d,e)}},parseDate:function(a){try{var b=new Date,c=a.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})$/);return c&&0!==c.length?b.setFullYear(parseInt(c[1],10),parseInt(c[2],10)-1,parseInt(c[3],10)):(c=a.match(/^(\d{2})\.(\d{2})\.(\d{4})\s(\d{2}):(\d{2}):(\d{2})$/),b.setFullYear(parseInt(c[3],10),parseInt(c[2],10)-1,parseInt(c[1],10))),b.setHours(c[4]),b.setMinutes(c[5]),b.setSeconds(c[6]),b.valueOf()}catch(b){return new Date(a).valueOf()}},_parseMessages:function(a){var c=b.select("mailbox_list",a);if(!c)throw new Error("Bad response format");var d=b.select("error",c);if(d)throw new Error("Error with code"+b.getAttr(d,"code"));var e=b.select("details",c),f={},g=[];f.count=parseInt(b.getAttr(e,"msg_count"),10),f.countUnread=parseInt(b.getAttr(e,"unread"),10),f.name=(b.getAttr(e,"name")||"").split("|").pop(),f.type=void 0!==b.getAttr(e,"fid")?"folder":"label",f.id=b.getAttr(e,"fid")||b.getAttr(e,"lid"),f.symbol=b.getAttr(e,"symbol"),f.page=parseInt(b.getAttr(e,"page_number"),10)-1,f.unread=!!parseInt(b.getAttr(e,"unread"),10);for(var h=b.selectAll("message",c),i=0,j=0;j<h.length;j++){var k=h[j],l=i+j,m="",n=0,o="",p="",q=null,r=!1,s=null,t=null;try{m=b.getText(b.select("subject",k),"text"),"No subject"===m&&(m=""),o=b.getText(k,"firstline"),p=b.getText(b.select("from",k),"name"),p||(p=b.getText(b.select("from",k),"email")),q=this.parseDate(b.getAttr(k,"recv_date")),t=b.getAttr(k,"fid"),r="New"===b.getAttr(k,"status"),s=b.getAttr(k,"mid"),n=parseInt(b.getAttr(k,"att_count"),10)}catch(a){throw new Error("Неверный формат.")}g.push({number:l,id:s,from:p,subject:m,firstline:o,unread:r,date:q,attach:n,fid:t})}return{status:"ok",messages:this._filterMessages(g),details:f}},_parseError:function(a){var c=b.select("authProcedure",a),d={status:"error",errorType:"authorization"};if(c){var e=b.select("error",c);d.code=e?b.getAttr(e,"code"):""}return d},_filterMessages:function(a){var b=d.IGNORED_FOLDERS,f=c.getCurrentUser();return a.filter(function(a){var c=e.getFolderById(f.data.folders,a.fid);return!c||b.indexOf(c.symbol)<0}.bind(this))}}}),define("slice/logic/mail-api",["browser-adapter","api/http","api/xml","slice/logic/config","slice/logic/messages","slice/logic/folders"],function(a,b,c,d,e,f){"use strict";function g(){}return g.prototype={constructor:g,getAllCounters:function(a){return b.GET({url:d.URL_COUNTERS_ALL,ctx:this,responseType:"json",callback:this._onGetAllCounters.bind(this,a),errback:this._onGetAllCountersError.bind(this,a)})},_onGetAllCounters:function(b,c){var d=c?c.error:"empty response";if(d)return a.log("MailApi: getAllCounters error: "+d),void b.callback.call(b.ctx,d);b.callback.call(b.ctx,null,c)},_onGetAllCountersError:function(b,c,d){a.log("MailApi: getAllCounters error: "+c+" "+d),b.callback.call(b.ctx,{status:c,text:d})},getMessages:function(a){var c=d.URL_API+"mailbox_list";return b.GET({url:c,ctx:this,params:{first:0,last:d.MESSAGES_TO_LOAD,extra_cond:"only_new",goto:"all",elmt:"mail"},responseType:"xml",callback:this._createRedirectCatcher("getMessages",a,this._onGetMessages.bind(this,a)),errback:this._onGetMessagesError.bind(this,a)})},_onGetMessages:function(a,b){e.parse(b,a.callback,a.ctx)},_onGetMessagesError:function(b,c,d){a.log("MailApi: getMessages error: "+c+" "+d),b.callback.call(b.ctx,{status:c,text:d})},getFolders:function(a){var c=d.URL_API+"folder_list";return b.GET({url:c,ctx:this,responseType:"xml",callback:this._createRedirectCatcher("getFolders",a,this._onGetFolders.bind(this,a)),errback:this._onGetFoldersError.bind(this,a)})},_onGetFolders:function(a,b){f.parse(b,a.callback,a.ctx)},_onGetFoldersError:function(b,c,d){a.log("MailApi: getfolders error: "+c+" "+d),b.callback.call(b.ctx,{status:c,text:d})},changeMessageState:function(a){var c=d.URL_API+"mailbox_oper",e={oper:a.action,ids:[a.message.id]};return a.user.data.ckey&&(e.ckey=a.user.data.ckey),b.POST({url:c,ctx:this,params:e,responseType:"xml",callback:this._createRedirectCatcher("changeMessageState",a,this._onChangeMessageState.bind(this,a)),errback:this._onChangeMessageStateError.bind(this,a)})},_onChangeMessageState:function(b,c){var d=c.getElementsByTagName("error"),e=d?d[0]:null;e?(a.log("MailApi: changeMessageState error: "+e),b.callback.call(b.ctx,e)):b.callback.call(b.ctx)},_onChangeMessageStateError:function(b,c,d){a.log("MailApi: changeMessageState error: "+c+" "+d),b.callback.call(b.ctx,{status:c,text:d})},getUserSettings:function(a){var c=d.URL_API+"settings_setup";return b.GET({url:c,ctx:this,responseType:"xml",callback:this._createRedirectCatcher("getUserSettings",a,this._onGetUserSettings.bind(this,a)),errback:this._onGetUserSettingsError.bind(this,a)})},_onGetUserSettings:function(b,d){var e;try{if(!(e=c.select("error",d))){var f=c.select("body",d),g=c.getText(f,"default_email"),h=c.getText(f,"from_name");b.callback.call(b.ctx,null,{user:b.user,email:g,name:h})}}catch(a){e=a}if(e){a.log("MailApi: getUserSettings error");var i=parseInt(c.getAttr(e,"code"),10);b.callback.call(b.ctx,{status:i,text:""})}},_onGetUserSettingsError:function(b,c,d){a.log("MailApi: getUserSettings network error:",c,d),b.callback.call(b.ctx,{status:c,text:d})},getAccountInfo:function(a){var c=d.URL_API+"account_information";return b.GET({url:c,ctx:this,responseType:"xml",callback:this._createRedirectCatcher("getAccountInfo",a,this._onGetAccountInfo.bind(this,a)),errback:this._onGetAccountInfoError.bind(this,a)})},_onGetAccountInfo:function(b,d){var e;try{if(!(e=c.select("error",d))){var f=c.select("account_information",d),g=c.getText(f,"ckey");b.callback.call(b.ctx,null,{user:b.user,ckey:g})}}catch(a){e=a}if(e){a.log("getAccountInfo error");var h=parseInt(c.getAttr(e,"code"),10);b.callback.call(b.ctx,{status:h,text:""})}},_onGetAccountInfoError:function(b,c,d){a.log("getAccountInfo network error, status: %s, text: %s",c,d),b.callback.call(b.ctx,{status:c,text:d})},_createRedirectCatcher:function(a,b,c){return function(d){var e=!1;b&&b.noFurtherRedirects||(e=this._tryCatchRedirect(d,a,b,c)),e||c.call(this,d)}},_tryCatchRedirect:function(b,d,e,f){try{var g=c.select("redirect",b),h=c.getText(g,"redirect_to");if(h)return a.log("Catch redirect for method: "+d+", redirect url: "+h),this._goToRedirect(h,d,e,f),!0}catch(b){a.log("Can not parse response for redirects")}return!1},_goToRedirect:function(c,d,e,f){return b.GET({url:c,ctx:this,responseType:"xml",callback:function(){"function"==typeof this[d]?(e=e||{},e.noFurtherRedirects=!0,this[d].call(this,e)):a.log("Bad callback for name: "+d)},errback:function(b,c){a.log("Error while going to redirect after: "+d),a.log("Status: "+b+", text: "+c),f(null)}})}},g}),define("slice/common-logic/timers",["browser-adapter","api/manager"],function(a,b){function c(a,b,c,d){var f=this;this._callback=function(){var a=!0;f._expandingMode&&(a=f._expandingCurrent>=f._expandingSkipCount,a?(f._expandingSkipCount<f._maxSkipCount&&f._expandingSkipCount++,f._expandingCurrent=0):f._expandingCurrent++),a&&b.call(c||f)},this._interval=0,this._maxSkipCount=d||e,this._expandingMode=!1,this.setInterval(a)}var d=function(b,c){a.log("[sliceApi.timers]: "+b)},e=2;c.prototype={constructor:c,setInterval:function(a){if(a=Number(a),this._interval!=a){this._interval=a;var b=this._timer;this.stop(),b&&this.start()}return this},start:function(){return!this._timer&&this._interval>=1&&(this._expandingSkipCount=0,this._expandingCurrent=0,this._timer=setInterval(this._callback,this._interval)),this},stop:function(){return this._timer&&(clearInterval(this._timer),this._timer=null),this},setExpanding:function(a){if(a=!1!==a,this._expandingMode!=a)return this._expandingMode=a,d("setExpanding "+a),a&&(this._expandingSkipCount=0,this._expandingCurrent=0),this},resetExpanding:function(){return this._expandingMode&&(this._expandingSkipCount=0,this._expandingCurrent=0),this},finalize:function(){this.stop(),this._callback=null,this._interval=0}};var f=[],g={create:function(a,b,d,e){"function"==typeof a&&(e=d,d=b,b=a,a=0);var g=new c(a,b,d,e);return f.push(g),g},stopAll:function(){for(var a=0;a<f.length;++a)f[a].stop()},startAll:function(){for(var a=0;a<f.length;++a)f[a].start()},finalize:function(){for(var a=0;a<f.length;++a)f[a].finalize();f=[]}};return b.onReady(g),g}),define("slice/common-logic/plural",["browser-adapter"],function(a){function b(){return a.getLang()}function c(){if(!f){for(var a=","+b()+",",c=0;c<e.length;++c)if((","+e[c][0]+",").indexOf(a)>=0){f=e[c];break}f=f||e[d]}return f}var d=1,e=[["kk,ka,km,ms,my,su,tt,th,ug,tr,zh,ja,vi,fa,tut,ko,lo,hi,id",1,function(a){return 0}],["en,de,et,no,el,it",2,function(a){return 1!=a?1:0}],["fr,uz,tg",2,function(a){return a>1?1:0}],["lv",3,function(a){return a%10==1&&a%100!=11?1:0!=a?2:0}],["gd",4,function(a){return 1==a||11==a?0:2==a||12==a?1:a>0&&a<20?2:3}],["ro",3,function(a){return 1==a?0:0==a||a%100>0&&a%100<20?1:2}],["lt",3,function(a){return a%10==1&&a%100!=11?0:a%10>=2&&(a%100<10||a%100>=20)?2:1}],["ru,uk,be,hr,sr,bs",3,function(a){return a%10==1&&a%100!=11?0:a%10>=2&&a%10<=4&&(a%100<10||a%100>=20)?1:2}],["sk,cs",3,function(a){return 1==a?0:a>=2&&a<=4?1:2}],["pl",3,function(a){return 1==a?0:a%10>=2&&a%10<=4&&(a%100<10||a%100>=20)?1:2}],["sl",4,function(a){return a%100==1?0:a%100==2?1:a%100==3||a%100==4?2:3}],["ga",5,function(a){return 1==a?0:2==a?1:a>=3&&a<=6?2:a>=7&&a<=10?3:4}],["ar",6,function(a){return 0==a?5:1==a?0:2==a?1:a%100>=3&&a%100<=10?2:a%100>=11&&a%100<=99?3:4}],["mt",4,function(a){return 1==a?0:0==a||a%100>0&&a%100<=10?1:a%100>10&&a%100<20?2:3}],["mk",3,function(a){return a%10==1?0:a%10==2?1:2}],["is",2,function(a){return a%10==1&&a%100!=11?0:1}],["br",5,function(a){return a%10==1&&a%100!=11&&a%100!=71&&a%100!=91?0:a%10==2&&a%100!=12&&a%100!=72&&a%100!=92?1:a%10!=3&&a%10!=4&&a%10!=9||a%100==13||a%100==14||a%100==19||a%100==73||a%100==74||a%100==79||a%100==93||a%100==94||a%100==99?a%1e6==0&&0!=a?3:4:2}]],f=null;return{index:function(a){return c()[2](a)},form:function(a,b,d){return"string"==typeof b&&(b=b.split(d||";")),b[Math.min(b.length-1,c()[2](a))]},formCount:function(){return c()[1]}}}),define("slice/common-logic/notify",["browser-adapter","api/manager","api/stat","api/branding","slice/common-logic/plural"],function(a,b,c,d,e){function f(){o.requestShowPermission(function(b){if(!b)return void(n=[]);var c=a.getNotificationManager(),d=n.length;d>1?c.create(h(n)):1===d&&c.create(g(n[0])),n=[]})}function g(b){var c=a.getNotificationManager();return{type:b.type,title:b.title||o.defaultTitle,text:((b.mainText||"")+"\n"+(b.subText||"")).trim(),mainText:b.mainText||"",subText:b.subText||"",template:o.useMailTemplates?c.TEMPLATE_MAIL:c.TEMPLATE_MESSAGE,context:b.context||o.defaultClickUrl,icon:b.icon||o.defaultIconUrl,groupSize:1,isDefaultIcon:!b.icon}}function h(b){var c,d=a.getNotificationManager(),f=b.length,g=i(b);if(o.ongroup)c=o.ongroup(b,g),a.logObj(c);else{var h;h=g?o.pluralForms[g]:o.pluralForms.mix;var j=e.form(f,h).replace(o.pluralPlaceholder,f,"gm");c={title:j,mainText:j,subText:"",template:d.TEMPLATE_GROUP,isDefaultIcon:!0,context:o.groupContexts&&g?o.groupContexts(b):void 0}}return c.text=((c.mainText||"")+"\n"+(c.subText||"")).trim(),c.groupSize=f,c.type=c.type||g||"mix",c.defaultTitle=c.defaultTitle||o.defaultTitle,c.icon=c.icon||o.defaultIconUrl,c.context=c.context||o.defaultClickUrl,c}function i(a){for(var b=a[0].type,c=1,d=a.length;c<d;c++)if(a[c].type!==b)return null;return b}function j(a,b){var d=a>1?"group":"one";c.logNotification(d+"."+b)}function k(a){return!(!a||!a.key||"adv-"!==a.key.substr(0,4))}var l,m={ENABLE_NOTIF:!0},n=[],o={useMailTemplates:!1,serviceName:"",delayInMs:4e3,defaultTitle:"",defaultIconUrl:"",defaultClickUrl:"",pluralPlaceholder:"{N}",pluralForms:{},requestShowPermission:function(a){a(!0)}},p={init:function(){d.brandingObject(m),a.getNotificationManager().addListener(this.handlers)},finalize:function(){a.getNotificationManager().removeListener(this.handlers)},handlers:{notificationClicked:function(b,c,d){if(!k(c)){a.log("Notification clicked with target: "+d);var e=a.getNotificationManager();switch(d){case e.CLICK_TARGET_OPTIONS:j(c.groupSize,"sett"),a.openSettings();break;case e.CLICK_TARGET_CLOSE:j(c.groupSize,"close");break;case e.CLICK_TARGET_OTHER:case e.CLICK_TARGET_TITLE:j(c.groupSize,"click"),o.onclick?o.onclick(c):a.navigate(c.context,"new tab")}}},notificationClosed:function(b,c,d){if(!k(c)){a.log("Notification closed with reason: "+d);var e=a.getNotificationManager();switch(d){case e.CLOSE_REASON_TIMEOUT:j(c.groupSize,"time")}}},notificationsGroup:function(){a.log("Notify: notificationGroup handler")}},setOptions:function(a){for(var b=Object.keys(a),c=0,d=b.length;c<d;c++){var e=b[c];o[e]=a[e]}},show:function(a){m.ENABLE_NOTIF&&(n.push(a),clearTimeout(l),l=setTimeout(f,o.delayInMs))}};return b.onReady(p),p}),function(){function a(a){var c=!1;return function(){if(c)throw new Error("Callback was already called.");c=!0,a.apply(b,arguments)}}var b,c,d={};b=this,null!=b&&(c=b.async),d.noConflict=function(){return b.async=c,d};var e=Object.prototype.toString,f=Array.isArray||function(a){return"[object Array]"===e.call(a)},g=function(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)},h=function(a,b){if(a.map)return a.map(b);var c=[];return g(a,function(a,d,e){c.push(b(a,d,e))}),c},i=function(a,b,c){return a.reduce?a.reduce(b,c):(g(a,function(a,d,e){c=b(c,a,d,e)}),c)},j=function(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b};"undefined"!=typeof process&&process.nextTick?(d.nextTick=process.nextTick,"undefined"!=typeof setImmediate?d.setImmediate=function(a){setImmediate(a)}:d.setImmediate=d.nextTick):"function"==typeof setImmediate?(d.nextTick=function(a){setImmediate(a)},d.setImmediate=d.nextTick):(d.nextTick=function(a){setTimeout(a,0)},d.setImmediate=d.nextTick),d.each=function(b,c,d){function e(a){a?(d(a),d=function(){}):(f+=1)>=b.length&&d()}if(d=d||function(){},!b.length)return d();var f=0;g(b,function(b){c(b,a(e))})},d.forEach=d.each,d.eachSeries=function(a,b,c){if(c=c||function(){},!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c():e())})};e()},d.forEachSeries=d.eachSeries,d.eachLimit=function(a,b,c,d){k(b).apply(null,[a,c,d])},d.forEachLimit=d.eachLimit;var k=function(a){return function(b,c,d){if(d=d||function(){},!b.length||a<=0)return d();var e=0,f=0,g=0;!function h(){if(e>=b.length)return d();for(;g<a&&f<b.length;)f+=1,g+=1,c(b[f-1],function(a){a?(d(a),d=function(){}):(e+=1,g-=1,e>=b.length?d():h())})}()}},l=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[d.each].concat(b))}},m=function(a,b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[k(a)].concat(c))}},n=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[d.eachSeries].concat(b))}},o=function(a,b,c,d){if(b=h(b,function(a,b){return{index:b,value:a}}),d){var e=[];a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d,b(c)})},function(a){d(a,e)})}else a(b,function(a,b){c(a.value,function(a){b(a)})})};d.map=l(o),d.mapSeries=n(o),d.mapLimit=function(a,b,c,d){return p(b)(a,c,d)};var p=function(a){return m(a,o)};d.reduce=function(a,b,c,e){d.eachSeries(a,function(a,d){c(b,a,function(a,c){b=c,d(a)})},function(a){e(a,b)})},d.inject=d.reduce,d.foldl=d.reduce,d.reduceRight=function(a,b,c,e){var f=h(a,function(a){return a}).reverse();d.reduce(f,b,c,e)},d.foldr=d.reduceRight;var q=function(a,b,c,d){var e=[];b=h(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c&&e.push(a),b()})},function(a){d(h(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};d.filter=l(q),d.filterSeries=n(q),d.select=d.filter,d.selectSeries=d.filterSeries;var r=function(a,b,c,d){var e=[];b=h(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c||e.push(a),b()})},function(a){d(h(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};d.reject=l(r),d.rejectSeries=n(r);var s=function(a,b,c,d){a(b,function(a,b){c(a,function(c){c?(d(a),d=function(){}):b()})},function(a){d()})};d.detect=l(s),d.detectSeries=n(s),d.some=function(a,b,c){d.each(a,function(a,d){b(a,function(a){a&&(c(!0),c=function(){}),d()})},function(a){c(!1)})},d.any=d.some,d.every=function(a,b,c){d.each(a,function(a,d){b(a,function(a){a||(c(!1),c=function(){}),d()})},function(a){c(!0)})},d.all=d.every,d.sortBy=function(a,b,c){d.map(a,function(a,c){b(a,function(b,d){b?c(b):c(null,{value:a,criteria:d})})},function(a,b){if(a)return c(a);var d=function(a,b){var c=a.criteria,d=b.criteria;return c<d?-1:c>d?1:0};c(null,h(b.sort(d),function(a){return a.value}))})},d.auto=function(a,b){b=b||function(){};var c=j(a),e=c.length;if(!e)return b();var h={},k=[],l=function(a){k.unshift(a)},m=function(a){for(var b=0;b<k.length;b+=1)if(k[b]===a)return void k.splice(b,1)},n=function(){e--,g(k.slice(0),function(a){a()})};l(function(){if(!e){var a=b;b=function(){},a(null,h)}}),g(c,function(c){var e=f(a[c])?a[c]:[a[c]],k=function(a){var e=Array.prototype.slice.call(arguments,1);if(e.length<=1&&(e=e[0]),a){var f={};g(j(h),function(a){f[a]=h[a]}),f[c]=e,b(a,f),b=function(){}}else h[c]=e,d.setImmediate(n)},o=e.slice(0,Math.abs(e.length-1))||[],p=function(){return i(o,function(a,b){return a&&h.hasOwnProperty(b)},!0)&&!h.hasOwnProperty(c)};if(p())e[e.length-1](k,h);else{var q=function(){p()&&(m(q),e[e.length-1](k,h))};l(q)}})},d.retry=function(a,b,c){var e=5,f=[];"function"==typeof a&&(c=b,b=a,a=e),a=parseInt(a,10)||e;var g=function(e,g){for(var h=function(a,b){return function(c){a(function(a,d){c(!a||b,{err:a,result:d})},g)}};a;)f.push(h(b,!(a-=1)));d.series(f,function(a,b){b=b[b.length-1],(e||c)(b.err,b.result)})};return c?g():g},d.waterfall=function(a,b){if(b=b||function(){},!f(a)){var c=new Error("First argument to waterfall must be an array of functions");return b(c)}if(!a.length)return b();var e=function(a){return function(c){if(c)b.apply(null,arguments),b=function(){};else{var f=Array.prototype.slice.call(arguments,1),g=a.next();g?f.push(e(g)):f.push(b),d.setImmediate(function(){a.apply(null,f)})}}};e(d.iterator(a))()};var t=function(a,b,c){if(c=c||function(){},f(b))a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.each(j(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}};d.parallel=function(a,b){t({map:d.map,each:d.each},a,b)},d.parallelLimit=function(a,b,c){t({map:p(b),each:k(b)},a,c)},d.series=function(a,b){if(b=b||function(){},f(a))d.mapSeries(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},b);else{var c={};d.eachSeries(j(a),function(b,d){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),c[b]=e,d(a)})},function(a){b(a,c)})}},d.iterator=function(a){var b=function(c){var d=function(){return a.length&&a[c].apply(null,arguments),d.next()};return d.next=function(){return c<a.length-1?b(c+1):null},d};return b(0)},d.apply=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b.concat(Array.prototype.slice.call(arguments)))}};var u=function(a,b,c,d){var e=[];a(b,function(a,b){c(a,function(a,c){e=e.concat(c||[]),b(a)})},function(a){d(a,e)})};d.concat=l(u),d.concatSeries=n(u),d.whilst=function(a,b,c){a()?b(function(e){if(e)return c(e);d.whilst(a,b,c)}):c()},d.doWhilst=function(a,b,c){a(function(e){if(e)return c(e);var f=Array.prototype.slice.call(arguments,1);b.apply(null,f)?d.doWhilst(a,b,c):c()})},d.until=function(a,b,c){a()?c():b(function(e){if(e)return c(e);d.until(a,b,c)})},d.doUntil=function(a,b,c){a(function(e){if(e)return c(e);var f=Array.prototype.slice.call(arguments,1);b.apply(null,f)?c():d.doUntil(a,b,c)})},d.queue=function(b,c){function e(a,b,c,e){if(a.started||(a.started=!0),f(b)||(b=[b]),0==b.length)return d.setImmediate(function(){a.drain&&a.drain()});g(b,function(b){var f={data:b,callback:"function"==typeof e?e:null};c?a.tasks.unshift(f):a.tasks.push(f),a.saturated&&a.tasks.length===a.concurrency&&a.saturated(),d.setImmediate(a.process)})}void 0===c&&(c=1);var h=0,i={tasks:[],concurrency:c,saturated:null,empty:null,drain:null,started:!1,paused:!1,push:function(a,b){e(i,a,!1,b)},kill:function(){i.drain=null,i.tasks=[]},unshift:function(a,b){e(i,a,!0,b)},process:function(){if(!i.paused&&h<i.concurrency&&i.tasks.length){var c=i.tasks.shift();i.empty&&0===i.tasks.length&&i.empty(),h+=1;var d=function(){h-=1,c.callback&&c.callback.apply(c,arguments),i.drain&&i.tasks.length+h===0&&i.drain(),i.process()},e=a(d);b(c.data,e)}},length:function(){return i.tasks.length},running:function(){return h},idle:function(){return i.tasks.length+h===0},pause:function(){!0!==i.paused&&(i.paused=!0)},resume:function(){if(!1!==i.paused){i.paused=!1;for(var a=1;a<=i.concurrency;a++)d.setImmediate(i.process)}}};return i},d.priorityQueue=function(a,b){function c(a,b){return a.priority-b.priority}function e(a,b,c){for(var d=-1,e=a.length-1;d<e;){var f=d+(e-d+1>>>1);c(b,a[f])>=0?d=f:e=f-1}return d}function h(a,b,h,i){if(a.started||(a.started=!0),f(b)||(b=[b]),0==b.length)return d.setImmediate(function(){a.drain&&a.drain()});g(b,function(b){var f={data:b,priority:h,callback:"function"==typeof i?i:null};a.tasks.splice(e(a.tasks,f,c)+1,0,f),a.saturated&&a.tasks.length===a.concurrency&&a.saturated(),d.setImmediate(a.process)})}var i=d.queue(a,b);return i.push=function(a,b,c){h(i,a,b,c)},delete i.unshift,i},d.cargo=function(a,b){var c=!1,e=[],i={tasks:e,payload:b,saturated:null,empty:null,drain:null,drained:!0,push:function(a,c){f(a)||(a=[a]),g(a,function(a){e.push({data:a,callback:"function"==typeof c?c:null}),i.drained=!1,i.saturated&&e.length===b&&i.saturated()}),d.setImmediate(i.process)},process:function d(){if(!c){if(0===e.length)return i.drain&&!i.drained&&i.drain(),void(i.drained=!0);var f="number"==typeof b?e.splice(0,b):e.splice(0,e.length),j=h(f,function(a){return a.data});i.empty&&i.empty(),c=!0,a(j,function(){c=!1;var a=arguments;g(f,function(b){b.callback&&b.callback.apply(null,a)}),d()})}},length:function(){return e.length},running:function(){return c}};return i};var v=function(a){return function(b){var c=Array.prototype.slice.call(arguments,1);b.apply(null,c.concat([function(b){var c=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(b?console.error&&console.error(b):console[a]&&g(c,function(b){console[a](b)}))}]))}};d.log=v("log"),d.dir=v("dir"),d.memoize=function(a,b){var c={},e={};b=b||function(a){return a};var f=function(){var f=Array.prototype.slice.call(arguments),g=f.pop(),h=b.apply(null,f);h in c?d.nextTick(function(){g.apply(null,c[h])}):h in e?e[h].push(g):(e[h]=[g],a.apply(null,f.concat([function(){c[h]=arguments;var a=e[h];delete e[h];for(var b=0,d=a.length;b<d;b++)a[b].apply(null,arguments)}])))};return f.memo=c,f.unmemoized=a,f},d.unmemoize=function(a){return function(){return(a.unmemoized||a).apply(null,arguments)}},d.times=function(a,b,c){for(var e=[],f=0;f<a;f++)e.push(f);return d.map(e,b,c)},d.timesSeries=function(a,b,c){for(var e=[],f=0;f<a;f++)e.push(f);return d.mapSeries(e,b,c)},d.seq=function(){var a=arguments;return function(){var b=this,c=Array.prototype.slice.call(arguments),e=c.pop();d.reduce(a,c,function(a,c,d){c.apply(b,a.concat([function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);d(a,b)}]))},function(a,c){e.apply(b,[a].concat(c))})}},d.compose=function(){return d.seq.apply(null,Array.prototype.reverse.call(arguments))};var w=function(a,b){var c=function(){var c=this,d=Array.prototype.slice.call(arguments),e=d.pop();return a(b,function(a,b){a.apply(c,d.concat([b]))},e)};if(arguments.length>2){var d=Array.prototype.slice.call(arguments,2);return c.apply(this,d)}return c};d.applyEach=l(w),d.applyEachSeries=n(w),d.forever=function(a,b){function c(d){if(d){if(b)return b(d);throw d}a(c)}c()},"undefined"!=typeof module&&module.exports?module.exports=d:void 0!==define&&define.amd?define("slice/common-libs/async",[],function(){return d}):b.async=d}(),define("slice/logic/notify",["require","browser-adapter","api/manager","slice/logic/config","slice/common-logic/notify","slice/common-libs/async"],function(a){"use strict";var b,c=a("browser-adapter"),d=a("api/manager"),e=a("slice/logic/config"),f=a("slice/common-logic/notify"),g=a("slice/common-libs/async"),h={notificationClicked:function(a,b,d){var e=c.getNotificationManager(),f=b.context?b.context.match(/uid=([0-9]+)/):null,g=f?f[1]:null;"mail"!==b.type||!g||d!==e.CLICK_TARGET_OTHER&&d!==e.CLICK_TARGET_TITLE||c.sendOuterMessage("user:login",{uid:g})}};return d.onReady(function(){c.getNotificationManager().addListener(h),f.setOptions({serviceName:"yamail",useMailTemplates:!0,defaultTitle:c.getString("logo"),defaultIconUrl:c.getSlicePath()+"images/mail_128.png",pluralForms:{mail:c.getString("new-messages-plural"),mix:""},requestShowPermission:function(a){var d=String(c.getOption("showTextAlert")),e=c.isWindowVisible();if(e||"false"===d)return c.log("Notify: requestShowPermission denied"),c.log("isWindowVisible: "+e),c.log("showOption: "+d),void a(!1);g.parallel([function(a){c.getCurrentTabUrl(a.bind(null,null))},function(a){c.isCurrentWindowMinimized(a.bind(null,null))}],function(d,e){var f=!d&&(-1===e[0].indexOf(b)||e[1]);c.log("Notify: requestShowPermission, active tab and window state check result: "+f),a(f)})},groupContexts:function(a){if(a.length&&a[0]&&a[0].user){var b=a[0].user;return a.every(function(a){return a.user.id===b.id})?b.getUrl(e.URL_WEB)+"?uid="+b.id:void 0}}})}),d.onExit(function(){c.getNotificationManager().removeListener(h)}),{createNotification:function(a,d){c.log("Send notification to platform"),b=a.getUrl(e.URL_WEB),f.setOptions({defaultClickUrl:a.getUrl(e.URL_WEB)}),f.show({type:"mail",title:d.from||d.email,mainText:((d.subject||"")+"\n"+(d.firstline||"")).trim(),icon:null,user:a,context:a.getUrl(e.URL_WEB)+"message?"+e.linkParam+"&ids="+d.id+"&uid="+a.id})}}}),define("slice/logic/oauth-manager",["require","api/http","browser-adapter"],function(a){"use strict";var b=a("api/http"),c=a("browser-adapter");return{_clientId:"",_clientSecret:"",init:function(a,b){this._clientId=a,this._clientSecret=b},getAccessToken:function(a,b){if(!a.id)return void b(new Error("Empty uid:"+a.id));c.getCookie(a.passport,"Session_id","/",!0,!0,function(c){if(!c)return void b(new Error("Empty Session_id: "+c));this._requestToken(a,c,b)},this)},_requestToken:function(a,c,d){try{b.POST({url:a.getUrl("https://oauth.{passport}")+"/token",params:{client_id:this._clientId,client_secret:this._clientSecret,host:a.passport,grant_type:"sessionid",sessionid:c,uid:a.id},callback:function(a){try{a=JSON.parse(a)}catch(b){return void d(new Error("Can not parse response:"+a))}if(a&&a.access_token)d(null,a.access_token);else{var b="Empty token in response: "+a.error+" "+a.error_description;d(new Error(b))}}.bind(this),errback:function(a,b,c){var e="Status code: "+a+", status text: "+b+", response:"+c.responseText;d(new Error(e))}})}catch(a){d(a)}}}}),define("slice/logic/xiva",["require","browser-adapter","api/manager","api/http","api/xml","slice/logic/folders","slice/logic/messages","slice/logic/config","slice/logic/yauth","slice/logic/oauth-manager"],function(a){"use strict";function b(a,b){e.log("XIVA ("+a.login+"): "+b)}function c(a,b){e.error("XIVA: "+b)}var d,e=a("browser-adapter"),f=a("api/manager"),g=(a("api/http"),a("api/xml"),a("slice/logic/folders")),h=a("slice/logic/messages"),i=a("slice/logic/config"),j=a("slice/logic/yauth"),k=a("slice/logic/oauth-manager"),l={NORMAL:1e3,REQUEST_ERROR:4400,AUTH_ERROR:4401,INTERNAL_ERROR:4500},m={init:function(){window.WebSocket?(e.log("XIVA: use native websockets"),d=window.WebSocket):(e.log("XIVA: use platform's websockets"),d=e.getWebSocket()),d?k.init(i.OAUTH.CLIENT_ID,i.OAUTH.CLIENT_SECRET):e.error("XIVA: websockets isn't supported")},finalize:function(){j.forEach(!0,this.disconnect,this)},observers:{"slice:auth:logout":function(a,b){var c=j.getUser(b);this.disconnect(c),this.reset(c)},"slice:auth:login":function(a,b){this.connect(j.getUser(b))}},connect:function(a){a&&!a.data.xivaConnect&&(a.data.accessToken?(b(a,"connecting with existing token"),this.openSocket(a)):(b(a,"getting new token"),k.getAccessToken(a,function(d,e){if(d)return c(a,"Error getting token "+d),this.reset(a),void this.reconnect(a);b(a,"connecting with new token"),a.updateToken(e),this.openSocket(a)}.bind(this))))},reconnect:function(a){if(a){this.disconnect(a),a.data.progressTimeout||(a.data.progressTimeout=i.XIVA_RECONNECT_TIMEOUT_MS);var c=a.data.progressTimeout,d=Date.now(),e=a.data.xivaReconnectTimeout;e&&(e>d?c=e-d:a.data.xivaReconnectTimeout=0),b(a,"reconnect after "+c),clearTimeout(a.data.xivaReconnectTimeoutId),a.data.xivaReconnectTimeoutId=setTimeout(function(){this.connect(a)}.bind(this),c),a.data.progressTimeout<i.XIVA_RECONNECT_MAX_TIMEOUT_MS&&(a.data.progressTimeout*=2)}},disconnect:function(a){a&&(this._closeSocket(a),this._clearTimers(a))},_closeSocket:function(a){a.data.xivaConnect&&(this.removeListenersFromSocket(a.data.xivaConnect,a.data.xivaConnectHandlers),a.data.xivaConnect.close(),delete a.data.xivaConnect,delete a.data.xivaConnectHandlers,b(a,"socket disconnected"))},_clearTimers:function(a){clearTimeout(a.data.xivaReconnectTimeoutId),delete a.data.xivaReconnectTimeoutId,a.data.xivaReconnectTimeout=0,clearTimeout(a.data.xivaPingReconnectTimeoutId),delete a.data.xivaPingReconnectTimeoutId,clearTimeout(a.resetProgressTimeoutId)},openSocket:function(a){if(a&&!a.data.xivaConnect){var b=a.data.accessToken;if(b){var f="wss://push.yandex.ru/v1/subscribe/?oauth_token="+b+"&client=bar&uid="+a.id+"&service=mail&session="+e.getUI().replace(/[^a-zA-Z0-9\-_]/g,"");try{a.data.xivaConnect=new d(f)}catch(b){c(a,"Can not create WebSocket: "+(b&&b.message||String(b)))}a.data.xivaConnectHandlers={message:this.onSocketMessage.bind(this,a),open:this.onSocketOpen.bind(this,a),close:this.onSocketClose.bind(this,a),error:this.onSocketClose.bind(this,a)},this.resetManualReconnectTimer(a),this.addListenersToSocket(a.data.xivaConnect,a.data.xivaConnectHandlers)}}},resetManualReconnectTimer:function(a){clearTimeout(a.data.xivaPingReconnectTimeoutId),a.data.xivaPingReconnectTimeoutId=setTimeout(function(){b(a,"manual reconnect because no signal from xiva for "+i.XIVA_PING_RECONNECT_TIMEOUT_MS+" ms"),this.reconnect(a)}.bind(this),i.XIVA_PING_RECONNECT_TIMEOUT_MS)},reset:function(a){a&&(b(a,"clear token for reset"),a.updateToken(""),delete a.data.xivaReconnectTimeout)},
addListenersToSocket:function(a,b){this.processSocketListeners(a,b,"add")},removeListenersFromSocket:function(a,b){this.processSocketListeners(a,b,"remove")},processSocketListeners:function(a,b,c){var d="add"===c?"addEventListener":"removeEventListener",e="add"===c?"attachEvent":"detachEvent";for(var f in b)if(b.hasOwnProperty(f)){var g=b[f];a[d]?a[d](f,g,!1):a[e]?a[e]("on"+f,g):a["on"+f]="add"===c?g:null}},onSocketOpen:function(a){b(a,"socket opened"),a.resetProgressTimeoutId=setTimeout(function(){a.data.progressTimeout=i.XIVA_RECONNECT_TIMEOUT_MS},2e3)},onSocketClose:function(a,c){if(b(a,"socketClose, type: "+c.type+", code: "+c.code+", reason: "+c.reason),"close"===c.type&&c.code!==l.NORMAL){var d=c.reason,e=null;if(d)try{e=parseInt(d.match(/^\s*retry\-after\:\s*(\d+)\s*$/i)[1],10)}catch(a){}e&&(a.data.xivaReconnectTimeout=Date.now()+1e3*e),c.code===l.AUTH_ERROR&&this.reset(a)}this.reconnect(a)},onSocketMessage:function(a,e){if(d){var f=e.data;try{f=JSON.parse(f)}catch(b){return void c(a,"Can not parse socket message: "+f)}if(f){if(b(a,"socket message with operation: "+f.operation),"bad sign"===f.Error&&(c(a,'socket receivedData "bad sign"'),this.reset(a),this.reconnect(a)),"insert"===f.operation){var j=i.IGNORED_FOLDERS,k=f.message;if(k){var l=k.fid,m="New"===k.hdr_status,n=g.getFolderById(l);if(m&&n&&-1===j.indexOf(n.symbol||"")){var o=k.hdr_from.match(/^"(.+)"/),p=k.hdr_from.match(/<(.+)>$/),q=o?o[1]:null,r=p?p[1]:null,s=k.hdr_subject;"No subject"===s&&(s="");var t=k.firstline,u=k.mid,v=h.parseDate(k.received_date),w=r;q&&q!==r&&(w=q);var x={uid:a.id,message:{email:r,from:w,subject:s||"",firstline:t||"",id:u,fid:l,date:v}};a.setMessages([x.message])?this.notify(x):b(a,"new message have been declined as a duplicate")}}}else"ping"!==f.operation&&this.notify({uid:a.id});this.resetManualReconnectTimer(a)}}},notify:function(a){e.sendMessage("mail:xiva:notify",a)}};return f.onReady(m),m}),define("slice/logic/main",["browser-adapter","api/manager","api/utils","api/stat","slice/logic/config","slice/logic/mail-api","slice/common-logic/timers","slice/logic/yauth","slice/logic/notify","slice/common-libs/async","slice/logic/xiva"],function(a,b,c,d,e,f,g,h,i,j){"use strict";function k(a,b){a&&a(b)}var l=2001,m="allAccountsCounter",n={_timer:null,_mailApi:null,_updateCounterDelayed:null,init:function(){this._mailApi=new f,this._updateCounterDelayed=c.debounce(this.updateAllCounters.bind(this),1e3),this._addListeners(),this._initPollingTimer(),a.log("Send user:get-all to platform"),a.sendOuterMessage("user:get-all")},_initPollingTimer:function(){this._timer=g.create(e.UPDATE_TIME_MS,this.handleTimerTick,this),this._timer.start()},_addListeners:function(){a.addListener("slice:auth:list-updated",this.handleListUpdatedEvent,this),a.addListener("slice:auth:current",this.handleAuthCurrentEvent,this),a.addListener("mail:xiva:notify",this.handleXivaNotifyEvent,this),a.addListener("mail:ui:request",this.handleRequestAllEvent,this),a.addListener("mail:ui:request-messages",this.handleRequestMessagesEvent,this),a.addListener("mail:messages:change",this.handleMessageChangeEvent,this),a.addListener("mail:compose",this.handleComposeEvent,this),a.addListener("mail:open",this.handleOpenEvent,this),a.addListener("slice-event-show",this.handleSliceShowEvent,this),a.addListener("options:change",this.handleOptionChangeEvent,this),a.addListener("slice:user:delete",this.handleUserDelete,this)},handleUserDelete:function(b,c){if(c.authorized){var d=function(){a.removeListener("slice:auth:logout",d,this),a.sendOuterMessage("user:delete",{uid:c.id})};a.addListener("slice:auth:logout",d,this),a.sendOuterMessage("user:logout",{uid:c.id})}else a.sendOuterMessage("user:delete",{uid:c.id})},finalize:function(){h.forEach(!0,this.abortRequests,this),this._timer.stop()},handleTimerTick:function(){a.log("TIMER TICK"),this.updateAllCounters()},handleSliceShowEvent:function(a,b){var c=b&&"menu"===b.sender?"menu":"button";d.logWidget(c)},handleListUpdatedEvent:function(b,c){this.sendUsers(),c.currentChanged||(a.log("update counters in list updated handler"),this.updateAllCounters())},handleAuthCurrentEvent:function(a,b){var c=h.getUser(b.oldCurrent),d=h.getUser(b.current);c&&this.abortRequests(c),this.updateUser(d)},handleXivaNotifyEvent:function(b,c){var d=h.getUser(c.uid);c.message?(a.log("New message from xiva"),this.updateAllCounters(),this.sendMessages(d),i.createNotification(d,c.message)):(a.log("New notification from xiva, call updateCounterDelayed"),this._updateCounterDelayed())},handleRequestAllEvent:function(){var b=h.getCurrentUser();if(!b)return void this.handleError();a.log("mail:ui:request: start update logic for user: "+b.login),this.updateUser(b),this.sendUsers()},handleRequestMessagesEvent:function(){var b=h.getCurrentUser();a.log("mail:ui:request-messages: start fetching messages logic for user: "+b.login),this.updateMessages(b)},handleMessageChangeEvent:function(b,c){var d=h.getCurrentUser();d.deleteMessageById(c.message.id)&&(a.log("Change message state - action: "+c.action+" id: "+c.message.id),this.sendMessages(d),d.data.count=Math.max(0,d.data.count-1),this.sendAllCounters(),this.changeMessageState(d,c.message,c.action,function(){a.log("Change message state success - action: "+c.action+" id: "+c.message.id),this._updateCounterDelayed()}.bind(this)))},handleComposeEvent:function(a,b){var c=h.getCurrentUser();this.compose(c,b)},handleOpenEvent:function(b,c){var d=h.getCurrentUser(),f=h.getUrl(d,e.URL_WEB);c&&c.message&&(f+="message?"+e.linkParam+"&ids="+encodeURIComponent(c.message.id)),a.navigate(f,"new tab")},handleOptionChangeEvent:function(a,b){b.name===m&&this.sendAllCounters()},abortRequests:function(a){if(a){var b=a.requests;for(var c in b)b.hasOwnProperty(c)&&(b[c].abort(),delete b[c])}},updateUser:function(b){b&&(a.sendMessage("mail:loading"),j.parallel([this.getUserCkey.bind(this,b),this.updateUserEmail.bind(this,b),this.updateAllCounters.bind(this)],function(a){a?(this.handleError(b,a),this.sendAllCounters()):this._updateUserMessages(b)}.bind(this)))},_updateUserMessages:function(b){b.data.count?a.isWindowVisible()&&j.series([this.updateFolders.bind(this,b),this.updateMessages.bind(this,b)]):(b.setMessages(null,!0),this.sendMessages(b))},getUserCkey:function(b,c){b&&!b.requests.getUserCkey&&(b.requests.getUserCkey=this._mailApi.getAccountInfo({user:b,callback:function(d,e){if(delete b.requests.getUserCkey,d)return this.handleError(b,d),void k(c,!0);e.ckey&&(a.log("Ckey for "+b.login+": "+e.ckey),b.data.ckey=e.ckey),k(c,null)},ctx:this}))},updateUserEmail:function(b,c){b&&!b.requests.updateUserEmail&&(b.requests.updateUserEmail=this._mailApi.getUserSettings({user:b,callback:function(d,e){delete b.requests.updateUserEmail,e&&e.email&&(a.log("Default email for "+b.login+" is - "+e.email),this.fixDisplayEmail(e.email),b.data.displayEmail=e.email,this.sendUsers()),k(c,null)},ctx:this}))},updateAllCounters:function(a){if(!h.hasAuth())return void k(a,!0);this._mailApi.getAllCounters({callback:function(b,c){if(b)return k(a,!0),void this.handleError(null,b);var d=[];c.forEach(function(a){var b=a.data.counters,c=null;a.uid&&b&&(d.push(a.uid),(c=h.getUser(a.uid))&&(c.data.count=b.unread))}),h.forEach(!0,function(a){-1===d.indexOf(a.id)&&(a.data.count=0)}),this.sendAllCounters(),this.sendUsers(),k(a,null)},ctx:this})},updateFolders:function(b,c){b&&!b.requests.updateFolders&&(b.requests.updateFolders=this._mailApi.getFolders({user:b,callback:function(d,e){if(delete b.requests.updateFolders,d)return k(c,!0),void this.handleError(b,d);b.data.folders=e,a.sendMessage("mail:folders",e),k(c,null)},ctx:this}))},updateMessages:function(b,c){b&&!b.requests.updateMessages&&(b.requests.updateMessages=this._mailApi.getMessages({user:b,callback:function(d,e){if(delete b.requests.updateMessages,d)return this.handleError(b,d),void k(c,!0);b.setMessages(e.messages,!0),this.sendMessages(b),a.log("updateMessages: new messages for user: "+b.login),k(c,null)},ctx:this}))},changeMessageState:function(a,b,c,d){a&&(a.requests.changeMessageState=this._mailApi.changeMessageState({user:a,message:b,action:c,callback:function(c){if(delete a.requests.changeMessageState,c)return k(d,!0),void this.handleMessageStateError(this,a,b);a.deleteMessageById(b.id),this.sendMessages(a),k(d,null)},ctx:this}))},compose:function(b,c){var d=h.getUrl(b,e.URL_WEB)+"compose?"+e.linkParam;c&&c.message&&(d+="&oper=reply&ids="+encodeURIComponent(c.message.id)),a.navigate(d,"new tab")},sendAllCounters:function(){var b=this._getAllUsersCounter(),c=this._getCurrentUserCounter(),d="true"===String(a.getOption(m));a.sendOuterMessage("mail:data",{count:d?b:c}),a.sendMessage("mail:counter",{currentUserCount:c,count:b||0})},_getCurrentUserCounter:function(){var a=h.getCurrentUser();return a?a.data.count||0:0},_getAllUsersCounter:function(){var a=0;return h.forEach(!0,function(b){a+=b.data.count||0},this),a},sendUsers:function(){var b=[];h.forEach(!1,function(a){b.push({id:a.id,email:a.data.displayEmail||a.email,isCurrent:a.isCurrent,authorized:a.authorized,count:a.data.count||0})},this),a.sendMessage("mail:users",b)},sendMessages:function(b){a.sendMessage("mail:messages",{messages:b.data.messages,count:b.data.count})},handleError:function(b,c){c=c||{},c.status===l&&b&&(b.data.count=0,this.sendAllCounters(),this.sendUsers()),a.sendMessage("mail:error",{status:c.status,text:c.text})},handleMessageStateError:function(a,b){a.setMessages([b]),this.sendMessages(a),this.updateAllCounters()},fixDisplayEmail:function(a){h.forEach(!1,function(b){b.data.displayEmail===a&&delete b.data.displayEmail},this)}};return b.onReady(n),n});