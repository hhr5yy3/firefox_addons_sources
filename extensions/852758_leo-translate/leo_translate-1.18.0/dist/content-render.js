(()=>{"use strict";function t(){const t=window.getComputedStyle(document.body).getPropertyValue("position");if("static"===t||""===t)return{top:0,left:0};const e=document.body.getBoundingClientRect(),n=document.documentElement.getBoundingClientRect();return{top:n.top-e.top,left:n.left-e.left}}class e{constructor(t,e,n){this.selection=t,this.behind=e,this.ahead=n}getSentence(){let t=0,e="";const n=this.allSentences;for(let o=0;o<n.length&&(e=n[o],t+=e.length,!(t>this.behind.length));o++);return e}get joinedContext(){return this.behind+this.selection+this.ahead}get allSentences(){return this.joinedContext.replace(/(.*?(?:\.|!|\?)(?:(?= +[A-Z0-9])|$))/g,"$1"+e.DELIMITER).split(e.DELIMITER)}static get DELIMITER(){return"|leo-translate-delimiter|"}}class n{constructor(t){this.range=t}getContext(){if(null===this.range)return null;const t=this.range.toString(),o=t.length,i=n.LIMIT-o;let s="",r="",l="";return o>=n.LIMIT?s=t.substr(0,n.LIMIT):(s=t,this.range.startContainer.nodeType===Node.TEXT_NODE?r=this.range.startOffset-i>=0?this.range.startContainer.textContent.substr(this.range.startOffset-i,i):this.gatherText(this.range.startContainer,this.range.startContainer.textContent.substr(0,this.range.startOffset),n.BACKWARD_DIRECTION,!0):this.range.endContainer.nodeType===Node.ELEMENT_NODE&&(r=this.gatherText(this.range.startContainer.childNodes[this.range.startOffset],"",n.BACKWARD_DIRECTION,!0)),this.range.endContainer.nodeType===Node.TEXT_NODE?l=this.range.endOffset+i<=this.range.endContainer.textContent.length-1?this.range.endContainer.textContent.substr(this.range.endOffset,i):this.gatherText(this.range.endContainer,this.range.endContainer.textContent.substr(this.range.endOffset),n.FORWARD_DIRECTION,!0):this.range.endContainer.nodeType===Node.ELEMENT_NODE&&(l=this.gatherText(this.range.endContainer.childNodes[this.range.endOffset],"",n.FORWARD_DIRECTION,!0))),new e(s,r,l)}gatherText(t,e,o,i=!1){const s=t=>o===n.BACKWARD_DIRECTION?t.previousSibling:t.nextSibling;if(-1===[n.BACKWARD_DIRECTION,n.FORWARD_DIRECTION].indexOf(o))throw new Error(`Invalid direction "${o}"`);if(n.isBlock(t)||"br"===t.nodeName.toLowerCase())return"";const r=n.LIMIT-e.length;if(r<1)throw new Error("The text is longer than LIMIT");if(!i&&t.nodeType===Node.TEXT_NODE){const i=t.textContent;o===n.BACKWARD_DIRECTION?e=i.substr(-1*r,r)+e:o===n.FORWARD_DIRECTION&&(e+=i.substr(0,r))}if(e.length>=n.LIMIT)return e;let l;if(null!==(l=(a=t).childNodes.length>0?a.childNodes[o===n.BACKWARD_DIRECTION?a.childNodes.length-1:0]:null)||null!==(l=s(t)))return n.isBlock(l)||"br"===l.nodeName.toLowerCase()?e:this.gatherText(l,e,o);{let i=t.parentNode;for(;null!==i&&!n.isBlock(i)&&"body"!==i.nodeName.toLowerCase();){if(l=s(i),null!==l){if(n.isBlock(l))break;return this.gatherText(l,e,o)}i=i.parentNode}}var a;return e}static isBlock(t){if(t.nodeType!==Node.ELEMENT_NODE)return!1;const e=window.getComputedStyle(t).getPropertyValue("display");return-1===["inline","inline-block"].indexOf(e)}static get LIMIT(){return 128}static get FORWARD_DIRECTION(){return"forward"}static get BACKWARD_DIRECTION(){return"backward"}}const o="proxy-content-open-popup",i="content-open-popup",s=new class{constructor(){this.ID="leoTranslatePopup",this.WIDTH=250,this.MARGIN_Y=3,this.DEFAULT_STYLES={position:"absolute",display:"none",border:"none",zIndex:1e10,boxShadow:"0 0 4px 0",width:`${this.WIDTH}px`,height:"67px",padding:0,margin:0},this.popup=null,this.refreshSelectionScrolls()}show(){return this.createPopup().style.display="block",this}hide(){return null!==this.popup&&(this.popup.style.display="none"),this}sendData({text:t,context:e,frameIndex:n}){const o={id:"content-data",text:t,context:e,frameIndex:n};return this.createPopup().contentWindow.postMessage(o,chrome.extension.getURL("")),this}refreshHeight(t){return this.createPopup().style.height=`${t}px`,this}refreshSelectionScrolls(){return this.selectionScrollY=window.scrollY,this.selectionScrollX=window.scrollX,this}setPosition({left:e,top:n,bottom:o=null}){n=parseInt(n)+this.selectionScrollY,e=parseInt(e)+this.selectionScrollX,o=parseInt(o)+this.selectionScrollY;const i=t(),s=this.createPopup().offsetHeight+this.MARGIN_Y,r=window.document.documentElement.clientWidth+window.scrollX+i.left,l=window.scrollY+i.top,a=e+this.WIDTH>r?r-this.WIDTH:e,h=o+s>l+window.document.documentElement.clientHeight&&n-s>l||o+s>document.body.scrollHeight+i.top?n-s:o+this.MARGIN_Y;return this.popup.style.top=`${h}px`,this.popup.style.left=`${a}px`,this}createPopup(){if(this.popup=document.getElementById(this.ID),null===this.popup){this.popup=document.createElement("iframe"),this.popup.id=this.ID;for(const t in this.DEFAULT_STYLES)this.popup.style[t]=this.DEFAULT_STYLES[t];document.body.appendChild(this.popup),this.popup.src=chrome.extension.getURL("/templates/popup-iframe.html")}return this.popup}};let r={},l={x:0,y:0},a={top:0,bottom:0,left:0};function h(t,e=null){const n=document.querySelectorAll("iframe");for(let o=0;o<n.length;o++)if(n[o].contentWindow===t)return"function"==typeof e&&e(n[o]),n[o];return null}function d(...t){const e={top:0,left:0,bottom:0};return t.forEach((t=>{e.top+=t.top,e.left+=t.left,e.bottom+=void 0===t.bottom?t.top:t.bottom})),e}chrome.runtime.onMessage.addListener((e=>{if("proxy-content-get-data"===e.id)s.sendData(r);else if("proxy-content-resize-popup"===e.id)s.refreshHeight(e.height).setPosition(a,t());else if("proxy-content-close-popup"===e.id)s.hide();else if(e.id===i||e.id===o){if(function(t){const e=2*n.LIMIT;return!(t.length>e)||(chrome.runtime.sendMessage({id:"background-show-notification",text:`The selection is too long! It must be less than ${e} characters.`}),!1)}(e.text)){const n=t();r={context:e.context,text:(c=e.text,c.replace(/[<>]/g,"")),frameIndex:-1},e.id===o?(a=d(e.rect,n),r.frameIndex=e.frameIndex,e.frameIndex>-1&&h(window.frames[e.frameIndex],(t=>{const e=t.getBoundingClientRect();a=d(a,{top:e.top,left:e.left})}))):e.id===i&&(a=d({top:l.y,left:l.x},n)),s.refreshSelectionScrolls().show().sendData(r).setPosition(a,t())}document.getElementById(s.ID).blur(),r.frameIndex>-1&&window.frames[r.frameIndex].focus()}else"proxy-content-mouse"===e.id&&(l={x:e.x,y:e.y},e.frameIndex>-1&&h(window.frames[e.frameIndex],(t=>{const e=t.getBoundingClientRect();l.x+=e.left,l.y+=e.top})));var c}))})();