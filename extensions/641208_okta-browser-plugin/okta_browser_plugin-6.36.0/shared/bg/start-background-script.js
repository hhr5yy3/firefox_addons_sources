const startBackgroundScript=function(p,g,l,h){const k=1e3,y=Okta.Q,o=y.when,T=Okta.fn.storage.wrapVal,m=Okta.fn.base.timestamp,{getToSettings:s,prependPath:n,setSessionData:a}=Okta.fn.api,{getOAuthUris:P,toQueryParams:b}=Okta.fn.authUtil,{isOktaPersonalAccount:i,removeTrailingSlash:f}=Okta.fn.url,{first:u,filter:d,isUndefined:v}=Okta._okta,S=e=>"_lock_"+e,C=()=>v(p.isInstalledByUser)?y(!0):p.isInstalledByUser(),c=(e,t,r,o)=>{switch(e){case"getSessionState":return g.get(r.key);case"setSessionState":return g.set(r.key,r.val);case"clearAllSessionState":return g.clearAll(),r.result=!0,r;case"getPersistentState":return l.get(r.key);case"setPersistentState":return l.set(r.key,r.val);case"clearPersistentState":return l.clear&&l.clear(),r.result=!0,r.browserType=p.getType(),r;case"requestPrivacyPermissions":return v(p.requestPrivacyPermissions)?y({errorCode:"requestPrivacyPermissions is not supported on "+p.getType()}):p.requestPrivacyPermissions();case"getTabId":return t;case"getTabInfo":return v(p.getTabInfo)?y({errorCode:"not supported by this version of the plugin"}):p.getTabInfo(t);case"documentLoaded":return v(p.documentLoaded)?y({errorCode:"not supported by this version of the plugin"}):p.documentLoaded(t,o);case"getBrowserType":return p.getType();case"getBackgroundVersion":return p.getBackgroundVersion();case"unlockSessionKey":return i=r.key,g.set(S(i),null),!0;case"lockSessionKey":return s=r.key,n=m(),a=S(s),(!(s=g.get(a))||n>s.lockTime+k)&&(g.set(a,{lockTime:n}),!0);case"request":return h.ajax(r);case"refreshAccessToken":i=r?r.refresh_token:null;if(i){s=i.refreshToken,a=i.clientId,n=i.issuer;const u=i.tokenUrl,d={grant_type:"refresh_token",client_id:a,refresh_token:s};const c="undefined"!=typeof chrome?chrome:null;if(!c)return y(null);if(3<=c.runtime.getManifest().manifest_version){s=987654321;return c.declarativeNetRequest.updateSessionRules({removeRuleIds:[s],addRules:[{id:s,action:{type:"modifyHeaders",responseHeaders:[{header:"Access-Control-Allow-Origin",operation:"set",value:Okta.window.location.origin}],requestHeaders:[{header:"Origin",operation:"set",value:f(n)},{header:"Referer",operation:"set",value:n}]},condition:{urlFilter:"|"+n+P().tokenUri,initiatorDomains:[Okta.window.location.hostname],resourceTypes:["xmlhttprequest"]}}]}).then(()=>h.ajax({url:u,type:"post",contentType:"application/x-www-form-urlencoded",data:b(d),headers:{Accept:"application/json"}})).catch(function(){return null})}return y(null)}return y(null);case"openTab":return p.openTab(r.url);case"hasPrivacyPermissions":return p.hasPrivacyPermissions?p.hasPrivacyPermissions():y(T(!0));case"openPermissionsPage":return p.openPermissionsPage?p.openPermissionsPage():y({errorCode:"openPermissionsPage is not supported on "+p.getType()});case"openSettingsPage":return p.openSettingsPage?p.openSettingsPage():y({errorCode:"openSettingsPage is not supported on "+p.getType()});case"openOktaNewtab":return p.openOktaNewtab?p.openOktaNewtab():y({errorCode:"openOktaNewtab is not supported on "+p.getType()});case"servePopover":return p.servePopover?p.servePopover():y({errorCode:"servePopover is not supported on "+p.getType()});case"suppressSavePassword":return p.suppressSavePassword?p.suppressSavePassword(t,r):y({errorCode:"suppressSavePassword is not supported on "+p.getType()});case"getPasswordSavingDetails":return p.getPasswordSavingDetails?p.getPasswordSavingDetails():y({errorCode:"getPasswordSavingDetails is not supported on "+p.getType()});case"openTabForAccountChooser":return v(p.openTabForAccountChooser)?y({errorCode:"not supported by this version of the plugin",url:r.url}):p.openTabForAccountChooser(r.url);case"closeTab":return p.closeTab(t);case"getCookies":return v(p.getCookies)?y({errorCode:"not supported by this version of the plugin"}):p.getCookies(r.key.hostUrl,r.key.cookieNames,t);case"getLocalStorageUsage":return v(p.getLocalStorageUsage)?y({errorCode:"not supported by this version of the plugin"}):p.getLocalStorageUsage().fail(e=>y({errorCode:"failed to get the local storage usage: "+e}));case"updateBadge":return v(p.updateBadge)?y.resolve():p.updateBadge(r.key);case"downloadExtensionLogs":return v(p.downloadExtensionLogs)?y.resolve():p.downloadExtensionLogs(r.key);case"setUninstallURL":return v(p.setUninstallURL)?y.resolve():p.setUninstallURL(r.url||"");case"isInstalledByUser":return C();case"injectContentScript":return p.injectContentScript&&p.injectContentScript(t,o),y();case"getSessionTabState":return g.get(r.key+"_"+t);case"sendMsgToCurrentTab":return v(p.sendMsgToCurrentTab)?y({errorCode:"sendMsgToCurrentTab not supported on "+p.getType()}):p.sendMsgToCurrentTab(r);case"getUserPinned":return v(p.getUserPinned)?y({errorCode:"getUserPinned not supported on "+p.getType()}):p.getUserPinned();case"openPopup":return v(p.openPopup)?y({errorCode:"openPopup not supported on "+p.getType()}):p.openPopup(r.key);case"getAccessTokenFromBackground":return v(p.getAccessTokenFromBackground)?y({errorCode:"getAccessTokenFromBackground not supported on "+p.getType()}):p.getAccessTokenFromBackground(r,t);case"shouldInjectThrushFutureContentScript":return v(ThrushFuture.Preload)?y(T(!1)):ThrushFuture.Preload.isThrushFutureEnabled().then(e=>y(T(e)));case"computeSHA256":return crypto&&crypto.subtle?O(r.key):y({errorCode:"WebCrypto not avaliable"});default:return y({errorCode:"Unknown msg type: "+e})}var s,n,a,i};p.on("injectReady",e=>{p.injectScript(e,null)}),p.on("messageFromContent",t=>{const r=t.msg;var e=c(r.type,t.tabId,r.data,t.frameId);o(e,e=>{p.post({msg:{id:r.id,type:r.type,data:e},tabId:t.tabId,portInfo:t.portInfo})}).done()}),addEventListener("thrush-future/messageFromContent",e=>{const t=e.detail,r=t.msg;e=c(r.type,t.tabId,r.data,t.frameId);o(e,e=>{dispatchEvent(new CustomEvent("thrush-future/messageFromContent/response",{detail:{msg:{id:r.id,type:r.type,data:e},tabId:t.tabId}}))}).done()});const w=e=>{l.set("PENDO_ONBOARDING_DATA",{sentTo:e,timestamp:m()})},O=async e=>{const t=new TextEncoder;e=t.encode(e),e=await crypto.subtle.digest("SHA-256",e);const r=Array.from(new Uint8Array(e));return r.map(e=>e.toString(16).padStart(2,"0")).join("")};p.on("postInstall",()=>(l.set("ONBOARDING_FLOW",!0),C().then(r=>p.tryOktaPersonalPasswordlessPostInstall().then(e=>{if(e&&0<e.length){const t=u(e);e=t.url||null,e=e?new URL(e).origin:null;if(e&&i(e))return Okta.window.setTimeout(()=>{p.highlightAndRefreshTab(t.id)},500),y(null)}return Okta.Config.onboardingLaunchNewTab&&r?p.getOrgsWithSessionCookies():y(null)})).then(e=>{if(e)if(e.oktaAccounts&&0!==e.oktaAccounts.length){var t=1===e.oktaAccounts.length;if(!e.sessions||0===e.sessions.length)return p.openTab(t?u(e.oktaAccounts).origin+"/login/login.htm":"https://login.okta.com"),void w(t?"orgLogin":"oktaLogin");var r=d(e.sessions,e=>void 0!==e.tabId);if(!t&&0===r.length)return p.openTab("https://login.okta.com"),void w("oktaLogin");const o=u(t?e.sessions:r);r=s(o.domain+n("/settings"),{backgroundVersion:p.getBackgroundVersion(),contentVersion:""});a({sid:o.sid,DT:o.dt,idx:o.idx},r.headers),h.ajax(r).then(e=>{e?(l.set("PLUGIN_SETTINGS",{override:{},orgSettings:e}),e.pluginOnboardingEnabled?void 0!==o.tabId&&o.isDashboardTab?(p.highlightAndRefreshTab(o.tabId),w("refreshDashboard")):(p.openTab(o.domain+"/app/UserHome"),w("openDashboard")):w("none")):w("none")})}else w("zeroOrgs")})))};Okta.startBackgroundScript=startBackgroundScript;