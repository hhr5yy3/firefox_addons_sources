let ignoredHostnames=["login.id.tim.it"],isHidden=null,lastProductId="";function getBuyonData(){chrome.runtime.sendMessage({command:"cashback-data",url:document.location.href,title:document.title},(function(e){null!=e&&chrome.runtime.sendMessage({command:"price-tracker-site-data",url:document.location.href},(function(t){getPricetrackerProduct(t?.site,(function(n){let o={buyon:e?.buyon,trackingTabData:e?.trackingTabData,giftcard:e?.giftcard,codicesconto:e?.codicesconto,pricetrackerSite:t?.site,pricetrackerProduct:n};canOpenBuyonNotification(o)&&(openBuyonNotification(o),t&&monitorProductChanges(t?.site,o)),e&&e.trackingTabData&&e.trackingTabData.lostTrackingAlert&&(openTrackingAlert(),chrome.runtime.sendMessage({command:"restore-tracking",hidden:!0}))}))}))}))}function monitorProductChanges(e,t){setInterval((function(){getPricetrackerProduct(e,(function(e){e&&(t.pricetrackerProduct=e,document.getElementById("buyon-widget").remove(),openBuyonNotification(t))}))}),1e3)}function canOpenBuyonNotification(e){var t=!1;if(e.trackingTabData&&e.trackingTabData.isWhitelisted&&(!e.buyon||!e.buyon.sameSite))return!1;if(e.buyon&&(t=!0),e.giftcard&&(t=!0),e.codicesconto&&(t=!0),e.pricetrackerProduct){var n=!1;e.pricetrackerProduct.price>0&&e.pricetrackerProduct.found&&e.pricetrackerSite.hasFeed&&(n=!0),n?t=!0:(e.pricetrackerSite=null,e.pricetrackerProduct=null)}return t}function getPricetrackerProduct(e,t){if(e)if(e&&e.productIdRule&&e.priceRule)try{var n=e.productIdRule.substr(0,e.productIdRule.indexOf(":")),o=e.productIdRule.substr(e.productIdRule.indexOf(":")+1),r="";if("xpath"==n){var a=null,c=o.indexOf(">>regex:");if(-1!==c&&(a=o.substr(c+8),o=o.substr(0,c)),r=document.evaluate(o,document,null,XPathResult.STRING_TYPE,null).stringValue,a){var d=new RegExp(a),l=r.match(d);r=l&&l.length>=2?l[1]:""}}else if("regex"==n){var u=document.querySelector("link[rel='canonical']"),s=u?u.href:document.location.href.split("#")[0];d=new RegExp(o),l=s.match(d);r=l&&l.length>=2?l[1]:""}else if("json"==n){let e=document.querySelectorAll('script[type="application/ld+json"]');for(i=0;i<e.length;i++){try{let t=JSON.parse(e[i].innerText.replace(/\n/g," ").trim().replace(/\;+$/g,""));r=findProp(t,o)}catch{r=""}if(r)break}}if(!r||r==lastProductId)return void t(null);lastProductId=r;let p="",m=-1,f=e.priceRule.substr(0,e.priceRule.indexOf(":")),h=e.priceRule.substr(e.priceRule.indexOf(":")+1);if("xpath"==f)p=document.evaluate(h,document,null,XPathResult.STRING_TYPE,null).stringValue,m=guessPrice(p);else if("json"==f){let e=document.querySelectorAll('script[type="application/ld+json"]');for(i=0;i<e.length;i++)try{let t=JSON.parse(e[i].innerText.replace(/\n/g," ").trim().replace(/\;+$/g,""));if(p=String(findProp(t,h)),p&&(m=guessPrice(p),m>0))break}catch{}}chrome.runtime.sendMessage({command:"price-tracker-product-data",idMerchant:e.idMerchant,productId:r,price:m},(function(e){t(e?{found:e.found,id:e.id,price:m,productId:r}:null)}))}catch(e){t(null)}else t(null);else t(null)}function openBuyonNotification(e){let t=navigator.userAgent.toLowerCase().indexOf("firefox")>-1?"firefox":"chrome",n=document.location.hostname.replace("www.",""),o=document.querySelector("link[rel='canonical']"),r=o?o.href:document.location.href.split("#")[0],a="_nob",c=getCookieValueByName(a),d=c?c.split(","):[],l=d.slice();isHidden=!0;let u=[];for(e.buyon&&u.push("bo"),e.giftcard&&u.push("gc"),e.codicesconto&&u.push("cs"),e.pricetrackerProduct&&e.pricetrackerProduct.price>0&&u.push("pt"),i=0;i<u.length;i++)d.includes(u[i])||(d.push(u[i]),isHidden=!1);e.giftcard&&!l.includes("gc")&&(l.push("gc"),setBuyOnCookie(a,l.join(","))),e.buyon&&e.buyon.fromBuyon&&(isHidden=!1,l.includes("bo")||(l.push("bo"),setBuyOnCookie(a,l.join(",")))),c=d.join(",");let s=document.createElement("div");s.id="buyon-widget",s.style.fontSize="14px",s.style.lineHeight="normal";let p=document.createElement("style");p.appendChild(document.createTextNode(`\n    @font-face { font-family: 'Montserrat'; src: url('${chrome.runtime.getURL("fonts/Montserrat-Regular.ttf")}') format('truetype'); font-style: normal; font-weight: 400; }\n    @font-face { font-family: 'Montserrat'; src: url('${chrome.runtime.getURL("fonts/Montserrat-Bold.ttf")}') format('truetype'); font-style: normal; font-weight: 700; }\n  `)),s.appendChild(p);let m=s.attachShadow({mode:"open"}),f=document.createElement("style");f.appendChild(document.createTextNode("\n    :host { display: block!important; box-sizing: border-box; }\n    :host * { font-family: Montserrat, 'Helvetica Neue', Helvetica, Arial, sans-serif!important; }\n    .buyon-content { position: relative; padding: 8px 16px 16px 16px; border-top-left-radius: 10px; border-top-right-radius: 10px; background-color: #ff6d06; color: #fff; }\n    .buyon-btn-white { text-decoration: none; margin: 0; display: block; border-radius: 3px; padding: 6px; line-height: 1.3333333; text-align: center; font-weight: 700; outline: 0; font-size: 13px; transition: all .2s linear; background-color: #fff; border: 1px solid #fff; color: #ff6d06; cursor: pointer; }\n    .buyon-btn-white:hover { background-color: #f0f0f0; border-color: #f0f0f0; }\n    .buyon-btn-outline { text-decoration: none; margin: 0; display: block; border-radius: 3px; padding: 6px; line-height: 1.3333333; text-align: center; font-weight: 700; outline: 0; font-size: 13px; transition: all .2s linear; background-color: transparent; border: 1px solid #fff; color: #fff; cursor: pointer; }\n    .buyon-btn-outline:hover { background-color: rgba(255,255,255,.2); }\n    .buyon-close { font-weight: bold; color: #ff6d06; background-color: #fff; text-decoration: none; transition: all 0.2s linear; display: flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; font-size: 10px; margin-left: 4px; }\n    .buyon-share { cursor: pointer; height: 16px; background-color: #fff; border-radius: 10px; display: flex; align-items: center; font-size: 8px; font-weight: 700; text-decoration: none; padding: 0 8px; color: #ff6d06; transition: all .2s linear; }\n    .buyon-close:hover, .buyon-share:hover { background-color: #f0f0f0; }\n    .buyon-logo-cont { cursor: pointer; position: absolute; top: -48px; width: 70px; height: 48px; left: 50%; transform: translateX(-50%); background-color: #ff6d06; border-top-left-radius: 10px; border-top-right-radius: 10px; text-align: center; border-bottom: 1px solid #ff6d06; }\n    .buyon-logo-cont > img { width: 32px; margin-top: 10px; }\n    .buyon-round-corner { position: absolute; bottom: -1px; width: 10px; height: 10px; cursor: default; pointer-events: none; font-size: 0; border-bottom: 1px solid #ff6d06; }\n    .buyon-round-left { left: -10px; }\n    .buyon-round-right { right: -10px; }\n    .buyon-top-cont { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 12px; }\n    .buyon-whitelisted { background-color: #81c868; }\n    .buyon-whitelisted .buyon-logo-cont { background-color: #81c868; border-bottom: 1px solid #81c868; }\n    .buyon-whitelisted .buyon-btn-white, .buyon-whitelisted .buyon-close, .buyon-whitelisted .buyon-share { color: #81c868; }\n    .buyon-whitelisted .fill { fill: #81c868; }\n    .buyon-whitelisted .buyon-round-corner { border-color: #81c868; }\n    @keyframes buyonPopIn { 0% { transform: translate(-50%, calc(100% + 24px)); } 100% { transform: translate(-50%, 0); } }\n    @keyframes buyonPopOut { 0% { transform: translate(-50%, 0); } 100% { transform: translate(-50%, calc(100% + 24px)); } }\n    @media print { .buyon-content { display: none!important; } }\n  ")),m.appendChild(f);let h=document.createElement("div");h.style.position="fixed",h.style.bottom="0",h.style.left="50%",h.style.transform="translate(-50%, calc(100% + 24px))",h.style.width="260px",h.style.zIndex="65535",m.appendChild(h);let b=document.createElement("div");b.className="buyon-content",h.appendChild(b);let y=document.createElement("div");y.className="buyon-logo-cont";let g=document.createElement("img");g.src=chrome.runtime.getURL("images/buyon-icon-white.svg"),y.appendChild(g);let x=new DOMParser,k=document.createElement("div");k.className="buyon-round-corner buyon-round-left";let v=x.parseFromString('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="fill: #ff6d06"><mask id="m" fill="#fff"><rect id="r" width="50" height="50" /><circle id="c" r="50" fill="#000" /></mask><use xlink:href="#r" class="fill" mask="url(#m)" /></svg>',"image/svg+xml").documentElement;k.appendChild(v),y.appendChild(k);let C=document.createElement("div");C.className="buyon-round-corner buyon-round-right";let w=x.parseFromString('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="fill: #ff6d06" transform="scale(-1, 1)"><mask id="m" fill="#fff"><rect id="r" width="50" height="50" /><circle id="c" r="50" fill="#000" /></mask><use xlink:href="#r" class="fill" mask="url(#m)" /></svg>',"image/svg+xml").documentElement;C.appendChild(w),y.appendChild(C),y.onclick=function(){isHidden?(document.cookie=`${a}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`,h.style.animation="buyonPopIn 0.5s forwards",isHidden=!1):(setBuyOnCookie(a,c),h.style.animation="buyonPopOut 0.5s forwards",isHidden=!0)},b.appendChild(y);let E=document.createElement("div");E.className="buyon-top-cont";let N=document.createElement("div");N.appendChild(document.createTextNode("Cashback "));var T=document.createElement("b");e.trackingTabData&&e.trackingTabData.isWhitelisted?(b.classList.add("buyon-whitelisted"),T.appendChild(document.createTextNode(" attivo"))):T.appendChild(document.createTextNode(" non attivo")),N.appendChild(T),E.appendChild(N);let P=document.createElement("div");if(P.style.display="flex",e.buyon&&!e.buyon.merchant.noDeeplink&&n==e.buyon.merchant.hostname){var $=`https://www.buyon.it/link/nuovo?m=${e.buyon.merchant.idTdMerchant}&url=${encodeURIComponent(r)}`;let o=document.createElement("a");o.className="buyon-share",o.href=`${$}&utm_source=buyon&utm_medium=extension&utm_campaign=${t}&utm_term=link&utm_content=${n}`,o.appendChild(document.createTextNode("CONDIVIDI")),P.appendChild(o)}let I=document.createElement("a");if(I.className="buyon-close",I.href="javascript:;",I.appendChild(document.createTextNode("✕")),I.onclick=function(){setBuyOnCookie(a,c),h.style.animation="buyonPopOut 0.5s forwards",isHidden=!0},P.appendChild(I),E.appendChild(P),b.appendChild(E),e.buyon&&e.buyon.fromBuyon){let e=document.createElement("div");e.style.textAlign="center",e.appendChild(document.createTextNode("Per ricevere il cashback devi accettare i "));let t=document.createElement("u");t.appendChild(document.createTextNode("cookie")),e.appendChild(t),e.appendChild(document.createTextNode(" e verificare che questa icona resti "));let n=document.createElement("u");n.appendChild(document.createTextNode("verde")),e.appendChild(n),e.appendChild(document.createTextNode("!")),b.appendChild(e)}else{if(e.buyon&&(!e.trackingTabData||!e.trackingTabData.isWhitelisted)){let o=document.createElement("div");o.style.marginTop="4px";let r=document.createElement("a");r.className="buyon-btn-white";let i="Attiva cashback";e.buyon.merchant.cashback&&(i=`${i} ${e.buyon.merchant.cashback}`),r.appendChild(document.createTextNode(i)),r.href=`${e.buyon.merchant.url}?utm_source=buyon&utm_medium=extension&utm_campaign=${t}&utm_term=cashback&utm_content=${n}`,o.appendChild(r),b.appendChild(o)}if(e.buyon&&e.buyon.sameSite&&e.trackingTabData&&e.trackingTabData.isWhitelisted&&!e.pricetrackerProduct){let e=document.createElement("div");e.style.marginTop="4px";let t=document.createElement("a");t.className="buyon-btn-white",t.appendChild(document.createTextNode("Hai completato l'acquisto?")),t.href="javascript:;",t.onclick=function(){chrome.runtime.sendMessage({command:"open-buyon-url"})},e.appendChild(t),b.appendChild(e)}if(e.giftcard){let o=document.createElement("div");o.style.marginTop="4px";let r=document.createElement("a");r.className="buyon-btn-white",r.appendChild(document.createTextNode(`Gift card cashback ${e.giftcard.merchant.cashback.toFixed(2).replace(".",",")}${e.giftcard.merchant.currency}`)),r.href=`${e.giftcard.merchant.realUrl}?utm_source=buyon&utm_medium=extension&utm_campaign=${t}&utm_term=gift-card&utm_content=${n}`,o.appendChild(r),b.appendChild(o)}if(e.codicesconto){let o=document.createElement("div");o.style.marginTop="4px";let r=document.createElement("a");r.className="buyon-btn-white",r.appendChild(document.createTextNode(`${e.codicesconto.merchant.totalCodes} codic${1==e.codicesconto.merchant.totalCodes?"e":"i"} sconto`)),r.href=`${e.codicesconto.merchant.realUrl}?utm_source=buyon&utm_medium=extension&utm_campaign=${t}&utm_content=${n}&buyon=1`,o.appendChild(r),b.appendChild(o)}if(e.pricetrackerProduct&&e.pricetrackerProduct.price>0){let o=`https://www.buyon.it/price-tracker/nuovo?price=${Math.round(100*e.pricetrackerProduct.price)}`;e.pricetrackerProduct.found?o+=`&id=${encodeURIComponent(e.pricetrackerProduct.id)}`:o+=`&m=${e.pricetrackerSite.idMerchant}&productId=${encodeURIComponent(e.pricetrackerProduct.productId)}&url=${encodeURIComponent(url)}`,o=`${o}&utm_source=buyon&utm_medium=extension&utm_campaign=${t}&utm_term=price-tracker&utm_content=${n}`;let r=document.createElement("div");r.style.marginTop="4px";let i=document.createElement("a");i.className="buyon-btn-outline",i.appendChild(document.createTextNode("Avverti se il prezzo scende")),i.href=o,r.appendChild(i),b.appendChild(r)}}h.style.opacity=0,isHidden||(h.style.animation="buyonPopIn 0.5s forwards"),setTimeout((function(){h.style.opacity=1}),100),document.body.parentElement.appendChild(s)}function openTrackingAlert(){let e=document.createElement("div");e.id="buyon-alert",e.style.fontSize="14px",e.style.lineHeight="normal";let t=document.createElement("style");t.appendChild(document.createTextNode(`\n    @font-face { font-family: 'Montserrat'; src: url('${chrome.runtime.getURL("fonts/Montserrat-Regular.ttf")}') format('truetype'); font-style: normal; font-weight: 400; }\n    @font-face { font-family: 'Montserrat'; src: url('${chrome.runtime.getURL("fonts/Montserrat-Bold.ttf")}') format('truetype'); font-style: normal; font-weight: 700; }\n  `)),e.appendChild(t),e.style.position="fixed",e.style.width="100vw",e.style.height="100vh",e.style.top="0",e.style.left="0",e.style.zIndex="65535";let n=e.attachShadow({mode:"open"}),o=document.createElement("style");o.appendChild(document.createTextNode("\n    :host { display: block!important; box-sizing: border-box; }\n    :host * { font-family: Montserrat, 'Helvetica Neue', Helvetica, Arial, sans-serif!important; }\n    .buyon-backdrop { position: fixed; top: 0; right: 0; bottom: 0; left: 0; background-color: #000; opacity: .5; z-index: 1040; }\n    .buyon-alert { box-sizing: border-box; padding: 10px; position: relative; background-color: #fff; z-index: 1050; width: 600px; min-width: 480px; max-width: 100%; margin: 30px auto; border-radius: 2px; color: #505458; text-align: center; max-height: calc(100vh - 30px); overflow-y: auto; }\n    .buyon-alert-content { border: 1px solid #ff6d06; border-radius: 8px; padding: 30px 90px; }\n    .buyon-alert-animated-icon-cont { overflow: hidden; height: 36px; text-align: center; margin: 20px 80px; border-bottom: 1px solid rgba(0,0,0,.2); }\n    .buyon-alert-animated-icon-cont > div { width: 105px; border-top-left-radius: 15px; border-top-right-radius: 15px; display: inline-block; background-color: #81c868; transform: translateY(36px); animation: buyonAlertIconPopIn 1s ease .5s 1 normal forwards; }\n    .buyon-alert-animated-icon-cont > div > img { width: 48px; margin-top: 15px; }\n    .buyon-alert-actions-cont { margin-top: 30px; }\n    .buyon-alert-button-ok { padding: 10px 16px; font-size: 18px; line-height: 1.3333333; border-radius: 23px; outline: 0 !important; text-decoration: none; display: inline-block; background-color: #ff6d06; border: 1px solid #ff6d06; color: #fff; margin-bottom: 10px; }\n    .buyon-alert-button-ko { color: #337ab7 !important; text-decoration: none; }\n    h1 { margin: 0 0 10px 0; color: #505458; }\n    @keyframes buyonAlertIconPopIn { 0% { transform: translateY(36px); } 100% { transform: translateY(0); } }\n  ")),n.appendChild(o);let r=document.createElement("div");r.className="buyon-backdrop",n.appendChild(r);let i=document.createElement("div");i.className="buyon-alert",n.appendChild(i);let a=document.createElement("div");a.className="buyon-alert-content",i.appendChild(a);let c=document.createElement("h1");c.appendChild(document.createTextNode("Attenzione!")),a.appendChild(c);let d=document.createElement("div");d.appendChild(document.createTextNode("Ti trovi su una pagina diversa da quella aperta da BuyOn.")),a.appendChild(d);let l=document.createElement("div");l.className="buyon-alert-animated-icon-cont";let u=document.createElement("div");l.appendChild(u);let s=document.createElement("img");s.src=chrome.runtime.getURL("images/buyon-icon-white.svg"),u.appendChild(s),a.appendChild(l);let p=document.createElement("div");p.appendChild(document.createTextNode("Controlla sempre che l'icona sia verde altrimenti il cashback potrebbe non funzionare.")),a.appendChild(p);let m=document.createElement("br");a.appendChild(m);let f=document.createElement("div");f.className="buyon-alert-actions-cont";let h=document.createElement("div"),b=document.createElement("a");b.className="buyon-alert-button-ok",b.href="javascript:;",b.onclick=function(){document.body.parentElement.removeChild(e),chrome.runtime.sendMessage({command:"restore-tracking",hidden:!1})},b.appendChild(document.createTextNode("Continua con il cashback")),h.appendChild(b),f.appendChild(h);let y=document.createElement("div"),g=document.createElement("a");g.appendChild(document.createTextNode("Prosegui senza cashback")),g.className="buyon-alert-button-ko",g.href="javascript:;",g.onclick=function(){document.body.parentElement.removeChild(e),chrome.runtime.sendMessage({command:"close-buyon-alert"})},y.appendChild(g),f.appendChild(y),a.appendChild(f),e.style.opacity=0,e.style.transition="all 0.2s ease",setTimeout((function(){e.style.opacity=1}),1),document.body.style.overflow="hidden",document.body.parentElement.appendChild(e)}function guessPrice(e){if(!e)return-1;var t=(e=e.replace("€","").trim()).indexOf("."),n=e.indexOf(",");e=n>=t?e.replace(".","").replace(",","."):e.replace(",","");var o=new RegExp("^[0-9]+([.]?([0-9]+))?$");if(!e.match(o))return-1;var r=parseFloat(e);return isNaN(r)&&(r=-1),r}function setBuyOnCookie(e,t){let n=new Date,o=new Date(n.getTime()+864e5);document.cookie=`${e}=${t}; expires=${o.toGMTString()}; path=/`}function getCookieValueByName(e){let t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?t[2]:""}function findProp(e,t,n){void 0===n&&(n=null),t=t.split(".");for(var o=0;o<t.length;o++){if(void 0===e[t[o]])return n;e=e[t[o]]}return e}ignoredHostnames.includes(document.location.hostname)||getBuyonData();