{"version":3,"file":"index.serp-f7f582d1.js","sources":["../../../../src/serp/assets/serp.white.inline.svg","../../../../src/serp/assets/serp.black.inline.svg","../../../../src/serp/widget/index.ts","../../../../src/serp/index.serp.ts"],"sourcesContent":["export default \"__VITE_ASSET__ecc2fd79__\"","export default \"__VITE_ASSET__173ad0b1__\"","import styles from './widget.module.scss';\nimport logo from '~A/icons/logo.svg';\nimport serpLigth from '../assets/serp.white.inline.svg';\nimport serpDark from '../assets/serp.black.inline.svg';\n\nimport { serpShopsData } from '~B/storage';\nimport Browser from 'webextension-polyfill';\n\nimport { metricSerpApi } from '~F/app/api/metrics/metricsSerp.api';\nimport { metricSerpCholloApi } from '~F/app/api/metrics/metricsSerpChollo.api';\n\nimport { collectMetrics } from '~F/app/api/metrics/utils';\n\nmetricSerpApi.connect();\nmetricSerpCholloApi.connect();\nconst googleInput = document.getElementById('APjFqb') as HTMLTextAreaElement;\nlet userSearchValue = googleInput.value;\nconst cholloWidget = () => {\n    const widget = document.createElement('div');\n    widget.id = 'cholloFind';\n    widget.classList.add(styles.root, styles.darkTheme, styles.lightTheme, styles.cholloShop);\n    const icon = window.matchMedia('(prefers-color-scheme: dark)').matches ? serpDark : serpLigth;\n    const iconPath = import.meta.env.DEV\n        ? 'http://localhost:5173/' + icon\n        : Browser.runtime.getURL(icon);\n    widget.innerHTML = `<img src=\"${iconPath}\" />`;\n    return widget;\n};\nconst shopMatchWidget = ({\n    offers,\n    vouchers,\n    merchandDomain,\n}: {\n    offers: number;\n    vouchers: number;\n    merchandDomain?: string;\n}) => {\n    if (offers === 0 && vouchers === 0) return document.createElement('span');\n    const widget = document.createElement('div');\n    widget.addEventListener('click', () => {\n        // go to search input and enter shop:chollometro\n\n        const sendInputButton = document.querySelector(\n            'button[jsname=\"Tg7LZd\"]',\n        ) as HTMLInputElement;\n\n        if (userSearchValue.match(/\\w+\\schollometro\\s\\w+\\.(es|com)/)) {\n            userSearchValue = userSearchValue.replace(/(\\w+\\.(es|com)$)/, merchandDomain as string);\n            metricSerpApi.methods.metricSerpShop({\n                name: 'ext-event-redirect-serp',\n                data: {\n                    //  query: userSearchValue.replace(/\\schollometro\\s\\w+\\.(es|com)$/, ''),\n                    targetUrl: merchandDomain,\n                },\n            });\n            googleInput.value = userSearchValue;\n        } else {\n            metricSerpApi.methods.metricSerpShop({\n                name: 'ext-event-redirect-serp',\n                data: {\n                    //  query: userSearchValue,\n                    targetUrl: merchandDomain,\n                },\n            });\n            googleInput.value = userSearchValue + ' ' + 'chollometro' + ' ' + merchandDomain;\n        }\n\n        sendInputButton.click();\n    });\n    widget.id = 'cholloSerp';\n    widget.classList.add(styles.root, styles.darkTheme, styles.lightTheme, styles.shopMatch);\n    const dataHtml = (data: number, label: 'cupones' | 'ofertas') => {\n        const getDataByLabel = (label: 'cupones' | 'ofertas') => {\n            switch (label) {\n                case 'ofertas':\n                    return offers;\n                case 'cupones':\n                    return vouchers;\n            }\n        };\n        const getLabelByData = (quantity: number, label: 'cupones' | 'ofertas') => {\n            switch (label) {\n                case 'cupones':\n                    return quantity > 1 ? 'cupones' : 'cupÃ³n';\n                case 'ofertas':\n                    return quantity > 1 ? 'ofertas' : 'oferta';\n            }\n        };\n        return data > 0\n            ? `<span class=\"${styles[label]}\">${getDataByLabel(label)} </span>${getLabelByData(\n                  data,\n                  label,\n              )}`\n            : '';\n    };\n    const sepHtml = (ofertas: number, cupones: number) =>\n        ofertas > 0 && cupones > 0 ? `<span class=\"${styles.bullet}\">&bull;</span>` : '';\n    widget.innerHTML = `<span class=\"${styles.logo}\"> <img src=\"${\n        import.meta.env.DEV ? 'http://localhost:5173/' + logo : Browser.runtime.getURL(logo)\n    }\" /></span><div class=\"${styles.pepperData}\"> ${dataHtml(vouchers, 'cupones')}\n    ${sepHtml(offers, vouchers)}\n    ${dataHtml(offers, 'ofertas')}\n    </div>`;\n    return widget;\n};\n\nconst { shops } = await serpShopsData.get();\nconst noNullShops = shops.filter((elm) => elm.merchantDomain !== null && elm.merchantDomain !== '');\n\nexport function insertWidget(where: string, isScroll?: boolean) {\n    const domWhere = document.querySelectorAll(where);\n    const CHOLLOHOST = 'chollometro.com';\n    //insertViteBundledCss(document.body);\n    domWhere.forEach((elm, index) => {\n        const urlShopInfo = elm.querySelector('cite[role=\"text\"]');\n\n        const domStr = urlShopInfo?.textContent;\n\n        if (domStr?.includes(CHOLLOHOST) && !elm.parentElement.querySelector('#cholloFind')) {\n            elm.insertAdjacentElement('afterbegin', cholloWidget());\n            const highLightElement = urlShopInfo?.parentElement?.parentElement;\n            highLightElement?.classList.add(styles.root, styles.highLine);\n            if (userSearchValue.match(/\\w+\\schollometro\\s\\w+\\.(es|com)/)) {\n                const goTocholloMetricElement =\n                    highLightElement?.parentElement?.parentElement?.parentElement;\n                goTocholloMetricElement.addEventListener(\n                    'click',\n                    async function (e) {\n                        e.preventDefault();\n                        const metricData = await collectMetrics();\n                        const targetElm = this;\n                        await metricSerpCholloApi.methods.metricSerpToChollo({\n                            name: 'ext-event-redirect-serp-chollometro',\n                            data: {\n                                username: metricData?.username,\n                                platform: metricData?.platform,\n                                order: isScroll ? domWhere.length + index : index + 1,\n                                version: metricData?.version,\n                                targetUrl: (targetElm as HTMLAnchorElement).href,\n                            },\n                        });\n\n                        location.href = (targetElm as HTMLAnchorElement).href;\n                    },\n                    true,\n                );\n            }\n\n            return;\n        }\n        const shopMatch = noNullShops.find((elm) => {\n            return domStr?.includes(elm.merchantDomain as string);\n        });\n        if (!!shopMatch && !elm.parentElement.querySelector('#cholloSerp')) {\n            elm.insertAdjacentElement(\n                'beforebegin',\n                shopMatchWidget({\n                    vouchers: shopMatch!.stats.vouchersCount,\n                    offers: shopMatch!.stats.offersCount,\n                    merchandDomain: shopMatch.merchantDomain as string,\n                }),\n            );\n        }\n    });\n}\n","import '~F/app/views/App/css/index.scss';\nimport { insertWidget } from './widget';\n\nimport { insertViteBundledCss } from '~F/app/views/App/App.view';\nimport { settingsAPIHandler } from '~F/account/api';\n\nactivateSerp();\n\nasync function activateSerp() {\n    const { SERPConf } = await settingsAPIHandler.read();\n\n    if (SERPConf === 'activate') {\n        insertViteBundledCss(document.body, import.meta.PLUGIN_WEB_EXT_CHUNK_CSS_PATHS, true);\n\n        insertWidget('div[jscontroller=\"SC7lYd\"]');\n        scrollSerpInjection();\n    }\n}\nfunction scrollSerpInjection() {\n    const googleBottomStuff = '#botstuff div[jscontroller=\"SC7lYd\"]';\n    const initialPageHeight = document.documentElement.scrollHeight;\n    document.addEventListener('scrollend', () => {\n        if (document.documentElement.scrollHeight > initialPageHeight) {\n            insertWidget(googleBottomStuff, true);\n        }\n    });\n}\n"],"names":["label","ofertas","cupones","logo","shopMatch","elm"],"mappings":"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"}