var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t};function _objectWithoutProperties(t,e){var s={};for(var r in t)e.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(t,r)&&(s[r]=t[r]);return s}const xmlToJson=t=>{let e={};if(t.nodeType===Node.ELEMENT_NODE){if(t.attributes.length>0){e["@attributes"]={};for(let s=0;s<t.attributes.length;s++){const r=t.attributes.item(s);e["@attributes"][r.nodeName]=r.value}}}else t.nodeType===Node.TEXT_NODE&&(e=t.value);if(t.hasChildNodes())for(let s=0;s<t.childNodes.length;s++){const r=t.childNodes.item(s),i=r.nodeName;if(void 0===e[i])e[i]=xmlToJson(r);else{if(void 0===e[i].push){const t=e[i];e[i]=[],e[i].push(t)}e[i].push(xmlToJson(r))}}return e};class _WotApi{constructor(){this.root="https://api.mywot.com/",this.methods={query:{name:"query",url:SCORECARD_SERVER_ADDRESS+"/v3/query"},register:{url:API_USERS_SERVER_ADDRESS+"/v3/registerClient"},getSerps:{url:STATIC_FILES_SERVER+"/v2/serps.json"},getTrackersUrls:{url:STATIC_FILES_SERVER+"/v2/trackersUrls.json"},reviews:{url:SCORECARD_SERVER_ADDRESS+"/v3/reviews"},reviewsCounter:{url:SCORECARD_SERVER_ADDRESS+"/v3/reviews/count"},myReview:{url:SCORECARD_SERVER_ADDRESS+"/v3/myReview"},deleteReview:{url:SCORECARD_SERVER_ADDRESS+"/v3/review/delete"},submitReview:{url:SCORECARD_SERVER_ADDRESS+"/v3/review/submit"},isPremium:{url:API_USERS_SERVER_ADDRESS+"/v3/user/isPremium"},analytics:{url:API_ANALYTICS_SERVER_ADDRESS+"/event"},getLeakInfo:{url:API_LEAK_SERVER_ADDRESS+"/scanEmail"},userDataAnalytics:{url:API_ANALYTICS_SERVER_ADDRESS+"/reportClientData"},updateMailChimpTagsEndpoint:{url:API_USERS_SERVER_ADDRESS+"/updateMailListTags"}},this.crypto=WotCrypto,this.rtSublast="",this.witness=null,this.rtWitness=null,this.counters={}}onError(t){setTimeout(()=>{window.location=location},1e3)}getRtSublast(){return this.rtSublast?this.rtSublast:""}setRtSublast(t){this.isValidUrl(t)&&(this.rtSublast=t)}isValidUrl(t){return"string"==typeof t&&/^https?:\/\/(?!localhost)/.test(t)&&-1===t.indexOf("chrome/newtab")}isChromeInstantUrl(t){return"string"==typeof t&&-1!==t.indexOf("sourceid=chrome-instant")}get(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t=>{},s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];const r=new XMLHttpRequest,i=+new Date;s.push(WOT_TRACE_ID),r.open("GET",t),s.forEach(t=>r.setRequestHeader(t.name,t.value)),r.onload=()=>(r.time=+new Date-i,e.call(null,r)),r.send()}post(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",s=arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t=>{};const i=new XMLHttpRequest,n=+new Date;i.open("POST",t,!0),"function"==typeof s&&(r=s,s=null),this.addHeadersToXhr(i,s),i.onload=()=>(i.time=+new Date-n,r.call(null,i)),i.send(e)}delete(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",s=arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t=>{};const i=new XMLHttpRequest;i.open("DELETE",t),"function"==typeof s&&(r=s,s=null),this.addHeadersToXhr(i,s),i.onload=function(){return r.call(null,i)},i.send(e)}getCommentsData(t){return new Promise((e,s)=>{const r=t.target=t.url;this.get(buildUrl(this.methods.reviews.url,t),t=>{if(200===t.status||304===t.status){const s=JSON.parse(t.responseText),i=[];s.length?(s.forEach(t=>{const e=t.rating||{},s=!t.adult,r=t.user||{};i.push({comment:t.comment,name:r.name,picture:r.avatar,status:t.status,timestamp:t.timestamp/1e3,uid:r.id,url:t.url,wcid:t.id,star:e.star,rating:20*e.score,bubbles:"none",childSafety:s})}),e({[r]:{data:i}})):e({[r]:{data:i}})}else s(t.status)})})}getOldWitnessSettings(t,e){const s=JSON.parse(localStorage.getItem(e)),r=JSON.parse(localStorage.getItem(t));return!(!s||!r)&&(webextApi.storage.local.set({settingId:s}),webextApi.storage.local.set({settingKey:r}),this.sendAnalyticsFromBackground("OLD_CONF",t),this.sendAnalyticsFromBackground("OLD_CONF",e),{id:s,key:r})}getIsPremium(t,e){if(!t||!e)return new Promise(t=>t());const s=[{name:"Authorization",value:"Bearer "+e}];return new Promise((e,r)=>{this.get(buildUrl(this.methods.isPremium.url,{uid:t}),t=>{200===t.status?(t.responseText&&e(JSON.parse(t.responseText)),e()):r(t.status)},s)})}comments(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;const r={url:t,uid:e,limit:s,page:(arguments.length>3&&void 0!==arguments[3]?arguments[3]:0)/s+1,includeRating:"true"};r.salt=+new Date;const i=this.getCommentsData(r),n=new Promise((e,s)=>{this.get(buildUrl(this.methods.reviewsCounter.url,{url:t,salt:+new Date}),r=>{if(200!==r.status&&304!==r.status||"{}"===r.responseText)s(r.status);else{const s=JSON.parse(r.responseText);e({[t]:s})}})});return Promise.all([i,n])}commentsCount(t){return new Promise((e,s)=>{this.get(buildUrl(this.methods.reviewsCounter.url,{url:t,salt:+new Date}),r=>{if(200!==r.status&&304!==r.status||"{}"===r.responseText)s(r.status);else{const s=JSON.parse(r.responseText);e({[t]:s})}})})}getUserReview(t,e){const s=[{name:"Authorization",value:"Bearer "+e}];return new Promise((e,r)=>{this.get(buildUrl(this.methods.myReview.url,{url:t}),t=>{if(200===t.status||304===t.status){const s=JSON.parse(t.responseText);e(s)}else r(t.status)},s)})}sendComments(t,e){const s={Authorization:"Bearer "+e,"Content-type":"application/json"};return new Promise((e,r)=>{this.post(this.methods.submitReview.url,JSON.stringify(t),s,t=>{if(200===t.status)return e();r()})})}deleteComments(t,e){const s={Authorization:"Bearer "+e,"Content-type":"application/json"};this.post(this.methods.deleteReview.url,JSON.stringify({target:t}),s,t=>{200!==t.status})}register(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{isRt:!1};if(t&&t.id&&t.key)return e.isRt?this.rtWitness=t:this.witness=t,new Promise((e,s)=>{e(t)});if(e.isRt){const t=this.getOldWitnessSettings("rt_witness_key","rt_witness_id");if(t)return this.rtWitness=t,new Promise((e,s)=>{e(t)})}else{const t=this.getOldWitnessSettings("witness_key","witness_id");if(t)return this.witness=t,new Promise((e,s)=>{e(t)})}return new Promise((t,s)=>{const r={nonce:this.crypto.getnonce("register",{id:"",key:""}),lang:getLocale(),version:VERSION};e.isRt&&(r.wg=1),this.get(buildUrl(this.methods.register.url,r),r=>{if(200===r.status){const s=r.responseText.match(/[0-9a-z]{40}/g),i={id:s[0],key:s[1]};e.isRt?this.rtWitness=i:this.witness=i,t(i)}else this.onError(r),s(r.status)})})}registerAll(t,e){const s=this.register(t),r=this.register(e,{isRt:!0});return Promise.all([s,r])}prepareForRt(t){if(!Object.keys(t).length)return"";const e=this.crypto.getnonce(this.methods.query.name,this.rtWitness),s={id:this.rtWitness.id,nonce:e,lang:getLocale(),version:`${VERSION}-${RT_API_SUBVERSION}`},r=this.targetParamsToQuerystring(Object.assign(t,this.getAdditionalTargetParams()),{});return s.target=this.crypto.encrypt(r,e,this.rtWitness.key),"&wg=1&b64="+btoa(this.paramsToQuerystring(s,{}))}query(t,e){return new Promise((s,r)=>{const i=t.links,n=t.wp0,o=_objectWithoutProperties(t,["links","wp0"]),a=n?"":this.prepareForRt(o),l=i.length?i.toString():o.target,u=this.crypto.getnonce(this.methods.query.name),c={target:this.crypto.encrypt(l,u,this.witness.key),id:this.witness.id,nonce:u,lang:getLocale(),version:VERSION};let h=this.paramsToQuerystring(c);const d=`/v3/${this.methods.query.name}?${h}`;h+="&auth="+this.crypto.authenticate(d,this.witness),h+=""+a,this.post(this.methods.query.url,h,e,t=>{if(200===t.status){const e=t.getResponseHeader("x-session-id");if(e)try{const t=new Event("settings-event");Object.assign(t,{settings:e}),self.dispatchEvent(t)}catch(t){}let i={targets:[]};try{i=JSON.parse(t.responseText)}catch(e){this.onError(t),r(e.message)}const n=i.targets,o=Date.now(),a=n.reduce((t,e,s)=>{const r=e.target,i={response_str:!0,index:s,witness_key:this.witness.key};return e.target=this.crypto.decrypt(r,u,i),e.categories=e.categories.map(addCategoryDescription).filter(t=>!!t),e.color=RATING_COLORS[e.safety],t[e.target]=_extends({},e,{updated:o}),t},{});s(a)}else this.onError(t),r(t.status)})})}getSerps(){return new Promise((t,e)=>{this.get(buildUrl(this.methods.getSerps.url,{id:this.witness.id}),s=>{200===s.status?t(JSON.parse(s.responseText)):e(s.status)})})}getTrackersUrls(){return new Promise((t,e)=>{this.get(buildUrl(this.methods.getTrackersUrls.url,{id:this.witness.id}),s=>{200===s.status?t(JSON.parse(s.responseText)):e(s.status)})})}getAdditionalTargetParams(){const t={epochtime:new Date/1,id:this.getRtId()};return"undefined"!=typeof _wotPloyder&&_wotPloyder.hasItems()&&(t.lk=_wotPloyder.takeAndPack(_wotPloyder.limit)),t}subsfwrdToQueryString(t,e){if(!t||0===t.length)return"";const s=[];for(const r in t){const i=t[r];s.push(this.paramsToQuerystring({subsfwrd:i},e))}return s.join("&")}targetParamsToQuerystring(t,e){const s=this.subsfwrdToQueryString(t.subsfwrd,e);t.hasOwnProperty("subsfwrd")&&delete t.subsfwrd;let r=this.paramsToQuerystring(t,e);return s&&(r+="&"+s),r}paramsToQuerystring(t,e){if(!t)return"";const s=[];for(const r in t)if(null!=t[r]){let i=r,n=t[r];e&&e.hash&&e.hash==r&&(i="SHA1",n=this.crypto.bintohex(this.crypto.sha1.sha1str(unescape(encodeURIComponent(t[r]))))),s.push(`${i}=${encodeURIComponent(n)}`)}return s.join("&")}getRtId(){if(crossbrowserName===PLATFORM_TYPES.OPERA){const t=JSON.parse(localStorage.getItem("stats_uid"));if(t)return webextApi.storage.local.set({stats_uid:t}),this.sendAnalyticsFromBackground("OLD_CONF","stats_uid"),t}const t=JSON.parse(localStorage.getItem("uuid"));if(t)return webextApi.storage.local.set({uuid:t}),this.sendAnalyticsFromBackground("OLD_CONF","uuid"),t;if(this.witness&&this.witness.id)return this.witness.id;throw new Error("WotApi.getRtId: RT id is not set")}getDataLeak(t,e){const s=[{name:"Authorization",value:"Bearer "+t}];return new Promise((t,r)=>{this.get(buildUrl(this.methods.getLeakInfo.url,{fromDate:e}),e=>{if(200===e.status||304===e.status){const s=JSON.parse(e.responseText);t(s)}else r(e.status)},s)})}addHeadersToXhr(t,e){e?Object.keys(e).forEach(s=>{t.setRequestHeader(s,e[s])}):t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.setRequestHeader(WOT_TRACE_ID.name,WOT_TRACE_ID.value)}getAnalyticsInfoFromLocalStorage(){return new Promise(t=>{chrome.storage.local.get(ANALYTICS.ANALYTICS_INFO_KEY,e=>{let s=e.uuid;t(s)})})}async syncAnalyticInfoWithWebapp(){let t,e;try{const s=await fetch(ANALYTIC_INFO);200===s.status&&(t=await s.json()),e=t&&t.uuid||generateUuidV4(),await fetch(ANALYTIC_INFO,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuid:e})})}catch(t){}return e}async getOrInitAnalyticsInfoFromLocalStorage(){const t=await this.getAnalyticsInfoFromLocalStorage();if(!t){const t=await this.syncAnalyticInfoWithWebapp();return await webextApi.storage.local.set({[ANALYTICS.ANALYTICS_INFO_KEY]:t}),t}return t}sendAnalyticsFromBackground(t,e,s,r){const i={[GA_ACTION_KEY]:t||"",[GA_LABEL_KEY]:e||"",testGroup:s,eventPayload:r};this.sendInternalAnalytics(i)}async sendInternalAnalytics(t){try{const e=t[GA_ACTION_KEY],s=t[GA_LABEL_KEY],r=t.testGroup,i=t.eventPayload,n=await this.getOrInitAnalyticsInfoFromLocalStorage(),o=new WotAnalyticsEvent(e,s,r,i,n),a={"Content-type":"application/json"};this.post(this.methods.analytics.url,JSON.stringify(o.createPayload()),a,t=>{})}catch(t){console.log("sendInternalAnalytics error ",t)}}sendUserDataAnalytics(t,e,s,r){try{const i=new UserDataAnalyticsEvent(t,e,s,r),n={"Content-type":"application/json"};this.post(this.methods.userDataAnalytics.url,JSON.stringify(i.createPayload()),n,t=>{})}catch(t){}}reportError(t){fetch(API_ANALYTICS_SERVER_ADDRESS+"/reportClientError",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(_extends({},t,{browserName:browserName,version:VERSION,locale:getLocale(),witness_id:this.witness&&this.witness.id}))}).catch()}updateMailChimpTags(t,e){const s={tags:t},r={Authorization:"Bearer "+e,"Content-type":"application/json"};this.post(this.methods.updateMailChimpTagsEndpoint.url,JSON.stringify(s),r)}}const WotApi=new _WotApi;