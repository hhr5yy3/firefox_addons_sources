class ElementInspector{selectedElement;selectedLink;static getTarget(){return this.selectedElement}static setTarget(e){this.selectedElement=null,this.selectedLink=null;var t=e.target===window.document.documentElement,r="mousedown"===e.type,i=!(e.target instanceof SVGElement||e.target instanceof HTMLElement);!r&&t||i||(r={x:e.clientX,y:e.clientY},this.selectedElement=this.getCollectableElementFromElement(e.target),this.selectedElement?(this.isLinkContainAcceptableElement(this.selectedElement)&&(t=this.getCollectableElementByPoint(r))&&({img:!0,video:!0,audio:!0,canvas:!0,picture:!0,svg:!0}[t.tagName.toLowerCase()]||t.hasAttribute("eagle-src"))&&(this.selectedElement=t),eagle.logger.info("[ElementInspector] get element directly success")):(this.selectedElement=this.getCollectableElementByPoint(r),this.selectedElement?eagle.logger.info("[ElementInspector] get element by point success"):eagle.logger.info("[ElementInspector] get element by point failed")))}static isAcceptableElement(e){if(e.hasAttribute("eagle-src"))return!0;if(e.hasAttribute("eagle-collectable"))return!0;var t=e.tagName.toLowerCase();if({picture:!0,svg:!0}[t])return!0;if("img"===t){const n=getComputedStyle(e).getPropertyValue("pointer-events");var r=""!=(e.src||e.currentSrc),i="none"===n;if(this.#isVisible(e)&&!this.#isAnnoyingImage(e)&&r&&!i)return!0}if("canvas"===t)return!!e.getContext("2d");if(("video"==t||"audio"==t)&&!e.currentSrc.startsWith("blob:"))return!0;"a"==t&&e.href&&"nofollow"!==e.rel&&(this.selectedLink=e.href),r=getComputedStyle(e).getPropertyValue("background-image");const n=getComputedStyle(e).getPropertyValue("pointer-events");if(t="repeat"!==(i=getComputedStyle(e).getPropertyValue("background-repeat"))&&"repeat-x"!==i&&"repeat-y"!==i,i=(i=getComputedStyle(e).getPropertyValue("background-size")).includes("cover")||i.includes("contain")||i.includes("100%"),e=5<e.clientWidth&&5<e.clientHeight,"none"!==r&&r.includes("url")&&"none"!==n&&e){if(i)return!0;if(t)return!0}return!1}static isLinkContainAcceptableElement(e){var t;return!("A"!==e.tagName||!e.href||(t=e.querySelector("img, video, canvas, picture, svg, [eagle-src]"),e="none"===getComputedStyle(e).getPropertyValue("pointer-events"),!t)||!this.#isVisible(t)||this.#isAnnoyingImage(t)||e)}static getCollectableElementFromElement(e){if(this.isAcceptableElement(e))return e;if(e instanceof SVGElement&&null!=e.closest("SVG"))return e.closest("SVG");if(e.hasAttribute("eagle-src"))return e;if("IMG"==e.tagName&&!this.#isAnnoyingImage(e)){if((e.hasAttribute("src")&&""!=e.getAttribute("src")||e.hasAttribute("srcset"))&&e.src)return e;var t="none"!==(r=getComputedStyle(e).getPropertyValue("background-image"))&&!r.includes("gradient")&&!r.includes("about:blank")&&!r.includes("overlay");if(this.#isAnnoyingImage(e)&&(t=t&&r.match(/url\("?(.+?)"?\)/))&&t[1])return e}if("VIDEO"==e.tagName){let t=(e.currentSrc||e.children[0].src).toLowerCase();if([".mp4",".webm","fbcdn.net","mime_type=video_mp4"].some(e=>t.includes(e))&&!t.includes("blob:"))return e}var r,i;return"AUDIO"!=e.tagName||!e.currentSrc&&!e.children[0].src||e.currentSrc.startsWith("blob:")?(r=getComputedStyle(e).getPropertyValue("background-image"),t="repeat"!==(t=getComputedStyle(e).getPropertyValue("background-repeat"))&&"repeat-x"!==t&&"repeat-y"!==t,i="auto"!=getComputedStyle(e).getPropertyValue("background-size"),t&&i&&"none"!==r&&!r.includes("gradient")&&!r.includes("about:blank")&&!r.includes("overlay")&&(t=r.match(/url\("?(.+?)"?\)/))&&t[1]?e:null):e.currentSrc}static#getAllElementsFromPoint(e,t,r=document,i=new WeakMap){if(i.get(r))return[];i.set(r,!0);let n=[];var l,a;if(0===(r=r.elementsFromPoint(e,t)).length)return[];for(l of r)l.shadowRoot?(a=this.#getAllElementsFromPoint(e,t,l.shadowRoot,i),n.unshift(...a)):n.push(l);return n=[...new Set(n)]}static getCollectableElementByPoint(e){return this.#getAllElementsFromPoint(e.x,e.y,document).find(e=>this.isAcceptableElement(e))||this.#findAcceptedElementByPoint(e,$("img:visible"))}static getFilteredElementByPoint(e,t=()=>!0){return document.elementsFromPoint(e.x,e.y).filter(t)[0]}static#findAcceptedElementByPoint(e,t){let r=9999999,i=null;for(const s of t){var n=window.getComputedStyle(s),l=parseInt(n.width),a=parseInt(n.height),l=0<l&&0<a;0<parseFloat(n.opacity)&&"none"!==n.display&&"hidden"!==n.visibility&&l&&-1!==(a=this.#isPointInElement(s,e))&&a<r&&(i=s,r=a)}return i}static async getBase64FromBlobUrl(e){const r=await(await fetch(e)).blob(),i=new FileReader;return new Promise((e,t)=>{i.onloadend=()=>e(i.result),i.onerror=t,i.readAsDataURL(r)})}static async getMeta(e,{parseBase64:t=!1}={}){if(null==e)return null;var r=(n=e).getAttribute("eagle-src"),i=(n.getAttribute("eagle-tags")||"").split(",").map(e=>e.trim()).filter(e=>""!==e),r={src:r&&eagle.utils.absolutePath(r),annotation:n.getAttribute("eagle-annotation"),tags:i||[],link:n.getAttribute("eagle-link"),title:eagle.utils.clearWeirdCharacters(n.getAttribute("eagle-title"))},i=await(async e=>{var t,r=e.tagName.toLowerCase(),i=getComputedStyle(e).getPropertyValue("background-image");let n={title:"",src:"",link:""};if(this.selectedLink&&(n.link=this.selectedLink),"canvas"===r?n.src=e.toDataURL():"svg"===r&&0<e.childElementCount?(l=(new XMLSerializer).serializeToString(e),l=btoa(unescape(encodeURIComponent(l))),n.src="data:image/svg+xml;base64,"+l):"img"===r&&("picture"===e?.parentElement?.tagName?.toLowerCase()&&(l=e.parentElement,l=this.#getPictureSourceSrc(l),n.src=l||e.currentSrc||e.src),e.srcset&&(n.src=this.#getHighestResImgFromElement(e)),"none"!==i)&&i.includes("url")&&!i.includes("gradient")&&!i.includes("about:blank")&&!i.includes("overlay")&&!0===e.complete&&e.naturalWidth<=5&&e.naturalHeight<=5&&e.naturalHeight<=e.clientHeight&&e.naturalWidth<=e.clientWidth&&(l=i.match(/url\("?(.+?)"?\)/))&&l[1]&&(n.src=l[1]),n.src||!e.currentSrc&&!e.src||(n.src=e.currentSrc||e.src),n.src||(l=e.querySelector("source"))&&(n.src=l.src),n.src||(t=i.match(/url\("?(.+?)"?\)/))&&t[1]&&(n.src=t[1]),n.src||(n.src=this.#getHighestResImgFromElement(e)),"img"===r&&n.src&&n.src.includes("blob:")&&(l=await this.getBase64FromBlobUrl(n.src),n.src=l),0<(i=$("a").has(e)).length&&(r=location.href,l=i.attr("rel"),a=i.attr("target"),i=eagle.utils.absolutePath(i.attr("href")),eagle.utils.isValidUrl(i))&&("nofollow"!==l&&"noopener"!==l&&"_blank"!==a&&(n.link=i),eagle.utils.url.isSameHost(r,i)||eagle.utils.url.isSameRootDomain(r,i))&&(n.link=i),""==n.link){var l=e.getBoundingClientRect(),a=l.x+l.width/2,r=l.y+l.height/2,a=(i=document.elementsFromPoint(a,r)).find(e=>"a"===e.tagName.toLowerCase()),r=i.indexOf(e),i=i.indexOf(a);try{-1!==r&&-1!==i&&a&&i<r&&(u=a.getBoundingClientRect()).x<=l.x&&u.y<=l.y&&u.x+u.width>=l.x+l.width&&u.y+u.height>=l.y+l.height&&(n.link=a.href)}catch(e){}}i=n.link===n.src,r=n.link&&n.src&&n.link.split("?")[0]===n.src.split("?")[0],(i||r||(t=(t=n.link).split(".").pop(),["jpg","jpeg","png","gif","webp","bmp","svg","apng","avif"].includes(t))||""==n.link)&&(n.link=location.href);try{var s,c,o=eagle.plugin.get(n.link);o&&o.getMeta&&(s=o.getMeta(e),n={...n,...s}),o&&o.getMetaAsync&&(c=await Promise.race([o.getMetaAsync(e),new Promise(e=>setTimeout(()=>e({}),1e4))]),n={...n,...c})}catch(e){}n.src=eagle.utils.absolutePath(n.src);var u=[n.customTitle,n.title,this.#getBestTitle(e),document.title,"untitled"];return n.title=u.find(e=>0<eagle.utils.clearWeirdCharacters(e).length),n})(e),n={src:r.src||i.src,annotation:r.annotation||i.annotation,tags:r.tags||[],url:r.link||i.link,title:r.title||i.title};return n.src&&n.src.startsWith("blob:")?null:(t&&"img"===e.tagName.toLowerCase()&&!e.hasAttribute("eagle-src")&&(r=await eagle.cacheHelper.toDataURL(n.src))&&(n.base64=r),n)}static#isPointInElement(e,t){var r=e.getBoundingClientRect(),i=t.x,t=t.y;return r.y+r.height<t||r.y>t+1||r.x+r.width<i||r.x>i+1?-1:0<=(e=this.#getZIndex(e))?Math.sqrt(Math.pow(r.x-i,2)+Math.pow(r.y-t,2))-1e3*e:Math.sqrt(Math.pow(r.x-i,2)+Math.pow(r.y-t,2))}static#getZIndex(e){var t;return e==document?0:(t=document.defaultView.getComputedStyle(e).getPropertyValue("z-index"),isNaN(t)?this.#getZIndex(e.parentNode):parseInt(t))}static#isVisible(e){return!!e&&"0px"!==(e=getComputedStyle(e)).width&&"0px"!==e.height&&"0"!==e.opacity&&"none"!==e.display&&"hidden"!==e.visibility}static#isAnnoyingImage(e){var t;return!!e&&("IMG"!==e.tagName||!1!==e.complete)&&(t=e.naturalWidth,e=e.naturalWidth,t<=5&&e<=5||t*e<10)}static#getPictureSourceSrc(t){let r="";{var i=e=>{r=0<e.length?this.#extractMaxURLFromSourceElements(e):(e=t.querySelector("img"))?.currentSrc||e?.src||""};let e=[...t.children];e=(e=e.filter(e=>"SOURCE"==e.tagName)).filter(e=>""==e.media||null==e.media);const n={"image/gif":1,"image/png":2,"image/jpeg":3,"image/jpg":3,"":4,undefined:4};i(e=(e=e.filter(e=>n[e.type])).sort((e,t)=>n[e.type]-n[t.type]))}return r}static#getHighestResImgFromElement(e){var t=e.currentSrc||e.getAttribute("src"),r=e.querySelectorAll("source");return 0<r.length?this.#extractMaxURLFromSourceElements(r)||t:(r=e.getAttribute("srcset"))&&this.#extractMaxResolutionFromSrcset(r)||t}static#extractMaxURLFromSourceElements(r){try{let e=null,t=0;for(var i of r){var n,l;i.hasAttribute("srcset")&&(n=i.getAttribute("srcset"),(l=this.#parseSrcsetString(n)).sort((e,t)=>null==e.width?1:null==t.width?-1:t.width-e.width),l[0].width>t)&&(e=l[0].url,t=l[0].width)}return e}catch(e){return null}}static#extractMaxResolutionFromSrcset(e){return e=this.#parseSrcsetString(e),(e=eagle.utils.deepUnique(e)).sort((e,t)=>e.width<t.width||null==e.width?1:e.width>t.width||null==t.width?-1:0),e[0].url}static#parseSrcsetString(e){return e.split(/\s*([^,]\S*[^,](?:\s+[^,]+)?)\s*(?:,|$)/).filter(e=>""!==e).map(e=>{let n={};return e.trim().split(/\s+/).forEach((e,t)=>{var r,i;0===t?n.url=e:(t=/^-?\d+$/,r=e.slice(0,-1),e=e[e.length-1],i=Number.parseInt(r,10),"w"===e&&t.test(r)?0<i&&(n.width=i):"x"===e&&t.test(r)&&0<i&&(n.width=i))}),n})}static#getBestTitle(t){let r=t&&(t.getAttribute("eagle-title")||t.customTitle||t.title)||t&&t.alt;try{r=r&&r.trim();let e=t.currentSrc||t.src||this.#getHighestResImgFromElement(t);if(e=e.split("?")[0],!r&&e&&-1<e.indexOf("."))try{var i;(r=decodeURIComponent(e).split("/").pop().replace(/\.[^.]*$/,""))&&(r=(r=(r=null===r.match(/[^a-zA-Z0-9 -_]/g)&&(i=r.split(/\d+/).length,1===r.split(" ").length)&&2<i?document.title:r).match(/^[a-zA-Z]+\d{4,}/g)?document.title:r).match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/g)?document.title:r).match(/^\d{5,}/g)&&(r=document.title),new RegExp("/[0-9a-f]{32}.|/[0-9a-f]{40}.","g").test(e)&&(r=document.title)}catch(e){}return location.href===e&&(r=new URL(e).pathname.split("/").pop(),r=decodeURIComponent(r)),r=(r="图片"===r||-1<r.indexOf("https://")?void 0:r)&&r!=parseInt(r)?r:document.title}catch(e){return r}}}eagle.elementInspector=ElementInspector;