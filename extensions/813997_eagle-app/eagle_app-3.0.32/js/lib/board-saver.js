class BoardSaver{rules=[];constructor(){this.#registerRuntimeChannel()}#registerRuntimeChannel(){eagle.runtime.onMessage("save-board",(e,t,a)=>(this.start(),a(),!0))}async start(){var a,t;function r(){jQuery(".eagle-save-board-progress-bar").remove()}let i=location.href,o;if((0===this.rules.length?await this.getRules():this.rules).forEach(e=>{-1!==i.indexOf(e.urlPattern)&&(o=e)}),o){const b="http://localhost:41595/api/item/addFromURLs";var s=Date.now(),l=0,n=100,c=200,d={imageCount:0,imageSet:{},linkSet:{},allImgElems:[],folderId:""},g=location.href;let e=window;o.selector.scrollEle&&(e=document.querySelector(o.selector.scrollEle)||window);var m=function(){e.scrollTo(0,(e.scrollY||e.scrollTop||0)+(e.innerHeight||e.offsetHeight||100)/2),e.scrollY||e.scrollTop},h=async()=>{var e=Array.from(document.querySelectorAll(o.selector.image));return e.forEach(e=>{d.allImgElems.push(e)}),d.allImgElems=[...new Set(d.allImgElems)],e=e.filter(e=>(e=e.src,!d.imageSet[e]&&(d.imageSet[e]=!0))),Promise.all(e.map(async e=>{d.imageCount++,r=d.imageCount,jQuery(".eagle-save-board-progress-bar-message span").text(`(${r})`);var t,a,r=await eagle.elementInspector.getMeta(e);return(r=new URL(r.src||e.src)).searchParams.append("v",Date.now()),{name:(t=e,(a=eagle.plugin.get(location.href))?.getMeta&&a.getMeta(t),await((a=a?.getMetaAsync&&await a.getMetaAsync(t))?.title?a?.title:(a=t.closest(o.selector.box),t.alt&&!o.selector.ignoreAlt?t.alt:a&&a.textContent?a.textContent:""))||document.title),url:decodeURIComponent(r.href),website:function(e){if(o.selector.box)for(var t=Array.from(document.querySelectorAll(o.selector.box)),a=0;a<t.length;a++)if(t[a].contains(e))return eagle.utils.absolutePath(t[a].querySelector(o.selector.link)?.href)||location.href;return""}(e),modificationTime:s-d.imageCount}}))};const f=()=>{var e=d.allImgElems.length-d.imageCount;0<e?alert(""+eagle.i18n.words["board-saver.finish.msg1"]+eagle.i18n.words["board-saver.finish.msg2"].replace("{count}",e)+eagle.i18n.words["board-saver.finish.msg3"].replace("{count}",d.imageCount)):alert(""+eagle.i18n.words["board-saver.finish.msg1"]+eagle.i18n.words["board-saver.finish.msg3"].replace("{count}",d.imageCount)),clearInterval(a),r()};var p,u=async()=>{var e=await h();0<e.length?(l=0,v(e)):l++,location.href!=g&&f(),(e=o.selector.endElem&&document.querySelector(o.selector.endElem))&&f(),(e=$(o.selector.spinner)?.is(":visible")?c:n)<=l&&(e=eagle.i18n.words["board-saver.progress.hit-bottom"],jQuery(".eagle-save-board-progress-bar-message").text(e)),m(),(e=o.selector.moreBtn&&document.querySelector(o.selector.moreBtn))&&e.click()},v=function(e){e&&0!==e.length&&e.forEach(a=>{eagle.urlEnlarger.enlarge(a.url).then(({largeUrl:e,url:t})=>{a.url=e||t,eagle.fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:[a],folderId:d.folderId})}).then(e=>{})})})};e.scrollTo(0,0),e.scrollY||e.scrollTop,(p=jQuery(`
				<div class="eagle-save-board-progress-bar" eagle-extension eagle-extension-theme="${eagle.preference.displayTheme}" translate="no">
					<div class="eagle-save-board-progress-bar-icon">
						<svg class="spinner" width="16px" height="16px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
							<circle class="path" fill="none" stroke-width="3" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
						</svg>
					</div>
					<div class="eagle-save-board-progress-bar-message">${eagle.i18n.words["board-saver.progress.crawling"]} <span></span></div>
					<div class="eagle-save-board-progress-bar-stop-button">${eagle.i18n.words["board-saver.progress.stop"]}</div>
				</div>
			`)).find(".eagle-save-board-progress-bar-stop-button").on("click",()=>{r(),clearInterval(a)}),jQuery("body").append(p),p=jQuery(o.selector.title).text()||document.querySelector("title").text,t=(e,t)=>{t&&(d.folderId=t.id,a=setInterval(u,100))},eagle.fetch("http://localhost:41595/api/folder/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folderName:p})}).then(e=>{try{"success"===e.status&&e.data&&e.data.id?t(0,e.data):t()}catch(e){t()}})}}async getRules(){return new Promise(async t=>{if(0<this.rules.length)return t(this.rules);const a=[{site:"huaban",urlPattern:"huaban.com/boards",selector:{title:"h1",image:".infinite-scroll-component a[href*='pins'] img",link:".infinite-scroll-component a[href*='pins']",box:"[data-pin-id]",spinner:".loading"}},{site:"pinterest",urlPattern:"pinterest.",selector:{title:"h1",image:"[data-grid-item] a [data-test-id] img:not([src^='https://i.pinimg.com/140x140_RS/'])",link:"[data-grid-item] a",box:"[data-grid-item]",spinner:"[data-test-id='homefeed-feed'] svg path[d]:empty, [data-test-id='board-feed'] svg path[d]:empty",ignoreAlt:!0}},{site:"dribbble",urlPattern:"dribbble.com/",selector:{title:"h1",image:'[data-thumbnail-id] figure img:not([src^="data:image/gif;base64,"])',link:"[data-thumbnail-id] a.shot-thumbnail-link",box:"[data-thumbnail-id]",spinner:".loading-more .processing",moreBtn:".load-more"}},{site:"meiye",urlPattern:"meiye.art/",selector:{scrollEle:".overBoxCon",title:"h1",image:'.app-main .imgBox .wrap img[src*="image.meiye.art"]',box:'.app-main .imgBox .wrap img[src*="image.meiye.art"]',spinner:"#load"}},{site:"xiaohongshu",urlPattern:"xiaohongshu.com/",selector:{image:"section.note-item a.cover img, section.note-item a.cover[style*='background-image']",link:"section.note-item a",box:"section.note-item",spinner:".loading .feeds-loading.active"}},{site:"twitter",urlPattern:"twitter.com/",selector:{image:"section div[data-testid='cellInnerDiv'] article a[href*='photo'] img, section div[data-testid='cellInnerDiv'] li a[href*='photo'] img",link:"section div[data-testid='cellInnerDiv'] article a[href*='photo'], section div[data-testid='cellInnerDiv'] li a[href*='photo']",box:"section div[data-testid='cellInnerDiv']",spinner:"div[role='progressbar']"}},{site:"x (twitter)",urlPattern:"x.com/",selector:{image:"section div[data-testid='cellInnerDiv'] article a[href*='photo'] img, section div[data-testid='cellInnerDiv'] li a[href*='photo'] img",link:"section div[data-testid='cellInnerDiv'] article a[href*='photo'], section div[data-testid='cellInnerDiv'] li a[href*='photo']",box:"section div[data-testid='cellInnerDiv']",spinner:"div[role='progressbar']"}},{site:"gameui",urlPattern:"gameui.net/inspiration",selector:{image:"div.vue-waterfall-slot a img",link:"div.vue-waterfall-slot a",box:"div.vue-waterfall-slot",spinner:"div.cus-loading-box"}}];eagle.fetch("https://oss-app.eagle.cool/extensions/batch-save-image-rules.json").then(e=>e&&e.length?(this.rules=e,t(e)):(this.rules=a,t(a)))})}}eagle.boardSaver=new BoardSaver;