const t=window.browser;void 0===window.Hls&&(window.Hls={},window.Hls.isSupported=()=>!1);class e{constructor(){this.disableDetailUrl="/blog/not-support-youtube",this.tab=null,this.options=OPTION,this.langDir="",this.disable=!1,this.bootstrap=null,this.ruleId=1,this.items=[],this.storageKey=null,this.langRender(),this.$item=this.selector("item").cloneNode(!0),this.selector("item").remove(),this.$loading=this.selector("loading"),this.$empty=this.selector("empty"),this.$disable=this.selector("disable"),this.$container=this.selector("container"),this.$list=this.selector("list"),this.$optionsBtn=this.selector("optionsBtn"),this.$options=this.selector("options"),this.$home=this.selector("home"),this.$disableDetail=this.selector("disableDetail")}itemToggle(t,e){const{max:s,min:i}=this.options.size;let o=!0;o=0!==i&&0!==s?e<i||e>s:(0!==i||0!==s)&&(0===i?e>s:e<i),o?t.classList.add("d-none"):t.classList.remove("d-none")}optionRender(){this.$options.classList.add("offcanvas"),this.$options.classList.remove("d-none");const t=new this.bootstrap.Offcanvas(this.$options);this.$optionsBtn.onclick=()=>{t.toggle()},document.querySelectorAll(".tooltip-toggle").forEach((t=>{new this.bootstrap.Tooltip(t)}));const{$options:e,options:s}=this,i=this.selector("sizeMin",!1,e),o=this.selector("sizeMax",!1,e),n=this.selector("noAddDomainTip",!1,e);i.value=s.size.min/1024,o.value=s.size.max/1024,n.checked=!s.noAddDomainTip;for(const t of s.domain)this.createOptionDomain(t);i.onblur=()=>{let t=i.value||0;t?t=parseInt(t):i.value=0,t*=1024,t!=this.options.size.min&&(this.options.size.min=t,this.saveOptions().then((()=>{for(const t of this.items)"hls"!==t.detail.type&&this.itemToggle(t.$item,t.detail.size);this.toast(this.lang("popup_option_setup_success"))})))},o.onblur=()=>{let t=o.value||0;t?t=parseInt(t):o.value=0,t*=1024,t!=this.options.size.max&&(this.options.size.max=t,this.saveOptions().then((()=>{for(const t of this.items)"hls"!==t.detail.type&&this.itemToggle(t.$item,t.detail.size);this.toast(this.lang("popup_option_setup_success"))})))},n.onclick=()=>{this.options.noAddDomainTip=!n.checked,this.saveOptions().then((()=>this.toast(this.lang("popup_option_setup_success"))))}}createOptionDomain(t){const e=this.selector("domain",!1,this.$options),s=this.selector("noDomain",!1,this.$options);s.classList.contains("d-none")||s.classList.add("d-none");const i=document.createElement("div");i.className="d-flex justify-content-between align-items-center mb-1";const o=document.createElement("span");o.className="flex-grow-1 text-truncate me-2 text-decoration-underline",o.innerText=t;const n=document.createElement("button");n.className="btn btn-light",n.innerHTML='<i class="bi bi-trash3"></i>',i.appendChild(o),i.appendChild(n),e.appendChild(i),n.onclick=()=>{n.onclick=null;const e=this.options.domain.indexOf(t);e>-1&&(this.options.domain.splice(e,1),this.saveOptions()),i.remove(),0===this.options.domain.length&&s.classList.remove("d-none")}}langRender(){document.querySelectorAll(".lang-title").forEach((t=>{let e=t.getAttribute("title");e?(e=e.trim(),t.setAttribute("title",this.lang(e))):(e=t.getAttribute("data-bs-title"),e&&(e=e.trim(),t.setAttribute("data-bs-title",this.lang(e))))})),document.querySelectorAll(".lang").forEach((t=>{let e=t.innerText.trim();e&&(t.textContent=this.lang(e))}))}async init(){this.bootstrap=await new Promise((t=>{import("../bootstrap/js/bootstrap.bundle.min.js").then((({bootstrap:e})=>{t(e)}))})),await this.getOptions(),this.langDir=await this.getLangDir(),this.tab=await new Promise((e=>{t.tabs.query({currentWindow:!0}).then((s=>{for(const t of s)if(t.active){e(t);break}t.storage.local.get(["tasks"],(({tasks:e})=>{if(!e)return;const i=e.filter((t=>s.some((e=>e.id===t.tabId&&e.url.startsWith(this.options.site)))));i.length!==e.length&&t.storage.local.set({tasks:i})}))}))})),this.optionRender(),this.$home.onclick=()=>{t.tabs.create({url:this.options.site+this.langDir,index:this.tab.index+1},(()=>{window.close()}))},this.$disableDetail.onclick=()=>{t.tabs.create({url:this.options.site+this.langDir+this.disableDetailUrl,index:this.tab.index+1},(()=>{window.close()}))},t.runtime.onMessage.addListener(((t,e,s)=>{const{cmd:i,parameter:o}=t;if("POPUP_APPEND_ITEMS"===i){if(!o.tab||!o.item||this.disable)return s(),!0;if(this.tab.id!==o.tab)return s(),!0;this.$empty.classList.add("d-none"),this.$container.classList.remove("d-none");for(const t in o.item)this.itemCreate(o.item[t]);return s(),!0}}));const e=["youtube.com","globo.com"];if(0===this.tab.url.indexOf("http")){const t=new URL(this.tab.url).hostname;for(const s of e)if(t.endsWith(s))return this.$loading.remove(),this.$disable.classList.remove("d-none"),void(this.disable=!0)}this.storageKey=`storage${this.tab.id}`;const s=await new Promise((e=>{t.runtime.sendMessage({cmd:"GET_STORAGE",parameter:{storageKey:this.storageKey}},(t=>{e(t)}))}));if(0===Object.keys(s).length)return this.$loading.remove(),void this.$empty.classList.remove("d-none");this.$loading.remove(),this.$container.classList.remove("d-none");for(const t in s)this.itemCreate(s[t])}selector(t,e=!1,s=null){return s?e?s.querySelectorAll('[selector="'+t+'"]'):s.querySelector('[selector="'+t+'"]'):e?document.querySelectorAll('[selector="'+t+'"]'):document.querySelector('[selector="'+t+'"]')}saveOptions(e=!1){const s=JSON.parse(JSON.stringify(this.options));return s.size.min=s.size.min/1024,s.size.max=s.size.max/1024,new Promise((i=>{t.storage.sync.set({options:s}).then((()=>{const s={};e&&(s.storageKey=this.storageKey),t.runtime.sendMessage({cmd:"RESET_OPTIONS",parameter:s},(()=>{i()}))}))}))}getOptions(){const e=t=>{t?.size?.min&&(t.size.min=1024*t.size.min,t.size.min<0&&(t.size.min=0)),t?.size?.max&&(t.size.max=1024*t.size.max,t.size.max<0&&(t.size.max=0))};return new Promise((s=>{try{t.storage.sync.get(["options"]).then((({options:t})=>{if(t)for(let e in this.options)void 0!==t[e]&&(this.options[e]=t[e]);e(this.options),s()}))}catch(t){e(this.options),s()}}))}getLangDir(){return new Promise((async e=>{let s=await t.i18n.getUILanguage();s=s.toLowerCase(),s=s.replace(/_/,"-"),s=this.options.lang.indexOf(s)<0?"":"/"+s,e(s)}))}sizeConvert(t){return t<1024?t+="B":t=t<1048576?(t/1024).toFixed(0)+"K":t<1073741824?(t/1048576).toFixed(0)+"M":(t/1073741824).toFixed(2)+"G",t}setRules(e,s){return new Promise((i=>{void 0!==e.Origin||void 0!==e.Referer?t.runtime.sendMessage({cmd:"ADD_POPUP_PLAYER_HEADER",parameter:{url:s,headers:e}},(t=>{i()})):i()}))}player(t,e,s){const i=document.createElement("video");i.autoplay=!0,i.controls=!0,i.style.maxWidth="100%",e.appendChild(i);const o={};for(const e in t.headers){let s=e;s.toLowerCase().startsWith("fv_")&&(s=s.substring(3),o[s]=t.headers[e])}if("hls"===t.type){if(Hls.isSupported()){const e={};e.fetchSetup=async(e,s)=>(await this.setRules(o,t.url),new Request(e.url,s)),e.xhrSetup=async(e,s)=>{await this.setRules(o,t.url),e.open("GET",s,!0)};const n=new Hls(e);return n.on(Hls.Events.MANIFEST_PARSED,((t,e)=>{let o=0,a=0,l=0;for(const t of n.levels){const{bitrate:e,width:s,height:i}=t;e&&s&&i&&(e>l&&(l=e,o=s,a=i))}o&&a?s.innerText=`${o} x ${a}`:i.addEventListener("loadedmetadata",(()=>{const t=i.videoWidth,e=i.videoHeight;s.innerText=`${t} x ${e}`}))})),n.loadSource(t.url),n.attachMedia(i),n}}else i.addEventListener("loadedmetadata",(()=>{const e=`${i.videoWidth} x ${i.videoHeight}`;t.quality=e,s.innerText=e})),this.setRules(o,t.url).then((()=>{i.src=t.url}));return null}createTab(e,s=!1,i=null){e.initiator=this.tab.url,e.title=this.tab.title.trim()||this.tab.url,t.storage.local.set({queue:e},(()=>{const{options:e,langDir:o}=this;let n="bufferrecorder";if(!s){if(!i)return;n="hls"===i?"m3u8downloader":"videodownloader"}t.tabs.create({url:`${e.site}${o}/${n}`,index:this.tab.index+1},(()=>{window.close()}))}))}itemCreate(e){let s=null;const i=this.$item.cloneNode(!0),o={requestId:e.requestId,detail:e,$item:i},n=this.selector("play",!1,i),a=this.selector("info",!1,i),l=this.selector("name-wrap",!1,i),r=this.selector("name-width",!1,i),c=this.selector("name",!1,i),d=this.selector("name-ellipsis",!1,i),h=this.selector("size",!1,i),m=this.selector("chevron-down",!1,i),p=this.selector("download",!1,i),u=this.selector("blocked",!1,i),b=this.selector("url-collapse",!1,i),g=this.selector("url",!1,i),f=this.selector("url-close",!1,i),v=this.selector("copy",!1,i),y=this.selector("player-collapse",!1,i),w=this.selector("resolution",!1,i),x=this.selector("player",!1,i),$=this.selector("player-close",!1,i);a.setAttribute("title",e.name),c.innerText=e.name,h.innerText="hls"===e.type?"HLS":`${e.type.toUpperCase()}/${this.sizeConvert(e.size)}`,g.innerText=e.url,this.$list.appendChild(i),r.offsetWidth<l.offsetWidth&&(r.classList.remove("h-100","position-absolute","top-0","end-0"),d.remove());const _=new this.bootstrap.Collapse(b,{toggle:!1}),C=new this.bootstrap.Collapse(y,{toggle:!1});b.addEventListener("hide.bs.collapse",(t=>{m.classList.remove("transform-up")})),b.addEventListener("show.bs.collapse",(t=>{m.classList.add("transform-up"),C.hide()})),y.addEventListener("hide.bs.collapse",(t=>{s&&s.destroy(),x.firstElementChild.remove()})),y.addEventListener("show.bs.collapse",(t=>{_.hide()})),a.onclick=()=>{for(const t of this.items)t.requestId!==o.requestId&&t.urlCollapse.hide();_.toggle()},f.onclick=()=>_.hide(),$.onclick=()=>C.hide(),n.onclick=()=>{for(const t of this.items)t.requestId!==o.requestId&&t.playerCollapse.hide();y.classList.contains("show")||(s=this.player(e,x,w),C.show())},p.onclick=()=>{e.contentType.startsWith("audio")?t.tabs.create({url:e.url,index:this.tab.index+1},(()=>{window.close()})):t.storage.local.get(["tasks"],(({tasks:s})=>{s?t.tabs.query({currentWindow:!0}).then((i=>{const o=s.find((t=>i.some((e=>e.id===t.tabId&&e.url.startsWith(this.options.site)))&&t.url===e.url));o?t.tabs.update(o.tabId,{active:!0},(()=>{window.close()})):this.createTab(e,!1,e.type)})):this.createTab(e,!1,e.type)}))},u.onclick=()=>{const{options:t}=this,{hostname:s}=new URL(e.url),o=()=>{if(t.domain.indexOf(s)<0){if(t.domain.length>30)return void this.toast(this.lang("popup_item_block_error"),4e3,!0);t.domain.push(s),this.saveOptions(!0).then((()=>{for(this.createOptionDomain(s);;){let t=!0,e=0;for(const i of this.items){if(new URL(i.detail.url).hostname===s){i.$item.remove(),this.items.splice(e,1),t=!1;break}e++}if(t)break}this.updateBadge(),this.toast(this.lang("popup_item_block_success"))}))}else i.remove()};t.noAddDomainTip?o():this.modal({title:`${this.lang("popup_item_block_modal_title")}: <span class="text-danger text-decoration-underline">${s}</span>`,btnConfirm:this.lang("popup_item_block_modal_btn_confirm"),content:this.lang("popup_item_block_modal_content")},(e=>{t.noAddDomainTip=e,o()}))},v.onclick=()=>{try{navigator.clipboard.writeText(e.url).then((()=>{this.toast(this.lang("popup_item_copy_success"))})).catch((t=>{this.toast(this.lang("popup_item_copy_error"),4e3,!0)}))}catch(t){this.toast(this.lang("popup_item_copy_error"),4e3,!0)}},o.urlCollapse=_,o.playerCollapse=C,this.items.push(o),"hls"!==e.type&&this.itemToggle(i,e.size)}updateBadge(){let e=this.items.length;0===e&&(this.$container.classList.add("d-none"),this.$empty.classList.remove("d-none")),e=e>0?e.toString():"",t.action.setBadgeText({text:e,tabId:this.tab.id});try{t.action.setBadgeTextColor({color:"#FFFFFF"}),t.action.setBadgeBackgroundColor({color:"#FF0000"})}catch(t){}}toast(t,e=3e3,s=!1){const i=document.createElement("div");i.style.zIndex=99999,i.className="w-100 h-100 fixed-top d-flex justify-content-center align-items-start pt-5 pe-none";const o=document.createElement("div");o.className="toast align-items-center border-0 text-white pe-auto";const n=document.createElement("div");n.className="d-flex";const a=document.createElement("div");a.className="toast-body",a.innerText=t;const l=document.createElement("button");if(l.className="btn-close btn-close-white me-2 m-auto",s){const t=document.createElement("span");t.className="text-danger-emphasis",n.appendChild(t),o.classList.add("bg-danger")}else o.classList.add("bg-success");i.appendChild(o),o.appendChild(n),n.appendChild(a),n.appendChild(l),document.body.appendChild(i);const r=new this.bootstrap.Toast(o);r.show(),o.addEventListener("hidden.bs.toast",(()=>{l.onclick=null,r.dispose(),i.remove()})),l.onclick=()=>r.hide(),setTimeout((()=>{r.hide()}),e)}modal(t={},e=((t=!1)=>{})){"string"!=typeof t.title&&(t.title="Tip"),"string"!=typeof t.btnConfirm&&(t.btnConfirm="Confirm"),"string"!=typeof t.content&&(t.content="Content");const{title:s,btnConfirm:i,content:o}=t,n=document.createElement("div");n.className="modal fade",n.setAttribute("tabindex","-1"),n.setAttribute("data-bs-delay",'{"show":150,"hide":150}');const a=document.createElement("div");a.className="modal-dialog",n.appendChild(a);const l=document.createElement("div");l.className="modal-content",a.appendChild(l);const r=document.createElement("div");r.className="modal-header py-3",r.innerHTML=`<h3 class="modal-title fs-6">${s}</h3><button type="button" class="btn-close" data-bs-dismiss="modal"></button>`,l.appendChild(r);const c=document.createElement("div");c.className="modal-body",c.innerHTML=o,l.appendChild(c);const d=document.createElement("div");d.className="modal-footer d-flex justify-content-between align-items-center",l.appendChild(d);const h=document.createElement("label");h.className="d-flex justify-content-start align-items-center pointer";const m=document.createElement("input");m.className="form-check-input fs-5 mt-0 border-2",m.setAttribute("type","checkbox");const p=document.createElement("span");p.className="ps-1",p.innerText=this.lang("popup_no_remind"),h.appendChild(m),h.appendChild(p),d.appendChild(h);const u=document.createElement("button");u.className="btn btn-primary",u.innerText=i,d.appendChild(u),document.body.appendChild(n);const b=new this.bootstrap.Modal(n);b.show(),n.addEventListener("hidden.bs.modal",(t=>{u.onclick=null,b.dispose(),n.remove()})),u.onclick=()=>{e(m.checked),b.hide()}}lang(e){return t.i18n.getMessage(e)}}const s=new e;s.init(),t.runtime.connect({name:"POPUP"});