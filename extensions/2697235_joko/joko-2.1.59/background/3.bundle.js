"use strict";(self.webpackChunkchrome_extension=self.webpackChunkchrome_extension||[]).push([[3],{63441:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},a=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},s=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.refreshData=void 0;var c=n(55015),u=n(67935),l=n(45133),d=n(37052),f=n(30352),p=n(42792),h=n(68657),v=n(78826),g=n(93667),b=n(59006),y=n(13139),m=n(52812),w=n(53233),S=n(16316),I=n(52151),A=n(32495),k=n(78707),M=n(83920),L=n(86459),T=n(7080),E=n(1031),x=n(57419),C=n(22641),O=n(68124),P=n(84594),U=n(69479),_=n(53556),D=n(87626);function R(){return o(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,(0,A.setLocalStorageItem)(A.LocalStorageKey.installed,!0)];case 1:return e.sent(),[4,(0,A.setLocalStorageItem)(A.LocalStorageKey.installationTimestampMs,Date.now())];case 2:return e.sent(),[2]}}))}))}!function(){(0,u.initAuthStorage)(),(0,D.initializeSentry)(),function(){var e=this,t=(0,D.withSentry)((function(){return o(e,void 0,void 0,(function(){var e;return i(this,(function(t){switch(t.label){case 0:e=!1,t.label=1;case 1:return t.trys.push([1,3,,4]),[4,(0,A.getLocalStorageItem)(A.LocalStorageKey.installed)];case 2:return e=t.sent(),[3,4];case 3:return t.sent(),[3,4];case 4:return e||((0,C.logUserEventUtil)({type:"installedBrowserExtension"}),(0,x.sendAmplitudeEvent)({type:"Navigation - Installed Browser Extension"}),I.isMobileExtension?I.isMobileSafariExtension&&(0,O.confirmMobileSafariActivation)(R):(R(),(0,h.checkIsExplicitConsentRequired)()?(0,h.openInstallConsentPage)():((0,g.openWebAppAutoLoginTab)(),(0,b.openWebAppLoginPage)()))),[2]}}))}))}));chrome.runtime.onInstalled.removeListener(t),chrome.runtime.onInstalled.addListener(t)}(),(0,L.setRedirectionToFeedbackFormOnUninstall)(),(0,k.setMessageListener)(),function(){var e=(0,D.withSentry)((function(e){e.name===B&&W()}));chrome.alarms.onAlarm.removeListener(e),chrome.alarms.onAlarm.addListener(e),chrome.alarms.clear(B,(function(){chrome.alarms.create(B,{periodInMinutes:60*F,when:Date.now()})}))}(),(0,m.setBadgeListener)(),(0,w.setBrowserActionListener)(),(0,v.finishOAuthLogin)(),I.isMobileSafariExtension&&((0,P.handleMobileSafariAutoLogin)(!1),(0,P.switchToMobileSafariSharedDevStackMode)());(function(){var e=(0,D.withSentry)((function(e){e.name===j&&function(){o(this,void 0,void 0,(function(){var e,t,n,o,s,c,d,f,h,v,g,b,y,m,w,S,k,M,L,T,E;return i(this,(function(i){switch(i.label){case 0:return[4,(0,A.getLocalStorageItem)(A.LocalStorageKey.lastDailyEventDate)];case 1:return e=i.sent(),_=new Date,D=String(_.getDate()).padStart(2,"0"),R=String(_.getMonth()+1).padStart(2,"0"),F=_.getFullYear(),t="".concat(F,"-").concat(R,"-").concat(D),e&&t<=e?[2]:[4,Promise.all([(0,p.checkIsSignedIn)(),(0,A.getLocalStorageItem)(A.LocalStorageKey.userId)])];case 2:return n=a.apply(void 0,[i.sent(),2]),o=n[0],s=n[1],I.isMobileSafariExtension?[4,(0,U.syncMobileSafariExtensionSetupStateInAppGroup)()]:[3,4];case 3:i.sent(),i.label=4;case 4:return I.isMobileSafariExtension&&o&&!s?((0,C.logUserEventUtil)({type:"mobileSafariExtensionPreDailyBackgroundEventAutoLoginTriggered",active:!1}),(0,x.sendAmplitudeEvent)({type:"Mobile Safari Extension - Pre Daily Background Event Auto Login Triggered"}),[4,(0,P.handleForceMobileSafariAutoLoginMessage)()]):[3,6];case 5:i.sent(),i.label=6;case 6:return console.log("Triggering daily event..."),c=Date.now(),[4,(0,A.getLocalStorageItem)(A.LocalStorageKey.lastContentScriptExecutionTimestampMs)];case 7:return d=i.sent(),[4,(0,A.getLocalStorageItem)(A.LocalStorageKey.lastNonJokoContentScriptExecutionTimestampMs)];case 8:return f=i.sent(),h=!!f&&c-f<864e5,[4,(0,A.getLocalStorageItem)(A.LocalStorageKey.cognitoUserPoolWebClientId)];case 9:return v=i.sent(),[4,(0,l.getDevStackMode)()];case 10:return g=i.sent(),[4,(0,u.getFilledCognitoBackupDataEntries)()];case 11:return b=i.sent(),y=b.filledCognitoBackupDataEntries,m=b.areAllCognitoBackupDataEntriesFilled,w=g?l.ExtensionCognitoUserPoolClientId.dev:l.ExtensionCognitoUserPoolClientId.prod,k=[{contentScriptExecutionDetectedAllTime:!!d,contentScriptExecutionDetectedLast24Hours:!!d&&c-d<864e5,nonJokoContentScriptExecutionDetectedAllTime:!!f,nonJokoContentScriptExecutionDetectedLast24Hours:h}],I.isMobileSafariExtension?[4,(0,O.getPreciseMobileSafariExtensionAuthorizationStatus)()]:[3,13];case 12:return M=i.sent(),[3,14];case 13:M={},i.label=14;case 14:return L=[r.apply(void 0,k.concat([M]))],T={},E={isSignedIn:o},[4,(0,A.getLocalStorageItem)(A.LocalStorageKey.userId)];case 15:return T.extensionDebuggingInfo=(E.localStorageUserId=i.sent(),E.isUsingExtensionCognitoUserPoolClientId=v===w,E.filledCognitoBackupDataEntries=y,E.areAllCognitoBackupDataEntriesFilled=m,E),[4,(0,A.getLocalStorageItem)(A.LocalStorageKey.thirdPartyExtensionsLastDetectedTimestampInSecondsMap)];case 16:return S=r.apply(void 0,L.concat([(T.thirdPartyExtensionsLastDetectedTimestampInSecondsMap=i.sent(),T.currentDate=t,T)])),(0,C.logUserEventUtil)({type:"browserExtensionDailyBackgroundEventTriggered",active:!1,payload:S}),(0,x.sendAmplitudeEvent)({type:"Browser Extension - Daily Background Event Triggered",properties:S}),(0,A.setLocalStorageItem)(A.LocalStorageKey.lastDailyEventDate,t),I.isMobileSafariExtension&&o?[4,(0,O.checkMobileSafariAuthorization)({currentTimestampMs:c,nonJokoContentScriptExecutionDetectedLast24Hours:h})]:[3,18];case 17:i.sent(),i.label=18;case 18:return[2]}var _,D,R,F}))}))}()}));chrome.alarms.onAlarm.removeListener(e),chrome.alarms.onAlarm.addListener(e),chrome.alarms.clear(j,(function(){chrome.alarms.create(j,{periodInMinutes:30,when:Date.now()+q})}))})(),function(){var e=this,t=(0,D.withSentry)((function(t,n){return o(e,void 0,void 0,(function(){var e;return i(this,(function(r){switch(r.label){case 0:return n.url&&(chrome.tabs.sendMessage(t,{message:"urlChange",newUrl:n.url}),function(e){o(this,void 0,void 0,(function(){var t,n,r,o,c,u,l,d;return i(this,(function(i){switch(i.label){case 0:return[4,(0,A.getLocalStorageItem)(A.LocalStorageKey.lastPageLoadStartTimestampByTabIdMap)];case 1:(t=i.sent())||(t={}),t[e]=Date.now();try{for(n=s(Object.entries(t)),r=n.next();!r.done;r=n.next())o=a(r.value,2),c=o[0],u=o[1],Date.now()-u>6e4&&delete t[c]}catch(e){l={error:e}}finally{try{r&&!r.done&&(d=n.return)&&d.call(n)}finally{if(l)throw l.error}}return[4,(0,A.setLocalStorageItem)(A.LocalStorageKey.lastPageLoadStartTimestampByTabIdMap,t)];case 2:return i.sent(),[2]}}))}))}(t)),[4,H()];case 1:return r.sent(),(e=I.isMobileSafariExtension)?[4,(0,p.checkIsSignedIn)()]:[3,3];case 2:e=r.sent(),r.label=3;case 3:return e&&(0,O.handleMobileSafariMissingAuthorizationActions)(n.status),[2]}}))}))}));chrome.tabs.onUpdated.removeListener(t),chrome.tabs.onUpdated.addListener(t)}(),function(){var e=(0,D.withSentry)((function(e){return o(this,void 0,void 0,(function(){var t,n,r;return i(this,(function(o){switch(o.label){case 0:return[4,Promise.all([(0,A.getLocalStorageItem)(A.LocalStorageKey.capturedWebpageDataByTabIdMap),(0,A.getLocalStorageItem)(A.LocalStorageKey.unfinishedBnplSubscriptionStateByTabIdMap)])];case 1:return t=a.apply(void 0,[o.sent(),2]),n=t[0],r=t[1],(null==n?void 0:n[e])?(delete n[e],[4,(0,A.setLocalStorageItem)(A.LocalStorageKey.capturedWebpageDataByTabIdMap,n)]):[3,3];case 2:o.sent(),o.label=3;case 3:return(null==r?void 0:r[e])?(delete r[e],[4,(0,A.setLocalStorageItem)(A.LocalStorageKey.unfinishedBnplSubscriptionStateByTabIdMap,r)]):[3,5];case 4:o.sent(),o.label=5;case 5:return[2]}}))}))}));chrome.tabs.onRemoved.removeListener(e),chrome.tabs.onRemoved.addListener(e)}(),(0,S.addCookieChangeListenerForAffiliateActivationTracking)(),(0,E.addWebRequestListenerForAffiliateActivationTracking)(),(0,E.addWebRequestListenerForAdBlockerDetection)(),(0,M.setContentScriptPortListener)(),(0,f.closeOpenHiddenTabsAfterBackgroundScriptReloading)(),I.extensionType===c.ExtensionType.desktopChromeExtension&&(e=function(e){e.name===V&&chrome.runtime.requestUpdateCheck((function(){}))},t=(0,D.withSentry)(e),chrome.alarms.onAlarm.removeListener(t),chrome.alarms.onAlarm.addListener(t),chrome.alarms.clear(V,(function(){chrome.alarms.create(V,{periodInMinutes:60*z,when:Date.now()})})));var e,t}();var F=6,B="refreshData";function W(e){return o(this,void 0,void 0,(function(){var t,n;return i(this,(function(r){switch(r.label){case 0:return[4,(0,p.checkIsSignedIn)()];case 1:return r.sent()?[4,(0,A.getLocalStorageItem)(A.LocalStorageKey.lastDataRefreshTimestampMs)]:[3,9];case 2:return t=r.sent(),e||!t||Date.now()-t>=60*F*60*1e3?(console.log("Refreshing data..."),[4,(0,l.getClient)()]):[3,7];case 3:return n=r.sent(),[4,Promise.all([G(),K({client:n})])];case 4:return r.sent(),chrome.runtime.sendMessage({message:"dataRefreshed"}),[4,(0,d.clearExpiredQueryCacheEntries)()];case 5:return r.sent(),[4,(0,A.clearExpiredLocalStorageEntries)()];case 6:return r.sent(),console.log("Data refreshed"),(0,A.setLocalStorageItem)(A.LocalStorageKey.lastDataRefreshTimestampMs,Date.now()),[3,8];case 7:console.log("The data was recently refreshed"),r.label=8;case 8:return[3,10];case 9:console.log("The user is not signed in"),r.label=10;case 10:return[2]}}))}))}function G(){return o(this,void 0,void 0,(function(){var e;return i(this,(function(t){switch(t.label){case 0:return[4,(0,T.runThrottledUserQuery)(0)];case 1:return(e=t.sent())?[4,Promise.all([(0,y.updateAbTestAmplitudeProperties)(e.states),(0,T.refreshLocalStorageUserDataFromQueryResponse)(e)])]:[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}}))}))}t.refreshData=W;var N=500;function K(e){var t=e.client,n=e.backoffDelay,r=void 0===n?N:n,a=e.resolve;return o(this,void 0,void 0,(function(){var e,n;return i(this,(function(o){switch(o.label){case 0:return[4,(0,_.fetchOfferBrowsingTags)(t)];case 1:if(!(e=o.sent())){if(r<N*Math.pow(2,10))return[2,new Promise((function(e){return setTimeout((function(){return K({client:t,backoffDelay:2*r,resolve:e})}),r)}))];a&&a(void 0)}return e?(n=(0,_.sortOfferBrowsingTags)(e),[4,(0,A.setLocalStorageItem)(A.LocalStorageKey.offerBrowsingTags,n)]):[3,3];case 2:o.sent(),o.label=3;case 3:return[4,(0,A.getLocalStorageItem)(A.LocalStorageKey.offerActivatedInSessionTimestampMsMap)];case 4:return void 0!==o.sent()?[3,6]:[4,(0,A.setLocalStorageItem)(A.LocalStorageKey.offerActivatedInSessionTimestampMsMap,{})];case 5:o.sent(),o.label=6;case 6:return a&&a(void 0),[2]}}))}))}var j="triggerDailyEvent",q=1e4;var Q=2;function H(){return o(this,void 0,void 0,(function(){var e,t;return i(this,(function(n){switch(n.label){case 0:return e=Date.now(),[4,(0,A.getLocalStorageItem)(A.LocalStorageKey.lastBrowsingSessionStartedTimestampMs)];case 1:return t=n.sent(),!t||e-t>60*Q*60*1e3?[4,(0,A.setLocalStorageItem)(A.LocalStorageKey.lastBrowsingSessionStartedTimestampMs,e)]:[3,3];case 2:n.sent(),n.label=3;case 3:return[2]}}))}))}var z=1,V="requestExtensionUpdateCheck"},30352:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},c=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},u=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},l=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.handleTriggerPostAffiliateLinkLoadingActionsMessage=t.closeOpenHiddenTabsAfterBackgroundScriptReloading=t.handleHandleUserInterfaceComponentInteractionInBackgroundMessage=t.handleOpenUniversalOnlineOfferActivationInterstitialMessage=void 0;var d=a(n(2543)),f=n(22831),p=n(68460),h=n(58029),v=n(89614),g=n(47248),b=n(45133),y=n(2727),m=n(42792),w=n(93795),S=n(52151),I=n(32495),A=n(7080),k=n(67290),M=n(57419),L=n(22641),T=n(56979),E=n(87626),x=n(16206),C=[g.UserInterfaceComponentInteractionEventType.offerWidgetActivateButton,g.UserInterfaceComponentInteractionEventType.panelOfferDetailsTabCashbackSectionActivateButton,g.UserInterfaceComponentInteractionEventType.cashbackReminderWidgetActivateButton,g.UserInterfaceComponentInteractionEventType.cashbackTrackingLostWidgetReactivateButton,g.UserInterfaceComponentInteractionEventType.cashbackReactivationAtCheckoutWidgetActivateOfferButton,g.UserInterfaceComponentInteractionEventType.panelOfferSearchResult,g.UserInterfaceComponentInteractionEventType.searchResults,g.UserInterfaceComponentInteractionEventType.alternativeOffersWidgetBrowsedAlternativeOffer,g.UserInterfaceComponentInteractionEventType.panelAlternativeOffersSectionBrowsedAlternativeOffer,g.UserInterfaceComponentInteractionEventType.sideButtonWidgetCashbackTab,g.UserInterfaceComponentInteractionEventType.cashbackWidgetActivateButton,g.UserInterfaceComponentInteractionEventType.offerDetails],O=[g.UserInterfaceComponentInteractionEventType.panelOfferDetailsTabBnplSectionStartButton,g.UserInterfaceComponentInteractionEventType.bnplSuggestionAtCheckoutWidgetStartButton],P=[g.UserInterfaceComponentInteractionEventType.couponSuggestionWidgetStartButton],U=[g.UserInterfaceComponentInteractionEventType.copyCouponCodeButton],_=[g.UserInterfaceComponentInteractionEventType.priceComparisonAlternativeButton],D=[g.UserInterfaceComponentInteractionEventType.productSavingButton],R=[g.UserInterfaceComponentInteractionEventType.savedProduct,g.UserInterfaceComponentInteractionEventType.browsedProduct];function F(e){var t=e.userId,n=e.offerId,r=e.triggeringEventType,o=e.isTemporaryUser,i=e.isDevStackMode,a=e.localStorageRegion,s=e.shouldOpenInCurrentTab,c=e.tabUrl,u=e.shouldDisableAffiliateRedirectionMechanism,l=e.hasAcceptedMerchantCookies,d=e.isOpenedInHiddenTab,f=(0,L.getUserEventPlatform)(),p=Math.round(Date.now()/1e3),h=a||v.DEFAULT_REGION;return"https://"+(i?"dev.app.joko.com":"app.joko.com")+(d?"/online-background-offer-activation":"/online-offer-activation")+"/".concat(t,"/").concat(n)+"".concat(i?"/dev":"")+"?triggeringEventPlatform=".concat(f)+"&triggeringEventType=".concat(r)+"&triggeringEventTimestamp=".concat(p)+"".concat(o?"&isTemporaryUser=true":"")+"&region=".concat(h)+(s&&c&&!u?"&redirectUrl=".concat(encodeURIComponent(c)):"")+"".concat(l?"&hasAcceptedMerchantCookies=true":"")}function B(e,t){var n,r,o,i,a,u,l,d,f,p,v,g,b,y,m,S,I,A,k,M,L,T,E,x;return s(this,void 0,void 0,(function(){var s,F,B,G;return c(this,(function(c){switch(c.label){case 0:return C.includes(e)?[2,!0]:O.includes(e)?void 0===(null===(r=null===(n=null==t?void 0:t.browserExtension)||void 0===n?void 0:n.affiliateLinkLoading)||void 0===r?void 0:r.enableAffiliateTrackingForBnplFlowLaunchOverride)||null===(null===(i=null===(o=null==t?void 0:t.browserExtension)||void 0===o?void 0:o.affiliateLinkLoading)||void 0===i?void 0:i.enableAffiliateTrackingForBnplFlowLaunchOverride)?[3,1]:(s=!!(null===(u=null===(a=null==t?void 0:t.browserExtension)||void 0===a?void 0:a.affiliateLinkLoading)||void 0===u?void 0:u.enableAffiliateTrackingForBnplFlowLaunchOverride),[3,3]):[3,4];case 1:return[4,(0,w.checkHasFeature)(h.Feature.enableAffiliateTrackingForBnplFlowLaunch)];case 2:s=c.sent(),c.label=3;case 3:return[2,s];case 4:return P.includes(e)?void 0===(null===(d=null===(l=null==t?void 0:t.browserExtension)||void 0===l?void 0:l.affiliateLinkLoading)||void 0===d?void 0:d.enableAffiliateTrackingForAutoCouponApplicationStartOverride)||null===(null===(p=null===(f=null==t?void 0:t.browserExtension)||void 0===f?void 0:f.affiliateLinkLoading)||void 0===p?void 0:p.enableAffiliateTrackingForAutoCouponApplicationStartOverride)?[3,5]:(F=!!(null===(g=null===(v=null==t?void 0:t.browserExtension)||void 0===v?void 0:v.affiliateLinkLoading)||void 0===g?void 0:g.enableAffiliateTrackingForAutoCouponApplicationStartOverride),[3,7]):[3,8];case 5:return[4,(0,w.checkHasFeature)(h.Feature.enableAffiliateTrackingForAutoCouponApplicationStart)];case 6:F=c.sent(),c.label=7;case 7:return[2,F];case 8:return _.includes(e)?void 0===(null===(y=null===(b=null==t?void 0:t.browserExtension)||void 0===b?void 0:b.affiliateLinkLoading)||void 0===y?void 0:y.enableAffiliateTrackingForPriceComparisonOverride)||null===(null===(S=null===(m=null==t?void 0:t.browserExtension)||void 0===m?void 0:m.affiliateLinkLoading)||void 0===S?void 0:S.enableAffiliateTrackingForPriceComparisonOverride)?[3,9]:(B=!!(null===(A=null===(I=null==t?void 0:t.browserExtension)||void 0===I?void 0:I.affiliateLinkLoading)||void 0===A?void 0:A.enableAffiliateTrackingForPriceComparisonOverride),[3,11]):[3,12];case 9:return[4,(0,w.checkHasFeature)(h.Feature.enableAffiliateTrackingForPriceComparison)];case 10:B=c.sent(),c.label=11;case 11:return[2,B];case 12:return D.includes(e)?void 0===(null===(M=null===(k=null==t?void 0:t.browserExtension)||void 0===k?void 0:k.affiliateLinkLoading)||void 0===M?void 0:M.enableAffiliateTrackingForProductSavingOverride)||null===(null===(T=null===(L=null==t?void 0:t.browserExtension)||void 0===L?void 0:L.affiliateLinkLoading)||void 0===T?void 0:T.enableAffiliateTrackingForProductSavingOverride)?[3,13]:(G=!!(null===(x=null===(E=null==t?void 0:t.browserExtension)||void 0===E?void 0:E.affiliateLinkLoading)||void 0===x?void 0:x.enableAffiliateTrackingForProductSavingOverride),[3,15]):[3,16];case 13:return[4,(0,w.checkHasFeature)(h.Feature.enableAffiliateTrackingForProductSaving)];case 14:G=c.sent(),c.label=15;case 15:return[2,G];case 16:return R.includes(e)?[4,(0,w.checkHasFeature)(h.Feature.enableAffiliateTrackingForClickingSavedOrBrowsedProduct)]:[3,18];case 17:return[2,c.sent()];case 18:return U.includes(e)?[4,W(t)]:[3,20];case 19:return[2,c.sent()];case 20:return[2,!1]}}))}))}function W(e){var t,n,r,o,i,a;return s(this,void 0,void 0,(function(){var s,u;return c(this,(function(c){switch(c.label){case 0:return void 0!==(null===(n=null===(t=null==e?void 0:e.browserExtension)||void 0===t?void 0:t.affiliateLinkLoading)||void 0===n?void 0:n.enableAffiliateTrackingForCouponCodeCopyOverride)&&null!==(null===(o=null===(r=null==e?void 0:e.browserExtension)||void 0===r?void 0:r.affiliateLinkLoading)||void 0===o?void 0:o.enableAffiliateTrackingForCouponCodeCopyOverride)?[2,!!(null===(a=null===(i=null==e?void 0:e.browserExtension)||void 0===i?void 0:i.affiliateLinkLoading)||void 0===a?void 0:a.enableAffiliateTrackingForCouponCodeCopyOverride)]:[4,(0,w.checkHasFeature)(h.Feature.enableAffiliateTrackingForCouponCodeCopy)];case 1:return c.sent()?(u=x.parseSetting,[4,(0,x.getSetting)(g.SettingKey.loadAffiliateLinkOnCopyCouponCodeAffiliatePlatformIdsList)]):[2,!1];case 2:return s=u.apply(void 0,[c.sent()]),[2,!(!(null==e?void 0:e.affiliatePlatformId)||!(null==s?void 0:s.includes(e.affiliatePlatformId)))]}}))}))}function G(e){var t=e.offer,n=e.triggeringEventType;return s(this,void 0,void 0,(function(){var e,r,o,i,a,s;return c(this,(function(c){switch(c.label){case 0:return[4,(0,I.getLocalStorageItem)(I.LocalStorageKey.userId)];case 1:if(!(e=c.sent()))throw new Error("User ID not found for affiliate link loading mechanism");return t.merchantId&&t.personalizedAffiliateLink?(r=t.merchantId,o=t.personalizedAffiliateLink,i=(0,f.v1)(),a=(0,L.getUserEventPlatform)(),s=Math.round(Date.now()/1e3),[2,{userId:e,offerId:t.offerId,merchantId:r,personalizedAffiliateLink:o,triggeringEventId:i,triggeringEventType:n,triggeringEventPlatform:a,triggeringEventTimestamp:s}]):[2,void 0]}}))}))}function N(e,t,n){var r=e.userId,o=e.offerId,i=e.merchantId,a=e.personalizedAffiliateLink,s=e.triggeringEventId,c=e.triggeringEventType,u=e.triggeringEventPlatform,l=e.triggeringEventTimestamp,d="c-".concat((0,f.v1)());return{userId:r,offerId:o,merchantId:i,clickId:d,affiliateLinkUrl:a.replace(r,d),triggeringEventId:s,triggeringEventType:c,triggeringEventPlatform:u,triggeringEventTimestamp:l,affiliateLinkLoadingMethod:t,affiliateLinkLoadingTimestamp:Date.now()/1e3,attemptNumber:n}}function K(e){var t=e.offerId,n=e.merchantId,r=e.clickId,o=e.affiliateLinkUrl,i=e.triggeringEventId,a=e.triggeringEventType,u=e.triggeringEventPlatform,l=e.triggeringEventTimestamp,d=e.affiliateLinkLoadingMethod,f=e.affiliateLinkLoadingTimestamp,p=e.attemptNumber;return s(this,void 0,void 0,(function(){var e;return c(this,(function(s){switch(s.label){case 0:return e={offerId:t,merchantId:n,clickId:r,affiliateLinkUrl:o,triggeringEventId:i,triggeringEventType:a,triggeringEventPlatform:u,triggeringEventTimestamp:l,affiliateLinkLoadingMethod:d,affiliateLinkLoadingTimestamp:f,attemptNumber:p,from:a},[4,Promise.all([(0,L.logUserEventUtil)({type:"clickedAffiliateLink",payload:e}),(0,M.sendAmplitudeEvent)({type:"Offers - Clicked Affiliate Link",properties:e})])];case 1:return s.sent(),[2]}}))}))}function j(e,t){var n=e.delayBeforeFirstAttemptInSeconds,r=e.delayBetweenAttemptsInSeconds,o=e.throttlingDelayInSeconds,i=e.attempts,a=i.numberOfNonBackupAttempts,u=i.firstAttempt,l=i.secondAttempt,d=i.backupAttempt,f=e.testName,p=e.testGroup,h=t.offerId,v=t.merchantId,g=t.triggeringEventId,b=t.triggeringEventType,y=t.triggeringEventPlatform,m=t.triggeringEventTimestamp;return s(this,void 0,void 0,(function(){var e;return c(this,(function(t){switch(t.label){case 0:return e={offerId:h,merchantId:v,triggeringEventId:g,triggeringEventType:b,triggeringEventPlatform:y,triggeringEventTimestamp:m,delayBeforeFirstAttemptInSeconds:n,delayBetweenAttemptsInSeconds:r,throttlingDelayInSeconds:o,numberOfNonBackupAttempts:a,firstAttempt:u,secondAttempt:l,backupAttempt:d,testName:f,testGroup:p},[4,(0,L.logUserEventUtil)({type:"affiliateLinkLoadingMechanismStarted",payload:e})];case 1:return t.sent(),[4,(0,M.sendAmplitudeEvent)({type:"Offers - Affiliate Link Loading Mechanism Started",properties:e})];case 2:return t.sent(),[2]}}))}))}function q(e){var t=e.offerId,n=e.merchantId,r=e.clickId,o=e.affiliateLinkUrl,i=e.triggeringEventId,a=e.triggeringEventType,u=e.triggeringEventPlatform,l=e.triggeringEventTimestamp,d=e.affiliateLinkLoadingMethod,f=e.affiliateLinkLoadingTimestamp,p=e.attemptNumber;return s(this,void 0,void 0,(function(){var e;return c(this,(function(s){switch(s.label){case 0:return e={offerId:t,merchantId:n,clickId:r,affiliateLinkUrl:o,triggeringEventId:i,triggeringEventType:a,triggeringEventPlatform:u,triggeringEventTimestamp:l,affiliateLinkLoadingMethod:d,affiliateLinkLoadingTimestamp:f,attemptNumber:p,from:a},[4,(0,L.logUserEventUtil)({type:"affiliateLinkLoadingAttemptStarted",payload:e})];case 1:return s.sent(),[4,(0,M.sendAmplitudeEvent)({type:"Offers - Affiliate Link Loading Attempt Started",properties:e})];case 2:return s.sent(),[2]}}))}))}function Q(e,t){var n=t.offerId,r=t.merchantId,o=t.clickId,i=t.affiliateLinkUrl,a=t.triggeringEventId,u=t.triggeringEventType,l=t.triggeringEventPlatform,d=t.triggeringEventTimestamp,f=t.affiliateLinkLoadingMethod,p=t.affiliateLinkLoadingTimestamp,h=t.attemptNumber;return s(this,void 0,void 0,(function(){var t;return c(this,(function(s){switch(s.label){case 0:return t={success:e,offerId:n,merchantId:r,clickId:o,affiliateLinkUrl:i,triggeringEventId:a,triggeringEventType:u,triggeringEventPlatform:l,triggeringEventTimestamp:d,affiliateLinkLoadingMethod:f,affiliateLinkLoadingTimestamp:p,attemptNumber:h,from:u},[4,(0,L.logUserEventUtil)({type:"affiliateLinkLoadingAttemptFinished",payload:t})];case 1:return s.sent(),[4,(0,M.sendAmplitudeEvent)({type:"Offers - Affiliate Link Loading Attempt Finished",properties:t})];case 2:return s.sent(),[2]}}))}))}t.handleOpenUniversalOnlineOfferActivationInterstitialMessage=function(e,t){var n;return s(this,void 0,void 0,(function(){var r,o,i,a,s,l,d,f,p,h,v,g,y;return c(this,(function(c){switch(c.label){case 0:return(null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.offerId)?(r=e.data,o=r.offerId,i=r.triggeringEventType,a=r.shouldOpenInCurrentTab,s=r.shouldDisableAffiliateRedirectionMechanism,l=r.hasAcceptedMerchantCookies,[4,(0,I.updateLocalStorageItem)(I.LocalStorageKey.affiliateLinkLoadingRequestTimestampMsMap,(y={},y[o]=Date.now(),y))]):[3,3];case 1:return c.sent(),[4,Promise.all([(0,I.getLocalStorageItem)(I.LocalStorageKey.userId),(0,m.checkIsTemporaryUser)(),(0,b.getDevStackMode)(),(0,I.getLocalStorageItem)(I.LocalStorageKey.userRegion)])];case 2:d=u.apply(void 0,[c.sent(),4]),f=d[0],p=d[1],h=d[2],v=d[3],g=F({userId:f,offerId:o,triggeringEventType:i,isTemporaryUser:p,isDevStackMode:h,localStorageRegion:v,shouldOpenInCurrentTab:a,tabUrl:t,shouldDisableAffiliateRedirectionMechanism:s,hasAcceptedMerchantCookies:l}),a?chrome.tabs.update({url:g,active:!0}):chrome.tabs.create({url:g,active:!0}),Z({offerId:o,shouldRememberOfferActivation:!0}),c.label=3;case 3:return[2]}}))}))},t.handleHandleUserInterfaceComponentInteractionInBackgroundMessage=function(e,t){var n;return s(this,void 0,void 0,(function(){var r,o,i,a,u,l,d;return c(this,(function(f){switch(f.label){case 0:return(null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.offerId)&&"string"==typeof e.data.offerId&&t?(r=e.data,o=r.offerId,i=r.triggeringEventType,a=r.shouldOpenAffiliateLinkInNewActiveTab,u=r.shouldNotRememberOfferActivation,l=r.shouldForceAffiliateLinkLoading,[4,(0,T.getEnrichedMerchantOfferFromAppSync)(o)]):[2];case 1:return(d=f.sent())?[4,B(i,d)]:[2];case 2:return f.sent()?(function(e){var t=e.offer,n=e.triggeringEventType,r=e.tabId,o=e.shouldOpenAffiliateLinkInNewActiveTab,i=e.shouldNotRememberOfferActivation,a=e.shouldForceAffiliateLinkLoading;if(o)return void function(e){var t=e.offer,n=e.triggeringEventType,r=e.shouldNotRememberOfferActivation;s(this,void 0,void 0,(function(){var e,o,i,a;return c(this,(function(s){switch(s.label){case 0:return[4,G({offer:t,triggeringEventType:n})];case 1:return(e=s.sent())?[4,(0,I.updateLocalStorageItem)(I.LocalStorageKey.affiliateLinkLoadingRequestTimestampMsMap,(a={},a[t.offerId]=Date.now(),a))]:[2];case 2:return s.sent(),K(o=N(e,g.AffiliateLinkLoadingMethod.directLoading,1)),q(o),i=o.affiliateLinkUrl,chrome.tabs.update({url:i,active:!0},function(e,t,n,r){return function(){var o=!0;Q(o,e),o&&Z({offerId:t,attemptNumber:1,shouldRememberOfferActivation:C.includes(n)&&!r})}}(o,t.offerId,n,r)),[2]}}))}))}({offer:t,triggeringEventType:n,shouldNotRememberOfferActivation:i});!function(e){var t=e.offer,n=e.triggeringEventType,r=e.tabId,o=e.shouldNotRememberOfferActivation,i=e.shouldForceAffiliateLinkLoading;s(this,void 0,void 0,(function(){var e,a,u,l,d,f,p,b,y,m,A,k,x,O,P=this;return c(this,(function(U){switch(U.label){case 0:return e=t.offerId,S.isMobileAppBrowserExtension?[2]:[4,ne()];case 1:return a=U.sent(),[4,G({offer:t,triggeringEventType:n})];case 2:return u=U.sent(),[4,(0,w.getUserFeaturesMapFromLocalStorageOrNetwork)()];case 3:return l=U.sent(),d=S.isMobileExtension?null==l?void 0:l[h.Feature.backgroundLoadingWithWebAppMobileBrowserExtension]:null==l?void 0:l[h.Feature.backgroundLoadingWithWebAppDesktopBrowserExtension],f=void 0,d&&(f=F({userId:null==u?void 0:u.userId,offerId:e,triggeringEventType:n,isTemporaryUser:!1,isDevStackMode:!1,localStorageRegion:v.DEFAULT_REGION,shouldOpenInCurrentTab:!1,isOpenedInHiddenTab:!0,tabUrl:void 0,shouldDisableAffiliateRedirectionMechanism:!1,hasAcceptedMerchantCookies:!1})),[4,J()];case 4:return p=U.sent(),b=[],y=[],m=function(){return s(P,void 0,void 0,(function(){return c(this,(function(e){switch(e.label){case 0:return a&&u?[4,j(a,u)]:[2];case 1:return e.sent(),a.attempts.firstAttempt&&setTimeout((function(){a.attempts.firstAttempt&&A(1,a.attempts.firstAttempt)}),1e3*a.delayBeforeFirstAttemptInSeconds),a.attempts.secondAttempt&&setTimeout((function(){a.attempts.secondAttempt&&A(a.attempts.numberOfNonBackupAttempts,a.attempts.secondAttempt)}),1e3*(a.delayBeforeFirstAttemptInSeconds+a.delayBetweenAttemptsInSeconds)),[2]}}))}))},A=function(t,o){return s(P,void 0,void 0,(function(){var v,b,y,m;return c(this,(function(w){switch(w.label){case 0:return u?[4,Y(e,o,a.throttlingDelayInSeconds)]:[2];case 1:return v=w.sent(),!i&&v?(function(e){s(this,void 0,void 0,(function(){return c(this,(function(t){switch(t.label){case 0:return[4,Promise.all([(0,L.logUserEventUtil)({type:"affiliateLinkLoadingThrottled",payload:e}),(0,M.sendAmplitudeEvent)({type:"Offers - Affiliate Link Loading Throttled",properties:e})])];case 1:return t.sent(),[2]}}))}))}({offerId:e,triggeringEventType:n,throttlingReason:v}),[2]):[4,(0,I.updateLocalStorageItem)(I.LocalStorageKey.affiliateLinkLoadingRequestTimestampMsMap,(m={},m[e]=Date.now(),m))];case 2:return w.sent(),K(b=N(u,o,t)),q(b),y=b.affiliateLinkUrl,te({offerId:e,affiliateLinkLoadingMethod:o,actionType:"attemptStart"}),o===g.AffiliateLinkLoadingMethod.iframe?function(e,t){var n=e.affiliateLinkUrl,r=e.tabId,o={message:"openLinkInIframe",data:{affiliateLinkUrl:n}};void 0===r?chrome.tabs.query({active:!0,currentWindow:!0},(function(e){if(!e[0].id)throw new Error("No active tab found to open link in iframe");chrome.tabs.sendMessage(e[0].id,o,t)})):chrome.tabs.sendMessage(r,o,t)}({affiliateLinkUrl:y,tabId:r},k(t,g.AffiliateLinkLoadingMethod.iframe,b)):o===g.AffiliateLinkLoadingMethod.hiddenTab&&function(e,t){var n=this,r=e.affiliateLinkUrl,o=e.offerId,i=e.userFeaturesMap,a=e.affiliateLinkBackgroundLoadingDelayBeforeClosingHiddenTabSetting,u=e.shouldUseWebAppForBackgroundLinkLoading,l=e.webAppOnlineOfferActivationUrl,d=S.isMobileExtension?z:H,f=1e3*function(e,t){if(!e||!t)return V[S.isMobileExtension?"mobile":"desktop"];if(S.isMobileExtension){if(e[h.Feature.delayBeforeClosingHiddenTab1MobileBrowserExtension])return t.mobile.value1;if(e[h.Feature.delayBeforeClosingHiddenTab2MobileBrowserExtension])return t.mobile.value2;if(e[h.Feature.delayBeforeClosingHiddenTab3MobileBrowserExtension])return t.mobile.value3;if(e[h.Feature.delayBeforeClosingHiddenTab4MobileBrowserExtension])return t.mobile.value4}else{if(e[h.Feature.delayBeforeClosingHiddenTab1DesktopBrowserExtension])return t.desktop.value1;if(e[h.Feature.delayBeforeClosingHiddenTab2DesktopBrowserExtension])return t.desktop.value2;if(e[h.Feature.delayBeforeClosingHiddenTab3DesktopBrowserExtension])return t.desktop.value3;if(e[h.Feature.delayBeforeClosingHiddenTab4DesktopBrowserExtension])return t.desktop.value4}return V[S.isMobileExtension?"mobile":"desktop"]}(i,a),p=u&&l?l:r;try{var v=void 0;chrome.tabs.create({url:p,active:!1,pinned:!0},(function(e){return s(n,void 0,void 0,(function(){var t;return c(this,(function(n){switch(n.label){case 0:if(!(v=e.id))throw new Error("Hidden tab ID is not defined");return[4,(0,I.getLocalStorageItem)(I.LocalStorageKey.hiddenTabsToClose)];case 1:return(t=n.sent()||[]).push({initialTabId:v,offerId:o,hiddenTabOpenedAtTimestampMs:Date.now()}),[4,(0,I.setLocalStorageItem)(I.LocalStorageKey.hiddenTabsToClose,t)];case 2:return n.sent(),[2]}}))}))}));var g=function(){return s(n,void 0,void 0,(function(){var e,t;return c(this,(function(n){switch(n.label){case 0:return v?[4,chrome.tabs.remove(v)]:[3,2];case 1:n.sent(),n.label=2;case 2:return[4,new Promise((function(e){return setTimeout(e,2e3)}))];case 3:return n.sent(),[4,(0,I.getLocalStorageItem)(I.LocalStorageKey.hiddenTabsToClose)];case 4:return e=n.sent()||[],t=e.filter((function(e){return e.initialTabId!==v})),[4,(0,I.setLocalStorageItem)(I.LocalStorageKey.hiddenTabsToClose,t)];case 5:return n.sent(),[2]}}))}))},b=setTimeout((function(){chrome.tabs.onUpdated.removeListener(y),g(),t(!1)}),d),y=(0,E.withSentry)((function(e,r,i){return s(n,void 0,void 0,(function(){return c(this,(function(n){switch(n.label){case 0:return e===v&&"complete"===r.status&&i.url?[4,(0,T.getEnrichedMerchantOffersMatchingUrlFromAppSync)(i.url,!0)]:[3,2];case 1:n.sent().some((function(e){return e.offerId===o}))&&(clearTimeout(b),chrome.tabs.onUpdated.removeListener(y),setTimeout((function(){g()}),f),t(!0)),n.label=2;case 2:return[2]}}))}))}));chrome.tabs.onUpdated.addListener(y)}catch(e){(0,E.captureSentryException)(e),console.error(e),t(!1)}}({affiliateLinkUrl:y,offerId:e,userFeaturesMap:l,affiliateLinkBackgroundLoadingDelayBeforeClosingHiddenTabSetting:p,shouldUseWebAppForBackgroundLinkLoading:d,webAppOnlineOfferActivationUrl:f},k(t,g.AffiliateLinkLoadingMethod.hiddenTab,b)),[2]}}))}))},k=function(t,n,r){return function(o){Q(o,r),te({offerId:e,affiliateLinkLoadingMethod:n,actionType:"attemptEnd",shouldMarkLastHiddenTabAttemptAsSuccessful:o&&n===g.AffiliateLinkLoadingMethod.hiddenTab}),n===g.AffiliateLinkLoadingMethod.iframe?b.push(o):y.push(o),o&&x(t),t===a.attempts.numberOfNonBackupAttempts&&(function(e,t){return!e.includes(!0)&&!t.includes(!0)}(b,y)&&a.attempts.backupAttempt?A(t+1,a.attempts.backupAttempt):O()),t===a.attempts.numberOfNonBackupAttempts+1&&O()}},x=function(t){Z({offerId:e,attemptNumber:t,shouldRememberOfferActivation:C.includes(n)&&!o})},O=function(){u&&function(e,t,n){var r=e.offerId,o=e.merchantId,i=e.triggeringEventId,a=e.triggeringEventType,u=e.triggeringEventPlatform,l=e.triggeringEventTimestamp;s(this,void 0,void 0,(function(){var e,s,d,f;return c(this,(function(c){switch(c.label){case 0:return e=t.length+n.length,s=t.filter((function(e){return e})).length,d=n.filter((function(e){return e})).length,f={offerId:r,merchantId:o,triggeringEventId:i,triggeringEventType:a,triggeringEventPlatform:u,triggeringEventTimestamp:l,totalNumberOfAttempts:e,totalNumberOfSuccessfulAttempts:s+d,numberOfIframeAttempts:t.length,numberOfSuccessfulIframeAttempts:s,numberOfHiddenTabAttempts:n.length,numberOfSuccessfulHiddenTabAttempts:d,from:a},[4,(0,L.logUserEventUtil)({type:"affiliateLinkLoadingMechanismFinished",payload:f})];case 1:return c.sent(),[4,(0,M.sendAmplitudeEvent)({type:"Offers - Affiliate Link Loading Mechanism Finished",properties:f})];case 2:return c.sent(),[2]}}))}))}(u,b,y)},m(),[2]}}))}))}({offer:t,triggeringEventType:n,tabId:r,shouldNotRememberOfferActivation:i,shouldForceAffiliateLinkLoading:a})}({offer:d,triggeringEventType:i,tabId:t,shouldOpenAffiliateLinkInNewActiveTab:a,shouldNotRememberOfferActivation:u,shouldForceAffiliateLinkLoading:l}),[2]):[2]}}))}))};var H=1e4,z=3e4,V={desktop:2,mobile:2};function J(){return s(this,void 0,void 0,(function(){var e,t,n,r;return c(this,(function(o){switch(o.label){case 0:return n=(t=p.affiliateLinkBackgroundLoadingDelayInSecondsBeforeClosingHiddenTabSettingValidator).safeParse,r=x.parseSetting,[4,(0,x.getSetting)(g.SettingKey.affiliateLinkBackgroundLoadingDelayInSecondsBeforeClosingHiddenTab)];case 1:return(e=n.apply(t,[r.apply(void 0,[o.sent()])])).success?[2,e.data]:[2,void 0]}}))}))}function Z(e){var t=e.offerId,n=e.attemptNumber,r=e.shouldRememberOfferActivation;return s(this,void 0,void 0,(function(){var e;return c(this,(function(o){switch(o.label){case 0:return t?!1===r?[3,2]:[4,(0,I.updateLocalStorageItem)(I.LocalStorageKey.offerActivatedInSessionTimestampMsMap,(e={},e[t]=Date.now(),e))]:[2];case 1:o.sent(),o.label=2;case 2:return n&&1!==n?[3,4]:[4,X(t)];case 3:o.sent(),o.label=4;case 4:return[2]}}))}))}function X(e){return s(this,void 0,void 0,(function(){return c(this,(function(t){switch(t.label){case 0:return[4,(0,b.getClient)()];case 1:return[4,t.sent().mutate({mutation:y.activateUserOfferMutation,fetchPolicy:"no-cache",variables:{offerId:e}}).catch((function(e){console.error("GraphQL: error while running activate user offer mutation:",e),(0,E.captureSentryException)(e)}))];case 2:return t.sent(),[2]}}))}))}function Y(e,t,n){return s(this,void 0,void 0,(function(){var r,o,i,a,s;return c(this,(function(c){switch(c.label){case 0:return[4,(0,I.getLocalStorageItem)(I.LocalStorageKey.affiliateLinkLoadingTimestampMsMap)];case 1:return(r=c.sent())&&"object"==typeof r&&$(r[e])?(o=r[e],i=o.currentHiddenTabAttemptStartTimestampMs,a=o.currentIframeAttemptStartTimestampMs,s=o.lastSuccessfulHiddenTabAttemptTimestampMs,function(e){if(!e)return!1;var t=Date.now(),n=S.isMobileAppBrowserExtension?z:H;return t-e<n}(t===g.AffiliateLinkLoadingMethod.hiddenTab?i:a)?[2,g.AffiliateLinkLoadingThrottlingReason.concurrentAttempt]:[2,ee(s,n)?g.AffiliateLinkLoadingThrottlingReason.recentSuccessfulAttempt:void 0]):[2,void 0]}}))}))}function $(e){return"object"==typeof e&&["number","undefined"].includes(typeof e.lastSuccessfulHiddenTabAttemptTimestampMs)&&["number","undefined"].includes(typeof e.currentHiddenTabAttemptStartTimestampMs)&&["number","undefined"].includes(typeof e.currentIframeAttemptStartTimestampMs)}function ee(e,t){return!!e&&Date.now()-e<1e3*t}function te(e){var t=e.offerId,n=e.affiliateLinkLoadingMethod,o=e.actionType,i=e.shouldMarkLastHiddenTabAttemptAsSuccessful;return s(this,void 0,void 0,(function(){var e,a,s,u,l;return c(this,(function(c){switch(c.label){case 0:return[4,(0,I.getLocalStorageItem)(I.LocalStorageKey.affiliateLinkLoadingTimestampMsMap)];case 1:return e=c.sent(),a=e&&"object"==typeof e&&$(e[t])?e[t]:{},s=Date.now(),u=r(r(r(r(r({},a),n===g.AffiliateLinkLoadingMethod.hiddenTab&&{currentHiddenTabAttemptStartTimestampMs:"attemptStart"===o?s:void 0}),n===g.AffiliateLinkLoadingMethod.iframe&&{currentIframeAttemptStartTimestampMs:"attemptStart"===o?s:void 0}),i&&{lastSuccessfulHiddenTabAttemptTimestampMs:s}),"attemptEnd"===o&&{lastAttemptEndTimestampMs:s}),[4,(0,I.updateLocalStorageItem)(I.LocalStorageKey.affiliateLinkLoadingTimestampMsMap,(l={},l[t]=u,l))];case 2:return c.sent(),[2]}}))}))}function ne(){return s(this,void 0,void 0,(function(){var e,t,n;return c(this,(function(r){switch(r.label){case 0:return t=x.parseSetting,[4,(0,x.getSetting)(g.SettingKey.affiliateLinkLoadingInExtensionsSettings)];case 1:return(e=t.apply(void 0,[r.sent()]))?e.testName?[4,re(e.testName)]:[2,ie(e.defaultConfiguration)]:[2,g.DEFAULT_BACKGROUND_AFFILIATE_LINK_LOADING_CONFIGURATION];case 2:return(n=r.sent())&&e.testConfigurations&&e.testConfigurations[n]?[2,ie(e.testConfigurations[n],e.testName,n)]:[2,ie(e.defaultConfiguration)]}}))}))}function re(e){return s(this,void 0,void 0,(function(){var t,n,r;return c(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,oe()];case 1:return(t=o.sent())?(n=u(t.filter((function(e){return e.stateKey===k.UserStateKey.abTestGroup})),1),(r=n[0])?[2,(r.value?JSON.parse(r.value):{})[e]]:[2,void 0]):[2,void 0];case 2:return o.sent(),[2,void 0];case 3:return[2]}}))}))}function oe(){return s(this,void 0,void 0,(function(){var e;return c(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,(0,A.runThrottledUserQuery)()];case 1:return(null==(e=t.sent())?void 0:e.states)?[2,e.states]:[2,void 0];case 2:return t.sent(),[2,void 0];case 3:return[2]}}))}))}function ie(e,t,n){if(!e)return g.DEFAULT_BACKGROUND_AFFILIATE_LINK_LOADING_CONFIGURATION;var r=ae(e.delayBeforeFirstAttemptInSeconds,g.DEFAULT_BACKGROUND_AFFILIATE_LINK_LOADING_CONFIGURATION.delayBeforeFirstAttemptInSeconds),o=ae(e.delayBetweenAttemptsInSeconds,g.DEFAULT_BACKGROUND_AFFILIATE_LINK_LOADING_CONFIGURATION.delayBetweenAttemptsInSeconds),i=ae(e.throttlingDelayInSeconds,g.DEFAULT_BACKGROUND_AFFILIATE_LINK_LOADING_CONFIGURATION.throttlingDelayInSeconds),a=function(e){var t=S.isMobileExtension?e.mobileExtension:e.desktopExtension;if(!t)return g.DEFAULT_BACKGROUND_AFFILIATE_LINK_LOADING_CONFIGURATION.attempts;var n=t.loadingStrategy;if(!n)return g.DEFAULT_BACKGROUND_AFFILIATE_LINK_LOADING_CONFIGURATION.attempts;var r=se(n.firstAttempt)?n.firstAttempt:void 0,o=se(n.secondAttempt)?n.secondAttempt:void 0,i=se(n.backupAttempt)?n.backupAttempt:void 0,a=(r?1:0)+(o?1:0);return{firstAttempt:r,secondAttempt:o,backupAttempt:i,numberOfNonBackupAttempts:a}}(e),s=a.firstAttempt,c=a.secondAttempt,u=a.backupAttempt;return{delayBeforeFirstAttemptInSeconds:r,delayBetweenAttemptsInSeconds:o,throttlingDelayInSeconds:i,attempts:{numberOfNonBackupAttempts:a.numberOfNonBackupAttempts,firstAttempt:s,secondAttempt:c,backupAttempt:u},testName:t,testGroup:n}}function ae(e,t){return function(e){return void 0!==e&&"number"==typeof e&&!isNaN(e)}(e)?e:t}function se(e){return e===g.AffiliateLinkLoadingMethod.hiddenTab||e===g.AffiliateLinkLoadingMethod.iframe}t.closeOpenHiddenTabsAfterBackgroundScriptReloading=function(){return s(this,void 0,void 0,(function(){var e,t,n,r,o=this;return c(this,(function(i){switch(i.label){case 0:return[4,(0,I.getLocalStorageItem)(I.LocalStorageKey.hiddenTabsToClose)];case 1:return(e=i.sent()||[]).length?[4,(0,I.setLocalStorageItem)(I.LocalStorageKey.hiddenTabsToClose,[])]:[2];case 2:return i.sent(),S.isMobileExtension?[2]:[4,new Promise((function(e){return setTimeout(e,1500)}))];case 3:return i.sent(),t=d.keyBy(e,"initialTabId"),n=d.keyBy(e,"offerId"),r=S.isMobileExtension?z:H,chrome.tabs.query({pinned:!0},(function(e){return s(o,void 0,void 0,(function(){var o,i,a,s,u,f,p;return c(this,(function(h){switch(h.label){case 0:o=function(e){var o,i,a;return c(this,(function(s){switch(s.label){case 0:return e.id&&e.url?t[e.id]?(a=t[e.id].hiddenTabOpenedAtTimestampMs,setTimeout((function(){e.id&&chrome.tabs.remove(e.id)}),d.max([0,r-(Date.now()-a)])),[3,3]):[3,1]:((0,E.captureSentryException)(new Error("Hidden tab ID or URL not found")),[2,"continue"]);case 1:return[4,(0,T.getEnrichedMerchantOffersMatchingUrlFromAppSync)(e.url,!0)];case 2:o=s.sent(),(i=o.find((function(e){return n[e.offerId]})))&&(a=n[i.offerId].hiddenTabOpenedAtTimestampMs,setTimeout((function(){e.id&&chrome.tabs.remove(e.id)}),d.max([0,r-(Date.now()-a)]))),s.label=3;case 3:return[2]}}))},h.label=1;case 1:h.trys.push([1,6,7,8]),i=l(e),a=i.next(),h.label=2;case 2:return a.done?[3,5]:(s=a.value,[5,o(s)]);case 3:h.sent(),h.label=4;case 4:return a=i.next(),[3,2];case 5:return[3,8];case 6:return u=h.sent(),f={error:u},[3,8];case 7:try{a&&!a.done&&(p=i.return)&&p.call(i)}finally{if(f)throw f.error}return[7];case 8:return[2]}}))}))})),[2]}}))}))},t.handleTriggerPostAffiliateLinkLoadingActionsMessage=function(e){e.data&&Z(e.data)}},24808:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleCompareOfferActivatedUrlChangePayload=t.handleSaveOfferActivatedInitialUrlPayload=void 0;var a=n(47248),s=n(32495),c=n(57419),u=n(22641),l=n(87626),d=n(16206);function f(e){return o(this,void 0,void 0,(function(){var t;return i(this,(function(n){switch(n.label){case 0:return[4,(0,s.getLocalStorageItem)(s.LocalStorageKey.savedOfferActivatedUrlAndRedirectsPayloadByTabIdMap)];case 1:return t=n.sent(),[2,e&&(null==t?void 0:t[e])?t[e]:void 0]}}))}))}function p(e,t){return o(this,void 0,void 0,(function(){var n;return i(this,(function(o){switch(o.label){case 0:return n=r(r({},e),{areRedirectsObfuscated:t}),[4,Promise.all([(0,u.logUserEventUtil)({type:"affiliateLinkRedirectionDetected",payload:n,active:!1}),(0,c.sendAmplitudeEvent)({type:"Offers - Affiliate Link Redirection Detected",properties:n})])];case 1:return o.sent(),[2]}}))}))}t.handleSaveOfferActivatedInitialUrlPayload=function(e,t){return o(this,void 0,void 0,(function(){var n,o;return i(this,(function(i){switch(i.label){case 0:return void 0===t?[2]:[4,f(t)];case 1:return(null==(n=i.sent())?void 0:n.redirects)&&n.redirects.length>0&&(delete n.redirects,p(n,!0)),[2,(0,s.updateLocalStorageItem)(s.LocalStorageKey.savedOfferActivatedUrlAndRedirectsPayloadByTabIdMap,(o={},o[t]=r(r({},e.data),{savedAt:Date.now(),redirects:[]}),o))]}}))}))},t.handleCompareOfferActivatedUrlChangePayload=function(e,t){return o(this,void 0,void 0,(function(){var n,r,o,a,c,u,d,h,g,b;return i(this,(function(i){switch(i.label){case 0:return void 0===t?[2]:[4,f(t)];case 1:if(!(n=i.sent()))return[2];Array.isArray(n.redirects)||(n.redirects=[]),i.label=2;case 2:return i.trys.push([2,8,,9]),r=new URL(n.initialUrl),o=new URL(e.data.url),a=r.hostname===o.hostname,c=n.offerId===(e.data.offer?e.data.offer.offerId:void 0),u={url:e.data.url,isSameHostname:a,isSameOffer:c,isSameHostnameAndPath:a&&r.pathname===o.pathname,isSameFullUrl:n.initialUrl===e.data.url,timestamp:Date.now()},[4,v(n.savedAt)];case 3:return d=i.sent(),c||d?[4,(0,s.updateLocalStorageItem)(s.LocalStorageKey.savedOfferActivatedUrlAndRedirectsPayloadByTabIdMap,(g={},g[t]=void 0,g))]:[3,5];case 4:return i.sent(),c?n.redirects.push(u):delete n.redirects,p(n,!c),[3,7];case 5:return n.redirects.push(u),[4,(0,s.updateLocalStorageItem)(s.LocalStorageKey.savedOfferActivatedUrlAndRedirectsPayloadByTabIdMap,(b={},b[t]=n,b))];case 6:i.sent(),i.label=7;case 7:return[3,9];case 8:return h=i.sent(),console.error("Error: ".concat(h)),(0,l.captureSentryException)(h),[3,9];case 9:return[2]}}))}))};var h=30;function v(e){return o(this,void 0,void 0,(function(){var t,n;return i(this,(function(r){switch(r.label){case 0:return null===e||isNaN(e)?[2,!0]:(n=d.parseSetting,[4,(0,d.getSetting)(a.SettingKey.savedOfferActivatedUrlExpirationInSeconds)]);case 1:return void 0===(t=n.apply(void 0,[r.sent()]))&&(t=h),[2,Date.now()-e>1e3*t]}}))}))}},47869:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.getThirdPartyAffiliateLinkLoadingListener=t.handleGetPostAffiliateLinkLoadingJokoFingerprintMessage=void 0;var i=n(55015),a=n(47248),s=n(45133),c=n(59548),u=n(93795),l=n(32495),d=n(51635),f=n(22641),p=n(76038),h=n(16206),v={offerIdToAffiliateFingerprintMap:void 0,lastRefreshTimestampMs:0};function g(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,b()];case 1:return(null==(t=n.sent())?void 0:t[e])?[2,t[e].postAffiliateLinkLoadingJokoFingerprint]:[2,void 0]}}))}))}function b(){return r(this,void 0,void 0,(function(){var e,t;return o(this,(function(n){switch(n.label){case 0:return!v.offerIdToAffiliateFingerprintMap||Date.now()-v.lastRefreshTimestampMs>108e5?[4,(0,s.getAwsAccountId)()]:[3,3];case 1:return e=n.sent(),[4,(0,c.fetchOfferIdToAffiliateFingerprintMapFromS3)(e)];case 2:t=n.sent(),v.offerIdToAffiliateFingerprintMap=t,v.lastRefreshTimestampMs=Date.now(),n.label=3;case 3:return[2,v.offerIdToAffiliateFingerprintMap]}}))}))}t.handleGetPostAffiliateLinkLoadingJokoFingerprintMessage=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,g(e.data.offerId)];case 1:return n=r.sent(),t({postAffiliateLinkLoadingJokoFingerprint:n}),[2]}}))}))},t.getThirdPartyAffiliateLinkLoadingListener=function(){return r(this,void 0,void 0,(function(){var e,t,n=this;return o(this,(function(a){switch(a.label){case 0:return[4,(0,d.getThrottledUserRegion)()];case 1:return(e=a.sent())?[4,(0,c.runThrottledAffiliatePlatformDomainsFromS3Query)(e)]:[2,void 0];case 2:return t=a.sent(),[2,function(e){return r(n,void 0,void 0,(function(){var n,r,a,s;return o(this,(function(o){switch(o.label){case 0:return n=e.url,r=e.redirectUrl,[4,(0,u.checkHasFeatureByPlatform)({desktopFeature:i.Feature.affiliateLinkLoadingDetectionThroughWebRequestsDesktopBrowserExtension,mobileFeature:i.Feature.affiliateLinkLoadingDetectionThroughWebRequestsMobileBrowserExtension})];case 1:return o.sent()?(a=function(e,t){if(!t)return;var n=t.find((function(t){return e.includes(t)}));return n}(n,t),a?[4,(0,p.getMerchantOfferMatchingUrlWithConditionsAndCoupons)(r,!0)]:[2]):[2];case 2:return[4,m(null==(s=o.sent())?void 0:s.offerId)];case 3:return!o.sent()&&a&&s&&function(e){var t,n=e.merchantUrl,r=e.mainOffer,o=e.affiliatePlatformDomain;(0,l.updateLocalStorageItem)(l.LocalStorageKey.thirdPartyAffiliateLinkLoadingTimestampMsMap,((t={})[r.offerId]=Date.now(),t));var i={url:n,offerId:r.offerId,thirdPartyId:void 0,isAffiliateThirdPartyLinkLoading:!0,isNonAffiliateThirdPartyLinkLoading:!1,affiliatePlatformDomain:o,isWebRequestDetection:!0};(0,f.logUserEventUtil)({type:"thirdPartyLinkLoadingDetected",payload:i})}({merchantUrl:r,mainOffer:s,affiliatePlatformDomain:a}),[2]}}))}))}]}}))}))};var y=60;function m(e){var t;return r(this,void 0,void 0,(function(){var n,r,i;return o(this,(function(o){switch(o.label){case 0:return e?[4,(0,l.getLocalStorageItem)(l.LocalStorageKey.affiliateLinkLoadingRequestTimestampMsMap)]:[2,!1];case 1:return n=o.sent(),i=h.parseSetting,[4,(0,h.getSetting)(a.SettingKey.maximumDelayForConsideringAffiliateLinkLoadingRequestAsJokoAffiliateLinkLoadingRequestInSeconds)];case 2:return r=null!==(t=i.apply(void 0,[o.sent()]))&&void 0!==t?t:y,[2,(null==n?void 0:n[e])&&Date.now()-n[e]<1e3*r]}}))}))}},11394:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleRequestCardLinkedOfferNonAffiliateTrackingLinkLoading=void 0;var i=n(47248),a=n(32495),s=n(57419),c=n(22641),u=n(16206);function l(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,(0,a.getLocalStorageItem)(a.LocalStorageKey.trackingLinkLoadingTimestampMsMap)];case 1:return(t=n.sent())&&"object"==typeof t?[4,d(t[e])]:[2,!1];case 2:return[2,n.sent()]}}))}))}function d(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return e?(n=u.parseSetting,[4,(0,u.getSetting)(i.SettingKey.backgroundTrackingLinkLoadingThrottlingRateInSeconds)]):[2,!1];case 1:return"number"!=typeof(t=n.apply(void 0,[r.sent()]))&&(t=180),[2,Date.now()-e<1e3*t]}}))}))}t.handleRequestCardLinkedOfferNonAffiliateTrackingLinkLoading=function(e,t){return r(this,void 0,void 0,(function(){var n,r,u,d,f,p,h;return o(this,(function(o){switch(o.label){case 0:return(null==e?void 0:e.data)?(n=e.data,r=n.offer,u=n.triggeringEventType,r&&r.type===i.OfferType.OneTime&&r.oneTimeOfferTrackingLink?(d=(0,c.getUserEventPlatform)(),f=Math.round(Date.now()/1e3),[4,l(p=r.offerId)]):[2]):[2];case 1:return o.sent()||(h=function(){return function(e){var t;if(e){(0,a.updateLocalStorageItem)(a.LocalStorageKey.trackingLinkLoadingTimestampMsMap,((t={})[p]=Date.now(),t));var n={offerId:p,oneTimeOfferTrackingLink:r.oneTimeOfferTrackingLink,triggeringEventType:u,triggeringEventPlatform:d,triggeringEventTimestamp:f};(0,c.logUserEventUtil)({type:"cardLinkedOfferNonAffiliateTrackingLinkLoaded",payload:n}),(0,s.sendAmplitudeEvent)({type:"Offers - Card-Linked Offer Non Affiliate Tracking Link Loaded",properties:n})}}},function(e,t){var n=e.trackingLinkUrl,r=e.tabId,o={message:"openLinkInIframe",data:{trackingLinkUrl:n}};void 0===r?chrome.tabs.query({active:!0,currentWindow:!0},(function(e){if(!e[0].id)throw new Error("No active tab found to open link in iframe");chrome.tabs.sendMessage(e[0].id,o,t)})):chrome.tabs.sendMessage(r,o,t)}({trackingLinkUrl:r.oneTimeOfferTrackingLink,tabId:t},h())),[2]}}))}))}},42792:function(e,t,n){var r,o=this&&this.__extends||(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return a(t,e),t},c=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},u=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},l=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};Object.defineProperty(t,"__esModule",{value:!0}),t.handleTermsOfServiceAndPrivacyPolicyConsentDetectedMessage=t.handleUpdateCognitoPhoneNumberMessage=t.handleSubmitForgottenPasswordCodeMessage=t.handleSendForgottenPasswordEmailMessage=t.handleVerifyMFACodeMessage=t.handleLoginMessage=t.handleCheckIsTemporaryUserMessage=t.checkIsTemporaryUser=t.triggerPostSignInActions=t.signIn=t.triggerReplacementActionsForRegularAccount=t.clearLocalStorageForAccountReplacement=t.triggerReplacementActionsForTemporaryAccountAndSignOut=t.checkIsTemporaryAccountCreationDisabled=t.createTemporaryAccountAndSignIn=t.UserNotFound=t.handleCheckIsSignedInMessage=t.checkIsSignedIn=void 0;var d=n(30693),f=n(63441),p=n(22831),h=n(55015),v=n(47248),g=s(n(67935)),b=n(45133),y=n(78571),m=n(45901),w=n(68657),S=n(16316),I=n(24785),A=n(52151),k=n(32495),M=n(86459),L=n(51635),T=n(1031),E=n(57419),x=n(22641),C=n(68124),O=n(69479),P=n(87626),U=n(16206),_=n(83503);function D(){return c(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return[4,(0,g.initAuthStorage)()];case 1:return e.sent(),[2,(0,g.checkIsSignedInUnsafe)()]}}))}))}t.checkIsSignedIn=D,t.handleCheckIsSignedInMessage=function(e){return c(this,void 0,void 0,(function(){var t;return u(this,(function(n){switch(n.label){case 0:return[4,D()];case 1:return t=n.sent(),e({isSignedIn:t}),[2]}}))}))};var R=function(e){function t(){var n=e.call(this,"")||this;return n.__proto__=t.prototype,n}return o(t,e),t}(Error),F=function(e){function t(){var n=e.call(this,"")||this;return n.__proto__=t.prototype,n}return o(t,e),t}(Error),B=function(e){function t(){var n=e.call(this,"")||this;return n.__proto__=t.prototype,n}return o(t,e),t}(Error);function W(e){return c(this,void 0,void 0,(function(){var t,n,r;return u(this,(function(o){switch(o.label){case 0:return console.log("API call: getting the user id for email ".concat(e,"...")),(t=new Headers).append("Accept","application/json"),t.append("Content-Type","application/json"),r="".concat,[4,(0,b.getRestApiUrl)()];case 1:return n=r.apply("",[o.sent(),"/user/id?email="]).concat(encodeURIComponent(e)),[2,fetch(n,{method:"GET",headers:t}).then((function(e){if(console.log("Response ".concat(e.status," for API call 'get user id'")),200===e.status)return e.json();throw 422===e.status?new R:409===e.status?new F:new Error("".concat(e.status))})).then((function(e){return e.userId}))]}}))}))}t.UserNotFound=B,t.createTemporaryAccountAndSignIn=function(){return c(this,void 0,void 0,(function(){var e,t,n,r,o,i,a,s,c,l;return u(this,(function(u){switch(u.label){case 0:return(e=(0,w.checkIsExplicitConsentRequired)())?[4,(0,w.checkHasGivenInstallConsent)()]:[3,2];case 1:e=!u.sent(),u.label=2;case 2:return e?[2]:((0,x.logUserEventUtil)({type:"temporaryJokoAccountCreationStarted"}),(0,E.sendAmplitudeEvent)({type:"Registration - Temporary Joko Account Creation Started"}),[4,(0,b.getClient)()]);case 3:return u.sent(),t=(0,p.v1)(),n="temporary+".concat(t,"@joko.com"),[4,(0,L.detectRegion)()];case 4:return r=u.sent(),o=function(e){void 0===e&&(e=30);return new Array(e).fill(null).map((function(){return Math.random().toString(36)[2]})).join("")}(30),a=(i=d.Auth).signUp,c={username:t,password:o},l={email:n.toLowerCase(),"custom:password_type":y.PasswordType.generated,"custom:region":r,"custom:newsletter_consent":"false","custom:signup_platform":(0,x.getUserEventPlatform)()},s="custom:signup_device_id",[4,(0,I.getDeviceId)()];case 5:return[4,a.apply(i,[(c.attributes=(l[s]=u.sent(),l),c)])];case 6:return u.sent(),[4,N(t,o)];case 7:return u.sent(),[4,(0,k.setLocalStorageItem)(k.LocalStorageKey.isTemporaryUser,!0)];case 8:return u.sent(),[4,(0,k.setLocalStorageItem)(k.LocalStorageKey.userRegion,r)];case 9:return u.sent(),A.isMobileSafariExtension?[4,(0,I.enableAdjustTracking)()]:[3,11];case 10:u.sent(),u.label=11;case 11:return(0,x.logUserEventUtil)({type:"temporaryJokoAccountCreated"}),(0,E.sendAmplitudeEvent)({type:"Registration - Temporary Joko Account Created"}),[2]}}))}))},t.checkIsTemporaryAccountCreationDisabled=function(){return c(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return[4,(0,U.getPublicSetting)(v.SettingKey.disableTemporaryAccountCreation)];case 1:return[2,!!e.sent()]}}))}))};var G=void 0;function N(e,t){return c(this,void 0,void 0,(function(){var n,r;return u(this,(function(o){switch(o.label){case 0:return o.trys.push([0,6,,7]),[4,(0,b.getClient)()];case 1:return o.sent(),d.Auth.configure({authenticationFlowType:"CUSTOM_AUTH",storage:g.default}),[4,d.Auth.signIn(e,t)];case 2:return(n=o.sent()).challengeName?[3,4]:[4,Q(e)];case 3:return o.sent(),[2,{mfaRequired:!1}];case 4:if("CUSTOM_CHALLENGE"===n.challengeName)return G=n,[2,{mfaRequired:!0}];throw new Error("Unhandled authentication response");case 5:return[3,7];case 6:throw"UserNotFoundException"===(r=o.sent()).code?new B:r;case 7:return[2]}}))}))}function K(e){return c(this,void 0,void 0,(function(){var t;return u(this,(function(n){switch(n.label){case 0:if(!G)return[3,7];n.label=1;case 1:return n.trys.push([1,5,,6]),[4,(0,b.getClient)()];case 2:return n.sent(),[4,d.Auth.sendCustomChallengeAnswer(G,e)];case 3:return n.sent(),[4,Q(G.username)];case 4:return n.sent(),[3,6];case 5:throw t=n.sent(),console.log("Failed to verify MFA code"),t;case 6:return G=void 0,[3,8];case 7:throw new Error("No MFA request");case 8:return[2]}}))}))}t.triggerReplacementActionsForTemporaryAccountAndSignOut=function(e){var t=e.regularAccountUserId;return c(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return(0,x.logUserEventUtil)({type:"temporaryJokoAccountDisabledAndReplaced",payload:{regularAccountUserId:t}}),(0,E.sendAmplitudeEvent)({type:"Registration - Temporary Joko Account Disabled And Replaced",properties:{regularAccountUserId:t}}),[4,(0,b.getClient)().then((function(e){return e.mutate({mutation:m.replaceTemporaryAccountMutation,variables:{regularAccountUserId:t}})})).catch((function(e){console.error("GraphQL: error while replacing temporary account",e),(0,P.captureSentryException)(e)}))];case 1:return e.sent(),[4,d.Auth.signOut()];case 2:return e.sent(),[2]}}))}))},t.clearLocalStorageForAccountReplacement=function(){return c(this,void 0,void 0,(function(){var e;return u(this,(function(t){switch(t.label){case 0:return[4,(0,k.getLocalStorageItem)(k.LocalStorageKey.installationTimestampMs)];case 1:return e=t.sent(),[4,(0,g.clearAuthStorage)()];case 2:return t.sent(),[4,(0,k.clearLocalStorage)()];case 3:return t.sent(),[4,(0,k.setLocalStorageItem)(k.LocalStorageKey.installed,!0)];case 4:return t.sent(),[4,(0,k.setLocalStorageItem)(k.LocalStorageKey.installationTimestampMs,e)];case 5:return t.sent(),[2]}}))}))},t.triggerReplacementActionsForRegularAccount=function(e){var t=e.temporaryAccountUserId;return c(this,void 0,void 0,(function(){var e,n,r,o,i,a;return u(this,(function(s){switch(s.label){case 0:return(0,x.logUserEventUtil)({type:"replacedTemporaryJokoAccount",payload:{temporaryAccountUserId:t}}),(0,E.sendAmplitudeEvent)({type:"Registration - Replaced Temporary Joko Account",properties:{temporaryAccountUserId:t}}),A.isMobileSafariExtension?[4,Promise.all([(0,k.getLocalStorageItem)(k.LocalStorageKey.userId),(0,b.getDevStackMode)(),(0,k.getLocalStorageItem)(k.LocalStorageKey.userRegion),(0,C.getOnboardingState)(),(0,O.getOrInitPreRegistrationUserSeed)()])]:[3,2];case 1:e=l.apply(void 0,[s.sent(),5]),n=e[0],r=e[1],o=e[2],i=e[3],a=e[4],(0,C.openInstructionWebpage)({userId:n,isDevStackMode:r,region:o,shouldUseSecondInstructionWebsite:!1,shouldOpenInCurrentTab:!1,onboardingState:i,step:C.InstructionStep.temporaryAccountReplacement,userSeed:a}),s.label=2;case 2:return[2]}}))}))},t.signIn=N;var j,q=2e4;function Q(e,t){return c(this,void 0,void 0,(function(){return u(this,(function(n){switch(n.label){case 0:return[4,(0,x.logUserEventUtil)({type:"loggedInToBrowserExtension",payload:{autoLogin:t}})];case 1:return n.sent(),A.isMobileSafariExtension?[4,(0,O.syncMobileSafariExtensionSetupStateInAppGroup)()]:[3,3];case 2:n.sent(),n.label=3;case 3:return[4,(0,k.setLocalStorageItem)(k.LocalStorageKey.userId,e)];case 4:return n.sent(),[4,(0,M.setRedirectionToFeedbackFormOnUninstall)()];case 5:return n.sent(),[4,(0,f.refreshData)(!0)];case 6:return n.sent(),setTimeout((function(){return(0,f.refreshData)(!0)}),q),(0,U.runThrottledSettingsQuery)(0),(0,P.setUserIdSentryTag)(e),(0,w.updateRemoteBrowserExtensionInstallConsents)(),(0,S.addCookieChangeListenerForAffiliateActivationTracking)(),(0,T.addWebRequestListenerForAffiliateActivationTracking)(),function(){if(A.extensionType!==h.ExtensionType.desktopSafariExtension)return;setTimeout((function(){console.log("Reloading background context..."),chrome.runtime.reload()}),1500)}(),[2]}}))}))}function H(){return c(this,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return[4,D()];case 1:return e.sent()?[4,(0,k.getLocalStorageItem)(k.LocalStorageKey.isTemporaryUser)]:[2,!1];case 2:return[2,!0===e.sent()]}}))}))}t.triggerPostSignInActions=Q,t.checkIsTemporaryUser=H,t.handleCheckIsTemporaryUserMessage=function(e){return c(this,void 0,void 0,(function(){var t,n;return u(this,(function(r){switch(r.label){case 0:return t=e,n={},[4,H()];case 1:return t.apply(void 0,[(n.isTemporaryUser=r.sent(),n)]),[2]}}))}))},t.handleLoginMessage=function(e,t){return c(this,void 0,void 0,(function(){var n,r,o,i,a,s;return u(this,(function(c){switch(c.label){case 0:if(c.trys.push([0,6,,7]),!e.data||"string"!=typeof e.data.email||"string"!=typeof e.data.password)throw new Error("Missing Parameters");return n=e.data,r=n.email,o=n.password,[4,W(r)];case 1:return[4,N(c.sent(),_(o))];case 2:return(i=c.sent().mfaRequired)?[3,4]:(t({success:!0}),[4,(0,E.sendAmplitudeEvent)({type:"Registration - Email Login Succeeded"})]);case 3:return c.sent(),[3,5];case 4:(0,k.setLocalStorageItem)(k.LocalStorageKey.mfaRequired,!0),t({success:!1,mfaRequired:i}),c.label=5;case 5:return[3,7];case 6:return a=c.sent(),s={success:!1,errorCode:void 0},a instanceof R||a instanceof F?s.errorCode="EmailAddressUnknown":"NotAuthorizedException"===a.code&&(s.errorCode=a.code),t(s),[3,7];case 7:return[2]}}))}))},t.handleVerifyMFACodeMessage=function(e,t){return c(this,void 0,void 0,(function(){var n,r;return u(this,(function(o){switch(o.label){case 0:if(o.trys.push([0,4,,6]),!e.data||"string"!=typeof e.data.code)throw new Error("Missing Parameters");return[4,K(e.data.code)];case 1:return o.sent(),t({success:!0}),[4,(0,E.sendAmplitudeEvent)({type:"Registration - Email Login Succeeded"})];case 2:return o.sent(),[4,(0,E.sendAmplitudeEvent)({type:"Registration - Login MFA Succeeded"})];case 3:return o.sent(),[3,6];case 4:return n=o.sent(),r={success:!1,errorCode:void 0},[4,(0,E.sendAmplitudeEvent)({type:"Registration - Login MFA Failed"})];case 5:return o.sent(),"NotAuthorizedException"===n.code&&(r.errorCode=n.code),t(r),[3,6];case 6:return[2]}}))}))},t.handleSendForgottenPasswordEmailMessage=function(e,t){return c(this,void 0,void 0,(function(){var n,r,o;return u(this,(function(i){switch(i.label){case 0:return i.trys.push([0,4,,13]),[4,(0,b.getClient)()];case 1:return i.sent(),[4,W(e.data.email)];case 2:return n=i.sent(),[4,d.Auth.forgotPassword(n)];case 3:return i.sent(),t({success:!0,userId:n}),[3,13];case 4:return r=i.sent(),console.log("Sending forgotten password email failed:",r),o={success:!1,errorCode:void 0},r instanceof R?(o.errorCode="EmailAddressUnknown",[4,(0,E.sendAmplitudeEvent)({type:"Registration - Reset Password Failed",properties:{error:"emailAddressUnknown"}})]):[3,6];case 5:return i.sent(),[3,12];case 6:return r instanceof F?(o.errorCode="GeneratedPassword",[4,(0,E.sendAmplitudeEvent)({type:"Registration - Reset Password Failed",properties:{error:"socialLogin"}})]):[3,8];case 7:return i.sent(),[3,12];case 8:return"NotAuthorizedException"!==r.code&&"InvalidParameterException"!==r.code&&"LimitExceededException"!==r.code?[3,10]:(o.errorCode=r.code,"InvalidParameterException"===r.code&&W(e.data.email).then((function(e){return function(e){return c(this,void 0,void 0,(function(){var t,n,r;return u(this,(function(o){switch(o.label){case 0:return console.log("API call: resending confirmation email to user ".concat(e,"...")),(t=new Headers).append("Accept","application/json"),t.append("Content-Type","application/json"),r="".concat,[4,(0,b.getRestApiUrl)()];case 1:return n=r.apply("",[o.sent(),"/email/resend-confirmation?username="]).concat(e),[2,fetch(n,{method:"GET",headers:t}).then((function(e){if(console.log("Response ".concat(e.status," for API call 'resend confirmation email'")),200!==e.status)throw new Error("".concat(e.status))}))]}}))}))}(e)})),[4,(0,E.sendAmplitudeEvent)({type:"Registration - Reset Password Failed",properties:{error:"InvalidParameterException"===r.code?"unverifiedEmailAddress":"LimitExceededException"===r.code?"limitExceeded":"other"}})]);case 9:return i.sent(),[3,12];case 10:return[4,(0,E.sendAmplitudeEvent)({type:"Registration - Reset Password Failed",properties:{error:"other"}})];case 11:i.sent(),i.label=12;case 12:return t(o),[3,13];case 13:return[2]}}))}))},t.handleSubmitForgottenPasswordCodeMessage=function(e,t){return c(this,void 0,void 0,(function(){var n,r,o,i,a,s;return u(this,(function(c){switch(c.label){case 0:return c.trys.push([0,4,,9]),[4,(0,b.getClient)()];case 1:return c.sent(),n=e.data,r=n.userId,o=n.newPasswordMd5,i=n.code,[4,d.Auth.forgotPasswordSubmit(r,i,o)];case 2:return c.sent(),[4,(0,E.sendAmplitudeEvent)({type:"Registration - Reset Password Succeeded"})];case 3:return c.sent(),t({success:!0}),[3,9];case 4:return a=c.sent(),console.log("Submitting forgotten password code failed:",a),s={success:!1,errorCode:void 0},"CodeMismatchException"!==a.code&&"ExpiredCodeException"!==a.code&&"LimitExceededException"!==a.code?[3,6]:(s.errorCode=a.code,[4,(0,E.sendAmplitudeEvent)({type:"Registration - Reset Password Failed",properties:{error:"CodeMismatchException"===a.code?"codeMismatch":"ExpiredCodeException"===a.code?"expiredCode":"LimitExceededException"===a.code?"limitExceeded":"other"}})]);case 5:return c.sent(),[3,8];case 6:return[4,(0,E.sendAmplitudeEvent)({type:"Registration - Reset Password Failed",properties:{error:"other"}})];case 7:c.sent(),c.label=8;case 8:return t(s),[3,9];case 9:return[2]}}))}))},function(e){e.phoneNumber="phone_number"}(j||(j={})),t.handleUpdateCognitoPhoneNumberMessage=function(e,t){return c(this,void 0,void 0,(function(){var n,r,o,i;return u(this,(function(a){switch(a.label){case 0:return a.trys.push([0,4,,5]),[4,(0,b.getClient)()];case 1:return a.sent(),n=e.data.formattedPhoneNumber,[4,d.Auth.currentAuthenticatedUser()];case 2:return r=a.sent(),[4,d.Auth.updateUserAttributes(r,(i={},i[j.phoneNumber]=n,i))];case 3:return a.sent(),t({success:!0}),[3,5];case 4:return o=a.sent(),console.log("Error updating cognito phone number:",o),t({success:!1}),[3,5];case 5:return[2]}}))}))},t.handleTermsOfServiceAndPrivacyPolicyConsentDetectedMessage=function(e){return c(this,void 0,void 0,(function(){var t;return u(this,(function(n){switch(n.label){case 0:return(0,k.setLocalStorageItem)(k.LocalStorageKey.termsOfServiceAndPrivacyPolicyConsentDetectedTimestampMs,Date.now()),(0,k.setLocalStorageItem)(k.LocalStorageKey.termsOfServiceAndPrivacyPolicyConsentDetectedIsDevStackMode,e.data.isDevStackMode),t=e.data.isDevStackMode?b.DevStackMode.activated:b.DevStackMode.deactivated,[4,(0,k.getLocalStorageItem)(k.LocalStorageKey.devStackMode)];case 1:return n.sent()===t?[3,3]:[4,(0,k.setLocalStorageItem)(k.LocalStorageKey.devStackMode,t)];case 2:n.sent(),n.label=3;case 3:return[2]}}))}))}},50111:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.signInWithGoogle=t.GOOGLE_LOGIN_STATE=t.GOOGLE_LOGIN_REDIRECTION_URL=t.GOOGLE_LOGIN_CLIENT_ID=void 0;var a=i(n(44040)),s=i(n(37932)),c=n(22831),u=n(45133),l=n(42792),d=n(78826),f=n(29387),p=n(32495),h=n(57419),v=n(87626);function g(e){return r(this,void 0,void 0,(function(){var n,r,i,a,s;return o(this,(function(o){switch(o.label){case 0:return console.log("Google API: exchanging user code for tokens..."),(n=new Headers).append("Accept","application/json"),i=URL.bind,a="".concat,[4,(0,u.getRestApiUrl)()];case 1:return(r=new(i.apply(URL,[void 0,a.apply("",[o.sent(),"user/exchange-google-code"])]))).searchParams.append("googleClientId",t.GOOGLE_LOGIN_CLIENT_ID),r.searchParams.append("redirectUrl",t.GOOGLE_LOGIN_REDIRECTION_URL),r.searchParams.append("code",e),[4,fetch(r.toString(),{method:"GET",headers:n})];case 2:return[4,o.sent().json()];case 3:return s=o.sent(),console.log("Google API: user code exchanged"),[2,s.id_token]}}))}))}function b(e){var t;return r(this,void 0,void 0,(function(){var n,r,i,c;return o(this,(function(o){switch(o.label){case 0:if(n=a.default.decode(e,{complete:!0}),!(null===(t=null==n?void 0:n.header)||void 0===t?void 0:t.kid))throw new Error("Google login: missing 'kid' key in token header");return console.log("Google API: obtaining public keys to verify integrity of Json Web Token received..."),[4,m()];case 1:return[4,w(o.sent())];case 2:if(r=o.sent(),i=function(e,t){console.log("Google login: matching public key...",e);var n=t.find((function(t){return(null==t?void 0:t.kid)===e}));if(!n)throw new Error("Google login: no matching key found");return console.log("Google login: public key matched"),(0,s.default)(n)}(n.header.kid,r),!(null==(c=a.default.verify(e,i,{algorithms:["RS256"]}))?void 0:c.sub)||"string"!=typeof c.sub)throw new Error("Google login: missing 'sub' key in verified JWT Token");return[2,c]}}))}))}t.GOOGLE_LOGIN_CLIENT_ID="424755138228-4827vp1dnem3ve06dra346mtflgqggma.apps.googleusercontent.com",t.GOOGLE_LOGIN_REDIRECTION_URL="https://www.joko.com/fr/",t.GOOGLE_LOGIN_STATE=(0,c.v1)(),t.signInWithGoogle=function(e){return r(this,void 0,void 0,(function(){var t,n,r;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,9,,12]),[4,(i=e,new Promise((function(e,t){console.log("Google: fetching user code...");var n=(0,v.withSentry)((function(r,o,a){var s;if(chrome.runtime.lastError)return t(chrome.runtime.lastError);if(i===r){var c=null===(s=a.url)||void 0===s?void 0:s.match("code=(.+?)&");if(null==c?void 0:c[1])return console.log("Google: user code fetched"),chrome.tabs.onUpdated.removeListener(n),e(c[1])}}));chrome.tabs.onUpdated.addListener(n),chrome.tabs.get(i,(function(e){return n(i,{},e)}))})))];case 1:return[4,g(o.sent())];case 2:return[4,b(o.sent())];case 3:return t=o.sent(),[4,(0,d.updateTabUrl)(d.OAUTH_LOGIN_RESULT_PAGE_URL)];case 4:if(o.sent(),!(null==t?void 0:t.sub)||"string"!=typeof t.sub)throw new Error("Apple: Missing 'sub' key in verified JWT Token");return[4,(0,f.getSocialIdentityCredentials)({provider:f.Provider.Google,providerUserId:t.sub})];case 5:return n=o.sent(),[4,(0,l.signIn)(n.userId,n.secretKey)];case 6:return o.sent(),[4,(0,p.setLocalStorageItem)(p.LocalStorageKey.googleLoginTabId,void 0)];case 7:return o.sent(),[4,(0,h.sendAmplitudeEvent)({type:"Registration - Google Login Succeeded"})];case 8:return o.sent(),chrome.runtime.sendMessage({message:"loginSucceeded"}),[3,12];case 9:return r=o.sent(),(0,v.captureSentryException)(r),[4,(0,p.setLocalStorageItem)(p.LocalStorageKey.googleLoginTabId,void 0)];case 10:return o.sent(),[4,(0,h.sendAmplitudeEvent)({type:"Registration - Google Login Failed",properties:{type:"".concat(r)}})];case 11:return o.sent(),chrome.runtime.sendMessage({message:"loginFailed",data:{error:r}}),[3,12];case 12:return[2]}var i}))}))};var y="https://accounts.google.com/.well-known/openid-configuration";function m(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return console.log("Google API: fetching identity document..."),[4,fetch(y)];case 1:return e=t.sent(),console.log("Google API: identity document fetched"),[2,e.json()]}}))}))}function w(e){return r(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,fetch(e.jwks_uri).then((function(e){return e.json()})).then((function(e){return e.keys}))];case 1:return[2,t.sent()]}}))}))}},68657:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},i=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};Object.defineProperty(t,"__esModule",{value:!0}),t.updateRemoteBrowserExtensionInstallConsents=t.checkHasGivenTrackingConsent=t.checkHasGivenInstallConsent=t.checkIsExplicitConsentRequired=t.handleSubmitInstallConsentMessage=t.openInstallConsentPage=void 0;var a=n(55015),s=n(45133),c=n(76816),u=n(93667),l=n(52151),d=n(32495),f=n(57419),p=n(22641),h=n(87626),v=(a.browserKind===a.Browser.firefox?"../":"")+"installationPage/index.html?showConsentPage=true";t.openInstallConsentPage=function(){chrome.tabs.create({url:v,active:!0})},t.handleSubmitInstallConsentMessage=function(e){return r(this,void 0,void 0,(function(){var t,n,r;return o(this,(function(o){switch(o.label){case 0:return t=e.data,n=t.isMandatoryPrivacyPolicyConsentGiven,r=t.isTrackingConsentGiven,n?[4,(0,d.setLocalStorageItem)(d.LocalStorageKey.browserExtensionInstallConsentTimestampMap,{mandatoryPrivacyPolicyConsentGivenAtTimestampMs:n?Date.now():void 0,trackingConsentGivenAtTimestampMs:r?Date.now():void 0})]:[3,2];case 1:o.sent(),l.isMobileExtension||(0,u.openWebAppAutoLoginTab)(),(0,p.logUserEventUtil)({type:"submittedBrowserExtensionInstallConsent",active:!1,payload:{isMandatoryPrivacyPolicyConsentGiven:n,isTrackingConsentGiven:r}}),(0,f.sendAmplitudeEvent)({type:"Registration - Submitted Browser Extension Install Consent",properties:{isMandatoryPrivacyPolicyConsentGiven:n,isTrackingConsentGiven:r}}),o.label=2;case 2:return[2]}}))}))};var g=[a.Browser.firefox];function b(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,(0,d.getLocalStorageItem)(d.LocalStorageKey.browserExtensionInstallConsentTimestampMap)];case 1:return[2,!!(null==(e=t.sent())?void 0:e.mandatoryPrivacyPolicyConsentGivenAtTimestampMs)]}}))}))}function y(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,(0,d.getLocalStorageItem)(d.LocalStorageKey.browserExtensionInstallConsentTimestampMap)];case 1:return[2,!!(null==(e=t.sent())?void 0:e.trackingConsentGivenAtTimestampMs)]}}))}))}function m(e,t){return r(this,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return[4,(0,s.getClient)().then((function(n){return n.mutate({mutation:c.updateUserTrackingConsentMutation,variables:{trackingId:e,consentChoice:t}})})).catch((function(e){console.error("GraphQL: error while updating user tracking consent",e),(0,h.captureSentryException)(e)}))];case 1:return n.sent(),[2]}}))}))}t.checkIsExplicitConsentRequired=function(){return!l.isMobileExtension&&g.includes(a.browserKind)},t.checkHasGivenInstallConsent=b,t.checkHasGivenTrackingConsent=y,t.updateRemoteBrowserExtensionInstallConsents=function(){return r(this,void 0,void 0,(function(){var e,t,n;return o(this,(function(r){switch(r.label){case 0:return[4,Promise.all([b(),y()])];case 1:return e=i.apply(void 0,[r.sent(),2]),t=e[0],n=e[1],a.browserKind!==a.Browser.chrome?[3,3]:[4,Promise.all([m(c.TrackingId.chromeExtensionInstallPrivacyPolicyConsent,t),m(c.TrackingId.chromeExtensionInstallTrackingConsent,n)])];case 2:r.sent(),r.label=3;case 3:return a.browserKind!==a.Browser.firefox?[3,5]:[4,Promise.all([m(c.TrackingId.firefoxExtensionInstallPrivacyPolicyConsent,t),m(c.TrackingId.firefoxExtensionInstallTrackingConsent,n)])];case 4:r.sent(),r.label=5;case 5:return a.browserKind!==a.Browser.safari||l.isMobileExtension?[3,7]:[4,Promise.all([m(c.TrackingId.desktopSafariExtensionInstallPrivacyPolicyConsent,t),m(c.TrackingId.desktopSafariExtensionInstallTrackingConsent,n)])];case 6:r.sent(),r.label=7;case 7:return[2]}}))}))}},78826:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.updateTabUrl=t.finishOAuthLogin=t.handleGoogleLoginMessage=t.handleAppleLoginMessage=t.handleFacebookLoginMessage=t.OAUTH_LOGIN_RESULT_PAGE_URL=void 0;var i=n(22831),a=n(45133),s=n(42792),c=n(50111),u=n(29387),l=n(32495),d=n(57419),f=n(87626),p=n(44040),h=n(37932);t.OAUTH_LOGIN_RESULT_PAGE_URL="oAuthLoginPage/index.html";var v="223366131775158",g="https://www.joko.com/fr/",b=(0,i.v1)(),y="https://www.joko.com/fr/",m=(0,i.v1)();function w(e){return r(this,void 0,void 0,(function(){var n,r,i,c,p,h,b;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,10,,13]),[4,(y=e,new Promise((function(e,t){console.log("Facebook: fetching user code...");var n=(0,f.withSentry)((function(r,o,i){var a;if(chrome.runtime.lastError)return t(chrome.runtime.lastError);if(y===r){var s=null===(a=i.url)||void 0===a?void 0:a.match("^".concat(g,"\\?code=(.+?)&"));if(null==s?void 0:s[1])return console.log("Facebook: user code fetched"),chrome.tabs.onUpdated.removeListener(n),e(s[1])}}));chrome.tabs.onUpdated.addListener(n),chrome.tabs.get(y,(function(e){return n(y,{},e)}))})))];case 1:return n=o.sent(),[4,I(t.OAUTH_LOGIN_RESULT_PAGE_URL)];case 2:return o.sent(),console.log("Facebook: exchanging user code for token..."),i=fetch,c="".concat,[4,(0,a.getRestApiUrl)()];case 3:return[4,i.apply(void 0,[c.apply("",[o.sent(),"user/exchange-fb-code"])+"?facebookAppId=".concat(v)+"&redirectUrl=".concat(g)+"&code=".concat(n)]).then((function(e){return e.json()}))];case 4:return r=o.sent(),console.log("Facebook: user code exchanged"),console.log("Facebook: fetching user data..."),[4,fetch("https://graph.facebook.com/me?access_token=".concat(r.access_token,"&fields=email,id,first_name")).then((function(e){return e.json()}))];case 5:return p=o.sent(),console.log("Facebook: user data fetched"),[4,(0,u.getSocialIdentityCredentials)({provider:u.Provider.Facebook,providerUserId:p.id,email:p.email,secretToken:r.access_token})];case 6:return h=o.sent(),[4,(0,s.signIn)(h.userId,h.secretKey)];case 7:return o.sent(),[4,(0,l.setLocalStorageItem)(l.LocalStorageKey.facebookLoginTabId,void 0)];case 8:return o.sent(),[4,(0,d.sendAmplitudeEvent)({type:"Registration - Facebook Login Succeeded"})];case 9:return o.sent(),chrome.runtime.sendMessage({message:"loginSucceeded"}),[3,13];case 10:return b=o.sent(),[4,(0,l.setLocalStorageItem)(l.LocalStorageKey.facebookLoginTabId,void 0)];case 11:return o.sent(),b instanceof u.ConflictingEmail?b="ConflictingEmail":b instanceof s.UserNotFound&&(b="UserNotFound"),[4,(0,d.sendAmplitudeEvent)({type:"Registration - Facebook Login Failed",properties:{type:"".concat(b)}})];case 12:return o.sent(),chrome.runtime.sendMessage({message:"loginFailed",data:{error:b}}),[3,13];case 13:return[2]}var y}))}))}function S(e){return r(this,void 0,void 0,(function(){var n,r,i,a;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,7,,10]),[4,(c=e,new Promise((function(e,t){console.log("Apple: fetching JWT token...");var n=(0,f.withSentry)((function(r,o,i){var a;if(chrome.runtime.lastError)return t(chrome.runtime.lastError);if(c===r){var s=null===(a=i.url)||void 0===a?void 0:a.match("^".concat(y,"#state=(.+?)&code(.+?)&id_token=(.+)"));if((null==s?void 0:s[1])&&s[3])return s[1]!==m?(chrome.tabs.onUpdated.removeListener(n),t("Apple sign in state is not valid")):(console.log("Apple: JWT Token fetched"),chrome.tabs.onUpdated.removeListener(n),e(s[3]))}}));chrome.tabs.onUpdated.addListener(n),chrome.tabs.get(c,(function(e){return n(c,{},e)}))})))];case 1:return n=o.sent(),[4,I(t.OAUTH_LOGIN_RESULT_PAGE_URL)];case 2:if(o.sent(),r=function(e){var t;console.log("Apple: verifying JWT token...");var n=p.decode(e,{complete:!0});if(!(null===(t=null==n?void 0:n.header)||void 0===t?void 0:t.kid))throw new Error("Apple: Missing 'kid' key in token header");var r=function(e){var t=A.find((function(t){return t&&t.kid===e}));if(!t)throw new Error("Apple Sign-in: no matching public key found");return h(t)}(n.header.kid),o=p.verify(e,r,{algorithms:["RS256"]});return console.log("Apple: JWT token verified"),o}(n),!(null==r?void 0:r.sub)||"string"!=typeof r.sub)throw new Error("Apple: Missing 'sub' key in verified JWT Token");return[4,(0,u.getSocialIdentityCredentials)({provider:u.Provider.Apple,providerUserId:r.sub})];case 3:return i=o.sent(),[4,(0,s.signIn)(i.userId,i.secretKey)];case 4:return o.sent(),[4,(0,l.setLocalStorageItem)(l.LocalStorageKey.appleLoginTabId,void 0)];case 5:return o.sent(),[4,(0,d.sendAmplitudeEvent)({type:"Registration - Apple Login Succeeded"})];case 6:return o.sent(),chrome.runtime.sendMessage({message:"loginSucceeded"}),[3,10];case 7:return a=o.sent(),console.log(a),[4,(0,l.setLocalStorageItem)(l.LocalStorageKey.appleLoginTabId,void 0)];case 8:return o.sent(),a instanceof u.ConflictingEmail?a="ConflictingEmail":(a instanceof s.UserNotFound||a instanceof u.MissingEmail)&&(a="UserNotFound"),[4,(0,d.sendAmplitudeEvent)({type:"Registration - Apple Login Failed",properties:{type:"".concat(a)}})];case 9:return o.sent(),chrome.runtime.sendMessage({message:"loginFailed",data:{error:a}}),[3,10];case 10:return[2]}var c}))}))}function I(e){return new Promise((function(t,n){chrome.tabs.update({url:e},(function(e){(null==e?void 0:e.id)?t(e.id):n()}))}))}t.handleFacebookLoginMessage=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,I("https://www.facebook.com/v4.0/dialog/oauth"+"?client_id=".concat(v)+"&redirect_uri=".concat(g)+"&state=".concat(b)+"&scope=public_profile,email")];case 1:return t=r.sent(),[4,(0,l.setLocalStorageItem)(l.LocalStorageKey.facebookLoginTabId,t)];case 2:return r.sent(),[3,4];case 3:return n=r.sent(),(0,f.captureSentryException)(n),e({error:n}),[3,4];case 4:return t?[4,w(t)]:[3,6];case 5:r.sent(),r.label=6;case 6:return[2]}}))}))},t.handleAppleLoginMessage=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,I("https://appleid.apple.com/auth/authorize"+"?client_id=".concat("io.wylr.joko-web")+"&redirect_uri=".concat(y)+"&response_type=code+id_token"+"&state=".concat(m)+"&response_mode=fragment")];case 1:return t=r.sent(),[4,(0,l.setLocalStorageItem)(l.LocalStorageKey.appleLoginTabId,t)];case 2:return r.sent(),[3,4];case 3:return n=r.sent(),(0,f.captureSentryException)(n),e({error:n}),[3,4];case 4:return t?[4,S(t)]:[3,6];case 5:r.sent(),r.label=6;case 6:return[2]}}))}))},t.handleGoogleLoginMessage=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,I("https://accounts.google.com/o/oauth2/auth"+"?client_id=".concat(c.GOOGLE_LOGIN_CLIENT_ID)+"&response_type=code"+"&redirect_uri=".concat(c.GOOGLE_LOGIN_REDIRECTION_URL)+"&state=".concat(c.GOOGLE_LOGIN_STATE)+"&scope=openid profile email")];case 1:return t=r.sent(),[4,(0,l.setLocalStorageItem)(l.LocalStorageKey.googleLoginTabId,t)];case 2:return r.sent(),[3,4];case 3:return n=r.sent(),(0,f.captureSentryException)(n),e({error:n}),[3,4];case 4:return t?[4,(0,c.signInWithGoogle)(t)]:[3,6];case 5:r.sent(),r.label=6;case 6:return[2]}}))}))},t.finishOAuthLogin=function(){(0,l.getLocalStorageItem)(l.LocalStorageKey.facebookLoginTabId).then((function(e){if(e&&"number"==typeof e)return w(e);(0,l.setLocalStorageItem)(l.LocalStorageKey.facebookLoginTabId,void 0)})),(0,l.getLocalStorageItem)(l.LocalStorageKey.appleLoginTabId).then((function(e){if(e&&"number"==typeof e)return S(e);(0,l.setLocalStorageItem)(l.LocalStorageKey.appleLoginTabId,void 0)}))},t.updateTabUrl=I;var A=[{kty:"RSA",kid:"Bh6H7rHVmb",use:"sig",alg:"RS256",n:"2HkIZ7xKMUYH_wtt2Gwq6jXKRl-Ng5vdwd-XcWn5RIW82-uxdmGJyTo3T6MPty-xWUeW7FCs9NlM4yu02GKgwep7TKfnOovP78sd3rESbZsvuN7zD_Vk6aZP7QfqblElUtiMQxh9bu-gZUeMZfa_ndX-P5C4yKtZvXGrSPLLjyAcSmSHNLZnWbZXjeIVsgXWHMr5fwVEAkftHq_4py82xgn2XEK0FK9HmWOCZ47Wcx9fWBnqSi9JTJTUX0lh-kI5TcYfv9UKX2oe3uyOn-A460E_L_4ximlM-lgi3otw26EZfAGY9FFgSZoACjhgw_z5NRbK9dycHRpeLY9GxIyiYw",e:"AQAB"},{kty:"RSA",kid:"lVHdOx8ltR",use:"sig",alg:"RS256",n:"nXDu9MPf6dmVtFbDdAaal_0cO9ur2tqrrmCZaAe8TUWHU8AprhJG4DaQoCIa4UsOSCbCYOjPpPGGdE_p0XeP1ew55pBIquNhNtNNEMX0jNYAKcA9WAP1zGSkvH5m39GMFc4SsGiQ_8Szht9cayJX1SJALEgSyDOFLs-ekHnexqsr-KPtlYciwer5jaNcW3B7f9VNp1XCypQloQwSGVismPHwDJowPQ1xOWmhBLCK50NV38ZjobUDSBbCeLYecMtsdL5ZGv-iufddBh3RHszQiD2G-VXoGOs1yE33K4uAto2F2bHVcKOUy0__9qEsXZGf-B5ZOFucUkoN7T2iqu2E2Q",e:"AQAB"},{kty:"RSA",kid:"pyaRQpAbnY",use:"sig",alg:"RS256",n:"qHiwOpizi6xHG8FIOSWH4l0P1CjLIC7aBFkhbk7BrD4s9KQAs5Sj5xAtOwlZMyP2XFcqRtZBLIMM7vw_CNERtRrhc68se5hQE_vsrHy7ugcQU6ogJS6s54zqO-zTUfaa3mABM6iR-EfgSpvz33WTQZAPtwAyxaSLknHyDzWjHEZ44WqaQBdcMAvgsWMYG5dBfnV-3Or3V2r1vdbinRE5NomE2nsKDbnJ3yo3u-x9TizKazS1JV3umt71xDqbruZLybIrimrzg_i9OSIzT2o5ZWz8zdYkKHZ4cvRPh-DDt8kV7chzR2tenPF2c5WXuK-FumOrjT7WW6uwSvhnhwNZuw",e:"AQAB"}]},29387:function(e,t,n){var r,o=this&&this.__extends||(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},a=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.getSocialIdentityCredentials=t.MissingEmail=t.ConflictingEmail=t.Provider=void 0;var s=n(45133);!function(e){e.Facebook="facebook",e.Apple="apple",e.Google="google"}(t.Provider||(t.Provider={}));var c=function(e){function t(){var n=e.call(this,"")||this;return n.__proto__=t.prototype,n}return o(t,e),t}(Error);t.ConflictingEmail=c;var u=function(e){function t(){var n=e.call(this,"")||this;return n.__proto__=t.prototype,n}return o(t,e),t}(Error);t.MissingEmail=u,t.getSocialIdentityCredentials=function(e){return i(this,void 0,void 0,(function(){var t,n,r,o,i,l,d;return a(this,(function(a){switch(a.label){case 0:return t=e.provider,n=e.providerUserId,r=e.email,o=e.secretToken,console.log("API call: getting social identity credentials for user ".concat(n," for provider ").concat(t,"...")),(i=new Headers).append("Accept","application/json"),i.append("Content-Type","application/json"),d="".concat,[4,(0,s.getRestApiUrl)()];case 1:return l=d.apply("",[a.sent(),"user/social-identity"])+"?provider=".concat(encodeURIComponent(t))+"&providerUserId=".concat(encodeURIComponent(n)),r&&(l+="&email=".concat(encodeURIComponent(r))),o&&(l+="&secretToken=".concat(encodeURIComponent(o))),[2,fetch(l,{method:"GET",headers:i}).then((function(e){switch(console.log("Response ".concat(e.status," for API call 'get social identity'")),e.status){case 200:return e.json();case 409:throw new c;case 422:throw new u;default:throw new Error("".concat(e.status))}}))]}}))}))}},93667:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},i=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};Object.defineProperty(t,"__esModule",{value:!0}),t.handlePopupOpenedMessage=t.processWebAppLoginInfo=t.handleWebAppLoginInfoSentMessage=t.handleWebAppAutoLogin=t.openWebAppAutoLoginTab=void 0;var a=n(25841),s=n(67935),c=n(45133),u=n(42792),l=n(68657),d=n(52151),f=n(32495),p=n(57419),h="https://app.joko.com/",v=void 0;function g(){chrome.tabs.create({url:h,active:!1},(function(e){return v=e.id})),setTimeout((function(){v&&chrome.tabs.remove(v)}),5e3)}t.openWebAppAutoLoginTab=g;function b(e){return r(this,void 0,void 0,(function(){var t,n,r,a,l,d,h,g,b,y,m;return o(this,(function(o){switch(o.label){case 0:return t=Object.keys(e).find((function(e){return e.startsWith("CognitoIdentityServiceProvider")})),[4,Promise.all([(0,u.checkIsSignedIn)(),(0,u.checkIsTemporaryUser)()])];case 1:if(n=i.apply(void 0,[o.sent(),2]),r=n[0],a=n[1],!t||r&&!a)return[3,12];for(g in l=void 0,d=void 0,h="activated"===e["@AuthenticationStore:devStackMode"]?c.DevStackMode.activated:c.DevStackMode.deactivated,e)if((null==(b=g.match(/CognitoIdentityServiceProvider\.([\w-]+)\.([\w-]+)\.([\w-]+)/))?void 0:b[1])&&(null==b?void 0:b[2])){m=i(b,3),l=m[1],d=m[2];break}return l&&d?(y=void 0,[4,(0,u.checkIsTemporaryUser)()]):[3,12];case 2:return o.sent()?[4,(0,f.getLocalStorageItem)(f.LocalStorageKey.userId)]:[3,6];case 3:return y=o.sent(),[4,(0,u.triggerReplacementActionsForTemporaryAccountAndSignOut)({regularAccountUserId:d})];case 4:return o.sent(),[4,(0,u.clearLocalStorageForAccountReplacement)()];case 5:o.sent(),o.label=6;case 6:return[4,(0,f.setLocalStorageItem)(f.LocalStorageKey.cognitoUserPoolWebClientId,l)];case 7:return o.sent(),[4,(0,f.setLocalStorageItem)(f.LocalStorageKey.devStackMode,h)];case 8:return o.sent(),[4,(0,s.importAuthKeysFromAutoLoginData)(e)];case 9:return o.sent(),[4,(0,u.triggerPostSignInActions)(d,!0)];case 10:return o.sent(),(0,p.sendAmplitudeEvent)({type:"Registration - Auto Login Succeeded",properties:{autoLoginMechanism:"webApp"}}),y&&""!==y?[4,(0,u.triggerReplacementActionsForRegularAccount)({temporaryAccountUserId:y})]:[3,12];case 11:o.sent(),o.label=12;case 12:return void 0!==v&&chrome.tabs.remove(v),[2]}}))}))}t.handleWebAppAutoLogin=function(e,t){return r(this,void 0,void 0,(function(){var n,a,s,c,p;return o(this,(function(v){switch(v.label){case 0:return(n=(0,l.checkIsExplicitConsentRequired)())?[4,(0,l.checkHasGivenInstallConsent)()]:[3,2];case 1:n=!v.sent(),v.label=2;case 2:return n?[2]:[4,Promise.all([(0,u.checkIsSignedIn)(),(0,u.checkIsTemporaryUser)()])];case 3:return a=i.apply(void 0,[v.sent(),2]),s=a[0],c=a[1],(null==t?void 0:t.startsWith(h))||(null==t?void 0:t.startsWith("https://dev.app.joko.com/"))?(s&&!c||e&&chrome.tabs.sendMessage(e,{message:"getWebAppLoginInfo"}),[3,7]):[3,4];case 4:return s||d.isMobileExtension?[3,7]:[4,new Promise((function(e){return setTimeout(e,1e3)}))];case 5:return v.sent(),[4,(0,f.getLocalStorageItem)(f.LocalStorageKey.installationTimestampMs)];case 6:(!(p=v.sent())||Date.now()-p>2592e5)&&function(){r(this,void 0,void 0,(function(){var e,t=this;return o(this,(function(n){switch(n.label){case 0:return[4,(0,u.checkIsSignedIn)()];case 1:return(e=n.sent()||d.isMobileExtension)?[3,3]:[4,(0,u.checkIsTemporaryAccountCreationDisabled)()];case 2:e=n.sent(),n.label=3;case 3:if(e)return[2];if(m.isTemporaryAccountCreationTriggered)return[2];m.isTemporaryAccountCreationTriggered=!0,setTimeout((function(){return r(t,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,(0,u.checkIsSignedIn)()];case 1:return e.sent()||(m.isTemporaryAccountCreationTriggered=!1),[2]}}))}))}),w),n.label=4;case 4:return n.trys.push([4,6,,7]),[4,(0,u.createTemporaryAccountAndSignIn)()];case 5:return n.sent(),[3,7];case 6:return n.sent(),m.isTemporaryAccountCreationTriggered=!1,[3,7];case 7:return[2]}}))}))}(),v.label=7;case 7:return[2]}}))}))},t.handleWebAppLoginInfoSentMessage=function(e){var t=e.data;return r(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,b(t)];case 1:return e.sent(),[2]}}))}))},t.processWebAppLoginInfo=b;var y=!1;t.handlePopupOpenedMessage=function(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return(e=a.browserKind===a.Browser.safari)?[4,(0,u.checkIsSignedIn)()]:[3,2];case 1:e=!t.sent(),t.label=2;case 2:return e&&!y&&(y=!0,g()),[2]}}))}))};var m={isTemporaryAccountCreationTriggered:!1},w=15e3},59006:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.openWebAppLoginPage=void 0;var i=n(55015),a=n(45133),s=n(93667),c=n(52151);t.openWebAppLoginPage=function(){var e,t;return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return c.extensionType!==i.ExtensionType.desktopSafariExtension?[3,1]:(null===(t=(e=browser.runtime).sendNativeMessage)||void 0===t||t.call(e,"application.id","startWebAuthenticationSession",(function(e){if(e&&"object"==typeof e&&"callbackUrl"in e&&"string"==typeof e.callbackUrl){console.log("ASWebAuthenticationSession success:",e);var t=new URL(e.callbackUrl),n=new URLSearchParams(t.search),r=Object.fromEntries(n.entries());(0,s.processWebAppLoginInfo)(r)}else console.error("ASWebAuthenticationSession failure:",e)})),[3,3]);case 1:return[4,(0,a.getDevStackMode)()];case 2:n=r.sent(),chrome.tabs.create({url:n?"https://dev.app.joko.com/auth/sign-in":"https://app.joko.com/auth/sign-in",active:!0}),r.label=3;case 3:return[2]}}))}))}},61669:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleCheckWasBnplCardCreatedRecently=t.handleDisplayBnplCardReadyWidgetMessage=t.handleCheckCanDisplayCardReadyWidgetMessage=t.handleBnplCardReadyWidgetDisplay=void 0;var i=n(58029),a=n(47248),s=n(42792),c=n(23441),u=n(93795),l=n(32495),d=n(76038);function f(e,t){return void 0===t&&(t=!0),r(this,void 0,void 0,(function(){var n,r,a;return o(this,(function(o){switch(o.label){case 0:return[4,(0,l.getLocalStorageItem)(l.LocalStorageKey.userFeaturesMap)];case 1:return(null==(n=o.sent())?void 0:n[i.Feature.bnplEnabledDesktopBrowserExtensionNew])?[4,h(t)]:[2,void 0];case 2:return(r=o.sent())?[4,v(r,e)]:[2,void 0];case 3:return(a=o.sent())?[4,g(r)]:[2,void 0];case 4:return o.sent()?[2,{offer:a,lastUserBnplTransactionMetadata:r}]:[2,void 0]}}))}))}t.handleBnplCardReadyWidgetDisplay=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,(0,s.checkIsSignedIn)()];case 1:return r.sent()?[4,(0,u.checkHasFeature)(i.Feature.bnplNewCardReadyDisplayInExtensions)]:[2];case 2:if(r.sent())return[2];if(!e)throw new Error("Tab ID is required to display the BNPL card ready widget");return[4,f(t)];case 3:return(n=r.sent())&&chrome.tabs.sendMessage(e,{message:"displayWidget",data:{widgetType:"bnplCardReady",offer:n.offer,userBnplTransactionCreatedAt:n.lastUserBnplTransactionMetadata.createdAt}}),[2]}}))}))},t.handleCheckCanDisplayCardReadyWidgetMessage=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,f(t)];case 1:return n=r.sent(),e({canDisplayCardReadyWidget:!!n}),[2]}}))}))};var p=2;function h(e){return void 0===e&&(e=!0),r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,(0,l.getLocalStorageItem)(l.LocalStorageKey.lastCreatedUserBnplTransaction)];case 1:return(t=n.sent())&&t.createdAt?e&&(t.numberOfDismissals||0)>=p||t.hasEverReceivedAnAuthorization||[a.BnplTransactionStatus.confirmed,a.BnplTransactionStatus.canceled,a.BnplTransactionStatus.expired].includes(t.status)?[2,void 0]:[2,t]:[2,void 0]}}))}))}function v(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return t?[4,(0,d.getMerchantOfferMatchingUrlWithConditionsAndCoupons)(t,!0)]:[2,void 0];case 1:return(n=r.sent())&&n.offerId===e.offerId?[2,n]:[2,void 0]}}))}))}function g(e){var t,n,i;return r(this,void 0,void 0,(function(){var r,s;return o(this,(function(o){switch(o.label){case 0:return[4,(0,c.runUserBnplTransactionQuery)(Math.round(Date.parse(e.createdAt)/1e3))];case 1:return r=o.sent(),(s=null===(n=null===(t=null==r?void 0:r.data)||void 0===t?void 0:t.user)||void 0===n?void 0:n.bnplTransaction)?[4,(0,l.updateLocalStorageItem)(l.LocalStorageKey.lastCreatedUserBnplTransaction,{status:s.status,hasEverReceivedAnAuthorization:s.swanPaymentCard?s.swanPaymentCard.hasEverReceivedAnAuthorization:void 0})]:[2,!1];case 2:return o.sent(),s.status!==a.BnplTransactionStatus.provisioned||(null===(i=s.swanPaymentCard)||void 0===i?void 0:i.hasEverReceivedAnAuthorization)||Date.parse(s.createdAt)<=Date.now()-864e5?[2,!1]:[2,!0]}}))}))}t.handleDisplayBnplCardReadyWidgetMessage=function(e,t){var n={widgetType:"bnplCardReady",offer:e.data.offer,userBnplTransactionCreatedAt:e.data.userBnplTransactionCreatedAt};void 0===t?chrome.tabs.query({active:!0,currentWindow:!0},(function(e){if(!e[0].id)throw new Error("Tab ID is required to display the BNPL card ready widget");chrome.tabs.sendMessage(e[0].id,{message:"displayWidget",data:n})})):chrome.tabs.sendMessage(t,{message:"displayWidget",data:n})},t.handleCheckWasBnplCardCreatedRecently=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,f(t,!1)];case 1:return n=r.sent(),e({wasBnplCardCreatedRecently:!!n}),[2]}}))}))}},57013:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleDisplayBnplSubscriptionWidgetMessage=void 0;var i=n(42792),a=n(76038);t.handleDisplayBnplSubscriptionWidgetMessage=function(e,t,n){var s,c,u;return r(this,void 0,void 0,(function(){var r;return o(this,(function(o){switch(o.label){case 0:return[4,(0,i.checkIsTemporaryUser)()];case 1:return o.sent()?[2]:(r=null===(s=null==e?void 0:e.data)||void 0===s?void 0:s.offer)?[3,3]:n?[4,(0,a.getMerchantOfferMatchingUrlWithConditionsAndCoupons)(n,!0)]:[2];case 2:if(!(r=o.sent()))return[2];o.label=3;case 3:return(null===(u=null===(c=r.browserExtension)||void 0===c?void 0:c.bnpl)||void 0===u?void 0:u.active)?(void 0===t?chrome.tabs.query({active:!0,currentWindow:!0},(function(e){if(!e[0].id)throw new Error("Tab ID is required to display the BNPL subscription widget");chrome.tabs.sendMessage(e[0].id,{message:"displayWidget",data:{widgetType:"bnplSubscription",offer:r}})})):chrome.tabs.sendMessage(t,{message:"displayWidget",data:{widgetType:"bnplSubscription",offer:r}}),[2]):[2]}}))}))}},23441:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleCreateUserBnplTransactionMessage=t.handleGetUserBnplTransactionsMessage=t.runUserBnplTransactionQuery=t.handleGetUserBnplTransactionMessage=void 0;var a=n(25841),s=n(47248),c=n(45133),u=n(11262),l=n(25566),d=n(37052),f=n(24785),p=n(52151),h=n(32495),v=n(87626);function g(e){return(0,c.getClient)().then((function(t){return t.query({query:l.userBnplTransactionQuery,variables:{createdAt:e},fetchPolicy:"no-cache"})})).catch((function(e){console.error("GraphQL: error while fetching user BNPL transaction",e),(0,v.captureSentryException)(e)}))}t.handleGetUserBnplTransactionMessage=function(e,t){var n,r,a;return o(this,void 0,void 0,(function(){var o,s;return i(this,(function(i){switch(i.label){case 0:return[4,g(e.data.createdAt)];case 1:return o=i.sent(),s=null!==(a=null===(r=null===(n=null==o?void 0:o.data)||void 0===n?void 0:n.user)||void 0===r?void 0:r.bnplTransaction)&&void 0!==a?a:void 0,t({bnplTransaction:s}),[2]}}))}))},t.runUserBnplTransactionQuery=g;function b(){return(0,c.getClient)().then((function(e){return e.query({query:l.userBnplTransactionsQuery,fetchPolicy:"no-cache"})})).catch((function(e){console.error("GraphQL: error while fetching user BNPL transactions:",e),(0,v.captureSentryException)(e)})).then((function(e){var t,n,r;return null!==(r=null===(n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.user)||void 0===n?void 0:n.bnplTransactions)&&void 0!==r?r:void 0}))}function y(e){return o(this,void 0,void 0,(function(){var t,n,o;return i(this,(function(i){switch(i.label){case 0:return n=[r({},e)],o={},[4,m(a.browserKind)];case 1:return t=r.apply(void 0,n.concat([(o.deviceOs=i.sent(),o)])),[2,(0,c.getClient)().then((function(e){return e.mutate({mutation:u.createUserBnplTransactionMutation,variables:t})})).catch((function(e){console.error("GraphQL: error while creating user BNPL transaction",e),(0,v.captureSentryException)(e)}))]}}))}))}function m(e){return o(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:switch(e){case a.Browser.safari:return[3,1];case a.Browser.firefox:return[3,2];case a.Browser.chrome:return[3,3];case a.Browser.mobileAppWebView:return[3,4]}return[3,6];case 1:return p.isMobileSafariExtension?[2,"mobileSafariExtension"]:[2,"desktopSafariExtension"];case 2:return[2,"desktopFirefoxExtension"];case 3:return[2,"desktopChromeExtension"];case 4:return[4,(0,f.getOperatingSystemInfo)()];case 5:return[2,"ios"===t.sent().os?"ios":"android"];case 6:throw console.log("Unexpected browserKind: ".concat(e)),new Error("Unexpected browserKind")}}))}))}t.handleGetUserBnplTransactionsMessage=function(e){return o(this,void 0,void 0,(function(){var t;return i(this,(function(n){switch(n.label){case 0:return[4,(0,d.runThrottledQuery)({queryType:d.ThrottledQueryType.userBnplTransactionsQuery,runQuery:b,throttlingDelayInMs:3e4})];case 1:return t=n.sent(),e({bnplTransactions:t}),[2]}}))}))},t.handleCreateUserBnplTransactionMessage=function(e){var t=e.data;return o(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,y(t)];case 1:return e.sent(),[4,(0,h.setLocalStorageItem)(h.LocalStorageKey.lastCreatedUserBnplTransaction,{createdAt:t.createdAt,status:s.BnplTransactionStatus.created,offerId:t.offerId})];case 2:return e.sent(),[2]}}))}))}},13139:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.updateAbTestAmplitudeProperties=void 0;var o=n(67290),i=n(57419);t.updateAbTestAmplitudeProperties=function(e){var t=e.find((function(e){return e.stateKey===o.UserStateKey.abTestGroup})),n=(null==t?void 0:t.value)?JSON.parse(t.value):{};return(0,i.setAmplitudeUserProperties)(r({},n))}},93795:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.getUserFeaturesMapFromLocalStorageOrNetwork=t.checkHasFeatureFromLocalStorage=t.checkHasFeature=t.checkHasFeatureByPlatform=t.handleGetUserFeaturesMap=void 0;var i=n(58029),a=n(45133),s=n(4120),c=n(42792),u=n(52151),l=n(32495),d=n(87626);function f(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,p()];case 1:return[2,!!(null==(t=n.sent())?void 0:t[e])]}}))}))}function p(){return r(this,void 0,void 0,(function(){var e,t;return o(this,(function(n){switch(n.label){case 0:return[4,(0,c.checkIsSignedIn)()];case 1:return n.sent()?[4,v()]:(console.log("Cannot fetch the user features map because the user is not signed in"),[2,void 0]);case 2:return n.sent()?[4,(0,a.getClient)().then((function(e){return e.query({query:s.userFeaturesMapQuery,fetchPolicy:"no-cache"})})).catch((function(e){console.error("GraphQL: error while fetching user features map",e),(0,d.captureSentryException)(e)})).then((function(e){var t,n,r;return null!==(r=null===(n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.user)||void 0===n?void 0:n.featuresMap)&&void 0!==r?r:void 0}))]:[3,8];case 3:return(t=n.sent())?[3,5]:[4,(0,l.getLocalStorageItem)(l.LocalStorageKey.userFeaturesMap)];case 4:return e=n.sent(),[3,7];case 5:return e=(0,i.parseUserFeaturesMap)(t),[4,Promise.all([(0,l.setLocalStorageItem)(l.LocalStorageKey.userFeaturesMap,e),(0,l.setLocalStorageItem)(l.LocalStorageKey.userFeaturesMapLastFetchedTimestampMs,Date.now())])];case 6:n.sent(),n.label=7;case 7:return[3,10];case 8:return[4,(0,l.getLocalStorageItem)(l.LocalStorageKey.userFeaturesMap)];case 9:e=n.sent(),n.label=10;case 10:return[2,e]}}))}))}t.handleGetUserFeaturesMap=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return t=e,n={},[4,p()];case 1:return t.apply(void 0,[(n.featuresMap=r.sent(),n)]),[2]}}))}))},t.checkHasFeatureByPlatform=function(e){var t=e.desktopFeature,n=e.mobileFeature;return r(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return u.isMobileExtension?[4,f(n)]:[3,2];case 1:case 3:return[2,e.sent()];case 2:return[4,f(t)]}}))}))},t.checkHasFeature=f,t.checkHasFeatureFromLocalStorage=function(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,(0,l.getLocalStorageItem)(l.LocalStorageKey.userFeaturesMap)];case 1:return[2,!!(null==(t=n.sent())?void 0:t[e])]}}))}))},t.getUserFeaturesMapFromLocalStorageOrNetwork=p;var h=36e5;function v(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,(0,l.getLocalStorageItem)(l.LocalStorageKey.userFeaturesMapLastFetchedTimestampMs)];case 1:return e=t.sent()||0,[2,Date.now()-e>h]}}))}))}},52812:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},a=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},s=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},c=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};Object.defineProperty(t,"__esModule",{value:!0}),t.setBadgeListener=void 0;var u=i(n(2543)),l=n(55015),d=n(58029),f=n(42792),p=n(93795),h=n(52151),v=n(4436),g=n(76038),b=n(87626);function y(e,t){var n,r;return a(this,void 0,void 0,(function(){var o,i,a,l,d,f;return s(this,(function(s){switch(s.label){case 0:return o=null===(r=null===(n=e.browserExtension)||void 0===n?void 0:n.coupons)||void 0===r?void 0:r.itemList,(null==t?void 0:t.minNumberOfActiveCouponsForSkipping)?(i=t.minNumberOfActiveCouponsForSkipping,[4,(0,v.checkShouldSkipUnsuccessfulCouponsForOffer)(o,i)]):[2,o.length];case 1:return s.sent()?(a=c(u.partition(o,(function(e){return e.shouldSkip})),2),l=a[0],d=a[1],[4,(0,v.getMaximumNumberOfCouponsDisplayedBrowserExtensionSetting)()]):[2,o.length];case 2:return f=s.sent(),[2,Math.min(d.length+(0,v.getNumberOfUnsuccessfulCouponsToSelectForReevaluation)(l,d,i),f)]}}))}))}t.setBadgeListener=function(){l.browserActionNamespace.setBadgeBackgroundColor({color:"#8D3FEF"});var e=(0,b.withSentry)((function(e,t,n){n.active&&(h.isMobileExtension?function(e,t){a(this,void 0,void 0,(function(){var n;return s(this,(function(r){switch(r.label){case 0:return[4,(0,f.checkIsSignedIn)()];case 1:return r.sent()?[4,(0,g.getMerchantOfferMatchingUrlWithConditionsAndCoupons)(e)]:[2];case 2:return(null==(n=r.sent())?void 0:n.browserExtension)&&(h.isMobileExtension?n.browserExtension.mobileVersion?!1!==n.browserExtension.mobileVersion.displayCashbackWidget:!1!==n.browserExtension.displayCashbackWidget:n.browserExtension.desktopVersion?!1!==n.browserExtension.desktopVersion.displayCashbackWidget:!1!==n.browserExtension.displayCashbackWidget)?l.browserActionNamespace.setBadgeText({text:"1",tabId:t}):l.browserActionNamespace.setBadgeText({text:"",tabId:t}),[2]}}))}))}(n.url,e):function(e,t){var n,r;a(this,void 0,void 0,(function(){var o,i,a,u,h;return s(this,(function(s){switch(s.label){case 0:return[4,(0,f.checkIsSignedIn)()];case 1:return s.sent()?[4,Promise.all([(0,g.getMerchantOfferMatchingUrlWithConditionsAndCoupons)(e),(0,v.getCouponsPriorityManagementSettings)(),(0,p.checkHasFeature)(d.Feature.couponsSideButtonTabMobileBrowserExtension)])]:[2];case 2:return o=c.apply(void 0,[s.sent(),3]),i=o[0],a=o[1],u=o[2],(null===(r=null===(n=null==i?void 0:i.browserExtension)||void 0===n?void 0:n.coupons)||void 0===r?void 0:r.itemList)&&i.browserExtension.coupons.itemList.length>0&&u?[4,y(i,a)]:[3,4];case 3:return h=s.sent(),l.browserActionNamespace.setBadgeText({text:h>99?"99+":h.toString(),tabId:t}),[3,5];case 4:l.browserActionNamespace.setBadgeText({text:"",tabId:t}),s.label=5;case 5:return[2]}}))}))}(n.url,e))}));chrome.tabs.onUpdated.removeListener(e),chrome.tabs.onUpdated.addListener(e)}},9168:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.checkHasActiveBankConnections=t.handleCheckHasDisconnectedBank=void 0;var i=n(45133),a=n(5061),s=n(64448),c=n(12900),u=n(39468),l=n(37052),d=n(69479),f=n(87626);t.handleCheckHasDisconnectedBank=function(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,g()];case 1:return t=n.sent(),e(t),[2]}}))}))},t.checkHasActiveBankConnections=function(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,v()];case 1:return[2,(null!=(e=t.sent())?e:[]).some((function(e){return e.status===a.ConnectionStatus.active}))]}}))}))};var p=108e5;function h(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,(0,d.getMobileSafariLastBankReconnectedAt)()];case 1:return(e=t.sent())?[2,Date.now()-e.valueOf()<3e5]:[2,!1]}}))}))}function v(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,(0,l.runThrottledQuery)({queryType:l.ThrottledQueryType.userBankConnectionsQuery,runQuery:y,throttlingDelayInMs:p})];case 1:return[2,null!=(e=t.sent())?e:[]]}}))}))}function g(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,h()];case 1:return e=t.sent(),[4,(0,l.runThrottledQuery)({queryType:l.ThrottledQueryType.checkHasDisconnectedBankQuery,runQuery:b,throttlingDelayInMs:e?1e4:p})];case 2:return[2,!!t.sent()]}}))}))}function b(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,y()];case 1:return(null==(e=t.sent())?void 0:e.length)?[4,Promise.all(e.map((function(e){return function(e,t){var n;return r(this,void 0,void 0,(function(){var r,i;return o(this,(function(o){switch(o.label){case 0:return[4,(0,c.fetchBudgetInsightConnectionWithSourceAndConnectorData)(e,t)];case 1:return r=o.sent(),i=null===(n=r.sources)||void 0===n?void 0:n.some((function(e){return null!==e.state&&m.has(e.state)})),[2,{budgetInsightConnectionState:r.state,isBudgetInsightConnectionInRecoverableError:i}]}}))}))}(e.budgetInsightUserInfo,e.budgetInsightConnectionId)})))]:[2,!1];case 2:return[2,t.sent().some((function(e){return e.isBudgetInsightConnectionInRecoverableError}))]}}))}))}function y(){var e,t;return r(this,void 0,void 0,(function(){var n,r,a;return o(this,(function(o){switch(o.label){case 0:return[4,(0,i.getClient)()];case 1:n=o.sent(),o.label=2;case 2:return o.trys.push([2,4,,5]),[4,n.query({query:s.userBankConnectionsQuery,fetchPolicy:"no-cache"})];case 3:return r=o.sent(),[2,(null===(t=null===(e=null==r?void 0:r.data)||void 0===e?void 0:e.user)||void 0===t?void 0:t.connections)||void 0];case 4:return a=o.sent(),console.error("GraphQL: error while fetching user bank connections",a),(0,f.captureSentryException)(a),[2,void 0];case 5:return[2]}}))}))}var m=new Set([u.BudgetInsightConnectionState.SCARequired,u.BudgetInsightConnectionState.additionalInformationNeeded,u.BudgetInsightConnectionState.wrongpass,u.BudgetInsightConnectionState.passwordExpired,u.BudgetInsightConnectionState.decoupled,u.BudgetInsightConnectionState.actionNeeded,u.BudgetInsightConnectionState.validating,u.BudgetInsightConnectionState.webauthRequired])},53233:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},i=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};Object.defineProperty(t,"__esModule",{value:!0}),t.setBrowserActionListener=void 0;var a=n(55015),s=n(93667),c=n(42792),u=n(68657),l=n(59006),d=n(52151),f=n(22641),p=n(76038),h=n(56315),v=n(87626);function g(e){var t;return r(this,void 0,void 0,(function(){var n,r,a,v,g,b;return o(this,(function(o){switch(o.label){case 0:if(!e.id)throw new Error("Browser tab ID is undefined");return(0,f.logUserEventUtil)({type:"clickedBrowserExtensionIcon",active:!0,payload:{}}),[4,Promise.all([(0,p.getMerchantOfferMatchingUrlWithConditionsAndCoupons)(e.url),(0,c.checkIsTemporaryUser)(),(0,c.checkIsSignedIn)()])];case 1:return n=i.apply(void 0,[o.sent(),3]),r=n[0],a=n[1],n[2]?[3,5]:d.isMobileExtension?[3,4]:(v=(0,u.checkIsExplicitConsentRequired)())?[4,(0,u.checkHasGivenInstallConsent)()]:[3,3];case 2:v=!o.sent(),o.label=3;case 3:v?(0,u.openInstallConsentPage)():((0,s.openWebAppAutoLoginTab)(),(0,l.openWebAppLoginPage)()),o.label=4;case 4:return[2];case 5:return d.isMobileExtension&&(null===(t=e.url)||void 0===t?void 0:t.match(/^https?:\/\/[a-zA-Z0-9.]*joko\.com/))?[2]:r?[4,(0,h.getUserOfferActivationInfo)(r.offerId)]:[3,7];case 6:return b=o.sent(),[3,8];case 7:b=void 0,o.label=8;case 8:return g=b,chrome.tabs.sendMessage(e.id,{message:"displayWidget",data:{widgetType:"panelFromBrowserActionClick",offer:r,userOfferActivationInfo:g,isTemporaryUser:a}}),[2]}}))}))}t.setBrowserActionListener=function(){var e=(0,v.withSentry)(g);a.browserActionNamespace.onClicked.removeListener(e),a.browserActionNamespace.onClicked.addListener(e)}},98985:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleContentScriptReadyMessage=void 0;var i=n(55015),a=n(42792),s=n(93667),c=n(61669),u=n(52151),l=n(32495),d=n(22641),f=n(68124),p=n(84594),h=n(76038),v=n(16206);t.handleContentScriptReadyMessage=function(e,t,n){var i=Date.now();(0,s.handleWebAppAutoLogin)(t,n),u.isMobileSafariExtension&&((0,p.handleMobileSafariAutoLogin)(!0),(0,f.handleMobileSafariAuthorizationDetection)(n)),function(e){r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return e?(t=!!e.match(/^https?:\/\/[a-zA-Z0-9\.]*joko\.com/),n=Date.now(),[4,(0,l.setLocalStorageItem)(l.LocalStorageKey.lastContentScriptExecutionTimestampMs,n)]):[2];case 1:return r.sent(),t?[3,3]:[4,(0,l.setLocalStorageItem)(l.LocalStorageKey.lastNonJokoContentScriptExecutionTimestampMs,n)];case 2:r.sent(),r.label=3;case 3:return[2]}}))}))}(n),function(e){var t=e.tabId,n=e.tabUrl,i=e.contentScriptReadyMessageReceivedTimestamp,s=e.timeToSendContentScriptReadyMessageAfterPageLoadingStart;r(this,void 0,void 0,(function(){var e,r,c;return o(this,(function(o){switch(o.label){case 0:return t&&n?[4,(0,a.checkIsSignedIn)()]:[2];case 1:return o.sent()?[4,b()]:[2];case 2:return e=o.sent(),(0,d.checkShouldLogEventBasedOnRandomDraw)(e)?[4,(0,h.getMerchantOfferMatchingUrlWithConditionsAndCoupons)(n)]:[2];case 3:return(r=o.sent())?(c={offerId:r.offerId,contentScriptReadyMessageReceivedTimestamp:i,timeToSendContentScriptReadyMessageAfterPageLoadingStart:s},(0,d.logUserEventUtil)({type:"browserExtensionContentScriptReadyMessageReceived",active:!1,payload:c}),[2]):[2]}}))}))}({tabId:t,tabUrl:n,contentScriptReadyMessageReceivedTimestamp:i,timeToSendContentScriptReadyMessageAfterPageLoadingStart:e.data.timeToSendContentScriptReadyMessageAfterPageLoadingStart}),(0,c.handleBnplCardReadyWidgetDisplay)(t,n)};var g=.05;function b(){return r(this,void 0,void 0,(function(){var e,t,n;return o(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),t=v.parseSetting,[4,(0,v.getSetting)(i.SettingKey.specificUserEventsSamplingRate)];case 1:return(e=t.apply(void 0,[r.sent()]))&&e instanceof Object&&"browserExtensionContentScriptReadyMessageReceived"in e?[2,e.browserExtensionContentScriptReadyMessageReceived]:[3,3];case 2:return n=r.sent(),console.warn("Error while fetching `specificUserEventsSamplingRate` setting:",n),[3,3];case 3:return[2,g]}}))}))}},16316:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.addCookieChangeListenerForAffiliateActivationTracking=void 0;var i=n(55015),a=n(42792),s=n(20332),c=n(87626);t.addCookieChangeListenerForAffiliateActivationTracking=function(){return r(this,void 0,void 0,(function(){var e,t;return o(this,(function(n){switch(n.label){case 0:return i.browserKind!==i.Browser.chrome&&i.browserKind!==i.Browser.firefox?[2]:[4,(0,a.checkIsSignedIn)()];case 1:return n.sent()?[4,(0,s.getStandDownComplianceCookieListener)()]:[2];case 2:return(e=n.sent())?(t=(0,c.withSentry)(e),chrome.cookies.onChanged.removeListener(t),chrome.cookies.onChanged.addListener(t),[2]):[2]}}))}))}},24785:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.getOperatingSystemInfo=t.enableAdjustTracking=t.getDeviceId=void 0;var i=n(22831),a=n(55015),s=n(45133),c=n(832),u=n(76816),l=n(52151),d=n(32495),f=n(69479),p=n(87626),h=(0,i.v1)();function v(){return r(this,void 0,void 0,(function(){var e,t;return o(this,(function(n){switch(n.label){case 0:return[4,(0,d.getLocalStorageItem)(d.LocalStorageKey.deviceId)];case 1:return(e=n.sent())?[2,e]:l.isMobileSafariExtension?[4,(0,f.getMobileSafariSharedDeviceId)()]:[3,4];case 2:return(t=n.sent())?[4,(0,d.setLocalStorageItem)(d.LocalStorageKey.deviceId,t)]:[3,4];case 3:return n.sent(),[2,t];case 4:return[4,(0,d.setLocalStorageItem)(d.LocalStorageKey.deviceId,h)];case 5:return n.sent(),[2,h]}}))}))}t.getDeviceId=v;t.enableAdjustTracking=function(){return r(this,void 0,void 0,(function(){var e,t,n,r;return o(this,(function(o){switch(o.label){case 0:return l.isMobileSafariExtension?[4,(0,s.getClient)()]:[2];case 1:return e=o.sent(),[4,v()];case 2:return t=o.sent(),[4,(0,f.getMobileSafariSharedAdjustId)()];case 3:return n=o.sent(),t?(r={deviceId:t,adjustId:n},[4,e.mutate({mutation:c.createOrUpdateDeviceIdMutation,variables:r}).catch((function(e){console.error("GraphQL: error while creating or updating device ID",e),(0,p.captureSentryException)(e)}))]):[3,5];case 4:o.sent(),o.label=5;case 5:return n?(r={trackingId:u.TrackingId.adjustMarketingAttributionMobileApp,consentChoice:!0},[4,e.mutate({mutation:u.updateUserTrackingConsentMutation,variables:r}).catch((function(e){console.error("GraphQL: error while updating user tracking consent",e),(0,p.captureSentryException)(e)}))]):[3,7];case 6:o.sent(),o.label=7;case 7:return[2]}}))}))},t.getOperatingSystemInfo=function(){return new Promise((function(e){chrome.runtime.getPlatformInfo((function(t){var n,r=t.os,o=void 0;switch(r){case"win":o=-1!==navigator.appVersion.indexOf("Windows NT 10.")?"Windows 10":-1!==navigator.appVersion.indexOf("Windows NT 6.3")?"Windows 8.1":-1!==navigator.appVersion.indexOf("Windows NT 6.2")?"Windows 8":-1!==navigator.appVersion.indexOf("Windows NT 6.1")?"Windows 7":-1!==navigator.appVersion.indexOf("Windows NT 6.0")?"Windows Vista":-1!==navigator.appVersion.indexOf("Windows NT 5.2")?"Windows Server 2003; Windows XP x64 Edition":-1!==navigator.appVersion.indexOf("Windows NT 5.1")?"Windows XP":-1!==navigator.appVersion.indexOf("Windows NT 5.01")?"Windows 2000, Service Pack 1 (SP1)":-1!==navigator.appVersion.indexOf("Windows NT 5.0")?"Windows 2000":-1!==navigator.appVersion.indexOf("Windows NT 4.0")?"Windows NT 4.0":-1!==navigator.appVersion.indexOf("Windows 98; Win 9x 4.90")?"Windows Millennium Edition (Windows Me)":-1!==navigator.appVersion.indexOf("Windows 98")?"Windows 98":-1!==navigator.appVersion.indexOf("Windows 95")?"Windows 95":-1!==navigator.appVersion.indexOf("Windows CE")?"Windows CE":void 0;break;case"android":o=(n=a.navigatorNamespace.appVersion.match(/Android (\d+)/))?n[1]:void 0;break;case"mac":case"ios":o=function(){var e=a.navigatorNamespace.appVersion.match(/\d+(_\d+){1,2}/);return e?e[0].replace(/_/g,"."):void 0}()}e({os:r,osVersion:o})}))}))}},52151:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.handleGetExtensionTypeMessage=t.isMobileAppBrowserExtension=t.isMobileSafariExtension=t.isMobileExtension=t.detectExtensionType=t.extensionType=void 0;var r=n(25841),o=n(47248);function i(){return r.browserKind===r.Browser.chrome?o.ExtensionType.desktopChromeExtension:r.browserKind===r.Browser.firefox?o.ExtensionType.desktopFirefoxExtension:r.browserKind===r.Browser.mobileAppWebView?o.ExtensionType.mobileAppBrowserExtension:r.browserKind===r.Browser.safari?-1!==navigator.userAgent.toLowerCase().indexOf("macintosh")?o.ExtensionType.desktopSafariExtension:o.ExtensionType.mobileSafariExtension:o.ExtensionType.unknownBrowserExtension}t.extensionType=i(),t.detectExtensionType=i,t.isMobileExtension=t.extensionType===o.ExtensionType.mobileSafariExtension||t.extensionType===o.ExtensionType.mobileAppBrowserExtension,t.isMobileSafariExtension=t.extensionType===o.ExtensionType.mobileSafariExtension,t.isMobileAppBrowserExtension=t.extensionType===o.ExtensionType.mobileAppBrowserExtension,t.handleGetExtensionTypeMessage=function(e){e({extensionType:t.extensionType})}},42737:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleLoadImageMessage=void 0;var i=n(87626);t.handleLoadImageMessage=function(e,t){return r(this,void 0,void 0,(function(){var n,r,a,s,c;return o(this,(function(o){switch(o.label){case 0:n=e.data.imageUrl,o.label=1;case 1:return o.trys.push([1,4,,5]),[4,fetch(n)];case 2:if(!(r=o.sent()).ok)throw new Error("Failed to load image: ".concat(n));return[4,r.blob()];case 3:return a=o.sent(),(s=new FileReader).onloadend=function(){var e=s.result;t({base64Image:e})},s.onerror=function(){throw new Error("Failed to load image: ".concat(n))},s.readAsDataURL(a),[3,5];case 4:return c=o.sent(),console.error("Failed to load image: ".concat(n)),(0,i.captureSentryException)(c),t({base64Image:void 0}),[3,5];case 5:return[2]}}))}))}},32495:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.clearExpiredLocalStorageEntries=t.removeLocalStorageItem=t.clearLocalStorage=t.getLocalStorageCouponAutomationState=t.setLocalStorageCouponAutomationState=t.updateLocalStorageItem=t.setLocalStorageItem=t.getLocalStorageItem=t.LocalStorageKey=void 0;var a,s=n(65547);function c(e){return new Promise((function(t){chrome.storage.local.get(e,(function(n){return t(n[e])}))}))}function u(e,t){return new Promise((function(n){var r;chrome.storage.local.set(((r={})[e]=t,r),n)}))}!function(e){e.installed="installed",e.installationTimestampMs="installationTimestampMs",e.browserExtensionInstallConsentTimestampMap="browserExtensionInstallConsentTimestampMap",e.devStackMode="devStackMode",e.cognitoUserPoolWebClientId="cognitoUserPoolWebClientId",e.cognitoBackupData="cognitoBackupData",e.isTemporaryUser="isTemporaryUser",e.facebookLoginTabId="facebookLoginTabId",e.appleLoginTabId="appleLoginTabId",e.googleLoginTabId="googleLoginTabId",e.deviceId="deviceId",e.sessionId="sessionId",e.lastEventTimestampMs="lastEventTimestampMs",e.lastDailyEventDate="lastDailyEventDate",e.userId="userId",e.userFirstName="userFirstName",e.userPoints="userPoints",e.userPendingPoints="userPendingPoints",e.userRegion="userRegion",e.userStatesMap="userStatesMap",e.userFeaturesMap="userFeaturesMap",e.userFeaturesMapLastFetchedTimestampMs="userFeaturesMapLastFetchedTimestampMs",e.userDataLastFetchedTimestampMs="userDataLastFetchedTimestampMs",e.lastDataRefreshTimestampMs="lastDataRefreshTimestampMs",e.lastContentScriptExecutionTimestampMs="lastContentScriptExecutionTimestampMs",e.lastNonJokoContentScriptExecutionTimestampMs="lastNonJokoContentScriptExecutionTimestampMs",e.offerActivatedInSessionTimestampMsMap="offerActivatedInSessionTimestampMsMap",e.affiliateLinkLoadingTimestampMsMap="affiliateLinkLoadingTimestampMsMap",e.affiliateLinkLoadingRequestTimestampMsMap="affiliateLinkLoadingRequestTimestampMsMap",e.thirdPartyAffiliateLinkLoadingTimestampMsMap="thirdPartyAffiliateLinkLoadingTimestampMsMap",e.offerWidgetLastClosedInSessionTimestampMsMap="offerWidgetLastClosedInSessionTimestampMsMap",e.trackingLinkLoadingTimestampMsMap="trackingLinkLoadingTimestampMsMap",e.offerIdToMerchantOfferMap="offerIdToMerchantOfferMap",e.offerBrowsingTags="offerBrowsingTags",e.unsuccessfulCouponsSelectedForReevaluationMap="unsuccessfulCouponsSelectedForReevaluationMap",e.couponWidgetDisplayDecisionForOffersWithOnlyUnsuccessfulCouponsMap="couponWidgetDisplayDecisionForOffersWithOnlyUnsuccessfulCouponsMap",e.couponAutomationStateKeyPrefix="couponAutomationState-",e.savedUserEvents="savedUserEvents",e.mfaRequired="mfaRequired",e.onboardingState="onboardingState",e.hasAlreadyDetectedMobileSafariAuthorization="hasAlreadyDetectedMobileSafariAuthorization",e.hasAlreadyDetectedMobileSafariAuthorizationOnInstructionWebsite1="hasAlreadyDetectedMobileSafariAuthorizationOnInstructionWebsite1",e.hasAlreadyDetectedMobileSafariAuthorizationOnInstructionWebsite2="hasAlreadyDetectedMobileSafariAuthorizationOnInstructionWebsite2",e.hasAlreadyDetectedMobileSafariAuthorizationOnAllWebsites="hasAlreadyDetectedMobileSafariAuthorizationOnAllWebsites",e.hasAlreadyDisplayedMobileSafariSetupConclusionPage="hasAlreadyDisplayedMobileSafariSetupConclusionPage",e.lastCreatedUserBnplTransaction="lastCreatedUserBnplTransaction",e.unfinishedBnplSubscriptionStateByTabIdMap="unfinishedBnplSubscriptionStateByTabIdMap",e.isMobileSafariAuthorizationMissing="isMobileSafariAuthorizationMissing",e.lastBrowsingSessionStartedTimestampMs="lastBrowsingSessionStartedTimestampMs",e.lastAuthorizationBannerSessionStartedTimestampMs="lastAuthorizationBannerSessionStartedTimestampMs",e.lastAuthorizationBannerTriggeredTimestampMs="lastAuthorizationBannerTriggeredTimestampMs",e.lastAuthorizationPageTriggeredTimestampMs="lastAuthorizationPageTriggeredTimestampMs",e.lastFetchedUserHistoryTimestampMs="lastFetchedUserHistoryTimestampMs",e.userSavedWebpagesSessionData="userSavedWebpagesSessionData",e.capturedWebpageDataByTabIdMap="capturedWebpageDataByTabIdMap",e.lastBrowsedToMerchantWebsiteEventsEmissionTimestampMillisecondsMap="lastBrowsedToMerchantWebsiteEventsEmissionTimestampMillisecondsMap",e.termsOfServiceAndPrivacyPolicyConsentDetectedTimestampMs="termsOfServiceAndPrivacyPolicyConsentDetectedTimestampMs",e.termsOfServiceAndPrivacyPolicyConsentDetectedIsDevStackMode="termsOfServiceAndPrivacyPolicyConsentDetectedIsDevStackMode",e.savedOfferActivatedUrlAndRedirectsPayloadByTabIdMap="savedOfferActivatedUrlAndRedirectsPayloadByTabIdMap",e.userOfferActivationInfoMap="userOfferActivationInfoMap",e.thirdPartyExtensionsLastDetectedTimestampInSecondsMap="thirdPartyExtensionsLastDetectedTimestampInSecondsMap",e.lastPageLoadStartTimestampByTabIdMap="lastPageLoadStartTimestampByTabIdMap",e.hiddenTabsToClose="hiddenTabsToClose",e.priceComparisonWidgetLastClosedInSessionTimestampMsMap="priceComparisonWidgetLastClosedInSessionTimestampMsMap"}(a=t.LocalStorageKey||(t.LocalStorageKey={})),t.getLocalStorageItem=c,t.setLocalStorageItem=u,t.updateLocalStorageItem=function(e,t){return new Promise((function(n){chrome.storage.local.get([e],(function(o){var i,a=o[e],s=r(r({},a),t);chrome.storage.local.set(((i={})[e]=s,i),n)}))}))},t.setLocalStorageCouponAutomationState=function(e,t){return u("".concat(a.couponAutomationStateKeyPrefix).concat(e),{state:t,timestampInMs:Date.now()})},t.getLocalStorageCouponAutomationState=function(e){return c("".concat(a.couponAutomationStateKeyPrefix).concat(e))},t.clearLocalStorage=function(){return new Promise((function(e){chrome.storage.local.clear(e)}))},t.removeLocalStorageItem=function(e){return new Promise((function(t){chrome.storage.local.remove(e,t)}))},t.clearExpiredLocalStorageEntries=function(){return o(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,(0,s.clearExpiredPriceComparisonLocalStorageData)()];case 1:return e.sent(),[2]}}))}))}},78707:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.handleBackgroundMessage=t.setMessageListener=void 0;var r=n(45133),o=n(30352),i=n(24808),a=n(47869),s=n(11394),c=n(42792),u=n(68657),l=n(78826),d=n(93667),f=n(61669),p=n(57013),h=n(23441),v=n(93795),g=n(9168),b=n(98985),y=n(52151),m=n(42737),w=n(60179),S=n(7080),I=n(70986),A=n(67290),k=n(4436),M=n(57419),L=n(86247),T=n(22641),E=n(68124),x=n(84594),C=n(56979),O=n(76038),P=n(13922),U=n(56315),_=n(53556),D=n(76387),R=n(53527),F=n(65547),B=n(33837),W=n(62606),G=n(87626),N=n(16206);function K(e,t,n){var G,K,j,q,Q,H,z,V,J,Z,X,Y,$,ee,te;switch(e.message){case"pingBackgroundScriptFromContentScript":n("pingContentScriptFromBackgroundScript");break;case"switchStack":(0,r.switchStackMode)().then(n).catch((function(e){return n(e)}));break;case"submitInstallConsent":(0,u.handleSubmitInstallConsentMessage)(e);break;case"login":(0,c.handleLoginMessage)(e,n);break;case"loginWithFacebook":(0,l.handleFacebookLoginMessage)(n);break;case"loginWithApple":(0,l.handleAppleLoginMessage)(n);break;case"loginWithGoogle":(0,l.handleGoogleLoginMessage)(n);break;case"verifyMFACode":(0,c.handleVerifyMFACodeMessage)(e,n);break;case"forceMobileSafariAutoLogin":(0,x.handleForceMobileSafariAutoLoginMessage)();break;case"contentScriptReady":(0,b.handleContentScriptReadyMessage)(e,null===(G=null==t?void 0:t.tab)||void 0===G?void 0:G.id,null===(K=null==t?void 0:t.tab)||void 0===K?void 0:K.url);break;case"handleOfferWidgetDisplay":(0,R.handleHandleOfferWidgetDisplayMessage)(e,null===(j=null==t?void 0:t.tab)||void 0===j?void 0:j.id,null===(q=null==t?void 0:t.tab)||void 0===q?void 0:q.url);break;case"getOffersByTags":(0,_.handleGetOffersByTagsMessage)(e,n);break;case"searchOffers":(0,D.handleSearchOffersMessage)(e,n);break;case"getMerchantOffersWithConditionsAndCouponsFromOfferIds":(0,O.handleGetMerchantOffersWithConditionsAndCouponsFromOfferIdsMessage)(e,n);break;case"getMerchantOfferMatchingUrlWithConditionsAndCoupons":(0,O.handleGetMerchantOfferMatchingUrlWithConditionsAndCouponsMessage)(e,n);break;case"getMerchantOfferWithConditionsAndCouponsFromS3":(0,O.handleGetMerchantOfferWithConditionsAndCouponsFromS3Message)(e,n);break;case"getEnrichedMerchantOfferFromAppSync":(0,C.handleGetEnrichedMerchantOfferFromAppSyncMessage)(e,n);break;case"getMerchantOfferLastUsedAtAutoCouponsFromAppSync":(0,P.handleGetMerchantOfferLastUsedAtAutoCouponsFromAppSync)(e,n);break;case"updateMerchantOfferLastUsedAtAutoCoupons":(0,P.handleUpdateMerchantOfferLastUsedAtAutoCoupons)(e);break;case"handleUserInterfaceComponentInteractionInBackground":(0,o.handleHandleUserInterfaceComponentInteractionInBackgroundMessage)(e,null===(Q=null==t?void 0:t.tab)||void 0===Q?void 0:Q.id);break;case"requestCardLinkedOfferNonAffiliateTrackingLinkLoading":(0,s.handleRequestCardLinkedOfferNonAffiliateTrackingLinkLoading)(e,null===(H=null==t?void 0:t.tab)||void 0===H?void 0:H.id);break;case"openUniversalOnlineOfferActivationInterstitial":(0,o.handleOpenUniversalOnlineOfferActivationInterstitialMessage)(e,null===(z=null==t?void 0:t.tab)||void 0===z?void 0:z.url);break;case"triggerPostAffiliateLinkLoadingActions":(0,o.handleTriggerPostAffiliateLinkLoadingActionsMessage)(e);break;case"activateOnetimeOffer":(0,U.handleActivateOnetimeOfferMessage)(e);break;case"getUserOfferActivationInfo":(0,U.handleGetUserOfferActivationInfoMessage)(e,n);break;case"openUrlInCurrentTab":(0,w.handleOpenUrlInCurrentTabMessage)(e,n);break;case"openTab":(0,w.handleOpenTabMessage)(e,n);break;case"closeTab":(0,w.handleCloseTabMessage)(e);break;case"getTabId":(0,w.handleGetTabIdMessage)(t,n);break;case"logAmplitudeEvent":(0,M.handleLogAmplitudeEventMessage)(e);break;case"logUserEvent":(0,T.handleLogUserEventMessage)(e);break;case"logAnonymousEvent":(0,L.handleLogAnonymousEventMessage)(e);break;case"sendForgottenPasswordEmail":(0,c.handleSendForgottenPasswordEmailMessage)(e,n);break;case"submitForgottenPasswordCode":(0,c.handleSubmitForgottenPasswordCodeMessage)(e,n);break;case"updateLocalStorageUserState":(0,A.handleUpdateLocalStorageUserStateMessage)(e);break;case"popupOpened":(0,d.handlePopupOpenedMessage)();break;case"webAppLoginInfoSent":(0,d.handleWebAppLoginInfoSentMessage)(e);break;case"getUser":(0,S.handleGetUserMessage)(e,n);break;case"getUserFeaturesMap":(0,v.handleGetUserFeaturesMap)(n);break;case"updateUser":(0,S.handleUpdateUserMessage)(e,n);break;case"checkIsTemporaryUser":(0,c.handleCheckIsTemporaryUserMessage)(n);break;case"getUserPendingPoints":(0,I.handleGetUserPendingPointsMessage)(n);break;case"getUserBnplTransaction":(0,h.handleGetUserBnplTransactionMessage)(e,n);break;case"getUserBnplTransactions":(0,h.handleGetUserBnplTransactionsMessage)(n);break;case"createUserBnplTransaction":(0,h.handleCreateUserBnplTransactionMessage)(e);break;case"displayBnplSubscriptionWidget":(0,p.handleDisplayBnplSubscriptionWidgetMessage)(e,null===(V=null==t?void 0:t.tab)||void 0===V?void 0:V.id,null===(J=null==t?void 0:t.tab)||void 0===J?void 0:J.url);break;case"displayBnplCardReadyWidget":(0,f.handleDisplayBnplCardReadyWidgetMessage)(e,null===(Z=null==t?void 0:t.tab)||void 0===Z?void 0:Z.id);break;case"updateCognitoPhoneNumber":(0,c.handleUpdateCognitoPhoneNumberMessage)(e,n);break;case"checkIsPhoneNumberDuplicate":(0,S.handleCheckIsPhoneNumberDuplicateMessage)(e,n);break;case"getSetting":(0,N.handleGetSettingMessage)(e,n);break;case"checkCanDisplayCardReadyWidget":(0,f.handleCheckCanDisplayCardReadyWidgetMessage)(n,null===(X=null==t?void 0:t.tab)||void 0===X?void 0:X.url);break;case"checkWasBnplCardCreatedRecently":(0,f.handleCheckWasBnplCardCreatedRecently)(n,null===(Y=null==t?void 0:t.tab)||void 0===Y?void 0:Y.url);break;case"focusCurrentContentScriptTab":(null===($=null==t?void 0:t.tab)||void 0===$?void 0:$.id)&&chrome.tabs.update(t.tab.id,{active:!0});break;case"createProductWebpage":(0,W.handleCreateProductWebpageMessage)(e);break;case"getUserSavedWebpages":(0,W.handleGetUserSavedWebpagesMessage)(n);break;case"getUserBrowsedProductWebpages":(0,W.handleGetUserBrowsedProductWebpagesMessage)(n);break;case"deleteUserBrowsedProductWebpages":(0,W.handleDeleteUserBrowsedProductWebpagesMessage)(e);break;case"updateQueryCacheForDetectedProductWebpage":(0,W.handleUpdateQueryCacheForDetectedProductWebpageMessage)(e);break;case"getWebpageUrlIfSaved":(0,W.handleGetWebpageUrlIfSavedMessage)(e,n);break;case"saveWebpage":(0,W.handleSaveWebpageMessage)(e);break;case"unsaveWebpage":(0,W.handleUnsaveWebpageMessage)(e);break;case"getWebpagePriceHistory":(0,W.handleGetWebpagePriceHistoryMessage)(e,n);break;case"getProductWebpage":(0,W.handleGetProductWebpageMessage)(e,n);break;case"getMerchantProductOfferAlternatives":(0,F.handleGetMerchantProductOfferAlternativesMessage)(e,n);break;case"getProductImageEmbedding":(0,W.handleGetProductImageEmbeddingMessage)(e,n);break;case"createProductImageEmbedding":(0,W.handleCreateProductImageEmbeddingMessage)(e);break;case"getImagePixelsAndShape":(0,W.handleGetImagePixelsAndShapeMessage)(e,n);break;case"termsOfServiceAndPrivacyPolicyConsentDetected":(0,c.handleTermsOfServiceAndPrivacyPolicyConsentDetectedMessage)(e);break;case"saveOfferActivatedInitialUrlPayload":(0,i.handleSaveOfferActivatedInitialUrlPayload)(e,null===(ee=null==t?void 0:t.tab)||void 0===ee?void 0:ee.id);break;case"compareOfferActivatedUrlChangePayload":(0,i.handleCompareOfferActivatedUrlChangePayload)(e,null===(te=null==t?void 0:t.tab)||void 0===te?void 0:te.id);break;case"getSharedBalanceStatus":(0,E.handleGetSharedBalanceStatusMessage)(n);break;case"getPostAffiliateLinkLoadingJokoFingerprint":(0,a.handleGetPostAffiliateLinkLoadingJokoFingerprintMessage)(e,n);break;case"getExtensionType":(0,y.handleGetExtensionTypeMessage)(n);break;case"checkIsSignedIn":(0,c.handleCheckIsSignedInMessage)(n);break;case"loadImage":(0,m.handleLoadImageMessage)(e,n);break;case"searchMerchantProductOffers":(0,B.handleSearchMerchantProductOffers)(e,n);break;case"checkHasDisconnectedBank":(0,g.handleCheckHasDisconnectedBank)(n);break;case"createProductDiscoveryConversationId":(0,B.handleCreateProductDiscoveryConversationId)(n);break;case"updateProductDiscoveryConversation":(0,B.handleUpdateProductDiscoveryConversation)(e,n)}return(0,k.handleCouponAutomationMessages)(e,t,n),!0}t.setMessageListener=function(){var e=(0,G.withSentry)(K);chrome.runtime.onMessage.removeListener(e),chrome.runtime.onMessage.addListener(e)},t.handleBackgroundMessage=K},83920:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.setContentScriptPortListener=void 0;var r=n(78707);function o(e){var t=function(t){(0,r.handleBackgroundMessage)(t.message,e.sender,(function(n){return e.postMessage({messageId:t.messageId,response:n})}))};e.onMessage.removeListener(t),e.onMessage.addListener(t)}t.setContentScriptPortListener=function(){chrome.runtime.onConnect.removeListener(o),chrome.runtime.onConnect.addListener(o)}},86459:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},i=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};Object.defineProperty(t,"__esModule",{value:!0}),t.setRedirectionToFeedbackFormOnUninstall=void 0;var a=n(55015),s=n(89614),c=n(96613),u=n(45133),l=n(42792),d=n(24785),f=n(52151),p=n(32495),h=n(57419),v=n(22641),g=n(87626);t.setRedirectionToFeedbackFormOnUninstall=function(){return r(this,void 0,void 0,(function(){var e,t,n,r,b,y,m,w,S;return o(this,(function(o){switch(o.label){case 0:return[4,(0,p.getLocalStorageItem)(p.LocalStorageKey.userRegion)];case 1:return e=o.sent(),t=new URL(e===s.Region.FR?"https://www.joko.com/fr/browser-extension/uninstallation-form":"https://www.joko.com/en/browser-extension/uninstallation-form"),[4,(0,l.checkIsSignedIn)()];case 2:return o.sent()?[4,Promise.all([(0,p.getLocalStorageItem)(p.LocalStorageKey.userId),(0,u.getDevStackMode)(),(0,d.getDeviceId)(),(0,d.getOperatingSystemInfo)()])]:[3,4];case 3:n=i.apply(void 0,[o.sent(),4]),r=n[0],b=n[1],y=n[2],m=n[3],w=m.os,S=m.osVersion,r&&(t.searchParams.set("userId",r),t.searchParams.set("isDev",b.toString()),t.searchParams.set("userRegion",e),t.searchParams.set("os",w),S&&t.searchParams.set("osVersion",S),t.searchParams.set("userEventPlatform",(0,v.getUserEventPlatform)()),t.searchParams.set("amplitudePlatform",(0,h.getAmplitudePlatform)(w)),t.searchParams.set("deviceId",y),t.searchParams.set("versionNumberKeyName",(0,c.getVersionNumberKeyName)(f.isMobileSafariExtension)),a.versionNumber&&t.searchParams.set("versionNumber",a.versionNumber)),o.label=4;case 4:try{chrome.runtime.setUninstallURL(t.toString())}catch(e){(0,g.captureSentryException)(e),console.log("Error setting uninstall URL",e)}return[2]}}))}))}},51635:function(e,t,n){var r,o=this&&this.__extends||(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},a=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.detectRegion=t.getThrottledUserRegion=void 0;var s=n(89614),c=n(47248),u=n(45133),l=n(37052),d=n(32495),f=n(22641),p=n(69479),h=n(87626),v={FR:s.Region.FR,GB:s.Region.GB,US:s.Region.US};function g(){return i(this,void 0,void 0,(function(){var e;return a(this,(function(t){switch(t.label){case 0:return[4,function(){return i(this,void 0,void 0,(function(){var e;return a(this,(function(t){switch(t.label){case 0:return[4,(0,p.getMobileSafariSharedRegion)()];case 1:return b((e=t.sent()).region)?[2,e]:[4,y()];case 2:return b((e=t.sent()).region)?[2,e]:[4,w()];case 3:return b((e=t.sent()).region)?[2,e]:[2,{region:(0,s.getRegionFromBrowserLanguage)(),detectionMethod:c.RegionDetectionMethod.BrowserLanguage}]}}))}))}()];case 1:if(!(e=t.sent()).region)throw new Error("Region could not be detected");return[4,(0,f.logUserEventUtil)({type:"regionDetected",active:!1,payload:e})];case 2:return t.sent(),[2,v[e.region]]}}))}))}function b(e){return!(!e||!s.AUTHORIZED_REGIONS.includes(e))}function y(){return i(this,void 0,void 0,(function(){var e;return a(this,(function(t){switch(t.label){case 0:return e={},[4,(0,d.getLocalStorageItem)(d.LocalStorageKey.userRegion)];case 1:return[2,(e.region=t.sent(),e.detectionMethod=c.RegionDetectionMethod.LocalStorage,e)]}}))}))}t.getThrottledUserRegion=function(){return i(this,void 0,void 0,(function(){var e;return a(this,(function(t){switch(t.label){case 0:return[4,(0,d.getLocalStorageItem)(d.LocalStorageKey.userRegion)];case 1:return(e=t.sent())?[2,e]:[2,(0,l.runThrottledQuery)({queryType:l.ThrottledQueryType.regionQuery,runQuery:g})]}}))}))},t.detectRegion=g;var m=function(e){function t(){var n=e.call(this,"")||this;return n.__proto__=t.prototype,n}return o(t,e),t}(Error);function w(){return i(this,void 0,void 0,(function(){var e,t,n,r;return a(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,4]),[4,new Promise((function(e,t){var n=function(){return i(this,void 0,void 0,(function(){var e,t,n;return a(this,(function(r){switch(r.label){case 0:return console.log("API call: getting region from IP..."),(e=new Headers).append("Accept","application/json"),e.append("Content-Type","application/json"),n="".concat,[4,(0,u.getRestApiUrl)()];case 1:return t=n.apply("",[r.sent(),"/region"]),[2,fetch(t,{method:"GET",headers:e}).then((function(e){if(console.log("Response ".concat(e.status," for API call 'get region from IP'")),200===e.status)return e.json();throw new Error("".concat(e.status))}))]}}))}))}(),r=setTimeout((function(){return t(new m)}),S);n.then((function(t){clearTimeout(r),e(t)})).catch((function(e){clearTimeout(r),t(e)}))}))];case 1:return e=o.sent(),t=e.countryCode,n=e.city,[2,{region:t,city:n,detectionMethod:c.RegionDetectionMethod.IpAddress}];case 2:return r=o.sent(),(0,h.captureSentryException)(r),[4,(0,f.logUserEventUtil)({type:"regionDetectionFromIpFailed",active:!1,payload:{reason:r instanceof m?"timeout":"unknown"}})];case 3:return o.sent(),[3,4];case 4:return[2,{region:void 0,detectionMethod:c.RegionDetectionMethod.IpAddress}]}}))}))}var S=1500},81866:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.updateLastEventTimestampMs=t.getSessionId=void 0;var i=n(22641),a=n(32495),s=3e5,c=void 0;function u(e){return r(this,void 0,void 0,(function(){var t,n,r;return o(this,(function(o){switch(o.label){case 0:return[4,(0,a.getLocalStorageItem)(a.LocalStorageKey.lastEventTimestampMs)];case 1:return t=o.sent(),n=Date.now()-e>s,r=!t||Date.now()-t>s,[2,n&&r]}}))}))}function l(){return r(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return c=Date.now(),console.log("Starting a new session... (Session ID: ".concat(c,")")),[4,(0,a.setLocalStorageItem)(a.LocalStorageKey.sessionId,c)];case 1:return e.sent(),[4,(0,i.logUserEventUtil)({type:"sessionStarted",payload:{sessionId:c.toString()}})];case 2:return e.sent(),[2,c]}}))}))}t.getSessionId=function(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,(0,a.getLocalStorageItem)(a.LocalStorageKey.sessionId)];case 1:return c=t.sent()||c,(e=!c)?[3,3]:[4,u(c)];case 2:e=t.sent(),t.label=3;case 3:return e?[4,l()]:[3,5];case 4:c=t.sent(),t.label=5;case 5:return[2,c]}}))}))},t.updateLastEventTimestampMs=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return[4,(0,a.getLocalStorageItem)(a.LocalStorageKey.sessionId)];case 1:return t=r.sent()||c,(n=!t)?[3,3]:[4,u(t)];case 2:n=r.sent(),r.label=3;case 3:return n?[4,l()]:[3,5];case 4:c=r.sent(),r.label=5;case 5:return[4,(0,a.setLocalStorageItem)(a.LocalStorageKey.lastEventTimestampMs,e)];case 6:return r.sent(),[2]}}))}))}},20332:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},i=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},a=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.getStandDownComplianceWebRedirectionListener=t.getStandDownComplianceCookieListener=void 0;var s=n(55015),c=n(93795),u=n(52151),l=n(76038),d=n(16206);function f(e){return function(t){var n,r=t.cookie,o=t.cause,i=t.removed;if("explicit"===o&&!i){var c=function(e,t){var n,r;if(!e.name||!e.domain)return{isTargetMatch:!1};if(!t[e.domain])return{isTargetMatch:!1};var o=t[e.domain];try{for(var i=a(o),s=i.next();!s.done;s=i.next()){var c=s.value;if(p(e.name,c.nameRegex))return{isTargetMatch:!0,affiliatePlatformId:c.affiliatePlatformId}}}catch(e){n={error:e}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return{isTargetMatch:!1}}(r,e),u=c.isTargetMatch,l=c.affiliatePlatformId;u&&l&&(0,s.updateLocalStorageItem)(s.LocalStorageKey.standDownEventDetectionByAffiliatePlatformIdMap,((n={})[l]={timestampInMs:Date.now()},n))}}}function p(e,t){try{return new RegExp(t).test(e)}catch(e){return console.error(e),!1}}function h(e){var t=this;return function(n){return r(t,void 0,void 0,(function(){var t,r,i,a,c,u,d,f,p;return o(this,(function(o){switch(o.label){case 0:return t=n.type,r=n.tabId,i=n.url,a=n.redirectUrl,"main_frame"!==t||r<0||!i||!a?[2]:(c=function(e){try{return new URL(e).hostname}catch(t){return e}}(i),e[c]?(u=e[c],[4,(0,l.getMerchantOfferMatchingUrlWithConditionsAndCoupons)(a)]):[2]);case 1:return(d=null===(p=o.sent())||void 0===p?void 0:p.offerId)?((0,s.updateLocalStorageItem)(s.LocalStorageKey.standDownEventDetectionByAffiliatePlatformIdMap,((f={})[u]={timestampInMs:Date.now(),offerId:d},f)),[2]):[2]}}))}))}}function v(e){return Object.keys(e).map((function(e){return"*://".concat(e,"/*")}))}t.getStandDownComplianceCookieListener=function(){return r(this,void 0,void 0,(function(){var e,t,n,r,l;return o(this,(function(o){switch(o.label){case 0:return[4,Promise.all([(0,c.checkHasFeature)(s.Feature.enableStandDownComplianceInMobileBrowserExtension),(0,c.checkHasFeature)(s.Feature.enableStandDownComplianceInDesktopBrowserExtension),(0,d.getSetting)(s.SettingKey.standDownComplianceSettings).then(d.parseSetting)])];case 1:return e=i.apply(void 0,[o.sent(),3]),t=e[0],n=e[1],r=e[2],(u.isMobileExtension?t:n)?(l=function(e){var t,n,r,o;if(!(null==e?void 0:e.settingsByAffiliatePlatformId)||"object"!=typeof(null==e?void 0:e.settingsByAffiliatePlatformId))return;var s={};try{for(var c=a(Object.entries(e.settingsByAffiliatePlatformId)),u=c.next();!u.done;u=c.next()){var l=i(u.value,2),d=l[0],f=l[1].activationCookies;if(f&&Array.isArray(f))try{for(var p=(r=void 0,a(f)),h=p.next();!h.done;h=p.next()){var v=h.value,g=v.domain,b=v.nameRegex;g&&b&&(s[g]?s[g].push({nameRegex:b,affiliatePlatformId:d}):s[g]=[{nameRegex:b,affiliatePlatformId:d}])}}catch(e){r={error:e}}finally{try{h&&!h.done&&(o=p.return)&&o.call(p)}finally{if(r)throw r.error}}}}catch(e){t={error:e}}finally{try{u&&!u.done&&(n=c.return)&&n.call(c)}finally{if(t)throw t.error}}return 0===Object.keys(s).length?void 0:s}(r),l?[2,f(l)]:[2,void 0]):[2,void 0]}}))}))},t.getStandDownComplianceWebRedirectionListener=function(){return r(this,void 0,void 0,(function(){var e,t,n,r,l;return o(this,(function(o){switch(o.label){case 0:return[4,Promise.all([(0,c.checkHasFeature)(s.Feature.enableStandDownComplianceInMobileBrowserExtension),(0,c.checkHasFeature)(s.Feature.enableStandDownComplianceInDesktopBrowserExtension),(0,d.getSetting)(s.SettingKey.standDownComplianceSettings).then(d.parseSetting)])];case 1:return e=i.apply(void 0,[o.sent(),3]),t=e[0],n=e[1],r=e[2],(u.isMobileExtension?t:n)?(l=function(e){var t,n,r,o;if(!(null==e?void 0:e.settingsByAffiliatePlatformId)||"object"!=typeof e.settingsByAffiliatePlatformId)return;var s={};try{for(var c=a(Object.entries(e.settingsByAffiliatePlatformId)),u=c.next();!u.done;u=c.next()){var l=i(u.value,2),d=l[0],f=l[1].redirectionDomains;if(f&&Array.isArray(f))try{for(var p=(r=void 0,a(f)),h=p.next();!h.done;h=p.next()){s[h.value]=d}}catch(e){r={error:e}}finally{try{h&&!h.done&&(o=p.return)&&o.call(p)}finally{if(r)throw r.error}}}}catch(e){t={error:e}}finally{try{u&&!u.done&&(n=c.return)&&n.call(c)}finally{if(t)throw t.error}}return 0===Object.keys(s).length?void 0:s}(r),l?[2,{listener:h(l),targetUrls:v(l)}]:[2,{}]):[2,{}]}}))}))}},60179:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.handleGetTabIdMessage=t.handleCloseTabMessage=t.handleOpenTabMessage=t.handleOpenUrlInCurrentTabMessage=void 0,t.handleOpenUrlInCurrentTabMessage=function(e,t){var n;if(null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.url){var r=e.data.url;chrome.tabs.update({url:r,active:!0},t)}},t.handleOpenTabMessage=function(e,t){var n;if(null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.url){var r=e.data.url;chrome.tabs.create({url:r,active:!0},t)}},t.handleCloseTabMessage=function(e){var t;if(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.tabId){var n=e.data.tabId;chrome.tabs.remove(n)}},t.handleGetTabIdMessage=function(e,t){var n;t({tabId:null===(n=null==e?void 0:e.tab)||void 0===n?void 0:n.id})}},7080:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.refreshLocalStorageUserDataFromQueryResponse=t.handleCheckIsPhoneNumberDuplicateMessage=t.handleUpdateUserMessage=t.runThrottledUserQuery=t.handleGetUserMessage=void 0;var i=n(58029),a=n(89614),s=n(45133),c=n(95329),u=n(4120),l=n(37052),d=n(32495),f=n(67290),p=n(87626);function h(e){return(0,l.runThrottledQuery)({queryType:l.ThrottledQueryType.userQuery,runQuery:v,throttlingDelayInMs:e})}function v(){return(0,s.getClient)().then((function(e){return e.query({query:u.userQuery,fetchPolicy:"no-cache"})})).catch((function(e){console.error("GraphQL: error while fetching user",e),(0,p.captureSentryException)(e)})).then((function(e){var t;return null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.user}))}t.handleGetUserMessage=function(e,t){var n;return r(this,void 0,void 0,(function(){var r;return o(this,(function(o){switch(o.label){case 0:return[4,h(null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.throttlingInMs)];case 1:return r=o.sent(),t({user:r}),[2]}}))}))},t.runThrottledUserQuery=h,t.handleUpdateUserMessage=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,(o=e.data,(0,s.getClient)().then((function(e){return e.mutate({mutation:c.updateUserMutation,variables:{input:o},fetchPolicy:"no-cache"})})))];case 1:return r.sent(),t({success:!0}),[3,3];case 2:return n=r.sent(),console.error("GraphQL: error updating user:",n),(0,p.captureSentryException)(n),t({success:!1}),[3,3];case 3:return[2]}var o}))}))},t.handleCheckIsPhoneNumberDuplicateMessage=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,(o=e.data.formattedPhoneNumber,(0,s.getClient)().then((function(e){return e.query({query:u.checkDuplicatePhoneNumberQuery,variables:{phoneNumber:o},fetchPolicy:"no-cache"})})).catch((function(e){console.error("GraphQL: error checking for duplicate phone number:",e),(0,p.captureSentryException)(e)})))];case 1:return(null==(n=r.sent())?void 0:n.data.checkDuplicatePhoneNumber)?t({isDuplicate:!n.data.checkDuplicatePhoneNumber}):t({isDuplicate:void 0}),[2]}var o}))}))},t.refreshLocalStorageUserDataFromQueryResponse=function(e){var t,n=e.points.balance,r=null===(t=e.userInfo)||void 0===t?void 0:t.firstName,o=e.states,s=e.featuresMap,c=e.region,u=[(0,d.setLocalStorageItem)(d.LocalStorageKey.userPoints,n),(0,d.setLocalStorageItem)(d.LocalStorageKey.userStatesMap,(0,f.buildUserStatesMap)(o)),(0,d.setLocalStorageItem)(d.LocalStorageKey.userFeaturesMap,(0,i.parseUserFeaturesMap)(s)),(0,d.setLocalStorageItem)(d.LocalStorageKey.userFeaturesMapLastFetchedTimestampMs,Date.now()),(0,d.setLocalStorageItem)(d.LocalStorageKey.userDataLastFetchedTimestampMs,Date.now()),(0,d.setLocalStorageItem)(d.LocalStorageKey.userRegion,c||a.Region.FR)];return r&&u.push((0,d.setLocalStorageItem)(d.LocalStorageKey.userFirstName,r)),Promise.all(u)}},70986:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleGetUserPendingPointsMessage=void 0;var i=n(93489),a=n(45133),s=n(11823),c=n(87626);function u(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,d()];case 1:return n.sent()?[2]:[4,f(e)];case 2:return t=n.sent(),[4,(0,i.setLocalStorageItem)(i.LocalStorageKey.lastFetchedUserHistoryTimestampMs,Date.now())];case 3:return n.sent(),void 0===t?[2]:[4,(0,i.setLocalStorageItem)(i.LocalStorageKey.userPendingPoints,t)];case 4:return n.sent(),[2]}}))}))}t.handleGetUserPendingPointsMessage=function(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,(0,a.getClient)()];case 1:return[4,u(n.sent())];case 2:return n.sent(),[4,(0,i.getLocalStorageItem)(i.LocalStorageKey.userPendingPoints)];case 3:return t=n.sent(),e({userPendingPoints:t}),[2]}}))}))};var l=6;function d(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,(0,i.getLocalStorageItem)(i.LocalStorageKey.lastFetchedUserHistoryTimestampMs)];case 1:return e=t.sent()||0,[2,Date.now()-e<1e3*l*3600]}}))}))}function f(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return[4,p(e,{showUncollected:!1,showReferralPoints:!0})];case 1:return(t=r.sent())?(n=t.filter((function(e){return e.pending})),[2,n.reduce((function(e,t){return e+t.points}),0)]):[2,void 0]}}))}))}function p(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,e.query({query:s.userHistoryQuery,fetchPolicy:"no-cache",variables:t}).catch((function(e){console.error("GraphQL: error while fetching user history",e),(0,c.captureSentryException)(e)}))];case 1:return[2,null==(n=r.sent())?void 0:n.data.user.history]}}))}))}},67290:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},i=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.handleUpdateLocalStorageUserStateMessage=t.buildUserStatesMap=t.getLocalStorageUserState=t.UserStateKey=void 0;var a,s=n(32495);!function(e){e.abTestGroup="abTestGroup",e.hasAcknowledgedWarningForCookieTracking="hasAcknowledgedWarningForCookieTracking",e.lastOsUsed="lastOsUsed",e.lastOsVersionUsed="lastOsVersionUsed"}(a=t.UserStateKey||(t.UserStateKey={})),t.getLocalStorageUserState=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,(0,s.getLocalStorageItem)(s.LocalStorageKey.userStatesMap)];case 1:return n=r.sent(),t=n[e],[3,3];case 2:return r.sent(),[3,3];case 3:return[2,t]}}))}))};var c=Object.keys(a).map((function(e){return a[e]}));t.buildUserStatesMap=function(e){var t,n,r=e.filter((function(e){return c.includes(e.stateKey)})).map((function(e){return{stateKey:e.stateKey,value:e.value?JSON.parse(e.value):void 0}})),o={};try{for(var a=i(r),s=a.next();!s.done;s=a.next()){var u=s.value;o[u.stateKey]=u.value}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}return o},t.handleUpdateLocalStorageUserStateMessage=function(e){var t;if(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.state){var n=e.data.state;!function(e,t){r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:n={},r.label=1;case 1:return r.trys.push([1,3,,4]),[4,(0,s.getLocalStorageItem)(s.LocalStorageKey.userStatesMap)];case 2:return n=r.sent()||{},[3,4];case 3:return r.sent(),[3,4];case 4:return n[e]=t,[2,(0,s.setLocalStorageItem)(s.LocalStorageKey.userStatesMap,n)]}}))}))}(n.stateKey,n.value)}}},1031:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.addWebRequestListenerForAdBlockerDetection=t.addWebRequestListenerForAffiliateActivationTracking=void 0;var i=n(55015),a=n(47869),s=n(42792),c=n(20332),u=n(87626),l=n(16206),d=["responseHeaders"];t.addWebRequestListenerForAffiliateActivationTracking=function(){return r(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return i.browserKind!==i.Browser.chrome&&i.browserKind!==i.Browser.firefox?[2]:[4,(0,s.checkIsSignedIn)()];case 1:return e.sent()?(function(){r(this,void 0,void 0,(function(){var e,t,n,r;return o(this,(function(o){switch(o.label){case 0:return[4,(0,c.getStandDownComplianceWebRedirectionListener)()];case 1:return e=o.sent(),t=e.listener,n=e.targetUrls,t&&n?(r=(0,u.withSentry)(t),chrome.webRequest.onBeforeRedirect.removeListener(r),chrome.webRequest.onBeforeRedirect.addListener(r,{urls:n},d),[2]):[2]}}))}))}(),function(){r(this,void 0,void 0,(function(){var e,t;return o(this,(function(n){switch(n.label){case 0:return[4,(0,a.getThirdPartyAffiliateLinkLoadingListener)()];case 1:return(e=n.sent())?(t=(0,u.withSentry)(e),chrome.webRequest.onBeforeRedirect.removeListener(t),chrome.webRequest.onBeforeRedirect.addListener(t,{urls:["<all_urls>"]}),[2]):[2]}}))}))}(),[2]):[2]}}))}))};t.addWebRequestListenerForAdBlockerDetection=function(){var e;return r(this,void 0,void 0,(function(){var t,n,r,a,s;return o(this,(function(o){switch(o.label){case 0:return i.browserKind!==i.Browser.chrome&&i.browserKind!==i.Browser.firefox?[2]:(t=i.browserKind===i.Browser.chrome?"net::ERR_BLOCKED_BY_CLIENT":"NS_ERROR_ABORT",r=l.parseSetting,[4,(0,l.getSetting)(i.SettingKey.adBlockerDetectionAssetUrl)]);case 1:return n=null!==(e=r.apply(void 0,[o.sent()]))&&void 0!==e?e:i.DEFAULT_AD_BLOCKER_DETECTION_ASSET_URL,a=function(e){var n=e.error,r=e.tabId;n===t&&-1!==r&&chrome.tabs.sendMessage(r,{message:"adBlockerDetected"})},s=(0,u.withSentry)(a),chrome.webRequest.onErrorOccurred.removeListener(s),chrome.webRequest.onErrorOccurred.addListener(s,{urls:[n,i.DEFAULT_AD_BLOCKER_DETECTION_ASSET_URL]}),[2]}}))}))}},4436:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},c=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},u=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},l=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))},d=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.getNumberOfUnsuccessfulCouponsToSelectForReevaluation=t.checkShouldSkipUnsuccessfulCouponsForOffer=t.getMaximumNumberOfCouponsDisplayedBrowserExtensionSetting=t.getCouponsPriorityManagementSettings=t.handleCouponAutomationMessages=void 0;var f=a(n(2543)),p=n(22831),h=a(n(35759)),v=n(58029),g=n(13476),b=n(93489),y=n(47248),m=n(93795),w=n(52151),S=n(32495),I=n(76038),A=n(87626),k=n(16206);t.handleCouponAutomationMessages=function(e,t,n){var r,o,i;switch(e.message){case"getCouponAutomationState":(null===(r=e.data)||void 0===r?void 0:r.url)?function(e,t){s(this,void 0,void 0,(function(){var n,r,o,i,a,s,l,d;return c(this,(function(c){switch(c.label){case 0:return[4,(0,I.getMerchantOfferMatchingUrlWithConditionsAndCoupons)(e)];case 1:return(null==(n=c.sent())?void 0:n.browserExtension)?(r=w.isMobileExtension&&n.mobileApp?n.mobileApp.coupons:n.browserExtension.coupons,n.browserExtension.coupons&&(o=n.browserExtension.coupons.itemList),o&&r&&!1!==r.automationActive&&0!==o.length?[4,Promise.all([(0,S.getLocalStorageCouponAutomationState)(M(e)),(0,b.getLocalStorageItem)(b.LocalStorageKey.lastContentScriptExecutionTimestampMs)])]:[2,t(void 0)]):[2,t(void 0)];case 2:return i=u.apply(void 0,[c.sent(),2]),a=i[0],s=i[1],void 0!==a&&(function(e,t){return!!(e.state.passive&&t&&e.timestampInMs>t)}(a,s)||function(e){return!!(Date.now()-e.timestampInMs<1e3*L&&e.state.active)}(a)||function(e,t){var n=!!e.state.done||!e.state.active&&!e.state.passive&&!e.state.done;return!!(n&&t&&e.timestampInMs>t-1e3*L)}(a,s))?[2,t(a.state)]:[4,T(o,n)];case 3:return l=c.sent(),d=t,[4,q(n,r,l)];case 4:return[2,d.apply(void 0,[c.sent()])]}}))}))}(e.data.url,n):console.log("Missing attribute `url` in `getCouponAutomationState` message.");break;case"saveCouponAutomationState":(null===(o=e.data)||void 0===o?void 0:o.state)&&e.data.url?(0,S.setLocalStorageCouponAutomationState)(M(e.data.url),e.data.state):console.log("Missing attribute `state` and/or `url` in `saveCouponAutomationState` message.");break;case"getEnrichedMerchantCoupons":(null===(i=e.data)||void 0===i?void 0:i.offer)&&function(e,t){var n;s(this,void 0,void 0,(function(){var r,o;return c(this,(function(i){switch(i.label){case 0:return(null===(n=e.browserExtension)||void 0===n?void 0:n.coupons)&&(r=e.browserExtension.coupons.itemList),(null==r?void 0:r.length)?(o=t,[4,T(r,e,!0)]):[2,t(void 0)];case 1:return[2,o.apply(void 0,[i.sent()])]}}))}))}(e.data.offer,n)}};var M=function(e){return new URL(e).hostname};var L=30;function T(e,t,n){return void 0===n&&(n=!1),s(this,void 0,void 0,(function(){var o,i,a,s,d,p,h,v,g,b,y,m;return c(this,(function(c){switch(c.label){case 0:return[4,O()];case 1:return o=c.sent(),i=o.minNumberOfSuccessiveUnsuccessfulApplicationsForSkipping,a=o.minNumberOfActiveCouponsForSkipping,[4,_()];case 2:return s=c.sent(),[4,W(e,a)];case 3:return d=c.sent(),p=u(d?f.partition(e,(function(e){return e.shouldSkip})):[[],l([],u(e),!1)],2),h=p[0],v=p[1],[4,N({offerId:t.offerId,skippedCoupons:h,nonSkippedCoupons:v,minNumberOfActiveCouponsForSkipping:a,minNumberOfSuccessiveUnsuccessfulApplicationsForSkipping:i})];case 4:return g=c.sent(),b=new Set(g.map((function(e){return e.merchantCouponId}))),y=h.filter((function(e){var t=e.merchantCouponId;return!b.has(t)})).map((function(e){return r(r({},e),{isSelectedForReevaluation:!1})})),m=l(l([],u((w=function(e,t){return l(l([],u(e.map((function(e){return r(r({},e),{isSelectedForReevaluation:!1})}))),!1),u(t.map((function(e){return r(r({},e),{isSelectedForReevaluation:!0})}))),!1)}(v,g),w.sort((function(e,t){if(B(t)&&!B(e))return-1;if(B(e)&&!B(t))return 1;if(D(e)&&!D(t))return-1;if(!D(e)&&D(t))return 1;if(R(e)&&!R(t))return-1;if(!R(e)&&R(t))return 1;if(F(e)&&!F(t))return-1;if(!F(e)&&F(t))return 1;var n=(e.numberOfSuccessiveUnsuccessfulApplications||0)-(t.numberOfSuccessiveUnsuccessfulApplications||0);return 0!==n?n:0})))),!1),u(n?y:[]),!1),[2,P(m,s,n)]}var w}))}))}function E(){return s(this,void 0,void 0,(function(){var e,t,n;return c(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,(0,k.getSetting)(y.SettingKey.couponsCheckoutWidgetHidingRules)];case 1:if(e=r.sent(),!(t=(0,k.parseSetting)(e))||!C.check(t))throw new Error("Invalid couponsCheckoutWidgetHidingRules settings");return[2,t];case 2:return n=r.sent(),console.error("Invalid couponsCheckoutWidgetHidingRules settings",n),(0,A.captureSentryException)(n),[2,x];case 3:return[2]}}))}))}var x={ignoreWidgetHidingRulesWhenBnplUnavailable:!0,hiddenWidgetFallbackDisplayProbabilityDistributionParameters:{maximumProbability:.05,minimumProbability:.01,rateParameter:.01},widgetSnoozingDurationsInSeconds:{afterClickedOnCross:300,afterCrashedCouponApplicationProcess:3600,afterCompletedCouponApplicationProcess:600}},C=h.object({ignoreWidgetHidingRulesWhenBnplUnavailable:h.boolean(),hiddenWidgetFallbackDisplayProbabilityDistributionParameters:h.object({maximumProbability:h.number(),minimumProbability:h.number(),rateParameter:h.number()}).nonstrict(),widgetSnoozingDurationsInSeconds:h.object({afterClickedOnCross:h.number(),afterCrashedCouponApplicationProcess:h.number(),afterCompletedCouponApplicationProcess:h.number()}).nonstrict()}).nonstrict();function O(){return s(this,void 0,void 0,(function(){var e,t;return c(this,(function(n){switch(n.label){case 0:return[4,(0,k.getSetting)(y.SettingKey.couponsPriorityManagementSettings)];case 1:return e=n.sent(),(t=(0,k.parseSetting)(e))?[2,t]:[2,{minNumberOfSuccessiveUnsuccessfulApplicationsForSkipping:1e3,minNumberOfActiveCouponsForSkipping:1e4}]}}))}))}function P(e,t,n){return n?l(l([],u(e.slice(0,t)),!1),u(e.slice(t).map((function(e){return r(r({},e),{isSelectedForReevaluation:!1,shouldSkip:!0})}))),!1):l([],u(e.slice(0,t)),!1)}t.getCouponsPriorityManagementSettings=O;var U=15;function _(){return s(this,void 0,void 0,(function(){var e,t;return c(this,(function(n){switch(n.label){case 0:return t=k.parseSetting,[4,(0,k.getSetting)(y.SettingKey.maximumNumberOfCouponsDisplayedBrowserExtension)];case 1:return(e=t.apply(void 0,[n.sent()]))?[2,e]:[2,U]}}))}))}function D(e){return e.merchantCouponId.startsWith("manual")}function R(e){return e.merchantCouponId.startsWith("strackr")}function F(e){return e.merchantCouponId.startsWith("third-party")}function B(e){return!e.displayedInformation||e.displayedInformation.title===e.code}function W(e,t){return s(this,void 0,void 0,(function(){return c(this,(function(n){switch(n.label){case 0:return void 0===t||e.length<t?[2,!1]:[4,(0,m.checkHasFeature)(w.isMobileExtension?v.Feature.skipUnsuccessfulCouponsMobileBrowserExtension:v.Feature.skipUnsuccessfulCouponsDesktopBrowserExtension)];case 1:return[2,n.sent()]}}))}))}t.getMaximumNumberOfCouponsDisplayedBrowserExtensionSetting=_,t.checkShouldSkipUnsuccessfulCouponsForOffer=W;var G=60;function N(e){var t=e.offerId,n=e.skippedCoupons,r=e.nonSkippedCoupons,o=e.minNumberOfActiveCouponsForSkipping,i=e.minNumberOfSuccessiveUnsuccessfulApplicationsForSkipping;return s(this,void 0,void 0,(function(){var e,a,s,u,l;return c(this,(function(c){switch(c.label){case 0:return n.length?[4,(0,b.getLocalStorageItem)(b.LocalStorageKey.unsuccessfulCouponsSelectedForReevaluationMap)]:[2,[]];case 1:return void 0===(e=c.sent())&&(e={}),e[t]&&Date.now()-(e[t].lastUpdatedAtTimestampMs||0)<60*G*1e3?(a=new Set(e[t].unsuccessfulMerchantCouponIdsSelectedForReevaluation),[2,n.filter((function(e){return a.has(e.merchantCouponId)}))]):(s=K(n,r,o),u=function(e,t,n){if(!n)return[];for(var r=t.map((function(e){return Math.exp(-((null==e?void 0:e.numberOfSuccessiveUnsuccessfulApplications)||0)/(n+1))})),o=r.reduce((function(e,t){return e+t}),0),i=j(r,o),a=[],s=0;s<e;s++){var c=f.sortedIndex(i,Math.random());a.push(t[c]),s!==e-1&&(o-=r[c],r[c]=0,i=j(r,o))}return a}(s,n,i),l=u.map((function(e){return e.merchantCouponId})),e[t]={lastUpdatedAtTimestampMs:Date.now(),unsuccessfulMerchantCouponIdsSelectedForReevaluation:l},[4,(0,b.setLocalStorageItem)(b.LocalStorageKey.unsuccessfulCouponsSelectedForReevaluationMap,e)]);case 2:return c.sent(),[2,u]}}))}))}function K(e,t,n){return n?Math.max(Math.min(Math.ceil(e.length/25),n),n-t.length):0}function j(e,t){var n,r,o=[];try{for(var i=d(e),a=i.next();!a.done;a=i.next()){var s=a.value,c=o[o.length-1]?o[o.length-1]:0;o.push(c+s/t)}}catch(e){n={error:e}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return o}function q(e,t,n){var o,i,a,l,d,f,h,b,y,S,I,A,k,M,L,T;return s(this,void 0,void 0,(function(){var s,x,C,P,U,_,D,R,F,B;return c(this,(function(c){switch(c.label){case 0:for(C in s=t.selectors,x={},s)s[C]&&"__typename"!==C&&(x[C]={selector:s[C],selectorType:g.CouponSelectorType.manual,detectionStatus:g.CouponSelectorElementDetectionStatus.notRun});return[4,(0,m.checkHasFeature)(w.isMobileExtension?v.Feature.useNetworkRequestCouponApplicationInMobileBrowserExtension:v.Feature.useNetworkRequestCouponApplicationInDesktopBrowserExtension)];case 1:return P=c.sent()&&!!t.networkRequestsParameters,[4,Promise.all([Q(),E(),O()])];case 2:return U=u.apply(void 0,[c.sent(),3]),_=U[0],D=U[1],R=U[2],F=function(e,t){var n,r;return e?!((null===(n=t.browserExtension)||void 0===n?void 0:n.mobileVersion)&&!1===t.browserExtension.mobileVersion.displayAutoCouponCheckoutWidget):!((null===(r=t.browserExtension)||void 0===r?void 0:r.desktopVersion)&&!1===t.browserExtension.desktopVersion.displayAutoCouponCheckoutWidget)}(w.isMobileExtension,e),[4,H(w.isMobileExtension,e,n,D,R)];case 3:return B=c.sent(),[2,{passive:{offerId:e.offerId,displayedAmountSavedByUsersUsingAutoCoupons:e.displayedAmountSavedByUsersUsingAutoCoupons,totalAmountSavedByUsersUsingAutoCoupons:e.totalAmountSavedByUsersUsingAutoCoupons,displayedSuccessRateAutoCoupons:e.displayedSuccessRateAutoCoupons,lastUsedAtAutoCoupons:e.lastUsedAtAutoCoupons,shouldLoadAffiliateLinkOnAutomation:!1!==(null===(i=null===(o=e.browserExtension)||void 0===o?void 0:o.coupons)||void 0===i?void 0:i.loadAffiliateLinkOnAutomation),isAutoCouponCheckoutWidgetDisplayEnabled:F,shouldHideAutoCouponCheckoutWidgetDueToLowSuccessRate:B,couponCheckoutWidgetSnoozingDurationsInSeconds:D.widgetSnoozingDurationsInSeconds,selectors:x,coupons:n,stateType:g.CouponAutomationPassiveStateType.inspect,couponApplicationProcessId:(0,p.v4)(),shouldUseNetworkRequestsApplication:P,networkRequestsParameters:null!==(L=r(r({},t.networkRequestsParameters),{merchantApiEndpointUrl:null===(a=t.networkRequestsParameters)||void 0===a?void 0:a.merchantApiEndpointUrl,requestContentType:null!==(d=null===(l=t.networkRequestsParameters)||void 0===l?void 0:l.requestContentType)&&void 0!==d?d:void 0,additionalHeaders:null!==(h=null===(f=t.networkRequestsParameters)||void 0===f?void 0:f.additionalHeaders)&&void 0!==h?h:void 0,requestBodyFormatter:null!==(y=null===(b=t.networkRequestsParameters)||void 0===b?void 0:b.requestBodyFormatter)&&void 0!==y?y:void 0,method:null===(S=t.networkRequestsParameters)||void 0===S?void 0:S.method,requestUrlParametersFormatter:null!==(A=null===(I=t.networkRequestsParameters)||void 0===I?void 0:I.requestUrlParametersFormatter)&&void 0!==A?A:void 0,responseParser:null!==(M=null===(k=t.networkRequestsParameters)||void 0===k?void 0:k.responseParser)&&void 0!==M?M:void 0}))&&void 0!==L?L:void 0,customDelayBetweenApplicationsInMs:null!==(T=t.customDelayBetweenApplicationsInMs)&&void 0!==T?T:void 0,couponsNetworkRequestsSettings:_}}]}}))}))}function Q(){return s(this,void 0,void 0,(function(){var e,t;return c(this,(function(n){switch(n.label){case 0:return[4,(0,k.getSetting)(y.SettingKey.couponsNetworkRequestsSettings)];case 1:return e=n.sent(),(t=(0,k.parseSetting)(e))?[2,t]:[2,void 0]}}))}))}function H(e,t,n,r,o){var i,a;return s(this,void 0,void 0,(function(){var s,u;return c(this,(function(c){switch(c.label){case 0:return n.some((function(e){return!e.shouldSkip}))?[2,!1]:[4,(0,m.checkHasFeature)(e?v.Feature.hideCouponsCheckoutWidgetOnLowSuccessRateMerchantsMobileBrowserExtension:v.Feature.hideCouponsCheckoutWidgetOnLowSuccessRateMerchantsDesktopBrowserExtension)];case 1:return c.sent()?(s=null===(a=null===(i=t.browserExtension)||void 0===i?void 0:i.bnpl)||void 0===a?void 0:a.active,u=function(e,t){var n,r,o,i;return e?!!(null===(r=null===(n=t.browserExtension)||void 0===n?void 0:n.mobileVersion)||void 0===r?void 0:r.shouldIgnoreAutoCouponCheckoutWidgetHidingRules):!!(null===(i=null===(o=t.browserExtension)||void 0===o?void 0:o.desktopVersion)||void 0===i?void 0:i.shouldIgnoreAutoCouponCheckoutWidgetHidingRules)}(e,t),u||r.ignoreWidgetHidingRulesWhenBnplUnavailable&&!s?[2,!1]:[2,V(t,n,o,r)]):[2,!1]}}))}))}t.getNumberOfUnsuccessfulCouponsToSelectForReevaluation=K;var z=108e5;function V(e,t,n,r){var o=e.offerId;return s(this,void 0,void 0,(function(){var e,i,a,s;return c(this,(function(c){switch(c.label){case 0:return[4,(0,b.getLocalStorageItem)(b.LocalStorageKey.couponWidgetDisplayDecisionForOffersWithOnlyUnsuccessfulCouponsMap)];case 1:return(null==(e=c.sent())?void 0:e[o])&&Date.now()-e[o].lastAttemptTimestampMs<z?[2,e[o].shouldDisplayWidget]:(i=f.min(t.map((function(e){return e.numberOfSuccessiveUnsuccessfulApplications||0})))||0,Math.random()<function(e,t,n){var r=t.minNumberOfSuccessiveUnsuccessfulApplicationsForSkipping,o=n.hiddenWidgetFallbackDisplayProbabilityDistributionParameters,i=o.rateParameter,a=o.maximumProbability,s=o.minimumProbability;return(a-s)*Math.exp(-i*(e-(r||1)))+s}(i,n,r)?((0,S.updateLocalStorageItem)(b.LocalStorageKey.couponWidgetDisplayDecisionForOffersWithOnlyUnsuccessfulCouponsMap,((a={})[o]={lastAttemptTimestampMs:Date.now(),shouldDisplayWidget:!1},a)),[2,!1]):((0,S.updateLocalStorageItem)(b.LocalStorageKey.couponWidgetDisplayDecisionForOffersWithOnlyUnsuccessfulCouponsMap,((s={})[o]={lastAttemptTimestampMs:Date.now(),shouldDisplayWidget:!0},s)),[2,!0]))}}))}))}},57419:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},a=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};Object.defineProperty(t,"__esModule",{value:!0}),t.setAmplitudeUserProperties=t.handleLogAmplitudeEventMessage=t.sendAmplitudeEvent=t.getAmplitudePlatform=void 0;var s,c=n(25841),u=n(96613),l=n(42792),d=n(68657),f=n(24785),p=n(52151),h=n(32495),v=n(81866),g="bb40330abc74b9e9b8a4f95a086c3416";function b(e){return c.browserKind===c.Browser.mobileAppWebView&&"ios"===e?s.iOS:c.browserKind===c.Browser.mobileAppWebView&&"android"===e?s.android:c.browserKind===c.Browser.chrome?s.chromeExtension:c.browserKind===c.Browser.firefox?s.firefoxExtension:c.browserKind===c.Browser.safari&&p.isMobileExtension?s.mobileSafariExtension:c.browserKind!==c.Browser.safari||p.isMobileExtension?s.unknown:s.safariExtension}function y(e){return o(this,void 0,void 0,(function(){var t,n,o,s,c,y,m,w,S,I,A,k,M,L,T;return i(this,(function(i){switch(i.label){case 0:return[4,Promise.all([(0,f.getDeviceId)(),(0,f.getOperatingSystemInfo)(),(0,h.getLocalStorageItem)(h.LocalStorageKey.userId),(0,v.getSessionId)(),(0,h.getLocalStorageItem)(h.LocalStorageKey.userRegion),(0,l.checkIsTemporaryUser)(),(0,d.checkHasGivenTrackingConsent)()])];case 1:return t=a.apply(void 0,[i.sent(),7]),n=t[0],o=t[1],s=o.os,c=o.osVersion,y=t[2],m=t[3],w=t[4],S=t[5],I=t[6],(0,d.checkIsExplicitConsentRequired)()&&!I?[2]:(A=b(s),k=(0,u.getVersionNumberKeyName)(p.isMobileSafariExtension),M=Date.now(),L={device_id:n,os_name:s,os_version:c,user_id:S?void 0:y,user_properties:(T={region:w},T[k]=u.versionNumber,T),event_type:e.type,time:M,platform:A,session_id:m},e.properties&&(L.event_properties=r(r({},e.properties),{temporaryUserId:S?y:void 0})),(0,v.updateLastEventTimestampMs)(M),[4,fetch("https://api.amplitude.com/httpapi?api_key=".concat(g)+"&event=".concat(encodeURIComponent(JSON.stringify([L])))).catch((function(e){return console.log("Amplitude: Error ".concat(e.message))}))]);case 2:return i.sent(),[2]}}))}))}!function(e){e.chromeExtension="ChromeExtension",e.firefoxExtension="FirefoxExtension",e.safariExtension="SafariExtension",e.mobileSafariExtension="MobileSafariExtension",e.iOS="iOS",e.android="Android",e.unknown="Unknown"}(s||(s={})),t.getAmplitudePlatform=b,t.sendAmplitudeEvent=y,t.handleLogAmplitudeEventMessage=function(e){var t;(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.event)&&y(e.data.event)},t.setAmplitudeUserProperties=function(e){return o(this,void 0,void 0,(function(){var t,n,r;return i(this,(function(o){switch(o.label){case 0:return[4,(0,f.getDeviceId)()];case 1:return t=o.sent(),[4,(0,h.getLocalStorageItem)(h.LocalStorageKey.userId)];case 2:return n=o.sent(),r={device_id:t,user_id:n,user_properties:e},[4,fetch("https://api2.amplitude.com/identify",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({api_key:g,identification:JSON.stringify(r)})}).catch((function(e){return console.log("Amplitude: Error ".concat(e.message))}))];case 3:return o.sent(),[2]}}))}))}},86247:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleLogAnonymousEventMessage=t.logAnonymousEventUtil=void 0;var a=n(55015),s=n(74249),c=n(24785),u=n(52151),l=n(22641);function d(e){return o(this,void 0,void 0,(function(){var t,n,o,d,f,p,h,v,g,b;return i(this,(function(i){switch(i.label){case 0:return t=(0,l.getDeduplicatedTimestampInSeconds)(),[4,(0,c.getOperatingSystemInfo)()];case 1:return n=i.sent(),o=n.os,d=n.osVersion,f=(0,l.getUserEventPlatform)(),p=(0,a.getVersionNumberKeyName)(u.isMobileSafariExtension),h=r(r({},e.payload),((b={})[p]=a.versionNumber,b.platform=f,b.os=o,b.osVersion=d,b)),v=JSON.stringify(h),g=r(r({},e),{payload:v,timestamp:t}),[4,(0,s.logAnonymousEventsThroughRestApi)([g])];case 2:return i.sent(),[2]}}))}))}t.logAnonymousEventUtil=d,t.handleLogAnonymousEventMessage=function(e){var t;(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.event)&&d(e.data.event)}},22641:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},a=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.checkShouldLogEventBasedOnRandomDraw=t.handleLogUserEventMessage=t.getDeduplicatedTimestampInSeconds=t.logUserEventUtil=t.getUserEventPlatform=void 0;var s=n(58029),c=n(25841),u=n(47248),l=n(96613),d=n(45133),f=n(86552),p=n(69363),h=n(24785),v=n(52151),g=n(32495),b=n(81866);function y(){return c.browserKind===c.Browser.mobileAppWebView?u.UserEventPlatform.mobileApp:c.browserKind===c.Browser.chrome?u.UserEventPlatform.chromeExtension:c.browserKind===c.Browser.firefox?u.UserEventPlatform.firefoxExtension:c.browserKind===c.Browser.safari&&v.isMobileExtension?u.UserEventPlatform.mobileSafariExtension:c.browserKind!==c.Browser.safari||v.isMobileExtension?u.UserEventPlatform.unknown:u.UserEventPlatform.safariExtension}function m(e,t){return o(this,void 0,void 0,(function(){var n,o,s,c,u,m,w,L,T,E,x,C,O,P,U,_,D,R,F,B,W,G,N;return i(this,(function(i){switch(i.label){case 0:return n=S(),[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.userId)];case 1:return o=i.sent(),[4,(0,h.getDeviceId)()];case 2:return s=i.sent(),[4,(0,h.getOperatingSystemInfo)()];case 3:return c=i.sent(),u=c.os,m=c.osVersion,w=y(),[4,(0,b.getSessionId)()];case 4:return L=i.sent(),T=(0,l.getVersionNumberKeyName)(v.isMobileSafariExtension),E=r(r({},e.payload),((W={})[T]=l.versionNumber,W.platform=w,W.sessionId=L,W.deviceId=s,W.os=u,W.osVersion=m,W)),x=JSON.stringify(E),C=r(r({},e),{payload:x,active:void 0===e.active||e.active,timestamp:n}),o?t?(P=!0,[3,7]):[3,5]:[3,26];case 5:return[4,I()];case 6:P=i.sent(),i.label=7;case 7:return(O=P)?[4,(0,p.logUserEventsThroughRestApi)(o,[C])]:[3,9];case 8:return i.sent(),[3,12];case 9:return[4,(0,d.getClient)()];case 10:return _=i.sent(),[4,(0,f.logUserEventThroughAppSync)(_,C)];case 11:i.sent(),i.label=12;case 12:return[4,k()];case 13:return(U=i.sent()).length>0?[4,M([])]:[3,25];case 14:return i.sent(),O?[4,(0,p.logUserEventsThroughRestApi)(o,U)]:[3,16];case 15:return i.sent(),[3,25];case 16:return[4,(0,d.getClient)()];case 17:_=i.sent(),i.label=18;case 18:i.trys.push([18,23,24,25]),D=a(U),R=D.next(),i.label=19;case 19:return R.done?[3,22]:(F=R.value,[4,(0,f.logUserEventThroughAppSync)(_,F)]);case 20:i.sent(),i.label=21;case 21:return R=D.next(),[3,19];case 22:return[3,25];case 23:return B=i.sent(),G={error:B},[3,25];case 24:try{R&&!R.done&&(N=D.return)&&N.call(D)}finally{if(G)throw G.error}return[7];case 25:return[3,28];case 26:return[4,A(C)];case 27:i.sent(),i.label=28;case 28:return[2]}}))}))}t.getUserEventPlatform=y,t.logUserEventUtil=m;var w={lastEventTimestampMs:void 0};function S(){var e=Date.now(),t=w.lastEventTimestampMs,n=t&&e<=t?t+1:e;return w.lastEventTimestampMs=n,(0,b.updateLastEventTimestampMs)(n),Number((n/1e3).toFixed(3))}function I(){return o(this,void 0,void 0,(function(){var e;return i(this,(function(t){switch(t.label){case 0:return[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.userFeaturesMap)];case 1:return(e=t.sent())?[2,!!(!v.isMobileExtension&&e[s.Feature.shouldLogUserEventsThroughRestApiForDesktopBrowserExtension]||v.isMobileExtension&&e[s.Feature.shouldLogUserEventsThroughRestApiForMobileBrowserExtension])]:[2,!1]}}))}))}function A(e){return o(this,void 0,void 0,(function(){var t;return i(this,(function(n){switch(n.label){case 0:return[4,k()];case 1:return(t=n.sent()).push(e),[4,M(t)];case 2:return n.sent(),[2]}}))}))}function k(){return o(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.savedUserEvents)];case 1:return[2,e.sent()||[]]}}))}))}function M(e){return o(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,(0,g.setLocalStorageItem)(g.LocalStorageKey.savedUserEvents,e)];case 1:return t.sent(),[2]}}))}))}t.getDeduplicatedTimestampInSeconds=S,t.handleLogUserEventMessage=function(e){var t;(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.event)&&m(e.data.event)},t.checkShouldLogEventBasedOnRandomDraw=function(e){return Math.random()<e}},68124:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},a=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};Object.defineProperty(t,"__esModule",{value:!0}),t.handleGetSharedBalanceStatusMessage=t.getOnboardingState=t.checkIsValidOnboardingState=t.OnboardingState=t.getPreciseMobileSafariExtensionAuthorizationStatus=t.handleMobileSafariMissingAuthorizationActions=t.checkMobileSafariAuthorization=t.handleMobileSafariAuthorizationDetection=t.openInstructionWebpage=t.InstructionStep=t.confirmMobileSafariActivation=void 0;var s,c,u=n(58029),l=n(25841),d=n(89614),f=n(47248),p=n(45133),h=n(42792),v=n(52151),g=n(32495),b=n(57419),y=n(22641),m=n(69479),w=n(22846),S=n(87626),I=n(16206),A=n(32668),k="https://app.joko.com/mobile-safari-extension-installation",M={isFinished:!1};function L(e,t){return o(this,void 0,void 0,(function(){var n,r,o;return i(this,(function(i){switch(i.label){case 0:return Number((0,l.getSafariMajorAndMinorOsVersion)())<16?[2,!1]:A.isOsVersion18OrLater||t!==d.Region.US&&t!==d.Region.GB?[4,Promise.all([(0,w.getDoesBelongToTestGroupPreRegistration)(e,w.PreRegistrationTwoGroupAbTestSettingsKey.shouldUseRevampedMobileSafariExtensionInstallationFlowGroupProportion),(0,w.getDoesBelongToTestGroupPreRegistration)(e,w.PreRegistrationTwoGroupAbTestSettingsKey.shouldShowBannerInRevampedMobileSafariExtensionInstallationFlowTestGroupProportion)])]:[2,!1];case 1:return n=a.apply(void 0,[i.sent(),2]),r=n[0],o=n[1],[2,r&&o]}}))}))}function T(e){var t=e.isDevStackMode,n=e.userId,r=e.region,o=e.step,i=e.shouldUseSecondInstructionWebsite,a=e.shouldOpenInCurrentTab,c=e.onboardingState,u=e.callback,l=e.isFlowWithSystemSettings,f=e.userSeed,p="".concat(i?t?"http://dev.app.joko.com.s3-website-eu-west-1.amazonaws.com/mobile-safari-extension-installation":"http://app.joko.com.s3-website-eu-west-1.amazonaws.com/mobile-safari-extension-installation":t?"https://dev.app.joko.com/mobile-safari-extension-installation":k,"?step=").concat(o,"&region=").concat(r||d.Region.FR);t&&(p+="&devStack=true"),n&&(p+="&userId=".concat(n)),l&&(p+="&isFlowWithSystemSettings=true"),f&&(p+="&userSeed=".concat(f)),p+=c===W.beforeOnboarding?"&isBeforeOnboarding=true":c===W.onboardingOngoing?"&isOnboarding=true":"",a?u?chrome.tabs.update({url:p,active:!0},u):chrome.tabs.update({url:p,active:!0}):u?chrome.tabs.create({url:p},u):chrome.tabs.create({url:p}),function(e){[s.authorize,s.authorizeWithBanner].includes(e)?((0,m.sendNativeMessage)("setLastMobileSafariExtensionSetupAuthorizationPageOpenedAt"),(0,m.sendMobileSafariExtensionSetupConfirmationNativeMessage)("activated")):e===s.conclusion&&((0,m.sendNativeMessage)("setLastMobileSafariExtensionSetupConclusionPageOpenedAt"),(0,m.sendMobileSafariExtensionSetupConfirmationNativeMessage)("authorized"))}(o),o===s.authorizeWithBanner&&K({isNewBannerSession:!0,isDuringSetupFlow:!0})}t.confirmMobileSafariActivation=function(e){return o(this,void 0,void 0,(function(){var t,n,r,o,a,c,u,l,d;return i(this,(function(i){switch(i.label){case 0:return v=Q(),b=5e3,y=new Promise((function(e){setTimeout((function(){return e(void 0)}),b)})),t=Promise.race([v,y]),[4,(0,p.getDevStackMode)()];case 1:n=i.sent(),f=n,(h=function(e){T({userId:void 0,isDevStackMode:f,region:void 0,shouldUseSecondInstructionWebsite:!1,step:e?s.secondWaitingStep:s.firstWaitingStep,shouldOpenInCurrentTab:!1}),e&&(M.isFinished=!0)})(!1),setTimeout((function(){return h(!0)}),1e3),r=Date.now(),o=void 0,a=void 0,i.label=2;case 2:return Date.now()-r<5e3?[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.userId)]:[3,8];case 3:return o=i.sent(),[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.userRegion)];case 4:return a=i.sent(),o&&M.isFinished&&a?[3,6]:[4,new Promise((function(e){return setTimeout(e,200)}))];case 5:return i.sent(),[3,7];case 6:return[3,8];case 7:return[3,2];case 8:return[4,(0,m.getOrInitPreRegistrationUserSeed)()];case 9:return[4,L(c=i.sent(),a)];case 10:return u=i.sent(),l=T,d={userId:o,isDevStackMode:n,region:a,shouldUseSecondInstructionWebsite:!1,step:u?s.authorizeWithBanner:s.authorize,shouldOpenInCurrentTab:!0},[4,t];case 11:return l.apply(void 0,[(d.onboardingState=i.sent(),d.callback=e,d.userSeed=c,d)]),[2]}var f,h,v,b,y}))}))},function(e){e.activate="activate",e.authorize="authorize",e.authorizeWithBanner="authorizeWithBanner",e.conclusion="conclusion",e.missingAllWebsitesAuthorization="missingAllWebsitesAuthorization",e.missingAllWebsitesAuthorizationAfterRetry="missingAllWebsitesAuthorizationAfterRetry",e.missingAuthorization="missingAuthorization",e.temporaryAccountReplacement="temporaryAccountReplacement",e.firstWaitingStep="firstWaitingStep",e.secondWaitingStep="secondWaitingStep"}(s=t.InstructionStep||(t.InstructionStep={})),t.openInstructionWebpage=T,function(e){e.instructionWebsite1="instructionWebsite1",e.instructionWebsite2="instructionWebsite2",e.other="other"}(c||(c={})),t.handleMobileSafariAuthorizationDetection=function(e){return o(this,void 0,void 0,(function(){var t,n,r,o,u,l,d,f,h;return i(this,(function(i){switch(i.label){case 0:return[4,P("allWebsites")];case 1:return(t=i.sent())?[3,3]:[4,P("legacyAuthorizationFlag")];case 2:t=i.sent(),i.label=3;case 3:return t?[2]:[4,Promise.all([(0,g.getLocalStorageItem)(g.LocalStorageKey.userId),Q(),(0,p.getDevStackMode)(),(0,g.getLocalStorageItem)(g.LocalStorageKey.userRegion),(0,m.getOrInitPreRegistrationUserSeed)()])];case 4:return n=a.apply(void 0,[i.sent(),5]),r=n[0],o=n[1],u=n[2],l=n[3],d=n[4],f=function(e){if(!e)return c.other;try{return RegExp("joko").test(e)?RegExp("amazonaws").test(e)?c.instructionWebsite2:c.instructionWebsite1:c.other}catch(e){return c.other}}(e),f!==c.instructionWebsite1?[3,6]:[4,P("instructionWebsite1")];case 5:return i.sent()?[2]:(O("instructionWebsite1"),F((function(t){t?(O("allWebsites"),U({isFromNonInstructionWebsite:!1}),e&&/step=temporaryAccountReplacement/.test(e)||T({userId:r,isDevStackMode:u,region:l,shouldUseSecondInstructionWebsite:!1,shouldOpenInCurrentTab:!0,step:s.conclusion,onboardingState:o,callback:B,userSeed:d})):(_(),T({userId:r,isDevStackMode:u,region:l,shouldUseSecondInstructionWebsite:!0,shouldOpenInCurrentTab:!0,onboardingState:o,step:s.missingAllWebsitesAuthorization,userSeed:d}),r||function(){try{var e=void 0,t=k+"?step=wait";chrome.tabs.create({url:t,active:!1},(function(t){e=t.id})),setTimeout((function(){e&&chrome.tabs.remove(e)}),R)}catch(e){}}())})),[3,9]);case 6:return f!==c.instructionWebsite2?[3,8]:[4,P("instructionWebsite2")];case 7:return i.sent()?[2]:(O("instructionWebsite2"),F((function(t){t?(O("allWebsites"),U({isFromNonInstructionWebsite:!1}),e&&/step=temporaryAccountReplacement/.test(e)||T({userId:r,isDevStackMode:u,region:l,shouldUseSecondInstructionWebsite:!0,shouldOpenInCurrentTab:!0,step:s.conclusion,onboardingState:o,callback:B,userSeed:d})):(_(),T({userId:r,isDevStackMode:u,region:l,shouldUseSecondInstructionWebsite:!0,shouldOpenInCurrentTab:!0,onboardingState:o,step:s.missingAllWebsitesAuthorizationAfterRetry,userSeed:d}))})),[3,9]);case 8:if(!0===E.value||!0===x.value)return[2];O("allWebsites"),h=function(t){return U({isFromNonInstructionWebsite:!0,sourceUrl:e,hasAuthorizedAllWebsites:t})},(0,m.sendMobileSafariExtensionSetupConfirmationNativeMessage)("authorized"),F(h),i.label=9;case 9:return[2]}}))}))};var E={value:!1},x={value:!1},C={value:!1};function O(e){"instructionWebsite1"===e?(E.value=!0,(0,g.setLocalStorageItem)(g.LocalStorageKey.hasAlreadyDetectedMobileSafariAuthorizationOnInstructionWebsite1,!0)):"instructionWebsite2"===e?(x.value=!0,(0,g.setLocalStorageItem)(g.LocalStorageKey.hasAlreadyDetectedMobileSafariAuthorizationOnInstructionWebsite2,!0)):"allWebsites"===e&&(C.value=!0,(0,g.setLocalStorageItem)(g.LocalStorageKey.hasAlreadyDetectedMobileSafariAuthorizationOnAllWebsites,!0))}function P(e){return o(this,void 0,void 0,(function(){var t,n,r;return i(this,(function(o){switch(o.label){case 0:switch(e){case"instructionWebsite1":return[3,1];case"instructionWebsite2":return[3,4];case"allWebsites":return[3,7];case"legacyAuthorizationFlag":return[3,10]}return[3,12];case 1:return(t=E.value)?[3,3]:[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.hasAlreadyDetectedMobileSafariAuthorizationOnInstructionWebsite1)];case 2:t=o.sent(),o.label=3;case 3:return[2,!!t];case 4:return(n=x.value)?[3,6]:[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.hasAlreadyDetectedMobileSafariAuthorizationOnInstructionWebsite2)];case 5:n=o.sent(),o.label=6;case 6:return[2,!!n];case 7:return(r=C.value)?[3,9]:[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.hasAlreadyDetectedMobileSafariAuthorizationOnAllWebsites)];case 8:r=o.sent(),o.label=9;case 9:return[2,!!r];case 10:return[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.hasAlreadyDetectedMobileSafariAuthorization)];case 11:return[2,!!o.sent()];case 12:return[2]}}))}))}function U(e){var t=e.isFromNonInstructionWebsite,n=e.sourceUrl,r=e.hasAuthorizedAllWebsites,o=n?new URL(n).hostname:void 0,i=t?{fromNonInstructionWebsite:{isFromNonInstructionWebsite:t,sourceDomain:o,hasAuthorizedAllWebsites:r}}:{};(0,y.logUserEventUtil)({type:"authorizedMobileSafariExtension",payload:i}),(0,b.sendAmplitudeEvent)({type:"Mobile Safari Extension - Authorized Extension",properties:i})}function _(){(0,y.logUserEventUtil)({type:"missingMobileSafariExtensionAuthorizationDetected",payload:{isAllWebsitesAuthorizationMissing:!0}}),(0,b.sendAmplitudeEvent)({type:"Mobile Safari Extension - Missing Authorization Detected",properties:{isAllWebsitesAuthorizationMissing:!0}})}var D="https://www.nike.fr",R=3e3;function F(e){try{var t=void 0;chrome.tabs.create({url:D,active:!1},(function(e){t=e.id}));var n=setTimeout((function(){chrome.tabs.onUpdated.removeListener(r),t&&chrome.tabs.remove(t),e(!1)}),R),r=(0,S.withSentry)((function(o,i){o===t&&(clearTimeout(n),chrome.tabs.onUpdated.removeListener(r),chrome.tabs.remove(t),i.url?e(!0):e(!1))}));chrome.tabs.onUpdated.addListener(r)}catch(t){console.error(t),e(!1)}}function B(){setTimeout((function(){return(0,g.setLocalStorageItem)(g.LocalStorageKey.hasAlreadyDisplayedMobileSafariSetupConclusionPage,!0)}),1e3)}t.checkMobileSafariAuthorization=function(e){var t=e.currentTimestampMs,n=e.nonJokoContentScriptExecutionDetectedLast24Hours;return o(this,void 0,void 0,(function(){var e,r,o,a,s;return i(this,(function(i){switch(i.label){case 0:return r=I.parseSetting,[4,(0,I.getSetting)(f.SettingKey.mobileSafariExtensionAuthorizationBannerSettings)];case 1:return(e=r.apply(void 0,[i.sent()]))&&"object"==typeof e?(o=e.delayAfterInstallBeforeFirstAuthorizationCheckInHours,a=e.shouldCheckAuthorizationForOldUsers,[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.installationTimestampMs)]):[2];case 2:return s=i.sent(),(s?t-s>60*(o||24)*60*1e3:!!a)&&!n?(0,g.setLocalStorageItem)(g.LocalStorageKey.isMobileSafariAuthorizationMissing,!0):(0,g.setLocalStorageItem)(g.LocalStorageKey.isMobileSafariAuthorizationMissing,!1),[2]}}))}))},t.handleMobileSafariMissingAuthorizationActions=function(e){return o(this,void 0,void 0,(function(){var t,n;return i(this,(function(c){switch(c.label){case 0:return[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.isMobileSafariAuthorizationMissing)];case 1:return c.sent()?[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.lastBrowsingSessionStartedTimestampMs)]:[2];case 2:return t=c.sent(),[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.userFeaturesMap)];case 3:return n=c.sent(),function(e,t){o(this,void 0,void 0,(function(){var n,r,o;return i(this,(function(i){switch(i.label){case 0:return[4,N(e,t)];case 1:return n=a.apply(void 0,[i.sent(),2]),r=n[0],o=n[1],r&&K({isNewBannerSession:o,isDuringSetupFlow:!1}),[2]}}))}))}(e,t),(null==n?void 0:n[u.Feature.openAuthorizationPageInNewTabMobileSafariExtension])&&function(e){o(this,void 0,void 0,(function(){var t,n,c,u;return i(this,(function(l){switch(l.label){case 0:return[4,j(e)];case 1:return t=a.apply(void 0,[l.sent(),3]),n=t[0],c=t[1],u=t[2],n&&function(e,t){o(this,void 0,void 0,(function(){var n,o,a,c,u,l,d;return i(this,(function(i){switch(i.label){case 0:return[4,(0,p.getDevStackMode)()];case 1:return n=i.sent(),[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.userId)];case 2:return o=i.sent(),[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.userRegion)];case 3:return a=i.sent(),[4,Q()];case 4:return c=i.sent(),T({isDevStackMode:n,userId:o,region:a,step:s.missingAuthorization,onboardingState:c,shouldOpenInCurrentTab:!1,shouldUseSecondInstructionWebsite:e,isFlowWithSystemSettings:!0}),u=Date.now(),(0,g.setLocalStorageItem)(g.LocalStorageKey.lastAuthorizationPageTriggeredTimestampMs,u),d=[{hasAlreadyDetectedMobileSafariAuthorizationOnInstructionWebsites1And2:t}],[4,q()];case 5:return l=r.apply(void 0,[r.apply(void 0,d.concat([i.sent()])),{authorizationWebsite:e?"fallback":"first"}]),(0,y.logUserEventUtil)({type:"mobileSafariExtensionAuthorizationPageInNewTabDisplayed",active:!1,payload:l}),(0,b.sendAmplitudeEvent)({type:"Mobile Safari Extension - Authorization Page In New Tab Displayed",properties:l}),[2]}}))}))}(c,u),[2]}}))}))}(t),[2]}}))}))};var W,G=10;function N(e,t){return o(this,void 0,void 0,(function(){var n,r,o,s,c,u,l,d,p,v,b,y;return i(this,(function(i){switch(i.label){case 0:return[4,Promise.all([(0,h.checkIsSignedIn)(),(0,h.checkIsTemporaryUser)()])];case 1:return n=a.apply(void 0,[i.sent(),2]),r=n[0],o=n[1],!r||o?[2,[!1,!1]]:"complete"!==e?[2,[!1,!1]]:(c=I.parseSetting,[4,(0,I.getSetting)(f.SettingKey.mobileSafariExtensionAuthorizationBannerSettings)]);case 2:return(s=c.apply(void 0,[i.sent()]))&&"object"==typeof s?(u=s.delayAfterBrowsingSessionStartBeforeShowingBannerInMinutes,l=s.delayBetweenTwoBannerTriggersInMinutes,d=s.delayBetweenTwoBannerSessionsInDays,p=Date.now(),!!t&&p-t<60*(u||2)*1e3?[2,[!1,!1]]:[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.lastAuthorizationBannerTriggeredTimestampMs)]):[2,[!1,!1]];case 3:return v=i.sent(),!v||p-v>60*(l||2)*1e3?[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.lastAuthorizationBannerSessionStartedTimestampMs)]:[2,[!1,!1]];case 4:return b=i.sent(),y=d&&d>0?!b||p-b>24*d*60*60*1e3:!b,[2,[!!b&&p-b<60*G*1e3||y,y]]}}))}))}function K(e){var t=e.isNewBannerSession,n=e.isDuringSetupFlow;chrome.tabs.query({active:!0,currentWindow:!0},(function(){}));var r=Date.now();(0,g.setLocalStorageItem)(g.LocalStorageKey.lastAuthorizationBannerTriggeredTimestampMs,r),(0,y.logUserEventUtil)({type:"mobileSafariExtensionAuthorizationBannerDisplayRequested",active:!1,payload:{isDuringSetupFlow:n}}),(0,b.sendAmplitudeEvent)({type:"Mobile Safari Extension - Authorization Banner Display Requested",properties:{isDuringSetupFlow:n}}),t&&(0,g.setLocalStorageItem)(g.LocalStorageKey.lastAuthorizationBannerSessionStartedTimestampMs,r)}function j(e){return o(this,void 0,void 0,(function(){var t,n,r,o,s,c,u,l,d,p,v,b,y,m,w;return i(this,(function(i){switch(i.label){case 0:return[4,Promise.all([(0,h.checkIsSignedIn)(),(0,h.checkIsTemporaryUser)()])];case 1:return t=a.apply(void 0,[i.sent(),2]),n=t[0],r=t[1],!n||r?[2,[!1,!1,!1]]:[4,P("allWebsites")];case 2:return o=i.sent(),[4,P("instructionWebsite1")];case 3:return s=i.sent(),[4,P("instructionWebsite2")];case 4:return c=i.sent(),o?[2,[!1,!1,!1]]:(l=I.parseSetting,[4,(0,I.getSetting)(f.SettingKey.mobileSafariExtensionAuthorizationPageInNewTabSettings)]);case 5:return(u=l.apply(void 0,[i.sent()]))&&"object"==typeof u?(d=u.delayBetweenTwoTriggersInDays,p=u.minimumDelayAfterBrowsingSessionStartInMinutes,v=u.maximumDelayAfterBrowsingSessionStartInMinutes,b=Date.now(),!!e&&(b-e<60*(p||1)*1e3||b-e>60*(v||5)*1e3)?[2,[!1,!1,!1]]:[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.lastAuthorizationPageTriggeredTimestampMs)]):[2,[!1,!1,!1]];case 6:return(y=i.sent())?(w=y,[3,9]):[3,7];case 7:return[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.installationTimestampMs)];case 8:w=i.sent(),i.label=9;case 9:return[2,[!(m=w)||b-m>24*(d||7)*60*60*1e3,s,s&&c]]}}))}))}function q(){return o(this,void 0,void 0,(function(){var e,t,n;return i(this,(function(r){switch(r.label){case 0:return[4,P("instructionWebsite1")];case 1:return e=r.sent(),[4,P("instructionWebsite2")];case 2:return t=r.sent(),[4,P("allWebsites")];case 3:return n=r.sent(),[2,{hasAlreadyDetectedMobileSafariAuthorizationOnInstructionWebsite1:e,hasAlreadyDetectedMobileSafariAuthorizationOnInstructionWebsite2:t,hasAlreadyDetectedMobileSafariAuthorizationOnAllWebsites:n}]}}))}))}function Q(){return o(this,void 0,void 0,(function(){var e,t;return i(this,(function(n){switch(n.label){case 0:return v.isMobileSafariExtension?[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.onboardingState)]:[2,void 0];case 1:return(e=n.sent())&&e===W.afterOnboarding?[2,W.afterOnboarding]:[4,(0,m.getMobileSafariSharedOnboardingState)()];case 2:return(t=n.sent())?[4,(0,g.setLocalStorageItem)(g.LocalStorageKey.onboardingState,t)]:[3,4];case 3:return n.sent(),[2,t];case 4:return[2,void 0]}}))}))}t.getPreciseMobileSafariExtensionAuthorizationStatus=q,function(e){e.beforeOnboarding="beforeOnboarding",e.onboardingOngoing="onboardingOngoing",e.afterOnboarding="afterOnboarding"}(W=t.OnboardingState||(t.OnboardingState={})),t.checkIsValidOnboardingState=function(e){return"string"==typeof e&&Object.values(W).includes(e)},t.getOnboardingState=Q,t.handleGetSharedBalanceStatusMessage=function(e){return o(this,void 0,void 0,(function(){var t;return i(this,(function(n){switch(n.label){case 0:return[4,(0,m.getMobileSafariSharedBalanceStatus)()];case 1:return t=n.sent(),e({sharedBalanceStatus:t}),[2]}}))}))}},84594:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},i=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},a=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.switchToMobileSafariSharedDevStackMode=t.handleForceMobileSafariAutoLoginMessage=t.handleMobileSafariAutoLogin=void 0;var s=n(67935),c=n(45133),u=n(42792),l=n(52151),d=n(32495),f=n(57419),p={isAutoLoginSuccessful:!1,isTemporaryAccountCreationTriggered:!1};function h(e){var t=e.fromContentScript,n=e.shouldForceLogin;return function(e){return r(this,void 0,void 0,(function(){var r,l,h,b,y,m,w,S,I,A,k,M,L,T,E,x,C,O,P;return o(this,(function(o){switch(o.label){case 0:if(!e||"object"!=typeof e||!("sharedCognitoAuthenticationData"in e)||"string"!=typeof e.sharedCognitoAuthenticationData)return[3,19];o.label=1;case 1:for(b in o.trys.push([1,18,,19]),r=function(e){var t,n,r={};try{for(var o=a(Object.entries(e)),s=o.next();!s.done;s=o.next()){var c=i(s.value,2),u=c[0],l=c[1];if(u.startsWith(v))r[u.replace(v,"")]=l}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return r}(JSON.parse(e.sharedCognitoAuthenticationData)),l=void 0,h=void 0,O=void 0,r)if(b&&(null==(y=b.match(/CognitoIdentityServiceProvider\.([\w-]+)\.([\w-]+)\.([\w-]+)/))?void 0:y[1])&&(null==y?void 0:y[2])){P=i(y,3),l=P[1],h=P[2],O="113u65488gfatp3kll8cnnlpr5"===l?c.DevStackMode.activated:c.DevStackMode.deactivated;break}return m=l&&h&&O,[4,Promise.all([(0,u.checkIsSignedIn)(),(0,u.checkIsTemporaryUser)()])];case 2:return w=i.apply(void 0,[o.sent(),2]),S=w[0],I=w[1],A=!S||I||n,m&&A?(k=void 0,I?[4,(0,d.getLocalStorageItem)(d.LocalStorageKey.userId)]:[3,7]):[3,17];case 3:return k=o.sent(),h?[4,(0,u.triggerReplacementActionsForTemporaryAccountAndSignOut)({regularAccountUserId:h})]:[3,5];case 4:o.sent(),o.label=5;case 5:return[4,(0,u.clearLocalStorageForAccountReplacement)()];case 6:o.sent(),o.label=7;case 7:return[4,(0,s.clearAuthStorage)()];case 8:return o.sent(),l?[4,(0,d.setLocalStorageItem)(d.LocalStorageKey.cognitoUserPoolWebClientId,l)]:[3,10];case 9:o.sent(),o.label=10;case 10:return O?[4,(0,d.setLocalStorageItem)(d.LocalStorageKey.devStackMode,O)]:[3,12];case 11:o.sent(),o.label=12;case 12:return[4,(0,s.importAuthKeysFromAutoLoginData)(r)];case 13:return o.sent(),p.isAutoLoginSuccessful=!0,h?[4,(0,u.triggerPostSignInActions)(h,!0)]:[3,15];case 14:o.sent(),o.label=15;case 15:return(0,f.sendAmplitudeEvent)({type:"Registration - Auto Login Succeeded",properties:{autoLoginMechanism:"mobileApp",fromContentScript:t,shouldForceLogin:n}}),k&&""!==k?[4,(0,u.triggerReplacementActionsForRegularAccount)({temporaryAccountUserId:k})]:[3,17];case 16:o.sent(),o.label=17;case 17:return[3,19];case 18:return M=o.sent(),console.log("Error while parsing native response to 'getSharedCognitoAuthenticationData': ".concat(M)),[3,19];case 19:return[4,Promise.all([(0,d.getLocalStorageItem)(d.LocalStorageKey.hasAlreadyDetectedMobileSafariAuthorizationOnAllWebsites),(0,d.getLocalStorageItem)(d.LocalStorageKey.termsOfServiceAndPrivacyPolicyConsentDetectedTimestampMs),(0,d.getLocalStorageItem)(d.LocalStorageKey.hasAlreadyDisplayedMobileSafariSetupConclusionPage),(0,u.checkIsSignedIn)()])];case 20:return L=i.apply(void 0,[o.sent(),4]),T=L[0],E=L[1],x=L[2],!L[3]&&T&&E&&t&&x&&!p.isTemporaryAccountCreationTriggered&&!p.isAutoLoginSuccessful?[4,(0,d.getLocalStorageItem)(d.LocalStorageKey.termsOfServiceAndPrivacyPolicyConsentDetectedIsDevStackMode)]:[3,24];case 21:return C=!!o.sent(),O=C?c.DevStackMode.activated:c.DevStackMode.deactivated,[4,(0,d.setLocalStorageItem)(d.LocalStorageKey.devStackMode,O)];case 22:return o.sent(),[4,g()];case 23:o.sent(),o.label=24;case 24:return[2]}}))}))}}t.handleMobileSafariAutoLogin=function(e){return r(this,void 0,void 0,(function(){var t,n,r;return o(this,(function(o){switch(o.label){case 0:return[4,Promise.all([(0,u.checkIsSignedIn)(),(0,u.checkIsTemporaryUser)()])];case 1:return t=i.apply(void 0,[o.sent(),2]),n=t[0],r=t[1],!l.isMobileSafariExtension||n&&!r||browser.runtime.sendNativeMessage&&browser.runtime.sendNativeMessage("application.id","getSharedCognitoAuthenticationData",h({fromContentScript:e,shouldForceLogin:!1})),[2]}}))}))},t.handleForceMobileSafariAutoLoginMessage=function(){return new Promise((function(e){l.isMobileSafariExtension&&browser.runtime.sendNativeMessage?browser.runtime.sendNativeMessage("application.id","getSharedCognitoAuthenticationData",(function(t){return h({fromContentScript:!1,shouldForceLogin:!0})(t).then(e)})):e()}))};var v="@MemoryStorage:";function g(){return r(this,void 0,void 0,(function(){var e,t,n=this;return o(this,(function(i){switch(i.label){case 0:return(t=!l.isMobileSafariExtension)?[3,2]:[4,(0,u.checkIsSignedIn)()];case 1:t=i.sent(),i.label=2;case 2:return(e=t)?[3,4]:[4,(0,u.checkIsTemporaryAccountCreationDisabled)()];case 3:e=i.sent(),i.label=4;case 4:if(e)return[2];if(p.isTemporaryAccountCreationTriggered)return[2];p.isTemporaryAccountCreationTriggered=!0,setTimeout((function(){return r(n,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,(0,u.checkIsSignedIn)()];case 1:return e.sent()||(p.isTemporaryAccountCreationTriggered=!1),[2]}}))}))}),15e3),i.label=5;case 5:return i.trys.push([5,7,,8]),[4,(0,u.createTemporaryAccountAndSignIn)()];case 6:return i.sent(),[3,8];case 7:return i.sent(),p.isTemporaryAccountCreationTriggered=!1,[3,8];case 8:return[2]}}))}))}t.switchToMobileSafariSharedDevStackMode=function(){l.isMobileSafariExtension&&browser.runtime.sendNativeMessage&&browser.runtime.sendNativeMessage("application.id","getSharedDevStackMode",(function(e){return function(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return!e||chrome.runtime.lastError||"object"!=typeof e||"string"!=typeof e.sharedDevStackMode?[2]:(t=e.sharedDevStackMode,[4,(0,d.getLocalStorageItem)(d.LocalStorageKey.devStackMode)]);case 1:return n.sent()===t?[3,3]:[4,(0,d.setLocalStorageItem)(d.LocalStorageKey.devStackMode,t)];case 2:n.sent(),n.label=3;case 3:return[2]}}))}))}(e)}))}},69479:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.getOrInitPreRegistrationUserSeed=t.getMobileSafariLastBankReconnectedAt=t.getMobileSafariSharedBalanceStatus=t.getMobileSafariSharedOnboardingState=t.getMobileSafariSharedRegion=t.syncMobileSafariExtensionSetupStateInAppGroup=t.sendMobileSafariExtensionSetupConfirmationNativeMessage=t.getMobileSafariSharedAdjustId=t.getMobileSafariSharedDeviceId=t.sendNativeMessage=void 0;var i=n(2543),a=n(47248),s=n(52151),c=n(68124),u=n(22846);function l(e,t){return void 0===t&&(t=i.identity),s.isMobileSafariExtension&&browser.runtime.sendNativeMessage?new Promise((function(n){var r,o;null===(o=(r=browser.runtime).sendNativeMessage)||void 0===o||o.call(r,"application.id",e,(function(e){n(t(e))}))})):Promise.resolve(void 0)}function d(e,t){return"object"==typeof e&&"string"==typeof(null==e?void 0:e[t])}function f(e){if(d(e,"sharedDeviceId"))try{var t=e.sharedDeviceId;return t||void 0}catch(e){return void console.error("Error while parsing native response to 'getSharedDeviceId': ".concat(e))}}function p(e){if(d(e,"sharedAdjustId"))try{var t=e.sharedAdjustId;return t||void 0}catch(e){return void console.error("Error while parsing native response to 'getSharedAdjustId': ".concat(e))}}function h(e){return l("activated"===e?"setLastIsMobileSafariExtensionActivatedConfirmedAt":"setLastIsMobileSafariExtensionAuthorizedConfirmedAt")}function v(e){if(d(e,"sharedRegion")&&!chrome.runtime.lastError)return null==e?void 0:e.sharedRegion}function g(e){if(d(e,"sharedOnboardingState")&&!chrome.runtime.lastError)return e.sharedOnboardingState}function b(e){if(e&&d(e,"sharedBalanceStatus")&&!chrome.runtime.lastError)try{return JSON.parse(e.sharedBalanceStatus)}catch(e){return void console.error("Error while parsing native iOS message for 'getSharedBalanceStatus': ".concat(e))}}function y(e){if(d(e,"sharedPreRegistrationUserSeed")&&!chrome.runtime.lastError){var t=e.sharedPreRegistrationUserSeed;return(0,u.parseUserSeed)(t)}}function m(e){return l("setSharedPreRegistrationUserSeed:".concat(e))}t.sendNativeMessage=l,t.getMobileSafariSharedDeviceId=function(){return l("getSharedDeviceId",f)},t.getMobileSafariSharedAdjustId=function(){return l("getSharedAdjustId",p)},t.sendMobileSafariExtensionSetupConfirmationNativeMessage=h,t.syncMobileSafariExtensionSetupStateInAppGroup=function(){return r(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return h("activated"),[4,(0,c.getPreciseMobileSafariExtensionAuthorizationStatus)()];case 1:return e.sent().hasAlreadyDetectedMobileSafariAuthorizationOnAllWebsites&&h("authorized"),[2]}}))}))},t.getMobileSafariSharedRegion=function(){return l("getSharedRegion",v).then((function(e){return{region:e,detectionMethod:a.RegionDetectionMethod.MobileApp}}))},t.getMobileSafariSharedOnboardingState=function(){return l("getSharedOnboardingState",g)},t.getMobileSafariSharedBalanceStatus=function(){return l("getSharedBalanceStatus",b)},t.getMobileSafariLastBankReconnectedAt=function(){return new Promise((function(e){return l("getLastBankReconnectedAt",(function(t){var n=t.lastBankReconnectedAt;return e(new Date(Number(n)))}))}))},t.getOrInitPreRegistrationUserSeed=function(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,l("getSharedPreRegistrationUserSeed",y)];case 1:return void 0!==(e=t.sent())?[3,3]:[4,m(e=Math.random())];case 2:t.sent(),t.label=3;case 3:return[2,e]}}))}))}},22846:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.getDoesBelongToTestGroupPreRegistration=t.parseUserSeed=t.PreRegistrationTwoGroupAbTestSettingsKey=void 0;var i=n(47248),a=n(16206),s=n(83503);!function(e){e.shouldUseRevampedMobileSafariExtensionInstallationFlowGroupProportion="shouldUseRevampedMobileSafariExtensionInstallationFlowTestGroupProportion",e.shouldShowBannerInRevampedMobileSafariExtensionInstallationFlowTestGroupProportion="shouldShowBannerInRevampedMobileSafariExtensionInstallationFlowTestGroupProportion"}(t.PreRegistrationTwoGroupAbTestSettingsKey||(t.PreRegistrationTwoGroupAbTestSettingsKey={})),t.parseUserSeed=function(e){try{var t=Number(e);return function(e){if(!u(e))throw new RangeError("Invalid value: ".concat(e));if(0===e)throw new RangeError("It is highly unlikely that the user seed is 0; it was probably specified wrongly or not at all.")}(t),t}catch(e){console.error("Error while parsing native response to 'sharedPreRegistrationUserSeed': ".concat(e))}},t.getDoesBelongToTestGroupPreRegistration=function(e,t){return r(this,void 0,void 0,(function(){var n,r;return o(this,(function(o){switch(o.label){case 0:return[4,(0,a.getPublicSetting)(i.SettingKey.preRegistrationTwoGroupAbTestSettings)];case 1:if(!(n=o.sent()))return[2,!1];try{if(void 0===(r=n[t])||!u(r))throw new RangeError("Setting ".concat(t," should be a valid probability but is ").concat(r));return[2,(l="".concat(e,":").concat(t),d=s(l),f="f".repeat(c),p=parseInt(d,16)/parseInt(f,16),p<r)]}catch(e){return console.error("Failed to handle pre-registration AB Test settings:",e),[2,!1]}return[2]}var l,d,f,p}))}))};var c=32;function u(e){return!isNaN(e)&&e>=0&&e<=1}},56979:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.getEnrichedMerchantOffersMatchingUrlFromAppSync=t.handleGetEnrichedMerchantOfferFromAppSyncMessage=t.getEnrichedMerchantOfferFromAppSync=t.getAvailableUserOffersByOfferIdsFromAppSync=t.runThrottledEnrichedUserOfferAppSyncQuery=t.checkShouldFetchMerchantOfferFromAppSync=void 0;var i=n(58029),a=n(45133),s=n(34423),c=n(21304),u=n(37052),l=n(42792),d=n(93795),f=n(56315),p=n(13158),h=n(13469),v=n(87626);function g(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,(0,d.checkHasFeature)(i.Feature.useNewOfferConditionStyleInExtensions)];case 1:return t=n.sent(),[2,(0,u.runThrottledQuery)({queryType:u.ThrottledQueryType.enrichedUserOfferQuery,querySignature:e,runQuery:function(){return function(e,t){return(0,a.getClient)().then((function(n){return n.query({query:c.enrichedUserOfferQuery,variables:{offerId:e,returnCoupons:!0,shouldUseNewConditions:t},fetchPolicy:"network-only"})})).catch((function(e){console.error("GraphQL: error while fetching enriched user offer",e),(0,v.captureSentryException)(e)})).then((function(e){var t,n;return null===(n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.user)||void 0===n?void 0:n.enrichedOffer}))}(e,t)}})]}}))}))}function b(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return t=e.map((function(e){return g(e).catch((function(e){console.error("Error fetching user offer from AppSync",e),(0,v.captureSentryException)(e)}))})),n=function(e){return!!e},[4,Promise.all(t)];case 1:return[2,r.sent().filter(n).filter((function(e){return e.available})).filter((function(e){var t=e.offer;return(0,p.checkIsValidMerchantOfferForExtensions)(t)}))]}}))}))}t.checkShouldFetchMerchantOfferFromAppSync=function(e){return e.type===s.OfferType.OneTime||!!e.conditions&&!!e.conditions.userEligibility&&(Object.keys(e.conditions.userEligibility).some((function(e){return"excludeUsersEligibleToMerchantCardLinkedOffers"!==e}))||!!e.conditions.userEligibility.excludeUsersEligibleToMerchantCardLinkedOffers)},t.runThrottledEnrichedUserOfferAppSyncQuery=g,t.getAvailableUserOffersByOfferIdsFromAppSync=b,t.getEnrichedMerchantOfferFromAppSync=function(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,g(e)];case 1:return(null==(t=n.sent())?void 0:t.offer)?[2,t.offer]:[2,void 0]}}))}))},t.handleGetEnrichedMerchantOfferFromAppSyncMessage=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,g(e.data.offerId)];case 1:return n=r.sent(),t({offer:null==n?void 0:n.offer}),[2]}}))}))},t.getEnrichedMerchantOffersMatchingUrlFromAppSync=function(e,t){return r(this,void 0,void 0,(function(){var n,r,i,a;return o(this,(function(o){switch(o.label){case 0:return e?[4,(0,l.checkIsSignedIn)()]:[2,[]];case 1:return o.sent()?[4,(0,h.getOfferIdsMatchingUrl)(e)]:[2,[]];case 2:return[4,b(o.sent().slice(0,30))];case 3:return n=o.sent(),t&&(n=n.filter((function(e){return e.offer.type!==s.OfferType.OneTime}))),r=n.sort((function(e,t){return(0,p.comparePrioritiesOfOffers)(e.offer,t.offer)})),i=r.length?r[0]:void 0,[4,(0,f.setUserOfferActivationInfoMapInLocalStorage)(i)];case 4:return o.sent(),a=r.map((function(e){return e.offer})),[2,a]}}))}))}},76038:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},a=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},s=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.getMerchantOffersWithConditionsAndCouponsMatchingUrlOrOfferIds=t.getMerchantOfferMatchingUrlWithConditionsAndCoupons=t.handleGetMerchantOfferWithConditionsAndCouponsFromS3Message=t.handleGetMerchantOffersWithConditionsAndCouponsFromOfferIdsMessage=t.handleGetMerchantOfferMatchingUrlWithConditionsAndCouponsMessage=void 0;var c=n(34423),u=n(42792),l=n(56979),d=n(13922),f=n(56315),p=n(13158),h=n(13469);function v(e,t){return o(this,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return e?[4,g({currentUrl:e,shouldFilterOutOnetimeOffers:!!t})]:[2,void 0];case 1:return n=r.sent().offers,[2,n.length?n[0]:void 0]}}))}))}function g(e){var t=void 0===e?{}:e,n=t.currentUrl,r=t.offerIds,v=t.shouldFilterOutOnetimeOffers;return o(this,void 0,void 0,(function(){var e,t,o,g,y,m,w,S,I,A,k,M,L,T,E,x,C,O,P,U,_,D,R,F,B,W,G,N;return i(this,(function(i){switch(i.label){case 0:return e=Date.now(),[4,(0,u.checkIsSignedIn)()];case 1:return i.sent()?(t=Date.now()-e,n||r?(o=Date.now(),null==r?[3,2]:(y=r,[3,4])):[2,{offers:[],offerQueryIsSignedInCheckDurationInMs:t}]):[2,{offers:[]}];case 2:return[4,(0,h.getOfferIdsMatchingUrl)(n)];case 3:y=i.sent(),i.label=4;case 4:return g=y,m=Date.now()-o,w=Date.now(),[4,(0,d.getThrottledMerchantOffersWithConditionsAndCouponsFromS3)(g)];case 5:return S=i.sent(),I=Date.now()-w,S.length===g.length?[3,10]:(A=Date.now(),r?[4,(0,l.getAvailableUserOffersByOfferIdsFromAppSync)(r)]:[3,7]);case 6:return M=i.sent().map((function(e){return e.offer.type===c.OfferType.OneTime&&(0,f.setUserOfferActivationInfoMapInLocalStorage)(e),e.offer})),[3,9];case 7:return[4,(0,l.getEnrichedMerchantOffersMatchingUrlFromAppSync)(n,v)];case 8:M=i.sent(),i.label=9;case 9:return k=M,L=Date.now()-A,[2,{offers:k.map(b),offerQueryIsSignedInCheckDurationInMs:t,offerIdsMatchingDurationInMs:m,hasTriggeredFallbackToAppsync:!0,hasTriggeredAppsyncQueries:!0,appsyncQueriesDurationInMs:L}];case 10:return T=Date.now(),E=S.filter((function(e){var t=e.type;return!v||t!==c.OfferType.OneTime})),x=a([E.filter(l.checkShouldFetchMerchantOfferFromAppSync),E.filter((function(e){return!(0,l.checkShouldFetchMerchantOfferFromAppSync)(e)}))],2),C=x[0],O=x[1],P=Date.now()-T,U=Date.now(),[4,(0,l.getAvailableUserOffersByOfferIdsFromAppSync)(C.slice(0,30).map((function(e){return e.offerId})))];case 11:return _=i.sent(),D=C.length>0,R=D?Date.now()-U:0,F=Date.now(),B=_.map((function(e){return e.offer.type===c.OfferType.OneTime&&(0,f.setUserOfferActivationInfoMapInLocalStorage)(e),e.offer})),W=O.filter(p.checkBasicEligibilityConditions).filter(p.checkIsValidMerchantOfferForExtensions).filter((function(e){return!0===e.visible})),G=s(s([],a(B),!1),a(W),!1).sort((function(e,t){return(0,p.comparePrioritiesOfOffers)(e,t)})),N=Date.now()-F,[2,{offers:G.map(b),offerQueryIsSignedInCheckDurationInMs:t,offerIdsMatchingDurationInMs:m,s3QueriesDurationInMs:I,hasTriggeredFallbackToAppsync:!1,hasTriggeredAppsyncQueries:D,appsyncQueriesDurationInMs:R,offerQueryFirstFilterDurationInMs:P,offerQuerySecondFilterAndSortDurationInMs:N}]}}))}))}function b(e){var t,n,o,i,a,s,c,u,l,d,f,p,h,v,g,b,y,m,w,S,I,A,k,M,L,T,E,x,C,O,P,U,_,D,R,F,B,W,G,N,K,j,q,Q,H,z,V,J,Z,X,Y,$,ee,te,ne,re,oe,ie,ae,se,ce,ue,le,de,fe,pe,he,ve,ge,be,ye,me,we,Se,Ie,Ae,ke,Me,Le,Te,Ee,xe,Ce,Oe,Pe,Ue,_e,De,Re,Fe,Be,We,Ge,Ne,Ke,je,qe,Qe,He,ze,Ve,Je,Ze,Xe,Ye,$e,et,tt,nt,rt,ot,it,at,st,ct,ut,lt,dt,ft,pt,ht,vt,gt,bt,yt,mt,wt,St,It,At,kt,Mt,Lt,Tt,Et,xt,Ct,Ot,Pt,Ut,_t,Dt,Rt,Ft,Bt,Wt,Gt,Nt,Kt,jt,qt,Qt,Ht,zt,Vt,Jt,Zt,Xt,Yt,$t,en,tn,nn,rn,on,an,sn,cn,un,ln,dn,fn,pn,hn,vn,gn,bn,yn,mn,wn,Sn,In,An,kn,Mn,Ln,Tn,En,xn,Cn,On,Pn,Un,_n,Dn,Rn,Fn,Bn,Wn,Gn,Nn,Kn,jn,qn,Qn,Hn,zn,Vn,Jn,Zn,Xn,Yn,$n,er,tr,nr,rr,or,ir,ar,sr,cr,ur,lr,dr,fr,pr,hr,vr,gr,br,yr,mr,wr,Sr,Ir,Ar,kr,Mr,Lr,Tr,Er,xr,Cr,Or,Pr,Ur,_r,Dr,Rr,Fr,Br,Wr,Gr,Nr,Kr,jr,qr,Qr,Hr,zr,Vr,Jr,Zr,Xr,Yr,$r,eo,to,no,ro,oo,io,ao,so,co,uo,lo,fo,po,ho,vo,go,bo,yo,mo,wo,So,Io,Ao,ko,Mo,Lo,To,Eo,xo,Co,Oo,Po;return r(r({},e),{nonBoostedPoints:null!==(t=e.nonBoostedPoints)&&void 0!==t?t:void 0,nonBoostedFixedPoints:null!==(n=e.nonBoostedFixedPoints)&&void 0!==n?n:void 0,card:null!==(f=r(r({},e.card),{title:null!==(i=null===(o=e.card)||void 0===o?void 0:o.title)&&void 0!==i?i:void 0,subtitle:null!==(s=null===(a=e.card)||void 0===a?void 0:a.subtitle)&&void 0!==s?s:void 0,logoURL:null!==(u=null===(c=e.card)||void 0===c?void 0:c.logoURL)&&void 0!==u?u:void 0,bannerURL:null!==(d=null===(l=e.card)||void 0===l?void 0:l.bannerURL)&&void 0!==d?d:void 0}))&&void 0!==f?f:void 0,screen:null!==(S=r(r({},e.screen),{title:null!==(h=null===(p=e.screen)||void 0===p?void 0:p.title)&&void 0!==h?h:void 0,subtitle:null!==(g=null===(v=e.screen)||void 0===v?void 0:v.subtitle)&&void 0!==g?g:void 0,logoURL:null!==(y=null===(b=e.screen)||void 0===b?void 0:b.logoURL)&&void 0!==y?y:void 0,bannerURL:null!==(w=null===(m=e.screen)||void 0===m?void 0:m.bannerURL)&&void 0!==w?w:void 0}))&&void 0!==S?S:void 0,multipleRatesForDisplay:null!==(A=null===(I=e.multipleRatesForDisplay)||void 0===I?void 0:I.map((function(e){var t,n,r,o,i;return{points:null!==(t=e.points)&&void 0!==t?t:void 0,fixedPoints:null!==(n=e.fixedPoints)&&void 0!==n?n:void 0,nonBoostedPoints:null!==(r=e.nonBoostedPoints)&&void 0!==r?r:void 0,nonBoostedFixedPoints:null!==(o=e.nonBoostedFixedPoints)&&void 0!==o?o:void 0,text:null!==(i=e.text)&&void 0!==i?i:void 0}})))&&void 0!==A?A:void 0,oneTimeOfferTrackingLink:null!==(k=e.oneTimeOfferTrackingLink)&&void 0!==k?k:void 0,website:null!==(M=e.website)&&void 0!==M?M:void 0,matchingURLRegexes:null!==(L=e.matchingURLRegexes)&&void 0!==L?L:void 0,browserExtension:null!==(ur=r(r({},e.browserExtension),{active:null!==(E=null===(T=e.browserExtension)||void 0===T?void 0:T.active)&&void 0!==E?E:void 0,desktopVersion:r(r({},null===(x=e.browserExtension)||void 0===x?void 0:x.desktopVersion),{active:null!==(P=null===(O=null===(C=e.browserExtension)||void 0===C?void 0:C.desktopVersion)||void 0===O?void 0:O.active)&&void 0!==P?P:void 0,displayCashbackWidget:null!==(D=null===(_=null===(U=e.browserExtension)||void 0===U?void 0:U.desktopVersion)||void 0===_?void 0:_.displayCashbackWidget)&&void 0!==D?D:void 0,displayGoogleSearchResultEmbeddedInfo:null!==(B=null===(F=null===(R=e.browserExtension)||void 0===R?void 0:R.desktopVersion)||void 0===F?void 0:F.displayGoogleSearchResultEmbeddedInfo)&&void 0!==B?B:void 0,displayCouponsPromotionWidget:null!==(N=null===(G=null===(W=e.browserExtension)||void 0===W?void 0:W.desktopVersion)||void 0===G?void 0:G.displayCouponsPromotionWidget)&&void 0!==N?N:void 0,displayBnplPromotionWidget:null!==(q=null===(j=null===(K=e.browserExtension)||void 0===K?void 0:K.desktopVersion)||void 0===j?void 0:j.displayBnplPromotionWidget)&&void 0!==q?q:void 0,displayAutoCouponCheckoutWidget:null!==(z=null===(H=null===(Q=e.browserExtension)||void 0===Q?void 0:Q.desktopVersion)||void 0===H?void 0:H.displayAutoCouponCheckoutWidget)&&void 0!==z?z:void 0,hideSideButtonOnNonProductPage:null!==(Z=null===(J=null===(V=e.browserExtension)||void 0===V?void 0:V.desktopVersion)||void 0===J?void 0:J.hideSideButtonOnNonProductPage)&&void 0!==Z?Z:void 0,hideSideButtonOnProductPage:null!==($=null===(Y=null===(X=e.browserExtension)||void 0===X?void 0:X.desktopVersion)||void 0===Y?void 0:Y.hideSideButtonOnProductPage)&&void 0!==$?$:void 0,shouldIgnoreAutoCouponCheckoutWidgetHidingRules:null!==(ne=null===(te=null===(ee=e.browserExtension)||void 0===ee?void 0:ee.desktopVersion)||void 0===te?void 0:te.shouldIgnoreAutoCouponCheckoutWidgetHidingRules)&&void 0!==ne?ne:void 0,displayAlternativeOffersWidget:null!==(ie=null===(oe=null===(re=e.browserExtension)||void 0===re?void 0:re.desktopVersion)||void 0===oe?void 0:oe.displayAlternativeOffersWidget)&&void 0!==ie?ie:void 0,displayAlternativeOffersInPanel:null!==(ce=null===(se=null===(ae=e.browserExtension)||void 0===ae?void 0:ae.desktopVersion)||void 0===se?void 0:se.displayAlternativeOffersInPanel)&&void 0!==ce?ce:void 0}),mobileVersion:r(r({},null===(ue=e.browserExtension)||void 0===ue?void 0:ue.mobileVersion),{active:null!==(fe=null===(de=null===(le=e.browserExtension)||void 0===le?void 0:le.mobileVersion)||void 0===de?void 0:de.active)&&void 0!==fe?fe:void 0,displayCashbackWidget:null!==(ve=null===(he=null===(pe=e.browserExtension)||void 0===pe?void 0:pe.mobileVersion)||void 0===he?void 0:he.displayCashbackWidget)&&void 0!==ve?ve:void 0,displayGoogleSearchResultEmbeddedInfo:null!==(ye=null===(be=null===(ge=e.browserExtension)||void 0===ge?void 0:ge.mobileVersion)||void 0===be?void 0:be.displayGoogleSearchResultEmbeddedInfo)&&void 0!==ye?ye:void 0,displayCouponsPromotionWidget:null!==(Se=null===(we=null===(me=e.browserExtension)||void 0===me?void 0:me.mobileVersion)||void 0===we?void 0:we.displayCouponsPromotionWidget)&&void 0!==Se?Se:void 0,displayBnplPromotionWidget:null!==(ke=null===(Ae=null===(Ie=e.browserExtension)||void 0===Ie?void 0:Ie.mobileVersion)||void 0===Ae?void 0:Ae.displayBnplPromotionWidget)&&void 0!==ke?ke:void 0,displayAutoCouponCheckoutWidget:null!==(Te=null===(Le=null===(Me=e.browserExtension)||void 0===Me?void 0:Me.mobileVersion)||void 0===Le?void 0:Le.displayAutoCouponCheckoutWidget)&&void 0!==Te?Te:void 0,hideSideButtonOnNonProductPage:null!==(Ce=null===(xe=null===(Ee=e.browserExtension)||void 0===Ee?void 0:Ee.mobileVersion)||void 0===xe?void 0:xe.hideSideButtonOnNonProductPage)&&void 0!==Ce?Ce:void 0,hideSideButtonOnProductPage:null!==(Ue=null===(Pe=null===(Oe=e.browserExtension)||void 0===Oe?void 0:Oe.mobileVersion)||void 0===Pe?void 0:Pe.hideSideButtonOnProductPage)&&void 0!==Ue?Ue:void 0,shouldIgnoreAutoCouponCheckoutWidgetHidingRules:null!==(Re=null===(De=null===(_e=e.browserExtension)||void 0===_e?void 0:_e.mobileVersion)||void 0===De?void 0:De.shouldIgnoreAutoCouponCheckoutWidgetHidingRules)&&void 0!==Re?Re:void 0,displayAlternativeOffersWidget:null!==(We=null===(Be=null===(Fe=e.browserExtension)||void 0===Fe?void 0:Fe.mobileVersion)||void 0===Be?void 0:Be.displayAlternativeOffersWidget)&&void 0!==We?We:void 0,displayAlternativeOffersInPanel:null!==(Ke=null===(Ne=null===(Ge=e.browserExtension)||void 0===Ge?void 0:Ge.mobileVersion)||void 0===Ne?void 0:Ne.displayAlternativeOffersInPanel)&&void 0!==Ke?Ke:void 0}),displayInExtensionSearch:null!==(qe=null===(je=e.browserExtension)||void 0===je?void 0:je.displayInExtensionSearch)&&void 0!==qe?qe:void 0,coupons:r(r({},null===(Qe=e.browserExtension)||void 0===Qe?void 0:Qe.coupons),{active:null!==(Ve=null===(ze=null===(He=e.browserExtension)||void 0===He?void 0:He.coupons)||void 0===ze?void 0:ze.active)&&void 0!==Ve?Ve:void 0,automationActive:null!==(Xe=null===(Ze=null===(Je=e.browserExtension)||void 0===Je?void 0:Je.coupons)||void 0===Ze?void 0:Ze.automationActive)&&void 0!==Xe?Xe:void 0,loadAffiliateLinkOnAutomation:null!==(et=null===($e=null===(Ye=e.browserExtension)||void 0===Ye?void 0:Ye.coupons)||void 0===$e?void 0:$e.loadAffiliateLinkOnAutomation)&&void 0!==et?et:void 0,selectors:null!==(Tt=r(r({},null===(nt=null===(tt=e.browserExtension)||void 0===tt?void 0:tt.coupons)||void 0===nt?void 0:nt.selectors),{couponField:null!==(at=null===(it=null===(ot=null===(rt=e.browserExtension)||void 0===rt?void 0:rt.coupons)||void 0===ot?void 0:ot.selectors)||void 0===it?void 0:it.couponField)&&void 0!==at?at:void 0,price:null!==(lt=null===(ut=null===(ct=null===(st=e.browserExtension)||void 0===st?void 0:st.coupons)||void 0===ct?void 0:ct.selectors)||void 0===ut?void 0:ut.price)&&void 0!==lt?lt:void 0,validationButton:null!==(ht=null===(pt=null===(ft=null===(dt=e.browserExtension)||void 0===dt?void 0:dt.coupons)||void 0===ft?void 0:ft.selectors)||void 0===pt?void 0:pt.validationButton)&&void 0!==ht?ht:void 0,removalButton:null!==(yt=null===(bt=null===(gt=null===(vt=e.browserExtension)||void 0===vt?void 0:vt.coupons)||void 0===gt?void 0:gt.selectors)||void 0===bt?void 0:bt.removalButton)&&void 0!==yt?yt:void 0,showCouponFieldClickableElement:null!==(It=null===(St=null===(wt=null===(mt=e.browserExtension)||void 0===mt?void 0:mt.coupons)||void 0===wt?void 0:wt.selectors)||void 0===St?void 0:St.showCouponFieldClickableElement)&&void 0!==It?It:void 0,errorMessage:null!==(Lt=null===(Mt=null===(kt=null===(At=e.browserExtension)||void 0===At?void 0:At.coupons)||void 0===kt?void 0:kt.selectors)||void 0===Mt?void 0:Mt.errorMessage)&&void 0!==Lt?Lt:void 0}))&&void 0!==Tt?Tt:void 0,networkRequestsParameters:null!==(nn=r(r({},null===(xt=null===(Et=e.browserExtension)||void 0===Et?void 0:Et.coupons)||void 0===xt?void 0:xt.networkRequestsParameters),{merchantApiEndpointUrl:null===(Pt=null===(Ot=null===(Ct=e.browserExtension)||void 0===Ct?void 0:Ct.coupons)||void 0===Ot?void 0:Ot.networkRequestsParameters)||void 0===Pt?void 0:Pt.merchantApiEndpointUrl,method:null===(Dt=null===(_t=null===(Ut=e.browserExtension)||void 0===Ut?void 0:Ut.coupons)||void 0===_t?void 0:_t.networkRequestsParameters)||void 0===Dt?void 0:Dt.method,requestContentType:null!==(Wt=null===(Bt=null===(Ft=null===(Rt=e.browserExtension)||void 0===Rt?void 0:Rt.coupons)||void 0===Ft?void 0:Ft.networkRequestsParameters)||void 0===Bt?void 0:Bt.requestContentType)&&void 0!==Wt?Wt:void 0,additionalHeaders:null!==(jt=null===(Kt=null===(Nt=null===(Gt=e.browserExtension)||void 0===Gt?void 0:Gt.coupons)||void 0===Nt?void 0:Nt.networkRequestsParameters)||void 0===Kt?void 0:Kt.additionalHeaders)&&void 0!==jt?jt:void 0,requestBodyFormatter:null!==(zt=null===(Ht=null===(Qt=null===(qt=e.browserExtension)||void 0===qt?void 0:qt.coupons)||void 0===Qt?void 0:Qt.networkRequestsParameters)||void 0===Ht?void 0:Ht.requestBodyFormatter)&&void 0!==zt?zt:void 0,requestUrlParametersFormatter:null!==(Xt=null===(Zt=null===(Jt=null===(Vt=e.browserExtension)||void 0===Vt?void 0:Vt.coupons)||void 0===Jt?void 0:Jt.networkRequestsParameters)||void 0===Zt?void 0:Zt.requestUrlParametersFormatter)&&void 0!==Xt?Xt:void 0,responseParser:null!==(tn=null===(en=null===($t=null===(Yt=e.browserExtension)||void 0===Yt?void 0:Yt.coupons)||void 0===$t?void 0:$t.networkRequestsParameters)||void 0===en?void 0:en.responseParser)&&void 0!==tn?tn:void 0}))&&void 0!==nn?nn:void 0,customDelayBetweenApplicationsInMs:null!==(an=null===(on=null===(rn=e.browserExtension)||void 0===rn?void 0:rn.coupons)||void 0===on?void 0:on.customDelayBetweenApplicationsInMs)&&void 0!==an?an:void 0}),bnpl:r(r({},null===(sn=e.browserExtension)||void 0===sn?void 0:sn.bnpl),{active:null!==(ln=null===(un=null===(cn=e.browserExtension)||void 0===cn?void 0:cn.bnpl)||void 0===un?void 0:un.active)&&void 0!==ln?ln:void 0}),trackingConsent:r(r({},null!==(fn=null===(dn=e.browserExtension)||void 0===dn?void 0:dn.trackingConsent)&&void 0!==fn?fn:void 0),{disableTrackingConsentBannerFlow:null!==(vn=null===(hn=null===(pn=e.browserExtension)||void 0===pn?void 0:pn.trackingConsent)||void 0===hn?void 0:hn.disableTrackingConsentBannerFlow)&&void 0!==vn?vn:void 0,cmpId:null!==(yn=null===(bn=null===(gn=e.browserExtension)||void 0===gn?void 0:gn.trackingConsent)||void 0===bn?void 0:bn.cmpId)&&void 0!==yn?yn:void 0,trackingConsentRelatedCookieOrLocalStorageIds:null!==(Sn=null===(wn=null===(mn=e.browserExtension)||void 0===mn?void 0:mn.trackingConsent)||void 0===wn?void 0:wn.trackingConsentRelatedCookieOrLocalStorageIds)&&void 0!==Sn?Sn:void 0,isTrackingConsentDataInLocalStorageInsteadOfCookies:null!==(kn=null===(An=null===(In=e.browserExtension)||void 0===In?void 0:In.trackingConsent)||void 0===An?void 0:An.isTrackingConsentDataInLocalStorageInsteadOfCookies)&&void 0!==kn?kn:void 0,selectors:null!==(Rn=r(r({},null===(Ln=null===(Mn=e.browserExtension)||void 0===Mn?void 0:Mn.trackingConsent)||void 0===Ln?void 0:Ln.selectors),{acceptAllButton:null===(xn=null===(En=null===(Tn=e.browserExtension)||void 0===Tn?void 0:Tn.trackingConsent)||void 0===En?void 0:En.selectors)||void 0===xn?void 0:xn.acceptAllButton,rejectAllButton:null===(Pn=null===(On=null===(Cn=e.browserExtension)||void 0===Cn?void 0:Cn.trackingConsent)||void 0===On?void 0:On.selectors)||void 0===Pn?void 0:Pn.rejectAllButton,customChoiceButton:null===(Dn=null===(_n=null===(Un=e.browserExtension)||void 0===Un?void 0:Un.trackingConsent)||void 0===_n?void 0:_n.selectors)||void 0===Dn?void 0:Dn.customChoiceButton}))&&void 0!==Rn?Rn:void 0}),affiliateLinkLoading:r(r({},null!==(Bn=null===(Fn=e.browserExtension)||void 0===Fn?void 0:Fn.affiliateLinkLoading)&&void 0!==Bn?Bn:void 0),{offerActivationInteractionsWithBackgroundAffiliateLinkLoadingOverride:null!==(Nn=null===(Gn=null===(Wn=e.browserExtension)||void 0===Wn?void 0:Wn.affiliateLinkLoading)||void 0===Gn?void 0:Gn.offerActivationInteractionsWithBackgroundAffiliateLinkLoadingOverride)&&void 0!==Nn?Nn:void 0,shouldDisplayOfferActivationInterstitialForBackgroundAffiliateLinkLoadingOverride:null!==(qn=null===(jn=null===(Kn=e.browserExtension)||void 0===Kn?void 0:Kn.affiliateLinkLoading)||void 0===jn?void 0:jn.shouldDisplayOfferActivationInterstitialForBackgroundAffiliateLinkLoadingOverride)&&void 0!==qn?qn:void 0,userStateConditionForOfferActivationBackgroundAffiliateLinkLoadingOverride:null!==(zn=null===(Hn=null===(Qn=e.browserExtension)||void 0===Qn?void 0:Qn.affiliateLinkLoading)||void 0===Hn?void 0:Hn.userStateConditionForOfferActivationBackgroundAffiliateLinkLoadingOverride)&&void 0!==zn?zn:void 0,enableAffiliateTrackingForBnplFlowLaunchOverride:null!==(Zn=null===(Jn=null===(Vn=e.browserExtension)||void 0===Vn?void 0:Vn.affiliateLinkLoading)||void 0===Jn?void 0:Jn.enableAffiliateTrackingForBnplFlowLaunchOverride)&&void 0!==Zn?Zn:void 0,enableAffiliateTrackingForAutoCouponApplicationStartOverride:null!==($n=null===(Yn=null===(Xn=e.browserExtension)||void 0===Xn?void 0:Xn.affiliateLinkLoading)||void 0===Yn?void 0:Yn.enableAffiliateTrackingForAutoCouponApplicationStartOverride)&&void 0!==$n?$n:void 0,enableAffiliateTrackingForPriceComparisonOverride:null!==(nr=null===(tr=null===(er=e.browserExtension)||void 0===er?void 0:er.affiliateLinkLoading)||void 0===tr?void 0:tr.enableAffiliateTrackingForPriceComparisonOverride)&&void 0!==nr?nr:void 0,enableAffiliateTrackingForProductSavingOverride:null!==(ir=null===(or=null===(rr=e.browserExtension)||void 0===rr?void 0:rr.affiliateLinkLoading)||void 0===or?void 0:or.enableAffiliateTrackingForProductSavingOverride)&&void 0!==ir?ir:void 0,enableAffiliateTrackingForCouponCodeCopyOverride:null!==(cr=null===(sr=null===(ar=e.browserExtension)||void 0===ar?void 0:ar.affiliateLinkLoading)||void 0===sr?void 0:sr.enableAffiliateTrackingForCouponCodeCopyOverride)&&void 0!==cr?cr:void 0})}))&&void 0!==ur?ur:void 0,mobileApp:null!==(Io=r(r({},e.mobileApp),{coupons:null!==(So=r(r({},null===(lr=e.mobileApp)||void 0===lr?void 0:lr.coupons),{active:null!==(pr=null===(fr=null===(dr=e.mobileApp)||void 0===dr?void 0:dr.coupons)||void 0===fr?void 0:fr.active)&&void 0!==pr?pr:void 0,automationActive:null!==(gr=null===(vr=null===(hr=e.mobileApp)||void 0===hr?void 0:hr.coupons)||void 0===vr?void 0:vr.automationActive)&&void 0!==gr?gr:void 0,selectors:null!==(jr=r(r({},null===(yr=null===(br=e.mobileApp)||void 0===br?void 0:br.coupons)||void 0===yr?void 0:yr.selectors),{couponField:null!==(Ir=null===(Sr=null===(wr=null===(mr=e.mobileApp)||void 0===mr?void 0:mr.coupons)||void 0===wr?void 0:wr.selectors)||void 0===Sr?void 0:Sr.couponField)&&void 0!==Ir?Ir:void 0,price:null!==(Lr=null===(Mr=null===(kr=null===(Ar=e.mobileApp)||void 0===Ar?void 0:Ar.coupons)||void 0===kr?void 0:kr.selectors)||void 0===Mr?void 0:Mr.price)&&void 0!==Lr?Lr:void 0,validationButton:null!==(Cr=null===(xr=null===(Er=null===(Tr=e.mobileApp)||void 0===Tr?void 0:Tr.coupons)||void 0===Er?void 0:Er.selectors)||void 0===xr?void 0:xr.validationButton)&&void 0!==Cr?Cr:void 0,removalButton:null!==(_r=null===(Ur=null===(Pr=null===(Or=e.mobileApp)||void 0===Or?void 0:Or.coupons)||void 0===Pr?void 0:Pr.selectors)||void 0===Ur?void 0:Ur.removalButton)&&void 0!==_r?_r:void 0,showCouponFieldClickableElement:null!==(Br=null===(Fr=null===(Rr=null===(Dr=e.mobileApp)||void 0===Dr?void 0:Dr.coupons)||void 0===Rr?void 0:Rr.selectors)||void 0===Fr?void 0:Fr.showCouponFieldClickableElement)&&void 0!==Br?Br:void 0,errorMessage:null!==(Kr=null===(Nr=null===(Gr=null===(Wr=e.mobileApp)||void 0===Wr?void 0:Wr.coupons)||void 0===Gr?void 0:Gr.selectors)||void 0===Nr?void 0:Nr.errorMessage)&&void 0!==Kr?Kr:void 0}))&&void 0!==jr?jr:void 0,networkRequestsParameters:null!==(bo=r(r({},null===(Qr=null===(qr=e.mobileApp)||void 0===qr?void 0:qr.coupons)||void 0===Qr?void 0:Qr.networkRequestsParameters),{merchantApiEndpointUrl:null!==(Jr=null===(Vr=null===(zr=null===(Hr=e.mobileApp)||void 0===Hr?void 0:Hr.coupons)||void 0===zr?void 0:zr.networkRequestsParameters)||void 0===Vr?void 0:Vr.merchantApiEndpointUrl)&&void 0!==Jr?Jr:void 0,requestContentType:null!==($r=null===(Yr=null===(Xr=null===(Zr=e.mobileApp)||void 0===Zr?void 0:Zr.coupons)||void 0===Xr?void 0:Xr.networkRequestsParameters)||void 0===Yr?void 0:Yr.requestContentType)&&void 0!==$r?$r:void 0,additionalHeaders:null!==(ro=null===(no=null===(to=null===(eo=e.mobileApp)||void 0===eo?void 0:eo.coupons)||void 0===to?void 0:to.networkRequestsParameters)||void 0===no?void 0:no.additionalHeaders)&&void 0!==ro?ro:void 0,requestBodyFormatter:null!==(so=null===(ao=null===(io=null===(oo=e.mobileApp)||void 0===oo?void 0:oo.coupons)||void 0===io?void 0:io.networkRequestsParameters)||void 0===ao?void 0:ao.requestBodyFormatter)&&void 0!==so?so:void 0,requestUrlParametersFormatter:null!==(fo=null===(lo=null===(uo=null===(co=e.mobileApp)||void 0===co?void 0:co.coupons)||void 0===uo?void 0:uo.networkRequestsParameters)||void 0===lo?void 0:lo.requestUrlParametersFormatter)&&void 0!==fo?fo:void 0,responseParser:null!==(go=null===(vo=null===(ho=null===(po=e.mobileApp)||void 0===po?void 0:po.coupons)||void 0===ho?void 0:ho.networkRequestsParameters)||void 0===vo?void 0:vo.responseParser)&&void 0!==go?go:void 0}))&&void 0!==bo?bo:void 0,customDelayBetweenApplicationsInMs:null!==(wo=null===(mo=null===(yo=e.mobileApp)||void 0===yo?void 0:yo.coupons)||void 0===mo?void 0:mo.customDelayBetweenApplicationsInMs)&&void 0!==wo?wo:void 0}))&&void 0!==So?So:void 0}))&&void 0!==Io?Io:void 0,affiliatePlatformId:null!==(Ao=e.affiliatePlatformId)&&void 0!==Ao?Ao:void 0,matchToAffiliateTransaction:null!==(ko=e.matchToAffiliateTransaction)&&void 0!==ko?ko:void 0,alternativeOffersIds:null!==(Mo=e.alternativeOffersIds)&&void 0!==Mo?Mo:void 0,alternativeOffersDescription:null!==(Lo=e.alternativeOffersDescription)&&void 0!==Lo?Lo:void 0,enrichedConditions:null!==(To=e.enrichedConditions)&&void 0!==To?To:void 0,displayedAmountOfCashbackEarnedByUsers:null!==(Eo=e.displayedAmountOfCashbackEarnedByUsers)&&void 0!==Eo?Eo:void 0,displayedAmountSavedByUsersUsingAutoCoupons:null!==(xo=e.displayedAmountSavedByUsersUsingAutoCoupons)&&void 0!==xo?xo:void 0,totalAmountSavedByUsersUsingAutoCoupons:null!==(Co=e.totalAmountSavedByUsersUsingAutoCoupons)&&void 0!==Co?Co:void 0,displayedSuccessRateAutoCoupons:null!==(Oo=e.displayedSuccessRateAutoCoupons)&&void 0!==Oo?Oo:void 0,lastUsedAtAutoCoupons:null!==(Po=e.lastUsedAtAutoCoupons)&&void 0!==Po?Po:void 0})}t.handleGetMerchantOfferMatchingUrlWithConditionsAndCouponsMessage=function(e,t){var n;return o(this,void 0,void 0,(function(){var r;return i(this,(function(o){switch(o.label){case 0:return(null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.url)?[4,v(e.data.url)]:(t({offer:void 0}),[2]);case 1:return r=o.sent(),t({offer:r}),[2]}}))}))},t.handleGetMerchantOffersWithConditionsAndCouponsFromOfferIdsMessage=function(e,t){var n;return o(this,void 0,void 0,(function(){var r;return i(this,(function(o){switch(o.label){case 0:return(null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.offerIds)?[4,g({offerIds:e.data.offerIds})]:(t({offers:void 0}),[2]);case 1:return r=o.sent().offers,t({offers:r}),[2]}}))}))},t.handleGetMerchantOfferWithConditionsAndCouponsFromS3Message=function(e,t){var n;return o(this,void 0,void 0,(function(){var r,o;return i(this,(function(i){switch(i.label){case 0:return(null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.offerId)?[4,(0,d.getThrottledMerchantOffersWithConditionsAndCouponsFromS3)([e.data.offerId])]:(t({offer:void 0}),[2]);case 1:return r=a.apply(void 0,[i.sent(),1]),o=r[0],t({offer:o}),[2]}}))}))},t.getMerchantOfferMatchingUrlWithConditionsAndCoupons=v,t.getMerchantOffersWithConditionsAndCouponsMatchingUrlOrOfferIds=g},47430:function(e,t){var n=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.enrichMerchantOfferCoupons=void 0,t.enrichMerchantOfferCoupons=function(e,t){var r,o;if(!(null==t?void 0:t.length))return e;e.browserExtension||(e.browserExtension={}),e.browserExtension.coupons||(e.browserExtension.coupons={}),e.browserExtension.coupons.itemList=[];try{for(var i=n(t),a=i.next();!a.done;a=i.next()){var s=a.value;e.browserExtension.coupons.itemList.push(s)}}catch(e){r={error:e}}finally{try{a&&!a.done&&(o=i.return)&&o.call(i)}finally{if(r)throw r.error}}return e}},13922:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},i=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},a=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},s=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.handleUpdateMerchantOfferLastUsedAtAutoCoupons=t.handleGetMerchantOfferLastUsedAtAutoCouponsFromAppSync=t.getThrottledMerchantOffersWithConditionsAndCouponsFromS3=void 0;var c=n(58029),u=n(47248),l=n(45133),d=n(50384),f=n(45607),p=n(59548),h=n(93795),v=n(51635),g=n(47430),b=n(94925),y=n(87626),m=n(16206),w={};t.getThrottledMerchantOffersWithConditionsAndCouponsFromS3=function(e){return r(this,void 0,void 0,(function(){var t,n,r,c,u,l,d,f,p,h,v,g,b,y;return o(this,(function(o){switch(o.label){case 0:return 0===e.length?[2,[]]:(t=[],n=[],[4,I()]);case 1:r=o.sent();try{for(c=i(e),u=c.next();!u.done;u=c.next())l=u.value,w[l]&&Date.now()-w[l].lastRefreshTimestampMs<r?t.push(w[l].merchantOfferWithConditionsAndCoupons):n.push(l)}catch(e){v={error:e}}finally{try{u&&!u.done&&(g=c.return)&&g.call(c)}finally{if(v)throw v.error}}return 0===n.length?[2,t]:[4,M(n)];case 2:d=o.sent();try{for(f=i(d),p=f.next();!p.done;p=f.next())h=p.value,w[h.offerId]={lastRefreshTimestampMs:Date.now(),merchantOfferWithConditionsAndCoupons:h}}catch(e){b={error:e}}finally{try{p&&!p.done&&(y=f.return)&&y.call(f)}finally{if(b)throw b.error}}return[2,s(s([],a(t),!1),a(d),!1)]}}))}))};var S=1;function I(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,(0,m.getSetting)(u.SettingKey.merchantOffersFromS3RefreshCooldownInHoursForExtensions)];case 1:return e=t.sent(),[2,60*((0,m.parseSetting)(e)||S)*60*1e3]}}))}))}var A=6e4,k={};function M(e){if(0===e.length)return Promise.resolve([]);var t=e.join(""),n=function(e){var t;return(null===(t=k[e])||void 0===t?void 0:t.promise)?Date.now()-k[e].timestampInMs>A?void 0:k[e].promise:void 0}(t);if(n)return n;var i=function(e){return r(this,void 0,void 0,(function(){var t,n,r,i,s,u,d,f,y;return o(this,(function(o){switch(o.label){case 0:return[4,Promise.all([(0,v.getThrottledUserRegion)(),(0,l.getAwsAccountId)(),(0,h.checkHasFeature)(c.Feature.useNewOfferConditionStyleInExtensions)])];case 1:if(t=a.apply(void 0,[o.sent(),3]),n=t[0],r=t[1],i=t[2],!n)throw new Error("Region could not be found");return s=function(e){return!!e},[4,Promise.all(e.map((function(e){return(0,p.fetchMerchantOfferFromS3)({userRegion:n,offerId:e,awsAccountId:r})})))];case 2:return u=o.sent().filter(s),[4,(0,b.enrichMerchantOffersConditions)(u,n,r,i)];case 3:return d=o.sent(),f=Array.from(new Set(d.map((function(e){return e.merchantId})))),y={},[4,Promise.all(f.map((function(e){return(0,p.fetchMerchantCouponsFromS3)(n,e).then((function(t){y[e]=t})).catch((function(t){y[e]=[]}))})))];case 4:return o.sent(),[2,d.map((function(e){return y&&e.merchantId&&y[e.merchantId]?(0,g.enrichMerchantOfferCoupons)(e,y[e.merchantId]):e}))]}}))}))}(e);return k[t]={timestampInMs:Date.now(),promise:i},i}t.handleGetMerchantOfferLastUsedAtAutoCouponsFromAppSync=function(e,t){var n;return r(this,void 0,void 0,(function(){var r,i;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,3,,4]),[4,(0,l.getClient)()];case 1:return[4,o.sent().query({query:f.merchantOfferLastUsedAtAutoCouponsQuery,variables:{offerId:e.data.offerId},fetchPolicy:"no-cache"})];case 2:return r=o.sent(),t({lastUsedAtAutoCoupons:null===(n=null==r?void 0:r.data.offer)||void 0===n?void 0:n.lastUsedAtAutoCoupons}),[3,4];case 3:return i=o.sent(),console.error("GraphQL: error while fetching merchant offer auto coupons widget last used at value",i),(0,y.captureSentryException)(i),t({lastUsedAtAutoCoupons:void 0}),[3,4];case 4:return[2]}}))}))},t.handleUpdateMerchantOfferLastUsedAtAutoCoupons=function(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),[4,(0,l.getClient)()];case 1:return[4,n.sent().mutate({mutation:d.updateMerchantOfferLastUsedAtAutoCouponsMutation,variables:{offerId:e.data.offerId,lastUsedAtAutoCouponsTimestampInSeconds:e.data.lastUsedAtAutoCouponsTimestampInSeconds}})];case 2:return n.sent(),[3,4];case 3:return t=n.sent(),console.error("GraphQL: error while updating merchant offer auto coupons widget last used at value",t),(0,y.captureSentryException)(t),[3,4];case 4:return[2]}}))}))}},56315:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleActivateOnetimeOfferMessage=t.setUserOfferActivationInfoMapInLocalStorage=t.getUserOfferActivationInfo=t.handleGetUserOfferActivationInfoMessage=void 0;var i=n(45133),a=n(34423),s=n(2727),c=n(32495),u=n(57419),l=n(22641),d=n(56979),f=n(87626);function p(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return e?[4,(0,c.getLocalStorageItem)(c.LocalStorageKey.userOfferActivationInfoMap)]:[2,void 0];case 1:return(t=n.sent())&&"object"==typeof t?[2,t[e]]:[2,void 0]}}))}))}function h(e,t){return r(this,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return[4,(0,i.getClient)()];case 1:return[4,n.sent().mutate({mutation:s.activateUserOfferMutation,fetchPolicy:"no-cache",variables:{offerId:e,autoActivationMethod:t,shouldNotLogUserEvent:!0}})];case 2:return n.sent(),[2]}}))}))}t.handleGetUserOfferActivationInfoMessage=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,p(e.data.offerId)];case 1:return n=r.sent(),t({userOfferActivationInfo:n}),[2]}}))}))},t.getUserOfferActivationInfo=p,t.setUserOfferActivationInfoMapInLocalStorage=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return e?(t=e.offer.offerId,[4,(0,c.getLocalStorageItem)(c.LocalStorageKey.userOfferActivationInfoMap)]):[2];case 1:return(n=r.sent())||(n={}),n[t]={activatedAt:e.activatedAt,active:e.active},[4,(0,c.setLocalStorageItem)(c.LocalStorageKey.userOfferActivationInfoMap,n)];case 2:return r.sent(),[2]}}))}))},t.handleActivateOnetimeOfferMessage=function(e){var t;return r(this,void 0,void 0,(function(){var n,r,i,s,c,p,v;return o(this,(function(o){switch(o.label){case 0:if(!(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.offerId))return[2];o.label=1;case 1:return o.trys.push([1,5,,6]),n=e.data,r=n.offerId,i=n.autoActivationMethod,s=n.from,[4,(0,d.runThrottledEnrichedUserOfferAppSyncQuery)(r)];case 2:return(c=o.sent())&&!1===c.active?[4,h(r,i)]:[3,4];case 3:o.sent(),p={type:a.OfferType.OneTime,offerId:r,autoActivationMethod:i,from:s},(0,l.logUserEventUtil)({type:"activatedOffer",payload:p}),(0,u.sendAmplitudeEvent)({type:"Offers - Activated Offer",properties:p}),o.label=4;case 4:return[3,6];case 5:return v=o.sent(),console.log(v),(0,f.captureSentryException)(v),[3,6];case 6:return[2]}}))}))}},53556:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleGetOffersByTagsMessage=t.sortOfferBrowsingTags=t.fetchOfferBrowsingTags=void 0;var i=n(58029),a=n(45133),s=n(21304),c=n(87793),u=n(37052),l=n(93795),d=n(87626);function f(e,t,n){return r(this,void 0,void 0,(function(){var r,c;return o(this,(function(o){switch(o.label){case 0:return r=n?n.sort().join(","):t?t.sort().join(","):e||"",[4,(0,l.checkHasFeature)(i.Feature.useNewOfferConditionStyleInExtensions)];case 1:return c=o.sent(),[2,(0,u.runThrottledQuery)({queryType:u.ThrottledQueryType.enrichedUserOffersQuery,querySignature:r,runQuery:function(){return function(e,t,n,r){return(0,a.getClient)().then((function(o){return o.query({query:s.enrichedUserOffersQuery,variables:{internalTagIds:n||void 0,browsingTagIds:t||void 0,browsingTagId:n||t?void 0:e,maxNumberOfItems:p,shouldUseNewConditions:r},fetchPolicy:"no-cache"})})).catch((function(e){console.error("GraphQL: error while fetching enriched user offers by tag ids",e),(0,d.captureSentryException)(e)})).then((function(e){var t,n;return null===(n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.user)||void 0===n?void 0:n.enrichedOffers}))}(e,t,n,c)}})]}}))}))}t.fetchOfferBrowsingTags=function(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,e.query({query:c.offerBrowsingTagsQuery,variables:{shouldReturnChildrenTags:!0},fetchPolicy:"no-cache"}).catch((function(e){console.error("GraphQL: error while fetching offer browsing tags",e),(0,d.captureSentryException)(e)}))];case 1:return[2,null==(t=n.sent())?void 0:t.data.offerBrowsingTags.items]}}))}))},t.sortOfferBrowsingTags=function(e){return e.sort((function(e,t){return t.score-e.score}))},t.handleGetOffersByTagsMessage=function(e,t){var n;return r(this,void 0,void 0,(function(){var r;return o(this,(function(o){switch(o.label){case 0:return[4,f(e.data.parentTagId,e.data.browsingTagIds,e.data.internalTagIds)];case 1:return r=o.sent(),t({offers:null!==(n=null==r?void 0:r.map((function(e){return e.offer})))&&void 0!==n?n:[]}),[2]}}))}))};var p=72},81771:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},i=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.fetchAverageDaysInPendingFormattingSettings=t.replaceValuesInTemplateAndValidateFormat=void 0;var a=n(89614),s=n(47248),c=n(87626),u=n(16206),l=["averageDaysInPending"];t.replaceValuesInTemplateAndValidateFormat=function(e,t,n){var r,o,a=function(e){if(!e)return[];var t,n=[];for(;null!==(t=d.exec(e));)n.push(t[1]);return n}(e),s=e;try{for(var c=i(a),u=c.next();!u.done;u=c.next()){var h=u.value;if(!(t[h]&&t.region&&l.includes(h)&&p[h]))return{resolvedTextTemplate:s,isValidFormat:!1};s=f(e,h,p[h](t[h],t.region,n))}}catch(e){r={error:e}}finally{try{u&&!u.done&&(o=c.return)&&o.call(c)}finally{if(r)throw r.error}}var v=!(s.includes("{")||s.includes("}"));return{resolvedTextTemplate:s,isValidFormat:v}};var d=/{{(\w+)}}/g;function f(e,t,n){var r=new RegExp("{{".concat(t,"}}"),"g");return e.replace(r,n)}var p={averageDaysInPending:function(e,t,n){var r=n.averageDaysInPendingFormattingSettings,o=r.daysCutoffInDays,i=r.weeksCutoffInDays,s=(0,a.getLocalizedFormat)(t).dateAndTime;if(e<=o)return"".concat(e," ").concat(s.day(e));if(e<=i){var c=Math.ceil(e/7);return"".concat(c," ").concat(s.week(c))}var u=Math.ceil(e/30);return"".concat(u," ").concat(s.month(u))}};var h={daysCutoffInDays:20,weeksCutoffInDays:55};t.fetchAverageDaysInPendingFormattingSettings=function(){return r(this,void 0,void 0,(function(){var e,t,n;return o(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),t=u.parseSetting,[4,(0,u.getSetting)(s.SettingKey.averageDaysInPendingFormat)];case 1:return function(e){return!!(e&&e instanceof Object&&"daysCutoffInDays"in e&&"weeksCutoffInDays"in e)}(e=t.apply(void 0,[r.sent()]))?[2,e]:[3,3];case 2:return n=r.sent(),console.error("Invalid averageDaysInPending setting:",n),(0,c.captureSentryException)(n),[3,3];case 3:return[2,h]}}))}))}},94925:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},c=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},u=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},l=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};Object.defineProperty(t,"__esModule",{value:!0}),t.enrichMerchantOffersConditions=void 0;var d=a(n(2543)),f=n(34423),p=n(3896),h=n(59548),v=n(37052),g=n(81771),b=[y({summary:"Achetez via le bouton ci-dessous",description:'Il faut acheter sur le site du marchand via le bouton "J\'en profite" ci-dessous',conditionId:"affiliate-link"}),y({summary:"Payez avec votre carte bancaire",description:"Il faut payer avec le moyen de paiement que vous avez connecté à Joko",conditionId:"card-linked"})];function y(e){return r({iconUrl:"",priority:0,type:"",region:"",descriptionTemplate:""},e)}t.enrichMerchantOffersConditions=function(e,t,n,o){return s(this,void 0,void 0,(function(){var i,a,s,h;return c(this,(function(c){switch(c.label){case 0:return o?[4,w({awsAccountId:n,userRegion:t})]:[3,2];case 1:return a=c.sent(),[3,3];case 2:a=b,c.label=3;case 3:return i=a,!o||function(e,t){var n=new Set(null==e?void 0:e.map((function(e){return e.conditionId})).filter(Boolean)),r=d.flatten(t.map((function(e){var t;return(null===(t=e.conditions)||void 0===t?void 0:t.specificConditionIdsDescriptions)||[]}))).map((function(e){return e.conditionId}));return r.every((function(e){return e&&n.has(e)}))}(i,e)?[3,5]:[4,w({awsAccountId:n,userRegion:t,shouldForceRefresh:!0})];case 4:i=c.sent(),c.label=5;case 5:return s=d.keyBy(i,"conditionId"),[4,(0,g.fetchAverageDaysInPendingFormattingSettings)()];case 6:return h=c.sent(),[2,e.map((function(e){return function(e,t,n,o){var i,a,s,c,h=r({},e),v=e.conditions;if(!v)return h;var b={conditions:[],transactionEligibility:null};if(n)b.conditions=function(e,t,n){var o,i,a=e.conditions||{},s=a.specificConditionIdsDescriptions,c=a.disabledStandardConditionIds,h=d.keyBy(s,"conditionId"),v=[],b=new Set(c);try{for(var y=u(Object.entries(t)),m=y.next();!m.done;m=y.next()){var w=l(m.value,2),S=w[0],I=w[1];if(I.type&&I.iconUrl&&0!==I.iconUrl.length&&I.region===e.region&&!b.has(S))if(e.type===f.OfferType.OneTime&&I.type===p.OfferConditionType.standardCardLinked||e.type===f.OfferType.Online&&I.type===p.OfferConditionType.standardOnline)v.push(I);else{var A=(h[S]||{}).description;if(h&&S in h&&I.type===p.OfferConditionType.offerSpecific){var k="";if(I.descriptionTemplate&&h[S].shouldUseDescriptionTemplate){var M=(0,g.replaceValuesInTemplateAndValidateFormat)(I.descriptionTemplate,e,n),L=M.resolvedTextTemplate;M.isValidFormat&&(k=L)}else A&&(k=A);k||(k=I.description||""),v.push(r(r({},I),{description:k}))}}}}catch(e){o={error:e}}finally{try{m&&!m.done&&(i=y.return)&&i.call(y)}finally{if(o)throw o.error}}return v}(e,t,o);else{if(v.customConditions)try{for(var m=u(v.customConditions),w=m.next();!w.done;w=m.next()){var S=w.value;S.summary&&S.description&&b.conditions.push(y({conditionId:"",summary:S.summary,description:S.description}))}}catch(e){i={error:e}}finally{try{w&&!w.done&&(a=m.return)&&a.call(m)}finally{if(i)throw i.error}}if(v.standardConditionIds)try{for(var I=u(v.standardConditionIds),A=I.next();!A.done;A=I.next()){var k=A.value;void 0!==t[k]&&b.conditions.push(y({conditionId:"",summary:t[k].summary,description:t[k].description}))}}catch(e){s={error:e}}finally{try{A&&!A.done&&(c=I.return)&&c.call(I)}finally{if(s)throw s.error}}}return h.enrichedConditions=b,h}(e,s,o,{averageDaysInPendingFormattingSettings:h})}))]}}))}))};var m=108e5;function w(e){var t=e.awsAccountId,n=e.userRegion,r=e.shouldForceRefresh?0:m;return(0,v.runThrottledQuery)({queryType:v.ThrottledQueryType.merchantOfferConditionsFromS3Query,querySignature:n,runQuery:function(){return(0,h.fetchMerchantOfferConditionsFromS3)({awsAccountId:t,userRegion:n})},throttlingDelayInMs:r})}},76387:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleSearchOffersMessage=void 0;var i=n(58029),a=n(45133),s=n(21304),c=n(37052),u=n(93795),l=n(87626);function d(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,(0,u.checkHasFeature)(i.Feature.useNewOfferConditionStyleInExtensions)];case 1:return t=n.sent(),[2,(0,c.runThrottledQuery)({queryType:c.ThrottledQueryType.searchEnrichedUserOffersQuery,querySignature:e,runQuery:function(){return function(e,t){return(0,a.getClient)().then((function(n){return n.query({query:s.searchEnrichedUserOffersQuery,variables:{searchQuery:e,field:"screen.title",shouldUseNewConditions:t},fetchPolicy:"no-cache"})})).catch((function(e){console.error("GraphQL: error while fetching search enriched user offers by title",e),(0,l.captureSentryException)(e)})).then((function(e){var t,n,r;return null===(r=null===(n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.user)||void 0===n?void 0:n.searchEnrichedOffers)||void 0===r?void 0:r.items}))}(e,t)}})]}}))}))}t.handleSearchOffersMessage=function(e,t){var n;return r(this,void 0,void 0,(function(){var r;return o(this,(function(o){switch(o.label){case 0:return[4,d(e.data.searchQuery)];case 1:return r=o.sent(),t({offers:null!==(n=null==r?void 0:r.map((function(e){return e.offer})))&&void 0!==n?n:[]}),[2]}}))}))}},13158:function(e,t,n){var r=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},o=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.comparePrioritiesOfOffers=t.checkBasicEligibilityConditions=t.checkIsValidMerchantOfferForExtensions=void 0;var i=n(34423),a=n(52151);function s(e){var t,n,r=e.multipleRatesForDisplay,i=e.points,a=e.fixedPoints,s=0;if(r){var c=r.filter((function(e){return(e.points||e.fixedPoints)&&e.text}));try{for(var u=o(c),l=u.next();!l.done;l=u.next()){var d=l.value;s=Math.max(s,d.points||d.fixedPoints||0)}}catch(e){t={error:e}}finally{try{l&&!l.done&&(n=u.return)&&n.call(u)}finally{if(t)throw t.error}}}return s||(s=i||a||0),s}t.checkIsValidMerchantOfferForExtensions=function(e){return!!e.browserExtension&&(a.isMobileExtension?e.browserExtension.mobileVersion?!!e.browserExtension.mobileVersion.active:!!e.browserExtension.active:e.browserExtension.desktopVersion?!!e.browserExtension.desktopVersion.active:!!e.browserExtension.active)},t.checkBasicEligibilityConditions=function(e){var t;return!(null===(t=e.conditions)||void 0===t?void 0:t.transactionEligibility)||!(e.conditions.transactionEligibility.dateMin&&Date.now()<new Date(e.conditions.transactionEligibility.dateMin).getTime())&&!(e.conditions.transactionEligibility.dateMax&&Date.now()>new Date(e.conditions.transactionEligibility.dateMax).getTime()+864e5-1e3)},t.comparePrioritiesOfOffers=function(e,t){var n=r([e.type,t.type],2),o=n[0];return o!==n[1]?o===i.OfferType.Online?-1:1:s(t)-s(e)}},13469:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.getOfferIdsMatchingUrl=void 0;var i=n(59548),a=n(51635);t.getOfferIdsMatchingUrl=function(e){return r(this,void 0,void 0,(function(){var t,n,r;return o(this,(function(o){switch(o.label){case 0:return e?[4,(0,a.getThrottledUserRegion)()]:[2,[]];case 1:return(t=o.sent())?[4,(0,i.runThrottledMatchingUrlRegExpsFromS3Query)(t)]:[2,[]];case 2:return(n=o.sent())?(r=n.filter((function(t){var n=t.matchingURLRegexes;return null==n?void 0:n.some((function(t){try{return new RegExp(t).test(e)}catch(e){return!1}}))})).map((function(e){return e.offerId})),[2,r]):[2,[]]}}))}))}},53527:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},a=this&&this.__rest||function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n},s=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};Object.defineProperty(t,"__esModule",{value:!0}),t.handleHandleOfferWidgetDisplayMessage=void 0;var c=n(55015),u=n(58029),l=n(47248),d=n(34423),f=n(42792),p=n(93795),h=n(9168),v=n(52151),g=n(32495),b=n(57419),y=n(22641),m=n(76038),w=n(56315),S=n(16206);function I(e){chrome.tabs.sendMessage(e,{message:"submitHideOfferWidgetDecision"})}function A(e){return o(this,void 0,void 0,(function(){var t,n,r;return i(this,(function(o){switch(o.label){case 0:return t=e.type,n=e.offerId,[4,M(e)];case 1:if(o.sent())return[2,!1];switch(t){case d.OfferType.Online:return[3,2];case d.OfferType.NoCashback:return[3,5];case d.OfferType.OneTime:return[3,7]}return[3,11];case 2:case 7:return[4,k(n)];case 3:return o.sent()?[2,!1]:T(e)?[2,!0]:[4,(0,f.checkIsTemporaryUser)()];case 4:case 6:case 10:return r=o.sent(),[2,L(e,r)];case 5:return[4,(0,f.checkIsTemporaryUser)()];case 8:return o.sent()?[2,!1]:[4,(0,h.checkHasActiveBankConnections)()];case 9:return o.sent()?T(e)?[2,!0]:[4,(0,f.checkIsTemporaryUser)()]:[2,!1];case 11:return[2,!1]}}))}))}function k(e){return o(this,void 0,void 0,(function(){var t;return i(this,(function(n){switch(n.label){case 0:return[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.offerActivatedInSessionTimestampMsMap)];case 1:return[2,!!((null==(t=n.sent())?void 0:t[e])&&Date.now()-t[e]<=36e5)]}}))}))}function M(e){return o(this,void 0,void 0,(function(){var t,n;return i(this,(function(r){switch(r.label){case 0:return t=36e5*c.DEFAULT_OFFER_WIDGET_DISPLAY_COOLDOWN_IN_HOURS,[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.offerWidgetLastClosedInSessionTimestampMsMap)];case 1:return[2,!!(n=r.sent())&&!!n[e.offerId]&&Date.now()-n[e.offerId]<t]}}))}))}function L(e,t){var n,r,o=e.browserExtension;if(!o)return!1;var i=null===(n=o.bnpl)||void 0===n?void 0:n.active;return!(!((null===(r=o.coupons)||void 0===r?void 0:r.itemList)&&o.coupons.itemList.length>0)||(v.isMobileExtension?o.mobileVersion&&!1===o.mobileVersion.displayCouponsPromotionWidget:o.desktopVersion&&!1===o.desktopVersion.displayCouponsPromotionWidget))||!(!i||t)&&(v.isMobileExtension?!(o.mobileVersion&&!1===o.mobileVersion.displayBnplPromotionWidget):!(o.desktopVersion&&!1===o.desktopVersion.displayBnplPromotionWidget))}function T(e){var t=e.browserExtension;return!!t&&(v.isMobileExtension?t.mobileVersion?!1!==t.mobileVersion.displayCashbackWidget:!1!==t.displayCashbackWidget:t.desktopVersion?!1!==t.desktopVersion.displayCashbackWidget:!1!==t.displayCashbackWidget)}function E(e){return new Promise((function(t){return chrome.tabs.get(e,(function(e){chrome.runtime.lastError?t({isTabStillOpen:!1}):t({isTabStillOpen:!!e,tabUrl:null==e?void 0:e.url})}))}))}t.handleHandleOfferWidgetDisplayMessage=function(e,t,n){return o(this,void 0,void 0,(function(){var l,d,f,h,S,k,M,L,T,x,O,P,U,_,D,R,F,B,W,G,N,K,j,q,Q,H,z,V,J,Z;return i(this,(function(X){switch(X.label){case 0:if(!t)throw new Error("Tab ID is required to display the offer widget");if(!n)throw new Error("Tab URL is required to display the offer widget");return l=(null==e?void 0:e.data)||{},d=l.urlChangeMessageReceivedTimestampInMs,f=l.handleOfferWidgetDisplayMessageSentTimestampInMs,h=Date.now(),[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.lastPageLoadStartTimestampByTabIdMap)];case 1:return S=X.sent(),k=null==S?void 0:S[t],M=s((0,c.getHostnameAndPath)(n),1),L=M[0],v.isMobileAppBrowserExtension?(I(t),[2]):(T=function(e){var t=/app\.(hello)?joko\.com\/online-offer-activation\/([A-Za-z0-9-]*)\/([A-Za-z0-9-]*)/,n=e.match(t);if(null==n?void 0:n[2])return console.log("Matched WebApp URL (offerId: ".concat(n[2],")")),{isWebAppOnlineOfferActivationPage:!0,offerId:n[2]};var r=/app\.(hello)?joko\.com\/home\/shop\/(.*)/,o=e.match(r);if(null==o?void 0:o[1])return console.log("Matched WebApp URL (offerId: ".concat(o[1],")")),{isWebAppOnlineOfferActivationPage:!0,offerId:o[1]};return{isWebAppOnlineOfferActivationPage:!1,offerId:void 0}}(n),x=T.isWebAppOnlineOfferActivationPage,O=T.offerId,x?[4,(0,g.updateLocalStorageItem)(g.LocalStorageKey.offerActivatedInSessionTimestampMsMap,(Z={},Z[O]=Date.now(),Z))]:[3,3]);case 2:return X.sent(),I(t),[2];case 3:return P=Date.now(),[4,(0,p.checkHasFeature)(v.isMobileExtension?u.Feature.cardLinkedOfferCashbackWidgetMobileBrowserExtension:u.Feature.cardLinkedOfferCashbackWidgetDesktopBrowserExtension)];case 4:return U=X.sent(),_=Date.now()-P,[4,(0,m.getMerchantOffersWithConditionsAndCouponsMatchingUrlOrOfferIds)({currentUrl:n,shouldFilterOutOnetimeOffers:!U})];case 5:return D=X.sent(),R=D.offers,F=a(D,["offers"]),(B=R.length?R[0]:void 0)?(W=Date.now(),[4,A(B)]):(I(t),[2]);case 6:return G=X.sent(),N=Date.now()-W,K=Date.now(),j={lastPageLoadStartTimestampInMs:k,urlChangeMessageReceivedTimestampInMs:d,handleOfferWidgetDisplayMessageSentTimestampInMs:f,handleOfferWidgetDisplayMessageReceivedTimestampInMs:h,cardLinkedOfferCashbackWidgetAppFeatureCheckDurationInMs:_,shouldSendDisplayOfferWidgetMessageCheckDurationInMs:N,displayOfferWidgetMessageSentTimestampInMs:K},G?function(e){var t=e.tabId,n=e.displayedMatchingOffer,r=e.matchingOffers,a=e.initialUrlHostname,s=e.offerWidgetDisplayBackgroundScriptDebuggingTimestamps,c=e.offerQueriesDebuggingInfo;o(this,void 0,void 0,(function(){var e,o;return i(this,(function(i){switch(i.label){case 0:return[4,(0,w.getUserOfferActivationInfo)(n?n.offerId:void 0)];case 1:return e=i.sent(),o=r.length>1?r.slice(1).map((function(e){return e.offerId})):void 0,chrome.tabs.sendMessage(t,{message:"displayWidget",data:{widgetType:"offer",offer:n,userOfferActivationInfo:e,offerIdsMatchedButNotDisplayed:o,initialUrlHostname:a,offerWidgetDisplayBackgroundScriptDebuggingTimestamps:s,offerQueriesDebuggingInfo:c}}),[2]}}))}))}({tabId:t,displayedMatchingOffer:B,matchingOffers:R,initialUrlHostname:L,offerWidgetDisplayBackgroundScriptDebuggingTimestamps:j,offerQueriesDebuggingInfo:F}):I(t),[4,E(t)];case 7:return q=X.sent(),Q=q.isTabStillOpen,H=q.tabUrl,z=s(H?(0,c.getHostnameAndPath)(H):[void 0],1),V=z[0],J=r(r(r({},F),j),{isTabStillOpen:Q,shouldSendDisplayOfferWidgetMessage:G,hasChangedUrlHostnameWhenSendingDisplayOfferWidgetMessage:void 0===L||void 0===V?void 0:L!==V}),function(e){var t=e.offer,n=e.offerWidgetDisplayBackgroundScriptDebuggingInfo,a=e.tabId,u=e.initialUrlHostname,l=e.webpageUrl;o(this,void 0,void 0,(function(){var e,d,f,p,h;return i(this,(function(v){switch(v.label){case 0:return e=r({offerId:t.offerId,initialUrlHostname:u,webpageUrl:l},n),[4,(0,g.getLocalStorageItem)(g.LocalStorageKey.lastBrowsedToMerchantWebsiteEventsEmissionTimestampMillisecondsMap)];case 1:return d=v.sent(),f=null==d?void 0:d[t.offerId],[4,C(t.offerId)];case 2:return p=v.sent(),(null==n?void 0:n.shouldSendDisplayOfferWidgetMessage)||!f||Date.now()-f>1e3*p?[4,Promise.all([(0,y.logUserEventUtil)({type:"browsedToMerchantWebsite",payload:e}),(0,b.sendAmplitudeEvent)({type:"Browser Extension - Browsed To Merchant Website",properties:e}),(0,g.updateLocalStorageItem)(g.LocalStorageKey.lastBrowsedToMerchantWebsiteEventsEmissionTimestampMillisecondsMap,(h={},h[t.offerId]=Date.now(),h))])]:[3,4];case 3:v.sent(),v.label=4;case 4:return(null==n?void 0:n.shouldSendDisplayOfferWidgetMessage)&&setTimeout((function(){return function(e){var t=e.offer,n=e.handleOfferWidgetDisplayMessageReceivedTimestampInMs,r=e.tabId,a=e.initialUrlHostname;return o(this,void 0,void 0,(function(){var e,o,u,l,d,f,p,h;return i(this,(function(i){switch(i.label){case 0:return[4,E(r)];case 1:return e=i.sent(),o=e.isTabStillOpen,u=e.tabUrl,l=s(u?(0,c.getHostnameAndPath)(u):[void 0],1),d=l[0],f=new Promise((function(e){return chrome.tabs.sendMessage(r,{message:"pingContentScriptFromBackgroundScript"},(function(t){return e("pingBackgroundScriptFromContentScript"===t)}))})),p=new Promise((function(e){return setTimeout((function(){return e(!1)}),4e3)})),[4,Promise.race([f,p])];case 2:return h=i.sent(),(0,y.logUserEventUtil)({type:"backgroundScriptOfferWidgetDisplayLogicHealthCheckTriggered",active:!1,payload:{offerId:t.offerId,handleOfferWidgetDisplayMessageReceivedTimestampInMs:n,healthCheckTriggeredTimestampInMs:Date.now(),isTabStillOpen:o,hasChangedUrlHostname:void 0===a||void 0===d?void 0:a!==d,isContentScriptResponding:h}}),[2]}}))}))}({offer:t,handleOfferWidgetDisplayMessageReceivedTimestampInMs:n.handleOfferWidgetDisplayMessageReceivedTimestampInMs,tabId:a,initialUrlHostname:u})}),2e4),[2]}}))}))}({offer:B,offerWidgetDisplayBackgroundScriptDebuggingInfo:J,tabId:t,initialUrlHostname:L,webpageUrl:n}),[2]}}))}))};var x=3600;function C(e){return o(this,void 0,void 0,(function(){var t,n,r;return i(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),n=S.parseSetting,[4,(0,S.getSetting)(l.SettingKey.specificUserEventsThrottlingInSeconds)];case 1:if((t=n.apply(void 0,[o.sent()]))&&"object"==typeof t&&"browsedToMerchantWebsite"in t&&"object"==typeof t.browsedToMerchantWebsite){if(e in t.browsedToMerchantWebsite&&"number"==typeof t.browsedToMerchantWebsite[e])return[2,t.browsedToMerchantWebsite[e]];if("defaultThrottlingInSeconds"in t.browsedToMerchantWebsite&&"number"==typeof t.browsedToMerchantWebsite.defaultThrottlingInSeconds)return[2,t.browsedToMerchantWebsite.defaultThrottlingInSeconds]}return[3,3];case 2:return r=o.sent(),console.warn("Error while fetching specificUserEventsThrottlingInSeconds setting for event 'browsedToMerchantWebsite' and offerId ".concat(e,":"),r),[3,3];case 3:return[2,x]}}))}))}},65547:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.clearExpiredPriceComparisonLocalStorageData=t.handleGetMerchantProductOfferAlternativesMessage=void 0;var i=n(47248),a=n(45133),s=n(30752),c=n(32495),u=n(87626),l=n(16206);function d(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),[4,(0,a.getClient)()];case 1:return[4,n.sent().query({query:s.merchantProductOfferAlternativesQuery,variables:e,fetchPolicy:"network-only"})];case 2:return[2,n.sent().data];case 3:return t=n.sent(),console.error("GraphQL: error while fetching merchant product offer alternatives",t.message),(0,u.captureSentryException)(t),[2,void 0];case 4:return[2]}}))}))}t.handleGetMerchantProductOfferAlternativesMessage=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,d(e.data.queryVariables)];case 1:return n=r.sent(),t(n),[2]}}))}))};t.clearExpiredPriceComparisonLocalStorageData=function(){return r(this,void 0,void 0,(function(){var e,t,n,r;return o(this,(function(o){switch(o.label){case 0:return[4,(0,c.getLocalStorageItem)(c.LocalStorageKey.priceComparisonWidgetLastClosedInSessionTimestampMsMap)];case 1:return(e=o.sent())&&0!==Object.keys(e).length?[4,(0,l.getSetting)(i.SettingKey.priceComparisonWidgetDisplayCooldownInHours)]:[2];case 2:for(r in t=o.sent()||1,n={},Object.keys(e))Date.now()-e[r]<t&&(n[r]=e[r]);return(0,c.setLocalStorageItem)(c.LocalStorageKey.priceComparisonWidgetLastClosedInSessionTimestampMsMap,n),[2]}}))}))}},33837:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleUpdateProductDiscoveryConversation=t.handleCreateProductDiscoveryConversationId=t.handleSearchMerchantProductOffers=void 0;var i=n(45133),a=n(97779),s=n(30752),c=n(87626);function u(e){var t=e.data;return r(this,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),[4,(0,i.getClient)()];case 1:return[4,n.sent().query({query:s.searchMerchantProductOffersQuery,variables:t})];case 2:return[2,n.sent().data];case 3:return e=n.sent(),console.error("GraphQL: error while fetching merchant product offers",e.message),(0,c.captureSentryException)(e),[2,null];case 4:return[2]}}))}))}function l(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),[4,(0,i.getClient)()];case 1:return[4,t.sent().query({query:a.createProductDiscoveryConversationIdQuery,fetchPolicy:"network-only"})];case 2:return[2,t.sent().data];case 3:return e=t.sent(),console.error("GraphQL: error while creating product discovery conversation ID",e.message),(0,c.captureSentryException)(e),[2,void 0];case 4:return[2]}}))}))}function d(e){var t=e.data;return r(this,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),[4,(0,i.getClient)()];case 1:return[4,n.sent().mutate({mutation:a.updateProductDiscoveryConversationMutation,variables:t})];case 2:return[2,n.sent().data];case 3:return e=n.sent(),console.error("GraphQL: error while updating product discovery conversation",e.message),(0,c.captureSentryException)(e),[2,null];case 4:return[2]}}))}))}t.handleSearchMerchantProductOffers=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,u(e)];case 1:return n=r.sent(),t(null!=n?n:void 0),[2]}}))}))},t.handleCreateProductDiscoveryConversationId=function(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,l()];case 1:return t=n.sent(),e(null==t?void 0:t.productDiscoveryConversationId),[2]}}))}))},t.handleUpdateProductDiscoveryConversation=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,d(e)];case 1:return n=r.sent(),t(null!=n?n:void 0),[2]}}))}))}},62606:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},i=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},a=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},s=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.handleGetImagePixelsAndShapeMessage=t.handleCreateProductImageEmbeddingMessage=t.handleGetProductImageEmbeddingMessage=t.handleGetProductWebpageMessage=t.handleGetWebpagePriceHistoryMessage=t.handleUnsaveWebpageMessage=t.handleSaveWebpageMessage=t.handleGetWebpageUrlIfSavedMessage=t.updateUserBrowsedProductWebpagesCachedQueryResponse=t.handleUpdateQueryCacheForDetectedProductWebpageMessage=t.handleDeleteUserBrowsedProductWebpagesMessage=t.handleGetUserBrowsedProductWebpagesMessage=t.handleGetUserSavedWebpagesMessage=t.handleCreateProductWebpageMessage=void 0;var c=n(58029),u=n(85211),l=n(47248),d=n(45133),f=n(98894),p=n(555),h=n(18059),v=n(37725),g=n(16248),b=n(15089),y=n(37052),m=n(93795),w=n(32495),S=n(81866),I=n(87626),A=n(16206);function k(){return r(this,void 0,void 0,(function(){var e,t,n,r;return o(this,(function(o){switch(o.label){case 0:return[4,(0,y.runThrottledQuery)({queryType:y.ThrottledQueryType.userSavedWebpagesQuery,runQuery:M})];case 1:return(e=o.sent())?(t=w.setLocalStorageItem,n=[w.LocalStorageKey.userSavedWebpagesSessionData],r={},[4,(0,S.getSessionId)()]):[3,4];case 2:return[4,t.apply(void 0,n.concat([(r.sessionId=o.sent(),r.savedWebpageTitleMap=L(e),r)]))];case 3:o.sent(),o.label=4;case 4:return[2,null!=e?e:[]]}}))}))}function M(){return(0,d.getClient)().then((function(e){return e.query({query:b.userSavedWebpagesQuery,fetchPolicy:"no-cache"})})).catch((function(e){console.error("GraphQL: error while fetching user saved webpages",e),(0,I.captureSentryException)(e)})).then((function(e){var t,n,r;return null===(r=null===(n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.user)||void 0===n?void 0:n.savedWebpages)||void 0===r?void 0:r.items}))}function L(e){var t,n,r={};try{for(var o=i(e),a=o.next();!a.done;a=o.next()){var s=a.value,c=s.webpageUrl,u=s.webpageTitle;r[c]=u}}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return r}function T(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return[4,(0,y.runThrottledQuery)({queryType:y.ThrottledQueryType.userBrowsedProductWebpagesQuery,runQuery:x})];case 1:return[2,null!=(e=t.sent())?e:[]]}}))}))}t.handleCreateProductWebpageMessage=function(e){return r(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,(0,d.getClient)().then((function(t){return t.mutate({mutation:p.createProductWebpageMutation,variables:e.data})})).catch((function(e){console.error("GraphQL: error running create product webpage mutation",e),(0,I.captureSentryException)(e)}))];case 1:return t.sent(),[2]}}))}))},t.handleGetUserSavedWebpagesMessage=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return t=e,n={},[4,k()];case 1:return t.apply(void 0,[(n.userSavedWebpages=r.sent(),n)]),[2]}}))}))},t.handleGetUserBrowsedProductWebpagesMessage=function(e){return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return t=e,n={},[4,T()];case 1:return t.apply(void 0,[(n.userBrowsedProductWebpages=r.sent(),n)]),[2]}}))}))};var E=100;function x(){var e;return r(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return n=A.parseSetting,[4,(0,A.getSetting)(l.SettingKey.maxNumberOfBrowsedProductWebpagesBrowserExtension)];case 1:return t=null!==(e=n.apply(void 0,[r.sent()]))&&void 0!==e?e:E,[2,(0,d.getClient)().then((function(e){return e.query({query:b.userBrowsedProductWebpagesQuery,variables:{maxNumberOfItems:t},fetchPolicy:"no-cache"})})).catch((function(e){console.error("GraphQL: error while fetching user browsed product webpages",e),(0,I.captureSentryException)(e)})).then((function(e){var t,n;return null===(n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.user)||void 0===n?void 0:n.browsedProductWebpages}))]}}))}))}function C(e){var t=e.browsedProductWebpage,n=e.deletionData;return r(this,void 0,void 0,(function(){var e,r,i;return o(this,(function(o){switch(o.label){case 0:return e=(0,y.getQueryCacheKey)({queryType:y.ThrottledQueryType.userBrowsedProductWebpagesQuery}),(0,y.invalidateInMemoryQueryCacheEntry)(e),t?[4,(0,y.getLocalStorageQueryCache)(e)]:[3,4];case 1:return(r=o.sent())?[4,(0,y.updateLocalStorageQueryCache)(e,{data:s([t],a(r.data),!1)})]:[3,3];case 2:o.sent(),o.label=3;case 3:return[3,9];case 4:return n&&"deleteAll"in n&&n.deleteAll?[4,(0,y.updateLocalStorageQueryCache)(e,{data:[]})]:[3,6];case 5:return o.sent(),[3,9];case 6:return n&&"timestampsToDelete"in n&&n.timestampsToDelete.length>0?[4,(0,y.getLocalStorageQueryCache)(e)]:[3,9];case 7:return(r=o.sent())?(i=new Set(n.timestampsToDelete),[4,(0,y.updateLocalStorageQueryCache)(e,{data:r.data.filter((function(e){var t=e.timestamp;return!i.has(t)}))})]):[3,9];case 8:o.sent(),o.label=9;case 9:return[2]}}))}))}function O(e){var t=e.webpageUrl,n=e.webpageTitle,r=e.maxNumberOfItems,o=e.startDate,i="".concat(t,"|").concat(n||"")+"|".concat(r||"","|").concat(o||"");return(0,y.runThrottledQuery)({queryType:y.ThrottledQueryType.webpageSnapshotsQuery,querySignature:i,runQuery:function(){return function(e){return(0,d.getClient)().then((function(t){return t.query({query:b.webpageSnapshotsQuery,variables:e,fetchPolicy:"network-only"})})).catch((function(e){console.error("GraphQL: error getting webpage snapshots",e),(0,I.captureSentryException)(e)})).then((function(e){var t;return null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.webpageSnapshots}))}(e)}})}function P(e){var t=e.websiteSecondLevelDomain,n=e.webpageTitle,r="".concat(t,"|").concat(n);return(0,y.runThrottledQuery)({queryType:y.ThrottledQueryType.productImageEmbeddingQuery,querySignature:r,runQuery:function(){return function(e){return(0,d.getClient)().then((function(t){return t.query({query:b.productImageEmbeddingQuery,variables:e,fetchPolicy:"no-cache"})})).catch((function(e){console.error("GraphQL: error fetching product image embedding",e),(0,I.captureSentryException)(e)})).then((function(e){var t,n;return null!==(n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.productImageEmbedding)&&void 0!==n?n:void 0}))}(e)}})}t.handleDeleteUserBrowsedProductWebpagesMessage=function(e){return r(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,(0,d.getClient)().then((function(t){return t.mutate({mutation:h.deleteBrowsedProductWebpagesMutation,variables:e.data})})).catch((function(e){console.error("GraphQL: error while deleting browsed product webpages",e),(0,I.captureSentryException)(e)}))];case 1:return t.sent(),[4,C({deletionData:e.data})];case 2:return t.sent(),[2]}}))}))},t.handleUpdateQueryCacheForDetectedProductWebpageMessage=function(e){return r(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,C({browsedProductWebpage:e.data})];case 1:return t.sent(),[2]}}))}))},t.updateUserBrowsedProductWebpagesCachedQueryResponse=C,t.handleGetWebpageUrlIfSavedMessage=function(e,t){return r(this,void 0,void 0,(function(){var n,r,s,c,l,d,f,p,h,v,g,b;return o(this,(function(o){switch(o.label){case 0:return[4,Promise.all([(0,S.getSessionId)(),(0,w.getLocalStorageItem)(w.LocalStorageKey.userSavedWebpagesSessionData)])];case 1:return n=a.apply(void 0,[o.sent(),2]),r=n[0],(s=n[1])&&s.sessionId===r?(l=s.savedWebpageTitleMap,[3,4]):[3,2];case 2:return d=L,[4,k()];case 3:l=d.apply(void 0,[o.sent()]),o.label=4;case 4:c=l;try{for(f=i(Object.keys(c)),p=f.next();!p.done;p=f.next())if(h=p.value,v={webpageUrl:h,webpageTitle:c[h]},(0,u.checkAreSameWebpages)(e.data,v))return t({savedWebpageUrl:h}),[2]}catch(e){g={error:e}}finally{try{p&&!p.done&&(b=f.return)&&b.call(f)}finally{if(g)throw g.error}}return t({savedWebpageUrl:void 0}),[2]}}))}))},t.handleSaveWebpageMessage=function(e){return r(this,void 0,void 0,(function(){var t,n,r,s,c,u,l,f;return o(this,(function(o){switch(o.label){case 0:t=e.data,o.label=1;case 1:return o.trys.push([1,4,,5]),[4,(0,d.getClient)()];case 2:return[4,o.sent().mutate({mutation:v.saveWebpageMutation,variables:t})];case 3:return n=o.sent(),[3,5];case 4:return r=o.sent(),console.error("GraphQL: error running save product webpage mutation",r),(0,I.captureSentryException)(r),[3,5];case 5:return(null==n?void 0:n.data)?(s=n.data.saveWebpage,[4,Promise.all([(0,S.getSessionId)(),(0,w.getLocalStorageItem)(w.LocalStorageKey.userSavedWebpagesSessionData)])]):(console.error("No data returned from the save product webpage mutation"),(0,I.captureSentryException)(new Error("No data returned from the save product webpage mutation")),[2]);case 6:return c=a.apply(void 0,[o.sent(),2]),u=c[0],l=c[1],(f=l&&l.sessionId===u?l.savedWebpageTitleMap:{})[s.webpageUrl]=s.webpageTitle,[4,(0,w.setLocalStorageItem)(w.LocalStorageKey.userSavedWebpagesSessionData,{sessionId:u,savedWebpageTitleMap:f})];case 7:return o.sent(),[4,(0,y.invalidateQueryCacheEntry)({queryType:y.ThrottledQueryType.userSavedWebpagesQuery})];case 8:return o.sent(),chrome.tabs.query({},(function(e){var t,n;try{for(var r=i(e),o=r.next();!o.done;o=r.next()){var a=o.value;a.id&&chrome.tabs.sendMessage(a.id,{message:"webpageSaved"})}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),[2]}}))}))},t.handleUnsaveWebpageMessage=function(e){return r(this,void 0,void 0,(function(){var t,n,r,s,c,u,l,f;return o(this,(function(o){switch(o.label){case 0:t=e.data,o.label=1;case 1:return o.trys.push([1,4,,5]),[4,(0,d.getClient)()];case 2:return[4,o.sent().mutate({mutation:g.unsaveWebpageMutation,variables:t})];case 3:return n=o.sent(),[3,5];case 4:return r=o.sent(),console.error("GraphQL: error running save product webpage mutation",r),(0,I.captureSentryException)(r),[3,5];case 5:return(null==n?void 0:n.data)?(s=n.data.unsaveWebpage,[4,Promise.all([(0,S.getSessionId)(),(0,w.getLocalStorageItem)(w.LocalStorageKey.userSavedWebpagesSessionData)])]):(console.error("No data returned from the unsave product webpage mutation"),(0,I.captureSentryException)(new Error("No data returned from the unsave product webpage mutation")),[2]);case 6:return c=a.apply(void 0,[o.sent(),2]),u=c[0],l=c[1],delete(f=l&&l.sessionId===u?l.savedWebpageTitleMap:{})[s.webpageUrl],[4,(0,w.setLocalStorageItem)(w.LocalStorageKey.userSavedWebpagesSessionData,{sessionId:u,savedWebpageTitleMap:f})];case 7:return o.sent(),[4,(0,y.invalidateQueryCacheEntry)({queryType:y.ThrottledQueryType.userSavedWebpagesQuery})];case 8:return o.sent(),chrome.tabs.query({},(function(e){var t,n;try{for(var r=i(e),o=r.next();!o.done;o=r.next()){var a=o.value;a.id&&chrome.tabs.sendMessage(a.id,{message:"webpageUnsaved",data:{unsavedWebpageUrl:s.webpageUrl}})}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),[2]}}))}))},t.handleGetWebpagePriceHistoryMessage=function(e,t){return r(this,void 0,void 0,(function(){var n,r,a,s,u,l,d,f,p,h,v,g,b,y,w,S,I,A,k,M,L;return o(this,(function(o){switch(o.label){case 0:return n=e.data,r=n.webpageUrl,a=n.webpageTitle,s=n.startDate,u=n.maxNumberOfItems,[4,O({webpageUrl:r,webpageTitle:a,startDate:s,maxNumberOfItems:u})];case 1:l=o.sent()||[],d=[];try{for(f=i(l),p=f.next();!p.done;p=f.next())h=p.value,S=h.timestamp,(null==(I=h.productData)?void 0:I.priceAmount)&&I.priceCurrency&&d.push({timestamp:S,amount:I.priceAmount,currency:I.priceCurrency})}catch(e){A={error:e}}finally{try{p&&!p.done&&(k=f.return)&&k.call(f)}finally{if(A)throw A.error}}return[4,(0,m.checkHasFeature)(c.Feature.shouldLoadFullPriceHistoryIfPartialPriceHistoryContainsIncompleteDataInExtensions)];case 2:return o.sent()&&u&&l.length>=2&&d.length<=1?[4,O({webpageUrl:r,webpageTitle:a,startDate:s})]:[3,4];case 3:v=o.sent()||[],g=[];try{for(b=i(v),y=b.next();!y.done;y=b.next())w=y.value,S=w.timestamp,(null==(I=w.productData)?void 0:I.priceAmount)&&I.priceCurrency&&g.push({timestamp:S,amount:I.priceAmount,currency:I.priceCurrency})}catch(e){M={error:e}}finally{try{y&&!y.done&&(L=b.return)&&L.call(b)}finally{if(M)throw M.error}}return t({priceHistory:g}),[3,5];case 4:t({priceHistory:d}),o.label=5;case 5:return[2]}}))}))},t.handleGetProductWebpageMessage=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,(o=e.data,i=o.webpageUrl,a=o.webpageTitle,s="".concat(i,"|").concat(a),(0,y.runThrottledQuery)({queryType:y.ThrottledQueryType.productWebpageQuery,querySignature:s,runQuery:function(){return function(e){return(0,d.getClient)().then((function(t){return t.query({query:b.productWebpageQuery,variables:e,fetchPolicy:"network-only"})})).catch((function(e){console.error("GraphQL: error fetching product webpage",e),(0,I.captureSentryException)(e)})).then((function(e){var t;return null!==(t=null==e?void 0:e.data.productWebpage)&&void 0!==t?t:void 0}))}(o)}}))];case 1:return n=r.sent(),t({productWebpage:n}),[2]}var o,i,a,s}))}))},t.handleGetProductImageEmbeddingMessage=function(e,t){return r(this,void 0,void 0,(function(){var n,r,i,a;return o(this,(function(o){switch(o.label){case 0:return n=e.data,r=n.websiteSecondLevelDomain,i=n.webpageTitle,[4,P({websiteSecondLevelDomain:r,webpageTitle:i})];case 1:return a=o.sent(),t({productImageEmbedding:a}),[2]}}))}))},t.handleCreateProductImageEmbeddingMessage=function(e){return r(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,(0,d.getClient)().then((function(t){return t.mutate({mutation:f.createProductImageEmbeddingMutation,fetchPolicy:"no-cache",variables:e.data})})).catch((function(e){console.error("GraphQL: error creating product image embedding",e),(0,I.captureSentryException)(e)}))];case 1:return t.sent(),[2]}}))}))},t.handleGetImagePixelsAndShapeMessage=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,(o=e.data,i=o.imageUrl,a="".concat(i),(0,y.runThrottledQuery)({queryType:y.ThrottledQueryType.getImagePixelsAndShapeQuery,querySignature:a,runQuery:function(){return function(e){return(0,d.getClient)().then((function(t){return t.query({query:b.getImagePixelsAndShapeQuery,variables:e,fetchPolicy:"no-cache"})})).catch((function(e){console.error("GraphQL: error while fetching image pixels and shape",e),(0,I.captureSentryException)(e)})).then((function(e){var t,n;return null!==(n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.imagePixelsAndShape)&&void 0!==n?n:void 0}))}(o)}}))];case 1:return n=r.sent(),t({imagePixelsAndShape:n}),[2]}var o,i,a}))}))}},87626:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},a=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},s=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},c=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a},u=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.withSentry=t.captureSentryException=t.setUserIdSentryTag=t.initializeSentry=void 0;var l=i(n(37315)),d=n(55015),f=n(93489),p=n(96613),h=n(45133),v=n(42792),g=n(93795),b=n(52151),y=n(22641);t.initializeSentry=function(){return a(this,void 0,void 0,(function(){var e,t,n;return s(this,(function(r){switch(r.label){case 0:return l.init({dsn:d.SENTRY_DSN,release:p.versionNumber,sampleRate:1,beforeSend:function(e){var t,n,r;console.log("Sentry event: ".concat(null===(r=null===(n=null===(t=null==e?void 0:e.exception)||void 0===t?void 0:t.values)||void 0===n?void 0:n[0])||void 0===r?void 0:r.value),e);try{return function(e){var t,n;a(this,void 0,void 0,(function(){var r;return s(this,(function(o){switch(o.label){case 0:return[4,(0,v.checkIsSignedIn)()];case 1:return(r=o.sent())?[4,(0,g.checkHasFeatureFromLocalStorage)(b.isMobileExtension?d.Feature.logSentryEventsInUserEventsMobileBrowserExtension:d.Feature.logSentryEventsInUserEventsDesktopBrowserExtension)]:[3,3];case 2:r=o.sent(),o.label=3;case 3:return r?[4,(0,y.logUserEventUtil)({type:"sentryEventSent",active:!1,payload:{script:"backgroundScript",sentryEventId:e.event_id,exceptions:null===(n=null===(t=e.exception)||void 0===t?void 0:t.values)||void 0===n?void 0:n.map((function(e){return{exceptionType:(null==e?void 0:e.type)?"".concat(e.type):"",exceptionValue:(null==e?void 0:e.value)?"".concat(e.value):""}})),eventLevel:e.level,eventTimestamp:e.timestamp}},!0)]:[3,5];case 4:o.sent(),o.label=5;case 5:return[2]}}))}))}(e),e}catch(t){return console.error(t),e}}}),t=(e=l).setTags,n={script:"backgroundScript",environment:"production",versionNumber:p.versionNumber},[4,(0,f.getLocalStorageItem)(f.LocalStorageKey.userId)];case 1:return n.userId=r.sent(),n.extensionType=(0,b.detectExtensionType)(),[4,(0,h.getDevStackMode)()];case 2:return t.apply(e,[(n.isDevStack=r.sent(),n)]),[2]}}))}))},t.setUserIdSentryTag=function(e){l.setTag("userId",e)},t.captureSentryException=function(e){l.captureException(e)},t.withSentry=function(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];try{return e.apply(void 0,u([],c(t),!1))}catch(e){throw l.captureException(e),e}}}},16206:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.getPublicSetting=t.runThrottledSettingsQuery=t.parseSetting=t.getSetting=t.handleGetSettingMessage=void 0;var i=n(45133),a=n(94818),s=n(37052),c=n(42792),u=n(87626);function l(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,f(t)];case 1:return[2,null==(n=r.sent())?void 0:n.find((function(t){return t.settingKey===e}))]}}))}))}t.handleGetSettingMessage=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,l(e.data.settingKey,e.data.throttlingInMs)];case 1:return n=r.sent(),t({setting:n}),[2]}}))}))},t.getSetting=l,t.parseSetting=function(e){try{if(!e)return;return JSON.parse(e.value)}catch(e){return}};var d=216e5;function f(e){return r(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,(0,c.checkIsSignedIn)()];case 1:return t.sent()?[2,(0,s.runThrottledQuery)({queryType:s.ThrottledQueryType.settingQuery,runQuery:p,throttlingDelayInMs:null!=e?e:d})]:(console.log("Cannot fetch the settings because the user is not signed in"),[2,void 0])}}))}))}function p(){return(0,i.getClient)().then((function(e){return e.query({query:a.settingQuery,fetchPolicy:"no-cache"})})).catch((function(e){console.error("GraphQL: error while fetching settings",e),(0,u.captureSentryException)(e)})).then((function(e){var t,n;return null===(n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.settings)||void 0===n?void 0:n.items}))}t.runThrottledSettingsQuery=f,t.getPublicSetting=function(e){return r(this,void 0,void 0,(function(){var t,n,r,a;return o(this,(function(o){switch(o.label){case 0:return(t=new Headers).append("Accept","application/json"),t.append("Content-Type","application/json"),r="".concat,[4,(0,i.getRestApiUrl)()];case 1:return n=r.apply("",[o.sent(),"setting?settingKey="]).concat(encodeURIComponent(e)),a=fetch(n,{method:"GET",headers:t}).then((function(e){if(console.log("Response ".concat(e.status," for API call 'getPublicSetting'")),200===e.status)return e.json();throw new Error("No setting found")})).then((function(e){return e.settingValue})).catch((function(e){console.error("REST: Error fetching public setting",e),(0,u.captureSentryException)(e)})),[2,a]}}))}))}}}]);