function onRequestMessageMP(n,t){_gaq.push(["_trackEvent",n.domain,n.command]);switch(n.command){case commands.certificates:certificates(n,t);break;case commands.certificate:certificate(n,t);break;case commands.sign:sign(n,t);break;case commands.check:check(n,t);break;case commands.remove:remove(n,t);break;case commands.encrypt:encrypt(n,t);break;case commands.decrypt:decrypt(n,t)}}function onLoad(){chrome.runtime.onConnect.addListener(function(n){console.assert(n.name==portMPName);var t={portMP:n,portNM:null,isNMConnected:!1,isMPConnected:!0,connectionUuid:"",uuid:generateSecureIdentifier()};t.portMP.onMessage.addListener(function(n){onRequestMessageMP(n,t)});t.portMP.onDisconnect.addListener(function(){onDisconnectMP(t)});log("MessageParsing connected : "+t.uuid);try{connectToNM(t)}catch(i){log(i)}})}function onDisconnectMP(n){log("MessageParsing disconnected : "+n.uuid);n.isMPConnected=!1;n.isNMConnected=!1;n.portNM.disconnect()}function onResponseMP(n,t){t.portMP.postMessage(n)}function certificates(n,t){onSendNM(n,t)}function certificate(n,t){onSendNM(n,t)}function encrypt(n,t){onSendNM(n,t)}function decrypt(n,t){onSendNM(n,t)}function sign(n,t){var i=JSON.parse(n.content);signAuthorized(n,t)}function preAuthorize(n,t){internalRequest={command:commands.certificates,requestId:generateSecureIdentifier(),content:JSON.stringify(null),license:n.license,domain:n.domain};onSendNM(internalRequest,t,signUnauthorized,n)}function signAuthorized(n,t){onSendNM(n,t)}function signUnauthorized(n,t,i){for(var f=JSON.parse(t.content),e=JSON.parse(n.subRequest.content),r={},u=0;u<f.certificates.length;u++)if(f.certificates[u].thumbprint===e.thumbprint){r=f.certificates[u];break}chrome.tabs.create({url:chrome.extension.getURL("views/confirm_domain.html"),active:!1},function(t){chrome.windows.getCurrent(function(u){var c=0,l=0,f=500,o=240,s,h;c=u.left/2;l=u.top/2;s=screen.width/2-f/2;h=screen.height/2-o/2;chrome.windows.create({tabId:t.id,type:"popup",focused:!0,width:f,height:o,left:s,top:h},function(){chrome.tabs.sendMessage(t.id,{message:{thumbprint:e.thumbprint,subjectName:r.subjectName,issuerName:r.issuerName,domain:n.subRequest.domain}});authorizationItem={request:n.subRequest,subjectName:r.subjectName,conn:i};authorizationPool[e.thumbprint]=authorizationItem})})})}function checkAuthorization(n){var i=authorizationPool[n.thumbprint],u;i===null||delete authorizationPool[n.thumbprint];var t=i.request,r=i.conn,f=JSON.parse(t.content);n.isAuthorized?(addDomain(t.domain,f.thumbprint),signAuthorized(t,r)):(u={requestId:t.requestId,statusCode:statusCode.error,statusMessage:"Acesso ao certificado "+i.subjectName+' não autorizado para o domínio "'+t.domain+'"'},onResponseMP(u,r))}function addDomain(n,t){chrome.storage.sync.get(t,function(i){var r,u;r=i[t];r||(r=[]);r.push(n);u={};u[t]=r;chrome.storage.sync.set(u)})}function check(n,t){t.connectionUuid=n.requestId;onSendNM(n,t,checkApplication)}function remove(n,t){onSendNM(n,t)}function checkApplication(n,t,i){var r={},u,f;t.statusCode==statusCode.success&&(r=JSON.parse(t.content),u=validateAppVersion(r.appVersion),requestContent=JSON.parse(n.request.content),f=validateClientVersion(requestContent.jsClientVersion),r.instalationStatus=u?f?appStatus.INSTALLED:appStatus.JS_OUTDATED:appStatus.NATIVE_OUTDATED,_gaq.push(["_trackEvent",n.request.domain,"JS: "+requestContent.jsClientVersion]),_gaq.push(["_trackEvent","NATIVE",r.appVersion]),t.content=JSON.stringify(r));onResponseMP(t,i)}function connectToNM(n){n.portNM=chrome.runtime.connectNative(portNMName);n.portNM.onMessage.addListener(function(t){onReceiveNM(t,n)});n.portNM.onDisconnect.addListener(function(){onNativeDisconnect(n)});n.isNMConnected=!0;log("NM connected : "+n.uuid)}function onNativeDisconnect(n){n.isNMConnected=!1;n.isMPConnected&&setTimeout(function(){var t={instalationStatus:appStatus.NATIVE_NOT_INSTALLED,requestId:n.connectionUuid,statusCode:0,statusMessage:"App does not respond"};n.connectionUuid="";onResponseMP(t,n)},1e3);log("NM disconnected : "+n.uuid+" / "+chrome.runtime.lastError.message)}function generateSecureIdentifier(){function n(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function onSendNM(n,t,i,r){try{t.isNMConnected||connectToNM(t)}catch(u){log(u)}var f=generateSecureIdentifier(),e={callback:i,requestTime:new Date,request:n,subRequest:r};requestPool[f]=e;n.internalId=f;try{t.portNM.postMessage(n)}catch(u){log(u)}}function onReceiveNM(n,t){var i=requestPool[n.internalId];i?(log("Response internal uuid: "+n.internalId),delete requestPool[n.internalId],i.callback?i.callback(i,n,t):onResponseMP(n,t)):log("error invalid request id ----!")}function validateAppVersion(n){return cmpVersion(n,lowestAppVersion)>=0}function validateClientVersion(n){return cmpVersion(n,lowestClientVersion)>=0}function validateVersion(n,t){return cmpVersion(n,t)>=0}function cmpVersion(n,t){var i,r,u,f=/(\.0)+[^\.]*$/;for(n=(n+"").replace(f,"").split("."),t=(t+"").replace(f,"").split("."),u=Math.min(n.length,t.length),i=0;i<u;i++)if(r=parseInt(n[i],10)-parseInt(t[i],10),r!==0)return r;return n.length-t.length}function log(n){console.log(n)}var portNMName="com.scytl.icpbravoaccess",portMPName="com.scytl.icpbravoaccess.MP",authMPName="com.scytl.icpbravoaccess.auth",lowestAppVersion="0.7",lowestClientVersion="0.5",_AnalyticsCode="UA-73647068-1",_gaq=_gaq||[],commands,statusCode,authorizationPool,appStatus,requestPool;_gaq.push(["_setAccount",_AnalyticsCode]);_gaq.push(["_trackPageview"]),function(){var n=document.createElement("script"),t;n.type="text/javascript";n.async=!0;n.src="https://ssl.google-analytics.com/ga.js";t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(n,t)}();commands={sign:"sign",remove:"remove",certificate:"certificate",certificates:"certificates",check:"check",authorize:"authorize",encrypt:"encrypt",decrypt:"decrypt"};statusCode={error:0,success:1};authorizationPool={};appStatus={BROWSER_NOT_SUPPORTED:0,EXTENSION_NOT_INSTALLED:1,NATIVE_NOT_INSTALLED:2,NATIVE_OUTDATED:3,JS_OUTDATED:4,INSTALLED:5};requestPool={};onLoad();