(()=>{"use strict";const e=(e,t)=>t.some((t=>e instanceof t));let t,n;const r=new WeakMap,o=new WeakMap,s=new WeakMap,a=new WeakMap,i=new WeakMap;let c={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return o.get(e);if("objectStoreNames"===t)return e.objectStoreNames||s.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return d(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function l(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(n||(n=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(g(this),t),d(r.get(this))}:function(...t){return d(e.apply(g(this),t))}:function(t,...n){const r=e.call(g(this),t,...n);return s.set(r,t.sort?t.sort():[t]),d(r)}}function u(n){return"function"==typeof n?l(n):(n instanceof IDBTransaction&&function(e){if(o.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",s),e.removeEventListener("abort",s)},o=()=>{t(),r()},s=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",s),e.addEventListener("abort",s)}));o.set(e,t)}(n),e(n,t||(t=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(n,c):n)}function d(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",s)},o=()=>{t(d(e.result)),r()},s=()=>{n(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",s)}));return t.then((t=>{t instanceof IDBCursor&&r.set(t,e)})).catch((()=>{})),i.set(t,e),t}(e);if(a.has(e))return a.get(e);const t=u(e);return t!==e&&(a.set(e,t),i.set(t,e)),t}const g=e=>i.get(e);const w=["get","getKey","getAll","getAllKeys","count"],b=["put","add","delete","clear"],m=new Map;function h(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(m.get(t))return m.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,o=b.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!o&&!w.includes(n))return;const s=async function(e,...t){const s=this.transaction(e,o?"readwrite":"readonly");let a=s.store;return r&&(a=a.index(t.shift())),(await Promise.all([a[n](...t),o&&s.done]))[0]};return m.set(t,s),s}c=(e=>({...e,get:(t,n,r)=>h(t,n)||e.get(t,n,r),has:(t,n)=>!!h(t,n)||e.has(t,n)}))(c);class p{static DB_NAME="visual-bookmarks";static DB_VERSION=1;static DB_STORE="images";static DB=null;static async#e(){return this.DB=this.DB||await function(e,t,{blocked:n,upgrade:r,blocking:o,terminated:s}={}){const a=indexedDB.open(e,t),i=d(a);return r&&a.addEventListener("upgradeneeded",(e=>{r(d(a.result),e.oldVersion,e.newVersion,d(a.transaction),e)})),n&&a.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),i.then((e=>{s&&e.addEventListener("close",(()=>s())),o&&e.addEventListener("versionchange",(e=>o(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),i}(this.DB_NAME,this.DB_VERSION,{upgrade(e,t){if(0===t)e.createObjectStore(p.DB_STORE,{keyPath:"id",autoIncrement:!0})},blocking(){location.reload()}}),p.DB}static async deleteDB(){if(!this.DB)return!0;try{return await this.DB.close(),await function(e,{blocked:t}={}){const n=indexedDB.deleteDatabase(e);return t&&n.addEventListener("blocked",(e=>t(e.oldVersion,e))),d(n).then((()=>{}))}(this.DB_NAME),this.DB=null,!0}catch(e){return console.warn(e),!1}}static async clear(){try{const e=await this.#e();return await e.clear(this.DB_STORE),!0}catch(e){return console.warn(e),!1}}static async count(){try{const e=await this.#e();return await e.count(this.DB_STORE)}catch(e){console.warn(e)}}static async add(e){try{const t=(await this.#e()).transaction(this.DB_STORE,"readwrite"),n=e.map((e=>t.store.add(e).then((t=>({id:t,...e}))))),r=await Promise.all(n);return await t.done,r}catch(e){console.warn(e)}}static async get(e){try{const t=await this.#e();return await t.get(this.DB_STORE,e)}catch(e){console.warn(e)}}static async update(e){try{const t=await this.#e();return await t.put(this.DB_STORE,e)}catch(e){console.warn(e)}}static async delete(e){try{const t=await this.#e();return await t.delete(this.DB_STORE,e)}catch(e){console.warn(e)}}static async getAllByIds(e){try{const t=await this.#e();let n=await t.transaction(this.DB_STORE).store.openCursor();const r=[];for(;n;)e.includes(n.value.id)&&r.push(n.value),n=await n.continue();return r}catch(e){console.warn(e)}}}const _=browser.bookmarks,f=e=>e.reduce(((e,t)=>(t.children&&e.push({title:t.title,id:t.id,parentId:t.parentId,children:f(t.children)}),e)),[]);function y(e,t=!1){return t?[].concat(...e.map((e=>Array.isArray(e.children)?[e,...y(e.children,!0)]:e))):[].concat(...e.map((e=>Array.isArray(e.children)?y(e.children):e)))}const k="visual-bookmarks";let v=!1;const B={init(e){e&&(v||(v=!0,browser.contextMenus.removeAll((()=>{browser.runtime.lastError&&console.warn(browser.runtime.lastError),this.create().then((()=>{v=!1}))}))))},async create(){const e=await function(){try{return _.getTree().then((e=>{const t=e[0].children.map((e=>e));return f(t)}))}catch(e){return Promise.reject(e)}}(),t=[{id:k,title:browser.i18n.getMessage("add_bookmark"),contexts:["page"]},{id:"current_folder",title:browser.i18n.getMessage("save_to_current_folder"),contexts:["page"],parentId:k},{id:"separator",type:"separator",contexts:["page"],parentId:k}],n=((e,t)=>{const n=["0"],r=browser.i18n.getMessage("btn_save"),o=(e,t)=>e.reduce(((e,s)=>(n.includes(s.parentId)||e.push({id:`save-${s.parentId}`,title:r,contexts:["page"],parentId:s.parentId},{id:`separator-${s.parentId}`,type:"separator",contexts:["page"],parentId:s.parentId}),n.push(s.parentId),e.push({id:s.id,title:s.title,contexts:["page"],parentId:t}),s.children?.length&&t&&e.push(...o(s.children,s.id)),e)),[]);return o(e,t)})(e,k);t.push(...n);for(let e of t)browser.contextMenus.create(e,(()=>{browser.runtime.lastError&&console.warn(browser.runtime.lastError?.message)}))},toggle(e){e?this.create():browser.contextMenus.removeAll((()=>{browser.runtime.lastError}))}},I=1170,D=720,x=(browser.i18n.getMessage("contextmenu_tab"),browser.i18n.getMessage("contextmenu_window"),browser.i18n.getMessage("contextmenu_incognito"),browser.i18n.getMessage("contextmenu_open_all"),browser.i18n.getMessage("contextmenu_open_all_window"),browser.i18n.getMessage("contextmenu_copy_link"),browser.i18n.getMessage("contextmenu_edit"),browser.i18n.getMessage("contextmenu_capture"),browser.i18n.getMessage("contextmenu_upload"),browser.i18n.getMessage("contextmenu_upload_paste"),browser.i18n.getMessage("delete_thumbnail"),browser.i18n.getMessage("contextmenu_remove"),["edge://newtab/","chrome://newtab/",browser.runtime.getURL("newtab.html")]),E=["edge://newtab/","chrome://newtab/","about:blank"],M=!0,L="1",S="toolbar_____";function C(e,t,n=[]){t=t||e,browser.notifications.create(t,{type:"basic",iconUrl:"icons/icon128.png",title:"Visual bookmarks",message:e,...!M&&{buttons:n}},(function(){}))}function O(e,t,n){let r=t||"",o=atob(e.split(",")[1]),s=new ArrayBuffer(o.length),a=new Uint8Array(s);for(let e=0;e<o.length;e++)a[e]=o.charCodeAt(e);let i=new Blob([s],{type:r});return n?n(i):i}async function T(e,t=500,n="high",r=.75){let o=await createImageBitmap(e);t&&o.height>t&&(o.close(),o=await createImageBitmap(e,{resizeHeight:t,resizeQuality:n}));const s=new OffscreenCanvas(o.width,o.height);return s.getContext("bitmaprenderer").transferFromImageBitmap(o),o.close(),s.convertToBlob({type:"image/webp",quality:r})}function j(){return`id${Math.floor(Math.random()*Date.now()).toString(36)}`}const A={local:{get:e=>browser.storage.local.get(e),set:e=>browser.storage.local.set(e),remove:e=>browser.storage.local.remove(e)},sync:{get:e=>browser.storage.sync.get(e),set:e=>browser.storage.sync.set(e),remove:e=>browser.storage.sync.remove(e)}},R=Object.freeze({color_theme:"os",background_image:"background_noimage",background_external:"",default_folder_id:M?S:L,dial_columns:7,dial_width:70,vertical_center:!1,drag_and_drop:!0,auto_generate_thumbnail:!0,enable_sync:!1,show_toolbar:!0,show_contextmenu_item:!0,show_settings_icon:!0,show_back_column:!0,show_create_column:!0,show_bookmark_title:!0,show_favicon:!0,open_link_newtab:!1,thumbnails_update_button:!0,thumbnails_update_recursive:!1,thumbnails_update_delay:.5,custom_style:"",without_confirmation:!1,services_enable:!1,services_list:[{id:j(),name:"youtube",link:"https://www.youtube.com"},{id:j(),name:"search",link:"https://google.com"},{id:j(),name:"translate",link:"https://translate.google.com"},{id:j(),name:"gmail",link:"https://mail.google.com/mail"},{id:j(),name:"drive",link:"https://drive.google.com/"},{id:j(),name:"photos",link:"https://photos.google.com"}],folder_preview:!1,close_tab_after_adding_bookmark:!1,logo_external:!1,logo_external_url:"https://logo.clearbit.com/{{website}}",search_engine:"bookmarks",move_to_start:!1,sort_by_date:!1,bookmarks_sorting_type:"",search_autofocus:!1,enable_virtual_pagination:!1}),V=["default_folder_id","enable_sync"],N=(()=>{let e={};return{get $(){return e},async init(){let{settings:t}=await A.local.get("settings");if(t?Object.assign(e,R,t):(t=Object.assign({},R),A.local.set({settings:t})),t.enable_sync){const{settings:e}=await A.sync.get("settings");Object.assign(t,e)}Object.assign(e,t)},async updateKey(t,n){if(!e)throw Error("Settings store must be initialized with the init method");e[t]=n,await A.local.set({settings:e}),e.enable_sync&&(V.includes(t)||this.syncToStorage())},async updateAll(t={}){Object.assign(e,t),await A.local.set({settings:e})},syncToStorage(){const t=JSON.parse(JSON.stringify(e));V.forEach((e=>delete t[e])),A.sync.set({settings:t})},async restoreFromSync(){let{settings:t}=await A.sync.get("settings");Object.assign(e,t),A.local.set({settings:e})},async resetLocal(){e=Object.assign({},R),await A.local.set({settings:e})},resetSync:()=>new Promise((e=>{browser.storage.sync.clear(e)}))}})();function P(){browser.tabs.query({currentWindow:!0},(function(e){for(let t of e)if(x.some((e=>t.url.startsWith(e))))return browser.tabs.update(t.id,{active:!0});return browser.tabs.create({url:browser.runtime.getURL("newtab.html")})}))}async function U(){const{settings:e}=await A.local.get("settings");B.init(e.show_contextmenu_item)}async function W(e,t){const{screen:n}=await A.local.get("screen");browser.windows.create({url:e,state:"normal",left:1e5,top:1e5,width:1,height:1,type:"popup"},(async function(e){let r=25e3;const{settings:o}=await A.local.get("settings"),s=1e3*(parseFloat(o.thumbnails_update_delay)||.5);if(s>500&&(r+=s),!e.tabs||!e.tabs.length)return browser.windows.remove(e.id),console.error("not found page"),!1;let a=e.tabs[0],i=!1;browser.tabs.update(a.id,{muted:!0});let c=setTimeout((function(){browser.windows.remove(e.id),t({error:"long_load",url:a.url}),i=!0}),r);!function r(){if(i)return clearTimeout(c),!1;browser.tabs.get(a.id,(function(o){"complete"===o.status?(browser.scripting.insertCSS({target:{tabId:a.id},css:"html, body { overflow-y: hidden !important; }"}),browser.windows.update(e.id,{left:n.availWidth-I,top:n.availHeight-D,width:I,height:D,focused:!0},(function(e){setTimeout((()=>{browser.tabs.captureVisibleTab(e.id,(function(n){t({capture:n,title:o.title});try{browser.windows.remove(e.id,(()=>{clearTimeout(c)}))}catch(e){}}))}),s)}))):setTimeout((()=>{r()}),300)}))}()}))}async function $(e,t,n){(n.url||n.node?.url)&&"moved"!==e||U();const r=(await browser.tabs.query({active:!0}))[0].url.replace(/#\d*/,"");if(x.includes(r))return;const{settings:o}=await A.local.get("settings"),s=()=>{browser.runtime.sendMessage({bookmarksUpdated:!0},(()=>{browser.runtime.lastError}))};if(["created","changed"].includes(e)&&o.auto_generate_thumbnail&&n.url){await async function({permissions:e,origins:t}){return await browser.permissions.contains({permissions:e,origins:t})}({origins:["<all_urls>"]})?async function(e,t,n){const{importingBookmarks:r}=await A.local.get("importingBookmarks");r||W(t.url,(async function(e){if(e.error)return n&&n();const r=O(e.capture,"image/webp"),o=await T(r);await p.update({id:t.id,blob:o,custom:!1}),n&&n()}))}(0,n,s):s()}else s();if("removed"===e){const e=[p.delete(t)];n.node.url||e.push(...y(n.node.children,!0).map((({id:e})=>p.delete(e)))),Promise.all(e)}}browser.storage.onChanged.addListener(((e,t)=>{if("local"===t&&e?.settings?.oldValue){const{show_contextmenu_item:t}=e.settings.newValue,{show_contextmenu_item:n}=e.settings.oldValue;t!==n&&B.toggle(t)}})),browser.runtime.onInstalled.addListener((async e=>{"install"===e.reason&&await N.init(),U(),"update"===e.reason&&A.local.set({extension_updated:!0})})),browser.bookmarks.onCreated.addListener(((e,t)=>$("created",e,t))),browser.bookmarks.onChanged.addListener(((e,t)=>$("changed",e,t))),browser.bookmarks.onRemoved.addListener(((e,t)=>$("removed",e,t))),browser.bookmarks.onMoved.addListener(((e,t)=>$("moved",e,t))),M||(browser.bookmarks.onImportBegan.addListener((()=>{A.local.set({importingBookmarks:!0})})),browser.bookmarks.onImportEnded.addListener((()=>{A.local.remove("importingBookmarks")}))),browser.contextMenus.onClicked.addListener((function(e){browser.tabs.query({active:!0,currentWindow:!0},(async function(t){const n=await function(e){try{return _.search(e)}catch(e){return Promise.reject(e)}}(e.pageUrl);if(!n)return;if(n.some((t=>t.url===e.pageUrl)))C(browser.i18n.getMessage("notice_bookmark_exist"));else{const{settings:n}=await A.local.get("settings"),r=e.menuItemId.replace("save-",""),o="current_folder"===r?String(n.default_folder_id):r;if(!await function(e){try{return _.create(e)}catch(e){return Promise.reject(e)}}({parentId:o,url:e.pageUrl,title:t[0].title}).catch((e=>{console.warn(e)})))return;n.close_tab_after_adding_bookmark&&browser.tabs.remove(t[0].id),C(browser.i18n.getMessage("notice_bookmark_created"))}}))})),browser.action.onClicked.addListener(P),browser.notifications.onClicked.addListener(P),browser.notifications.onButtonClicked.addListener((e=>{if("changelog"===e)return browser.tabs.create({url:browser.runtime.getURL("options.html#changelog")})})),browser.runtime.onMessage.addListener((function(e,t,n){if(e.capture){const{id:t,captureUrl:r}=e.capture;W(r,(async function(e){if(e&&e.error){try{n({warning:"Timeout waiting for a screenshot"})}catch(e){}return console.warn(`Timeout waiting for a screenshot ${e.url}`),!1}if(e&&void 0===e.capture){try{n({warning:"Cannot access contents of url"})}catch(e){}return console.warn(`Cannot access contents of url: ${r}`),!1}const o=O(e.capture,"image/webp"),s=await T(o);await p.update({id:t,blob:s,custom:!1});try{n("success")}catch(e){}}))}if(e.showContextMenuItem){const{checked:t}=e.showContextMenuItem;B.toggle(t)}return!0})),browser.tabs.onCreated.addListener((async function(e){const{settings:t}=await A.local.get("settings");t.search_autofocus&&E.includes(e.pendingUrl)&&(browser.tabs.create({url:browser.runtime.getURL("newtab.html")}),browser.tabs.remove(e.id))}))})();