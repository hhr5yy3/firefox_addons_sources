let grpClick2Talk,popupPort,extensionNamespace,loginArea,dialArea,addressInput,usernameInput,passwordInput,loginButton,usernameAbout,passwordAbout,passwordModeSet,loginTips,tipClose,loadEffect,deviceArea,deviceAccounts,selectAccount,changeSelectAccount,accountArrowSwitch,callButton,phoneNumber,lineDisplay,linesCount,logoutButton,searchResult,lineExpand,popupTip,settingNav,settingNavList,privacySettings,wordDialing,popupTipTimeoutEvent,contactSource,contactSourceLdap,contactSourceLocal,TIP_CLOSE_DELAY=3e3,initOuterWidth=456,initOuterHeight=540,initOuterHeight_Line_expand=690;function setDomBindingEvent(){document.getElementsByClassName("address-error-tip")[0].innerText=currentLocale.L6,document.getElementsByClassName("password-error-tip")[0].innerText=currentLocale.L4,document.getElementsByClassName("dial-title")[0].innerText=currentLocale.L49,document.getElementsByClassName("copyright")[0].innerText=currentLocale.L26.replace("{0}",(new Date).getFullYear()),console.log("set dom binding event"),loginArea=document.getElementsByClassName("login-container")[0],addressInput=document.getElementById("address"),usernameInput=document.getElementById("username"),passwordInput=document.getElementById("password"),addressInput.addEventListener("input",handleInputStyle),addressInput.placeholder=currentLocale.L15,addressInput.addEventListener("blur",addressCheck),usernameInput.addEventListener("input",handleInputStyle),passwordInput.addEventListener("input",handleInputStyle),passwordInput.placeholder=currentLocale.L16,passwordModeSet=document.getElementById("passwordModeSet"),passwordModeSet.addEventListener("click",(function(e){return"password"===passwordInput.type?(passwordInput.type="text",passwordModeSet.classList.remove("eyes-icon-invisible"),passwordModeSet.classList.add("eyes-icon-visible")):(passwordInput.type="password",passwordModeSet.classList.remove("eyes-icon-visible"),passwordModeSet.classList.add("eyes-icon-invisible")),!1})),loginButton=document.getElementById("login"),loginButton.value=currentLocale.L9,loginButton.addEventListener("click",login),loginTips=document.getElementsByClassName("login-tips")[0],loadEffect=document.getElementsByClassName("loadEffect")[0],dialArea=document.getElementsByClassName("dialArea")[0],deviceArea=document.getElementsByClassName("account-list")[0],deviceAccounts=document.getElementsByClassName("device-account-list")[0],selectAccount=document.getElementsByClassName("select-account-words")[0],changeSelectAccount=document.getElementsByClassName("change-select-account")[0],changeSelectAccount.addEventListener("click",setAccountsDisplay),accountArrowSwitch=document.getElementsByClassName("account-arrow-down")[0],selectAccount.addEventListener("mousemove",selectAccountMousemoveHandler),callButton=document.getElementById("normalCall"),callButton.value=currentLocale.L24,callButton.addEventListener("click",call),phoneNumber=document.getElementById("phoneNumber"),phoneNumber.placeholder=currentLocale.L23,phoneNumber.addEventListener("input",searchForContacts),phoneNumber.addEventListener("focus",(function(){this.placeholder=""})),phoneNumber.addEventListener("blur",(function(){this.placeholder=currentLocale.L23})),phoneNumber.addEventListener("keyup",(function(e){if(e.preventDefault(),13===e.keyCode){if(!document.getElementsByClassName("number-input-text")[0]){let e=document.getElementsByClassName("menu-number")[0];e&&e.innerText&&(phoneNumber.value=e.innerText)}searchResult.style.display="none";let t=e.target.value.trim();t&&(console.log("start call number:",t),call())}})),lineDisplay=document.getElementsByClassName("lines-display")[0],linesCount=document.getElementsByClassName("line-count")[0],linesCount.setAttribute("dataBefore",currentLocale.L27),logoutButton=document.getElementsByClassName("logout")[0],logoutButton.addEventListener("click",doLogout),searchResult=document.getElementsByClassName("search-result")[0],lineExpand=document.getElementsByClassName("line-expand")[0],lineExpand.addEventListener("click",lineExpandClick),popupTip=document.getElementsByClassName("popup-tips")[0],settingNav=document.getElementById("setting-nav"),settingNavList=document.querySelector(".setting-nav-list"),settingNav.addEventListener("click",(function(){console.log("settingNavList.style.displayï¼š",settingNavList.style.display),"none"===settingNavList.style.display?settingNavList.style.display="block":settingNavList.style.display="none"})),document.querySelector(".privacy-settings-tip").innerText=currentLocale.L17,document.querySelector(".word-dialing-tip").innerText=currentLocale.L18,document.querySelector(".contact-source-tip").innerText=currentLocale.L150,document.querySelector(".contact-source-ldap-tip").innerText=currentLocale.L151,document.querySelector(".contact-source-local-tip").innerText=currentLocale.L152,privacySettings=document.getElementById("privacy-settings"),privacySettings.addEventListener("click",(function(){console.log("privacySettings.checked:",privacySettings.checked),privacySettings.checked?(console.log("enable security."),grpClick2Talk.keepUserInfo=!1,popupSendMessage2Background({cmd:"userDataControl",data:{keep:!1}})):(console.log("disable security."),grpClick2Talk.keepUserInfo=!0,popupSendMessage2Background({cmd:"userDataControl",data:{keep:!0}}))})),wordDialing=document.getElementById("word-dialing"),wordDialing.addEventListener("click",(function(){wordDialing.checked?console.log("enable word dialing."):console.log("disable word dialing."),grpClick2Talk.wordDialingEnabled=wordDialing.checked,popupSendMessage2Background({cmd:"setWordDialing",data:{wordDialing:grpClick2Talk.wordDialingEnabled}})})),contactSource=document.getElementById("contact-source"),contactSourceLdap=document.getElementById("contact-source-ldap"),contactSourceLocal=document.getElementById("contact-source-local"),contactSource.addEventListener("click",(function(){contactSource.checked?(console.log("enable word dialing."),contactSourceLdap.checked=!0,contactSourceLocal.checked=!0,grpClick2Talk.contactSearchFrom.ldap=!0,grpClick2Talk.contactSearchFrom.localAddressBook=!0):(console.log("disable word dialing."),contactSourceLdap.checked=!1,contactSourceLocal.checked=!1,grpClick2Talk.contactSearchFrom.ldap=!1,grpClick2Talk.contactSearchFrom.localAddressBook=!1),updateContactSource()})),contactSourceLdap.addEventListener("click",(function(){console.log("contactSourceLdap.checked:",contactSourceLdap.checked),grpClick2Talk.contactSearchFrom.ldap=contactSourceLdap.checked,updateContactSource()})),contactSourceLocal.addEventListener("click",(function(){console.log("contactSourceLocal.checked:",contactSourceLocal.checked),grpClick2Talk.contactSearchFrom.localAddressBook=contactSourceLocal.checked,updateContactSource()}))}function setConfigurationItems(){console.log("set configuration items"),privacySettings.checked=!grpClick2Talk.keepUserInfo,wordDialing.checked=grpClick2Talk.wordDialingEnabled,contactSourceLdap.checked=grpClick2Talk.contactSearchFrom.ldap,contactSourceLocal.checked=grpClick2Talk.contactSearchFrom.localAddressBook,contactSource.checked=!(!contactSourceLocal.checked&&!contactSourceLdap.checked)}function updateContactSource(){contactSource.checked=!(!contactSourceLocal.checked&&!contactSourceLdap.checked),popupSendMessage2Background({cmd:"setContactSearch",data:{ldap:grpClick2Talk.contactSearchFrom.ldap,localAddressBook:grpClick2Talk.contactSearchFrom.localAddressBook}})}function handleInputStyle(e){if(e&&e.target&&e.target.classList.length&&(e.target.classList.remove("login-input-error"),e.target.classList.add("login-input-ordinary"),e.target.parentNode)){let t=e.target.parentNode.getElementsByClassName("error-tip")[0];if(t){let n=e.target.value;n&&n.indexOf("https://")>=0?(t.innerText=currentLocale.L98,t.style.display="block",loginButton.disabled=!0):(t.innerText="",t.style.display="none",loginButton.disabled=!1)}}}function addressCheck(e){console.log(e.target.value),e&&e.target&&e.target.value&&(IPFormatLegal(e.target.value)||showAddressErrorTip(currentLocale.L25))}function setLoginTips(e,t,n){let o="";switch(e){case"CLOSE":loginTips.style.opacity=0;break;case"SUCCESS":o="login-success-tip";break;case"VERIFICATION":o="login-verification-tip";break;case"UNAUTHORIZED":o="login-unauthorized-tip";break;case"TIMEOUT":case"ERROR":case"SyntaxError":o="login-error-tip"}if(o){let a=currentLocale[t];"L12"===t&&(a=n?a.replace("{0}",n):a.split(".")[0]),loginTips.innerHTML="";let l=document.createElement("div");if(l.className=o,l.style.display="block","VERIFICATION"===e){let e=document.createElement("span");e.innerText=a,l.appendChild(e);let t=document.createElement("span");t.className="login-verification-tip-close",t.onclick=function(){setLoginTips("CLOSE","L21")},l.appendChild(t)}else l.innerText=a;loginTips.appendChild(l),loginTips.style.opacity=1}loginButton.value=currentLocale.L9,loadEffect.style.display="none","none"!==loginArea.style.display||grpClick2Talk.isLogin||(console.log("[EXT] login status change, login false"),switchDisplayPage(grpClick2Talk.isLogin,grpClick2Talk.loginData),deviceAccounts.innerHTML="",selectAccount.innerText="",selectAccount.setAttribute("accountId",""))}function setLoginFromData(e){if(e.url)if(e.url.indexOf("/addon")>0){let t=e.url.split("/addon");addressInput.value=t[0]}else addressInput.value=e.url;e.username&&(usernameInput.value=e.username),e.password&&(passwordInput.value=e.password),e.url||e.username||e.password||(console.log("Set default user account."),usernameInput.value="addons")}function isPreSelectAccountActive(e){let t=!1;for(let n=0;n<e.length;n++)if(1===parseInt(e[n].reg)&&parseInt(e[n].id)===parseInt(grpClick2Talk.loginData.selectedAccountId)){t=!0;break}return console.log("pre select account active ? ",t),t}function setDeviceAccountList(e){if(console.log("set device account list:",e),!e)return;let t=document.getElementsByClassName("change-icon-txt")[0],n=!1,o=null,a=document.createDocumentFragment();for(let e=deviceAccounts.children.length-1;e>=0;e--){let t=deviceAccounts.children[e];deviceAccounts.removeChild(t)}e.length&&(isPreSelectAccountActive(e)||updateSelectedAccountId(""),function(){for(let t=0;t<e.length;t++){let l=e[t],s=parseInt(l.id),c=l.name,i=l.sip_id,r=l.id,d="account"+s,u=null,p=document.createElement("li").cloneNode(!0);p.setAttribute("accountId",r),p.setAttribute("accountType",l.auto_cfg),p.setAttribute("sipId",i),p.setAttribute("name",c),p.className="device-account "+d,p.onclick=switchAccount;let g=document.createElement("div").cloneNode(!0);g.className="change-icon-parent GRP-icon-person",g.setAttribute("sipId",i),g.setAttribute("accountId",r),g.setAttribute("name",c),g.setAttribute("accountType",l.auto_cfg);let m=document.createElement("div").cloneNode(!0);m.className="change-icon-txt",m.setAttribute("sipId",i),m.setAttribute("accountId",r),m.setAttribute("accountType",l.auto_cfg),m.setAttribute("name",c),m.textContent=r,g.appendChild(m),p.appendChild(g);let h=document.createElement("span").cloneNode(!0);h.className=`accountContentWrap account_${c}_${i}`,h.setAttribute("accountId",r),h.setAttribute("accountType",l.auto_cfg),h.setAttribute("sipId",i),h.textContent=`${c} (${i})`,h.onmousemove=mousemoveHandle,p.appendChild(h),a.appendChild(p),u=p,1===parseInt(l.reg)&&(n=!0,u.style.display="flex",u.setAttribute("sipid",i),u.setAttribute("accountType",l.auto_cfg),o||(o=u)),t===e.length-1&&deviceAccounts.appendChild(a)}}(),!grpClick2Talk.loginData.selectedAccountId&&o&&updateSelectedAccountId(o.getAttribute("accountid")));for(let e=0;e<deviceAccounts.children.length;e++){let n=deviceAccounts.children[e],o=n.getAttribute("accountId");if(parseInt(o)===parseInt(grpClick2Talk.loginData.selectedAccountId)){t&&(t.textContent=grpClick2Talk.loginData.selectedAccountId),n.lastChild&&n.lastChild.classList.add("device-account-active");let e=n.getAttribute("sipid"),a=n.getAttribute("name");selectAccount.innerText=`${a} (${e})`,selectAccount.setAttribute("accountType",n.getAttribute("accountType")),selectAccount.setAttribute("accountId",o)}else n.lastChild&&n.lastChild.classList.remove("device-account-active")}setSelectAccount(n)}function setSelectAccount(e){e?(changeSelectAccount.style.display="flex",popupTip.innerHTML="",popupTip.classList.remove("popup-tips-opacity-1"),popupTip.classList.add("popup-tips-opacity-0"),callButton.disabled=!1,callButton.style.backgroundColor="#27CA15"):(changeSelectAccount.style.display="none",callButton.disabled=!0,callButton.style.backgroundColor="#c5c5c5",1===grpClick2Talk.websocketStatus&&showPopupTip("L19"))}function setAccountsDisplay(){console.log("deviceAccounts display:",deviceAccounts.style.display),"flex"===deviceAccounts.style.display?(deviceAccounts.style.display="none",accountArrowSwitch.style.backgroundImage='url("./assets/arrow_down.svg")'):(deviceAccounts.style.display="flex",accountArrowSwitch.style.backgroundImage='url("./assets/arrow_up.svg")')}function selectAccountMousemoveHandler(e){if(!e||!e.target)return;let t=e.target,n=t.offsetWidth;t.scrollWidth>n&&(t.title=t.textContent,t.classList.add("select-account-words_hover"))}function switchAccount(e){if(!e||!e.target)return;let t=e.target.getAttribute("accountId"),n=e.target.getAttribute("sipId"),o=document.getElementsByClassName("device-account");document.getElementsByClassName("change-icon-txt")[0].textContent=t;for(let a=0;a<o.length;a++){let l=o[a],s=l.getAttribute("name");l.getAttribute("accountId")===t?(l.classList.add("device-account-active"),l.lastChild&&l.lastChild.classList.add("device-account-active"),selectAccount.innerText=`${s} (${n})`,selectAccount.classList.contains("select-account-words_hover")&&(selectAccount.classList.remove("select-account-words_hover"),selectAccount.setAttribute("title","")),selectAccount.setAttribute("accountType",e.target.getAttribute("accountType")),selectAccount.setAttribute("accountId",t)):(l.classList.remove("device-account-active"),l.lastChild&&l.lastChild.classList.remove("device-account-active"))}updateSelectedAccountId(t),setAccountsDisplay()}function mousemoveHandle(e){if(!e||!e.target)return;if(!e.target.classList.contains("accountContentWrap"))return;let t=e.target,n=t.offsetWidth;t.scrollWidth>n&&(t.title=t.textContent)}function updateSelectedAccountId(e){grpClick2Talk.loginData.selectedAccountId=e,console.log("update selected accountId: ",e),popupSendMessage2Background({cmd:"setSelectedAccount",data:{accountId:e}})}function updateLineStatus(e){if(!e)return;let t=0,n=0,o=!1;for(let a=0;a<e.length;a++){let l=e[a],s="line"+l.line,c=lineDisplay.getElementsByClassName(s)[0];if("idle"!==l.state){if(t++,l.conf?o||(n++,o=!0):n++,c)c.children[0].innerHTML=`<span class="active-line_label">${Number(l.acct)+1}</span><div class="active-line_text">${l.remotename}</div>`,c.children[1].textContent=l.remotenumber,c.children[2].textContent=l.state,c.replaceChild(createCallBtn(l),c.children[3]);else{let e=document.createElement("ul");e.className="active-line "+s,t>3&&"firefox"!==getBrowserDetail().browser&&(e.className=e.className+" active-line-hide");let n=document.createElement("li");n.innerHTML=`<span class="active-line_label">${Number(l.acct)+1}</span><div class="active-line_text">${l.remotename}</div>`;let o=document.createElement("li");o.textContent=l.remotenumber;let a=document.createElement("li");a.textContent=l.state,e.appendChild(n),e.appendChild(o),e.appendChild(a),e.appendChild(createCallBtn(l)),lineDisplay.appendChild(e)}let e=lineDisplay.getElementsByClassName(s)[0].children[2];if("onhold"===l.state?(e.textContent="OnHold",e.style.color="#F8B222",lineDisplay.getElementsByClassName(s)[0].style.borderColor="#E1E3E6",lineDisplay.getElementsByClassName(s)[0].style.boxShadow="none"):"connected"===l.state?(e.style.color="#C5C5C5",lineDisplay.getElementsByClassName(s)[0].style.borderColor="#27CA15",lineDisplay.getElementsByClassName(s)[0].style.boxShadow="0 0 7px 0 #00000066"):(e.style.color="#C5C5C5",lineDisplay.getElementsByClassName(s)[0].style.borderColor="#E1E3E6",lineDisplay.getElementsByClassName(s)[0].style.boxShadow="none"),c&&c.children.length){let e=c.children[0];e.scrollWidth>e.clientWidth?e.title=l.remotenumber:delete e.title}}else c&&lineDisplay.removeChild(c)}let a=currentLocale.L28+" "+n+"/"+grpClick2Talk.maxLinesNum;linesCount.setAttribute("dataBefore",a),t>=4?(lineExpand.style.display="block","firefox"!==getBrowserDetail().browser?(lineExpand.classList.remove("GRP-icon-arrow_double_up"),lineExpand.classList.add("GRP-icon-arrow_double_down")):(lineExpand.classList.remove("GRP-icon-arrow_double_down"),lineExpand.classList.add("GRP-icon-arrow_double_up"))):lineExpand.style.display="none"}function lineExpandClick(){let e=lineDisplay.getElementsByTagName("ul");if(e.length&&e.length>=4){let t;lineExpand.classList.contains("GRP-icon-arrow_double_down")?(lineExpand.classList.remove("GRP-icon-arrow_double_down"),lineExpand.classList.add("GRP-icon-arrow_double_up"),t=!1):(lineExpand.classList.remove("GRP-icon-arrow_double_up"),lineExpand.classList.add("GRP-icon-arrow_double_down"),t=!0);for(let n=3;n<e.length;n++)e[n].style.display=t?"none":"block";t?window.resizeTo(window.outerWidth,initOuterHeight):window.resizeTo(window.outerWidth,initOuterHeight_Line_expand)}}function handleWindowResize(){let e=window.outerHeight,t=lineDisplay.getElementsByTagName("ul");if(t.length>3){let n="";e<initOuterHeight_Line_expand?(n="none",lineExpand.classList.remove("GRP-icon-arrow_double_up"),lineExpand.classList.add("GRP-icon-arrow_double_down")):(n="block",lineExpand.classList.remove("GRP-icon-arrow_double_down"),lineExpand.classList.add("GRP-icon-arrow_double_up"));for(let e=3;e<t.length;e++)t[e].style.display=n}}async function getLocalStorage(){return grpClick2Talk.phoneBooks=await(async e=>new Promise(((t,n)=>{extensionNamespace.storage.local.get([e],(function(o){if(void 0===o[e])n();else{let n=JSON.parse(o[e]);t(n)}}))})))("phoneBooks"),grpClick2Talk.phoneBooks}async function getPhoneBookArray(){let e={ldap:[],localAddressBook:[]};if(!grpClick2Talk.contactSearchFrom.ldap&&!grpClick2Talk.contactSearchFrom.localAddressBook)return console.log("contacts disabled"),e;let t=await getLocalStorage();return t&&(grpClick2Talk.contactSearchFrom.ldap&&t.ldap&&t.ldap.length&&"timeout"!==t.ldap[0]&&(e.ldap=t.ldap),grpClick2Talk.contactSearchFrom.localAddressBook&&t.localAddressBook&&t.localAddressBook.length&&(e.localAddressBook=t.localAddressBook)),e}function addHighlightSpan(e,t,n){let o=t;if(e=e?.toLowerCase(),t=t?.toLowerCase(),new RegExp(e,"g").test(t)){let a=document.createElement("span");a.className="search-highlight";let l=t.indexOf(e),s=o.substring(0,l),c=o.substring(l,l+e.length),i=o.substring(l+e.length);if(s){let e=document.createElement("span");e.textContent=s,n.appendChild(e)}if(a.textContent=c,n.appendChild(a),i){let e=document.createElement("span");e.textContent=i,n.appendChild(e)}}else n.textContent=t}function valueMatchAndHighlight(e,t){let n,o=e.email||e.Mail;"AccountNumber"in e?n=e.AccountNumber:"Phone"in e&&(n=getPhoneNumber(e,t));let{fullName:a,chineseFullName:l}=getFullName(e);if(l?.includes(t)&&(a=l),n){let e=document.createElement("div");e.className="result-menu";let l=document.createElement("div");l.className="menu-info";let s=document.createElement("div");s.className="menu-name";let c=document.createElement("div");if(c.className="menu-number",addHighlightSpan(t,n,c),addHighlightSpan(t,a,s),l.appendChild(s),l.appendChild(c),o){let e=document.createElement("div");e.className="menu-mail",addHighlightSpan(t,o,e),l.appendChild(e)}e.appendChild(l),e.onclick=function(){console.log("click change phoneNumber, ",n),phoneNumber.value=n,searchResult.style.display="none"},e.addEventListener("mousedown",(function(){console.log("mousedown change phoneNumber, ",n),phoneNumber.value=n,searchResult.style.display="none"})),searchResult.style.display="block",searchResult.appendChild(e)}}function isChinese(e){return/^[\u4E00-\u9FA5]+$/.test(e)}function isNumber(e){return/^\d+$/.test(e)}function getFullName(e){let t="",n="";return e.CallerIDName||e.calleridname?(t=e.CallerIDName||e.calleridname,isChinese(t[0])&&t.indexOf(" ")>-1&&(n=t?.split(" ").reverse().join("").replace(/[ ]/g,""))):(e.FirstName||e.LastName)&&(e.FirstName&&e.LastName?(t=e.FirstName+" "+e.LastName,isChinese(e.FirstName.split("")[0])&&(n=e.LastName+e.FirstName)):t=e.FirstName||e.LastName),{fullName:t.toString().trim(),chineseFullName:n.toString().trim()}}function getPhoneNumber(e,t){let n;if("AccountNumber"in e)n=e.AccountNumber;else if("Phone"in e)if("[object Object]"===Object.prototype.toString.call(e.Phone))n=e.Phone.phonenumber;else if("[object Array]"===Object.prototype.toString.call(e.Phone)){let o="";for(let a=0;a<e.Phone.length;a++){let l=e.Phone[a].phonenumber;if(l){if(l.toLowerCase().indexOf(t)>-1){n=l;break}o||(o=l)}}n||(n=o)}return n}function numberMatch(e,t){let n;if("[object Object]"===Object.prototype.toString.call(e.Phone))e.Phone.phonenumber?.includes(t)&&(n=e.Phone.phonenumber);else if("[object Array]"===Object.prototype.toString.call(e.Phone))for(let o=0;o<e.Phone.length;o++)if(e.Phone[o].phonenumber?.includes(t)){n=e.Phone[o].phonenumber;break}return n}let searchKeys=["AccountNumber","CallerIDName","email","FirstName","LastName","Phone","Mail","calleridname"];async function searchForContacts(){document.querySelector("div.number-from").style.display="none";let e=phoneNumber.value;if(e&&e.trim&&(e=e.trim()),!e)return void(searchResult.innerHTML="");if(searchResult.innerHTML="",isNumber(e)){let t=document.createElement("div");t.className="result-menu result-menu-select phone-number-text",t.innerHTML='<div class="number-input-text">'+e+"</div>",t.onclick=function(){phoneNumber.value=e,searchResult.style.display="none"},searchResult.appendChild(t)}let t=!1,n=!1;e=e.toLowerCase();let o=new RegExp("-","g");e=e.replace(o,"");let a=await getPhoneBookArray();if(a.ldap.length)for(let o=0;o<a.ldap.length;o++){let l=a.ldap[o],{fullName:s,chineseFullName:c}=getFullName(l),i=s?.toLowerCase();c=c?.toLowerCase();let r=l.email||l.Mail;(l?.AccountNumber?.includes(e)||i?.includes(e)||c?.includes(e)||r?.includes(e))&&(valueMatchAndHighlight(l,e),l?.AccountNumber===e&&(n=!0),t=!0)}if(a.localAddressBook.length)for(let o=0;o<a.localAddressBook.length;o++){let l=a.localAddressBook[o],{fullName:s,chineseFullName:c}=getFullName(l);s=s?.toLowerCase(),c=c?.toLowerCase();let i=l.email||l.Mail;(s?.includes(e)||c?.includes(e)||i?.includes(e)||numberMatch(l,e))&&(valueMatchAndHighlight(l,e),numberMatch(l,e)===e&&(n=!0),t=!0)}if(t){if(n){let e=document.getElementsByClassName("phone-number-text")[0];e&&(e.style.display="none")}}else searchResult.style.display="none"}function switchDisplayPage(e,t){console.log("[EXT] already login "+e),e?(loginArea.style.display="none",dialArea.style.display="block",setDeviceAccountList(t.accountLists),!1!==grpClick2Talk.keepUserInfo||privacySettings.classList.contains("security-enabled")||(console.log("set security enabled"),privacySettings.classList.add("security-enabled")),autoFillNumber()):(dialArea.style.display="none",loginArea.style.display="block",t&&setLoginFromData(t))}function showPopupTip(e,t,n){if(!e)return;popupTip||(popupTip=document.getElementsByClassName("popup-tips")[0]);let o=popupTip.classList;for(let e=0;e<o.length;e++)"popup-tips"!==o[e]&&popupTip.classList.remove(o[e]);n&&popupTip.classList.add(n),popupTip.textContent=currentLocale[e],popupTip.classList.remove("popup-tips-opacity-0"),popupTip.classList.add("popup-tips-opacity-1"),t&&(popupTipTimeoutEvent&&(clearTimeout(popupTipTimeoutEvent),popupTipTimeoutEvent=null),popupTipTimeoutEvent=setTimeout((function(){popupTip.innerHTML=null,popupTip.classList.remove("popup-tips-opacity-1"),popupTip.classList.add("popup-tips-opacity-0"),n&&popupTip.classList.remove(n)}),TIP_CLOSE_DELAY))}function IPFormat(e){return e.indexOf("://")>=0&&(e=e.split("://")[1]),e.indexOf("[")>=0&&(e=e.split("[")[1]),e.indexOf("]")>=0&&(e=e.split("]")[0]),e.indexOf(".local")>=0&&(e=e.split(".local")[0]),e}function IPFormatLegal(e){return IPV4(e)||IPV6(e)||Mac(e)}function cleanMACAddress(e){return e.replace(/[^0-9a-fA-F]/g,"")}function Mac(e){let t=/^([A-Fa-f0-9]{2}[-,_:]){5}[A-Fa-f0-9]{2}(:\d{1,5})?$/,n=(e=IPFormat(e)).match(t);return n||(t=/^[A-Fa-f0-9]{12}$/,n=e.match(t)),n}function IPV4(e){return(e=IPFormat(e)).match(/^((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)(:\d{1,5})?$/)}function IPV6(e){return(e=IPFormat(e)).match(/^([\da-fA-F]{1,4}:){6}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$|^::([\da-fA-F]{1,4}:){0,4}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$|^([\da-fA-F]{1,4}:):([\da-fA-F]{1,4}:){0,3}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$|^([\da-fA-F]{1,4}:){2}:([\da-fA-F]{1,4}:){0,2}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$|^([\da-fA-F]{1,4}:){3}:([\da-fA-F]{1,4}:){0,1}((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$|^([\da-fA-F]{1,4}:){4}:((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$|^([\da-fA-F]{1,4}:){7}[\da-fA-F]{1,4}$|^:((:[\da-fA-F]{1,4}){1,6}|:)$|^[\da-fA-F]{1,4}:((:[\da-fA-F]{1,4}){1,5}|:)$|^([\da-fA-F]{1,4}:){2}((:[\da-fA-F]{1,4}){1,4}|:)$|^([\da-fA-F]{1,4}:){3}((:[\da-fA-F]{1,4}){1,3}|:)$|^([\da-fA-F]{1,4}:){4}((:[\da-fA-F]{1,4}){1,2}|:)$|^([\da-fA-F]{1,4}:){5}:([\da-fA-F]{1,4})?$|^([\da-fA-F]{1,4}:){6}:(:\d{1,5})?$/)}function showAddressErrorTip(e){addressInput.classList.remove("login-input-ordinary"),addressInput.classList.add("login-input-error");let t=document.getElementsByClassName("address-error-tip")[0];t.innerText=e,t.style.display="block"}function login(){console.log("[EXT] login"),setLoginTips("CLOSE");let e=addressInput.value,t=usernameInput.value,n=passwordInput.value;if(e.trim&&(e=e.trim()),t.trim&&(t=t.trim()),n.trim&&(n=n.trim()),e)if(IPFormatLegal(e)){if(!n)return passwordInput.classList.remove("login-input-ordinary"),passwordInput.classList.add("login-input-error"),void(document.getElementsByClassName("password-error-tip")[0].style.display="block");IPV6(e)&&(e="["+IPV6(e)[0]+"]"),Mac(e)&&(e=cleanMACAddress(Mac(e)[0])+".local"),popupSendMessage2Background({cmd:"popupUpdateLoginInfo",data:{url:e,username:t,password:n}}),loginButton.value=null,loadEffect.style.display="block"}else showAddressErrorTip(currentLocale.L25);else showAddressErrorTip(currentLocale.L6)}function doLogout(){popupSendMessage2Background({cmd:"accountLogout"}),grpClick2Talk.isLogin=!1,grpClick2Talk.websocketStatus=0,grpClick2Talk.phoneBooks={},switchDisplayPage(grpClick2Talk.isLogin,grpClick2Talk.loginData),deviceAccounts.innerHTML="",selectAccount.innerText="",phoneNumber.value="",popupTip.innerHTML="",popupTip.classList.remove("popup-tips-opacity-1"),popupTip.classList.add("popup-tips-opacity-0"),selectAccount.setAttribute("accountId",""),document.querySelector("div.number-from").style.display="none",console.log("keep user info when logout:",grpClick2Talk.keepUserInfo),grpClick2Talk.keepUserInfo||(console.log("clear input..."),addressInput.value="",passwordInput.value="",grpClick2Talk.keepUserInfo=!0,grpClick2Talk.wordDialingEnabled=!0,grpClick2Talk.contactSearchFrom.ldap=!0,grpClick2Talk.contactSearchFrom.localAddressBook=!0,setConfigurationItems()),window.resizeTo(window.outerWidth,initOuterHeight)}function call(){let e=phoneNumber.value;console.log("[EXT] call number ",e),e?(e.trim&&(e=e.trim()),phoneNumber.classList.remove("warning"),popupSendMessage2Background({cmd:"popupMakeCall",data:{accountId:selectAccount.getAttribute("accountId"),phonenumber:e}})):showPopupTip("L20",!0)}function updateLoginStatus(e){if(e.grpClick2TalObj&&(grpClick2Talk=e.grpClick2TalObj,extensionNamespace.storage.local.get("phoneBooks",(function(e){e&&e.phoneBooks&&(grpClick2Talk.phoneBooks=JSON.parse(e.phoneBooks),console.log("[EXT] get phone book!",grpClick2Talk.phoneBooks))})),setConfigurationItems()),e&&e.data)if(e.data.response)switch(e.data.response){case"unauthorized":console.log("[EXT] login unauthorized."),setLoginTips("UNAUTHORIZED","L14");break;case"success":console.log("[EXT] login success."),setLoginTips("SUCCESS","L22"),setTimeout((function(){console.log("[EXT] close tip"),setLoginTips("CLOSE","L21"),switchDisplayPage(grpClick2Talk.isLogin,grpClick2Talk.loginData)}),500);let{ver:t}=e.data.body;t&&t.split(".")[2]<4&&(console.log(`[EXT]The current version ${t} does not support connecting to websockets. Please upgrade the version`),setTimeout((function(){showPopupTip("L100",!0)}),500));break;case"failed":setLoginTips("ERROR","L13");break;case"defaultLoginNotAllow":console.log("Your password is currently the initial password. Please go to WebUI to change your password and log in again."),setLoginTips("ERROR","DEFAULT_AUTH_PWD");break;case"requestTimeout":console.log("[EXT] request timeout."),setLoginTips("TIMEOUT","L10");break;case"SyntaxError":let n;console.log("[EXT] SyntaxError",e.data.message),n=e.data.body&&e.data.body.split&&e.data.body.split("wrong")[1],setLoginTips("SyntaxError","L12",n);break;default:if(console.log("[EXT] login error.",e.data),e.data.body&&"locked"===e.data.body)setLoginTips("ERROR","L101");else if(e.data.response.url&&e.data.response.url.indexOf("cgi-bin/access")>=0&&403===e.data.response.status)setLoginTips("ERROR","L48");else{let t=e.data.body&&e.data.body.split&&e.data.body.split("wrong")[1];t?setLoginTips("ERROR","L12",t):setLoginTips("ERROR","L13")}}else e.data.body&&"user is not allow"===e.data.body&&setLoginTips("ERROR","USER_WEB_ACCESS_DISABLED")}function operateLine(e){if(!e||!e.target)return;let t=e.target.getElementsByClassName("line")[0];if(t&&t.value){let n="";e.target.className.indexOf("accept")>=0?n="acceptcall":e.target.className.indexOf("hold")>=0?n="holdcall":e.target.className.indexOf("unHold")>=0?n="unhold":e.target.className.indexOf("end")>=0&&(n="ringing"===t.callType?"rejectcall":"calling"===t.callType?"cancel":"endcall"),console.log("[EXT] operateLine line "+t.value+" type "+n+" callType "+t.callType),popupSendMessage2Background({cmd:"popupLineOperation",type:n,lineId:t.value})}else console.log("operateLine: [EXT] not get correct line id")}function createInput(e){let t=document.createElement("input");return t.className="line",t.style.display="none",t.type="text",t.value=e.line,t.callType=e.state,t}function createCallBtn(e){let t=document.createElement("li"),n=document.createElement("span");n.className="end callKey",n.onclick=operateLine,n.appendChild(createInput(e));let o=document.createElement("span");return o.appendChild(createInput(e)),o.onclick=operateLine,"ringing"===e.state?(o.className="accept callKey",t.appendChild(o)):"connected"===e.state?(o.className="hold callKey",t.appendChild(o)):"onhold"===e.state&&(o.className="unHold callKey",t.appendChild(o)),t.appendChild(n),t}function guideToEnableClickToDial(e){console.info("Click-To-Dial Feature is not enabled");let t=grpClick2Talk.loginData.url.split("/addon")[0]+"/phset/call/outgoing",n=currentLocale.L1004.replace("{0}",t);!0===confirm(n)?window.open(t,"_blank"):(console.log('refuse enable "Click-To-Dial Feature".'),confirm(currentLocale.L1003))}function handleBackgroundMessage(e){if(e)switch(e=JSON.parse(e),console.log("handle background message cmd:",e.cmd,"; data: ",e.data),e.cmd){case"popupShowConfig":console.log("set popup config of click2Talk "),grpClick2Talk=e.grpClick2TalObj,switchDisplayPage(grpClick2Talk.isLogin,grpClick2Talk.loginData),extensionNamespace.storage.local.get("phoneBooks",(function(e){e&&e.phoneBooks&&(grpClick2Talk.phoneBooks=JSON.parse(e.phoneBooks),console.log("[EXT] get phone book!",grpClick2Talk.phoneBooks))})),setConfigurationItems();break;case"loginStatus":updateLoginStatus(e);break;case"clickToDialDisabled":guideToEnableClickToDial(e);break;case"updateAccountLists":e.accountLists?(grpClick2Talk.loginData.accountLists=e.accountLists,setDeviceAccountList(e.accountLists)):console.log("[EXT] no account.");break;case"setLineStatus":e.lines&&updateLineStatus(e.lines),e.maxLinesNum&&(console.log("save max lines num ",e.maxLinesNum),grpClick2Talk.maxLinesNum=e.maxLinesNum);break;case"setMaxLinesNum":console.log("set max lines num: ",e.maxLinesNum),grpClick2Talk.maxLinesNum=e.maxLinesNum;break;case"makeCallCallback":console.log("makeCallCallback msg:",e),"Invalid Request"===e.data||e.data&&"failed"===e.data.response?showPopupTip("L1001",!0):2===e.data.code?showPopupTip("L102",!0):8===e.data.code&&showPopupTip("L103",!0);break;case"websocketStatus":setWebsocketStatus(e)}}function setWebsocketStatus(e){e&&e.data&&(console.log("websocket status:",e.data),999===e.data.code?(console.log("[EXT] webSocket success"),1===e.data.status?showPopupTip("L46",!0,"success-tips"):(popupTip.classList.remove("popup-tips-opacity-1"),popupTip.classList.add("popup-tips-opacity-0"))):-1===e.data.status?(console.log("websocket abnormal onclose, auto logout."),doLogout(),setLoginTips("ERROR","L47")):2===e.data.status&&(console.log("reconnecting..."),showPopupTip("L45",!1)),grpClick2Talk.websocketStatus=e.data.status)}function popupSendMessage2Background(e){if(e){e.requestType="popupMessage2Background";try{popupPort.postMessage(e)}catch(t){console.log(t),establishRuntimeConnection(),popupPort.postMessage(e)}}}function autoFillNumber(e,t){if(!grpClick2Talk||!grpClick2Talk.isLogin)return void console.log("Not currently logged in~");let n=function(){t&&(phoneNumber.classList.add("number-input-shake"),setTimeout((function(){phoneNumber.classList.value.includes("number-input-shake")&&phoneNumber.classList.remove("number-input-shake")}),3e3)),phoneNumber.value=e.number,searchForContacts(),extensionNamespace.storage.local.remove(o)},o="temporaryCallInfo";e&&e.number?(console.log("auto fill number in input with ",e.number),n()):extensionNamespace.storage.local.get(o,(function(t){t[o]&&(e=t[o],n())}))}function establishRuntimeConnection(){extensionNamespace&&(popupPort=extensionNamespace.runtime.connect({name:"popup"}),popupPort.onDisconnect.addListener((function(){console.log("Connection is disconnected, close Popup page"),extensionNamespace.runtime.lastError&&console.error("Got expected error: "+extensionNamespace.runtime.lastError.message)})),popupPort.onMessage.addListener(handleBackgroundMessage))}function parentElementCompare(e,t){return!(!e||!t)&&(e.parentElement?e.parentElement===t||parentElementCompare(e.parentElement,t):void 0)}function getBrowserDetail(){function e(e,t,n){let o=e.match(t);return o&&o.length>=n&&parseInt(o[n],10)}var t={browser:null,version:null,UIVersion:null,chromeVersion:null,systemFriendlyName:null};if(navigator.userAgent.match(/Windows/)?t.systemFriendlyName="windows":navigator.userAgent.match(/Mac/)?t.systemFriendlyName="mac":navigator.userAgent.match(/Linux/)&&(t.systemFriendlyName="linux"),"undefined"==typeof window||!window.navigator)return t.browser="Not a browser.",t;if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=e(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2),t.UIVersion=navigator.userAgent.match(/Edge\/([\d.]+)/)[1];else if(!navigator.mediaDevices&&(window.ActiveXObject||"ActiveXObject"in window||navigator.userAgent.match(/MSIE (\d+)/)||navigator.userAgent.match(/rv:(\d+)/)))t.browser="ie",navigator.userAgent.match(/MSIE (\d+)/)?(t.version=e(navigator.userAgent,/MSIE (\d+).(\d+)/,1),t.UIVersion=navigator.userAgent.match(/MSIE ([\d.]+)/)[1]):navigator.userAgent.match(/rv:(\d+)/)&&(t.version=e(navigator.userAgent,/rv:(\d+).(\d+)/,1),t.UIVersion=navigator.userAgent.match(/rv:([\d.]+)/)[1]);else if(navigator.mozGetUserMedia)t.browser="firefox",t.version=e(navigator.userAgent,/Firefox\/(\d+)\./,1),t.UIVersion=navigator.userAgent.match(/Firefox\/([\d.]+)/)[1];else if(navigator.webkitGetUserMedia&&window.webkitRTCPeerConnection)navigator.userAgent.match(/(OPR|Opera).([\d.]+)/)?(t.browser="opera",t.version=e(navigator.userAgent,/O(PR|pera)\/(\d+)\./,2),t.UIVersion=navigator.userAgent.match(/O(PR|pera)\/([\d.]+)/)[2],navigator.userAgent.match(/Chrom(e|ium)\/([\d.]+)/)[2]&&(t.chromeVersion=e(navigator.userAgent,/Chrom(e|ium)\/(\d+)\./,2))):(t.browser="chrome",t.version=e(navigator.userAgent,/Chrom(e|ium)\/(\d+)\./,2),t.UIVersion=navigator.userAgent.match(/Chrom(e|ium)\/([\d.]+)/)[2]);else{if(!(!navigator.webkitGetUserMedia&&navigator.userAgent.match(/AppleWebKit\/([0-9]+)\./)||navigator.webkitGetUserMedia&&!navigator.webkitRTCPeerConnection))return t.browser="Not a supported browser.",t;if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return t.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",t;t.browser="safari",t.version=e(navigator.userAgent,/AppleWebKit\/(\d+)\./,1),t.UIVersion=navigator.userAgent.match(/Version\/([\d.]+)/)[1]}return t}var hidden,visibilityChange;window.handleBackgroundMessage=handleBackgroundMessage,window.chrome&&window.chrome.runtime&&window.chrome.runtime.connect?extensionNamespace=chrome:window.browser&&window.browser.runtime&&window.browser.runtime.connect&&(extensionNamespace=browser),extensionNamespace.storage.onChanged.addListener((function(e,t){for(let n in e)if("temporaryCallInfo"===n&&e[n].newValue){let o=e[n];console.log('Storage key "%s" in namespace "%s" changed. ',NaN,n,t,o.oldValue,o.newValue),autoFillNumber(o.newValue,!0)}})),window.onload=function(){console.log("window onload"),establishRuntimeConnection(),popupPort&&(setDomBindingEvent(),popupSendMessage2Background({cmd:"popupOnOpen",screen:{height:window.screen.height,width:window.screen.width},language:window.currentLocale})),window.resizeTo(window.outerWidth,initOuterHeight)},window.addEventListener("resize",handleWindowResize),document.onkeydown=function(e){window.event&&(e=window.event),13===(e.charCode||e.keyCode)&&(grpClick2Talk?grpClick2Talk.isLogin?console.log("[EXT] already login..."):login():console.log("[EXT] grpClick2Talk {}"))},document.addEventListener("click",(e=>{((e=e||window.event).path&&!e.path.includes(deviceArea)||e.target!==deviceArea&&!parentElementCompare(e.target,deviceArea))&&(deviceAccounts.style.display="none",accountArrowSwitch.style.backgroundImage='url("./assets/arrow_down.svg")'),(e.path&&!e.path.includes(settingNav)&&!e.path.includes(settingNavList)||e.target!==settingNav&&!parentElementCompare(e.target,settingNav)&&e.target!==settingNavList&&!parentElementCompare(e.target,settingNavList))&&(settingNavList.style.display="none");let t=document.getElementsByClassName("phoneNumber-input")[0];(e.path&&!e.path.includes(t)||e.target!==t&&!parentElementCompare(e.target,t))&&phoneNumber.blur(),(e.path&&!e.path.includes(searchResult)||e.target!==searchResult&&!parentElementCompare(e.target,searchResult))&&(searchResult.style.display="none")})),void 0!==document.hidden?(hidden="hidden",visibilityChange="visibilitychange"):void 0!==document.msHidden?(hidden="msHidden",visibilityChange="msvisibilitychange"):void 0!==document.webkitHidden&&(hidden="webkitHidden",visibilityChange="webkitvisibilitychange"),document.addEventListener(visibilityChange,(function(){document.hidden&&"safari"===getBrowserDetail().browser&&(console.log("document hidden"),window.close())}),!1);