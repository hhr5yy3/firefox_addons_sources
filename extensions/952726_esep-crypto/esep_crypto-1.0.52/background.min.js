console.log("ESEP Crypto extension background: loading...");var CryptoExtensionBackground={hosts:{crypto:{name:"com.topcase.cryptohost",port:null},updater:{name:"com.topcase.cryptoupdaterhost",port:null}},tabIds:{},configure:function(){this.listenContentRequest()},listenContentRequest:function(){browser.runtime.onMessage.addListener(function(request,sender,sendResponse){if(request.tabId!=null){CryptoExtensionBackground.sendMessageToHost(request,request.tabId)}else if(sender.tab!=null&&sender.tab.id!=null){CryptoExtensionBackground.sendMessageToHost(request,sender.tab.id)}else{browser.tabs.query({active:true,currentWindow:true},function(tabs){CryptoExtensionBackground.sendMessageToHost(request,tabs[0].id)})}return true})},sendMessageToHost:function(request,tabId){switch(request.type){case"EsepCryptoHostMessage":CryptoExtensionBackground.tabIds[request.data.id]=tabId;CryptoExtensionBackground.postHostMessage(CryptoExtensionBackground.hosts.crypto,request.data,tabId);break;case"EsepCryptoUpdaterHostMessage":CryptoExtensionBackground.tabIds[request.data.id]=tabId;CryptoExtensionBackground.postHostMessage(CryptoExtensionBackground.hosts.updater,request.data,tabId);break;case"EsepTabRequestMessage":CryptoExtensionBackground.sendAnswerToContent({id:request.data.id,result:{tabId:tabId}},tabId);break}},sendAnswerToContent:function(data,tabId){if(tabId==null){tabId=CryptoExtensionBackground.tabIds[data.id];if(tabId==null){return}}browser.tabs.sendMessage(tabId,{type:"EsepCryptoHostAnswer",id:data.id,data:data.result});delete CryptoExtensionBackground.tabIds[data.id]},getFailed:function(id){return{id:id,result:{success:"0",message:"HostError"}}},setPort:function(host,data,tabId){host.port=browser.runtime.connectNative(host.name);if(host.port==null){CryptoExtensionBackground.sendAnswerToContent(CryptoExtensionBackground.getFailed(data.id),tabId);return}host.port.onMessage.addListener(function(data){CryptoExtensionBackground.sendAnswerToContent(data);return true});host.port.onDisconnect.addListener(function(){host.port=null});host.checkTimer=0;setTimeout(function(){CryptoExtensionBackground.hostChecker(host,data,tabId)},100)},hostChecker:function(host,data,tabId){if(host.port==null){CryptoExtensionBackground.sendAnswerToContent(CryptoExtensionBackground.getFailed(data.id),tabId);return}host.checkTimer+=100;if(host.checkTimer<1e3){setTimeout(function(){CryptoExtensionBackground.hostChecker(host,data,tabId)},100);return}try{host.port.postMessage(data)}catch(e){host.port=null;CryptoExtensionBackground.sendAnswerToContent(CryptoExtensionBackground.getFailed(data.id),tabId)}},postHostMessage:function(host,data,tabId){if(host.port==null){CryptoExtensionBackground.setPort(host,data,tabId)}else{try{host.port.postMessage(data)}catch(e){host.port=null;CryptoExtensionBackground.sendAnswerToContent(CryptoExtensionBackground.getFailed(data.id),tabId)}}}};CryptoExtensionBackground.configure();console.log("ESEP Crypto extension background: loaded.");