async function save_key(){document.getElementById("submit-key").disabled=!0;const e=document.getElementById("licence-key").value,{valid:t,reason:n,text:o,licenceKey:i}=await sendOptionsMessage("options-check-key",{licenceKey:e});if(t)set_valid_key(i),document.getElementById("licence-error").innerHTML="",restore_options();else{let e="That licence key is not valid";"invalid-licence"===n?e='That licence key is not valid. Try again or click\n      <a rel="noopener noreferrer" target="_ellie-website" href="https://tryellie.com/downloads">here</a> to get\n      one</span>.':"licence-overused"===n&&(e='Your licence key is being used on too many devices, if you want to de-register a device or upgrade your plan please <a href="mailto:hi@tryellie.com">contact us</a>.'),document.getElementById("licence-error").innerHTML=e,document.getElementById("submit-key").disabled=!1}}function set_valid_key(e){chrome.storage.sync.set({licenceKey:e}),chrome.runtime.sendMessage({type:"load-user"},(function(e){}))}function save_options(){const e=document.getElementById("your-name").value,t=document.getElementById("hide-sig").checked,n=document.getElementById("preferred-model").value;console.log("Saving options"),chrome.storage.sync.set({replyFromName:e,doNotIncludeSig:t,preferredModel:n})}function save_style(){var e=document.getElementById("style").value;console.log("saving style",e),chrome.storage.sync.set({style:e})}function restore_options(){chrome.storage.sync.get({licenceKey:"",replyFromName:"",doNotIncludeSig:!1,preferredModel:"auto",examplePrompt1:"",exampleReply1:"",examplePrompt2:"",exampleReply2:""},(function(e){if(document.getElementById("licence-key").value=e.licenceKey,document.getElementById("your-name").value=e.replyFromName,document.getElementById("preferred-model").value=e.preferredModel,document.getElementById("hide-sig").checked=e.doNotIncludeSig,e.licenceKey){const e={type:"load-user"};chrome.runtime.sendMessage(e,(function(e){}))}else initFreeUser()}))}function setBannerError(e="",t){let n;n="licence-overused"===t?'Your licence key is being used on too many devices, if you want to de-register a device or upgrade your plan please <a href="mailto:hi@tryellie.com">contact us</a>.':"overdue-invoice"===t?"Your invoice is overdue and your subscription will be canceled soon. Please manage your plan and pay your invoice, you can do this from the Licence Key page.":e;const o=document.querySelector("#error-banner");o.innerHTML=n,n?(o.style.display="block",document.querySelector("body").classList.add("has-user-error")):(o.style.display="hidden",document.querySelector("body").classList.remove("has-user-error"))}function initFreeUser(){document.querySelector("body").classList.add("has-no-licence-key"),window.location="/src/options/onboarding/index.html"}function initUser(e,t){e.invites&&(document.getElementById("invite-url").value=`https://tryellie.com/?invite=${e.invites.codes[0]}`);const{uuid:n,email:o,usage:i,billing:a,corpus:l,roles:d,training:r,onboarding:s,planLimits:c={}}=e;if(s&&s.started&&!s.completed)return void(window.location="/src/options/onboarding/index.html");updateUsageElements({repliesLimitText:a&&"early-bird"===a.plan?"unlimited":i.generatedRepliesLimit,repliesGeneratedText:i.repliesGeneratedToday,emailTrainingLimit:c?c.emailTrainingLimit:10}),document.querySelector("body").classList.remove("has-no-licence-key"),document.querySelector("body").classList.add("has-licence-key"),a&&a.paid?document.querySelector("body").classList.add("is-paid-user"):(document.querySelector("body").classList.add("is-free-user"),document.querySelectorAll("[data-plan-required]").forEach((e=>e.setAttribute("data-modal","payment-modal"))),document.querySelectorAll("[data-plan-required-or-disabled]").forEach((e=>e.setAttribute("disabled",!0)))),[...document.querySelectorAll(".pricing-link")].forEach((e=>{const t=new URLSearchParams(new URL(e.href).search);t.set("e",o),t.set("u",n),e.href=`${e.href.split("?")[0]}?${t.toString()}`})),[...document.querySelectorAll(".manage-billing-link")].forEach((e=>{const t=new URLSearchParams(new URL(e.href).search);t.set("prefilled_email",o),e.href=`${e.href.split("?")[0]}?${t.toString()}`}));const u="Professional"===a.plan||"Business"===a.plan;if(a&&a.paid&&u&&document.querySelectorAll("[data-plan-required=pro]").forEach((e=>e.setAttribute("data-modal","payment-modal"))),"past_due"===a?.subscriptionStatus&&setBannerError("","overdue-invoice"),t&&t.updateRequired){const{downloadPage:e}=t,n=document.getElementById("upgrade-extension");n.href=e,n.classList.remove("hidden")}populateRolesList(d),populateTrainingData(l),e.training&&e.training.fineTuneModel&&removeAllAttribute("[data-requires-custom-model]","disabled");const m=document.getElementById("preferred-model").value;document.getElementById("try-models").value=m,"running"!==e.training.status&&"processing"!==e.training.status||setInterval(updateTrainingStatusText,5e3),updateTrainingStatusText()}function populateRolesList(e){const t=e.find((e=>e.isDefault)),n=document.getElementById("clear-default-role-btn");if(e.length){const o=document.getElementById("try-roles");o.classList.remove("hidden");const i=document.createElement("option");i.text="No role",i.value="",i.setAttribute("selected","selected"),o.appendChild(i);for(let t of e){const e=document.createElement("option");e.text=t.name,e.value=t.uuid,t.isDefault&&e.setAttribute("selected","selected"),o.appendChild(e)}t?(n.addEventListener("click",(async e=>{await sendOptionsMessage("options-clear-default-role",{data:{uuid:t.uuid}}),window.location.reload()})),n.classList.remove("hidden")):o.children[0].setAttribute("selected","selected")}else{document.getElementById("try-roles-empty").classList.remove("hidden")}const o=document.getElementById("existing-roles"),i=document.getElementById("roles-empty"),a=o.querySelector("ul");if(a.classList.add("blocky-list"),[...a.querySelectorAll("li")].forEach((e=>a.removeChild(e))),e.length){for(let n of e){const{uuid:e,name:o,description:i,prompt:l,example:d,meta:{createdAt:r},isDefault:s}=n,c=document.createElement("li");c.setAttribute("data-role-uuid",e),d&&c.setAttribute("data-example",!0),c.innerHTML=`<div class="roles-info"><div><b>${o}</b> <span class="example-label">Example</span><span class="muted">(${timeAgo(r)})</span></div><div>${i}</div></div>`;const u=document.createElement("div");if(u.classList.add("actions"),c.appendChild(u),s){const e=document.createElement("span");e.textContent="Default Role",e.classList.add("default-label"),u.appendChild(e)}else{const n=document.createElement("button");n.classList.add("btn"),n.classList.add("btn-muted"),n.textContent="Set default",n.addEventListener("click",(async n=>{await sendOptionsMessage("options-set-default-role",{data:{uuid:e,defaultUuid:t?t.uuid:null}}),window.location.reload()})),u.appendChild(n)}const m=document.createElement("button");m.classList.add("btn"),m.classList.add("btn-muted"),m.classList.add("open-modal"),m.setAttribute("data-modal","roles-edit-modal"),m.textContent="Edit",m.addEventListener("click",(t=>{openModal(t),document.getElementById("edit-role-current-name").textContent=o,document.getElementById("edit-role-uuid").value=e,document.getElementById("edit-role-prompt").value=l,document.getElementById("edit-role-prompt-total-chars").textContent=l.length})),u.appendChild(m);const p=document.createElement("button");p.classList.add("btn"),p.classList.add("btn-danger"),p.textContent="Delete",p.addEventListener("click",(()=>clickDeleteRoleBtn(e))),u.appendChild(p),a.appendChild(c)}document.getElementById("roles-total").textContent=e.length,i.classList.add("hidden"),o.classList.remove("hidden")}else i.classList.remove("hidden");e.length<5&&document.getElementById("new-role-modal-btn").removeAttribute("disabled")}function populateTrainingData(e){if(e.summaries&&e.summaries.length){const t=document.getElementById("existing-training-data"),n=t.querySelector("ul");t.classList.remove("hidden"),[...n.querySelectorAll("li")].forEach((e=>n.removeChild(e)));for(let t of e.summaries){const{websiteUrl:e,stats:o,status:i,uuid:a,type:l,fileName:d}=t,r=document.createElement("li");r.setAttribute("data-dataset-uuid",a);const s=document.createElement("div");s.classList.add("container");const c=document.createElement("span");"website"===l?c.textContent=`${e} (${o.urlsCrawled||0} pages)`:"file"===l&&(c.textContent=`${d}`);document.createElement("div").classList.add("crawl-status");const u=document.createElement("div");u.classList.add("actions");const m=document.createElement("button");if(m.classList.add("btn","btn-danger"),m.textContent="Delete",m.addEventListener("click",(()=>onDeleteTrainingData(a))),u.appendChild(m),r.appendChild(s),r.appendChild(u),s.appendChild(c),n.appendChild(r),"crawling"===i){const e=document.createElement("li");e.textContent="Crawling site, this may take a while...",e.classList.add("crawl-status"),n.appendChild(e)}}e.summaries.length>=3&&(document.querySelector('[data-modal="training-modal"]').style.display="none")}e.summaries.some((e=>"crawling"===e.status))&&setTimeout(restore_options,5e3)}function onDeleteTrainingData(e){const t=document.querySelector(`[data-dataset-uuid="${e}"]`);t.parentElement.removeChild(t),chrome.runtime.sendMessage({type:"delete-dataset",uuid:e},(function(e){})),setTimeout((()=>window.location.reload()),2e3)}function updateUsageElements({repliesLimitText:e,repliesGeneratedText:t,emailTrainingLimit:n=10}){document.querySelectorAll(".generated-replies-limit").forEach((t=>t.textContent=e)),document.querySelectorAll(".generated-replies-today").forEach((e=>e.textContent=t)),document.querySelectorAll(".email-training-max-limit").forEach((e=>e.textContent=n))}function hideLicenceKeyUpgradeElements(){document.querySelectorAll(".unlicensed").forEach((e=>e.classList.add("hidden")))}function showPlanManagement(){document.querySelectorAll(".plan-management").forEach((e=>e.classList.remove("hidden")))}function changeButtonToShowUpgrade(){document.querySelectorAll(".unlicensed").forEach((e=>e.textContent="Upgrade plan")),document.querySelectorAll(".free").forEach((e=>e.classList.remove("hidden")))}function getVersion(){return chrome.runtime.getManifest().version}function timeAgo(e){const t=new Date,n=new Date(e),o=Math.floor((t-n)/1e3);if(o<60)return`${o} sec${1===o?"":"s"} ago`;if(o<3600){const e=Math.floor(o/60);return`${e} min${1===e?"":"s"} ago`}if(o<86400){const e=Math.floor(o/3600);return`${e} hr${1===e?"":"s"} ago`}{const e=Math.floor(o/86400);return`${e} day${1===e?"":"s"} ago`}}function setupCharacterLimit(e,t,n){const o=document.getElementById(e),i=document.getElementById(t);o.addEventListener("input",(function(){const e=o.value;n-e.length<=0?(o.value=e.substring(0,n),i.textContent=o.value.length):i.textContent=e.length}))}function updateAllText(e,t){document.querySelectorAll(e).forEach((e=>{e.textContent=t}))}function updateAllAttribute(e,t,n){document.querySelectorAll(e).forEach((e=>{e.setAttribute(t,n)}))}function removeAllAttribute(e,t){document.querySelectorAll(e).forEach((e=>{e.removeAttribute(t)}))}async function sendOptionsMessage(e,t={}){return new Promise((n=>{chrome.runtime.sendMessage({type:e,...t},(function(e){n(e)}))}))}chrome.runtime.onMessage.addListener((function(e){if("user-error"!==e.type)return"user"===e.type?(setBannerError(""),initUser(e.user,e.extensionInfo)):void 0;setBannerError(e.text,e.reason)})),document.addEventListener("DOMContentLoaded",(()=>{restore_options()})),document.getElementById("submit-key").addEventListener("click",save_key),document.getElementById("licence-key").addEventListener("input",(()=>document.getElementById("submit-key").disabled=!1)),document.getElementById("your-name").addEventListener("input",save_options),document.getElementById("hide-sig").addEventListener("change",save_options),document.getElementById("preferred-model").addEventListener("change",save_options),document.getElementById("version").textContent=getVersion(),setupCharacterLimit("role-prompt","role-prompt-total-chars",4e3),setupCharacterLimit("edit-role-prompt","edit-role-prompt-total-chars",4e3);