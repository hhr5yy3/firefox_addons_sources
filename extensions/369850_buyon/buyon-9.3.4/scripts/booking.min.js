let attempts=0;async function findAlternative(e){let t=navigator.userAgent.toLowerCase().indexOf("firefox")>-1?"firefox":"chrome",n=document.location.hostname.replace("www.",""),o=document.querySelector('script[type="application/ld+json"]');if(!o)return;let d=JSON.parse(o.innerText),a=d.address;if(!a)return;let l=d.hasMap,r=d.name,c=a.postalCode,m="";if(l){let e=l.match(new RegExp("-?[0-9.]+,-?[0-9.]+"));e&&e.length>0&&(m=e[0])}if(!(!!r&&!!m))return;let s="_nobb",p=getCookieValueByName(s),f=!!p,h="",u="",g="",x="",y="",_=window.location.href.match("[?&]{1}([^&]*checkin[^&]*)"),b=[];if(null!=_&&_.length>1&&(b=_[1].split(";")),(null==b||b.length<=1)&&(_=window.location.href.split("?"),_.length>1&&(b=_[1].split("&"))),null!=b&&b.length>1)for(i=0;i<b.length;i++){let e=b[i].split("=");2==e.length&&("checkin"==e[0]?h=e[1]:"checkout"==e[0]?u=e[1]:"req_adults"==e[0]||"group_adults"==e[0]?g=e[1]:"req_age"==e[0]?(""!=x&&(x+=","),x+=e[1]):"no_rooms"==e[0]&&(y=e[1]))}if(!!!(h||u||g||y)&&attempts<3)return attempts++,void setTimeout((()=>findAlternative(e)),500);let C=`https://api.buyon.it/buyon/hotel/alternative?provider=booking.com&checkin=${h}&checkout=${u}&adults=${g}&children=${x}&rooms=${y}&hotelName=${fixedEncodeURIComponent(r)}&coordinates=${fixedEncodeURIComponent(m)}`,v=await fetch(C,{method:"GET",headers:{mode:"cors"}}).then((e=>e.text())).then((e=>JSON.parse(e))).catch((e=>{console.log(e)}));v.Alternative?(f="2"==p,p="2"):p||(p="1");let N=document.createElement("div");N.id="buyon-widget";let k=document.createElement("style");k.appendChild(document.createTextNode(`\n    @font-face { font-family: 'Montserrat'; src: url('${chrome.runtime.getURL("fonts/Montserrat-Regular.ttf")}') format('truetype'); font-style: normal; font-weight: 400; }\n    @font-face { font-family: 'Montserrat'; src: url('${chrome.runtime.getURL("fonts/Montserrat-Bold.ttf")}') format('truetype'); font-style: normal; font-weight: 700; }\n  `)),N.appendChild(k);let w=N.attachShadow({mode:"open"}),E=document.createElement("style");E.appendChild(document.createTextNode("\n    :host { font-family: Montserrat, 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; display: block!important; line-height: normal; }\n    .buyon-content { position: relative; width: 220px; display: flex; gap: 16px; padding: 16px; border-radius: 10px; background-color: rgba(50,50,50,.95); color: #fff; border: 2px solid #fff; box-shadow: 0px 0px 10px rgba(0,0,0,.5); }\n    .buyon-link { color: #ff6d06; text-decoration: none; font-weight: bold; transition: all 0.2s linear; }\n    .buyon-link:hover { color: #ff832b; }\n    .buyon-btn-action-cont { margin-top: 10px; }\n    .buyon-btn-action { display: block; border-radius: 3px; padding: 6px; line-height: 1.333333; text-align: center; border: 1px solid #fff; font-weight: 700; color: #ff6d06; background-color: #fff; outline: 0; text-decoration: none; transition: all 0.2s linear; }\n    .buyon-btn-action:hover { background-color: #f0f0f0; border-color: #f0f0f0; }\n    .buyon-close { font-weight: bold; color: #000; background-color: #fff; outline: 0; text-decoration: none; transition: all 0.2s linear; display: flex; align-items: center; justify-content: center; position: absolute; top: 5px; right: 5px; width: 16px; height: 16px; border-radius: 50%; font-size: 10px; }\n    .buyon-close:hover { background-color: #f0f0f0; }\n    .buyon-title { font-weight: bold; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 8px; word-break: break-word; }\n    .buyon-link-mini-cont { font-size: 11px; margin-top: 8px; }\n    .buyon-link-mini-cont > a { color: #fff; }\n  ")),w.appendChild(E);let T=document.createElement("div");T.style.position="fixed",T.style.top="16px",T.style.right="16px",T.style.zIndex="65535",T.style.opacity="0",w.appendChild(T);let $=document.createElement("div");$.className="buyon-content",T.appendChild($);let z=document.createElement("div"),A=document.createElement("img");A.src=chrome.runtime.getURL("images/buyon-icon-white.svg"),z.onclick=function(){f&&(f=!1,document.cookie=`${s}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`,toggleBookingWidget(f,T,$,M,z,A))},z.appendChild(A),$.appendChild(z);let M=document.createElement("div");M.className="buyon-message-cont",$.appendChild(M);let S=document.createElement("div");if(S.appendChild(document.createTextNode(r)),S.className="buyon-title",M.appendChild(S),v.Alternative){let e=document.createElement("div");e.appendChild(document.createTextNode("Verifica il miglior prezzo su BuyOn e guadagna!")),M.appendChild(e);let o=document.createElement("a"),i=v.Alternative.Url;-1==i.indexOf("?")?i+="?":i+="&",i+=`utm_source=buyon&utm_medium=extension&utm_campaign=${t}&utm_term=hotel&utm_content=${n}`,o.href=i,o.target="_blank",o.className="buyon-btn-action buyon-btn-action-cont";let d="Attiva cashback";null!=v.Alternative.Cashback&&(d+=` ${v.Alternative.Cashback}`),o.appendChild(document.createTextNode(d)),M.appendChild(o);let a=document.createElement("div");a.className="buyon-link-mini-cont";let l=document.createElement("a");l.href="javascript:;",l.appendChild(document.createTextNode("Oppure prenota direttamente")),l.onclick=function(){l.onclick=function(){},a.innerText="Recupero informazioni...",findContact(a,r,c,!1)},a.appendChild(l),M.appendChild(a)}else{let e=document.createElement("div");e.appendChild(document.createTextNode("Prenota direttamente, spesso si risparmia!")),M.appendChild(e);let t=document.createElement("div");t.className="buyon-btn-action-cont";let n=document.createElement("a");n.href="javascript:;",n.className="buyon-btn-action",n.appendChild(document.createTextNode("Prenota direttamente")),n.onclick=function(){n.onclick=function(){},t.innerText="Recupero informazioni...",findContact(t,r,c,!0)},t.appendChild(n),M.appendChild(t)}let H=document.createElement("a");H.className="buyon-close",H.href="javascript:;",H.appendChild(document.createTextNode("âœ•")),H.onclick=function(){let e=new Date,t=new Date(e.getTime()+864e5);document.cookie=`${s}=${p}; expires=${t.toGMTString()}; path=/`,f=!0,toggleBookingWidget(f,T,$,M,z,A)},$.appendChild(H),toggleBookingWidget(f,T,$,M,z,A,!0),T.style.transition="all 0.2s ease",setTimeout((()=>{T.style.opacity=f?.5:1}),1),document.body.parentElement.appendChild(N)}function toggleBookingWidget(e,t,n,o,i,d,a=!1){o.style.display=e?"none":"block",n.style.padding=e?"0":"16px",t.style.right=e?"-184px":"16px",t.style.top=e?"50%":"16px",a||(t.style.opacity=e?.5:1),t.style.transform=e?"translateY(-50%)":"none",i.style.display=e?"flex":"block",i.style.padding=e?"8px":"0",i.style.cursor=e?"pointer":"default",d.style.width=e?"24px":"32px"}async function findContact(e,t,n,o){let i=`hotelName=${fixedEncodeURIComponent(t)}&postalCode=${fixedEncodeURIComponent(n)}`,d=(new TextEncoder).encode(i).reverse(),a=String.fromCharCode(...d),l=btoa(hex2a(md5(a))),r=`https://api.buyon.it/buyon/hotel/find-contact?${i}`,c=await fetch(r,{method:"GET",headers:{mode:"no-cors","bo-check":l}}).then((e=>e.text())).then((e=>JSON.parse(e))).catch((e=>{console.log(e)}));e.style.fontSize="13px",e.replaceChildren();let m=document.createElement("div"),s=new DOMParser,p=s.parseFromString('<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><path d="M164.9 24.6c-7.7-18.6-28-28.5-47.4-23.2l-88 24C12.1 30.2 0 46 0 64C0 311.4 200.6 512 448 512c18 0 33.8-12.1 38.6-29.5l24-88c5.3-19.4-4.6-39.7-23.2-47.4l-96-40c-16.3-6.8-35.2-2.1-46.3 11.6L304.7 368C234.3 334.7 177.3 277.7 144 207.3L193.3 167c13.7-11.2 18.4-30 11.6-46.3l-40-96z"/></svg>',"image/svg+xml").documentElement;if(p.style.fill="#fff",!o){let e=document.createElement("hr");e.style.opacity=.3,e.style.margin="16px 0",m.appendChild(e)}if(!c||!c.Direct||!c.Direct.PhoneNumber&&!c.Direct.Website){textNode=document.createElement("div"),textNode.appendChild(p);let t=document.createElement("span");return t.appendChild(document.createTextNode("Nessun contatto trovato.")),textNode.style.marginTop="4px",textNode.style.display="flex",textNode.style.gap="8px",textNode.style.alignItems="center",textNode.appendChild(t),m.appendChild(textNode),void e.appendChild(m)}if(!o){let e=document.createElement("div");e.appendChild(document.createTextNode("Prenota direttamente, spesso si risparmia!")),e.style.marginBottom="8px",m.appendChild(e)}if(c.Direct.PhoneNumber){textNode=document.createElement("div"),textNode.appendChild(p);let e=document.createElement("a");e.href=`tel:${c.Direct.PhoneNumber}`,e.style.color="#fff",e.appendChild(document.createTextNode(c.Direct.PhoneNumber)),textNode.style.marginTop="4px",textNode.style.display="flex",textNode.style.gap="8px",textNode.style.alignItems="center",textNode.appendChild(e),m.appendChild(textNode)}if(c.Direct.Website){textNode=document.createElement("div");let e=s.parseFromString('<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><path d="M352 256c0 22.2-1.2 43.6-3.3 64H163.3c-2.2-20.4-3.3-41.8-3.3-64s1.2-43.6 3.3-64H348.7c2.2 20.4 3.3 41.8 3.3 64zm28.8-64H503.9c5.3 20.5 8.1 41.9 8.1 64s-2.8 43.5-8.1 64H380.8c2.1-20.6 3.2-42 3.2-64s-1.1-43.4-3.2-64zm112.6-32H376.7c-10-63.9-29.8-117.4-55.3-151.6c78.3 20.7 142 77.5 171.9 151.6zm-149.1 0H167.7c6.1-36.4 15.5-68.6 27-94.7c10.5-23.6 22.2-40.7 33.5-51.5C239.4 3.2 248.7 0 256 0s16.6 3.2 27.8 13.8c11.3 10.8 23 27.9 33.5 51.5c11.6 26 20.9 58.2 27 94.7zm-209 0H18.6C48.6 85.9 112.2 29.1 190.6 8.4C165.1 42.6 145.3 96.1 135.3 160zM8.1 192H131.2c-2.1 20.6-3.2 42-3.2 64s1.1 43.4 3.2 64H8.1C2.8 299.5 0 278.1 0 256s2.8-43.5 8.1-64zM194.7 446.6c-11.6-26-20.9-58.2-27-94.6H344.3c-6.1 36.4-15.5 68.6-27 94.6c-10.5 23.6-22.2 40.7-33.5 51.5C272.6 508.8 263.3 512 256 512s-16.6-3.2-27.8-13.8c-11.3-10.8-23-27.9-33.5-51.5zM135.3 352c10 63.9 29.8 117.4 55.3 151.6C112.2 482.9 48.6 426.1 18.6 352H135.3zm358.1 0c-30 74.1-93.6 130.9-171.9 151.6c25.5-34.2 45.2-87.7 55.3-151.6H493.4z"/></svg>',"image/svg+xml").documentElement;e.style.fill="#fff",textNode.appendChild(e);let t=document.createElement("a");t.href=c.Direct.Website,t.target="_blank",t.className="buyon-link",t.appendChild(document.createTextNode("Sito web")),textNode.appendChild(t),textNode.style.marginTop="4px",textNode.style.display="flex",textNode.style.gap="8px",textNode.style.alignItems="center",m.appendChild(textNode)}e.appendChild(m)}function getCookieValueByName(e){let t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?t[2]:""}function md5(e){return M(V(Y(X(e),8*e.length))).toLowerCase()}function M(e){for(var t,n="0123456789ABCDEF",o="",i=0;i<e.length;i++)t=e.charCodeAt(i),o+=n.charAt(t>>>4&15)+n.charAt(15&t);return o}function X(e){for(var t=Array(e.length>>2),n=0;n<t.length;n++)t[n]=0;for(n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}function V(e){for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>n%32&255);return t}function Y(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,o=-271733879,i=-1732584194,d=271733878,a=0;a<e.length;a+=16){var l=n,r=o,c=i,m=d;o=md5_ii(o=md5_ii(o=md5_ii(o=md5_ii(o=md5_hh(o=md5_hh(o=md5_hh(o=md5_hh(o=md5_gg(o=md5_gg(o=md5_gg(o=md5_gg(o=md5_ff(o=md5_ff(o=md5_ff(o=md5_ff(o,i=md5_ff(i,d=md5_ff(d,n=md5_ff(n,o,i,d,e[a+0],7,-680876936),o,i,e[a+1],12,-389564586),n,o,e[a+2],17,606105819),d,n,e[a+3],22,-1044525330),i=md5_ff(i,d=md5_ff(d,n=md5_ff(n,o,i,d,e[a+4],7,-176418897),o,i,e[a+5],12,1200080426),n,o,e[a+6],17,-1473231341),d,n,e[a+7],22,-45705983),i=md5_ff(i,d=md5_ff(d,n=md5_ff(n,o,i,d,e[a+8],7,1770035416),o,i,e[a+9],12,-1958414417),n,o,e[a+10],17,-42063),d,n,e[a+11],22,-1990404162),i=md5_ff(i,d=md5_ff(d,n=md5_ff(n,o,i,d,e[a+12],7,1804603682),o,i,e[a+13],12,-40341101),n,o,e[a+14],17,-1502002290),d,n,e[a+15],22,1236535329),i=md5_gg(i,d=md5_gg(d,n=md5_gg(n,o,i,d,e[a+1],5,-165796510),o,i,e[a+6],9,-1069501632),n,o,e[a+11],14,643717713),d,n,e[a+0],20,-373897302),i=md5_gg(i,d=md5_gg(d,n=md5_gg(n,o,i,d,e[a+5],5,-701558691),o,i,e[a+10],9,38016083),n,o,e[a+15],14,-660478335),d,n,e[a+4],20,-405537848),i=md5_gg(i,d=md5_gg(d,n=md5_gg(n,o,i,d,e[a+9],5,568446438),o,i,e[a+14],9,-1019803690),n,o,e[a+3],14,-187363961),d,n,e[a+8],20,1163531501),i=md5_gg(i,d=md5_gg(d,n=md5_gg(n,o,i,d,e[a+13],5,-1444681467),o,i,e[a+2],9,-51403784),n,o,e[a+7],14,1735328473),d,n,e[a+12],20,-1926607734),i=md5_hh(i,d=md5_hh(d,n=md5_hh(n,o,i,d,e[a+5],4,-378558),o,i,e[a+8],11,-2022574463),n,o,e[a+11],16,1839030562),d,n,e[a+14],23,-35309556),i=md5_hh(i,d=md5_hh(d,n=md5_hh(n,o,i,d,e[a+1],4,-1530992060),o,i,e[a+4],11,1272893353),n,o,e[a+7],16,-155497632),d,n,e[a+10],23,-1094730640),i=md5_hh(i,d=md5_hh(d,n=md5_hh(n,o,i,d,e[a+13],4,681279174),o,i,e[a+0],11,-358537222),n,o,e[a+3],16,-722521979),d,n,e[a+6],23,76029189),i=md5_hh(i,d=md5_hh(d,n=md5_hh(n,o,i,d,e[a+9],4,-640364487),o,i,e[a+12],11,-421815835),n,o,e[a+15],16,530742520),d,n,e[a+2],23,-995338651),i=md5_ii(i,d=md5_ii(d,n=md5_ii(n,o,i,d,e[a+0],6,-198630844),o,i,e[a+7],10,1126891415),n,o,e[a+14],15,-1416354905),d,n,e[a+5],21,-57434055),i=md5_ii(i,d=md5_ii(d,n=md5_ii(n,o,i,d,e[a+12],6,1700485571),o,i,e[a+3],10,-1894986606),n,o,e[a+10],15,-1051523),d,n,e[a+1],21,-2054922799),i=md5_ii(i,d=md5_ii(d,n=md5_ii(n,o,i,d,e[a+8],6,1873313359),o,i,e[a+15],10,-30611744),n,o,e[a+6],15,-1560198380),d,n,e[a+13],21,1309151649),i=md5_ii(i,d=md5_ii(d,n=md5_ii(n,o,i,d,e[a+4],6,-145523070),o,i,e[a+11],10,-1120210379),n,o,e[a+2],15,718787259),d,n,e[a+9],21,-343485551),n=safe_add(n,l),o=safe_add(o,r),i=safe_add(i,c),d=safe_add(d,m)}return Array(n,o,i,d)}function md5_cmn(e,t,n,o,i,d){return safe_add(bit_rol(safe_add(safe_add(t,e),safe_add(o,d)),i),n)}function md5_ff(e,t,n,o,i,d,a){return md5_cmn(t&n|~t&o,e,t,i,d,a)}function md5_gg(e,t,n,o,i,d,a){return md5_cmn(t&o|n&~o,e,t,i,d,a)}function md5_hh(e,t,n,o,i,d,a){return md5_cmn(t^n^o,e,t,i,d,a)}function md5_ii(e,t,n,o,i,d,a){return md5_cmn(n^(t|~o),e,t,i,d,a)}function safe_add(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function bit_rol(e,t){return e<<t|e>>>32-t}function hex2a(e){let t=e.toString(),n="";for(let e=0;e<t.length;e+=2)n+=String.fromCharCode(parseInt(t.substr(e,2),16));return n}function fixedEncodeURIComponent(e){return encodeURIComponent(e).replace(/[!'()*]/g,(function(e){return"%"+e.charCodeAt(0).toString(16)}))}chrome.runtime.sendMessage({command:"merchant-data",url:document.location.href},(async function(e){e&&""==e.cashback&&chrome.runtime.sendMessage({command:"cashback-data",url:document.location.href,title:document.title},(async function(t){t||await findAlternative(e)}))}));