import{c as C,d as D,b as N,g as B,h as w,p as k,f as _,a as F,P as b,_ as u,i as j}from"./chunk-QIZ4XBKF-C_NfkaUr.js";import{b as y}from"./browser-polyfill-tvjJO6eN.js";import{u as A,d as U}from"./storeTypes-CGrbvTi_.js";import"./_commonjsHelpers-CqkleIqs.js";var m=F(),s=new Map,p=new Map,h=new Map,E=(e,n)=>(p.set(e,(p.get(e)||new Set).add(n)),()=>{const t=p.get(e);t!=null&&t.delete(n)&&(t==null?void 0:t.size)===0&&p.delete(e)}),M=(e,n)=>{h.set(e,(h.get(e)||new Set).add(n))},f=e=>({withFingerprint:n=>{const t=r=>({and:()=>r}),a={aboutIncomingMessage:r=>{const i=s.get(e);return b.toExtensionContext(i.port,{status:"incoming",message:r}),t(a)},aboutSuccessfulDelivery:r=>{const i=s.get(e);return b.toExtensionContext(i.port,{status:"delivered",receipt:r}),t(a)},aboutMessageUndeliverability:(r,i)=>{const o=s.get(e);return(o==null?void 0:o.fingerprint)===n&&b.toExtensionContext(o.port,{status:"undeliverable",resolvedDestination:r,message:i}),t(a)},whenDeliverableTo:r=>{const i=()=>{const o=s.get(e);if((o==null?void 0:o.fingerprint)===n&&s.has(r))return b.toExtensionContext(o.port,{status:"deliverable",deliverableTo:r}),!0};if(!i()){const o=E(r,i);M(n,o)}return t(a)},aboutSessionEnded:r=>{const i=s.get(e);return(i==null?void 0:i.fingerprint)===n&&b.toExtensionContext(i.port,{status:"terminated",fingerprint:r}),t(a)}};return a}}),z=C(),I=D("background",e=>{var n;if(e.origin.context==="background"&&["content-script","devtools "].includes(e.destination.context)&&!e.destination.tabId)throw new TypeError("When sending messages from background page, use @tabId syntax to target specific tab");const t=w(u(u({},e.origin),e.origin.context==="window"&&{context:"content-script"})),a=w(j(u(u({},e.destination),e.destination.context==="window"&&{context:"content-script"}),{tabId:e.destination.tabId||e.origin.tabId}));e.destination.tabId=null,e.destination.frameId=null;const r=()=>s.get(a),i=()=>s.get(t),o=()=>{var l;f(a).withFingerprint(r().fingerprint).aboutIncomingMessage(e);const g={message:e,to:r().fingerprint,from:{endpointId:t,fingerprint:(l=i())==null?void 0:l.fingerprint}};e.messageType==="message"&&m.add(g),e.messageType==="reply"&&m.remove(e.messageID),i()&&f(t).withFingerprint(i().fingerprint).aboutSuccessfulDelivery(g)};(n=r())!=null&&n.port?o():e.messageType==="message"&&(e.origin.context==="background"?E(a,o):i()&&f(t).withFingerprint(i().fingerprint).aboutMessageUndeliverability(a,e).and().whenDeliverableTo(a))},e=>{const n=w(u(u({},e.origin),e.origin.context==="window"&&{context:"content-script"})),t=s.get(n),a={message:e,to:z,from:{endpointId:n,fingerprint:t.fingerprint}};f(n).withFingerprint(t.fingerprint).aboutSuccessfulDelivery(a)});N.runtime.onConnect.addListener(e=>{var n;const t=B(e.name);if(!t)return;t.endpointName||(t.endpointName=w({context:"content-script",tabId:e.sender.tab.id,frameId:e.sender.frameId}));const{tabId:a,frameId:r}=k(t.endpointName);s.set(t.endpointName,{fingerprint:t.fingerprint,port:e}),(n=p.get(t.endpointName))==null||n.forEach(i=>i()),p.delete(t.endpointName),M(t.fingerprint,()=>{const i=m.entries().filter(o=>o.to===t.fingerprint);m.remove(i),i.forEach(o=>{o.from.endpointId==="background"?I.endTransaction(o.message.transactionId):f(o.from.endpointId).withFingerprint(o.from.fingerprint).aboutSessionEnded(t.fingerprint)})}),e.onDisconnect.addListener(()=>{var i,o;((i=s.get(t.endpointName))==null?void 0:i.fingerprint)===t.fingerprint&&s.delete(t.endpointName),(o=h.get(t.fingerprint))==null||o.forEach(l=>l()),h.delete(t.fingerprint)}),e.onMessage.addListener(i=>{var o,l;if(i.type==="sync"){const g=[...s.values()].map(c=>c.fingerprint),T=i.pendingResponses.filter(c=>g.includes(c.to));m.add(...T),i.pendingResponses.filter(c=>!g.includes(c.to)).forEach(c=>f(t.endpointName).withFingerprint(t.fingerprint).aboutSessionEnded(c.to)),i.pendingDeliveries.forEach(c=>f(t.endpointName).withFingerprint(t.fingerprint).whenDeliverableTo(c));return}i.type==="deliver"&&((l=(o=i.message)==null?void 0:o.origin)!=null&&l.context)&&(i.message.origin.tabId=a,i.message.origin.frameId=r,I.handleMessage(i.message))})});var{sendMessage:H,onMessage:v}=I;_(I);const L=!1;chrome.runtime.onInstalled.addListener(async e=>{e.reason==="install"&&chrome.tabs.create({active:!0,url:chrome.runtime.getURL("src/ui/options-page/index.html#/options-page/install")}),e.reason});self.onerror=function(e,n,t,a,r){console.info("Error: "+e),console.info("Source: "+n),console.info("Line: "+t),console.info("Column: "+a),console.info("Error object: "+r)};console.log("background loaded");const d={},R=/Android/i.test(navigator.userAgent),S=!!y.webRequest,x=S?y.browserAction:chrome.action;x.setBadgeBackgroundColor({color:"#e60010"});async function W(e){((d==null?void 0:d[e])===void 0||typeof d[e]!="number")&&(d[e]=0),d[e]++,console.log("increaseBadge"),x.setBadgeText({text:d[e].toString(),tabId:e})}async function J(e,n){d[n]=e,x.setBadgeText({text:e,tabId:n})}v("updateUrl",async e=>{const{sender:n,data:t}=e;n!=null&&n.tabId&&(console.log("updateUrl"),chrome.tabs.update(n.tabId,{url:t.url}))});v("fetch",async e=>{const{data:n}=e;try{return await(await fetch(n.url,{method:"GET",headers:{accept:"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI5OWQyMWUxMmYzNjU1MjM4NzdhNTAwODVhMmVjYThiZiIsInN1YiI6IjY1M2E3Mjg3MjgxMWExMDBlYTA4NjI5OCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.x_EaVXQkg1_plk0NVSBnoNUl4QlGytdeO613nXIsP3w"}})).json()}catch(t){return console.error(t),{error:t.message}}});chrome.runtime.onMessage.addListener(function(e,n,t){var a,r;return e.type==="fullscreen"?(console.log("fullscreen"),(a=n==null?void 0:n.tab)!=null&&a.windowId&&chrome.windows.update(n.tab.windowId,{state:"fullscreen"})):e.type==="exitFullscreen"&&(console.log("exitFullscreen"),(r=n==null?void 0:n.tab)!=null&&r.windowId&&chrome.windows.update(n.tab.windowId,{state:"normal"})),!1});v("setBadgeText",async e=>{const{sender:n,data:t}=e;n!=null&&n.tabId&&J(t.text,n.tabId)});v("increaseBadge",async e=>{const{sender:n}=e;n!=null&&n.tabId&&W(n.tabId)});v("resetBadge",async e=>{const{sender:n}=e;n!=null&&n.tabId&&(d[n.tabId]&&delete d[n.tabId],x.setBadgeText({text:"",tabId:n.tabId}))});if(S&&R){let e=function(i){if(n.value.Video.userAgent){for(const o of i.requestHeaders)if(o.name==="User-Agent"){o.value=a;break}}return{requestHeaders:i.requestHeaders}};const{data:n,promise:t}=A("settings",U);r();const a="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:122.0) Gecko/20100101 Firefox/122.0 streamingEnhanced";async function r(){await t,y.webRequest.onBeforeSendHeaders.addListener(e,{urls:["*://*.disneyplus.com/*","*://*.starplus.com/*","*://*.max.com/*","*://*.hbomax.com/*","*://*.primevideo.com/*","*://*.amazon.com/gp/video/*","*://*.amazon.co.jp/gp/video/*","*://*.amazon.de/gp/video/*","*://*.amazon.co.uk/gp/video/*"]},["blocking","requestHeaders"])}}
