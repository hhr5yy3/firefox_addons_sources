let amazonMonitor,amazonMerchant,amazonProductId="",amazonSite=null,amazonIsHidden=null;async function findAmazonPriceTracker(){if(!amazonSite){let e=await getAmazonPriceTrackerSite();if(!e||!e.site)return;amazonSite=e.site}let e=await getAmazonPricetrackerProduct(amazonSite);e&&canShowWidget(e)&&buildAmazonWidget(amazonMerchant,e)}function buildAmazonWidget(e,t){let n=navigator.userAgent.toLowerCase().indexOf("firefox")>-1?"firefox":"chrome",o=document.location.hostname.replace("www.",""),a="_noba",i=getCookieValueByName(a);null==amazonIsHidden&&(amazonIsHidden=!!i,t.alternative?(amazonIsHidden="2"==i,i="2"):i||(i="1"));let r=document.createElement("div");r.id="buyon-widget";let d=document.createElement("style");d.appendChild(document.createTextNode(`\n    @font-face { font-family: 'Montserrat'; src: url('${chrome.runtime.getURL("fonts/Montserrat-Regular.ttf")}') format('truetype'); font-style: normal; font-weight: 400; }\n    @font-face { font-family: 'Montserrat'; src: url('${chrome.runtime.getURL("fonts/Montserrat-Bold.ttf")}') format('truetype'); font-style: normal; font-weight: 700; }\n  `)),r.appendChild(d);let l=r.attachShadow({mode:"open"}),c=document.createElement("style");c.appendChild(document.createTextNode("\n    :host { font-family: Montserrat, 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; display: block!important; line-height: normal; }\n    .buyon-content { position: relative; width: 220px; display: flex; gap: 16px; padding: 16px; border-radius: 10px; background-color: rgba(50,50,50,.95); color: #fff; border: 2px solid #fff; box-shadow: 0px 0px 10px rgba(0,0,0,.5); }\n    .buyon-link { color: #ff6d06; text-decoration: none; font-weight: bold; transition: all 0.2s linear; }\n    .buyon-link:hover { color: #ff832b; }\n    .buyon-btn-action { display: block; border-radius: 3px; padding: 6px; margin-top: 10px; line-height: 1.333333; text-align: center; border: 1px solid #fff; font-weight: 700; color: #ff6d06; background-color: #fff; outline: 0; text-decoration: none; transition: all 0.2s linear; }\n    .buyon-btn-action:hover { background-color: #f0f0f0; border-color: #f0f0f0; }\n    .buyon-close { font-weight: bold; color: #000; background-color: #fff; outline: 0; text-decoration: none; transition: all 0.2s linear; display: flex; align-items: center; justify-content: center; position: absolute; top: 5px; right: 5px; width: 16px; height: 16px; border-radius: 50%; font-size: 10px; }\n    .buyon-close:hover { background-color: #f0f0f0; }\n    .buyon-title { font-weight: bold; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 8px; word-break: break-word; }\n    .buyon-link-mini-cont { font-size: 11px; margin-top: 8px; }\n    .buyon-link-mini-cont > a { color: #fff; }\n    .buyon-btn-action.multiline > div:nth-child(1) { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 158px; }\n    .buyon-btn-action.multiline > div:nth-child(2) { color: #000; font-size: 10px; margin-top: 2px; }\n  ")),l.appendChild(c);let m=document.createElement("div");m.style.position="fixed",m.style.top="16px",m.style.right="16px",m.style.zIndex="65535",m.style.opacity="0",l.appendChild(m);let u=document.createElement("div");u.className="buyon-content",m.appendChild(u);let s=document.createElement("div"),p=document.createElement("img");p.src=chrome.runtime.getURL("images/buyon-icon-white.svg"),s.onclick=function(){amazonIsHidden&&(amazonIsHidden=!1,document.cookie=`${a}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`,toggleAmazonWidget(amazonIsHidden,m,u,f,s,p))},s.appendChild(p),u.appendChild(s);let f=document.createElement("div");f.className="buyon-message-cont",u.appendChild(f);let h=document.createElement("div");h.appendChild(document.createTextNode(document.querySelector('h1[id="title"]').innerText)),h.className="buyon-title",f.appendChild(h);let g="https://www.buyon.it/price-tracker";if(t.price>0&&(g=`https://www.buyon.it/price-tracker/nuovo?price=${Math.round(100*t.price)}`,t.found?g+=`&id=${t.id}`:g+=`&m=${e.id}&productId=${t.productId}&url=${encodeURIComponent(document.location.href.split("#")[0])}`,g=`${g}&utm_source=buyon&utm_medium=extension&utm_campaign=${n}&utm_term=price-tracker&utm_content=${o}`),t.alternative){let e=`https://www.buyon.it/goingnc?id=${t.alternative.id}&source=${t.alternative.source}`,n=t.alternative.price.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),o=document.createElement("a");o.href=e,o.target="_blank",o.className="buyon-btn-action multiline";let a=document.createElement("div");a.appendChild(document.createTextNode(`${n}€ su ${t.alternative.merchantName}`));let i=document.createElement("div");t.alternative.withCashback?i.appendChild(document.createTextNode("Ricorda di attivare il cashback")):i.appendChild(document.createTextNode("Cashback non disponibile")),o.appendChild(a),o.appendChild(i),f.appendChild(o);let r=document.createElement("div");r.classList="buyon-link-mini-cont";let d=document.createElement("a");d.href=g,d.target="_blank",d.appendChild(document.createTextNode("Monitora il prezzo Amazon")),r.appendChild(d),f.appendChild(r)}else{let e=document.createElement("div");e.appendChild(document.createTextNode("Ricevi un avviso se il prezzo scende.")),f.appendChild(e);let t=document.createElement("a");t.href=g,t.target="_blank",t.className="buyon-btn-action",t.appendChild(document.createTextNode("Monitora prezzo")),f.appendChild(t)}let b=document.createElement("a");b.className="buyon-close",b.href="javascript:;",b.appendChild(document.createTextNode("✕")),b.onclick=function(){let e=new Date,t=new Date(e.getTime()+864e5);document.cookie=`${a}=${i}; expires=${t.toGMTString()}; path=/`,amazonIsHidden=!0,toggleAmazonWidget(amazonIsHidden,m,u,f,s,p)},u.appendChild(b),toggleAmazonWidget(amazonIsHidden,m,u,f,s,p,!0),m.style.transition="all 0.2s ease",setTimeout((()=>{m.style.opacity=amazonIsHidden?.5:1}),1),document.body.parentElement.appendChild(r)}function toggleAmazonWidget(e,t,n,o,a,i,r=!1){o.style.display=e?"none":"block",n.style.padding=e?"0":"16px",t.style.right=e?"-184px":"16px",t.style.top=e?"50%":"16px",r||(t.style.opacity=e?.5:1),t.style.transform=e?"translateY(-50%)":"none",a.style.display=e?"flex":"block",a.style.padding=e?"8px":"0",a.style.cursor=e?"pointer":"default",i.style.width=e?"24px":"32px"}function canShowWidget(e){return!!e&&(!!e.alternative||(e.price>0||void 0))}function getAmazonPriceTrackerSite(){return new Promise((async e=>{chrome.runtime.sendMessage({command:"price-tracker-site-data",url:document.location.href},(function(t){e(t)}))}))}function startAmazonMonitor(){amazonMonitor=!0,setInterval((function(){let e=getAmazonProductId();if(e!=amazonProductId){amazonProductId=e;let t=document.getElementById("buyon-widget");t&&t.remove(),""!=amazonProductId&&findAmazonPriceTracker()}}),1e3)}function getAmazonProductId(){let e=document.getElementById("ASIN");return e?e.value:""}function getAmazonPricetrackerProduct(e){return new Promise((async t=>{if(e&&e.productIdRule&&e.priceRule){if(amazonMonitor||startAmazonMonitor(),amazonProductId=getAmazonProductId(),amazonProductId)try{let n="",o=-1,a=e.priceRule.substr(0,e.priceRule.indexOf(":")),r=e.priceRule.substr(e.priceRule.indexOf(":")+1);if("xpath"==a)n=document.evaluate(r,document,null,XPathResult.STRING_TYPE,null).stringValue;else if("json"==a){let e=document.querySelectorAll('script[type="application/ld+json"]');for(i=0;i<e.length;i++){try{let t=JSON.parse(e[0].innerText);n=String(findProp(t,r))}catch{n=""}if(n)break}}n&&(o=guessPrice(n)),chrome.runtime.sendMessage({command:"price-tracker-product-data",idMerchant:e.idMerchant,productId:amazonProductId,price:o},(function(e){if(e){var n={found:e.found,id:e.id,price:o,productId:amazonProductId,alternative:e.alternative};t(n)}else t(null)}))}catch(e){t(null)}}else t(null)}))}function getCookieValueByName(e){let t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?t[2]:""}chrome.runtime.sendMessage({command:"merchant-data",url:document.location.href},(async function(e){e&&""==e.cashback&&(amazonMerchant=e,await findAmazonPriceTracker())}));