import{R as g,M as z}from"./mention-audio.js";import{c as K,o as J,f as X,s as Y}from"./floating-ui.dom.esm.js";let C=0;function p(e){return h(g.GetValueFromStorage,e)}function h(e,t){return new Promise((n,i)=>{try{window.addEventListener("message",Q(C,n)),window.postMessage({target:"background",from:"webpage",type:e,data:t,requestId:C++})}catch(o){i(o)}})}function Q(e,t){return function n(i){i.data.target=="webpage"&&i.data.requestId==e&&(t(i.data.result),window.removeEventListener("message",n))}}let E=[],M;Z();async function Z(){te(),M=ie(),E=await p("unmutePlayerTypes"),ee(),ne()}function ee(){window.addEventListener("message",e=>{e.data.key=="unmutePlayerTypes"&&(E=e.data.value)})}function te(){const e=document.createElement;document.createElement=function(...t){let n=e.apply(document,t);return n.nodeName=="VIDEO"&&n.addEventListener("play",R),n}}function R(e){e.target.removeEventListener("play",R),T(e.target)}function ne(){try{let e=document.getElementsByTagName("vk-video-player");for(let t=0;t<e.length;t++){const n=e[t].firstChild.firstChild.shadowRoot.querySelector(":scope video");n&&T(n)}}catch(e){console.error(e)}}async function T(e){let t=document.location.pathname=="/"&&e.getRootNode().host.closest('div[class*="CatalogShowcaseStream"]')!=null,n=e.querySelector('button[data-testid="btn-settings"]')!=null,i;t?i="carousel":n?i="streamOrRecord":i="preview",await M&&E.includes(i)&&(e.muted=!1)}function ie(){return new Promise(e=>{if(navigator.userActivation.hasBeenActive){e();return}const t=setInterval(()=>{navigator.userActivation.hasBeenActive&&(clearInterval(t),e(!0))},200)})}const ae=HTMLElement.prototype.removeChild;HTMLElement.prototype.removeChild=function(...e){e[0].id!="emote-popover-trigger"&&ae.apply(this,e)};oe();function oe(){const{pushState:e,replaceState:t}=window.history;window.history.pushState=function(...n){e.apply(window.history,n),requestAnimationFrame(()=>window.dispatchEvent(new Event("pushState")))},window.history.replaceState=function(...n){t.apply(window.history,n),requestAnimationFrame(()=>window.dispatchEvent(new Event("replaceState")))}}function se(e){window.addEventListener("popstate",e),window.addEventListener("replaceState",e),window.addEventListener("pushState",e)}re();ce();function re(){document.addEventListener("click",e=>{de(e.target,4)&&N()},!0)}function ce(){const e=Element.prototype.addEventListener;HTMLDivElement.prototype.addEventListener=function(...t){t[0]=="keydown"&&this.className.includes("ce-block")&&(t[1]=ue(t[1])),Reflect.apply(e,this,t)}}function ue(e){return function(t){!t.ctrlKey&&t.key=="Enter"&&N(),e(t)}}function N(){var t;let e={};(t=document.getElementById("chat-pub-root"))==null||t.querySelectorAll(":scope .ce-paragraph.cdx-block").forEach(n=>{n.childNodes.forEach(i=>{i.tagName=="IMG"&&String(i.getAttribute("data-id")).startsWith("vkt-")&&(e[i.alt]=(e[i.alt]||0)+1,i.replaceWith(" "+i.alt+" "))})}),Object.keys(e).length>0&&h(g.SentEmoteCodes,e)}function de(e,t){let n=e;for(;t>0;){if(n){if(n.tagName=="BUTTON"&&n.className.includes("sendContainer"))return n}else return null;n=n.parentElement,t--}return null}const le="line-height: 1em; color: #006FEA; display: inline-block; font-size: 11px; line-height: 1em; background-color: #fff; padding: 4px 9px; border-radius: 30px; border: 1px solid rgba(56, 138, 229, 0.16); margin: 4px 5px 4px 0;";function w(...e){console.log("%cVK Play Tools",le,...e,new Date().toLocaleTimeString())}function pe(e,t=200){let n;return{cancel:function(){clearTimeout(n)},call:function(...i){clearTimeout(n),n=setTimeout(()=>e.apply(this,i),t)}}}let m,u,a,l;const B=pe(e=>{he(e)&&_(e)},150);O(fe);function O(e){document.body?e():requestAnimationFrame(O)}async function fe(){m=document.querySelectorAll('div[class*="OptimizedChannelsList_container"]'),l=await p("sideStreamPreview"),l.isEnabled&&D(),me()}function me(){window.addEventListener("message",e=>{e.data.key=="sideStreamPreview"&&(l=e.data.value,l.isEnabled?D():ge())})}function D(){m==null||m.forEach(e=>{e.removeEventListener("mouseenter",b,!0),e.addEventListener("mouseenter",b,!0)})}function ge(){m==null||m.forEach(e=>{e.removeEventListener("mouseenter",b,!0)})}function b(e){e.target.tagName=="A"&&(e.stopPropagation(),u=e.target,u.addEventListener("mouseleave",F),u.addEventListener("click",y),l.showMode=="hover"?B.call(u):l.showMode=="contextmenu"&&u.addEventListener("contextmenu",S),y())}function F(e){e.stopPropagation(),u.removeEventListener("mouseleave",F),u.removeEventListener("click",y),u.removeEventListener("contextmenu",S),B.cancel(),y()}function S(e){e.preventDefault(),e.stopPropagation(),u.removeEventListener("contextmenu",S),_(u)}function he(e){return e.querySelector(':scope div[class*="ViewersCounter"]')!=null}function _(e){a==null?ye():a.style.display="initial",a.src=`https://live.vkvideo.ru/app/embed${e.pathname}?autoplay=true&streamBtn=false`,a.style.width=`${l.widthPx}px`,a.style.height=`${l.widthPx*9/16}px`,K(e,a,{placement:"right",middleware:[J(15),X(),Y()]}).then(({x:t,y:n})=>{Object.assign(a.style,{left:`${t}px`,top:`${n}px`})})}function y(){a!=null&&(a.style.display="none",a.src="")}function ye(){a=document.createElement("iframe"),a.id="vkt-stream-preview",a.className="vkt-stream-preview",a.frameborder="0",a.scrolling="no",a.allowfullscreen="false",document.getElementById("vk-play-tools-root").append(a)}const x="vkt-subscribedChannelsUpdatedAtMs";Date.prototype.daysUntilNow=function(){return(Date.now()-this)/864e5};let I=!1;be();function we(){h(g.GetSubscribedChannelCount).then(ve)}function ve(e){(e==0||Ee().daysUntilNow()>1)&&setTimeout(()=>{localStorage.setItem(x,Date.now()),I||q()},5e3)}function be(){const e="user/subscriptions",t=XMLHttpRequest.prototype.open;n();function n(){XMLHttpRequest.prototype.open=function(){return arguments[1].match(e)&&this.addEventListener("readystatechange",function(s){this.readyState==4&&this.status==200&&i(s.target.responseText)}),t.apply(this,arguments)}}async function i(s){I=!0;let d=JSON.parse(s),r=d.data;r.length<d.total&&(XMLHttpRequest.prototype.open=t,r=await c(d.total),n()),o(r)}function o(s){let d=s.map(r=>({channelPath:r.blog.blogUrl,ownerId:r.blog.owner.id,avatarUrl:r.blog.owner.avatarUrl,displayName:r.blog.owner.displayName||r.blog.owner.nick||r.blog.owner.name}));h(g.SetSubscriptions,d)}async function c(s,d=100,r=!0){let P=[],W=Math.ceil(s/d);for(let v=0;v<W;v++){let G=await q(d,d*v,r);P.push(G.data.data)}return P.flat(1)}}function Ee(){return new Date(Number(localStorage.getItem(x)||0))}function q(e=100,t=0,n=!0){return window.FounderApi.user.getSubscriptions({limit:e,offset:t},n)}const $=350,U=1350;function Se(){ke(),Le(),se(A),A()}function ke(){["visibilityState","webkitVisibilityState","mozVisibilityState","msVisibilityState"].forEach(e=>{document[e]&&Object.defineProperty(document,e,{value:"visible"})}),["hidden","webkitHidden","mozHidden","msHidden"].forEach(e=>{document[e]&&Object.defineProperty(document,e,{value:!1})}),["visibilitychange","webkitvisibilitychange","mozvisibilitychange","msvisibilitychange"].forEach(e=>{window.addEventListener(e,t=>{t.stopPropagation()},!0)})}function Le(){window.addEventListener("message",e=>{e.source!==window||e.data.value==!1||(e.data.key=="isClaimChestBonus"?j():e.data.key=="isClaimDrops"&&V())})}function A(){j(),V()}function Pe(e){let t=!0,n=e.push.pub.data.type;return n=="cp_bonus_pending"?Ce(e):n=="drop_campaign_progress"?Ae(e):t=!1,t}async function Ce(e){await p("isClaimChestBonus")&&setTimeout(async()=>{await window.FounderApi.channelPointBonus.gatherPendingBonus(k(),e.push.pub.data.data.id),w("\u0441\u0443\u043D\u0434\u0443\u043A \u0441\u043E\u0431\u0440\u0430\u043D")},$)}async function Ae(e){await p("isClaimDrops")&&e.push.pub.data.data.dropProgresses.forEach(async t=>{t.currentRule.progress.goalReached===!0&&setTimeout(async()=>{await window.FounderApi.dropCampaigns.claimDropCampaignProduct(t.campaign.id),w("\u0434\u0440\u043E\u043F \u043F\u043E\u043B\u0443\u0447\u0435\u043D")},$)})}async function j(){let e=k();e.length!=0&&await p("isClaimChestBonus")&&window.FounderApi.channelPointBonus.getPendingBonus(e).then(t=>t.data.data.bonuses.forEach(n=>{setTimeout(async()=>{await window.FounderApi.channelPointBonus.gatherPendingBonus(e,n.id),w("\u0441\u0443\u043D\u0434\u0443\u043A \u0441\u043E\u0431\u0440\u0430\u043D")},U)}))}async function V(){let e=k();e.length!=0&&await p("isClaimDrops")&&window.FounderApi.drops.fetchProgress(e).then(t=>t.data.data.dropProgresses.forEach(n=>{var i,o;n.currentRule.progress.goalReached===!0&&(((o=(i=n.campaign.rules.find(s=>s.id==n.currentRule.id))==null?void 0:i.request)==null?void 0:o.state)=="done"||setTimeout(async()=>{await window.FounderApi.dropCampaigns.claimDropCampaignProduct(n.campaign.id),w("\u0434\u0440\u043E\u043F \u043F\u043E\u043B\u0443\u0447\u0435\u043D")},U))}))}function k(){return document.location.pathname.split("/")[1]}let L;Me();Re();async function Me(){L=await p("isBlockDeleteMessage")}function Re(){window.addEventListener("message",e=>{e.data.key=="isBlockDeleteMessage"&&(L=e.data.value)})}function Te(e){let t=e.push.pub.data;if(L&&(t.type=="delete_message"||t.type=="clean_chat_messages"))return Ne(t.id),e.push.pub.data.type="vk_tools_block_delete_message",JSON.stringify(e)}function Ne(e){let t=document.querySelector(`div[data-message-id="${e}"]`);t==null||t.classList.add("vkt-block-delete-message-border"),t.insertAdjacentHTML("afterbegin",'<div class="vkt-block-delete-message-title"><svg class="vkt-block-delete-message-icon"><use xlink:href="#svg-icon-delete"></use></svg>\u0423\u0434\u0430\u043B\u0435\u043D\u043D\u043E\u0435 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0435</div>')}let f;function Be(){FounderApi.user.fetchCurrent().then(e=>f=e.data).catch(console.error)}function Oe(e){if(f!=null&&e.push.pub.data.type=="message")return De(e),!0}function De(e){var i,o;let t=e.push.pub.data.data;if(t.author.nick==f.nick)return;let n=!1;n=((o=(i=t==null?void 0:t.parent)==null?void 0:i.author)==null?void 0:o.nick)==f.nick||t.data.some(c=>{if(c.type=="mention")return c.nick==f.nick;if(c.type=="text"){let s=c.content.toLowerCase();return s.includes(f.nick.toLowerCase())||s.includes(f.name.toLowerCase())}}),n&&Fe()}async function Fe(){let e=await h(g.GetNotifyAudioParams);e.isEnabled&&z.Player.play(e.src,e.volume)}function _e(e){let t=e.push.pub.data.data;if(e.push.pub.data.type=="raid_status"&&t.status=="created")return setTimeout(xe.bind(null,t.owner.blogUrl),1e3),!0}async function xe(e){if(await p("isRejectRaid")){let t=document.querySelector("div[class*=RaidNotification_control]");t==null?FounderApi.stream.rejectRaid(e):t.click()}}const Ie=[we,Se,Be],qe=[Te,_e,Pe,Oe];H();function H(){window.FounderApi?$e():requestAnimationFrame(H)}function $e(){Ie.forEach(e=>e()),Ue(je)}function Ue(e){let t=Object.getOwnPropertyDescriptor(MessageEvent.prototype,"data");const n=t.get;t.get=i,Object.defineProperty(MessageEvent.prototype,"data",t);function i(){if(!(this.currentTarget instanceof WebSocket))return n.call(this);let o=n.call(this).split(`
`).map(c=>e(c)||c).join(`
`);return Object.defineProperty(this,"data",{value:o}),o}}function je(e){try{let t,n=JSON.parse(e);return n.push==null?void 0:(qe.some(i=>{let o=i(n);return typeof o=="string"&&(t=o),o}),t)}catch(t){console.error(e,t)}}
