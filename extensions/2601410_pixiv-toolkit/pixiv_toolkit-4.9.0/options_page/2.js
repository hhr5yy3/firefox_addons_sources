(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{195:function(t,e,s){},196:function(t,e,s){},197:function(t,e,s){"use strict";s(195)},198:function(t,e,s){"use strict";var a=s(3),n=s.n(a),i=s(4),o=s.n(i),c=s(6),r=s.n(c),l=s(13),d=s.n(l),u=function(){function t(){n()(this,t),this.db=new d.a("asset_caches",{revs_limit:1}),this.maxLimit=2e3,this.init()}return o()(t,[{key:"init",value:function(){return this.db.createIndex({index:{fields:["cached_at"]}})}},{key:"checkLimitationAndRemove",value:function(){var t=this;this.db.allDocs().then((function(e){var s=e.rows.length-t.maxLimit;s>0&&t.db.find({selector:{cached_at:{$gte:null}},sort:[{cached_at:"asc"}],limit:s}).then((function(e){e.docs.forEach((function(e){t.db.remove(e).catch((function(t){console.log(t)}))}))}))}))}},{key:"putAsset",value:function(t,e){var s=this;return this.checkLimitationAndRemove(),new Promise((function(a){s.db.get(t).then((function(){a()})).catch((function(){a(s.db.put({_id:t,asset:e,cached_at:parseInt((Date.now()+"").substr(0,10))}))}))}))}},{key:"retrieveAsset",value:function(t){var e=this;return new Promise((function(s,a){e.db.get(t).then((function(t){s(t)})).catch((function(t){a(t)}))}))}}]),t}(),h=function(){function t(){n()(this,t),this.assetCacheRepo=new u,this.cachedAssets=new Map,this.cachedLimit=1e3}return o()(t,[{key:"getCache",value:function(t){var e=this;return new Promise((function(s){e.cachedAssets.size>e.cachedLimit&&e.cachedAssets.delete(e.cachedAssets.entries().next()),e.cachedAssets.has(t)?s(e.cachedAssets.get(t)):e.assetCacheRepo.retrieveAsset(t).then((function(a){e.cachedAssets.has(t)||e.cachedAssets.set(t,a.asset.data),s(a.asset.data)})).catch((function(a){console.log(a),e.fetchAsset(t).then((function(a){if(a.length<=102400)return e.assetCacheRepo.putAsset(t,{url:t,data:a}),void s(a);s(a)})).catch((function(e){s(t)}))}))}))}},{key:"fetchAsset",value:function(t){return new Promise((function(e,s){var a=new XMLHttpRequest;a.open("GET",t),a.responseType="blob",a.onload=function(){if(200===a.status){var t=new FileReader;t.onloadend=function(){e(t.result)},t.readAsDataURL(a.response)}else s(Error("Cannot fetch asset from remote"))},a.onerror=function(t){s(t)},a.send()}))}}],[{key:"getInstance",value:function(){return t.instance||(t.instance=new t),t.instance}}]),t}();r()(h,"instance",void 0);var f={props:{placeholder:{required:!1,type:String,default:""},src:{required:!0,type:String},defaultImage:{type:String,default:"data:image/gif;base64,R0lGODlhAQABAIAAAN/f3wAAACH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS41LWMwMTQgNzkuMTUxNDgxLCAyMDEzLzAzLzEzLTEyOjA5OjE1ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjhFRUMzOEMwMDY4QjExRUFCMTUwRDEyRjc1QThERDhDIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjhFRUMzOEMxMDY4QjExRUFCMTUwRDEyRjc1QThERDhDIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OEVFQzM4QkUwNjhCMTFFQUIxNTBEMTJGNzVBOEREOEMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OEVFQzM4QkYwNjhCMTFFQUIxNTBEMTJGNzVBOEREOEMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4B//79/Pv6+fj39vX08/Lx8O/u7ezr6uno5+bl5OPi4eDf3t3c29rZ2NfW1dTT0tHQz87NzMvKycjHxsXEw8LBwL++vby7urm4t7a1tLOysbCvrq2sq6qpqKempaSjoqGgn56dnJuamZiXlpWUk5KRkI+OjYyLiomIh4aFhIOCgYB/fn18e3p5eHd2dXRzcnFwb25tbGtqaWhnZmVkY2JhYF9eXVxbWllYV1ZVVFNSUVBPTk1MS0pJSEdGRURDQkFAPz49PDs6OTg3NjU0MzIxMC8uLSwrKikoJyYlJCMiISAfHh0cGxoZGBcWFRQTEhEQDw4NDAsKCQgHBgUEAwIBAAAh+QQAAAAAACwAAAAAAQABAAACAkQBADs="},mode:{required:!1,type:String,default:"image"},cacheService:{type:Object,default:function(){return h.getInstance()}}},data:function(){return{imageSrc:null}},computed:{usedSrc:function(){return this.imageSrc||this.placeholder}},watch:{src:function(t){var e=this;this.imageSrc=this.defaultImage,this.cacheService.getCache(t).then((function(t){e.imageSrc=t}))}},mounted:function(){var t=this;this.cacheService.getCache(this.src).then((function(e){t.imageSrc=e}))}},m=(s(197),s(1)),v=Object(m.a)(f,(function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"cacheable-image"},["image"===this.mode?e("img",{attrs:{src:this.usedSrc}}):"background"===this.mode?e("div",{staticClass:"cacheable-image-bg",style:{backgroundImage:"url("+this.usedSrc+")"}}):this._e()])}),[],!1,null,null,null);e.a=v.exports},199:function(t,e,s){"use strict";s(196)},200:function(t,e,s){"use strict";var a={props:{title:String}},n=(s(199),s(1)),i=Object(n.a)(a,(function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"page-title__wrap"},[e("h1",[this._v(this._s(this.title))])])}),[],!1,null,"72d44518",null);e.a=i.exports},203:function(t,e,s){},207:function(t,e,s){"use strict";s(203)},208:function(t,e,s){"use strict";s.r(e);s(201);var a=s(204),n=s(200),i=s(198),o=s(3),c=s.n(o),r=s(4),l=s.n(r),d=s(153),u=s.n(d),h=s(154),f=s.n(h),m=s(10),v=s.n(m),p=s(6),w=s.n(p),g=s(7),y=function(){function t(){c()(this,t),this.browser=g.a.getBrowser(),this.port=null}return l()(t,[{key:"createPort",value:function(t){return this.port="string"==typeof t?this.browser.runtime.connect({name:t}):t,this}},{key:"createListener",value:function(){var t=this;this.port.onMessage.addListener((function(e,s){if(e.action&&"function"==typeof t[e.action+"Action"])t[e.action+"Action"].call(t,e.args,s)})),this.port.onDisconnect.addListener((function(){console.log("Disconnect")}))}},{key:"getRawId",value:function(e,s){if([t.illustType,t.novelType].indexOf(s)<0)throw Error('Invalid download record type "'.concat(s,'"'));return s+e}},{key:"sendMessageThroughPort",value:function(e,s,a){e.postMessage(Object.assign({channel:"".concat(t.portName,":").concat(s)},a))}},{key:"responseSuccess",value:function(t,e,s){this.sendMessageThroughPort(t,e,s?{data:s}:{})}},{key:"responseError",value:function(t,e,s){this.sendMessageThroughPort(t,e,{error:s})}},{key:"isChannel",value:function(e,s){return e==="".concat(t.portName,":").concat(s)}}]),t}();function _(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var s,a=v()(t);if(e){var n=v()(this).constructor;s=Reflect.construct(a,arguments,n)}else s=a.apply(this,arguments);return f()(this,s)}}w()(y,"instance",void 0),w()(y,"illustType","I"),w()(y,"novelType","N"),w()(y,"portName","download-record-port");var D=function(t){u()(s,t);var e=_(s);function s(){var t;return c()(this,s),(t=e.call(this)).createPort(y.portName),t}return l()(s,[{key:"postMessage",value:function(t){try{this.port.postMessage(t)}catch(t){}}},{key:"saveDownloadRecord",value:function(t){var e=t.id,s=t.record,a=t.type;this.postMessage({action:"saveDownloadRecord",args:{id:e,record:s,type:a}})}},{key:"getDownloadRecord",value:function(t){var e=t.id,s=t.type;this.postMessage({action:"getDownloadRecord",args:{id:e,type:s}})}},{key:"getDownloadRecordsFromIds",value:function(t){var e=t.ids,s=t.responseArgs;this.postMessage({action:"getDownloadRecordsFromIds",args:{ids:e,responseArgs:s}})}},{key:"getDownload",value:function(t){var e=t.id,s=t.type;this.postMessage({action:"getDownload",args:{id:e,type:s}})}},{key:"deleteDownload",value:function(t){var e=t.id;this.postMessage({action:"deleteDownload",args:{id:e}})}},{key:"listDownloads",value:function(t){t=Object.assign({selector:{downloaded_at:{$gte:null}},sort:[{downloaded_at:"desc"}],limit:50,skip:0,query:null},t),this.postMessage({action:"listDownloads",args:t})}},{key:"clearDownloads",value:function(){this.postMessage({action:"clearDownloads"})}}],[{key:"getInstance",value:function(){return s.instance?s.instance:s.instance=new s}}]),s}(y);w()(D,"instance",void 0);var b=s(0),A=s.n(b),k={components:{"page-title":n.a,"cacheable-image":i.a,"recycle-scroller":a.a},data:function(){return{total:0,datasets:[],offset:0,step:50,loading:!1,allLoaded:!1,confirmDialog:!1,searchQuery:"",searchTimeout:null}},created:function(){this.windowScrollEventBinded=!1,this.downloadsPort=D.getInstance(),this.downloadsPort.port.onMessage.addListener(this.handleDownloadsPortResponse),this.latestListDate=null,"zh_CN"===this.$i18n.locale?(this.dateFormat="YYYY[年]MMMMDD[日] dddd",this.timeFormat="A h:mm"):(this.dateFormat="dddd, MMMM DD, YYYY",this.timeFormat="h:mmA")},mounted:function(){this.getDatasets()},beforeDestroy:function(){window.removeEventListener("scroll",this.handleScroll)},computed:{statusNotice:function(){return this.datasets.length<=0?"There is no any downloads":this.allLoaded?"There is no more downloads":""}},watch:{searchQuery:function(t){var e=this;this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout((function(){e.datasets=[],e.offset=0,t.trim().length>0?e.searchDatasets():e.getDatasets()}),800)}},methods:{caseDate:function(t){return A.a.unix(t).format(this.timeFormat)},caseWorkUrl:function(t){return"N"===t._id[0]?"https://www.pixiv.net/novel/show.php?id="+t._id.substr(1):"https://www.pixiv.net/en/artworks/"+t._id.substr(1)},caseWorkType:function(t){return 0===t._id.indexOf("I")?"Artwork":0===t._id.indexOf("N")?"Novel":"Unkown"},caseUserUrl:function(t){return"https://www.pixiv.net/member.php?id=".concat(t)},handleScroll:function(){document.documentElement.scrollHeight-window.innerHeight-window.scrollY<window.innerHeight/2&&!this.loading&&!this.allLoaded&&(this.searchQuery.trim().length>0?this.searchDatasets():this.getDatasets())},openInNew:function(t){window.open(this.caseWorkUrl(t))},handleDownloadsPortResponse:function(t,e){if(void 0!==t.error)throw t.error;if(this.downloadsPort.isChannel(t.channel,"list-downloads")){if(this.windowScrollEventBinded||(window.addEventListener("scroll",this.handleScroll),this.windowScrollEventBinded=!1),t.data.datasets.length>0){for(var s=0;s<t.data.datasets.length;s++){var a=t.data.datasets[s];if(null===this.latestListDate){this.latestListDate=new Date(1e3*a.downloaded_at),this.latestListDate.setHours(0),this.latestListDate.setMinutes(0),this.latestListDate.setSeconds(0),this.latestListDate.setMilliseconds(0);var n=this.latestListDate.getTime();t.data.datasets.splice(s,0,{_id:n,time:n}),s++}else{var i=new Date(1e3*a.downloaded_at);if(this.latestListDate.getTime()>i.getTime()){i.setHours(0),i.setMinutes(0),i.setSeconds(0),i.setMilliseconds(0);var o=i.getTime();t.data.datasets.splice(s,0,{_id:o,time:o}),this.latestListDate=i,s++}}}this.datasets=this.datasets.concat(t.data.datasets),t.data.datasets.length<this.step?this.allLoaded=!0:this.offset+=this.skip}this.loading=!1}},deleteItem:function(t){this.confirmDialog=!0,this.downloadsPort.deleteDownload({id:t._id}),this.datasets.splice(this.datasets.indexOf(t),1)},getDatasets:function(){this.loading=!0,this.downloadsPort.listDownloads({limit:this.step,skip:this.offset})},searchDatasets:function(){this.loading=!0,this.downloadsPort.listDownloads({limit:this.step,skip:this.offset,query:this.searchQuery.toLowerCase()})},formatDate:function(t){return A()(t).format(this.dateFormat)},clearAll:function(){window.confirm("Remove all downloads history? This operate cannot be reversed.")&&(this.downloadsPort.clearDownloads(),this.datasets=[])}}},M=(s(207),s(1)),R=Object(M.a)(k,(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"container container--small page-history"},[s("div",{staticClass:"download__header"},[s("v-text-field",{staticClass:"search-panel",attrs:{label:"Solo","single-line":"",solo:"",flat:"",placeholder:t.tl("_search")},model:{value:t.searchQuery,callback:function(e){t.searchQuery=e},expression:"searchQuery"}})],1),t._v(" "),s("div",{staticClass:"download__header-action"},[s("v-btn",{staticStyle:{"margin-left":"0"},attrs:{depressed:"",disabled:0===t.datasets.length},on:{click:t.clearAll}},[t._v("\n      Clear all\n    ")])],1),t._v(" "),t.datasets.length>0?s("v-layout",{staticClass:"download-items",attrs:{row:"",wrap:""}},[s("recycle-scroller",{staticClass:"scroller",attrs:{items:t.datasets,"item-size":50,"page-mode":"","key-field":"_id"},scopedSlots:t._u([{key:"default",fn:function(e){var a=e.item;return[a.time?s("div",{staticClass:"download-date"},[t._v(t._s(t.formatDate(a.time)))]):s("div",{staticClass:"download-item"},[t._e(),t._v(" "),s("div",{staticClass:"download-item__info"},[s("div",{staticClass:"download-item__info-time"},[t._v(t._s(t.caseDate(a.downloaded_at)))]),t._v(" "),s("div",{staticClass:"download-item__info-title"},[s("a",{attrs:{href:t.caseWorkUrl(a)}},[t._v(t._s(a.title||a._id))])]),t._v(" "),s("div",{staticClass:"download-item__info-user"},[s("a",{attrs:{href:t.caseUserUrl(a.userId)}},[t._v(t._s(a.userName))])]),t._v(" "),s("div",{staticClass:"download-item__info-id"},[t._v(t._s(t.caseWorkType(a)+" "+a._id.substr(1)))])]),t._v(" "),s("div",{staticClass:"download-item__actions"},[s("v-btn",{staticClass:"download-item__actions-btn",attrs:{flat:"",icon:"",small:""},on:{click:function(e){return t.deleteItem(a)}}},[s("svg",{staticClass:"c01204",attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 2048 2048",width:"16",height:"16"}},[s("path",{attrs:{d:"M1115 1024l690 691-90 90-691-690-691 690-90-90 690-691-690-691 90-90 691 690 691-690 90 90-690 691z"}})])])],1)])]}}],null,!1,2603080482)})],1):t._e(),t._v(" "),t.statusNotice?s("p",{staticClass:"download__status-notice"},[t._v("\n    "+t._s(t.statusNotice)+"\n  ")]):t._e(),t._v(" "),t.loading?s("div",{staticStyle:{"text-align":"center",clear:"both","margin-top":"20px"}},[s("v-progress-circular",{attrs:{indeterminate:"",color:"primary"}})],1):t._e()],1)}),[],!1,null,null,null);e.default=R.exports}}]);