import{Bookmarks,Containers,DEFAULT_SETTINGS,GROUP_URL,Info,Menu,NOID,Permissions,Settings,Sidebar,Snapshots,Store,Styles,Tabs2 as Tabs,URL_URL,V4_GROUP_URL_LEN,V4_URL_URL_LEN,WebReq,Windows,err,favicons_bg_exports,getSidebarConfigFromV4,info,ipc_exports,isV4GroupUrl,isV4UrlUrl,loadFavicons2 as loadFavicons,onConnected,onDisconnected,recreateNormalizedObject,registerActions,saveFavicon,sendToSidebar,setInstanceType,setInstanceType2,setupConnectionListener,setupGlobalMessageListener,sleep,translate,upgradeFaviCache,versionToInt,warn}from"../chunk-4KZVVU6Z.js";import"../chunk-FF3JOXTG.js";(async function(){Info.setInstanceType(0),setInstanceType2(0),setInstanceType(0);let ts=performance.now();if(info("Init start"),registerActions({cacheTabsData:Tabs.cacheTabsData,getGroupPageInitData:Tabs.getGroupPageInitData,tabsApiProxy:Tabs.tabsApiProxy,getSidebarTabs:Tabs.getSidebarTabs,openTabs:Tabs.openTabs,createSnapshot:Snapshots.createSnapshot,addSnapshot:Snapshots.addSnapshot,removeSnapshot:Snapshots.removeSnapshot,openSnapshotWindows:Snapshots.openWindows,createWindowWithTabs:Windows.createWithTabs,isWindowTabsLocked:Windows.isWindowTabsLocked,saveFavicon,saveInLocalStorage:Store.setFromRemoteFg,checkIpInfo:WebReq.checkIpInfo,disableAutoReopening:WebReq.disableAutoReopening,enableAutoReopening:WebReq.enableAutoReopening,checkUpgrade,continueUpgrade}),setupGlobalMessageListener(),setupConnectionListener(),await Promise.all([Windows.loadWindows(),Containers.load(),Settings.loadSettings(),Info.loadVersionInfo()]),Info.isMajorUpgrade()){await upgrade();return}Info.saveVersion(),Windows.setupWindowsListeners(),Containers.setupContainersListeners(),Settings.setupSettingsChangeListener(),await Sidebar.loadNav(),Sidebar.setupListeners(),WebReq.updateReqHandlers(),Tabs.setupTabsListeners(),await Tabs.loadTabs(),Permissions.loadPermissions(),Permissions.setupListeners(),loadFavicons(),Menu.setupListeners(),Snapshots.scheduleSnapshots(),onConnected(2,winId=>{info("IPC.onConnected sidebar",winId);let tabs=Windows.byId[winId]?.tabs;tabs&&Tabs.initInternalPageScripts(tabs),Settings.state.markWindow&&winId!==NOID&&sendToSidebar(winId,"updWindowPreface")}),onDisconnected(2,winId=>{info("IPC.onDisconnected sidebar",winId),Windows.byId[winId]&&browser.windows.update(winId,{titlePreface:""})}),window.getSideberyState=()=>({IPC:ipc_exports,Info,Settings,Windows,Tabs,Containers,Sidebar,Favicons:favicons_bg_exports,Snapshots,Menu,Permissions}),initToolbarButton(),browser.runtime.onUpdateAvailable.addListener(details=>{let currentVersion=versionToInt(browser.runtime.getManifest().version);versionToInt(details.version)<=currentVersion&&browser.runtime.reload()}),info(`Init end: ${performance.now()-ts}ms`)})();function initToolbarButton(){Menu.createSettingsMenu(),browser.browserAction.onClicked.addListener((_,info2)=>{info2&&info2.button===1?browser.runtime.openOptionsPage():browser.sidebarAction.toggle()})}var upgrading;async function upgrade(){let sNoteDone=translate("upgrade.status.done"),sNoteInProgress=translate("upgrade.status.in_progress"),sNoteNo=translate("upgrade.status.no"),sNoteErr=translate("upgrade.status.err"),msg={title:translate("upgrade.initializing"),note:sNoteInProgress,status:"in-progress"};upgrading={messages:[msg],status:"loading"},await waitForUpgradeCheck();let newStorage={ver:Info.reactive.addonVer},stored;try{stored=await browser.storage.local.get()}catch(err2){err("Upgrading: Cannot get stored data",err2);let errStr=err2 instanceof Error?err2.toString():"";msg=upgradeMsg(translate("upgrade.err.get_stored"),errStr,"err"),upgrading.status="err"}if(stored){if(stored.containers_v4&&(newStorage.containers=Containers.upgradeV4Containers(stored.containers_v4)),upgradeTabsDataCache(stored,newStorage),msg.status="done",msg.note=sNoteDone,msg=upgradeMsg(translate("upgrade.settings"),sNoteInProgress,"in-progress"),await sleep(250),stored.settings?(newStorage.settings=recreateNormalizedObject(stored.settings,DEFAULT_SETTINGS),newStorage.settings.theme="proton",newStorage.settings.tabDoubleClick!=="none"&&(newStorage.settings.tabsSecondClickActPrev=!1),stored.settings.hScrollThroughPanels===!0?newStorage.settings.hScrollAction="switch_panels":stored.settings.hScrollThroughPanels===!1&&(newStorage.settings.hScrollAction="none"),stored.settings.moveNewTabPin==="none"&&(newStorage.settings.moveNewTabPin="start"),msg.status="done",msg.note=sNoteDone):(msg.status="no",msg.note=sNoteNo),msg=upgradeMsg(translate("upgrade.panels_nav"),sNoteInProgress,"in-progress"),await sleep(250),stored.expandedBookmarks&&(newStorage.expandedBookmarkFolders=Bookmarks.convertOldTreeStruct(stored.expandedBookmarks)),stored.panels_v4?.length)try{newStorage.sidebar=getSidebarConfigFromV4(stored.panels_v4),msg.status="done",msg.note=sNoteDone}catch(err2){err("Upgrading: Cannot upgrade panels",err2),msg.status="err",msg.note=sNoteErr}else msg.status="no",msg.note=sNoteNo;if(msg=upgradeMsg(translate("upgrade.snapshots"),sNoteInProgress,"in-progress"),await sleep(250),stored.snapshots_v4?.length)try{newStorage.snapshots=Snapshots.convertFromV4(stored.snapshots_v4),msg.status="done",msg.note=sNoteDone}catch(err2){err("Upgrading: Cannot upgrade snapshots",err2),msg.status="err",msg.note=sNoteErr}else msg.status="no",msg.note=sNoteNo;if(msg=upgradeMsg(translate("upgrade.fav_cache"),sNoteInProgress,"in-progress"),await sleep(250),stored.favicons?.length&&stored.favUrls)try{await upgradeFaviCache(stored,newStorage),msg.status="done",msg.note=sNoteDone}catch(err2){err("Upgrading: Cannot upgrade favicons",err2),msg.status="err",msg.note=sNoteErr}else msg.status="no",msg.note=sNoteNo;if(msg=upgradeMsg(translate("upgrade.styles"),sNoteInProgress,"in-progress"),await sleep(250),stored.cssVars||stored.sidebarCSS||stored.groupCSS)try{Styles.upgradeCustomStyles(stored,newStorage),msg.status="done",msg.note=sNoteDone}catch(err2){err("Upgrading: Cannot upgrade styles",err2),msg.status="err",msg.note=sNoteErr}else msg.status="no",msg.note=sNoteNo;msg=upgradeMsg(translate("upgrade.data_ready"),translate("upgrade.data_ready_note"),"done"),upgrading.status="done"}await waitForApprovingUpgrade(),upgrading.status="loading",msg=upgradeMsg(translate("upgrade.links"),translate("upgrade.data_ready_note"),"in-progress"),await recreateGroupTabs(),msg.status="done",msg.note=sNoteDone;let toRemove=["favicons","favAutoCleanTime","favUrls","containers_v4","tabsData_v4","prevTabsData_v4","panels_v4","snapshots_v4","tabsMenu","bookmarksMenu","tabsPanelMenu","bookmarksPanelMenu","cssVars","expandedBookmarks","panelIndex"];try{await browser.storage.local.remove(toRemove)}catch(err2){err("Upgrade: Cannot remove old storage values",err2);try{await browser.storage.local.clear()}catch(err3){let errStr=err3 instanceof Error?err3.toString():"";err("Upgrade: Cannot clear storage",err3),msg=upgradeMsg(translate("upgrade.err.clear_stored"),errStr,"err"),await sleep(250),msg=upgradeMsg(translate("upgrade.err.finish"),"","finish"),upgrading.status="finish";return}}try{await browser.storage.local.set(newStorage)}catch(err2){let errStr=err2 instanceof Error?err2.toString():"";err("Upgrade: Cannot set new values",err2),msg=upgradeMsg(translate("upgrade.err.set_stored"),errStr,"err"),await sleep(250),msg=upgradeMsg(translate("upgrade.err.finish"),"","finish"),upgrading.status="finish";return}msg=upgradeMsg(translate("upgrade.done"),translate("upgrade.done_note"),"done"),await sleep(1e3),browser.runtime.reload()}function upgradeMsg(title,note,status){let msg={title,note,status};return upgrading&&upgrading.messages.push(msg),msg}var _firstUpgradeCheck;async function waitForUpgradeCheck(){return new Promise(res=>{_firstUpgradeCheck=()=>{res(),_firstUpgradeCheck=void 0}})}function checkUpgrade(){return upgrading?(_firstUpgradeCheck&&_firstUpgradeCheck(),upgrading):null}var _continueUpgrade;async function waitForApprovingUpgrade(){return new Promise(res=>{_continueUpgrade=res})}function continueUpgrade(){_continueUpgrade&&_continueUpgrade()}function upgradeV4GroupUrl(url){let titleEndIndex=url.indexOf(":id:",V4_GROUP_URL_LEN);return titleEndIndex===-1&&(titleEndIndex=void 0),GROUP_URL+url.slice(V4_GROUP_URL_LEN,titleEndIndex)}function upgradeV4UrlUrl(url){return URL_URL+url.slice(V4_URL_URL_LEN)}async function recreateGroupTabs(){let windows=await browser.windows.getAll({windowTypes:["normal"],populate:!0}),tabsCreating=[];for(let win of windows){if(win.id===void 0||!win.tabs)continue;let querying=win.tabs.map(t=>browser.sessions.getTabValue(t.id,"data")),tabsData=await Promise.all(querying)??[],groupsData=await browser.sessions.getWindowValue(win.id,"groups");if(!groupsData)continue;let indexOffset=0,tabsMap={};for(let i=0;i<win.tabs.length;i++){let tab=win.tabs[i],tabData=tabsData[i];if(!(!tab||!tabData)&&(isV4GroupUrl(tab.url)&&(tab.url=upgradeV4GroupUrl(tab.url),await browser.tabs.update(tab.id,{url:tab.url}).catch(()=>{warn("Upgrade: Cannot update group page url")})),isV4UrlUrl(tab.url)&&(tab.url=upgradeV4UrlUrl(tab.url),await browser.tabs.update(tab.id,{url:tab.url}).catch(()=>{warn("Upgrade: Cannot update url-placeholder page url")})),tabsMap[tabData.id]=tabData,!(tabData.parentId===void 0||tabData.parentId===-1)&&!tabsMap[tabData.parentId]&&groupsData[tabData.parentId]&&!tabsMap[tabData.parentId])){let groupTabData=groupsData[tabData.parentId],index=i+indexOffset;tabsCreating.push(createUpgradedGroupTab(groupTabData,index,win.id)),indexOffset++,tabsMap[groupTabData.id]=groupTabData;let existedParentTab=tabsMap[groupTabData.parentId];for(groupTabData=groupsData[groupTabData.parentId];groupTabData;)existedParentTab||(tabsCreating.push(createUpgradedGroupTab(groupTabData,index,win.id)),indexOffset++,tabsMap[groupTabData.id]=groupTabData),existedParentTab=tabsMap[groupTabData.parentId],groupTabData=groupsData[groupTabData.parentId]}}}try{await Promise.allSettled(tabsCreating)}catch(err2){err("recreateGroupTabs: Creating tabs",err2)}await sleep(1e3)}async function createUpgradedGroupTab(groupTabData,index,windowId){let tab;try{tab=await browser.tabs.create({active:!1,index,url:upgradeV4GroupUrl(groupTabData.url),cookieStoreId:groupTabData.ctx,windowId})}catch(err2){err("createUpgradedGroupTab: Cannot create tab",err2);return}try{await browser.sessions.setTabValue(tab.id,"data",{id:groupTabData.id,panelId:groupTabData.panelId,parentId:groupTabData.parentId,folded:groupTabData.folded})}catch(err2){err("createUpgradedGroupTab: Cannot save data",err2)}return tab}function upgradeTabsDataCache(oldStorage,newStorage){if(oldStorage.tabsData_v4&&(newStorage.tabsDataCache=oldStorage.tabsData_v4),newStorage.tabsDataCache)for(let winTabs of newStorage.tabsDataCache)for(let tab of winTabs)isV4GroupUrl(tab.url)&&(tab.url=upgradeV4GroupUrl(tab.url)),isV4UrlUrl(tab.url)&&(tab.url=upgradeV4UrlUrl(tab.url))}
