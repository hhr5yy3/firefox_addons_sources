(()=>{"use strict";var e={d:(t,r)=>{for(var a in r)e.o(r,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:r[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{L:()=>_});var t={LOG_TYPE:{NONE:-1,EMERGENCY:0,ALERT:1,CRITICAL:2,ERROR:3,WARNING:4,NOTICE:5,INFO:6,DEBUG:7},loglevel:7,Init:function(){},Uninit:function(){},SetLogLevel:function(e){e>=this.LOG_TYPE.NONE&&e<=this.LOG_TYPE.DEBUG&&(this.loglevel=e)},LogDebug:function(e){this.loglevel>=this.LOG_TYPE.DEBUG&&this.PrintLog(e)},LogInfo:function(e){this.loglevel>=this.LOG_TYPE.INFO&&this.PrintLog(e)},LogNotice:function(e){this.loglevel>=this.LOG_TYPE.NOTICE&&this.PrintLog(e)},LogError:function(e){this.loglevel>=this.LOG_TYPE.ERROR&&this.PrintLog(e)},PrintLog:function(e){var t;t=this.GenerateTimeString()+", "+e,console.log(t)},GenerateTimeString:function(){var e,t,r,a,s,i=new Date;return e=i.getMonth()+1<10?"0"+String(i.getMonth()+1):String(i.getMonth()+1),t=i.getDate()<10?"0"+String(i.getDate()):String(i.getDate()),r="",i.getHours()<10&&(r="0"),r+=String(i.getHours()),a="",i.getMinutes()<10&&(a="0"),a+=String(i.getMinutes()),s="",i.getSeconds()<10&&(s="0"),s+=String(i.getSeconds()),i.getFullYear()+"-"+e+"-"+t+" "+(r+":"+a+":"+s)}},r={bypass_private_ip:!1,async_mode:!1,main_url_rate_only:!1,safesearch:!1,log_all_URLs:!1,ems_version:null,restrictionLevel:"0",videoFilterConfig:{enabled:!1,siteSettings:{youtube:{hideComment:!1,safeSearch:!1,restrictionLevel:"1"}}},SetDefault:function(){this.safesearch=!1,this.videoFilterConfig.siteSettings.youtube.safeSearch=!1,this.videoFilterConfig.siteSettings.youtube.hideComment=!1}};function a(e,t,r,a){this.url=e,this.tabId=t,this.token=a,this.info_type=r}var s={category_version:"7",cat_list:{0:{name:"Unrated",group:0},1:{name:"Drug Abuse",group:1},2:{name:"Alternative Beliefs",group:2},3:{name:"Hacking",group:1},4:{name:"Illegal or Unethical",group:1},5:{name:"Discrimination",group:1},6:{name:"Explicit Violence",group:1},7:{name:"Abortion",group:2},8:{name:"Other Adult Materials",group:2},9:{name:"Advocacy Organizations",group:2},11:{name:"Gambling",group:2},12:{name:"Extremist Groups",group:1},13:{name:"Nudity and Risque",group:2},14:{name:"Pornography",group:2},15:{name:"Dating",group:2},16:{name:"Weapons (Sales)",group:2},17:{name:"Advertising",group:6},18:{name:"Brokerage and Trading",group:6},19:{name:"Freeware and Software Downloads",group:4},20:{name:"Games",group:6},23:{name:"Web-based Email",group:6},24:{name:"File Sharing and Storage",group:4},25:{name:"Streaming Media and Download",group:4},26:{name:"Malicious Websites",group:5},28:{name:"Entertainment",group:6},29:{name:"Arts and Culture",group:6},30:{name:"Education",group:6},31:{name:"Finance and Banking",group:7},33:{name:"Health and Wellness",group:6},34:{name:"Job Search",group:6},35:{name:"Medicine",group:6},36:{name:"News and Media",group:6},37:{name:"Social Networking",group:6},38:{name:"Political Organizations",group:6},39:{name:"Reference",group:6},40:{name:"Global Religion",group:6},41:{name:"Search Engines and Portals",group:7},42:{name:"Shopping",group:6},43:{name:"General Organizations",group:7},44:{name:"Society and Lifestyles",group:6},46:{name:"Sports",group:6},47:{name:"Travel",group:6},48:{name:"Personal Vehicles",group:6},49:{name:"Business",group:7},50:{name:"Information and Computer Security",group:7},51:{name:"Government and Legal Organizations",group:7},52:{name:"Information Technology",group:7},53:{name:"Armed Forces",group:7},54:{name:"Dynamic Content",group:6},55:{name:"Meaningless Content",group:6},56:{name:"Web Hosting",group:7},57:{name:"Marijuana",group:2},58:{name:"Folklore",group:6},59:{name:"Proxy Avoidance",group:1},61:{name:"Phishing",group:5},62:{name:"Plagiarism",group:1},63:{name:"Sex Education",group:2},64:{name:"Alcohol",group:2},65:{name:"Tobacco",group:2},66:{name:"Lingerie and Swimsuit",group:2},67:{name:"Sports Hunting and War Games",group:2},68:{name:"Web Chat",group:6},69:{name:"Instant Messaging",group:6},70:{name:"Newsgroups and Message Boards",group:6},71:{name:"Digital Postcards",group:6},72:{name:"Peer-to-peer File Sharing",group:4},75:{name:"Internet Radio and TV",group:4},76:{name:"Internet Telephony",group:4},77:{name:"Child Education",group:6},78:{name:"Real Estate",group:6},79:{name:"Restaurant and Dining",group:6},80:{name:"Personal Websites and Blogs",group:6},81:{name:"Secure Websites",group:7},82:{name:"Content Servers",group:6},83:{name:"Child Abuse",group:1},84:{name:"Web-based Applications",group:7},85:{name:"Domain Parking",group:6},86:{name:"Spam URLs",group:5},87:{name:"Personal Privacy",group:6},88:{name:"Dynamic DNS",group:5},89:{name:"Auction",group:6},90:{name:"Newly Observed Domain",group:5},"91:":{name:"Newly Registered Domain",group:5},92:{name:"Charitable Organizations",group:7},93:{name:"Remote Access",group:7},94:{name:"Web Analytics",group:7},95:{name:"Online Meeting",group:7}},group_list:{0:"Unrated",1:"Potentially Liable",2:"Adult/Mature Content",4:"Bandwidth Consuming",5:"Security Risk",6:"General Interest - Personal",7:"General Interest - Business"},url_rate_item_array:[],url_rate_timer_started:!1,save_web_access_stat_timer:null,send_web_access_stat_timer:null,item_expire_timeout:6048e5,web_access_statistics:{},stats_dirty:!1,emssn:null,total_pending_task:0,url_rate_init:function(){t.LogDebug("url_rate_init is called"),this.web_access_statistics={};try{var e=localStorage.web_access_statistics;null!=e&&(t.PrintLog("cached web access statistics:"+e),this.web_access_statistics=JSON.parse(e))}catch(e){t.PrintLog("failed to get cached web access statistics data")}},Init:function(){var e;e=this,this.save_web_access_stat_timer=setInterval((function(){e.save_web_access_statistics_data()}),3e4),this.send_web_access_stat_timer=setInterval((function(){e.SendoutStats()}),3e5)},Uninit:function(){if(null!=this.save_web_access_stat_timer&&clearInterval(this.save_web_access_stat_timer),null!=this.send_web_access_stat_timer&&clearInterval(this.send_web_access_stat_timer),r.async_mode)for(;this.url_rate_item_array.length;)this.url_rate_item_array.pop()},set_mode:function(e){if(r.async_mode,0==e)for(r.async_mode=!1,this.url_rate_timer_started=!1;this.url_rate_item_array.length;)this.url_rate_item_array.pop();else r.async_mode=!0},save_web_access_statistics_data:function(){try{localStorage.web_access_statistics=JSON.stringify(this.web_access_statistics)}catch(e){t.LogError("failed to save cached web access statistics data, error:"+e.message)}},url_rate:function(e,s,i,o){var n,l=this;if(0,"main_frame"==i&&1,(p={}).action=1,r.async_mode){var u=new a(e,s,i,o);this.url_rate_item_array.push(u),this.url_rate_timer_started||(setTimeout((function(){l.url_rating_timer()}),10),this.url_rate_timer_started=!0)}else{var c,g,m,d,h,b=new XMLHttpRequest;_.rating_server_port_index>=_.rating_server_ports_list.length&&(_.rating_server_port_index=0),n=_.rating_server_ports_list[_.rating_server_port_index],_.rating_server_port_index++;var p,f,v=`http://localhost:${n}/rate?url=${e}`;try{b.overrideMimeType("text/plain"),b.open("GET",v,!1),b.send()}catch(e){console.log("Error happened while rating web site, error:"+e.message)}if(_.SetLastAccessTime(),"4"==b.readyState&&200==b.status)if(console.log("response from rating server:"+b.response),c=(p=JSON.parse(b.response)).category,3==(g=p.action)&&"main_frame"!=i&&(g=2),h=p.customized_page?p.customized_page:"",_.EnableExtension(p.enabled),4==g&&_.SetMonitorThisPage(s,e),1!=g&&_.TabsStatusUpdate(s,i,e,g,c,h),"yt-navigate-finish"===o&&(s in _.chrome_tabs_status||(_.chrome_tabs_status[s]={action:g,rating:c,url:e,bar_url:e,customized_page:h,block_page:!1,time:""}),_.chrome_tabs_status[s].bar_url=e,_.chrome_tabs_status[s].customized_page=h),2==g||3==g)return 2==g?"main_frame"==i?(m=_.chrome_tabs_status[s].customized_page.length>0?chrome.extension.getURL("../customize.html"):chrome.extension.getURL("../block.html"),m+="?tabid=",m+=s,chrome.tabs.update(s,{url:m},(function(e){chrome.runtime.lastError?t.LogDebug("UrlRating()  exception happened while calling chrome.tabs.update()"):_.BlockTab(s)})),{cancel:!0}):{cancel:!0}:_.IsCategoryInIgnoreList(c)?{cancel:!1}:(f="  UrlRating()",f+="show warning page under sync mode, action:"+g,f+=", url:"+e,t.LogDebug(f),d=_.chrome_tabs_status[s].customized_page.length>0?chrome.extension.getURL("../customize.html"):chrome.extension.getURL("../warning.html"),d+="?tabid=",d+=s,chrome.tabs.update(s,{url:d},(function(e){chrome.runtime.lastError?t.LogDebug("UrlRating()  exception happened while calling chrome.tabs.update()"):_.BlockTab(s)})),{cancel:!0})}return{cancel:!1}},url_rate_table_clear:function(e){for(var t=[];this.url_rate_item_array.length;){var r=this.url_rate_item_array.pop();r.tabId!=e&&t.push(r)}this.url_rate_item_array=t},generate_web_content:function(e,t){var r="unknown";return this.cat_list[String(t)]&&(r=this.cat_list[String(t)].name),"data:text/html,<div>According to the policy, web site "+e+" is blocked, rating result:"+r+"</div>"},get_rating_info:function(e){var t,r="";return-1==e||-2==e?r=-1==e?"unknown":"black list":null!=this.cat_list[String(e)]&&(t=this.cat_list[String(e)].group,r=this.group_list[String(t)],r+=":",r+=this.cat_list[String(e)].name),r},process_rating_category:function(e,r,a,s){t.LogDebug("block this url:"+e.url),this.generate_web_content(e.url,r),4==a&&_.SetMonitorThisPage(e.tabId,e.url),1!=a&&_.TabsStatusUpdate(e.tabId,e.info_type,decodeURIComponent(e.url),a,r,s),e.info_type},url_rating_timer:function(){var e,r=this;if(this.total_pending_task>=1)setTimeout((function(){r.url_rating_timer()}),10);else if(void 0!==(e=this.url_rate_item_array.pop())){this.total_pending_task++;var a=`http://localhost:${_.rating_server_current_port}/rate?url=${e.url}`,s=new XMLHttpRequest;s.overrideMimeType("text/plain"),s.tabId=e.tabId,s.url=e.url,s.token=e.token,s.info_type=e.info_type,s.open("GET",a,!0),s.onreadystatechange=function(){if("4"==s.readyState){if("200"==s.status){var a,i,o;t.LogDebug("******** rating result:"+s.responseText+" tabId:"+s.tabId+" url:"+s.url+"  ********");var n=JSON.parse(s.response);i=n.category,3==(a=n.action)&&"main_frame"!=s.info_type&&(a=2),o=n.customized_page?n.customized_page:"","yt-navigate-finish"===s.token&&(_.chrome_tabs_status[e.tabId].bar_url=e.url,_.chrome_tabs_status[e.tabId].customized_page=o,_.chrome_tabs_status[e.tabId].action=a),r.process_rating_category(s,i,a,o),s=void 0}else t.LogError("Error happened while rating web site, error:"+s.status),r.process_rating_category(s,0,1,""),s=void 0,0==r.url_rate_item_array.length?r.url_rate_timer_started=!1:setTimeout((function(){r.url_rating_timer()}),10);r.total_pending_task>0&&r.total_pending_task--}0==r.url_rate_item_array.length?r.url_rate_timer_started=!1:setTimeout((function(){r.url_rating_timer()}),10)},s.onerror=function(){t.LogDebug("Error happened while rating web site under async mode"),r.total_pending_task>0&&r.total_pending_task--,s=void 0,0==r.url_rate_item_array.length?r.url_rate_timer_started=!1:setTimeout((function(){r.url_rating_timer()}),10)},s.send(),_.SetLastAccessTime()}else 0==this.url_rate_item_array.length?this.url_rate_timer_started=!1:setTimeout((function(){r.url_rating_timer()}),10)},is_google_hostname:function(e){var t;return t=!0,-1==/(\w+):\/\/([\w.\-]+)(:\d*)?(\/.*)/i.exec(e)[2].indexOf("google")&&(t=!1),t},SendoutStats:function(){var e,a,s,i,o;if(this.stats_dirty){a=this;var n,l,u=[];o=(l=Object.keys(this.web_access_statistics)).length;for(var c=0;c<o;c++)(n={}).category=Number(l[c]),n.count=this.web_access_statistics[l[c]],u.push(n);e=JSON.stringify(u),s=new XMLHttpRequest,i=r.no_auth_server?r.profileserverurl+"/userid-stat":r.profileserverurl+"/token-stat",s.open("POST",i,!0),s.setRequestHeader("Content-type","application/json"),r.no_auth_server?s.setRequestHeader("UserID",_.id_token):s.setRequestHeader("Token",_.id_token),s.timeout=1e4,s.ontimeout=function(){t.LogDebug("send web access stats timed out."),s=void 0},s.onreadystatechange=function(){"4"==s.readyState&&("200"==s.status?(t.LogDebug("web access stats are sent successfully"),a.web_access_statistics={},localStorage.removeItem("web_access_statistics"),a.stats_dirty=!1):t.LogError("Error happened when sending web access statistics data to EMS")),s=void 0},s.send(e)}}},i={catver:5,fdn_category_id:{"-1":"Unknown",0:"Not Rated",1:"Business",2:"Entertainment",3:"Games",4:"Knowledge",5:"Lifestyle",6:"Music",7:"News",8:"People",9:"Society",10:"Sports"},type:{1:"Regular",2:"Made for Kids",3:"Age Restricted"},ACTION:{ALLOW:1,BLOCK:2,WARN:3,MONITOR:4},tabsStatusYoutube:{},rateVideo:function(e,t){_.rating_server_port_index>=_.rating_server_ports_list.length&&(_.rating_server_port_index=0);var r=_.rating_server_ports_list[_.rating_server_port_index];_.rating_server_port_index+=1;var a=`http://localhost:${r}/rate?video=youtube&channelurl=${e}`;console.log(a),t&&(a+=`&videourl=${t}`);var s=new XMLHttpRequest;try{s.overrideMimeType("text/plain"),s.open("GET",a,!1),s.send()}catch(e){console.log("Error happened while rating video, error:"+e.message)}return"4"==s.readyState&&200==s.status?JSON.parse(s.response):{action:1,category:0}},rateYouTubeChannel:function(e,a,s,i){if(t.LogInfo(`Video Rating - Youtube - ChannelUrl ${e} VideoUrl${a} tabId ${s}`),r.videoFilterConfig.enabled){var o=r.videoFilterConfig.siteSettings.youtube.hideComment,n=this.rateVideo(e,a),l=parseInt(n.action);if(l===this.ACTION.BLOCK){i({block:!0,hideComment:o});var u=this.fdn_category_id[n.category],c="";if(n.customized_page){if(-1!==(b=(c=(c=n.customized_page).replace(/<div class="category">[^<]*<\/div>/,`<div class="category">${u}</div>`)).indexOf('<div class="reeval">'))){var g=16;if(-1===(p=c.indexOf("</a></div></div>"))&&(p=c.indexOf("</a></div> </div>"),g=17),-1!==p){var m=c.slice(0,b),d=c.slice(p+g);c=m+d}}-1==n.category&&c.replace("inaccessible.","inaccessible or video has not yet been rated.")}this.tabsStatusYoutube[s]={channelUrl:e,videoUrl:a,category:u,customizePage:c},h=""===c?chrome.runtime.getURL("video.html"):chrome.extension.getURL("../videoCustomize.html"),"Firefox"===_.browserInfo?browser.tabs.goBack(s).then((function(){browser.tabs.update(s,{url:h}).then((function(){browser.runtime.lastError?t.logError(`WebFilterProcess - scanTabsAndBlock - FAILED - Cannot update tab ${s}: ${chrome.runtime.lastError.message}`):_.BlockTab(s)}))})):chrome.tabs.goBack(s,(function(){chrome.tabs.update(s,{url:h},(function(){chrome.runtime.lastError?t.logError(`WebFilterProcess - scanTabsAndBlock - FAILED - Cannot update tab ${s}: ${chrome.runtime.lastError.message}`):_.BlockTab(s)}))}))}else if(l===this.ACTION.WARN){var h;i({block:!0,hideComment:o});u=this.fdn_category_id[n.category],c="";if(n.customized_page){var b;if(-1!==(b=(c=(c=(c=n.customized_page).replace(/<div class="category">[^<]*<\/div>/,`<div class="category">${u}</div>`)).replace(/blocking access to .* until/,`blocking access to "${u}" until`)).indexOf('<div class="reeval">'))){var p;g=16;if(-1===(p=c.indexOf("</a></div></div>"))&&(p=c.indexOf("</a></div> </div>"),g=17),-1!==p){m=c.slice(0,b),d=c.slice(p+g);c=m+d}}-1==n.category&&c.replace("inaccessible.","inaccessible or video has not yet been rated.")}this.tabsStatusYoutube[s]={channelUrl:e,videoUrl:a,category:u,customizePage:c},h=""===c?chrome.runtime.getURL("video.html"):chrome.extension.getURL("../videoCustomize.html"),console.log(_.browserInfo),"Firefox"===_.browserInfo?browser.tabs.goBack(s).then((function(){browser.tabs.update(s,{url:h}).then((function(){browser.runtime.lastError?t.logError(`WebFilterProcess - scanTabsAndBlock - FAILED - Cannot update tab ${s}: ${chrome.runtime.lastError.message}`):_.BlockTab(s)}))})):chrome.tabs.goBack(s,(function(){chrome.tabs.update(s,{url:h},(function(){chrome.runtime.lastError?t.logError(`WebFilterProcess - scanTabsAndBlock - FAILED - Cannot update tab ${s}: ${chrome.runtime.lastError.message}`):_.BlockTab(s)}))}))}else i({block:!1,hideComment:o})}else i({block:!1,hideComment:!1})}};function o(){this.action=1,this.rating="0",this.url="",this.bar_url="",this.block_page=!1,this.time="",this.customized_page=""}function n(e){this.url=e,this.time_created=new Date,this.monitor_this_page=!1,this.category="N/A"}var _={browserInfo:null,platforminfo:null,platform_os:null,authed:!1,window_created:!1,token_error:!1,browser:"chrome",error_no:0,test:!1,ext_version:null,local_IP:null,devid:null,tabId:null,lasterr:null,ignore_pages:["chrome-extension://","chrome://","chrome-devtools://devtools","edge://","edge-extensions://","https://accounts.google","https://accounts.gstatic.com","https://accounts.youtube.com","https://clients1.google.com","https://clients2.google.com","https://clients3.google.com","https://clients4.google.com","https://clients5.google.com","https://clients6.google.com","https://commondatastorage.googleapis.com","https://cros-omahaproxy.appspot.com","https://dl.google.com","https://dl-ssl.google.com","https://gweb-gettingstartedguide.appspot.com","https://m.google.com","https://omahaproxy.appspot.com","https://pack.google.com","https://safebrowsing-cache.google.com","https://safebrowsing.google.com","https://ssl.gstatic.com","https://storage.googleapis.com","https://tools.google.com","https://www.googleapis.com","https://fonts.gstatic.com","https://fonts.googleapis.com","https://security.google.com"],re_ignore_pages:[/https?:\/\/.*?\.googleusercontent.com\/.*/,/https?:\/\/.*?\.gstatic\.com\/?.*/,/https?:\/\/clients(\d)?\.google\.com\/?.*/],youtube_pages:[/^https?:\/\/www\.youtube\.com/,/^https?:\/\/m\.youtube\.com/,/^https?:\/\/youtubei\.googleapis\.com/,/^https?:\/\/youtube\.googleapis\.com/,/^https?:\/\/www\.youtube-nocookie\.com/],YOUTUBE_MODE:{NONE:0,STRICT:1,MODERATE:2},youtube_current_mode:0,timer_id:0,session_id:null,block_timer:0,chrome_tabs_status:[],current_tab_id:null,url_browse_time_table:{},mouse_move:!1,last_move_time:null,monitor_all_page:!1,mouse_move_tab_id:null,mouse_move_url:null,keepalive_timer:0,idle_timeout:18e4,warning_timeout:18e4,rating_server_start_port:17713,rating_server_total_port:10,rating_server_current_port:0,rating_server_ports_list:[],rating_server_last_access:0,rating_server_port_index:0,rating_server_request_started:!1,initial_test_timeout:1e4,initial_test_start:0,rating_server_ready:!0,rating_server_enabled:!1,rating_server_retry_count:0,keepalive_request_interval:1e3,keepalive_request_timeout:4e3,keepalive_retry_count:0,keepalive_revert_default_interval:3e4,last_keepalive_ok:0,request_id:0,youtubeBlockedChannels:[],tabsStatusYoutube:{},ignore_category:{},RESTRICTION_LEVEL:{STRICT:"1",MODERATE:"0"},ACTION:{ALLOW:1,BLOCK:2,WARN:3,MONITOR:4},GetRequestId:function(){var e=this.request_id;return this.request_id++,e},AddIgnoreCategory:function(e,t){this.ignore_category[String(t)]=e},IsCategoryInIgnoreList:function(e){var t=!1,r=new Date;return null!=this.ignore_category[String(e)]&&r<this.ignore_category[String(e)]&&(t=!0),t},onBeforeSendHeaders:function(e){var a=r.safesearch,s=r.videoFilterConfig.siteSettings.youtube.safeSearch;if(!a&&!s)return{};if(this.youtube_pages.some((function(t){return t.test(e.url)}))){var i=e.requestHeaders;if(i){var o=i.filter((function(e){return"youtube-restrict"!==e.name.toLowerCase()})),n=_.RESTRICTION_LEVEL.MODERATE,l=_.RESTRICTION_LEVEL.MODERATE;a&&(n=r.restrictionLevel),s&&(l=r.videoFilterConfig.siteSettings.youtube.restrictionLevel);var u=n;switch(l>n&&(u=l),u){case this.RESTRICTION_LEVEL.MODERATE:o.push({name:"YouTube-Restrict",value:"Moderate"});break;case this.RESTRICTION_LEVEL.STRICT:o.push({name:"YouTube-Restrict",value:"Strict"});break;default:t.LogError(`Unexpected RESTRICTION_LEVEL: ${r.restrictionLevel}.`)}return{requestHeaders:o}}}return{}},EnableSafeSearch:function(e){e?(r.safesearch=!0,this.youtube_current_mode=_.YOUTUBE_MODE.STRICT):(r.safesearch=!1,this.youtube_current_mode=_.YOUTUBE_MODE.NONE)},SafeSearch:function(e,a){var s,i=!1;return s=r.restrictionLevel===this.RESTRICTION_LEVEL.STRICT?"strict":"moderate",-1==e.indexOf("www.bing.com/search?")&&-1==e.indexOf("www.bing.com/images/search?")&&-1==e.indexOf("www.bing.com/videos/search?")||-1!=e.indexOf("adlt=")?-1!=e.indexOf("search.yahoo")&&-1!=e.indexOf("/search")&&-1==e.indexOf("vm=r")?(t.LogDebug("it is yahoo search"),a.redirectUrl=e+"&vm=r",i=!0):-1==e.indexOf("www.google")||-1!=e.indexOf("safe=active")||-1==e.indexOf("&q=")&&-1==e.indexOf("#q=")&&-1==e.indexOf("?q=")||(t.LogDebug("it is google search"),a.redirectUrl=e+"&safe=active",i=!0):(t.LogDebug("it is bing search"),a.redirectUrl=`${e}&adlt=${s}`,i=!0),i},IsPrivateIP:function(e){try{var t=(e=new URL(e)).hostname;if("localhost"===t)return!0;var r=t.split(".").map((e=>parseInt(e,10)));return 4===r.length&&!r.some((e=>e<0||e>255||isNaN(e)))&&(127===r[0]||(10===r[0]||(172===r[0]&&r[1]>=16&&r[1]<=31||192===r[0]&&168===r[1])))}catch(e){return!1}},OnBeforeWebRequest:function(e){var a,i,n,_=e.url;if(_){for("OnBeforeWebRequest  ","Web request URL:"+_,",tabId:"+e.tabId,",type:"+e.type,a=this.ignore_pages.length,u=0;u<a;u++)if(_.startsWith(this.ignore_pages[u]))return{cancel:!1};if(""==_)return{cancel:!1};if(_.startsWith("file://"))return{cancel:!1};if(!_.startsWith("http")&&(-1!==_.indexOf("http://")||-1!==!_.indexOf("https://"))){var l=_.match(/(http|https):\/\/[^\s]+/);if(t.LogInfo("Testing possible URL in data or blob"),l)for(var u=0;u<l.length;u++)try{new URL(l[u]),_=l[u];break}catch(e){t.LogDebug(e);continue}}if(r.bypass_private_ip&&this.IsPrivateIP(_))return{cancel:!1};if(_.startsWith("data:"))return{cancel:!1};if(_.startsWith("blob:"))return{cancel:!1};if(i=_,-1!=(n=_.indexOf("//"))&&(5!=n&&6!=n||-1!=(n=_.indexOf("/",n+2))&&(i=_.substring(0,n))),this.rating_server_ready&&this.rating_server_enabled&&-1!=e.tabId){var g=c(_);if("main_frame"==e.type&&(null==this.chrome_tabs_status[e.tabId]&&(this.chrome_tabs_status[e.tabId]=new o),this.chrome_tabs_status[e.tabId].url=g,this.chrome_tabs_status[e.tabId].bar_url=_),t.LogDebug("OnBeforeWebRequest()  BaseUrl:"+g),r.safesearch){var m={redirectUrl:""};if(this.SafeSearch(_,m))return m}for(a=this.re_ignore_pages.length,u=0;u<a;u++)if(this.re_ignore_pages[u].test(i))return{cancel:!1};return r.main_url_rate_only?"main_frame"==e.type?s.url_rate(encodeURIComponent(_),e.tabId,e.type,this.id_token):{cancel:!1}:s.url_rate(encodeURIComponent(_),e.tabId,e.type,this.id_token)}return{cancel:!1}}},BlockTab:function(e){this.chrome_tabs_status[e]&&(this.chrome_tabs_status[e].block_page=!0)},GetValue:function(e,t){var r=e.substr(e.indexOf("&")+1),a="";params=r.split("&");for(var s=0;s<params.length;s++)querystrpair=params[s].split("="),[querystrpair[0]]==t&&(a=querystrpair[1]);return a},SetTabId:function(e){void 0!==e&&void 0!==e.id?this.tabId=e.id:this.authed=!1},SetMonitorThisPage:function(e,r){var a;null!=this.url_browse_time_table[e]&&this.url_browse_time_table[e].url==r&&(this.url_browse_time_table[e].monitor_this_page=!0,a="SetMonitorThisPage()  monitor_this_page is set",a+=",tabId:"+e,a+=",url:"+r,t.LogDebug(a))},ResetMonitorThisPage:function(e,r){var a;this.url_browse_time_table[e]&&this.url_browse_time_table[e].url==r&&(this.url_browse_time_table[e].monitor_this_page=!1,a="ResetMonitorThisPage()  monitor_this_page is set",a+=",tabId:"+e,a+=",url:"+r,t.LogDebug(a))},SetMouseMoveEvent:function(e){var t,r;if(this.mouse_move){if(this.last_move_time=new Date,this.mouse_move_tab_id!=this.current_tab_id||this.mouse_move_url!=e){for(var a in t=!1,this.url_browse_time_table)if(this.url_browse_time_table[a].url==e){t=!0,r=a;break}t&&r!=this.current_tab_id&&(this.current_tab_id=r,this.url_browse_time_table[r].time_created=new Date,this.mouse_move_tab_id=r,this.mouse_move_url=e)}}else{for(var a in t=!1,this.url_browse_time_table)if(this.url_browse_time_table[a].url==e){t=!0,r=a;break}t&&(this.current_tab_id=r,this.url_browse_time_table[r].time_created=new Date,this.mouse_move_tab_id=r,this.mouse_move_url=e,this.mouse_move=!0,this.last_move_time=new Date)}},BlockTabTimer:function(){var e=this;chrome.tabs.query({},(function(r){for(var a=0;a<r.length;a++)if(null!=r[a]){var s=c(r[a].url),i=r[a].id;if(s.length>0&&void 0!==e.chrome_tabs_status[i]){var o,n;if(2==e.chrome_tabs_status[i].action)e.chrome_tabs_status[i].action=0,t.LogDebug("BlockTabTimer()  block web page in timer thread"),o=e.chrome_tabs_status[i].customized_page.length>0?chrome.extension.getURL("../customize.html"):chrome.extension.getURL("../block.html"),o+="?tabid=",o+=i,chrome.tabs.update(i,{url:o}),e.BlockTab(i);if(3==e.chrome_tabs_status[i].action)e.chrome_tabs_status[i].action=0,n=e.chrome_tabs_status[i].customized_page.length>0?chrome.extension.getURL("../customize.html"):chrome.extension.getURL("../warning.html"),n+="?tabid=",n+=i,chrome.tabs.update(i,{url:n}),e.BlockTab(i)}}}))},UpdateBrowseTimeItme:function(e,t){this.url_browse_time_table[e]&&(this.url_browse_time_table[e].category=t)},AddUrlBrowseTimeItem:function(e,r){var a;null==this.url_browse_time_table[e]?(a="AddUrlBrowseTimeItem()  url_browse_time_item",a+=" tabId: "+e,a+=" url: "+r,a+=" has been added into table",t.LogDebug(a),this.url_browse_time_table[e]=new n(r)):this.url_browse_time_table[e].url!=r&&(a="AddUrlBrowseTimeItem()  url_browse_time_item",a+=" tabId: "+e,a+=" url: "+r,a+=" has been updated",t.LogDebug(a),this.url_browse_time_table[e].url=r,this.url_browse_time_table[e].time_created=new Date)},DeleteUrlBrowseTimeItem:function(e){var r;null!=this.url_browse_time_table[e]&&(r="DeleteUrlBrowseTimeItem()  item ",r+=" tabId: "+e,r+=" url: "+this.url_browse_time_table[e].url,r+=" has been removed",t.LogDebug(r),delete this.url_browse_time_table[e])},OnTabRemoved:function(e){null!=this.url_browse_time_table[e]&&this.DeleteUrlBrowseTimeItem(e)},OnTabActivated:function(e){if(null!=this.current_tab_id){this.current_tab_id;if(this.current_tab_id==e)return}this.current_tab_id=e,null!=this.url_browse_time_table[e]&&(this.url_browse_time_table[e].time_created=new Date)},On_Tab_Replaced:function(e,t){this.url_browse_time_table[t]!=undefine&&this.DeleteUrlBrowseTimeItem(t),this.current_tab_id=e},OnTabUpdated:function(e,t,r){if(t.startsWith("chrome://newtab/")||t.startsWith("data:text/html"))null!=this.url_browse_time_table[e]&&this.DeleteUrlBrowseTimeItem(e);else{var a,s,i=!1;if(null==this.url_browse_time_table[e]||this.url_browse_time_table[e].url!=t){for(a=this.ignore_pages.length,s=0;s<a;s++)if(t.startsWith(this.ignore_pages[s])){i=!0;break}if(!i)for(a=this.re_ignore_pages.length,s=0;s<a;s++){this.re_ignore_pages[s].test(t)&&(i=!0);break}i||null!=this.url_browse_time_table[e]&&(this.url_browse_time_table[e].url=t,this.url_browse_time_table[e].time_created=new Date)}}},TabsStatusUpdate:function(e,a,s,i,o,n){var _,l;if(void 0!==this.chrome_tabs_status[e]&&(!this.IsCategoryInIgnoreList(o)||3!=i)){if(_=this.chrome_tabs_status[e].action,l=!1,r.async_mode){if(r.main_url_rate_only)this.chrome_tabs_status[e].bar_url==s&&(l=!0);else if(2!=_&&3!=_&&"main_frame"==a)l=!0;else if("main_frame"!=a&&2==i){var u=chrome.extension.getURL("../logo128.png");chrome.tabs.sendMessage(e,{block_url:s,action_url:u},(function(e){chrome.runtime.lastError&&t.LogDebug(chrome.runtime.lastError.message)}))}}else(3!=_||3==_&&2==i)&&(l=!0);if((2==i||3==i)&&l){var c=new Date;c=new Date(c.getTime()+this.warning_timeout),t.LogDebug("TabsStatusUpdate()--tabid:"+e+",action before set:"+this.chrome_tabs_status[e].action+",action set:"+i+",rating before set:"+this.chrome_tabs_status[e].rating+",rating set:"+o+",url before set:"+this.chrome_tabs_status[e].url+",urrl set:"+s),this.chrome_tabs_status[e].action=i,this.chrome_tabs_status[e].url=s,this.chrome_tabs_status[e].time=c,this.chrome_tabs_status[e].rating=o,this.chrome_tabs_status[e].customized_page=n}}},ReportUrlAction:function(e,t,a,s,i,o){(null!=this.url_browse_time_table[e]&&this.url_browse_time_table[e].url==t||r.log_all_URLs)&&(null==this.url_browse_time_table[e]||this.url_browse_time_table[e].url!=t||this.url_browse_time_table[e].monitor_this_page||this.monitor_all_page||this.DeleteUrlBrowseTimeItem(e))},ComputerIdleDetect:function(){this.mouse_move&&(new Date-this.last_move_time>=this.idle_timeout&&(this.mouse_move=!1))},SetMode:function(e){var t;t=this,0==e?(r.async_mode=!1,0!=this.block_timer&&(clearInterval(this.block_timer),this.block_timer=0)):(r.async_mode=!0,0==this.block_timer&&(this.block_timer=setInterval((function(){t.BlockTabTimer()}),500)))},SendKeepAlive:function(){var e,a=this;new Date-this.rating_server_last_access<=this.keepalive_request_interval||(this.rating_server_request_started=!0,e=this.rating_server_start_port+this.rating_server_total_port-1,chrome.extension.isAllowedIncognitoAccess((function(s){var i=new XMLHttpRequest,o=`http://localhost:${a.rating_server_current_port}/rate?keepalive=1&browsername=${a.browser}&incognito=${+s}`;i.overrideMimeType("text/plain"),i.timeout=a.keepalive_request_timeout,i.onreadystatechange=function(){if("4"==i.readyState&&"200"==i.status){a.keepalive_retry_count=0;new Date;a.rating_server_ready=!0;var e=JSON.parse(i.response);a.SaveConfig(e),a.rating_server_request_started=!1}},i.ontimeout=function(){a.keepalive_retry_count+=1,10===a.keepalive_retry_count&&(r.safesearch=!1),a.rating_server_ready=!1,t.LogDebug("SendKeepAlive timeout:"+new Date),a.rating_server_retry_count++,a.rating_server_retry_count<a.rating_server_total_port&&(a.rating_server_current_port++,a.rating_server_current_port>e&&(a.rating_server_current_port=a.rating_server_start_port),a.rating_server_request_started=!1)},i.onerror=i.ontimeout;try{i.open("GET",o,!0),i.send()}catch(e){t.LogDebug("Error happened while sending keepalive message, error:"+e.message),a.rating_server_ready=!1,a.rating_server_request_started=!1}})))},SaveConfig:function(e){var t=this.RESTRICTION_LEVEL.MODERATE,a=Boolean(parseInt(e.enabled)||!1),i=Boolean(parseInt(e.safesearch)||!1),o=e.strict||t,n=parseInt(e.async_mode)||0,_=Boolean(parseInt(e.addressbar_only)||!1),l=e.ports;(this.rating_server_enabled=a,r.bypass_private_ip=Boolean(parseInt(e.bypass_private_ip)||!1),i?(this.EnableSafeSearch(!0),r.restrictionLevel=o||t):this.EnableSafeSearch(!1),s.set_mode(n),this.SetMode(n),r.main_url_rate_only=_,this.rating_server_ports_list=l,this.rating_server_total_port=l.length,e.video&&(r.videoFilterConfig.enabled=Boolean(parseInt(e.video.enabled)||!1),r.videoFilterConfig.siteSettings.youtube.hideComment=Boolean(parseInt(e.video.hide_comments)||!1),r.videoFilterConfig.siteSettings.youtube.safeSearch=Boolean(parseInt(e.video.safe_search)||!1),r.videoFilterConfig.siteSettings.youtube.restrictionLevel=1===parseInt(e.video.restriction_level)?this.RESTRICTION_LEVEL.MODERATE:this.RESTRICTION_LEVEL.STRICT),e.scheduled)&&(Boolean(parseInt(e.scheduled)||!1)||(r.main_url_rate_only=!1,r.async_mode=!1));this.rating_server_ready=!0},EnableExtension:function(e){this.rating_server_enabled=Boolean(parseInt(e))},SetLastAccessTime:function(){this.rating_server_last_access=new Date}};function l(e){if(!_.rating_server_ready||!e.startTime)return;const r=new Date(e.startTime);if(Date.now()-r.getTime()>5e3)return;const a=e.url.trim()||e.finalUrl.trim();if(function(e){return!!(e.startsWith("about")||e.startsWith("chrome")||e.startsWith("file://")||e.startsWith("data:"))}(a))return;const{enabled:s,action:i,category:n,customized_page:l}=function(e){try{const r=`http://localhost:${function(){_.rating_server_port_index>=_.rating_server_ports_list.length&&(_.rating_server_port_index=0);const e=_.rating_server_ports_list[_.rating_server_port_index];return _.rating_server_port_index++,e}()}/rate?url=${encodeURIComponent(e)}`,a=new XMLHttpRequest;if(a.overrideMimeType("text/plain"),a.open("GET",r,!1),a.send(),_.SetLastAccessTime(),4==a.readyState&&200==a.status){t.LogDebug("Url rated successfully");return JSON.parse(a.response)}}catch(e){t.LogError("Error happened while rating url, error:"+e.message)}}(a);s&&i&&(i!=_.ACTION.BLOCK&&i!=_.ACTION.WARN||(t.LogDebug("Pausing Download"),chrome.downloads.pause(e.id,(()=>{chrome.tabs.create({},(t=>{const r=t.id;r in _.chrome_tabs_status||(_.chrome_tabs_status[r]=new o),_.chrome_tabs_status[r].url=a,_.chrome_tabs_status[r].bar_url=a,_.TabsStatusUpdate(r,"main_frame",a,i,n,l);const s=(l?"../customize.html":i==_.ACTION.BLOCK?"../block.html":"../warning.html")+"?tabid="+r,u=chrome.runtime.getURL(s);console.log(u),chrome.tabs.update(r,{url:u},(()=>{_.BlockTab(r)})),chrome.downloads.cancel(e.id),"interrupted"===e.state?chrome.downloads.erase({id:e.id}):"complete"===e.state&&chrome.downloads.removeFile(e.id)}))}))))}function u(){var e,a=new Date;t.LogDebug("Ext_Initializer Enter at "+a);try{t.LogDebug("LogManager:"+t),t.LogDebug("UrlRate:"+s)}catch(e){if(t.LogDebug("exception happened"),e instanceof ReferenceError)return void setTimeout((function(){u()}),2e3)}try{browser.runtime.getBrowserInfo(),_.browser="firefox"}catch(e){-1!==chrome.runtime.getManifest().description.indexOf("Chrome")?_.browser="chrome":_.browser="edge"}_.rating_server_current_port=_.rating_server_start_port,_.initial_test_start=new Date,_.keepalive_timer=setInterval((function(){_.rating_server_retry_count=0,_.SendKeepAlive()}),_.keepalive_request_interval),chrome.webRequest.onBeforeRequest.addListener((function(e){return _.OnBeforeWebRequest(e)}),{urls:["<all_urls>"]},["blocking"]),chrome.webRequest.onBeforeSendHeaders.addListener((function(e){return _.onBeforeSendHeaders(e)}),{urls:["<all_urls>"]},["blocking","requestHeaders"]),chrome.downloads.onCreated.addListener(l),chrome.tabs.onUpdated.addListener((function(e,r,a){var s;s="chrome.tabs.onUpdated is called,",s+=" tabId:"+e,s+=" status:"+r.status,s+=" url:"+a.url,t.LogDebug(s),_.OnTabUpdated(e,a.url,r.status),_.window_created=!0})),chrome.tabs.onRemoved.addListener((function(e,r){var a;a="chrome.tabs.onRemoved is called,",a+=" tabId:"+e,t.LogDebug(a),_.OnTabRemoved(e)})),chrome.tabs.onCreated.addListener((function(e){new Date,_.window_created=!0})),chrome.tabs.onActivated.addListener((function(e){var r;r="chrome.tabs.onActivated is called,",r+=" tabId:"+e.tabId,t.LogDebug(r),_.OnTabActivated(e.tabId),_.window_created=!0})),chrome.tabs.onReplaced.addListener((function(e,r){var a;a="chrome.tabs.onReplaced is called,",a+=" addedTabId:"+e,a+=" removedTabId:"+r,t.LogDebug(a),_.window_created=!0})),chrome.tabs.onHighlighted.addListener((function(e){var r,a,s;for(r="chrome.tabs.onHighlighted is called,",r+=" windowId:"+e.windowId,a=e.tabIds.length,s=0;s<a;s++)r+=" tab:"+e.tabIds[s];t.LogDebug(r),_.window_created=!0})),e=chrome.runtime.getManifest(),_.ext_version=e.version,chrome.runtime.onMessage.addListener((function(e,a,o){switch(t.LogDebug(a.tab?"from a content script:"+a.tab.url:"from the extension"),e.action){case"loginagain":o({action:"done"}),_.OnRelogin();break;case"setloglevel":var n=0;"Error"==e.level?n=4:"Info"==e.level?n=7:"Debug"==e.level&&(n=8),t.SetLogLevel(n);break;case"clearcache":break;case"setmode":var l=0;"async"==e.mode&&(l=1,r.main_url_rate_only=e.main_url_rate_only),"1"==e.safe_search?r.safesearch=!0:r.safesearch=!1,s.set_mode(l),_.SetMode(l);break;case"config_request":var u={mode:"sync"};r.async_mode&&(u.mode="async",u.main_url_rate_only=!1,r.main_url_rate_only&&(u.main_url_rate_only=!0)),u.safe_search="0",r.safesearch&&(u.safe_search="1"),o(u);break;case"mouse_move":case"mouse_wheel":t.LogDebug("requst:"+e.action+" url:"+e.url),o(u={}),_.SetMouseMoveEvent(e.url);break;case"get_warning_web_page_info":var c,g,m;if(u={rating_url:"",home_url:"",category:"",time:"",rating:0},null!=_.chrome_tabs_status[e.id])t.LogDebug("found item, rating:"+_.chrome_tabs_status[e.id].rating),u.rating_url=_.chrome_tabs_status[e.id].url,u.home_url=_.chrome_tabs_status[e.id].bar_url,u.category=s.get_rating_info(_.chrome_tabs_status[e.id].rating),m=_.chrome_tabs_status[e.id].time,_.chrome_tabs_status[e.id].rating&&(u.rating=_.chrome_tabs_status[e.id].rating),c=g=m.getHours(),g>12&&(c=g-12),c+=":",c+=m.getMinutes(),c+=":",c+=m.getSeconds(),c+=g>=12?" PM.":" AM.",u.time=c;o(u);break;case"block_warning_page":_.chrome_tabs_status[e.id].rating,o(u={});break;case"get_customized_web_page":u={customized_page:""},null!=_.chrome_tabs_status[e.id]&&(u.customized_page=_.chrome_tabs_status[e.id].customized_page),o(u);break;case"set_igore_category":_.AddIgnoreCategory(_.chrome_tabs_status[e.id].time,_.chrome_tabs_status[e.id].rating);break;case"refresh_token_revoke":chrome.tabs.create({url:"https://security.google.com/settings/security/permissions",active:!0},(function(e){})),o(u={action:"refresh_token_revoke is done"});break;case"get_last_error":o(u={error:_.lasterr});break;case"youtubeFilter":i.rateYouTubeChannel(e.channelUrl,e.videoUrl,a.tab.id,o);break;case"video":o(i.tabsStatusYoutube[a.tab.id]);break;case"yt-navigate-finish":r.async_mode?_.OnBeforeWebRequest({url:e.url,tabId:a.tab.id,type:"main_frame"}):s.url_rate(encodeURIComponent(e.url),a.tab.id,"main_frame","yt-navigate-finish")}})),t.LogDebug("Ext_Initializer Exit")}function c(e){return e.startsWith("chrome://")?"":e.replace("http://","").replace("https://","").split(/[/?#]/)[0]}document.addEventListener("DOMContentLoaded",(function(e){t.LogDebug("**** DOM fully loaded and parsed ****"),u()}))})();