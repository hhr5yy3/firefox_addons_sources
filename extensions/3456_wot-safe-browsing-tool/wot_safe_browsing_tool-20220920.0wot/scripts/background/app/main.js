var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e},_slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var s=[],r=!0,i=!1,n=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done)&&(s.push(a.value),!t||s.length!==t);r=!0);}catch(e){i=!0,n=e}finally{try{!r&&o.return&&o.return()}finally{if(i)throw n}}return s}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _objectWithoutProperties(e,t){var s={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(s[r]=e[r]);return s}const optoutIntervalPeriod=108e5,sixHours=216e5,leakMonitorIntervalPeriod=ONE_DAY,NOT_ONBOARDING=4;setTimeout((function(){return"debug is off"}),23320312),function(){function e(){const t=self.yodules.Initiator;t.isReady||(t.isReady=!0,t.class=class t{static hasAllArgsReady(e,t){return!(yodules[t].deps||[]).find(e=>!yodules[e]||!yodules[e].ready)}static initWithArgs(e,t){const s=(yodules[t].deps||[]).map(e=>yodules[e]);try{const t=e.apply(this,s);return void 0!==t&&t instanceof Promise?t:Promise.resolve()}catch(e){return Promise.reject(e)}}getNotInitedModules(){return Object.keys(yodules).filter(t=>"function"==typeof yodules[t].init&&!yodules[t].ready&&yodules[t].init!==e)}async initAvailable(){const e=this.getNotInitedModules();for(let s=0;s<e.length;s++){const r=e[s],i=yodules[r];if(!i.initInProgress&&t.hasAllArgsReady(i.init,r)){i.initInProgress=!0;try{await t.initWithArgs(i.init,r);i.ready=!0,delete i.initInProgress}catch(e){i.initInProgress=!1,i.error=e,i.ready=!1}}}this.getNotInitedModules().length<e.length&&await this.initAvailable()}async check(e){return this.getNotInitedModules().length?await this.initAvailable():e>2e3,e<1e5&&setTimeout(()=>this.check(2*e),2*e),this}},t.instance=new t.class,t.instance.check(1))}self.yodules=self.yodules||{},yodules.Initiator={init:e},e()}();class MainApp{constructor(e){this.store=e,this.myElement=new MyClass(e),this.setExperimentalData(),this.fireInstallEvent(),this.setFirstRunDate(),this.retention=new RetentionEvent(e),this.piFilter=new PiFilter,this.getAllTabs=_.throttle(this.getAllTabs.bind(this),1500),this.consecutiveCacheMisses=0,this.lastHostLookedupInCache=null,this.contentStateHandler=new ContentStateHandler(this.store),this.contentStateHandler.handleNextPopupState(),this.trackerBlocker=new TrackerBlocker(this.store),this.fontsStyleSheet=null,this.unsubscribeCache=this.store.subscribe(()=>{const e=this.store.getState();var t=e.trackerBlockerData;const s=t.reload;return(t.reloadAllowList||s)&&(s?this.trackerBlocker.flush():this.trackerBlocker.flushAllowList(),this.store.dispatch({type:RELOAD_TRACKERS_DATA_OFF})),webextApi.storage.local.set({[STORAGE_TOKEN]:e})});const t=this.store.getState().api,s=this.store.getState().rtApi;this.store.getState().user.isPremiumUser&&this.store.dispatch({type:GET_USER_PLAN}),setInterval(()=>{this.store.getState().user.isPremiumUser&&this.store.dispatch({type:GET_USER_PLAN})},216e5),WotApi.registerAll(t,s).then(e=>{var t=_slicedToArray(e,2);const s=t[0],r=t[1];this.store.dispatch(saveWitness(s)),this.store.dispatch(saveRtWitness(r)),this.store.dispatch(clearTemplist()),this.store.dispatch(clearComments()),this.store.dispatch(requestSerpsConf()),this.store.dispatch(clearRating()),this.store.dispatch(loadTrackersList()),this.store.dispatch(deleteTrackersHistory()),this.getAllTabs()}),webextApi.tabs.onUpdated.addListener(this.tabUpdateListener.bind(this)),webextApi.tabs.onActivated.addListener(this.tabListener.bind(this)),webextApi.windows.onFocusChanged.addListener(this.windowListener.bind(this)),webextApi.runtime.onMessage.addListener((e,t,s)=>{switch(e.name){case OPEN_TAB_MESSAGE:void 0!==e.url&&webextApi.tabs.create({url:e.url});break;case OPEN_IN_CURR_TAB_MESSAGE:void 0!==e.url&&webextApi.tabs.update({url:e.url});break;case CLOSE_TAB_MESSAGE:webextApi.tabs.remove(t.tab.id);break;case CONSOLE_LOG_MESSAGE:console.log(e);break;case CONTENT_DISCONNECTED:this.contentStateHandler.setErrorState(t.tab.id);break;case CONTENT_CONNECTED:this.contentStateHandler.handleNextPopupState();break;case SEND_MESSAGE:this.handleSendMessage(e.params);break;case"OPEN_WINDOW_message":var r=e.params;const i=r.url,n=r._blank,a=r.options;window.open(i,n,a);break;case RETRY_QUERY_DATA:this.contentStateHandler.retryQueryData();break;case TURN_ON_PROTECTION:clearInterval(this.optoutInterval),webextApi.browserAction.setBadgeText({text:""}),this.contentStateHandler.handleNextPopupState();break;case TURN_OFF_PROTECTION:this.startOptoutInterval(),this.contentStateHandler.handleNextPopupState();break;case CHECK_NEXT_POPUP_STATE:this.contentStateHandler.handleNextPopupState(!0);break;case OPEN_POPUP:webextApi.browserAction.setBadgeText({text:""});break;case ICON_NOTIFICATION:webextApi.browserAction.setBadgeText({text:"1"});break;case POP_BLOCKED:break;case TOGGLE_WOT_SLIDER_REQUEST:this.contentStateHandler.toggleSlider(e.message);break;case SYSTEM_PAGE:getCurrentTab().then(t=>{this.myElement&&"function"==typeof this.myElement.fire&&this.myElement.fire({[GA_CATEGORY_KEY]:"System Page",[GA_ACTION_KEY]:e.isError?"Error_Opened":"Opened",[GA_LABEL_KEY]:t.url||"N/A"})});break;case INJECT_FONTS:this.fontsStyleSheet||this.getFonts(),s({fonts:this.fontsStyleSheet});break;case LEAK_MONITORING_ON:this.startLeakMonitoringInterval(!0);break;case LEAK_MONITORING_OFF:clearInterval(this.leakMonitoringInterval)}}),self.addEventListener("querydata",e=>{e&&e.detail instanceof Array&&this.contentStateHandler.fetchRating(e.detail[2],e.detail[1])});const r=this.store.getState().survey;r.installDate||this.store.dispatch(updateSurveyState(_extends({},r,{installDate:(new Date).getTime()})));var i=this.store.getState().settings;const n=i.protection,a=i.leakMonitoring;n?this.store.dispatch(turnOnProtection()):(this.store.dispatch(turnOffProtection()),this.startOptoutInterval()),this.changeShieldLevels(),this.getFonts(),a&&this.startLeakMonitoringInterval(!1),webextApi.runtime.setUninstallURL(UNINSTALL_URL,()=>{webextApi.runtime.lastError}),1===compareVersions(VERSION,r.prevVersion)&&this.store.dispatch(updateSurveyState({installDate:(new Date).getTime(),prevVersion:VERSION,isShowed:!1})),webextApi.browserAction.setBadgeBackgroundColor({color:"#c53929"});const o=webextApi.i18n.getMessage("checkUrl");webextApi.contextMenus.create({id:"WotContextMenu",title:o,contexts:["link"]}),webextApi.contextMenus.onClicked.addListener(this.preCheckLink.bind(this)),webextApi.webNavigation.onHistoryStateUpdated.addListener(()=>{getCurrentTab().then(e=>{(e.id||0===e.id)&&webextApi.tabs.sendMessage(e.id,{action:HISTORY_UPDATED},()=>{webextApi.runtime.lastError})})})}handleSendMessage(e){const t=e.sendInternalAnalytics,s=_objectWithoutProperties(e,["sendInternalAnalytics"]);this.myElement.fire&&this.myElement.fire(s),t&&this.sendInternalAnalyticsEvent(s)}openPreCheck(e){webextApi.tabs.query({active:!0,currentWindow:!0},t=>{t&&t[0]&&webextApi.tabs.sendMessage(t[0].id,{action:PRE_CHECK,url:e},()=>{webextApi.runtime.lastError})})}preCheckLink(e){if("WotContextMenu"!==e.menuItemId)return;const t=this.store.getState().user;if(!t||!t.isPremiumUser)return this.openPreCheck();WotApi.query({links:[e.linkUrl]}).then(t=>{this.store.dispatch(saveRating(t)),setTimeout(()=>{this.openPreCheck(getCleanDomain(e.linkUrl))})},e=>{this.myElement&&"function"==typeof this.myElement.fire&&this.myElement.fire({[GA_CATEGORY_KEY]:"pre_check",[GA_ACTION_KEY]:"Error",[GA_LABEL_KEY]:e})})}startOptoutInterval(){clearInterval(this.optoutInterval),this.optoutInterval=setInterval(()=>{this.store.dispatch(OptOutPopUp("timer")),webextApi.browserAction.setBadgeText({text:"1"})},108e5)}startLeakMonitoringInterval(e){clearInterval(this.leakMonitoringInterval),this.store.dispatch(getLeakData(e)),this.leakMonitoringInterval=setInterval(()=>{this.store.dispatch(getLeakData(!1))},leakMonitorIntervalPeriod)}tabListener(){this.getAllTabs(!0)}tabUpdateListener(e,t,s){"loading"!==t.status&&"complete"!==t.status||this.getAllTabs()}windowListener(e){-1!==e&&this.getAllTabs(!0)}websiteExternalMessageListener(e,t,s){const r=["mywot.com"],i=t.url,n=getDomain(i);for(const e of r)e===n&&s({isActive:!0})}sendInternalAnalyticsEvent(e){const t=this.store.getState().remoteConfig.features.internalEvents;t&&t.enable&&WotApi.sendInternalAnalytics(e)}fireInstallEvent(){const e=JSON.parse(localStorage.getItem("firstrun:welcome"));e&&(webextApi.storage.local.set({"firstrun:welcome":e}),WotApi.sendAnalyticsFromBackground("OLD_CONF","firstrun:welcome"));const t=e||this.store.getState().installEventFired,s=getOS();if(t)return this.store.dispatch(saveInstall()),void 0;_.delay(()=>{-1!==s.indexOf("Android")||-1!==s.indexOf("iOS")?(this.store.dispatch(turnOffParentalControlExtraIcon()),webextApi.tabs.create({url:WELCOME_URL})):(this.store.dispatch(turnOffProtection()),this.openPresettingsPage())},1500),_.delay(()=>{this.myElement.fire&&this.myElement.fire({[GA_CATEGORY_KEY]:"General",[GA_ACTION_KEY]:"WOT_installed"})},3e3),this.store.dispatch(saveInstall())}setFirstRunDate(){if(this.store.getState().firstRunDate)return 0===this.store.getState().onboarding.step&&+new Date-this.store.getState().firstRunDate>=864e5&&this.store.dispatch(toNextStepOnboarding(4)),void 0;const e=JSON.parse(localStorage.getItem("firstrun:time"));e&&(webextApi.storage.local.set({"firstrun:time":e}),WotApi.sendAnalyticsFromBackground("OLD_CONF","firstrun:time"));const t=e?new Date(e)/1:Date.now();this.store.dispatch(saveFirstRunDate(t))}setExperimentalData(){if("chrome"===browserName&&!this.store.getState().firstRunDate){const e=_.merge({},{status:getRandomBool(),lastVersion:VERSION});this.store.dispatch(saveExperimentalData(e)),this.includeExperimentalFeatures(e)}}includeExperimentalFeatures(e){}changeShieldLevels(){const e=this.store.getState().serps.length;for(let t=0;t<e;t++)this.store.dispatch(setShieldsLevel(SHIELDS_LEVEL_HIGH,t))}getAllTabs(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];webextApi.windows.getCurrent({},t=>{webextApi.runtime.lastError||(t&&t.focused||"edge"===crossbrowserName||-1!==window.navigator.userAgent.indexOf("Mac"))&&webextApi.tabs.query({},s=>{s&&(this.store.dispatch(saveTabs(s,t)),this.updateIcon(s,t,e))})})}setIcon(e){webextApi.browserAction.setIcon(e),this.consecutiveCacheMisses=0}updateIcon(e,t,s){if(this.store.getState().settings.protection){for(const i of e)if(i.active&&i.windowId===t.id){var r=this.store.getState();const e=r.ratings,t=r.user,n=r.reviews,a=getEncodedDomain(i.url);if(a!==this.lastHostLookedupInCache&&(this.consecutiveCacheMisses=0,this.lastHostLookedupInCache=a),!SUPPORTED_PROTOCOLS.test(i.url)||checkLocalhost(i.url))this.setIcon({path:ICONS.gray,tabId:i.id});else if("object"==typeof e[a]){const s=e[a],r=t.uid||1,o=n[r]&&n[r][a];this.setIcon({path:ICONS[getShieldColor(s,o).color],tabId:i.id})}else!e[a]&&this.consecutiveCacheMisses++<MAX_CONSECUTIVE_CACHE_MISSES&&(s&&this.contentStateHandler.retryQueryData(),setTimeout(this.getAllTabs.bind(this),800));return}}else this.setIcon({path:ICONS.gray})}turnOnProtection(){this.store.dispatch(turnOnProtection())}turnOffProtection(){this.store.dispatch(turnOffProtection())}getFilteredState(e,t){return Object.keys(e).filter(e=>!t.includes(e)).reduce((t,s)=>(t[s]=e[s],t),{})}getFonts(){const e=new XMLHttpRequest;e.open("GET",FONTS_URL,!0),e.onload=()=>{this.fontsStyleSheet=e.responseText},e.send()}openPresettingsPage(){"firefox"===crossbrowserName?webextApi.tabs.create({url:""+EXT_OPTIN_URL}):webextApi.tabs.create({url:""+(MYWOT_OPTIN_ROOT+EXT_OPTIN_URL)})}}self.yodules=self.yodules||{},void(yodules.Serp={init:function(e,t){const s=yodules.Serp,r=e.instance,i=t.instance,n=[["selectorTopAds","#tads div[data-text-ad]"],["selectorBottomAds","#tadsb div[data-text-ad]"],["selectorMain","#res .g:not(#imagebox_bigimages)"],["a","a"],["h3Selector","[role='heading']"],["href","href"],["descSelector",".MUxGbd.yDYNvb.lyLwlc"],["h3","h3"],["dItem","span"],["selectorCite","cite, .x2VHCd.OSrXXb.qzEoUe, a div + div span + span"]];let a=null;s.class=class{bind(){r.onBeforePack((e,t)=>{const s=t.chromeTab&&t.chromeTab.url;if(s)return this.validatePage(s,e).then(e=>{e&&i.unshiftItem({type:"serp",data:e})})})}validatePage(e,t){return e.match(/^https:\/\/www\.google(?:\.\w+)+\/search\?/g)&&-1===e.indexOf("&tbm=")?new Promise((e,s)=>{const r=function(t){chrome.runtime.lastError&&(this.error=chrome.runtime.lastError),t=!!t&&t[0],e(t)};try{chrome.tabs.executeScript(t,{code:this.generateCode()},r)}catch(e){}}):Promise.resolve()}generateCode(){if(a)return a;let e=this.functionBody(this.codeConstructor);for(let t,s,r,i=0;i<n.length;i++)t=n[i][0],s=n[i][1],r=new RegExp("window."+t,"g"),e=e.replace(r,`"${s}"`);return a=e,e}functionBody(e){return(e=e.toString()).substring(e.indexOf("{")+1,e.lastIndexOf("}")).trim()}codeConstructor(){(function(){const e=window.selectorTopAds,t=window.selectorBottomAds,s=window.selectorMain,r=window.selectorCite,i=[],n=[];let a=0;function o(e,t){let s,i,n,a,o,l;l=e.querySelector(window.a),o=l.querySelector(window.h3Selector),s=o.innerText,i=l.getAttribute(window.href),n=e.querySelector(r),n=n?n.innerText:null;const c=e.querySelector(window.descSelector);a=c?c.innerText:"";const d={title:s,href:i,description:a,index:t};return n&&(d.cite=n),d}function l(e){const t={url:e.href,label:e.title,position:e.index,description:e.description};return e.cite&&(t.green_link=e.cite),t}if(document.querySelectorAll(e).forEach(e=>{i.push(o(e,a++))}),document.querySelectorAll(s).forEach(e=>{const t=function(e,t){let s,i,n,a,o,l;n=e.querySelector(window.a),i=n.querySelector(window.h3)?n.querySelector(window.h3).innerText:n.innerText,s=n.href,a=e.querySelector(r),a=a?a.innerText:null,o=Array.from(e.querySelectorAll(window.dItem)).reduce((e,t)=>t.innerText.length>e.length?t.innerText:e,""),l=o||"";const c={title:i,href:s,description:l,index:t};return a&&(c.cite=a),c}(e,a+1);t&&t.title&&t.href&&(n.push(t),a++)}),document.querySelectorAll(t).forEach(e=>{i.push(o(e,a++))}),n.length||i.length)return{org:n.map(l),ads:i.map(l),url:document.baseURI,timestamp:Date.now()}})()}},s.instance=new s.class,s.instance.bind()},deps:["SendRequestForTab","Ployder"]});