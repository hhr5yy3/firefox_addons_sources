import{r as d}from"./cplx-M4JPizzD.js";import{j as e,c as x}from"./cplx-DEt7CUyc.js";import{P as O}from"./cplx-BsCYqTWz.js";import{l as z,m as y,f as A,n as I,C as _,o as N,q as E,r as D,t as $,v as q,w as M,u as H,i as G,g as Q}from"./cplx-CWPpH3dB.js";import{c as U,s as V,i as K,b as J}from"./cplx-BqwXc_LR.js";import{$ as v}from"./cplx-BbAh7E-i.js";import{O as X,t as C,z as Y,P as Z,Q as ee,R as te,b as W}from"./cplx-CejnDNPm.js";import{E as f,q as oe}from"./cplx-CVsLL7Ku.js";import{b as ne}from"./cplx-CIDXzIHh.js";import{T as k}from"./cplx-Cqfmi6PF.js";import{C as re}from"./cplx-BddtA9RI.js";import{d as se}from"./cplx-CzQHx1MX.js";import{s as ae}from"./cplx-Bey00KRS.js";import{b as ie}from"./cplx-Cdcyb6EG.js";import"./cplx-DSnlyBAv.js";import"./cplx-CXGk_GMP.js";import"./cplx-BpeHHEix.js";import"./cplx-AFeO3sEC.js";import"./cplx-2ekRUlSR.js";import"./cplx-CvSOQQlQ.js";import"./cplx-Bzmv935M.js";import"./cplx-CZMWhpfy.js";import"./cplx-SsoyhRxE.js";import"./cplx-DewpVJ-0.js";import"./cplx-B42KOvrD.js";import"./cplx-km2FGkQ4.js";import"./cplx-Mn-h5XDX.js";import"./cplx-CCGYIZQf.js";import"./cplx-DD6dUv5H.js";import"./cplx-Dy60Fcq0.js";import"./cplx-CgmVhoKz.js";import"./cplx-hUtawQMb.js";import"./cplx-DC-QQLj-.js";import"./cplx-B814hFp-.js";import"./cplx-wwbq-DDb.js";import"./cplx-D37zsf-y.js";import"./cplx-CCS6eJc0.js";import"./cplx-B19A3gYQ.js";const ce="[data-cplx-component=cplx-mirrored-code-block]:not(:empty)+[data-cplx-component=message-block-code-block]{display:none}div.w-full.md\\:max-w-\\[90vw\\]:not(.overflow-x-auto){visibility:hidden}[data-cplx-component=message-block-code-block]:empty{display:none}[data-cplx-component=message-block-code-block] code{white-space:unset!important;width:-moz-max-content!important;width:max-content!important}",le=r=>U()(V(K(t=>({...r,setIsWrapped:n=>{t(o=>{o.isWrapped=n})},setMaxHeight:n=>{t(o=>{o.maxHeight=n})}})))),L=d.createContext(null),de=d.memo(function({storeValue:t,children:n}){const[o]=d.useState(()=>le(t));return d.useEffect(()=>{o.setState(t)},[o,t]),e.jsx(L.Provider,{value:o,children:n})});function h(){const r=d.use(L);if(!r)throw new Error("useMirroredCodeBlockContext must be used within a MirroredCodeBlockContext");return r}const P=({className:r,orientation:t="horizontal",...n})=>e.jsx("div",{role:"separator","aria-orientation":t,className:x("tw-shrink-0 tw-bg-border",t==="horizontal"?"tw-h-[1px] tw-w-full":"tw-h-full tw-w-[1px]",r),...n});P.displayName="Separator";function T({language:r}){var o;const t=f.getCachedSync().plugins["thread:betterCodeBlocks"];return(r?(o=oe.getQueryData(ne.list.queryKey))==null?void 0:o.find(s=>s.language===r):null)||t}function pe(){const{messageBlockIndex:r,codeBlockIndex:t,language:n}=h()(o=>({language:o.language,messageBlockIndex:o.sourceMessageBlockIndex,codeBlockIndex:o.sourceCodeBlockIndex}));return!z(n)&&!y(n)?null:e.jsx(A,{desktopOnly:!0,dependentPluginIds:["thread:canvas"],children:e.jsx(k,{content:"Render in Canvas",children:e.jsx("div",{className:"tw-cursor-pointer tw-text-muted-foreground tw-transition-colors hover:tw-text-foreground",onClick:()=>{I.setState(o=>{o.selectedCodeBlockLocation={messageBlockIndex:r,codeBlockIndex:t},o.state="preview"})},children:e.jsx(X,{className:"tw-size-4"})})})})}function me({defaultMaxHeight:r,maxHeight:t,setMaxHeight:n}){return e.jsx(k,{content:t===r?C("plugin-better-code-blocks:headerButtons.expand.expand"):C("plugin-better-code-blocks:headerButtons.expand.collapse"),children:e.jsx("div",{className:"tw-cursor-pointer tw-text-muted-foreground tw-transition-colors hover:tw-text-foreground",onClick:()=>n(t===r?9999:r),children:t===r?e.jsx(Y,{className:"tw-size-4"}):e.jsx(Z,{className:"tw-size-4"})})})}function ge({isWrapped:r,setIsWrapped:t}){return e.jsx(k,{content:r?C("plugin-better-code-blocks:headerButtons.wrap.unwrap"):C("plugin-better-code-blocks:headerButtons.wrap.wrap"),children:e.jsx("div",{className:"tw-cursor-pointer tw-text-muted-foreground tw-transition-colors hover:tw-text-foreground",onClick:()=>t(!r),children:r?e.jsx(ee,{className:"tw-size-4"}):e.jsx(te,{className:"tw-size-4"})})})}const ue=d.memo(function(){const{language:t,codeString:n,isInFlight:o,isMessageBlockInFlight:s,codeElement:a,isWrapped:l,maxHeight:i,setIsWrapped:c,setMaxHeight:p}=h()(w=>({language:w.language,codeString:w.codeString,codeElement:w.codeElement,isInFlight:w.isInFlight,isMessageBlockInFlight:w.isMessageBlockInFlight,isWrapped:w.isWrapped,maxHeight:w.maxHeight,setIsWrapped:w.setIsWrapped,setMaxHeight:w.setMaxHeight})),g=f.getCachedSync(),u=T({language:t}),m=u==null?void 0:u.placeholderText,b=u.stickyHeader,B=g.plugins["thread:betterMessageToolbars"].sticky,[F]=d.useState(()=>u.unwrap.showToggleButton&&we({codeElement:a})),[R]=d.useState(()=>u.maxHeight.enabled&&u.maxHeight.showToggleButton&&xe({initialMaxHeight:u.maxHeight.value,codeElement:a}));return e.jsxs("div",{className:x("tw-flex tw-items-center tw-justify-between tw-rounded-t-md tw-border-b tw-border-border/50 tw-bg-secondary tw-p-2 tw-px-4 tw-pb-2 tw-text-muted-foreground",{"tw-sticky":b,"tw-top-[calc(var(--navbar-height))]":b&&(s||!B),"tw-top-[calc(var(--navbar-height)+var(--message-block-bottom-bar-height))]":b&&!s&&B}),children:[e.jsxs("div",{className:"tw-flex tw-items-center tw-gap-2",children:[e.jsx("div",{className:"tw-line-clamp-1 tw-font-mono tw-text-sm",children:(m==null?void 0:m.title)||t}),!o&&(m==null?void 0:m.idle)&&e.jsxs("div",{className:"tw-flex tw-items-center tw-gap-2",children:[e.jsx(P,{orientation:"vertical",className:"tw-h-4 tw-w-[2px]"}),e.jsx("div",{className:"tw-font-sans tw-text-sm",children:m.idle})]})]}),e.jsxs("div",{className:"tw-flex tw-items-center tw-gap-4",children:[o&&e.jsxs("span",{className:"tw-flex tw-items-center tw-gap-2",children:[(m==null?void 0:m.loading)&&e.jsx("span",{className:"tw-animate-pulse tw-font-sans",children:m.loading}),e.jsx(W,{className:"tw-animate-spin"})]}),!o&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{}),i>0&&F&&e.jsx(ge,{isWrapped:l,setIsWrapped:c}),e.jsx(_,{content:n}),R&&e.jsx(me,{defaultMaxHeight:u.maxHeight.value,maxHeight:i,setMaxHeight:p})]})]})]})});function we({codeElement:r}){const t=v(r);if(!t.length)return!1;const n=t[0].getBoundingClientRect().width,o=t[0].parentElement;if(!o)return!1;const s=o.getBoundingClientRect().width;return n>s}function xe({initialMaxHeight:r,codeElement:t}){const n=v(t);return n.length?n[0].getBoundingClientRect().height>r:!1}const he=d.memo(()=>{const{maxHeight:r,isWrapped:t,codeString:n,language:o,isInFlight:s}=h()(i=>({codeElement:i.codeElement,codeString:i.codeString,language:i.language,maxHeight:i.maxHeight,isWrapped:i.isWrapped,isInFlight:i.isInFlight})),a=N(o??"text"),l=d.useMemo(()=>{const i=({children:c})=>e.jsx("pre",{className:"tw-px-4 tw-py-2",children:c});return i.displayName="PreTag",i},[]);return e.jsx("div",{style:{maxHeight:r},className:"tw-overflow-auto tw-rounded-b-md",children:e.jsx("div",{className:x("[&>pre]:tw-m-0 [&>pre]:tw-rounded-t-none [&>pre]:!tw-p-2 [&>pre]:!tw-px-4",{"[&_code]:!tw-whitespace-pre-wrap":t,"[&_span]:tw-duration-300 [&_span]:tw-animate-in [&_span]:tw-fade-in":s}),children:e.jsx(re,{language:a,PreTag:l,children:n})})})}),j=d.memo(function(){const{maxHeight:t,sourceMessageBlockIndex:n,sourceCodeBlockIndex:o}=h()(i=>({maxHeight:i.maxHeight,sourceMessageBlockIndex:i.sourceMessageBlockIndex,sourceCodeBlockIndex:i.sourceCodeBlockIndex})),s=f.getCachedSync().plugins["thread:canvas"].enabled,a=E(i=>i.selectedCodeBlockLocation),l=(a==null?void 0:a.messageBlockIndex)===n&&(a==null?void 0:a.codeBlockIndex)===o;return e.jsxs("div",{className:x("tw-relative tw-my-4 tw-flex tw-flex-col tw-rounded-md tw-border tw-border-border/50 tw-bg-secondary tw-font-mono tw-transition-all",{"tw-overflow-hidden":t===0,"tw-border-primary":s&&l}),children:[e.jsx(ue,{}),e.jsx(he,{})]})}),Ce=d.memo(function(){const{language:t,isInFlight:n,sourceMessageBlockIndex:o,sourceCodeBlockIndex:s}=h()(),a=E(g=>g.selectedCodeBlockLocation),l=(a==null?void 0:a.messageBlockIndex)===o&&(a==null?void 0:a.codeBlockIndex)===s,i=D($(t)),c=N(t),p=q[c];return e.jsxs("div",{className:x("tw-group tw-my-4 tw-flex tw-w-max tw-cursor-pointer tw-select-none tw-items-center tw-divide-x-2 tw-divide-border/50 tw-overflow-hidden tw-rounded-lg tw-border tw-border-border/50 tw-bg-secondary tw-transition-all hover:tw-border-primary",{"tw-border-primary":l}),onClick:()=>{I.setState(g=>{g.selectedCodeBlockLocation={messageBlockIndex:o,codeBlockIndex:s},g.state="preview",g.isCanvasListOpen=!1})},children:[e.jsx("div",{className:x("tw-group-hover:tw-bg-primary/10 tw-flex tw-size-16 tw-items-center tw-justify-center",{"tw-bg-primary/10":l}),children:n?e.jsx(W,{className:"tw-size-4 tw-animate-spin tw-text-muted-foreground"}):e.jsx(p.icon,{className:"tw-size-8"})}),e.jsxs("div",{className:"tw-flex tw-max-w-[300px] tw-flex-col tw-border-l tw-bg-background tw-px-4 tw-py-2",children:[e.jsx("div",{className:x("tw-line-clamp-1 tw-text-base tw-text-foreground tw-transition-all group-hover:tw-text-primary",{"tw-text-primary":l}),children:i.length>0?i:p.defaultTitle}),e.jsx("div",{className:"tw-w-max tw-text-sm tw-text-muted-foreground",children:n?e.jsx("span",{className:"tw-animate-pulse",children:"Generating..."}):p.description})]})]})}),fe=d.memo(function(){const{language:t}=h()(a=>({language:a.language})),{isMobile:n}=J();return n?e.jsx(j,{}):f.getCachedSync().plugins["thread:canvas"].enabled&&y(t)?e.jsx(Ce,{}):e.jsx(j,{})}),S=ie.THREAD.MESSAGE.TEXT_COL_CHILD.MIRRORED_CODE_BLOCK;function be(){const r=M(s=>s.setBlocks),t=H(s=>s.threadComponents.codeBlocks),n=d.useCallback(async(s,a,l)=>{const i=s.$wrapper.prev(),c=await ae("reactVdom:getCodeFromCodeBlock",{messageBlockIndex:a,codeBlockIndex:l},"window");if(!c)return{...s,portalContainer:null,codeString:null,language:null};if(i.length&&i.internalComponentAttr()===S)return{...s,portalContainer:i[0],codeString:c.code,language:c.language};const p=v("<div>").internalComponentAttr(S).attr({"data-language":c.language,"data-index":l});return s.$wrapper.before(p),{...s,portalContainer:p[0],codeString:c.code,language:c.language}},[]),o=d.useMemo(()=>se(s=>{G.getInstance().enqueue(async()=>{try{const a=await Promise.all(s.map((l,i)=>Promise.all(l.map((c,p)=>n(c,i,p)))));r(a)}catch(a){console.error("Error processing mirrored code blocks:",a),r([])}},"process-code-blocks")},0),[n,r]);d.useEffect(()=>{if(t)return o(t),()=>{o.cancel()}},[t,o])}const ve=d.memo(function({language:t,codeString:n,isInFlight:o,isMessageBlockInFlight:s,sourceMessageBlockIndex:a,sourceCodeBlockIndex:l,codeElement:i}){const c=T({language:t});return!t||!n?null:e.jsx(de,{storeValue:{language:t,codeString:n,sourceMessageBlockIndex:a,sourceCodeBlockIndex:l,isInFlight:o,isMessageBlockInFlight:s,codeElement:i,isWrapped:!c.unwrap.enabled,maxHeight:c.maxHeight.enabled&&c.maxHeight.collapseByDefault?c.maxHeight.value:9999},children:e.jsx(fe,{})})});function at(){const r=H(n=>n.threadComponents.messageBlocks);be();const t=M(n=>n.blocks);return Q({id:"cplx-hide-native-code-blocks",css:ce}),t.map((n,o)=>n.map((s,a)=>{var g;const{language:l,codeString:i,isInFlight:c,portalContainer:p}=s;return e.jsx(O,{container:p,children:e.jsx(ve,{language:l,codeString:i,isInFlight:c,isMessageBlockInFlight:!!((g=r==null?void 0:r[o])!=null&&g.isInFlight),sourceMessageBlockIndex:o,sourceCodeBlockIndex:a,codeElement:s.$code[0]})},`${o}-${a}`)}))}export{at as default};
