async function initialize(){showTab("#tab_database_profiles"),localize(),await createProfileTable(),await createUrlBlocksTable(),$(".tabs .tab-links a").on("click",tabActivated),$("#psr_logging").change(async function(){await mv.setStoreEntry("option_logging",this.checked)}),$("#psr_add_password").change(async function(){await saveIndexedDBrecord("options",this.checked.toString(),"add_password")}),$("#npws_cross_client_auth").change(async function(){await saveIndexedDBrecord("options",this.checked.toString(),"cross_client_auth")}),$("#save_overlay").click(saveProfileOverlay),$("#close_overlay").click(closeProfileOverlay),$("#add").click(openProfileOverlay),$(".close").click(closeProfileOverlay),$("#button_reset_options").click(resetOptions),$("#button_help").click(showHelp),$("#button_add_profile").click(addProfile),$(".login_input").keyup(onLoginInputChanged),$("#profilecolor").change(onLoginInputChanged),$("#webclient_url").change(()=>{let value=$("#webclient_url").val();value&&("/"!==(value=0!==(value=0===value.indexOf("http://")?value.split("http://")[1]:value).indexOf("https://")?"https://"+value:value)[value.length-1]&&(value+="/"),$("#endpoint").val()||($("#endpoint").val(value+"api"),onLoginInputChanged()))}),await loadOptions()}function tabActivated(e){showTab($(this).attr("href")),e.preventDefault()}function showTab(tabHref){var tab=$('a[href="'+tabHref+'"]');0<tab.length&&(tab=tab.get(0)),$(".tabs "+tabHref).show().siblings().hide(),$(tab).parent("li").addClass("active").siblings().removeClass("active")}function onLoginInputChanged(){$("#server_profile_id").val();let profile_profileName=$("#server_profile").val(),profile_endpoint=($("#webclient_url").val(),$("#endpoint").val()),profile_databaseName=$("#server_databasename").val(),profile_color=$("#profilecolor").val();var disabled=!(profile_databaseName&&profile_profileName&&profile_color&&profile_endpoint);$("#save_overlay").prop("disabled",disabled)}function localize(){$(document).prop("title",chrome.i18n.getMessage("option_title")),$("#label_logging").text(chrome.i18n.getMessage("option_logging")),$("#label_add_password").text(chrome.i18n.getMessage("option_add_password")),$("#button_reset_options").html(chrome.i18n.getMessage("option_reset_default_title")),$("#button_help").html(chrome.i18n.getMessage("help")),$("#label_profilename").text(browser.i18n.getMessage("profilename")),$("#label_webclienturl").text(browser.i18n.getMessage("webclient_url")),$("#label_endpoint").text(browser.i18n.getMessage("endpoint")),$("#label_username").text(browser.i18n.getMessage("server_username")),$("#label_password").text(browser.i18n.getMessage("server_password")),$("#label_databasename").text(browser.i18n.getMessage("databasename")),$("#label_profilecolor").text(browser.i18n.getMessage("profilecolor")),$("#close_overlay").text(browser.i18n.getMessage("profile_cancel")),$("#save_overlay").text(browser.i18n.getMessage("save")),$("#button_add_profile").text(browser.i18n.getMessage("new_profile")),$("#options").text(browser.i18n.getMessage("option_addon_tab_connection")),$("#servermode").text(browser.i18n.getMessage("option_addon_tab_server")),$("#url-blocks").text(browser.i18n.getMessage("option_addon_tab_save_passwords")),$("#table_url_blocks_help").text(browser.i18n.getMessage("option_addon_tab_websites")),$("#profile_tutorial_one").text(browser.i18n.getMessage("profile_create_database_info")).css({"font-weight":"bold","margin-bottom":"8px"}),$("#profile_tutorial_two").text(browser.i18n.getMessage("profile_create_automatically_bold")).css({"font-weight":"bold"}),$("#profile_tutorial_three").text(browser.i18n.getMessage("profile_create_automatically")),$("#profile_tutorial_four").text(browser.i18n.getMessage("profile_automatically_step_one")),$("#profile_tutorial_five").text(browser.i18n.getMessage("profile_automatically_step_two")),$("#profile_tutorial_six").text(browser.i18n.getMessage("profile_automatically_step_three")).css({"margin-bottom":"8px"}),$("#profile_tutorial_seven").text(browser.i18n.getMessage("profile_create_manually_bold")+":").css({"font-weight":"bold"}),$("#label_cross_client_auth").text(chrome.i18n.getMessage("option_cross_client_auth"))}async function loadOptions(){var optionLogging=await mv.getStoreEntry("option_logging"),addPassword=await getIndexedDBrecord("options","add_password"),crossClientAuth=await getIndexedDBrecord("options","cross_client_auth"),addPassword=!addPassword||"true"===addPassword,crossClientAuth=!crossClientAuth||"true"===crossClientAuth;$("#psr_logging").prop("checked",optionLogging),$("#psr_add_password").prop("checked",addPassword),$("#npws_cross_client_auth").prop("checked",crossClientAuth)}function createTemplate(){extension.createTemplate()}function showHelp(){extension.showHelp()}function addProfile(){openProfileOverlay(null)}async function resetOptions(){await loadOptions()}async function resetOption(key){await deleteIndexedDBrecord("options",key)}function openProfileOverlay(profile){$("#profile_overlay").css({display:"block"}),onLoginInputChanged(),null!=profile?($("#profilecolor").val(profile.color),$("#server_profile_id").val(profile.profileId),$("#server_profile").val(profile.profileName).focus(),$("#webclient_url").val(profile.webClientUrl),$("#endpoint").val(profile.endpoint),$("#server_databasename").val(profile.databaseName)):($("#server_profile_id").val(generateUuid()),$("#profilecolor").val(getRandomColor()),$("#server_profile").focus(),$("#server_profile,#webclient_url,#server_databasename,#endpoint").val(""))}async function createProfileTable(){$("#table_profiles").empty();var profiles=await loadDatabaseProfiles(),table=$("#table_profiles"),thProfileColor=$("<th></th>").text(browser.i18n.getMessage("profilecolor")),thProfileName=$("<th></th>").text(browser.i18n.getMessage("profilename")),thWebClient=$("<th></th>").text("WebClient"),thEndpoint=$("<th></th>").text("Endpoint"),thDatabaseName=$("<th></th>").text(browser.i18n.getMessage("databasename")),thActions=$("<th></th>").text(browser.i18n.getMessage("profile_actions"));table.append(thProfileColor).append(thProfileName).append(thWebClient).append(thEndpoint).append(thDatabaseName).append(thActions);for(const profile of profiles){var row=await createProfileRow(profile);table.append(row)}}async function createProfileRow(profile){var row=$("<tr></tr>"),tdProfileColor=$('<td style="background-color: '+profile.color+'"></td>'),tdProfileName=$("<td></td>").text(profile.profileName).prop("title",profile.profileName),tdWebClientUrl=$("<td></td>").text(profile.webClientUrl).prop("title",profile.webClientUrl),tdEndpoint=$("<td></td>").text(profile.endpoint).prop("title",profile.endpoint),tdDatabaseName=$("<td></td>").text(profile.databaseName).prop("title",profile.databaseName),tdActions=$("<td></td>").addClass("button-cell"),actionDel=$("<input></input>").addClass("img-button").prop("type","image").prop("src","../img/ImageDelete_16x16.png").prop("title",browser.i18n.getMessage("delete_profile")).click(async()=>{deleteDatabaseProfile(profile.profileId),await createProfileTable()}),actionEdit=$("<input></input>").addClass("img-button").prop("type","image").css("height","15px").prop("src","../img/ImageEdit_16x16.png").prop("title",browser.i18n.getMessage("edit_profile")).click(()=>{openProfileOverlay(profile)});return tdActions.append(actionEdit).append(actionDel),row.append(tdProfileColor).append(tdProfileName).append(tdWebClientUrl).append(tdEndpoint).append(tdDatabaseName).append(tdActions),row}async function createUrlBlocksTable(){$("#table_url_blocks").empty();var blockedUrls=(await getStoreIndexedDBrecords("urlsBlockedFromAddPassword")).map(u=>u.url).sort((a,b)=>b<a?1:a<b?-1:0);const table=$("#table_url_blocks");var thUrl=$("<th></th>").text("URL"),thActions=$("<th></th>").text(browser.i18n.getMessage("profile_actions"));table.append(thUrl).append(thActions),blockedUrls.forEach(url=>{url=createUrlBlockRow(url);table.append(url)})}function createUrlBlockRow(url){var row=$("<tr></tr>"),tdUrl=$("<td>"+url+"</td>"),tdActions=$("<td></td>").addClass("button-cell"),actionDel=$("<input></input>").addClass("img-button").prop("type","image").prop("src","../img/ImageDelete_16x16.png").prop("title",browser.i18n.getMessage("delete_entry")).click(async()=>{await deleteIndexedDBrecord("urlsBlockedFromAddPassword",url,"url"),await createUrlBlocksTable()});return tdActions.append(actionDel),row.append(tdUrl).append(tdActions),row}async function saveProfileOverlay(){var profile={color:$("#profilecolor").val(),profileId:$("#server_profile_id").val(),profileName:$("#server_profile").val(),webClientUrl:$("#webclient_url").val(),endpoint:$("#endpoint").val(),databaseName:$("#server_databasename").val()};profile.databaseName&&profile.profileName&&profile.endpoint&&(await getIndexedDBrecord("profiles",profile.profileId,"profileId")?await updateDatabaseProfile(profile):await saveDatabaseProfile(profile),closeProfileOverlay(),await createProfileTable(),extension.refreshData())}function closeProfileOverlay(){$("#profile_overlay").css({display:"none"})}window.browser=window.msBrowser||window.browser||window.chrome;let extension;function getBackgroundPage(){browser.runtime.getBackgroundPage(async function(page){extension=page,await initialize()})}$(getBackgroundPage);