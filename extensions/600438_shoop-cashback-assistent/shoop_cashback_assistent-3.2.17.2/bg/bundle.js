(()=>{"use strict";var t={d:(e,a)=>{for(var i in a)t.o(a,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:a[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{ACTIVATION_PATTERNS:()=>b,BOOKING_ID:()=>v,CAMPAIGN_ID_RX:()=>f,COLLECTIONS_LIST:()=>k,FINANZCHECK_ID:()=>m,GA_ID:()=>T,GA_SECRET:()=>I,ICONS:()=>E,LIEFERANDO_ID:()=>p,MERCHANT_OBJECT:()=>w,SCHEDULE_UPDATED_COLLECTIONS:()=>C,SUPPRESSION_PATTERNS:()=>S,TIMER_KEY:()=>A,VALIDATE_EBAY_CAMPAIGN_ID_RX:()=>g,WS_MESSAGES:()=>y});var a={};t.r(a),t.d(a,{EBAY_CAPCHA_SELECTORS:()=>M,MAX_SUGGESTED_MERCHANTS:()=>R,OVERLAPPING_EXTENSIONS:()=>D,SERP:()=>P,SHOW_RATEUS_PATTERNS:()=>x,SLIDER_STORE_KEY:()=>O});var i={};t.r(i),t.d(i,{SCREENS:()=>N,TAB_NAMES_FOR_GA:()=>_});var n={};t.r(n),t.d(n,{AB_TESTING:()=>st,AFTER_INSTALL_PAGE:()=>q,AGB:()=>Y,ALTERNATIVES_URL:()=>nt,API:()=>G,BEDINGUNGEN:()=>at,CAA_CONFIGS:()=>W,CLICKOUT:()=>z,CONDITIONS:()=>K,CONSENT_PAGE:()=>ct,DEALS_CATEGORIES:()=>V,DOMAIN:()=>U,EDIT_FAVORITES:()=>J,EXT_INFO:()=>et,HOME:()=>L,IMPRINT:()=>Z,INTERSTITIAL_PAGE_SETTINGS:()=>X,LOGIN:()=>$,MERCHANTS:()=>B,PAYOUT:()=>H,PROTECTION:()=>tt,STORE_LIST:()=>dt,SUGGESTED_MERCHANTS_URL:()=>ot,TOP_MERCHANTS:()=>Q,UNINSTALL_PAGE:()=>it,UNIQUE_CODE:()=>F,USER_API:()=>j,WEBSOCKET:()=>rt});var o={};t.r(o),t.d(o,{BOOKING_RX:()=>lt,RATE_SLIDER_POSTPONE_TIMEOUT:()=>vt,REQUIRED_PRODUCT_MAP:()=>ht,RX:()=>ut});class s{areaName;constructor(t){this.areaName=t}async get(t){if(3===chrome.runtime.getManifest().manifest_version){const e=await this.getStorage().get([t]);return e?.[t]??null}return new Promise((e=>{this.getStorage().get([t],(a=>e(a?.[t]??null)))}))}async remove(t){return 3===chrome.runtime.getManifest().manifest_version?this.getStorage().remove(t):new Promise((e=>{this.getStorage().remove(t,(()=>e()))}))}async set(t,e){return 3===chrome.runtime.getManifest().manifest_version?this.getStorage().set({[t]:e}):new Promise((a=>{this.getStorage().set({[t]:e},(()=>a()))}))}onChanged=(t,e)=>{chrome.storage.onChanged.addListener(((a,i)=>{i===this.areaName&&a[t]&&e(a[t].newValue,a[t].oldValue)}))};getStorage(){return chrome.storage[this.areaName]}}const r=new class extends s{constructor(){super("local")}},c=new class extends s{constructor(){super("session")}};var d,l;!function(t){t.ExtChrome="ext_chrome",t.ExtEdge="ext_edge",t.ExtFirefox="ext_firefox",t.ExtOpera="ext_opera",t.ExtSafari="ext_safari",t.Web="web"}(d||(d={})),function(t){t.Cashback="Cashback",t.Community="Communities",t.Conversion="Conversion"}(l||(l={}));const u=new class{sourceType;storage;storeKeys={customerHash:"megatron:customerHash",lastPingAt:"megatron:lastPingAt"};apiUrl;businessModel;customerHash;initDone;isConfigured;isPingPending=!1;trackId;trackUrlPrefix;userId;version;constructor(t,e){this.sourceType=t,this.storage=e,this.isConfigured=new Promise((t=>{this.initDone=t}))}async getCustomerHash(){return await this.isConfigured,this.customerHash??null}getSourceType(){return this.sourceType}async init(t){this.apiUrl=t.apiUrl,this.businessModel=t.businessModel,this.trackId=t.trackId,this.trackUrlPrefix=t.trackUrlPrefix??"",this.userId=t.userId,this.version=t.version;const e=await this.storage.get(this.storeKeys.customerHash);e?this.customerHash=e:(this.customerHash=t.customerHash??function(){const t=()=>Math.floor(65536*(1+Math.random())).toString(16).substring(1);return`${t()}${t()}-${t()}-${t()}-${t()}-${Date.now()}`}(),await this.storage.set(this.storeKeys.customerHash,this.customerHash)),this.initDone&&(this.initDone(),this.initDone=void 0)}async ping(){if(!this.isPingPending){this.isPingPending=!0;try{await this.pingUnsafe()}catch(t){console.error("Megatron ping error",t)}this.isPingPending=!1}}setUserId(t){this.userId=t??void 0}async track(t,{throwOnError:e=!1}={}){const a=Date.now();await this.isConfigured;const i=new URL(this.apiUrl);i.searchParams.set("z",(1e8*Math.random()).toFixed(0));try{await fetch(i.toString(),{body:JSON.stringify({...t,businessModel:this.businessModel,cu:this.trackId,customerHash:this.customerHash,dcat:"desktop",de:"UTF-8",dl:t.dl?.startsWith("/")?this.trackUrlPrefix+t.dl:t.dl,ds:this.sourceType,dv:this.version,tsp:a.toString(10),tzuo:(new Date).getTimezoneOffset().toString(10),uh:this.userId,ul:navigator.language,v:"1.0.0"}),headers:{"Content-Type":"text/plain"},method:"POST"})}catch(t){if(console.error("Megatron fetch error",t),e)throw t}}trackPageView({title:t,url:e}){this.track({dl:e,dt:t,t:"pageview"})}async pingUnsafe(){const t=Date.now();(parseInt(await this.storage.get(this.storeKeys.lastPingAt)||"",10)||-1)>t-864e5||(await this.track({dl:"/callmum",t:"callmum"},{throwOnError:!0}),await this.storage.set(this.storeKeys.lastPingAt,t.toString(10)))}}((h=navigator.userAgent,/\sfirefox\/\d+\.\d+/i.test(h)?d.ExtFirefox:/\sedge?\/\d+\.\d+/i.test(h)?d.ExtEdge:/\sopr\/\d+\.\d+/i.test(h)?d.ExtOpera:/\ssafari\/\d+\.\d+/i.test(h)&&/\sversion\/\d+\.\d+/i.test(h)&&!/chrome/i.test(h)?d.ExtSafari:d.ExtChrome),r);var h;const v=2772,m=5244,p=1880,f=/(rover\.)?ebay.*(mkrid|mkevt|campid)/,g=/campid=(5337791686|5337465330)/,y={Hello:1,Welcome:2,Challenge:4,Authenticate:5,Subscribe:32,Subscribed:33,Event:36},w=["id","name","subtitle","logo","hideSlider","urlPattern","serpEnabled","serpLink","rates","vouchers","supportsToolbar","cashbackAvailable"],b=[".*//api.shoop.de/api/visit/redirect",".*//www.shoop.de/visit/.*/voucher/.*",".*//www.shoop.de/visit/.*/cashback/.*",".*//www.shoop.de/cashback"],S=["commission-junction.com","qksrv.net","jdoqocy.com","kqzyfj.com","dpbolvw.net","anrdoezrs.net","tkqlhce.com","linksynergy.com","afsrc=1","affiliate.buy.com","affiliate.rakuten.com","apmebf.com","emjcd.com","qksz.net","afcyhf.com","awltovhc.com","ftjcfx.com","lduhtrp.net","tqlkg.com","awxibrm.com","cualbr.com","rnsfpw.net","vofzpwh.com","yceml.net","cj.com","cj.mplxtms.com","cj.dotomi.com","adclick.g.doubleclick.net","rover.ebay.com","letyshops.com","awin1.com","track.webgains.com","clk.tradedoubler.com","igraal.com","cjevent=","myvisualiq.net"],A={SESSION_PING:"session:ping"},T="G-732X5TLBP9",I="5Ygi2G7cTZOjFT0O0S4gRw",E={main:{default:"images/default.png",activation:"images/merchant.png",activated:"images/activated.png",inactive:"images/inactive.png"},safari:{default:"images/32-safari.png",activated:"images/activated.png",inactive:"images/inactive.png"}},k={ALTERNATIVES:"alternatives",CAACONFIGS:"caaConfigs",CONDITIONS:"conditions",DEALSCATEGORIES:"dealsCategories",MERCHANTS:"merchants",TOPMERCHANTS:"topMerchants",USER:"user",MUTEDMERCHANTS:"mutedMerchants",SUGGESTED_MERCHANTS:"suggestedMerchants",PRESET_STORAGE_DATA:"presetStorageData"},C={ALTERNATIVES:"alternatives",CAACONFIGS:"caaConfigs",CONDITIONS:"conditions",DEALSCATEGORIES:"dealsCategories",MERCHANTS:"merchants",TOPMERCHANTS:"topMerchants"},P=[{name:"yahoo",domain:"search.yahoo.com",rx:/(..\.)?search\.yahoo\.com/,links:"h3 a",blocks:"div#web li > .dd:not(.bingrelqa)"},{name:"bing",domain:"bing.com",rx:/(www(\d?).)?bing\.com/,links:"h2 a, div[class='sb_tlst'] * a",blocks:"#b_results>.b_algo"},{name:"google",domain:"google.",rx:/^http(?:s)?:\/\/(?:www\.|encrypted\.)?google\..+/,links:"a",blocks:"div.g:not(div.g .g)"}],M={capcha:"target-icaptcha-slot",form:"captchaDomIdForm",input:"captchaTokenInput"},x=[".*//api.shoop.de/api/visit/redirect",".*//www.shoop.de/visit/.*/voucher/.*",".*//www.shoop.de/visit/.*/cashback/.*",".*//www.shoop.de/cashback",".*//www.shoop.de/toolbar"],D=[{childSelector:"#lumaly-shadow-root",sliderSelector:".lumaly-discounts-found"},{childSelector:"#QOALA_CASHBACK"},{childSelector:'[id*="Qoala"]'}],R=2,O="suggestedMerchantsSlider",N={DEALS:"Deals",FAVORITES:"Favorites",PARTNER:"Partner",SEARCH_RESULT:"SearchResult",FAVORITE_ERROR:"FavoriteError",URL_TRACKING_CONSENT:"UrlTrackingConsent"},_={[N.DEALS]:"aktionen",[N.FAVORITES]:"favourites",[N.PARTNER]:"shop"},U="shoop.de",L=`https://www.${U}`,$=`${L}/start?utm_source=toolbar`,H=`${L}/auszahlung`,q=`${L}/willkommen-ca`,G=`https://api.${U}`,j=`${G}/api/user/toolbar`,B=`${G}/api/merchants/toolbar`,F=`${G}/api/voucher/request`,V=`${G}/api/deals/toolbar`,K=`${G}/api/cms?id=generelle-cashback-bedingungen`,J=`${G}/api/user/favorites`,z=`${G}/api/visit/redirect`,X=`${G}/api/interstitial-extension`,Q=`${G}/api/merchants/toolbar-top`,W=`${G}/api/toolbar/caa-configuration`,Y=`${L}/agb`,Z=`${L}/impressum`,tt=`${L}/cashback-assistent-datenschutz`,et=`${L}/cashback-assistent`,at=`${L}/generelle-cashback-bedingungen`,it=`${L}/toolbar-feedback`,nt=`${G}/api/toolbar/alternative-merchants`,ot=`${G}/api/merchants/suggested`,st=`${G}/api/abtest/version`,rt="wss://api.shoop.de/websocket",ct="consent.html",dt={chrome:"https://chrome.google.com/webstore/detail/shoopde-cashback-assisten/hacngjmphfcjdfpmfmlngemhddjdncpe/related",firefox:"https://addons.mozilla.org/en-GB/firefox/addon/shoop-cashback-assistent/",edge:"https://microsoftedge.microsoft.com/addons/detail/cpcckalhfmpnloapihhjjdoenplbhchn?hl=en-US",opera:"https://addons.opera.com/en/extensions/details/shoopde-cashback-assistent/",safari:"https://apps.apple.com/us/app/shoop-cashback-gutscheine/id1568244961"},lt=/aid=\d+(&|;)label=\d+x\d+/,ut=/(.*:\/\/www(\w|\d)?\.|.*:\/\/)?([^/:]*).*/i,ht={eBay:"promo"},vt=52704e5,mt=({module:t="",action:e="",data:a={},periodInMinutes:i=null,delayInMinutes:n=null})=>{chrome.alarms.create(JSON.stringify({module:t,action:e,data:a}),{periodInMinutes:i,delayInMinutes:n})},pt=(t,e)=>function(){const a=[...arguments];return new Promise((i=>{a.push((function(){return chrome.runtime.lastError&&console.error(chrome.runtime.lastError.message),i(...arguments)})),t[e](...a)}))},ft=(pt(chrome.cookies,"getAll"),pt(chrome.tabs,"query")),gt=()=>ft({}),yt=()=>ft({active:!0,currentWindow:!0}).then((([t])=>t)),wt=(t,e)=>new Promise((a=>{chrome.tabs.sendMessage(t,e,(t=>{a(t)}))})),bt=async()=>{(await gt()).forEach((t=>{wt(t.id,{action:"initContent"})}))},St=pt(chrome.storage.local,"get"),At=pt(chrome.storage.local,"set"),Tt=(pt(chrome.storage.session,"get"),pt(chrome.storage.session,"set"),pt(chrome.alarms,"getAll")),It=async t=>new Promise((e=>setTimeout((()=>e(!0)),t)));var Et=function(t,e,a,i){return new(a||(a=Promise))((function(n,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function r(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,r)}c((i=i.apply(t,e||[])).next())}))};const kt=new class{constructor(){this.toolbarVersion=chrome.runtime.getManifest().version}delete(t,e){return Et(this,void 0,void 0,(function*(){return this.request({headers:e,method:"DELETE",url:t})}))}get(t,e){return Et(this,void 0,void 0,(function*(){return this.request({headers:e,method:"GET",url:t})}))}patch(t,e,a){return Et(this,void 0,void 0,(function*(){return this.request({body:e,headers:a,method:"PATCH",url:t})}))}post(t,e,a){return Et(this,void 0,void 0,(function*(){return this.request({body:e,headers:a,method:"POST",url:t})}))}isApiResponseFailed(t){return!!t.error}request(t){var e;return Et(this,void 0,void 0,(function*(){const a=Object.assign({"Content-Type":"application/json","Toolbar-Version":this.toolbarVersion,accept:"application/json, text/plain, */*",locale:"de_DE"},null!==(e=t.headers)&&void 0!==e?e:{});this.authToken&&!a.token&&(a.token=this.authToken);try{const e=yield fetch(t.url,{body:t.body,headers:a,method:t.method});return this.convertToApiResponse(e,yield e.json())}catch(t){return{error:{message:"Fehler: Bitte versuche es noch mal."}}}}))}convertToApiResponse(t,e){var a;if(!e)return{error:{code:t.status,message:"Fehler: Bitte versuche es noch mal."}};const i=Object.assign({},e);return i.data||i.error||("success"===i.result?(i.data=i.message,i.headers=t.headers):i.error={code:t.status,message:null===(a=i.message)||void 0===a?void 0:a[0]}),i}},Ct=36e5,Pt="enabled",Mt="session",xt=24*Ct,Dt="threshold",Rt=new Set,Ot=(t,e)=>({get:async function(a){return(await t.get(e)??{})[a]??null},remove:async function(a){const i=await t.get(e)??{},{[a]:n,...o}=i;await t.set(e,o)},set:async function(a,i){const n=await t.get(e)??{};await t.set(e,{...n,[a]:i})}});const Nt=new class{constructor(t={}){this.isLoggingEnabled=!0,this.isThresholdSaving=!1,this.isPingPending=!1;const{localStorage:e=r,sessionStorage:a=c,storeKey:i="DataDogLogger"}=t;if(!i)throw new Error("ExtensionLogsService: storeKey is required!");if(Rt.has(i))throw new Error(`ExtensionLogsService: storeKey "${i}" is already being used!`);Rt.add(i);const n="ExtensionLogsService:"+i;this.localStorage=Ot(e,n),this.sessionStorage=Ot(a,n),this.isInitialised=new Promise((t=>{this.initDone=t})),setTimeout((()=>{this.clientToken||console.error("Please, call ExtensionLogsService.init() to avoid memory leaks!")}),6e4)}debug(t){return this.submit({...t,status:"debug"})}error(t){const{data:e={},origin:a="custom",stack:i="",...n}=t;return this.submit({data:{...e,error:{origin:a,stack:i}},...n,status:"error"})}info(t){return this.submit({...t,status:"info"})}warn(t){return this.submit({...t,status:"warn"})}async init(t){this.clientToken=t.clientToken,this.env=t.env,this.service=t.service,this.sessionId=t.sessionId,this.version=t.version;const e=await this.sessionStorage.get(Pt);"boolean"==typeof e?this.isLoggingEnabled=e:(this.isLoggingEnabled=Math.random()<(t.sessionSampleRate??1),await this.sessionStorage.set(Pt,this.isLoggingEnabled)),"number"!=typeof t.threshold||this.thresholdData||(this.thresholdData=await this.localStorage.get(Dt)??{count:0,limit:t.threshold,resetAt:Date.now()+xt},this.thresholdData.limit!==t.threshold&&console.error("ExtensionLogsService: threshold parameter was changed since last call")),this.initDone&&this.initDone()}logConsoleErrors(){const t=console.error;console.error=(...e)=>{t.apply(console,e),this.error({message:"console error: "+e[0],origin:"console"})}}logUnhandledErrors(){const t=globalThis.onerror;globalThis.onerror=(e,a,i,n,o)=>{t?.call(globalThis,e,a,i,n,o),this.error({message:"Unhandled error: "+(o?.message||""),stack:o?.stack})}}async ping(t){if(!this.isPingPending){this.isPingPending=!0;try{await this.pingUnsafe(t)}catch(t){console.error("ExtensionLogsService: ping error",t)}this.isPingPending=!1}}isThresholdExceeded(){return!!this.thresholdData&&!(Date.now()>this.thresholdData.resetAt)&&this.thresholdData.count>this.thresholdData.limit}async pingUnsafe(t){const{localStorage:e,sessionStorage:a}=this,i=Date.now(),n={durations:[],loggedAt:-1,startedAt:i,updatedAt:i,...await e.get(Mt)??{}};if(!await a.get(Mt)&&(await a.set(Mt,{startedAt:i}),n.startedAt!==i&&(n.durations.push(n.updatedAt-Math.max(n.startedAt,n.loggedAt)),n.startedAt=i)),n.loggedAt<=i-24*Ct){const e=[...n.durations,i-Math.max(n.startedAt,n.loggedAt)],a=t&&t()||{};await this.info({data:{...a,durations:e,durationsSum:e.reduce(((t,e)=>t+e),0),ongoingDuration:i-n.startedAt,startedAt:n.startedAt},forceLog:!0,message:"session",throwOnError:!0}),n.durations=[],n.loggedAt=i}n.updatedAt=i,await e.set(Mt,n)}async submit(t){if(await this.isInitialised,!this.isLoggingEnabled&&!t.forceLog)return;if(this.updateThreshold(),this.isThresholdExceeded()&&!t.forceLog)return;const e={"dd-api-key":this.clientToken,"dd-evp-origin":"browser",ddsource:"browser",ddtags:`api:fetch,env:${this.env},service:${this.service},version:${this.version}`},a=[];for(let t in e){const i=e[t];i&&a.push(t+"="+encodeURIComponent(i))}const i={date:Date.now(),message:t.message,service:this.service,session_id:this.sessionId,status:t.status??"info",version:this.version,view:t.data?.view??{url:""}};try{await fetch("https://logs.browser-intake-datadoghq.eu/api/v2/logs?"+a.join("&"),{body:JSON.stringify({...t.data??{},...i}),method:"POST"})}catch(e){if(console.error("ExtensionLogsService: fetch error",e),t.throwOnError)throw e}}updateThreshold(){if(!this.thresholdData)return;const t=this.isThresholdExceeded();Date.now()>this.thresholdData.resetAt&&(this.thresholdData.count=0,this.thresholdData.resetAt=Date.now()+xt),this.thresholdData.count++,this.isThresholdExceeded()&&!t&&this.warn({forceLog:!0,message:"Threshold reached"}),this.isThresholdSaving||(this.isThresholdSaving=!0,setTimeout((()=>{this.isThresholdSaving=!1,this.localStorage.set(Dt,this.thresholdData)}),5e3))}};class _t{constructor(t=""){this.base="",this.hash="",this.params={},this.path="";let e=t;if(e.match(/^[a-z]+:/i)&&(this.base=e.replace(/^([a-z]+:(?:\/\/)?[^/?&#]+).*/,"$1"),e=e.substring(this.base.length)),e.match(/^[^?#]/)&&(this.path=e.replace(/^([^?#]+).*/,"$1"),e=e.substring(this.path.length)),"?"===e[0]){const t=e.replace(/^([^#]+).*/,"$1");this.setParams(t),e=e.substring(t.length)}if("#"===e[0]&&(this.hash=e.substring(1),e=e.substring(this.hash.length+1)),e.length>0)throw new Error(`Cannot parse url: ${t}`)}static parseParams(t){const e={};return"?"===t[0]&&(t=t.substring(1)),t.split("&").forEach((t=>{const a=t.split("=");if(a.length>1){const t=a.shift(),i=a.join("=");e[decodeURIComponent(t)]=decodeURIComponent(i)}})),e}clone(){return(new _t).setBase(this.getBase()).setPath(this.getPath()).setParams(this.getParams()).setHash(this.getHash())}getBase(){return this.base}getData(){return{base:this.base,hash:this.hash,params:this.getParamsAsQuery(),path:this.path}}getHash(){return this.hash}getParam(t){return this.params[t]}getParams(){return Object.assign({},this.params)}getParamsAsQuery(){return Object.keys(this.params).reduce(((t,e)=>(null!=this.params[e]&&t.push(`${encodeURIComponent(e)}=${encodeURIComponent(this.params[e])}`),t)),[]).join("&")}getPath(){return this.path}removeBase(){return this.base="",this}removeHash(){return this.hash="",this}removeParam(...t){return t.forEach((t=>{delete this.params[t]})),this}setBase(t){return this.base=t.replace(/\/+$/,""),this}setHash(t){return"#"===t[0]&&(t=t.substring(1)),this.hash=t,this}setParam(t,e){return null==e?this.removeParam(t):this.params[t]=String(e),this}setParams(t){return"string"==typeof t&&(t=_t.parseParams(t)),this.params={},Object.keys(t).forEach((e=>{this.setParam(e,t[e])})),this}setPath(t){return this.path=t,this}toString(){let t=this.base;this.path&&(t&&"/"!==this.path[0]&&(t+="/"),t+=this.path);const e=this.getParamsAsQuery();return e&&(t=`${t}?${e}`),this.hash&&(t=`${t}#${this.hash}`),t}}const Ut=()=>navigator.userAgent.includes("Firefox")?"firefox":navigator.userAgent.includes("Edg")?"edge":navigator.userAgent.includes("OPR")?"opera":navigator.userAgent.includes("Chrome")?"chrome":"safari",Lt=async()=>{const t=(await gt()).find((t=>t.url.match(/\/\/(.+)\/shoopSettings\.html/)));t&&chrome.tabs.reload(t.id,{})},$t={alternatives(){mt({module:k.ALTERNATIVES,action:"update",delayInMinutes:240})},caaConfigs(){mt({module:k.CAACONFIGS,action:"update",delayInMinutes:240})},conditions(){mt({module:k.CONDITIONS,action:"update",delayInMinutes:240})},dealsCategories(){mt({module:k.DEALSCATEGORIES,action:"update",delayInMinutes:240})},merchants(){mt({module:k.MERCHANTS,action:"update",delayInMinutes:20})},topMerchants(){mt({module:k.TOPMERCHANTS,action:"update",delayInMinutes:240})}},Ht=t=>{let e=!1;if(!t||!t.premiumAccount)return e;const a=(new Date).getTime();return new Date(t.premiumAccount.start).getTime()<a&&(e=!0),t.premiumAccount.end&&new Date(t.premiumAccount.end).getTime()<a&&(e=!1),e},qt=t=>"firefox"!==Ut()||!!t&&!1!==t.isUrlTrackingEnabled,Gt=async t=>{const{settings:e}=await St("settings");await At({settings:{...e,...t}})},jt=async()=>{const{settings:t}=await St("settings");return t},Bt=Gt,Ft=jt,Vt=async()=>{const t=await jt();return"firefox"!==Ut()||t&&!1!==t.isUrlTrackingEnabled},Kt=async t=>t.map((t=>({...t}))),Jt=async(t,e)=>kt.get(t,e.headers),zt=async({force:t=!1,url:e="",parser:a=Kt,fetcher:i=Jt,timeout:n=240,errorTimeout:o=2,name:s="module",params:c={}})=>{if(t||!await(async({name:t,timeout:e})=>{try{const{[t]:a}=await St(t);return(a?.lastUpdated||0)>Date.now()-60*e*1e3&&a?.data?.length}catch(t){return!1}})({name:s,timeout:n}))try{const d=await(async({url:t="",parser:e=Kt,fetcher:a=Jt,name:i="module",params:n={}})=>{const o=await a(t,n);let s=[];o&&!kt.isApiResponseFailed(o)&&(s=await e(o.data));const c=await r.get(k.PRESET_STORAGE_DATA);return c?.[i]&&(s=Array.isArray(s)?[...c[i],...s]:Object.assign(c[i],s)),await At({[i]:{data:s||[],lastUpdated:Date.now()}}),o})({force:t,url:e,parser:a,fetcher:i,timeout:n,errorTimeout:o,name:s,params:c});mt({module:s,action:"update",delayInMinutes:d?.timeout||n})}catch(t){mt({module:s,action:"update",delayInMinutes:o})}},Xt=async(t,e)=>{const a=await r.get(k.PRESET_STORAGE_DATA),i=a?.[t]||[],n=Object.assign(a||{},{[t]:[...e,...i]});return await r.set(k.PRESET_STORAGE_DATA,n),n};var Qt=function(t,e,a,i){return new(a||(a=Promise))((function(n,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function r(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,r)}c((i=i.apply(t,e||[])).next())}))};const Wt="cache";class Yt{constructor(t){this.data={},this.isReady=t.get(Wt).then((t=>{this.data=null!=t?t:{}})),this.storage=t}get(t){return Qt(this,void 0,void 0,(function*(){yield this.isReady;const e=this.data[t];if(e&&e.expireAt&&e.expireAt>Date.now())return e.data}))}set(t,e,a){return Qt(this,void 0,void 0,(function*(){yield this.isReady,this.data[t]={data:e,expireAt:Date.now()+a},this.save()}))}remove(t){return Qt(this,void 0,void 0,(function*(){yield this.isReady,delete this.data[t],this.save()}))}clear(){return Qt(this,void 0,void 0,(function*(){this.data={},this.save(!0)}))}save(t=!1){if(this.timeoutId&&!t)return;const e=t?0:1e3;clearTimeout(this.timeoutId),this.timeoutId=setTimeout((()=>{this.storage.set(Wt,this.data),this.timeoutId=void 0}),e)}}new Yt(c);const Zt=new Yt(r);const te="suggestedMerchants";var ee=function(t,e,a,i){return new(a||(a=Promise))((function(n,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function r(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,r)}c((i=i.apply(t,e||[])).next())}))};const ae=t=>ee(void 0,void 0,void 0,(function*(){return function(t){return e=this,a=void 0,n=function*(){const e=(yield Zt.get(te))||{};if(e[t])return e[t];const a=new URL(ot);a.searchParams.append("merchantId",t.toString());try{const i=yield kt.get(a.toString());if("error"in i)throw i.error;const n=i.data;return e[t]=n,yield Zt.set(te,e,36e5),n}catch(t){console.log(`API request to ${a.toString()} failed:`,t)}return[]},new((i=void 0)||(i=Promise))((function(t,o){function s(t){try{c(n.next(t))}catch(t){o(t)}}function r(t){try{c(n.throw(t))}catch(t){o(t)}}function c(e){var a;e.done?t(e.value):(a=e.value,a instanceof i?a:new i((function(t){t(a)}))).then(s,r)}c((n=n.apply(e,a||[])).next())}));var e,a,i,n}(t)})),ie=async(t,e)=>{const a=await kt.get(t,e.headers);let i=0;try{i=+a.headers.get("cache-control").match(/(max-age=)(\d*)/)[2]/60||240}catch(t){i=240}return{data:a.data,timeout:i}},ne=t=>{const e=[],a=t.filter((t=>{const a=Object.keys(t),i=w.filter((t=>!a.includes(t)));return!i.length||(e.push({id:t.id,fields:i}),!1)}));return e.length&&e.forEach((t=>{be.sendAnalytics({name:"error",params:{event_action:"Data not found",event_details:JSON.stringify(t)}})})),a.filter((({urlPattern:t})=>""!==t)).map((t=>{const e=t;return e.urlPattern=t?.urlPattern?.substring(1,t?.urlPattern.length-1),"safari"===Ut()&&t?.id===p&&(e.supportsToolbar=!1,e.disableCashbackSupport=!0),e}))},oe=async()=>{const{merchants:{data:t=[]}={}}=await St(k.MERCHANTS);return t},se=async()=>{const{merchantsStates:t=[]}=await St("merchantsStates");return t},re=async t=>t?(await se())[t]:null,ce=async({id:t=null,url:e=null,query:a=null})=>{const i=await oe();if(!i||!i.length)return null;let n;if(t&&(n=i.find((e=>e.id===t))),!n&&e&&(n=i.find((t=>e.match(new RegExp(t?.urlPattern))))),!n&&a&&(n=i.find((t=>t?.name?.toLowerCase().includes(a.toLowerCase())))),!n)return null;let o=await re(n.id);const s=await le(n.id);return s&&(o={...o,...s}),{...n,...o}},de=async({id:t,data:e,persistPerSession:a=!1})=>{if(!t)return;if(a){const a=await le(t)||{};await ue(t,{...a,...e})}const i=await se();i[t]={...i[t],...e},await At({merchantsStates:i})},le=async t=>await c.get(`${O}:${t}`),ue=async(t,e)=>c.set(`${O}:${t}`,e),he={getAllMerchants:oe,getMerchantAndState:ce,getMerchantSuggestions:async t=>{const e=await ae(t.id),a=await oe(),i=e.map((({id:t})=>a.find((e=>e.id===t)))).filter(Boolean);return i},update:async t=>{await zt({force:t,url:B,parser:ne,fetcher:ie,timeout:240,name:k.MERCHANTS,params:{headers:{pragma:"no-cache","cache-control":"no-cache"}}})},getStateById:re,mapMerchants:async t=>(await Promise.all(t.map((async t=>await ce({id:t}))))).filter((t=>t)),getCode:async(t,e)=>{if(!t||!e)return!1;const a=await kt.post(F,JSON.stringify({merchantId:e,voucherId:t})),i=a.data?.codes?.[0]?.code;if(!i)return!1;let n=await oe();return n=n.map((a=>(a.id===e&&(a.vouchers=a.vouchers.map((e=>e.id===t?(e.code=i,e):e))),a))),At({merchants:{data:n}}),e},dropStateById:async({id:t})=>{await de(t)},setDefaultStates:async()=>{const t=await oe(),e={};t.forEach((t=>{e[t.id]={activated:!1,showNotification:!0,countShown:0,activatedTimestamp:0}})),await At({merchantsStates:e})},updateStateById:de};const ve=t=>{return e=void 0,a=void 0,n=function*(){const{favoriteMerchants:e}=t,a=yield he.mapMerchants(e);return Object.assign({favorites:a},t)},new((i=void 0)||(i=Promise))((function(t,o){function s(t){try{c(n.next(t))}catch(t){o(t)}}function r(t){try{c(n.throw(t))}catch(t){o(t)}}function c(e){var a;e.done?t(e.value):(a=e.value,a instanceof i?a:new i((function(t){t(a)}))).then(s,r)}c((n=n.apply(e,a||[])).next())}));var e,a,i,n};const me=(t,e)=>{return a=void 0,i=void 0,o=function*(){const a=yield Ft();return(null==a?void 0:a.token)?(e.headers=Object.assign({token:a.token},e.headers),kt.get(t,e.headers)):null},new((n=void 0)||(n=Promise))((function(t,e){function s(t){try{c(o.next(t))}catch(t){e(t)}}function r(t){try{c(o.throw(t))}catch(t){e(t)}}function c(e){var a;e.done?t(e.value):(a=e.value,a instanceof n?a:new n((function(t){t(a)}))).then(s,r)}c((o=o.apply(a,i||[])).next())}));var a,i,n,o};const pe=t=>{return e=void 0,a=void 0,n=function*(){yield zt({force:t,url:j,parser:ve,fetcher:me,timeout:240,name:k.USER})},new((i=void 0)||(i=Promise))((function(t,o){function s(t){try{c(n.next(t))}catch(t){o(t)}}function r(t){try{c(n.throw(t))}catch(t){o(t)}}function c(e){var a;e.done?t(e.value):(a=e.value,a instanceof i?a:new i((function(t){t(a)}))).then(s,r)}c((n=n.apply(e,a||[])).next())}));var e,a,i,n};const fe=()=>{return t=void 0,e=void 0,i=function*(){const{user:{data:t={}}={}}=yield St(k.USER);return t},new((a=void 0)||(a=Promise))((function(n,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function r(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,r)}c((i=i.apply(t,e||[])).next())}));var t,e,a,i};const ge=()=>{return t=void 0,e=void 0,i=function*(){const t=yield Ft(),e=yield fe();t.testingGroup="a",t.interstitialPageEnabled="skip"!==(null==e?void 0:e.extensionInterstitialPage),yield Bt(t),u.setUserId((null==e?void 0:e.id)||null)},new((a=void 0)||(a=Promise))((function(n,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function r(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,r)}c((i=i.apply(t,e||[])).next())}));var t,e,a,i};const ye={update:pe,get:fe,setTokenAndUpdate:t=>{return e=void 0,a=void 0,n=function*(){kt.authToken=t;const e=yield Ft();e.token=t,yield Bt(e),yield pe(!0),yield ge(),yield Lt(),be.sendAnalytics({name:"login",params:{}})},new((i=void 0)||(i=Promise))((function(t,o){function s(t){try{c(n.next(t))}catch(t){o(t)}}function r(t){try{c(n.throw(t))}catch(t){o(t)}}function c(e){var a;e.done?t(e.value):(a=e.value,a instanceof i?a:new i((function(t){t(a)}))).then(s,r)}c((n=n.apply(e,a||[])).next())}));var e,a,i,n},updateUserSettings:ge,clearData:()=>{return t=void 0,e=void 0,i=function*(){return At({[k.USER]:{data:[]}})},new((a=void 0)||(a=Promise))((function(n,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function r(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,r)}c((i=i.apply(t,e||[])).next())}));var t,e,a,i}};var we=function(t,e,a,i){return new(a||(a=Promise))((function(n,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function r(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,r)}c((i=i.apply(t,e||[])).next())}))};const be={sendAnalytics:({name:t,params:e})=>we(void 0,void 0,void 0,(function*(){const[a,i]=yield Promise.all([Ft(),ye.get()]);if(!(null==a?void 0:a.isAnalyticEnabled))return;const n=`https://www.google-analytics.com/mp/collect?measurement_id=${T}&api_secret=${I}`;let o;try{o=1e3*(performance.timeOrigin+performance.now())}catch(t){o=1e3*Date.now()}yield fetch(`${n}`,{method:"post",body:JSON.stringify({client_id:a.analyticsClientId,timestamp_micros:o,user_properties:{user:{value:a.token?"logged-in":"logged-out"},premium_status:{value:Ht(i)?"premium":"non-premium"},browser:{value:Ut()}},events:[{name:t,params:e}]})})})),initAnalytics:()=>we(void 0,void 0,void 0,(function*(){const t=yield Ft();t.analyticsClientId||(t.analyticsClientId="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})),yield Bt(t))}))},Se="safari"===Ut()?"safari":"main",Ae=t=>{"safari"===Ut()?chrome.action.setIcon({path:`${t}`}):chrome.action.setIcon({path:`../${t}`})},Te=()=>{Ae(E[Se].default)},Ie=()=>{Ae(E[Se].activated)},Ee=()=>{if(Ae(E[Se].activation),"safari"===Se)return Te(),!1},ke=({text:t,color:e})=>{chrome.action.setBadgeText({text:t}),e&&chrome.action.setBadgeBackgroundColor({color:e})},Ce=()=>{Ae(E[Se].inactive),ke({text:""})},Pe=async t=>{try{if(!await Vt())return void Ce();const a=await yt();if(!a)return!1;const{id:i,url:n}=a,o=await he.getMerchantAndState({url:n});if((t=>{if(!t)return!0;const e=t.id===v;return!t.activated&&!e&&(t.disableCashbackSupport||!t.supportsToolbar)})(o))return Te(),ke({text:""}),!1;if("number"==typeof t&&i!==t)return Te(),ke({text:""}),!1;let s="";if(o.rateTeaser&&!o.suppressed){const t=await ye.get(),e=(t=>t.premiumInfo&&!t.premiumInfo.isBreak&&!t.premiumInfo.hasDeal)(o)&&Ht(t);s=(t=>{const e=t.value.replace(".","").replace(",","."),a=Number(e),i="€"===t.sign?(t=>{if(!t||Number.isNaN(t))return"";const e=Math.round(100*t)/100,a=e<10?2:0;return`${e.toLocaleString("de-DE",{minimumFractionDigits:0,maximumFractionDigits:a}).slice(0,3)}€`})(a):((t,e)=>{const a="%"===e?"﹪":e,i=t<10?3:0;return`${t.toLocaleString("de-DE",{minimumFractionDigits:0,maximumFractionDigits:i}).slice(0,3)}${a}`})(a,t.sign);return`${t.upTo?"Bis zu ":""}${i}`})({...e?o.rateTeaser.premium:o.rateTeaser.basic,upTo:!1})}const r=await(e=o.id,ee(void 0,void 0,void 0,(function*(){var t;return!!(null===(t=((yield Zt.get(te))||{})[e])||void 0===t?void 0:t.length)})));let c=o&&!o.suppressed?"activation":"setDefault";c=o&&(o.cashbackInactive||r&&!o.vouchers.length)?"inactive":c,c=o&&o.activated?"activated":c;const d=o?.vouchers?.length||"";o?.id===v&&(c="inactive"),"activation"!==c&&"activated"!==c||ke({text:s,color:"#00509C"}),s&&"inactive"!==c&&ke({text:s}),o.suppressed&&ke({text:""}),o&&!o.cashbackAvailable&&d&&ke({text:d.toString(),color:"#00509C"}),"setDefault"===c&&Te(),"activation"===c&&Ee(),"inactive"===c&&Ce(),"activated"===c&&Ie()}catch(e){return setTimeout((()=>{Pe(t)}),100),!1}var e},Me={inactive:Ce,setBadgeText:ke,activation:Ee,activated:Ie,setDefault:Te,setIcon:Ae,defineIcon:Pe},xe=async({tabId:t,deeplink:e})=>{const{cashback:a}=await St("cashback");let i=a.activations.find((e=>e.tabId===t));i||(i={tabId:t,deeplink:e},a.activations.push(i)),await At({cashback:a}),mt({module:"cashback",action:"clearActivation",data:{tabId:t},delayInMinutes:1})},De=async({url:t,tabId:e})=>{const{activationPatterns:{data:a=[]}=[]}=await St("activationPatterns");a.find((e=>t&&e&&t.match(e)||t&&e&&t===e))&&await xe({deeplink:t,tabId:e})},Re=async({tabId:t,url:e,merchantId:a})=>{const{cashback:i}=await St("cashback");let n=i?.suppressions?.find((e=>e.tabId===t));n||(n={tabId:t,url:e,merchantId:a},i?.suppressions?.push(n)),At({cashback:i}),mt({module:"cashback",action:"clearSuppression",data:{tabId:t},delayInMinutes:1})},Oe=async({url:t,tabId:e})=>{if(!t)return!1;const{cashback:a}=await St("cashback"),i=a?.activations?.find((t=>t.tabId===e));if(i)return!1;const n=S?.find((e=>"string"==typeof e?t.indexOf(e)>0:t.search(e)>-1));if(n){const a=await he.getMerchantAndState(t);return await Re({url:t,tabId:e,merchantId:a?.id}),!0}return!1},Ne=async({data:t})=>{const{tabId:e}=t,{cashback:a}=await St("cashback");a.deeplink=a.deeplink.filter((t=>t.tabId!==e)),await At({cashback:a})},_e=async({data:t})=>{const{tabId:e}=t,{cashback:a}=await St("cashback");a.activations=a.activations.filter((t=>t.tabId!==e)),await At({cashback:a})},Ue=async({data:t})=>{const{tabId:e}=t,{cashback:a}=await St("cashback");a.suppressions=a.suppressions.filter((t=>t.tabId!==e)),await At({cashback:a})},Le={init:async()=>{await At({cashback:{activations:[],suppressions:[],deeplink:[]}})},setActivation:xe,setSuppression:Re,checkActivation:De,checkSuppression:Oe,clearActivation:_e,clearSuppression:Ue,activate:async({url:t,tabId:e})=>(await xe({tabId:e}),chrome.tabs.update(e,{url:t}),!0),isActivation:async({tabId:t})=>{const{cashback:e}=await St("cashback");return!!e?.activations?.find((e=>e.tabId===t))},checkUrl:async t=>(await De(t),await Oe(t),!!f.test(t.url)&&(g.test(t.url)||(Re({tabId:t.tabId}),await Me.defineIcon({tabId:t.tabId}),At({ebayTimestamp:Date.now()+432e5})),!0)),findSuppression:async t=>{const{cashback:e}=await St("cashback");return e?.suppressions?.find((e=>e.tabId===t))},checkMerchantStatus:async({url:t,tabId:e})=>{if(!await Vt())return;const a=await he.getMerchantAndState({url:t});if(!a)return!1;if(a.activatedTimestamp<Date.now()&&0!==a.activatedTimestamp){const t={activated:!1,activatedTimestamp:0,showNotification:!0,countShown:0};return he.updateStateById({id:a.id,data:t}),!1}if(a.suppressionTimestamp<Date.now()&&0!==a.suppressionTimestamp){const t={suppressed:!1,suppressionTimestamp:0,showNotification:!0,countShown:0};return he.updateStateById({id:a.id,data:t}),!1}const{cashback:i}=await St("cashback"),n=i?.activations?.find((t=>t.tabId===e)),o=i?.suppressions?.find((t=>t.tabId===e)),s=i?.deeplink?.find((t=>t.tabId===e))||[];if(!o&&!n)return!1;let r=0;n&&a.cashbackAvailable&&(r=Date.now()+36e5);let c=0;o&&!n&&0===s?.length&&(c=Date.now()+432e5);const d={suppressed:!!o&&!n&&0===s?.length,activated:!!n,activatedTimestamp:r,suppressionTimestamp:c,showNotification:!0,countShown:0};if(await he.updateStateById({id:a.id,data:d}),o&&!n&&(await Me.defineIcon(e),await bt()),o||n){const t={};t.tabId=e,setTimeout((async()=>{await Ue({data:t}),await _e({data:t})}),5e3)}return!0},checkDeeplink:async({url:t,tabId:e})=>{const{cashback:a}=await St("cashback"),i=a?.deeplink?.find((t=>t.tabId===e));if(!i||!i.url)return!1;let n="",o=null;t.includes(".booking.")&&!i.url.match(lt)&&(n=t.match(lt)[0],o=i.url.includes("?")?i.url.replace("?",`?${n}&`):`${i.url}?${n}`);const s=await he.getMerchantAndState({url:t});if(!s||(t=>(null==t?void 0:t.id)===m)(s))return!1;s.activated&&chrome.tabs.update(e,{url:`${o||i.url}`});const r={};return r.tabId=e,await Ne({data:r}),!0},setDeeplink:async({tabId:t,url:e})=>{const{cashback:a}=await St("cashback");let i=a.deeplink.find((e=>e.tabId===t));!i&&e&&(i={tabId:t,url:e},a.deeplink.push(i)),await At({cashback:a}),mt({module:"cashback",action:"clearDeeplink",data:{tabId:t},delayInMinutes:1})},clearDeeplink:Ne};var $e=function(t,e,a,i){return new(a||(a=Promise))((function(n,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function r(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,r)}c((i=i.apply(t,e||[])).next())}))};const He=(t,e)=>$e(void 0,void 0,void 0,(function*(){var a;const i=Object.assign({"Content-Type":"application/json",accept:"application/json, text/plain, */*",locale:"de_DE"},null!==(a=e.headers)&&void 0!==a?a:{}),n=yield fetch(t,{method:"GET",headers:i});return{result:"success",data:yield n.json(),headers:n.headers}})),qe=t=>{t.map((t=>({timestamp:0,alternativeMerchants:t.alternative_merchants,name:t.name,urlPattern:null==t?void 0:t.urlPattern})))},Ge={findAll:({name:t,url:e})=>$e(void 0,void 0,void 0,(function*(){const{alternatives:{data:a=[]}=[]}=yield St(k.ALTERNATIVES);return e?null==a?void 0:a.find((t=>null==e?void 0:e.match(new RegExp(null==t?void 0:t.urlPattern)))):!!t&&(null==a?void 0:a.find((e=>(null==e?void 0:e.name)===t)))})),update:t=>$e(void 0,void 0,void 0,(function*(){yield zt({fetcher:He,force:t,url:nt,parser:qe,timeout:240,name:k.ALTERNATIVES})}))},je=async(t,e)=>{const a={"Content-Type":"application/json",accept:"application/json, text/plain, */*",locale:"de_DE",...e.headers??{}},i=await fetch(t,{method:"GET",headers:a});return{result:"success",data:await i.json(),headers:i.headers}},Be=t=>t,Fe={getAll:async()=>{const{caaConfigs:{data:t=[]}}=await St(k.CAACONFIGS);return t},findOne:async t=>{const{caaConfigs:{data:e=[]}=[]}=await St(k.CAACONFIGS);return(Array.isArray(e)&&e||[]).find((({url:e})=>{const a=Array.isArray(e)?e:[e];let i=!1;try{i=!!a.find((e=>{const a=new RegExp(e,"ig");return t.indexOf(e)>=0||a.test(t)}))}catch(t){i=!1}return i}))},update:async t=>{await zt({fetcher:je,force:t,url:W,parser:Be,timeout:240,name:k.CAACONFIGS})}},Ve=t=>t,Ke={getAll:async()=>{const{conditions:{data:t=[]}=[]}=await St(k.CONDITIONS);return t},update:async t=>{await zt({force:t,url:K,parser:Ve,timeout:240,name:k.CONDITIONS})}},Je=t=>t,ze={getAll:async()=>{const{dealsCategories:{data:t=[]}={}}=await St(k.DEALSCATEGORIES);return t},update:async t=>{await zt({force:t,url:V,parser:Je,timeout:240,name:k.DEALSCATEGORIES})}},Xe=async(t,e)=>{const a={"Content-Type":"application/json",accept:"application/json, text/plain, */*",locale:"de_DE",...e.headers??{}},i=await fetch(t,{method:"GET",headers:a}),n=await i.json(),o={...n};return o.data=n.message.data,o.headers=i.headers,o},Qe=async t=>{const e=t.map((({id:t})=>t));return(await he.mapMerchants(e)).filter((t=>!t.disableCashbackSupport))},We={getAll:async()=>{const{topMerchants:{data:t=[]}=[]}=await St(k.TOPMERCHANTS);return t},update:async t=>{await zt({fetcher:Xe,force:t,url:Q,parser:Qe,timeout:240,name:k.TOPMERCHANTS,params:{headers:{pragma:"no-cache","cache-control":"no-cache"}}})}},Ye=t=>t&&!t.disableCashbackSupport&&!t.cashbackAvailable&&!t.activated,Ze=async()=>{let{mutedMerchants:t=[]}=await St(k.MUTEDMERCHANTS);return t=t.filter((t=>"forever"===t.timestamp||t.timestamp>Date.now())),At({mutedMerchants:t}),t};var ta=function(t,e,a,i){return new(a||(a=Promise))((function(n,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function r(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,r)}c((i=i.apply(t,e||[])).next())}))};const ea=()=>{chrome.tabs.create({url:$,active:!0})},aa=(t,e=null)=>ta(void 0,void 0,void 0,(function*(){var a,i;try{const n=yield Ft();kt.authToken=null==n?void 0:n.token;const o=new _t(z).setParams({merchant:t,cid:n.analyticsClientId,offerId:e,toolbar:"true",return:"true",meta:JSON.stringify({mtCustomerHash:yield u.getCustomerHash(),mtPlatform:u.getSourceType()})}).toString(),s=yield kt.get(o);return null===(i=null===(a=null==s?void 0:s.data)||void 0===a?void 0:a.data)||void 0===i?void 0:i.url}catch(t){return null}})),ia=({request:t})=>ta(void 0,void 0,void 0,(function*(){const{data:e}=t,a=yield Ft();a.isAnalyticEnabled=e.isAnalyticEnabled,a.analyticsNotification=e.analyticsNotification,yield Bt(a)})),na=()=>ta(void 0,void 0,void 0,(function*(){const t=yield Ft();t.rateUsBarShowed=!0,yield Bt(t)})),oa=({request:t})=>ta(void 0,void 0,void 0,(function*(){let e={};e=t.data?t.data:t,be.sendAnalytics(e)})),sa=({request:t,sendResponse:e})=>ta(void 0,void 0,void 0,(function*(){let{url:a}=t.data;a=(t=>t.match(/(http(s)?):\/\/r\.search\.yahoo\.com\//)?t.match(/(%3a%2f%2f)(.*)(%2f)/)[2]:t)(a);const i=yield he.getMerchantAndState({url:a});if(!i)return!1;const{serpEnabled:n,cashbackAvailable:o}=i;return!!((yield Ft()).serpEnabled&&o&&n)&&e({merchant:i})})),ra=({request:t,sendResponse:e})=>ta(void 0,void 0,void 0,(function*(){const{url:a}=t.data,i=yield Fe.findOne(a),n=yield he.getMerchantAndState({url:a});return e({merchant:n,config:i})})),ca=({request:t,sender:e})=>ta(void 0,void 0,void 0,(function*(){var a;const i=yield Ft();"stop"!==i.activationCount&&(i.activationCount+=1,yield Bt(i));let n=null;const{id:o,deeplink:s}=t.data,r=yield he.getMerchantAndState({id:o});if(!r)return!1;const{from:c,offerId:d=null}=t.data,l=d?`offerId=${d}`:"";n=r.serpLink?`${r.serpLink}${d?"?":""}${l}`:`${G}${r.link}?token=${i.token}&${l}`;const u=null===(a=null==r?void 0:r.rates)||void 0===a?void 0:a.some((t=>t.canClickout)),{hasAdBlock:h}=yield St("hasAdBlock"),v=!h&&!i.interstitialPageEnabled&&i.token&&!u;switch(v&&(n=(yield aa(r.id,d))||n),c){case"suggest":case"serp":chrome.tabs.create({url:n},(t=>ta(void 0,void 0,void 0,(function*(){v&&(yield Le.setActivation({deeplink:n,tabId:t.id})),Le.setDeeplink({tabId:t.id,url:s})}))));break;case"merchant":chrome.tabs.update(e.tab.id,{url:n},(t=>ta(void 0,void 0,void 0,(function*(){v&&(yield Le.setActivation({tabId:t.id,deeplink:void 0})),Le.setDeeplink({tabId:t.id,url:s})}))))}return yield he.updateStateById({id:o,data:{cashbackInactive:!1}}),!0})),da=()=>ta(void 0,void 0,void 0,(function*(){const t=yield yt();yield wt(t.id,{action:"removeCoupon"})})),la=({request:t,sender:e})=>ta(void 0,void 0,void 0,(function*(){const{id:a}=t.data,i={};i.tabId=e.tab.id,yield Le.clearSuppression({data:i}),yield he.updateStateById({id:a,data:{activatedShown:!1}})})),ua=({request:t,sender:e={}})=>ta(void 0,void 0,void 0,(function*(){var a,i;const n=yield Ft();"stop"!==n.activationCount&&(n.activationCount+=1,Bt(n));const{id:o=null,current:s=!1,tabInfo:r=null,offerId:c=null}=t.data,d=yield he.getMerchantAndState({id:o});if(!d)return!1;d.name.includes("eBay")&&At({ebayTimestamp:0});const l=(null==e?void 0:e.tab)||r||(yield yt()),u=null===(a=null==d?void 0:d.rates)||void 0===a?void 0:a.some((t=>t.canClickout)),{hasAdBlock:h}=yield St("hasAdBlock"),v=!h&&!n.interstitialPageEnabled&&n.token&&!u;let m=null;const p=c?`offerId=${c}`:"";m=d.serpLink?`${d.serpLink}${c?"?":""}${p}`:`${G}${d.link}?token=${n.token}&${p}`,v&&(m=(yield aa(d.id,c))||m),At({waitRemove:!1});const{successNcvVoucher:f=null}=yield St("successNcvVoucher");if(f){At({successNcvVoucher:!1}),da(),At({waitRemove:!0});const e=yield Fe.findOne(null==l?void 0:l.url),a=!Array.isArray(null==e?void 0:e.remove)&&(null===(i=null==e?void 0:e.remove)||void 0===i?void 0:i.timeout)||4e3;return setTimeout((()=>ta(void 0,void 0,void 0,(function*(){const{waitRemove:e=!1}=yield St("waitRemove");e&&(At({waitRemove:!1}),ua({request:{data:Object.assign(Object.assign({},t.data),{tabInfo:l})},sender:void 0}))}))),a),!1}const g=s?l.url:null;return chrome.tabs.update(l.id,{url:m},(()=>ta(void 0,void 0,void 0,(function*(){la({request:{data:{id:o}},sender:{tab:l}}),v&&(yield Le.setActivation({deeplink:g,tabId:l.id})),Le.setDeeplink({tabId:l.id,url:g})})))),he.updateStateById({id:o,data:{cashbackInactive:!1}})})),ha=()=>ta(void 0,void 0,void 0,(function*(){var t;const{caaFinishMerchants:e={}}=yield St("caaFinishMerchants");e.data=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.filter((t=>(null==t?void 0:t.timestamp)>Date.now())),At({caaFinishMerchants:e})})),va=({request:t,sendResponse:e,sender:a})=>ta(void 0,void 0,void 0,(function*(){At({successNcvVoucher:!1}),ha(),ta(void 0,void 0,void 0,(function*(){const t=yield Ft();if((null==t?void 0:t.alarmsCheckTimestamp)>Date.now())return!1;const e=((yield Tt())||[]).filter((t=>t.name!==A.SESSION_PING)).map((t=>JSON.parse(t.name).module)),a=Object.values(C).filter((t=>!e.includes(t)));return a.length>0&&a.forEach((t=>$t[t]())),t.alarmsCheckTimestamp=Date.now()+21e5,Bt(t)})),ta(void 0,void 0,void 0,(function*(){if("safari"===Ut()||"firefox"===Ut())return!1;const t=yield Ft();if(t.pinnedCheckTimestamp&&t.pinnedCheckTimestamp>Date.now())return!1;const e=yield chrome.action.getUserSettings();return e.isOnToolbar!==t.pinned&&(t.pinned=e.isOnToolbar,e.isOnToolbar&&be.sendAnalytics({name:"extension_pinned"}),t.pinnedCheckTimestamp=Date.now()+6e5,Bt(t))}));const{url:i}=t.data,n=yield Fe.findOne(i);yield Le.checkMerchantStatus({url:i,tabId:a.tab.tabId});const o=yield he.getMerchantAndState({url:i});let s=null;const r=yield Ft();r.alternativesEnabled&&(s=yield Ge.findAll({url:i}));let{mutedAlternatives:c=[]}=yield St("mutedAlternatives");if(s&&((null==c?void 0:c.find((t=>t===s.name)))?s=null:s.merchants=s.alternativeMerchants.map((t=>he.getMerchantAndState({id:t.id})))),null==o?void 0:o.name.includes("eBay")){const{ebayTimestamp:t=0}=yield St(["ebayTimestamp"]);if(t>Date.now())return!1;At({ebayTimestamp:0})}let d=[];((t,e)=>!("forever"===e.suppressSuggestionsTill||e.suppressSuggestionsTill>(new Date).getTime()||!t||t.activated||t.cashbackAvailable||t.disableCashbackSupport||t.vouchers.length&&t.vouchers.filter((t=>null!==t.code)).length))(o,r)&&(d=yield ae(o.id));const l=!!r.token;if(!r.notificationEnabled)return e({merchant:o,settings:r,scope:"content",alternative:s,loaded:Date.now(),url:i,config:null==n?void 0:n.url,mutedAlternatives:c,isLogged:l});const u=o&&(yield(async({id:t})=>{let{mutedMerchants:e=[]}=await St(k.MUTEDMERCHANTS);return e=e.filter((t=>"forever"===t.timestamp||t.timestamp>Date.now())),At({mutedMerchants:e}),e.find((e=>e.id===t))})({id:o.id}));let h=yield Ze();h=h.filter((({show:t})=>t)),h.length&&(h=h.length&&Promise.all(h.map((({id:t})=>ta(void 0,void 0,void 0,(function*(){return yield he.getMerchantAndState({id:t})})))))),c=c.map((t=>Ge.findAll({name:t})));const v=yield ye.get(),m=null==v?void 0:v.favorites,p=yield ze.getAll(),f=o&&p.deals.find((t=>t.merchantId===o.id));o&&(o.vouchersLink=`${o.serpLink.replace("toolbar","cashback").slice(0,-1)}#gutscheine`);let g=!(!(null==o?void 0:o.checkoutPattern)||!i.match(new RegExp(o.checkoutPattern)));u&&(g=g&&!u.show);const{shouldShowPinTutorial:y}=yield St("shouldShowPinTutorial");e({merchant:o,isLogged:l,muted:u,favorites:m,settings:r,lastChance:g,deal:f||null,scope:"content",alternative:s,loaded:Date.now(),url:i,activationCount:(null==r?void 0:r.activationCount)||0,activationCountTimestamp:null==r?void 0:r.activationCountTimestamp,shouldShowPinTutorial:y,config:null==n?void 0:n.url,mutedAlternatives:c,mutedMerchants:h,user:v,suggestedMerchants:d})})),ma=()=>ta(void 0,void 0,void 0,(function*(){yield It(500),chrome.tabs.create({url:q}),be.sendAnalytics({name:"privacy_consent",params:{event_action:"click",event_location:"privacy_page",event_details:Ut()}})})),pa=({request:t})=>ta(void 0,void 0,void 0,(function*(){const{muteStrategy:e,id:a}=t.data,i="forever"===e,n="hour"===e;yield(async({id:t,forever:e=!0,hour:a=!1})=>{const{mutedMerchants:i=[]}=await St(k.MUTEDMERCHANTS);return i.push({id:t,timestamp:e?"forever":Date.now()+(a?36e5:864e5),show:!a}),At({mutedMerchants:i}),i})({id:a,forever:i,hour:n})})),fa=()=>ta(void 0,void 0,void 0,(function*(){yield ee(void 0,void 0,void 0,(function*(){yield Bt({suppressSuggestionsTill:"forever"})}))})),ga=({request:t,sendResponse:e})=>ta(void 0,void 0,void 0,(function*(){const a=yield Ft();if(!a.token)return ea(),!1;const{id:i,scope:n,name:o}=t.data,s="content"===n?"notification":"popup",r=yield ye.get(),{favorites:c}=r,d=c.map((({id:t})=>t)).includes(i);let l="",u={};return kt.authToken=null==a?void 0:a.token,d?(l="favourites_removed",u=yield kt.delete(new _t(J).setParam("id",i).toString())):(l="favourites_add",u=yield kt.post(J,JSON.stringify({id:i}))),"error"in u||be.sendAnalytics({name:l,params:{event_merchant:o,event_location:s}}),e({success:!u.error,action:d?"remove":"add"}),Promise.all([ye.update(!0)])})),ya=({request:t})=>{const{id:e}=t.data;he.updateStateById({id:e,data:{activatedShown:!0}})},wa=({request:t})=>{const{url:e}=t.data;chrome.tabs.create({url:e})},ba=()=>ta(void 0,void 0,void 0,(function*(){if("safari"===Ut())return chrome.tabs.create({url:et},(({id:t})=>{const e=(a,i)=>{a===t&&"complete"===i.status&&setTimeout((()=>{wt(a,{action:"openSettings"}),chrome.tabs.onUpdated.removeListener(e)}),1500)};chrome.tabs.onUpdated.addListener(e)}));const t=(yield gt()).find((t=>t.url.match(/\/\/(.+)\/shoopSettings\.html/)));return t?chrome.tabs.reload(t.id,{active:!0}):chrome.tabs.create({url:"../../shoopSettings.html"}),!0})),Sa=({sendResponse:t})=>ta(void 0,void 0,void 0,(function*(){let e=yield Ze();e=e.filter((({show:t})=>t)),e.length&&(e=e.length&&(yield Promise.all(e.map((({id:t})=>ta(void 0,void 0,void 0,(function*(){return yield he.getMerchantAndState({id:t})})))))));let{mutedAlternatives:a=[]}=yield St("mutedAlternatives");a=a.map((t=>Ge.findAll({name:t})));const i=yield Ft(),n=i.isUrlTrackingEnabled,o=!!i.token;t({muted:e,mutedAlternatives:a,settings:i,isLogged:o,isUrlTrackingEnabled:n})})),Aa=({request:t})=>ta(void 0,void 0,void 0,(function*(){const{id:e}=t.data;yield(async({id:t})=>{let{mutedMerchants:e=[]}=await St(k.MUTEDMERCHANTS);return e=e.filter((e=>e.id!==t)),At({mutedMerchants:e}),e})({id:e}),"safari"===Ut()?setTimeout((()=>{bt()}),50):bt()})),Ta=()=>ta(void 0,void 0,void 0,(function*(){const t=yield ze.getAll();return 0===(yield he.getAllMerchants()).length||0===t.length})),Ia=({sendResponse:t})=>ta(void 0,void 0,void 0,(function*(){var e;const a=yield Vt();if(yield Ta())return t({askForUrlTrackingConsent:!a,globalError:!0}),!1;const i=yield Ft(),n=yield yt(),o=!!(null==i?void 0:i.token),s=yield he.getMerchantAndState({url:null==n?void 0:n.url});s&&(s.current=!0);const r=Ye(s)?yield he.getMerchantSuggestions(s):[],c=n.url.match(lt);(null==n?void 0:n.url.includes("booking.com"))&&!c&&s.activated&&(s.activated=!1);const d=yield Fe.findOne(null==n?void 0:n.url),l=yield ze.getAll(),u=null===(e=null==l?void 0:l.deals)||void 0===e?void 0:e.map(((t,e)=>Object.assign(Object.assign({},t),{id:e}))),h=yield ye.get(),v=null==h?void 0:h.favorites,m=[...new Set(null==u?void 0:u.map((t=>t.merchantId)))];let p=[],f=[],g=yield We.getAll();g&&(p=null==g?void 0:g.filter((t=>m.includes(t.id))),f=g&&(null==g?void 0:g.filter((t=>!m.includes(t.id))))),g=[...p,...f];const y=yield Ke.getAll(),w=(null==i?void 0:i.analyticsNotification)&&!(null==i?void 0:i.isAnalyticEnabled)&&("firefox"===Ut()||"safari"===Ut());return t({merchant:s,user:h,deals:u,conditions:y,isLogged:o,favorites:v,topMerchants:g,suggestedMerchants:r,scope:"popup",activationCount:(null==i?void 0:i.activationCount)||0,isPremium:Ht(h),config:null==d?void 0:d.url,activationCountTimestamp:null==i?void 0:i.activationCountTimestamp,askForUrlTrackingConsent:!a,url:n.url,showAnalyticsCard:w,testingGroup:null==i?void 0:i.testingGroup,rateUsBarShowed:null==i?void 0:i.rateUsBarShowed,showUnsupportedMerchantTooltip:null==i?void 0:i.showUnsupportedMerchantTooltip}),!0})),Ea=({request:t,sendResponse:e})=>ta(void 0,void 0,void 0,(function*(){const{query:a}=t.data;let i=yield he.getAllMerchants();i=i.filter((({name:t})=>t.toLowerCase().includes(a.toLowerCase()))),i=i.length?i.slice(0,20):["empty"],e(i)})),ka=({request:t,sendResponse:e})=>ta(void 0,void 0,void 0,(function*(){const{id:a}=t.data,i=yield he.getMerchantAndState({id:a});if(!i)return!1;const n=Ye(i)?yield he.getMerchantSuggestions(i):[];return e({merchant:i,suggestedMerchants:n})})),Ca=({sendResponse:t})=>ta(void 0,void 0,void 0,(function*(){yield We.update(!0),t({result:!0})})),Pa=({request:t})=>ta(void 0,void 0,void 0,(function*(){var e;const a=null===(e=null==t?void 0:t.data)||void 0===e?void 0:e.from;if(wa({request:{data:{url:dt[Ut()]}}}),"settings"===a)return!1;const i=yield Ft();return i.activationCount="stop",i.activationCountTimestamp=null,yield Bt(i),!0})),Ma=()=>ta(void 0,void 0,void 0,(function*(){const t=yield Ft();t.activationCount=0,yield Bt(t)})),xa=()=>ta(void 0,void 0,void 0,(function*(){const t=yield Ft();t.activationCount="stop",yield Bt(t)})),Da=()=>ta(void 0,void 0,void 0,(function*(){const t=yield Ft();t.activationCountTimestamp=Date.now()+vt,yield Bt(t)})),Ra=()=>ta(void 0,void 0,void 0,(function*(){yield At({shouldShowPinTutorial:!1})})),Oa=({request:t})=>ta(void 0,void 0,void 0,(function*(){const{id:e,countShown:a,persistPerSession:i}=t.data;he.updateStateById({id:e,data:{countShown:a+1},persistPerSession:i})})),Na=()=>ta(void 0,void 0,void 0,(function*(){const t=yield Ft();return t.token?(kt.authToken=void 0,t.token="",t.interstitialPageEnabled=!0,t.testingGroup=null,yield Bt(t),yield ye.clearData(),yield he.setDefaultStates(),(async()=>{At({mutedMerchants:[]})})(),u.setUserId(null),yield Lt(),be.sendAnalytics({name:"logout",params:{}}),!0):null})),_a=({request:t})=>ta(void 0,void 0,void 0,(function*(){const{token:e}=t.data,a=yield Ft();return null===e&&a.token?(yield Na(),!0):(a.token,a.token&&a.token!==e&&void 0!==e?(yield ye.setTokenAndUpdate(e),!0):!(a.token||!e||(yield ye.setTokenAndUpdate(e),yield ta(void 0,void 0,void 0,(function*(){var t;const e=yield Ft();e.suppressSuggestionsTill=0,null===(t=chrome.storage.session)||void 0===t||t.clear(),yield Bt(e)})),0)))})),Ua=({sender:t,sendResponse:e})=>ta(void 0,void 0,void 0,(function*(){var a;const{url:i}=t,n=yield Fe.findOne(i),o=yield he.getMerchantAndState({url:i});if(!o||(({merchant:t,url:e})=>{if((null==t?void 0:t.id)===v){const a=t.activated,i=lt.test(e);return!a||!i}return!1})({merchant:o,url:i}))return!1;n&&(null==o?void 0:o.name)&&be.sendAnalytics({name:"checkout_visit",params:{event_merchant:o.name}}),!o.vouchers.length&&n&&be.sendAnalytics({name:"caa_no_coupons",params:{event_merchant:o.name}});const{caaData:s={}}=yield St("caaData");let r={};if(o&&s[o.id]&&(r=s[o.id]),"mute"===(null==r?void 0:r.reason)&&(null==r?void 0:r.timestamp)+36e5>Date.now())return!1;const{ebayTimestamp:c=0}=yield St(["ebayTimestamp"]);(null==o?void 0:o.name.includes("eBay"))&&c<Date.now()&&At({ebayTimestamp:0});const{caaFinishMerchants:d={}}=yield St("caaFinishMerchants"),l=null===(a=null==d?void 0:d.data)||void 0===a?void 0:a.find((t=>(null==t?void 0:t.id)===o.id)),u=yield yt(),h=yield Fe.getAll(),m=l&&l.tabId===(null==u?void 0:u.id)&&o.activated;return e({configs:h,merchant:Object.assign(Object.assign({},o),{vouchers:o.vouchers.sort(((t,e)=>t.voucherType>e.voucherType?-1:t.voucherType<e.voucherType?1:0))}),caaStatus:r,isCaaFinish:m,ebayTimestamp:(null==o?void 0:o.name.includes("eBay"))&&c})})),La=()=>ta(void 0,void 0,void 0,(function*(){const t=yield yt();let{caaData:e={}}=yield St("caaData");e={},At({caaData:e}),yield wt(t.id,{action:"applyCoupons"})})),$a=({request:t})=>ta(void 0,void 0,void 0,(function*(){const{data:e}=t,a=yield yt(),i={id:e.merchantId,tabId:null==a?void 0:a.id,timestamp:Date.now()+6e4},{caaFinishMerchants:n={}}=yield St("caaFinishMerchants");n.data.push(i),At({caaFinishMerchants:n})})),Ha=({request:t})=>ta(void 0,void 0,void 0,(function*(){if((yield Ft()).isAnalyticEnabled){const{data:e}=t;fetch("https://analytics.besttoolbars.net/api/v1/activity/shoop",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.caaAnalytics)})}})),qa=({request:t})=>ta(void 0,void 0,void 0,(function*(){const{data:e}=t,{caaData:a={}}=yield St("caaData");a[null==e?void 0:e.id]=Object.assign({},e),At({caaData:a})})),Ga=({request:t})=>ta(void 0,void 0,void 0,(function*(){let{mutedAlternatives:e=[]}=yield St("mutedAlternatives");e||(e=[]),e.push(t.data.param),At({mutedAlternatives:e})})),ja=()=>ta(void 0,void 0,void 0,(function*(){const t=yield Ft();t.alternativesEnabled=!1,yield Bt(t)})),Ba=({request:t})=>ta(void 0,void 0,void 0,(function*(){let{mutedAlternatives:e=[]}=yield St("mutedAlternatives");e=e.filter((e=>e!==t.data.name)),At({mutedAlternatives:e})})),Fa=({request:t})=>ta(void 0,void 0,void 0,(function*(){(yield Ge.findAll({url:t.data.url})).data.find((e=>e.name===t.data.name)).timestamp=Date.now()+6e4})),Va=({request:t,sendResponse:e})=>ta(void 0,void 0,void 0,(function*(){const{settings:a}=t.data,i=yield Bt(a);e(i)})),Ka=({request:t,sendResponse:e})=>ta(void 0,void 0,void 0,(function*(){const{offerId:a=null,merchantId:i=null}=t.data,n=yield he.getCode(a,i);return!!n&&(yield Ia({merchantId:n,sendResponse:e}),!0)})),Ja=({request:t,sender:e})=>ta(void 0,void 0,void 0,(function*(){const{url:a}=t.data,i=yield he.getMerchantAndState({url:a}),n=P.find((t=>t.rx.test(a))),o=a.includes(L);(i||n||o)&&chrome.tabs.executeScript(e.tab.id,{file:"./content/bundle.js"})})),za=({request:t})=>ta(void 0,void 0,void 0,(function*(){if(!(yield Vt()))return;const{id:e,activated:a,voucherCode:i=null,wasActivated:n=!0,cashbackInactive:o=!0}=t.data;yield he.updateStateById({id:e,data:{activated:a,cashbackInactive:o}});const s=yield yt();yield Me.defineIcon(s);const r=yield gt();let c=yield Promise.all(r.map((t=>ta(void 0,void 0,void 0,(function*(){const a=yield he.getMerchantAndState({url:t.url});if((null==a?void 0:a.id)===e)return t})))));c=c.filter((t=>void 0!==t));const d=[];return c.forEach((t=>{d.push(wt(t.id,{action:"disableNotification",data:{voucherCode:i,wasActivated:n}}))})),Promise.all(d)})),Xa=()=>ta(void 0,void 0,void 0,(function*(){yield ye.update(!0);const t=yield ye.get(),e=yield Ft();e.interstitialPageEnabled="skip"!==(null==t?void 0:t.extensionInterstitialPage),yield Bt(e)})),Qa=({request:t})=>ta(void 0,void 0,void 0,(function*(){try{const{interstitialPageEnabled:e=!1}=t.data,a=e?"show":"skip";yield kt.patch(X,JSON.stringify({setting:a})),yield ye.update(!0)}catch(t){return null}return!0})),Wa=({request:t})=>ta(void 0,void 0,void 0,(function*(){const{shoopSessionUrlParams:e="",cookie:a=""}=t.data,i=a.split("; ").reduce(((t,e)=>{const[a,...i]=e.split("=");return t[a]=i.join("="),t}),{}),n=yield Ft();if(n.customerHash!==(null==i?void 0:i.customerHash)){n.customerHash=null==i?void 0:i.customerHash,yield u.init({apiUrl:"https://www.shoop.de/mgtrx/tx",businessModel:l.Cashback,customerHash:n.customerHash,trackId:"45ba4cf1e7d2d96fc5c22b8f62ac967d",trackUrlPrefix:"https://extension.shoop.de",version:chrome.runtime.getManifest().version});const t=new _t(it).setParams({customerHash:yield u.getCustomerHash(),version:chrome.runtime.getManifest().version});chrome.runtime.setUninstallURL(t.toString())}e&&(n.sessionUrlParams=yield JSON.parse(e),yield Bt(n))})),Ya=({sendResponse:t})=>ta(void 0,void 0,void 0,(function*(){const e=yield Ft();e.showUnsupportedMerchantTooltip=!1,yield Bt(e),t(!0)})),Za=({request:t,sendResponse:e})=>ta(void 0,void 0,void 0,(function*(){var a;const i=null===(a=null==t?void 0:t.data)||void 0===a?void 0:a[k.CAACONFIGS],n=yield Xt(k.CAACONFIGS,i);yield Fe.update(!0),e(Object.assign({},n))})),ti=({request:t,sendResponse:e})=>ta(void 0,void 0,void 0,(function*(){var a;const i=null===(a=null==t?void 0:t.data)||void 0===a?void 0:a[k.MERCHANTS],n=yield Xt(k.MERCHANTS,i);yield he.update(!0),e(Object.assign({},n))})),ei=()=>ta(void 0,void 0,void 0,(function*(){const t=yield yt();yield Me.defineIcon(t)}));var ai,ii=function(t,e,a,i){return new(a||(a=Promise))((function(n,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function r(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,r)}c((i=i.apply(t,e||[])).next())}))};Nt.logConsoleErrors(),Nt.logUnhandledErrors(),!chrome.action&&chrome.browserAction&&(chrome.action=chrome.browserAction);const ni=(t="")=>ii(void 0,void 0,void 0,(function*(){if(!(yield Vt()))return;const e=yield Ft();let a="";if((null==e?void 0:e.sessionUrlParams)&&"install"===t){const t=null==e?void 0:e.sessionUrlParams;a=Object.keys(t).map((e=>`${e}=${encodeURIComponent(t[e])}`)).join("&")}u.trackPageView({url:`/${t}${a?`?${a}`:""}`})}));chrome.runtime.onInstalled.addListener((({reason:t})=>ii(void 0,void 0,void 0,(function*(){yield ii(void 0,void 0,void 0,(function*(){yield(async()=>{const t=await jt(),e={isUrlTrackingEnabled:qt(t),isAnalyticEnabled:"firefox"!==Ut()&&"safari"!==Ut(),analyticsNotification:(a=t,!1!==qt(a)),token:null,serpEnabled:!0,notificationEnabled:!0,activationCount:0,activationCountTimestamp:null,alternativesEnabled:!0,interstitialPageEnabled:!0,customerHash:"",sessionUrlParams:null,alarmsCheckTimestamp:null,pinned:!1,pinnedCheckTimestamp:null,testingGroup:null,rateUsBarShowed:!1,suppressSuggestionsTill:0,showUnsupportedMerchantTooltip:!0};var a;return Gt(t?{...e,...t}:e)})(),yield At({hasAdBlock:!1})})),yield be.initAnalytics(),yield ii(void 0,void 0,void 0,(function*(){try{yield((t=!1)=>ii(void 0,void 0,void 0,(function*(){return Promise.all([ze.update(t),Ke.update(t),Fe.update(t),Ge.update(t),he.update(t)]).then((t=>t)).catch((()=>null))})))(!0),yield We.update(!0),he.setDefaultStates(),Le.init();const t={};t.data=b,yield At({activationPatterns:t}),At({caaFinishMerchants:{data:[]}})}catch(t){console.log(t)}finally{Me.setDefault()}}));const e=yield Ft();if(kt.authToken=null==e?void 0:e.token,(null==e?void 0:e.token)&&(yield ye.update(!0),yield ye.updateUserSettings()),"update"===t&&setTimeout((()=>{ni("update")}),5e3),"install"===t){let t=null;t="chrome"===Ut()||"opera"===Ut(),yield At({shouldShowPinTutorial:t}),setTimeout((()=>ii(void 0,void 0,void 0,(function*(){const t=(yield Vt())?q:chrome.runtime.getURL(ct);chrome.tabs.create({url:t})}))),500),yield It(5e3),be.sendAnalytics({name:"install"}),ni("install")}})))),chrome.runtime.onMessage.addListener(((t,e,a)=>{var i;const n={activate:ca,activateFromPopup:ua,activatedShown:ya,activatedShownRemove:la,addLocalCaaConfigs:Za,addLocalMerchants:ti,applyCoupons:La,caaFinish:$a,changeMerchantState:za,closePinTutorial:Ra,declineRateSuggestion:xa,disableAlternatives:ja,editFavorites:ga,generateActivationLink:aa,getCaaData:Ua,getMerchant:sa,getMerchantById:ka,getMerchantAndCaaConfig:ra,getPopupInfo:Ia,getSettingsInfo:Sa,hideUnsupportedMerchantTooltip:Ya,increaseShownCount:Oa,initContent:va,handlePrivacyConsent:ma,isError:Ta,isRelevantContentTab:Ja,logService:{info:({request:t})=>{Nt.info(t.params)}},logout:Na,megatron:{track:({request:t})=>{u.track(t.data)}},muteAlternative:Ga,muteAlternatives:Fa,muteMerchant:pa,muteSuggestionsForAllMerchants:fa,navigate:wa,openLoginPage:ea,openOptions:ba,openStore:Pa,postponeRateSuggestion:Da,refreshActivationCount:Ma,refreshTopMerchants:Ca,reloadUserInfo:Xa,removeAlternativeMuted:Ba,removeCoupon:da,removeMuted:Aa,requestCode:Ka,saveStates:Va,searchMerchants:Ea,sendAnalytics:oa,sendCaaAnalytics:Ha,setAnalyticsRateUsShowed:na,setAnalyticsSettings:ia,setCaaState:qa,setMegatronData:Wa,updateCaaFinishMerchants:ha,updateShowInterstitialSetting:Qa,updateToken:_a,updateIcon:ei},o=t.module?n[t.module]:n;return o&&"function"==typeof o[t.action]?null===(i=o[t.action])||void 0===i||i.call(o,{request:t,sender:e,sendResponse:a}):a(null),!0})),chrome.webRequest.onBeforeRequest.addListener((t=>{Vt().then((e=>{e&&(t.parentFrameId&&"safari"===Ut()||Le.checkUrl(t))}))}),{urls:["<all_urls>"],types:["main_frame"]}),chrome.tabs.onUpdated.addListener(((t=null,e=null,{url:a=""})=>ii(void 0,void 0,void 0,(function*(){(yield Vt())?("loading"===e.status?(yield Le.checkUrl({url:a,tabId:t}),yield Le.checkMerchantStatus({url:a,tabId:t})):"complete"===e.status?yield Le.checkDeeplink({url:a,tabId:t}):"safari"!==Ut()&&"firefox"!==Ut()||void 0!==e.status||(yield Le.checkUrl({url:a,tabId:t}),yield Le.checkMerchantStatus({url:a,tabId:t}),yield Le.checkDeeplink({url:a,tabId:t})),Me.defineIcon(t)):Me.inactive()})))),chrome.tabs.onActivated.addListener((({tabId:t})=>ii(void 0,void 0,void 0,(function*(){Me.defineIcon(t)})))),chrome.action.setPopup({popup:"popup.html"}),function(){var t,e,a,i;t=this,e=void 0,i=function*(){Nt.init({clientToken:"pube22fe1d3afa6fe7982d40f27be3f9183",env:"production",sessionSampleRate:.1,service:"shoop:extension",sessionId:yield u.getCustomerHash(),threshold:2e3,version:chrome.runtime.getManifest().version})},new((a=void 0)||(a=Promise))((function(n,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function r(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,r)}c((i=i.apply(t,e||[])).next())}))}(),ii(void 0,void 0,void 0,(function*(){const t=yield Ft();yield u.init({apiUrl:"https://www.shoop.de/mgtrx/tx",businessModel:l.Cashback,customerHash:null==t?void 0:t.customerHash,trackId:"45ba4cf1e7d2d96fc5c22b8f62ac967d",trackUrlPrefix:"https://extension.shoop.de",version:chrome.runtime.getManifest().version})})),u.getCustomerHash().then((t=>{const e=new _t(it).setParams({customerHash:t,version:chrome.runtime.getManifest().version});chrome.runtime.setUninstallURL(e.toString())})),chrome.alarms.create(A.SESSION_PING,{periodInMinutes:10}),chrome.alarms.onAlarm.addListener((({name:t})=>{if(t===A.SESSION_PING)return Nt.ping(),void u.ping();const e={alternatives:{update:Ge.update},caaConfigs:{update:Fe.update},conditions:{update:Ke.update},dealsCategories:{update:ze.update},topMerchants:{update:We.update},merchants:{update:he.update},user:{update:ye.update},cashback:{clearActivation:Le.clearActivation,clearSuppression:Le.clearSuppression,clearDeeplink:Le.clearDeeplink}},{module:a="",action:i="",data:n={}}=JSON.parse(t),o=a?e[a]:e;o&&"function"==typeof o[i]&&o[i].call(o,{data:n})})),null===(ai=chrome.runtime.onStartup)||void 0===ai||ai.addListener((()=>{chrome.storage.session.clear()})),chrome.windows.onRemoved.addListener((()=>ii(void 0,void 0,void 0,(function*(){(yield chrome.windows.getAll()).length||chrome.storage.session.clear()}))))})();