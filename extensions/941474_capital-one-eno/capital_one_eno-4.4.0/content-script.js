!function(){"use strict";class e{static extractOriginPath(e){try{const t=new URL(e);return t.origin+t.pathname}catch(t){return console.warn("cornhusk, shared-service, error: "+t+"Invalid url: "+e),""}}}class t{constructor(e,t){this.text=e,this.xTopLeft=t.left,this.yTopLeft=t.top,this.xBottomRight=t.left+t.width,this.yBottomRight=t.top+t.height,this.isVisible=this.checkTextIsVisible()}checkTextIsVisible(){const e=this.text.trim().length,t=[this.xTopLeft,this.yTopLeft,this.xBottomRight,this.yBottomRight];return e>0&&!t.includes(0)}}class s{static lineSegmentDistance(e,t,s,n){return s>=e&&s<=t?0:e<=s?s-t:e>=s&&e<=n?0:e-n}static wgeRowColDistance(e,t,n,o,i,a,r,c){const l=s.lineSegmentDistance(e,n,i,r),h=3*s.lineSegmentDistance(t,o,a,c);return l>0&&h>0?Number.MAX_VALUE:Math.max(l,h)}}class n{static getNeighborTextCandidates(e){let s,o=[];if(e.tagName&&["script","noscript","style","footer","header"].includes(e.tagName))return o;try{s=e.getBoundingClientRect()}catch(t){return console.error("cornhusk, neighbor.service, error: ",t,". node with exception: "+e.tagName),o}let i=[],a=!0;if(e.childNodes.forEach((e=>{e instanceof Text?/^\s*$/.test(e.data)||i.push(e):e instanceof Element&&(i.push(e),a=!1)})),a){let e=i.map((e=>e.data.trim())).join(" ");if(e.trim().length>0){const n=new t(e,s);n.isVisible&&o.push(n)}}else i.forEach((e=>{if(e instanceof Text){const t=n.getFigureTextInfo(e);t.isVisible&&o.push(t)}else o=o.concat(n.getNeighborTextCandidates(e))}));return o}static getFigureTextInfo(e){const s=e.data.trim(),n=document.createRange();n.selectNodeContents(e);const o=n.getBoundingClientRect();return new t(s,o)}static getNodeNeighborsText(e,s){const o=[];let i;try{const s=e.getBoundingClientRect();i=new t(e.tagName,s)}catch(t){return console.error("cornhusk, neighbors, error: ",t," with exception: "+e.tagName),""}for(let e=0;e<s.length;e++){const t=s[e];if(n.matchNeighbors(i,t)){const e=t.text.replace(/\s\s+/g," ");o.push(e)}}return o.length>0?o.join(" "):""}static matchNeighbors(e,t){return s.wgeRowColDistance(e.xTopLeft,e.yTopLeft,e.xBottomRight,e.yBottomRight,t.xTopLeft,t.yTopLeft,t.xBottomRight,t.yBottomRight)<=30}}class o{static checkNodeIsHidden(e){return!!("hidden"===e.type||e.disabled||e.offsetWidth<5&&e.offsetHeight<5&&e.getClientRects().length<5)}static inputNodeToInclude(e){return["text","tel","number","password"].includes(e.type)}static getNodeAttributesValues(e){const t=["id","name","type","autocomplete","data-automation-id","placeholder"],s=e.attributes;let n="";for(let e=0;e<s.length;e++)if(t.includes(s[e].name)){let t=s[e].value;t=t.replace("-"," "),t=t.replace("_"," "),n+=" "+t}return n.trim()}static buildFieldRecord(e,t){let s=0,n=0;const i=`${t} ${o.getNodeAttributesValues(e)}`;return"input"===e.tagName.toLowerCase()?s=1:n=1,[s,n,i]}}class i{paypalCount=0;bodyText="";pageFields=[];pageNodes=[];constructor(){}getNodeFeatures(e,t){const s=e.getElementsByTagName("input"),n=e.getElementsByTagName("select"),o=e.getElementsByTagName("h1"),i=e.getElementsByTagName("h2"),a=e.getElementsByTagName("h3"),r=/paypal/g;if(t.length>0)for(let e=0;e<t.length;e++)this.paypalCount+=(t[e].text.toLowerCase().match(r)||[]).length;else this.paypalCount=this.countText(e.body,r);for(let e=0;e<o.length;e++)this.bodyText+=` ${o[e].innerText}`;for(let e=0;e<i.length;e++)this.bodyText+=` ${i[e].innerText}`;for(let e=0;e<a.length;e++)this.bodyText+=` ${a[e].innerText}`;for(let e=0;e<s.length;e++)this.processNodeInfo(s[e],t);for(let e=0;e<n.length;e++)this.processNodeInfo(n[e],t);let c="";return self===top&&(c=e.title),this.generateResult(c)}processNodeInfo(e,t){if(o.checkNodeIsHidden(e))return;let s=n.getNodeNeighborsText(e,t);0==s.length&&e.hasAttribute("placeholder")&&(s=e.getAttribute("placeholder")),this.bodyText=`${this.bodyText} ${s} <${e.tagName}> `,("select"===e.tagName.toLowerCase()||"input"===e.tagName.toLowerCase()&&o.inputNodeToInclude(e))&&(this.pageFields.push(o.buildFieldRecord(e,s)),this.pageNodes.push(e))}generateResult(e){let t=!1;return(e.trim().length>0||this.bodyText.trim().length>0||this.paypalCount>0||this.pageFields.length>0)&&(t=!0),{containsInfo:t,pageToClassify:{pageData:{title:e,bodyText:this.bodyText,paypalCount:this.paypalCount},pageFieldsData:this.pageFields},pageNodes:this.pageNodes}}countText(e,t){let s=0;return e.tagName&&["script","noscript","style","footer","header"].includes(e.tagName.toLowerCase())||o.checkNodeIsHidden(e)||e.childNodes.forEach((e=>{e instanceof Text?/^\s*$/.test(e.data)||(s+=(e.data.toLowerCase().match(t)||[]).length):e instanceof HTMLElement&&(s+=this.countText(e,t))})),s}}class a{lastPageEvaluated={};static totalFingerprintsSent=0;static isLoading=!1;static isCheckout=!1;static fingerprintPage(){const t=a.getPaymentPageInfo(document);if(t.containsInfo){a.totalFingerprintsSent++;const s={action:"ml_fingerprint",data:t.pageToClassify,url:e.extractOriginPath(document.URL.valueOf()),referrer:e.extractOriginPath(document.referrer)};a.isLoading||(a.isLoading=!0,platform.sendMessage(s,(e=>{a.isLoading=!1,a.isCheckout=e.isCheckout})))}}static checkPossiblePaymentPage(e){const t=e.getElementsByTagName("input"),s=e.getElementsByTagName("select");if(null==t&&null==s)return!1;let n=0;for(let e=0;e<t.length;e++){let s=t[e];o.inputNodeToInclude(s)&&!o.checkNodeIsHidden(s)&&(n+=1)}for(let e=0;e<s.length;e++){let t=s[e];o.checkNodeIsHidden(t)||(n+=1)}return n>0}static getPaymentPageInfo(e){let t=[];return a.checkPossiblePaymentPage(e)&&(t=n.getNeighborTextCandidates(e.body)),(new i).getNodeFeatures(e,t)}}class r{static observer=new MutationObserver(r.observeCheckoutMutations);static totalMutations=0;static totalInputMutations=0;static totalFingerprintsSent=0;static observerOptions={childList:!0,subtree:!0,attributes:!0,characterData:!1,attributeFilter:["style","class"]};static launchMutationListeners(){return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(e=>{a.fingerprintPage(),a.isCheckout||r.activateListeners()})):(a.fingerprintPage(),a.isCheckout||r.activateListeners()),r.observer}static closeListeners(){r.observer.takeRecords(),r.observer.disconnect()}static activateListeners(){r.observer.observe(document,r.observerOptions)}static observeCheckoutMutations(e){let t=!1;r.totalMutations++,document.hidden||(t=r.checkTargetMutations(e),t&&(r.totalInputMutations++,a.fingerprintPage(),a.isCheckout&&r.closeListeners()))}static checkNodeChildren(e,t){if("html"!=t.nodeName.toLowerCase()&&"body"!=t.nodeName.toLowerCase()&&t.hasChildNodes()&&t.nodeType===Node.ELEMENT_NODE)for(let s=0;s<e.length;s++)if(t.getElementsByTagName(e[s]).length>0)return!0;return!1}static checkTargetMutations(e){const t=["input","select","h1","h2","h3"];for(let s=0;s<e.length;s++){const n=e[s];switch(n.type){case"attributes":const e=n.target;if(t.includes(e.nodeName.toLowerCase())||r.checkNodeChildren(t,e))return!0;break;case"childList":for(let e=0;e<n.addedNodes.length;e++){const s=n.addedNodes[e];if(t.includes(s.nodeName.toLowerCase())||r.checkNodeChildren(t,s))return!0}}}return!1}}platform.sendMessage({action:"get_feature_flag"},(e=>{e&&e.featureToggle?r.launchMutationListeners():r.closeListeners()})),platform.onMessage(((t,s,n)=>{if(t&&t.action)switch(t.action){case"refingerprint":r.activateListeners();break;case"populate_generate_card_number":setTimeout((()=>{const t=class{static selectorList=[{selector:"[autocomplete*='cc-number']",name:"Google Autocomplete"},{selector:"[id$='_ccno']",name:"Generic"},{selector:"[data-braintree-name='number']",name:"Braintree"},{selector:"[id=dwfrm_billing_paymentMethods_creditCard_number]",name:"dwfrm"}];static getAutocompleteRule(e){for(let t=0;t<this.selectorList.length;t++){const s=e.querySelectorAll(this.selectorList[t].selector);for(let e=0;e<s.length;e++){const n=s[e];if(n&&("text"===n.type||"tel"===n.type||"number"===n.type||"password"===n.type)&&!n.disabled&&(n.offsetWidth>=5||n.offsetHeight>=5||n.getClientRects().length>=5)&&n.isVisible())return this.selectorList[t].name}}return null}}.getAutocompleteRule(document);null!=t&&platform.sendMessage({action:"report_event",event:{event:"autocomplete_pattern_found",extra:{rule_type:t,hostname:location.hostname,url:e.extractOriginPath(document.URL.valueOf())}}},(()=>{}))}),2e3)}}))}();