let r=null,a=[],n="0",l="1";function h(){browser.storage.local.set({isOn:"0"}).then(()=>{n="0",browser.action.setBadgeText({text:""})})}browser.runtime.onStartup.addListener(h);function b(e){let s="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=t.length;let o=0;for(;o<e;)s+=t.charAt(Math.floor(Math.random()*i)),o+=1;return s}function y(e){let s=b(12);browser.storage.local.set({token:s}),browser.runtime.setUninstallURL("https://poteto.ru/deleted?token="+s)}browser.runtime.onInstalled.addListener(y);function d(){n==="1"?(browser.action.setBadgeText({text:"ON"}),browser.action.setBadgeBackgroundColor({color:"green"})):browser.action.setBadgeText({text:""})}function p(){browser.contextMenus.removeAll().then(()=>{let e="";l=="1"?e=browser.i18n.getMessage("add_nonproxy_contextmenu"):e=browser.i18n.getMessage("add_proxy_contextmenu"),browser.contextMenus.create({id:"add-site",title:e,contexts:["all","tab"]})})}browser.storage.local.get(["isOn","proxyMode","currentServer","bypass"]).then(e=>{n=e.isOn||n,l=e.proxyMode||"1",r=e.currentServer||null,a=e.bypass?JSON.parse(e.bypass):[],d(),p()});browser.runtime.onMessage.addListener((e,s,t)=>{switch(e.action){case"BashUpdate":r=e.proxy,n=e.isOn,d(),t({success:!0});break;case"BypassUpdate":a=e.bypass,t({success:!0});break;case"ProxyModeUpdate":l=e.proxyMode,p(),t({success:!0});break;default:t({success:!1})}});function x(e){const t=new URL(e).hostname;return t==="localhost"||t==="poteto.ru"||t==="127.0.0.1"||t.startsWith("192.168.")||t.startsWith("10.")||t.startsWith("172.")&&parseInt(t.split(".")[1])>=16&&parseInt(t.split(".")[1])<=31}function c(e){const t=new URL(e).hostname;return a.map(o=>{let u=o.replace(/\./g,"\\.").replace(/\*/g,".*");return u.endsWith("\\.*")&&(u=u.replace("\\.*","(\\.[a-zA-Z]{2,})")),new RegExp(`^${u}$`)}).some(o=>o.test(t))}function w(e){const t=new URL(e.url).hostname;if(r&&n=="1"){if(l=="1"&&!c(e.url)&&!x(e.url))return{type:r.proxy_type,host:r.proxy_host,port:Number(r.proxy_port)};if(l=="2"&&(c(e.url)||t=="dev.poteto.ru"))return{type:r.proxy_type,host:r.proxy_host,port:Number(r.proxy_port)}}return{type:"direct"}}function g(e){return r?{authCredentials:{username:r.proxy_user,password:r.proxy_pass}}:{}}browser.webRequest.onAuthRequired.addListener(g,{urls:["<all_urls>"]},["blocking"]);browser.proxy.onRequest.addListener(w,{urls:["<all_urls>"]});browser.contextMenus.onClicked.addListener((e,s)=>{if(e.menuItemId==="add-site"){const t=new URL(s.url);a.push(t.hostname),browser.storage.local.set({bypass:JSON.stringify(a)})}});
