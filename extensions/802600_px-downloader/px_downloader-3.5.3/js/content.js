!function(t){var e={};function i(n){if(e[n])return e[n].exports;var s=e[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(n,s,function(e){return t[e]}.bind(null,s));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=7)}([function(t,e){t.exports=browser},function(t){t.exports=JSON.parse('{"singleFilename":"PxDownloader/${userName}(${userId})/${title}(${id})","multiFilename":"PxDownloader/${userName}(${userId})/${title}(${id})/${page2}","novelFilename":"PxDownloader/${userName}(${userId})/${title}(${id})","conflictAction":"uniquify","forceFilename":0,"singleSize":"original","multiSize":"original","ugoiraSize":"original","convertMode":"none","convertQuality":0.9,"ugoiraMode":"gif","ugoiraQuality":0.9}')},function(t,e,i){"use strict";i.d(e,"a",(function(){return r}));var n=i(0),s=i.n(n);class r{constructor(){s.a.storage.hasOwnProperty("sync")?this.storage=s.a.storage.sync:this.storage=s.a.storage.local,navigator.userAgent.includes("Edge")?this.browser="edge":navigator.userAgent.includes("Chrome")?this.browser="chrome":navigator.userAgent.includes("Firefox")?this.browser="firefox":this.browser="unknown",this.listeners=new Map}listen(){s.a.runtime.onMessage.addListener((t,e,i)=>(this.listeners.has(t.type)&&this.listeners.get(t.type)(t.data).then(t=>{i({error:null,data:t})}).catch(t=>{i({error:t.message,data:null})}),!0))}addListener(t,e){return!this.listeners.has(t)&&(this.listeners.set(t,e),!0)}removeListener(t){return!!this.listeners.has(t)&&(this.listeners.delete(t),!0)}message(t){return new Promise((e,i)=>{s.a.runtime.sendMessage({type:t.type,data:t.data},t=>{t.error&&i(new Error(t.error)),e(t.data)})})}getOptions(t){return new Promise(e=>{this.storage.get(t,t=>{e(t)})})}setOptions(t){return new Promise(e=>{this.storage.set(t,()=>{e()})})}initOptions(t){return this.getOptions(Object.keys(t)).then(e=>this.setOptions(Object.assign(t,e)))}}},function(t,e){t.exports=JSZip},function(t,e,i){"use strict";var n,s="object"==typeof Reflect?Reflect:null,r=s&&"function"==typeof s.apply?s.apply:function(t,e,i){return Function.prototype.apply.call(t,e,i)};n=s&&"function"==typeof s.ownKeys?s.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var a=Number.isNaN||function(t){return t!=t};function o(){o.init.call(this)}t.exports=o,o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var l=10;function h(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function c(t){return void 0===t._maxListeners?o.defaultMaxListeners:t._maxListeners}function u(t,e,i,n){var s,r,a,o;if(h(i),void 0===(r=t._events)?(r=t._events=Object.create(null),t._eventsCount=0):(void 0!==r.newListener&&(t.emit("newListener",e,i.listener?i.listener:i),r=t._events),a=r[e]),void 0===a)a=r[e]=i,++t._eventsCount;else if("function"==typeof a?a=r[e]=n?[i,a]:[a,i]:n?a.unshift(i):a.push(i),(s=c(t))>0&&a.length>s&&!a.warned){a.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=t,l.type=e,l.count=a.length,o=l,console&&console.warn&&console.warn(o)}return t}function d(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(t,e,i){var n={fired:!1,wrapFn:void 0,target:t,type:e,listener:i},s=d.bind(n);return s.listener=i,n.wrapFn=s,s}function p(t,e,i){var n=t._events;if(void 0===n)return[];var s=n[e];return void 0===s?[]:"function"==typeof s?i?[s.listener||s]:[s]:i?function(t){for(var e=new Array(t.length),i=0;i<e.length;++i)e[i]=t[i].listener||t[i];return e}(s):w(s,s.length)}function g(t){var e=this._events;if(void 0!==e){var i=e[t];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function w(t,e){for(var i=new Array(e),n=0;n<e;++n)i[n]=t[n];return i}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(t){if("number"!=typeof t||t<0||a(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");l=t}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||a(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},o.prototype.getMaxListeners=function(){return c(this)},o.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e.push(arguments[i]);var n="error"===t,s=this._events;if(void 0!==s)n=n&&void 0===s.error;else if(!n)return!1;if(n){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var l=s[t];if(void 0===l)return!1;if("function"==typeof l)r(l,this,e);else{var h=l.length,c=w(l,h);for(i=0;i<h;++i)r(c[i],this,e)}return!0},o.prototype.addListener=function(t,e){return u(this,t,e,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(t,e){return u(this,t,e,!0)},o.prototype.once=function(t,e){return h(e),this.on(t,f(this,t,e)),this},o.prototype.prependOnceListener=function(t,e){return h(e),this.prependListener(t,f(this,t,e)),this},o.prototype.removeListener=function(t,e){var i,n,s,r,a;if(h(e),void 0===(n=this._events))return this;if(void 0===(i=n[t]))return this;if(i===e||i.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,i.listener||e));else if("function"!=typeof i){for(s=-1,r=i.length-1;r>=0;r--)if(i[r]===e||i[r].listener===e){a=i[r].listener,s=r;break}if(s<0)return this;0===s?i.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(i,s),1===i.length&&(n[t]=i[0]),void 0!==n.removeListener&&this.emit("removeListener",t,a||e)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(t){var e,i,n;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[t]),this;if(0===arguments.length){var s,r=Object.keys(i);for(n=0;n<r.length;++n)"removeListener"!==(s=r[n])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=i[t]))this.removeListener(t,e);else if(void 0!==e)for(n=e.length-1;n>=0;n--)this.removeListener(t,e[n]);return this},o.prototype.listeners=function(t){return p(this,t,!0)},o.prototype.rawListeners=function(t){return p(this,t,!1)},o.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):g.call(t,e)},o.prototype.listenerCount=g,o.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},function(t,e){t.exports=GIF},,function(t,e,i){t.exports=i(10)},,,function(t,e,i){"use strict";i.r(e);var n=i(4),s=i(0),r=i.n(s),a=i(3),o=i.n(a),l=i(5),h=i.n(l),c=i(2);const u=new Int32Array(256);for(let t=0;t<u.length;t++){let e=t;for(let t=0;t<8;t++)e=1&e?3988292384^e>>>1:e>>>1;u[t]=e}class d{static calc(t){let e=-1;for(let i=0,n=t.length;i<n;i++)e=u[255&(e^t[i])]^e>>>8;return-1^e}}class f{constructor(t,e,i){this.buffer=t,this.position=e||0,this.isLittleEndian=i||!1}readBits(t){if(this.position+t>this.buffer.length<<3)return this.position+=t,0;let e=0;if(this.isLittleEndian)for(let i=0;i<t;i++){const t=this.position>>3,n=7&this.position;e|=(this.buffer[t]>>n&1)<<i,this.position++}else for(let i=t-1;i>=0;i--){const t=this.position>>3,i=7&this.position^7;e<<=1,e|=this.buffer[t]>>i&1,this.position++}return e}readBytes(t){if(this.position+(t<<3)>this.buffer.length<<3)return this.position+=t<<3,new Uint8Array(0);const e=this.position>>3;return this.position+=t<<3,this.buffer.subarray(e,e+t)}next(t){this.position+=t}previous(t){this.position-=t}readString(t){if(this.position+(t<<3)>this.buffer.length<<3)return this.position+=t<<3,"";const e=String.fromCharCode(...this.buffer.subarray(this.position>>3,(this.position>>3)+t));return this.position+=t<<3,e}}class p{constructor(t,e,i){this.buffer=t,this.position=e||0,this.isLittleEndian=i||!1}writeBits(t,e){if(this.position+t>this.buffer.length<<3)this.position+=t;else if(this.isLittleEndian)for(let i=0;i<t;i++){const t=this.position>>3,n=7&this.position;this.buffer[t]=this.buffer[t]&~(1<<n)|(e>>i&1)<<n,this.position++}else for(let i=t-1;i>=0;i--){const t=this.position>>3,n=7&this.position^7;this.buffer[t]=this.buffer[t]&~(1<<n)|(e>>i&1)<<n,this.position++}}writeBytes(t,e){if(this.position+(t<<3)>this.buffer.length<<3)return void(this.position+=t<<3);const i=this.position>>3;this.position+=t<<3,this.buffer.set(e.subarray(0,t),i)}next(t){this.position+=t}previous(t){this.position-=t}writeString(t,e){if(this.position+(t<<3)>this.buffer.length<<3)this.position+=t<<3;else for(;t>0;){const i=this.position>>3;this.buffer[i]=e.charCodeAt(e.length-t),this.position+=8,t--}}}function g(t){return new Promise((e,i)=>{const n=new XMLHttpRequest;n.addEventListener("load",()=>{e(n.response)}),n.addEventListener("error",t=>{i(t)}),n.open("GET",t.url),n.responseType=t.responseType,n.send()})}class w{constructor(){this.canvas=document.createElement("canvas"),this.frames=[]}getSignature(){return new Uint8Array([137,80,78,71,13,10,26,10])}readChunks(t){const e=[],i=new f(t,0,!1);for(;i.position<t.length<<3;){const n={},s=i.readBits(32),r=i.position>>3;n.type=i.readString(4),n.data=i.readBytes(s);const a=i.position>>3;if(i.readBits(32)!==d.calc(t.subarray(r,a)))throw new Error("Incorrect CRC32");if(e.push(n),"IEND"===n.type)break}return e}writeChunks(t){const e=new Uint8Array(t.reduce((t,e)=>t+4+4+e.data.length+4,0)),i=new p(e,0,!1);for(const n of t){i.writeBits(32,n.data.length);const t=i.position>>3;i.writeString(4,n.type),i.writeBytes(n.data.length,n.data);const s=i.position>>3;i.writeBits(32,d.calc(e.subarray(t,s)))}return e}createActlChunk(t){const e=new Uint8Array(8),i=new p(e,0,!1);return i.writeBits(32,t.numFrames),i.writeBits(32,t.numPlays),{type:"acTL",data:e}}createFctlChunk(t){const e=new Uint8Array(26),i=new p(e,0,!1);return i.writeBits(32,t.sequenceNumber),i.writeBits(32,t.width),i.writeBits(32,t.height),i.writeBits(32,t.xOffset||0),i.writeBits(32,t.yoffset||0),i.writeBits(16,t.delayNum),i.writeBits(16,t.delayDen),i.writeBits(8,t.disposeOp||0),i.writeBits(8,t.blendOp||0),{type:"fcTL",data:e}}createFdatChunk(t){const e=new Uint8Array(4+t.frameData.length),i=new p(e,0,!1);return i.writeBits(32,t.sequenceNumber),i.writeBytes(t.frameData.length,t.frameData),{type:"fdAT",data:e}}add(t,{duration:e=1e3}={}){let i;if(t instanceof Blob)i=t;else{if(!(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement))throw new Error("Unsupported image");{let e;if(t instanceof HTMLImageElement){e=this.canvas;const i=e.getContext("2d");e.width=t.width,e.height=t.height,i.clearRect(0,0,t.width,t.height),i.drawImage(t,0,0)}else e=t;const n=atob(e.toDataURL("image/png").split(",")[1]),s=new Uint8Array(n.split("").map(t=>t.charCodeAt(0)));i=new Blob([s],{type:"image/png"})}}this.frames.push({blob:i,buffer:null,duration:e})}async render({loop:t=0}={}){const e=[];let i=0;for(const n of this.frames){const s=0===this.frames.indexOf(n),r=URL.createObjectURL(n.blob),a=await g({url:r,responseType:"arraybuffer"});URL.revokeObjectURL(r);const o=new Uint8Array(a),l=this.readChunks(o.subarray(8));for(const r of l)switch(r.type){case"IHDR":{const s=new f(r.data,0,!1),a=s.readBits(32),o=s.readBits(32);0===i&&(e.push({type:"IHDR",data:r.data}),e.push(this.createActlChunk({numFrames:this.frames.length,numPlays:t}))),e.push(this.createFctlChunk({sequenceNumber:i++,width:a,height:o,delayNum:n.duration,delayDen:1e3}));break}case"IDAT":s?e.push({type:"IDAT",data:r.data}):e.push(this.createFdatChunk({sequenceNumber:i++,frameData:r.data}))}}return e.push({type:"IEND",data:new Uint8Array(0)}),new Blob([this.getSignature(),this.writeChunks(e)],{type:"image/png"})}}class m{constructor(t,e,i){this.buffer=t,this.position=e||0,this.isLittleEndian=i||!1}readBits(t){if(this.position+t>this.buffer.length<<3)return this.position+=t,0;let e=0;if(this.isLittleEndian)for(let i=0;i<t;i++){const t=this.position>>3,n=7&this.position;e|=(this.buffer[t]>>n&1)<<i,this.position++}else for(let i=t-1;i>=0;i--){const t=this.position>>3,i=7&this.position^7;e<<=1,e|=this.buffer[t]>>i&1,this.position++}return e}readBytes(t){if(this.position+(t<<3)>this.buffer.length<<3)return this.position+=t<<3,new Uint8Array(0);const e=this.position>>3;return this.position+=t<<3,this.buffer.subarray(e,e+t)}next(t){this.position+=t}previous(t){this.position-=t}readString(t){if(this.position+(t<<3)>this.buffer.length<<3)return this.position+=t<<3,"";const e=String.fromCharCode(...this.buffer.subarray(this.position>>3,(this.position>>3)+t));return this.position+=t<<3,e}}class y{constructor(t,e,i){this.buffer=t,this.position=e||0,this.isLittleEndian=i||!1}writeBits(t,e){if(this.position+t>this.buffer.length<<3)this.position+=t;else if(this.isLittleEndian)for(let i=0;i<t;i++){const t=this.position>>3,n=7&this.position;this.buffer[t]=this.buffer[t]&~(1<<n)|(e>>i&1)<<n,this.position++}else for(let i=t-1;i>=0;i--){const t=this.position>>3,n=7&this.position^7;this.buffer[t]=this.buffer[t]&~(1<<n)|(e>>i&1)<<n,this.position++}}writeBytes(t,e){if(this.position+(t<<3)>this.buffer.length<<3)return void(this.position+=t<<3);const i=this.position>>3;this.position+=t<<3,this.buffer.set(e.subarray(0,t),i)}next(t){this.position+=t}previous(t){this.position-=t}writeString(t,e){if(this.position+(t<<3)>this.buffer.length<<3)this.position+=t<<3;else for(;t>0;){const i=this.position>>3;this.buffer[i]=e.charCodeAt(e.length-t),this.position+=8,t--}}}function b(t){return new Promise((e,i)=>{const n=new XMLHttpRequest;n.addEventListener("load",()=>{e(n.response)}),n.addEventListener("error",t=>{i(t)}),n.open("GET",t),n.responseType="arraybuffer",n.send()})}class v{constructor(){this.canvas=document.createElement("canvas"),this.frames=[]}readChunks(t){const e=[],i=new m(t,0,!0);for(;i.position<t.length<<3;){const t={};t.id=i.readString(4);const n=i.readBits(32);t.data=i.readBytes(n),n%2==1&&i.next(8),e.push(t)}return e}writeChunks(t){const e=new Uint8Array(t.reduce((t,e)=>t+4+4+e.data.length+e.data.length%2,0)),i=new y(e,0,!0);for(const e of t)i.writeString(4,e.id),i.writeBits(32,e.data.length),i.writeBytes(e.data.length,e.data),e.data.length%2==1&&i.next(8);return e}createRiffChunk(t){const e=new Uint8Array(4+t.buffer.length),i=new y(e,0,!0);return i.writeString(4,t.type),i.writeBytes(t.buffer.length,t.buffer),{id:"RIFF",data:e}}createVp8xChunk(t){const e=new Uint8Array(10),i=new y(e,0,!0);return i.next(1),i.writeBits(1,t.animation?1:0),i.writeBits(1,t.xmpMetadata?1:0),i.writeBits(1,t.exifMetadata?1:0),i.writeBits(1,t.alpha?1:0),i.writeBits(1,t.iccProfile?1:0),i.next(2),i.next(24),i.writeBits(24,t.canvasWidthMinusOne),i.writeBits(24,t.canvasHeightMinusOne),{id:"VP8X",data:e}}createAnimChunk(t){const e=new Uint8Array(6),i=new y(e,0,!0);return i.writeBits(32,t.backgroundColor),i.writeBits(16,t.loopCount),{id:"ANIM",data:e}}createAnmfChunk(t){const e=new Uint8Array(16+t.frameData.length),i=new y(e,0,!0);return i.writeBits(24,t.frameX||0),i.writeBits(24,t.frameY||0),i.writeBits(24,t.frameWidthMinusOne),i.writeBits(24,t.frameHeightMinusOne),i.writeBits(24,t.frameDuration),i.writeBits(1,t.disposalMethod?1:0),i.writeBits(1,t.blendingMethod?1:0),i.next(6),i.writeBytes(t.frameData.length,t.frameData),{id:"ANMF",data:e}}add(t,{duration:e=1e3}={}){let i;if(t instanceof Blob)i=t;else{if(!(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement))throw new Error("Unsupported image");{let e;if(t instanceof HTMLImageElement){e=this.canvas;const i=e.getContext("2d");e.width=t.width,e.height=t.height,i.clearRect(0,0,t.width,t.height),i.drawImage(t,0,0)}else e=t;const n=atob(e.toDataURL("image/webp").split(",")[1]),s=new Uint8Array(n.split("").map(t=>t.charCodeAt(0)));i=new Blob([s],{type:"image/webp"})}}this.frames.push({blob:i,buffer:null,duration:e})}async render({loop:t=0}={}){const e=[];for(const i of this.frames){const n=0===this.frames.indexOf(i),s=URL.createObjectURL(i.blob),r=await b(s);URL.revokeObjectURL(s);const a=new Uint8Array(r),o=this.readChunks(a);if(1!==o.length||"RIFF"!==o[0].id)throw new Error("Can't find RIFF chunk");const l=this.readChunks(o[0].data.subarray(4)),h=[];for(const s of l)switch(s.id){case"ALPH":h.push(s);break;case"VP8 ":case"VP8L":{h.push(s);const r=new m(s.data,0,!0);let a,o;switch(s.id){case"VP8 ":r.next(48),a=(16383&r.readBits(16))-1,o=(16383&r.readBits(16))-1;break;case"VP8L":r.next(8),a=r.readBits(14),o=r.readBits(14)}n&&(e.push(this.createVp8xChunk({animation:!0,canvasWidthMinusOne:a,canvasHeightMinusOne:o})),e.push(this.createAnimChunk({backgroundColor:0,loopCount:t}))),e.push(this.createAnmfChunk({frameWidthMinusOne:a,frameHeightMinusOne:o,frameDuration:i.duration,frameData:this.writeChunks(h)}));break}}}return new Blob([this.writeChunks([this.createRiffChunk({type:"WEBP",buffer:this.writeChunks(e)})])],{type:"image/webp"})}}var L=i(1);function x(t){return new Promise(e=>{setTimeout(()=>{e()},t)})}function M(t){return new Promise((e,i)=>{const n=document.createElement("img");n.src=t,n.addEventListener("load",()=>{e(n)}),n.addEventListener("error",t=>{i(t)})})}class S extends n.EventEmitter{constructor({util:t,url:e}={}){super(),this.util=t||new c.a,this.url=e||new URL(location.href),this.button=null}get page(){if(this.hasOwnProperty("_page"))return this._page;let t;return t=/\/artworks\/\d+/.test(this.url.pathname)?"illust":"/novel/show.php"===this.url.pathname&&null!==this.url.searchParams.get("id")?"novel":"/member_illust.php"===this.url.pathname?"imageList":/\/user\/\d+\/series\/\d+/.test(this.url.pathname)?"imageSeries":"/novel/member.php"===this.url.pathname?"novelList":/\/novel\/series\/\d+/.test(this.url.pathname)?"novelSeries":"",this._page=t,t}get id(){if(this.hasOwnProperty("_id"))return this._id;let t;switch(this.page){case"illust":t=this.url.pathname.match(/\/artworks\/(\d+)/)[1];break;case"novel":t=this.url.searchParams.get("id");break;case"novelSeries":t=this.url.pathname.match(/\/novel\/series\/(\d+)/)[1];break;default:t=""}return this._id=t,t}check(){return""!==this.page}getMacro(t){const e={};if(t.hasOwnProperty("id")?e.id=t.id:e.id="",t.hasOwnProperty("title")?e.title=t.title:e.title="",t.hasOwnProperty("userId")?e.userId=t.userId:e.userId="",t.hasOwnProperty("userName")?e.userName=t.userName:e.userName="",t.hasOwnProperty("seriesNavData")&&null!==t.seriesNavData?(e.seriesId=t.seriesNavData.seriesId,e.seriesTitle=t.seriesNavData.title):(e.seriesId="",e.seriesTitle=""),t.hasOwnProperty("createDate")){const i=new Date(t.createDate);e.YYYY=i.getFullYear().toString(),e.YY=i.getFullYear().toString().slice(-2),e.M=(i.getMonth()+1).toString(),e.MM=(i.getMonth()+1).toString().padStart(2,"0"),e.D=i.getDate().toString(),e.DD=i.getDate().toString().padStart(2,"0"),e.weekday=r.a.i18n.getMessage("weekdays").split(",")[i.getDay()],e.h=i.getHours().toString(),e.hh=i.getHours().toString().padStart(2,"0"),e.m=i.getMinutes().toString(),e.mm=i.getMinutes().toString().padStart(2,"0")}else e.YYYY="",e.YY="",e.M="",e.MM="",e.D="",e.DD="",e.weekday="",e.h="",e.hh="",e.m="",e.mm="";return e}replaceMacro(t,e,i){if(void 0!==i){let e={};e.index=i.toString(),e.index2=i.toString().padStart(2,"0"),e.index3=i.toString().padStart(3,"0"),e.index4=i.toString().padStart(4,"0"),e.page=(i+1).toString(),e.page2=(i+1).toString().padStart(2,"0"),e.page3=(i+1).toString().padStart(3,"0"),e.page4=(i+1).toString().padStart(4,"0"),t=Object.assign({},t,e)}for(const[i,n]of Object.entries(t))e=e.split("${"+i+"}").join(S.escape(n,!0));return e}getDownloaded(t){const e=localStorage.getItem("pxDownloaded");return null!==e&&!!JSON.parse(e).includes(t)}setDownloaded(t){let e=localStorage.getItem("pxDownloaded"),i=null===e?[]:JSON.parse(e);i.includes(t)&&i.splice(i.indexOf(t),1),i.push(t),i.length>1e4&&(i=i.slice(-1e4)),e=JSON.stringify(i),localStorage.setItem("pxDownloaded",e)}getFilename(t,e,i,n){let s;return s=void 0===n?`${this.replaceMacro(t,e)}.${i}`:`${this.replaceMacro(t,e,n)}.${i}`,s=s.replace(/\/+/g,"/").replace(/(^|\/)\./g,"$1．").replace(/\.($|\/)/g,"．$1").replace(/^\//,""),s}getExt(t){let e="";switch(t.type){case"image/gif":e="gif";break;case"image/jpeg":e="jpg";break;case"image/png":e="png";break;case"image/webp":e="webp";break;case"text/plain":e="txt";break;case"application/zip":e="zip"}return e}async downloadPixiv(){const t=await this.util.getOptions(Object.keys(L));switch(this.page){case"illust":await this.downloadIllust(t);break;case"novel":await this.downloadNovel(t);break;case"imageList":case"imageSeries":await this.downloadImageList();break;case"novelList":await this.downloadNovelList();break;case"novelSeries":await this.downloadNovelSeries()}this.setDownloaded(`${this.page}_${this.id}`)}async downloadIllust(t){this.emit("message",r.a.i18n.getMessage("phFetch"));const e=await fetch(`https://www.pixiv.net/ajax/illust/${this.id}`,{credentials:"include"}),i=(await e.json()).body;2===i.illustType?await this.downloadUgoira(t,i):1!==i.pageCount?await this.downloadMultiple(t,i):await this.downloadSingle(t,i)}async downloadSingle(t,e){const i=e.urls[t.singleSize],n=await fetch(i,{referrer:this.url.href});let s=await n.blob();"none"!==t.convertMode&&(this.emit("message",r.a.i18n.getMessage("phConvert")),s=await this.convert({blob:s,type:`image/${t.convertMode}`,quality:t.convertQuality})),this.emit("message",r.a.i18n.getMessage("phDownload"));const a=this.getMacro(e);await this.download({blob:s,filename:this.getFilename(a,t.singleFilename,this.getExt(s)),conflictAction:t.conflictAction})}async downloadMultiple(t,e){const i=await fetch(`https://www.pixiv.net/ajax/illust/${this.id}/pages`,{credentials:"include"}),n=(await i.json()).body.map(e=>e.urls[t.multiSize]);let s=[];for(let t=0;t<n.length;t++){const e=n[t],i=await fetch(e,{referrer:this.url.href}),a=await i.blob();this.emit("message",`${r.a.i18n.getMessage("phFetch")}: ${Math.floor((t+1)/n.length*100)}%`),s.push(a)}if("none"!==t.convertMode){this.emit("message",r.a.i18n.getMessage("phConvert"));const e=[];for(let i=0;i<s.length;i++){const n=s[i],a=await this.convert({blob:n,type:`image/${t.convertMode}`,quality:t.convertQuality});this.emit("message",`${r.a.i18n.getMessage("phConvert")}: ${Math.floor((i+1)/s.length*100)}%`),e.push(a)}s=e}this.emit("message",r.a.i18n.getMessage("phDownload"));const a=this.getMacro(e);for(let e=0;e<s.length;e++){const i=s[e];await this.download({blob:i,filename:this.getFilename(a,t.multiFilename,this.getExt(i),e),conflictAction:t.conflictAction}),this.emit("message",`${r.a.i18n.getMessage("phDownload")}: ${Math.floor((e+1)/s.length*100)}%`)}}async downloadUgoira(t,e){const i=await fetch(`https://www.pixiv.net/ajax/illust/${this.id}/ugoira_meta`,{credentials:"include"}),n=(await i.json()).body,s=n[{regular:"src",original:"originalSrc"}[t.ugoiraSize]],a=await fetch(s,{referrer:this.url.href}),o=await a.arrayBuffer();let l;switch(t.ugoiraMode){case"zip":l=await this.convertUgoiraToZip(t,e,n,o);break;case"gif":l=await this.convertUgoiraToGif(t,e,n,o);break;case"apng":l=await this.convertUgoiraToApng(t,e,n,o);break;case"webp":l=await this.convertUgoiraToWebp(t,e,n,o)}this.emit("message",r.a.i18n.getMessage("phDownload"));const h=this.getMacro(e);await this.download({blob:l,filename:this.getFilename(h,t.singleFilename,this.getExt(l)),conflictAction:t.conflictAction})}async convertUgoiraToZip(t,e,i,n){this.emit("message",r.a.i18n.getMessage("phLoad"));const s=await o.a.loadAsync(n);return s.file("animation.json",JSON.stringify({ugokuIllustData:i})),await s.generateAsync({type:"blob"})}async convertUgoiraToGif(t,e,i,n){this.emit("message",r.a.i18n.getMessage("phLoad"));const s=await o.a.loadAsync(n),a=[];for(let t=0;t<i.frames.length;t++){const e=i.frames[t],n=await s.file(e.file).async("arraybuffer"),o=new Blob([n],{type:i.mime_type}),l=URL.createObjectURL(o),h=await M(l);URL.revokeObjectURL(l),this.emit("message",`${r.a.i18n.getMessage("phLoad")}: ${Math.floor((t+1)/i.frames.length*100)}%`),a.push(h)}this.emit("message",r.a.i18n.getMessage("phProcess"));const l=await this.resource("lib/gif.worker.js"),c=await l.blob(),u=new h.a({quality:1,workers:4,workerScript:URL.createObjectURL(c)});for(let t=0;t<a.length;t++){const e=a[t];u.addFrame(e,{delay:i.frames[t].delay})}return await new Promise(t=>{u.on("progress",t=>{this.emit("message",`${r.a.i18n.getMessage("phProcess")}: ${Math.floor(100*t)}%`)}),u.on("finished",e=>{t(e)}),u.render()})}async convertUgoiraToApng(t,e,i,n){this.emit("message",r.a.i18n.getMessage("phConvert"));const s=await o.a.loadAsync(n),a=[];for(let e=0;e<i.frames.length;e++){const n=i.frames[e],o=await s.file(n.file).async("arraybuffer"),l=new Blob([o],{type:i.mime_type}),h=await this.convert({blob:l,type:"image/png",quality:t.ugoiraQuality});this.emit("message",`${r.a.i18n.getMessage("phConvert")}: ${Math.floor((e+1)/i.frames.length*100)}%`),a.push(h)}this.emit("message",r.a.i18n.getMessage("phProcess"));const l=new w;for(let t=0;t<a.length;t++){const e=a[t];l.add(e,{duration:i.frames[t].delay})}return await l.render()}async convertUgoiraToWebp(t,e,i,n){this.emit("message",r.a.i18n.getMessage("phConvert"));const s=await o.a.loadAsync(n),a=[];for(let e=0;e<i.frames.length;e++){const n=i.frames[e],o=await s.file(n.file).async("arraybuffer"),l=new Blob([o],{type:i.mime_type}),h=await this.convert({blob:l,type:"image/webp",quality:t.ugoiraQuality});this.emit("message",`${r.a.i18n.getMessage("phConvert")}: ${Math.floor((e+1)/i.frames.length*100)}%`),a.push(h)}this.emit("message",r.a.i18n.getMessage("phProcess"));const l=new v;for(let t=0;t<a.length;t++){const e=a[t];l.add(e,{duration:i.frames[t].delay})}return await l.render()}async downloadNovel(t){this.emit("message",r.a.i18n.getMessage("phFetch"));const e=await fetch(`https://www.pixiv.net/ajax/novel/${this.id}`,{credentials:"include"}),i=(await e.json()).body,n=new Blob([i.content.replace(/\r\n|\r|\n/g,"\r\n")],{type:"text/plain"});this.emit("message",r.a.i18n.getMessage("phDownload"));const s=this.getMacro(i);await this.download({blob:n,filename:this.getFilename(s,t.novelFilename,this.getExt(n)),conflictAction:t.conflictAction})}async downloadNovelSeries(){const t=await fetch(`https://www.pixiv.net/ajax/novel/series_content/${this.id}`,{credentials:"include"}),e=(await t.json()).body.seriesContents.map(t=>t.id);for(let t=0;t<e.length;t++){const i=e[t],n=new S({util:this.util,url:new URL(`https://www.pixiv.net/novel/show.php?id=${i}`)});n.on("message",i=>{this.emit("message",`[${t+1} / ${e.length}]: ${i}`)});try{await n.downloadPixiv()}catch(i){throw new Error(`[${t+1} / ${e.length}]: ${i.message}`)}await x(250)}}addButton(){switch(this.page){case"illust":case"novel":this.addButtonWork()}}addButtonWork(){const t=null===document.querySelector("div#root"),e=document.createElement("button");e.classList.add("px-button"),t&&(e.classList.add("mobile"),e.classList.add("c-gray-90"));const i=async()=>{e.removeEventListener("click",i),e.disabled=!0;try{await this.downloadPixiv(),s.textContent=r.a.i18n.getMessage("phDone"),e.classList.add("downloaded")}catch(t){s.textContent=r.a.i18n.getMessage("phRetry"),e.classList.remove("downloaded"),alert(t.message),console.error(t)}e.addEventListener("click",i),e.disabled=!1};e.addEventListener("click",i);const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttributeNS(null,"viewBox","0 0 32 32"),n.setAttributeNS(null,"width","32"),n.setAttributeNS(null,"height","32"),n.insertAdjacentHTML("beforeend",'\n            <mask id="mask">\n                <rect x="0" y="0" width="32" height="32" fill="white" />\n                <path d="M21.358 6.7v6.39H27L16 25.7 5 13.09h5.642V6.7z" />\n            </mask>\n            <path d="M10.64 5.1c-1.104 0-2 .716-2 1.6v4.8H5c-.745 0-1.428.332-1.773.86s-.294 1.167.133 1.656l11 12.61c.374.43.987.685 1.64.685s1.266-.256 1.64-.685l11-12.61c.426-.49.477-1.127.133-1.656S27.745 11.5 27 11.5h-3.644V6.7c-.001-.883-.895-1.6-2-1.6z" mask="url(#mask)" />\n        '),e.appendChild(n);const s=document.createElement("span");e.appendChild(s),this.getDownloaded(`${this.page}_${this.id}`)?(s.textContent=r.a.i18n.getMessage("phDone"),e.classList.add("downloaded")):s.textContent="Px Downloader";{const i=document.querySelector("main section div:first-child section, .work-interactions");null!==i&&(t?i.insertBefore(e,i.firstChild):i.appendChild(e))}const a=t=>{s.textContent=t};this.on("message",a);const o=new MutationObserver(i=>{if(!document.contains(e))for(const n of i)for(const i of n.addedNodes){if(i.nodeType!==Node.ELEMENT_NODE)continue;const n=i.querySelector("main section div:first-child section, .work-interactions");null!==n&&(t?n.insertBefore(e,n.firstChild):n.appendChild(e))}});o.observe(document,{childList:!0,subtree:!0}),this.button={element:e,listener:a,observer:o}}removeButton(){switch(this.page){case"illust":case"novel":this.removeButtonWork()}}removeButtonWork(){null!==this.button&&(this.button.observer.disconnect(),this.off("message",this.button.listener),null!==this.button.element.parentNode&&this.button.element.parentNode.removeChild(this.button.element),this.button=null)}convert(t){const e=URL.createObjectURL(t.blob);return new Promise((i,n)=>{const s=document.createElement("canvas"),r=s.getContext("2d"),a=document.createElement("img");a.setAttribute("src",e),a.addEventListener("load",()=>{URL.revokeObjectURL(e),s.width=a.width,s.height=a.height,r.clearRect(0,0,a.width,a.height),r.drawImage(a,0,0),s.toBlob(t=>i(t),t.type,t.quality)}),a.addEventListener("error",t=>{URL.revokeObjectURL(e),n(t)})})}async fetch(t,e){let i;if("chrome"===this.util.browser){const n=await this.util.message({type:"fetch",data:{resource:t,init:e}});i=await fetch(n)}else if("firefox"===this.util.browser){const n=await this.util.message({type:"fetch",data:{resource:t,init:e}});i=new Proxy({},{get(t,e){switch(e){case"blob":return async()=>n;case"arrayBuffer":case"formData":case"json":case"text":return async()=>{const t=URL.createObjectURL(n),i=await fetch(t),s=await i[e]();return URL.revokeObjectURL(t),s};default:return t[e]}}})}else{const n=await this.util.message({type:"fetch",data:{resource:t,init:e}});i=await fetch(n)}return i}async resource(t){let e;if("chrome"===this.util.browser){const i=await this.util.message({type:"resource",data:{path:t}});e=await fetch(i)}else if("firefox"===this.util.browser){const i=await this.util.message({type:"resource",data:{path:t}});e=new Proxy({},{get(t,e){switch(e){case"blob":return async()=>i;case"arrayBuffer":case"formData":case"json":case"text":return async()=>{const t=URL.createObjectURL(i),n=await fetch(t),s=await n[e]();return URL.revokeObjectURL(t),s};default:return t[e]}}})}else{const i=await this.util.message({type:"resource",data:{path:t}});e=await fetch(i)}return e}async download(t){let e;if("chrome"===this.util.browser)e=await this.util.message({type:"download",data:{blobUrl:URL.createObjectURL(t.blob),filename:t.filename,conflictAction:t.conflictAction}});else if("firefox"===this.util.browser)e=await this.util.message({type:"download",data:{blob:t.blob,filename:t.filename,conflictAction:t.conflictAction}});else{const i=await new Promise((e,i)=>{const n=new FileReader;n.addEventListener("load",()=>{e(n.result)}),n.addEventListener("error",t=>{i(t)}),n.readAsDataURL(t.blob)});e=await this.util.message({type:"download",data:{dataUrl:i,filename:t.filename,conflictAction:t.conflictAction}})}return e}static toHalf(t){return t.replace(/[\uff01-\uff5e]/g,(function(t){return String.fromCharCode(t.charCodeAt(0)-65248)})).split("　").join(" ")}static toFull(t){return t.replace(/[!-~]/g,(function(t){return String.fromCharCode(t.charCodeAt(0)+65248)})).split(" ").join("　")}static escape(t,e){return t.replace(e?/([/?*:|"<>~\\])/g:/([/?*:|"<>~])/g,S.toFull)}}document.addEventListener("DOMContentLoaded",()=>{let t=null;function e(){try{null!==t&&t.removeButton(),t=new S,t.check()&&t.addButton()}catch(t){console.error(t)}}window.addEventListener("message",async t=>{const i=t.data;"object"==typeof i&&("pxPushState"!==i.type&&"pxPopState"!==i.type||e())});const i=document.createElement("script");i.textContent='\n        "use strict";\n\n        const nativePushState = window.history.pushState;\n\n        window.history.pushState = (...args) => {\n            nativePushState.apply(window.history, args);\n\n            window.postMessage({\n                type: "pxPushState",\n                data: null\n            }, "*");\n        };\n\n        window.addEventListener("popstate", () => {\n            window.postMessage({\n                type: "pxPopState",\n                data: null\n            }, "*");\n        });\n    ',document.body.appendChild(i),e()})}]);
//# sourceMappingURL=content.js.map