{"version":3,"file":"projectPopdownFilter.worker.js","sources":["../../../../src/workers/projectPopdownFilter.worker.ts"],"sourcesContent":["/* eslint-disable no-console */\n\nimport {\n  type ProjectPopdownFilterWorkerProps,\n  type ProjectPopdownFilterWorkerResponse,\n  type VirtualizedListItem,\n  type WorkerData,\n} from '@src/workers/types'\n\nimport { type Project, type TaskV9 } from '@toggl/track-types'\n\nconst sortComparator = (dataMap?: any) => (a: string, b: string) => {\n  const nameA = dataMap?.[a]?.name\n  const nameB = dataMap?.[b]?.name\n\n  if (nameA === undefined && nameB === undefined) {\n    return 0\n  } else if (nameA === undefined) {\n    return -1\n  } else if (nameB === undefined) {\n    return 1\n  } else {\n    return nameA.localeCompare(nameB)\n  }\n}\n\nfunction handleEvent(\n  e: WorkerData<ProjectPopdownFilterWorkerProps>\n): ProjectPopdownFilterWorkerResponse {\n  const { projects, clients, workspaces, tasks, filter, expandedProjects } =\n    e.data\n\n  const projectHasTaskWithFilter = (projectId: number) => {\n    return (\n      (tasksByProject &&\n        tasksByProject[projectId]?.find((task) =>\n          task.name.toLowerCase().includes(filter.toLowerCase())\n        )) ??\n      undefined\n    )\n  }\n\n  const getVisibleTasks = (project: Project) => {\n    return filter.length > 0 &&\n      !project.name.toLowerCase().includes(filter.toLowerCase())\n      ? tasksByProject?.[project.id]?.filter((task) =>\n          task.name.toLowerCase().includes(filter.toLowerCase())\n        ) ?? []\n      : tasksByProject?.[project.id] ?? []\n  }\n\n  const tasksByProject: { [key: number]: TaskV9[] } = Object.values(\n    tasks ?? {}\n  ).reduce((acc, task) => {\n    if (!acc[task.project_id]) acc[task.project_id] = []\n    acc[task.project_id].push(task)\n    return acc\n  }, {})\n\n  const filteredData = Object.values(projects ?? {}).reduce((acc, project) => {\n    const projectHasFilteredTasks = projectHasTaskWithFilter(project.id)\n    if (\n      !project.name.toLowerCase().includes(filter.toLowerCase()) &&\n      !projectHasFilteredTasks &&\n      !clients?.[project.client_id ?? '']?.name\n        .toLowerCase()\n        .includes(filter.toLowerCase())\n    ) {\n      return acc\n    }\n\n    const clientId = project.client_id ?? 'no_client'\n    if (acc[project.workspace_id] === undefined) acc[project.workspace_id] = {}\n    if (acc[project.workspace_id][clientId] === undefined)\n      acc[project.workspace_id][clientId] = {}\n\n    let tasks: TaskV9[] = []\n    if (expandedProjects?.[project.id]) {\n      tasks = tasksByProject?.[project.id] ?? []\n    } else if (filter.length > 0 && projectHasFilteredTasks) {\n      tasks = getVisibleTasks(project)\n    }\n    acc[project.workspace_id][clientId][project.id] = tasks\n    return acc\n  }, {})\n\n  const items: VirtualizedListItem[] = []\n  items.push({ id: 0, type: 'project' })\n  Object.keys(filteredData ?? {})\n    .sort(sortComparator(workspaces))\n    .forEach((workspaceId) => {\n      items.push({ id: Number(workspaceId), type: 'workspace' })\n      Object.keys(filteredData[workspaceId])\n        .sort(sortComparator(clients))\n        .forEach((clientId) => {\n          items.push({ id: Number(clientId), type: 'client' })\n          Object.keys(filteredData[workspaceId][clientId])\n            .sort(sortComparator(projects))\n            .forEach((projectId) => {\n              items.push({ id: Number(projectId), type: 'project' })\n              filteredData[workspaceId][clientId][projectId]\n                .sort(sortComparator(tasks))\n                .forEach((task) => {\n                  items.push({ id: task.id, type: 'task' })\n                })\n            })\n        })\n    })\n\n  return { items, tasksByProject }\n}\n\nself.onmessage = function (e: WorkerData<ProjectPopdownFilterWorkerProps>) {\n  try {\n    console.time('toggl:projectPopdownFilterWorker')\n    const response = handleEvent(e)\n    self.postMessage(response)\n    console.timeEnd('toggl:projectPopdownFilterWorker')\n  } catch (error) {\n    console.error(error, 'toggl:projectPopdownFilterWorker')\n  }\n}\n"],"names":["sortComparator","dataMap","a","b","_a","_b","nameA","name","nameB","undefined","localeCompare","handleEvent","e","projects","clients","workspaces","tasks","filter","expandedProjects","data","projectHasTaskWithFilter","projectId","tasksByProject","find","task","toLowerCase","includes","getVisibleTasks","project","_c","length","id","Object","values","reduce","acc","project_id","push","filteredData","_d","projectHasFilteredTasks","client_id","clientId","workspace_id","items","type","keys","sort","forEach","workspaceId","Number","self","onmessage","console","time","response","postMessage","timeEnd","error"],"mappings":"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"}