const MINIMUM_COMMENT_LENGTH=15;class AddReviewComponent extends React.Component{constructor(e){super(e),this.avatarColors=scrambleAvatarColors(),this.stars=null,this.reviewPlaceHolder=translate("letCommunityKnow"),this.onChangeComment=this.onChangeComment.bind(this),this.onStarsSelected=this.onStarsSelected.bind(this),this.toggleTag=this.toggleTag.bind(this),this.cancel=this.cancel.bind(this),this.save=this.save.bind(this),this.onBlurComment=this.onBlurComment.bind(this),this.state={isErrorComment:!1,isPlaceholder:!e.review.comment,comment:e.review.comment||""},this.iniitalTagsSort=null,window.addEventListener("blur",()=>{window.parent.postMessage({type:CLOSE_ADD_REVIEW},"*")}),document.body.addEventListener("keyup",e=>{/^esc/i.test(e.key)&&window.parent.postMessage({type:CLOSE_ADD_REVIEW},"*")})}componentWillReceiveProps(e){this.setState({comment:e.review.comment})}onBlurComment(){this.props.updateReview({comment:this.state.comment});const e=this.state.comment.length;if(e<15)return this.setState({isErrorComment:e>0,isPlaceholder:0===e})}onChangeComment(e){const t=e.target.value;this.setState(e=>({comment:t,isErrorComment:!(!t.length||t.length>15)&&e.isErrorComment}))}onStarsSelected(){const e=20*document.querySelectorAll(".wot-add-review-stars >.selected").length,t=this.getTagsBySafety(e),a=t.tags.concat(t.moreTags).map(e=>WOT_TAGS_IDS[e]),s=(this.props.review.tags||[]).filter(e=>a.includes(e));this.props.updateReview({safety:e,tags:s})}getTagsBySafety(e){switch(e){case 20:case 40:return TAGS_OPTIONS_BY_RATING_TYPE.bad;case 60:return TAGS_OPTIONS_BY_RATING_TYPE.moderate;case 80:case 100:return TAGS_OPTIONS_BY_RATING_TYPE.good;default:return TAGS_OPTIONS_BY_RATING_TYPE.unrated}}save(){if(!this.isForbiddenToPost())return this.props.saveReview(),window.parent.postMessage({type:CLOSE_ADD_REVIEW},"*")}cancel(){return window.parent.postMessage({type:CLOSE_ADD_REVIEW},"*")}isForbiddenToPost(){const e=this.props.review.safety,t=(this.state.comment||"").length;return!e||t<15}toggleTag(e){const t=WOT_TAGS_IDS[e],a=this.props.review.tags;if(a.includes(t))return this.props.updateReview({tags:a.filter(e=>e!==t)});this.props.updateReview({tags:a.concat(t)})}enrichTagsData(){const e=this.props.review.tags,t=t=>a=>({name:a,selected:e.includes(WOT_TAGS_IDS[a]),isExtra:t});var a=this.getTagsBySafety(this.props.review.safety);const s=a.type,n=a.showAllWidth,r=a.tags,o=a.moreTags;return{type:s,showAllWidth:n,tags:r.map(t(!1)).concat(o.map(t(!0)))}}sortTags(e){if(this.iniitalTagsSort)return(e.tags||[]).sort((e,t)=>this.iniitalTagsSort[e.name]-this.iniitalTagsSort[t.name]),void 0;(e.tags||[]).sort(e=>e.selected?-1:1),this.iniitalTagsSort=e.tags.reduce((e,t,a)=>(e[t.name]=a,e),{})}render(){var e=this.props;const t=e.user,a=e.review,s=e.favIconUrl;var n=this.state;const r=n.comment,o=n.isErrorComment,i=n.isPlaceholder,c=t.name[0].toUpperCase()+t.name.slice(1),l=a.target,m=this.enrichTagsData();a.id&&this.sortTags(m);const d=this.isForbiddenToPost();return React.createElement("div",{className:"wot-add-review-container"},React.createElement("div",{className:"wot-add-review-target"},l?l[0].toUpperCase()+l.slice(1):""),React.createElement("div",{className:"wot-add-review-name-avatar"},React.createElement("div",{className:"wot-add-review-user-avatar",style:this.avatarColors[0]},t.picture?React.createElement("img",{src:t.picture,alt:c[0]}):React.createElement("span",null,c[0])),React.createElement("div",{className:"wot-add-review-user-name"},c)),React.createElement("div",{className:"wot-add-review-question"},translate("howWouldYouRate")),React.createElement("div",{className:"wot-add-review-logo-stars"},React.createElement("div",{className:"wot-add-review-logo"},React.createElement("img",{src:s,alt:""})),React.createElement("div",{className:"wot-add-review-stars",ref:e=>{this.stars=e},onClick:this.onStarsSelected},getRatingStarsAndColor(null,null,a.safety/20).stars)),React.createElement("div",{className:"wot-add-review-comment-title"},translate("letOthersKnowYourExperience")),React.createElement("div",{className:"wot-add-review-comment-wrapper"},i&&React.createElement("span",{className:"wot-add-review-comment-content-placeholder"},this.reviewPlaceHolder),React.createElement("textarea",{className:"wot-add-review-comment-content"+(o?" wot-comment-too-short":""),value:r,onFocus:()=>this.setState({isPlaceholder:!1}),onChange:this.onChangeComment,onBlur:this.onBlurComment}),o&&React.createElement("div",{className:"wot-minimum-comment-length-error"},translate("writeAtLeast15"))),React.createElement("div",{className:"wot-add-review-tags-section"+(m.tags.length?"visible":"")},React.createElement("div",{className:"wot-add-review-comment-title tags"},translate("chooseTagsForSite")),React.createElement(TagsComponent,{tags:m.tags,type:m.type,showAllWidth:m.showAllWidth,onTagChanged:this.toggleTag})),React.createElement("div",{className:"wot-add-review-buttons"},React.createElement("div",{className:"wot-add-review-cancel",onClick:this.cancel},translate("cancel")),React.createElement("div",{className:"wot-add-review-save"+(d?" wot-btn-disabled":""),onClick:this.save},translate("postReview"))))}}function mapStateTpPros(e){const t=Object.values(e.tabs),a=e.focusedReview.target,s=t.find(e=>getEncodedDomain(e.url)===a),n=s&&s.favIconUrl;return{review:e.focusedReview,user:e.user,favIconUrl:n||GET_FAVICON_PREFIX+a}}function mapDispatchToProps(e){return{updateReview:t=>{e(setReviewInFocus(t))},saveReview:()=>{e(saveCommentAndReview())}}}AddReviewComponent=ReactRedux.connect(mapStateTpPros,mapDispatchToProps)(AddReviewComponent);