const webSocketEventsEnums={TIME_ENTRY_STARTED:"TIME_ENTRY_STARTED",TIME_ENTRY_STOPPED:"TIME_ENTRY_STOPPED",TIME_ENTRY_DELETED:"TIME_ENTRY_DELETED",TIME_ENTRY_UPDATED:"TIME_ENTRY_UPDATED",TIME_ENTRY_CREATED:"TIME_ENTRY_CREATED",NEW_NOTIFICATIONS:"NEW_NOTIFICATIONS",TIME_TRACKING_SETTINGS_UPDATED:"TIME_TRACKING_SETTINGS_UPDATED",WORKSPACE_SETTINGS_UPDATED:"WORKSPACE_SETTINGS_UPDATED",ACTIVE_WORKSPACE_CHANGED:"ACTIVE_WORKSPACE_CHANGED",CHANGED_ADMIN_PERMISSION:"CHANGED_ADMIN_PERMISSION",PROFILE_UPDATED:"PROFILE_UPDATED",USER_SETTINGS_UPDATED:"USER_SETTINGS_UPDATED",USER_EMAIL_VERIFIED:"USER_EMAIL_VERIFIED",USER_LOGGEDOUT_FROM_WEB_APP:"USER_LOGGEDOUT"};let connection,reconnectIntervalId;async function connectWebSocket(){const e=await localStorage.getItem("permanent_webSocketClientId"),n=await localStorage.getItem("userEmail"),t=await localStorage.getItem("permanent_webSocketEndpoint");if(!e||!n||!t||connection)return;const o="extension-"+(isChrome()?"chrome":"firefox"),s=`/${e}/${n}/${Math.random().toString(36).substring(2,10)}/${o}`;connection=new WebSocket(`${t}${s}`),connection.onopen=e=>{"open"===e.type&&(reconnectIntervalId&&(clearInterval(reconnectIntervalId),reconnectIntervalId=null),TokenService.getToken().then((async e=>{e&&(this.authenticate(e),await localStorage.setItem("wsConnectionId",s))})))},connection.onclose=e=>{reconnectIntervalId&&(clearInterval(reconnectIntervalId),reconnectIntervalId=null),4e3!==e.code?reconnectIntervalId=setInterval((()=>{TokenService.getToken().then((async e=>{e&&this.connectWebSocket(e)}))}),5e3):connection=null},connection.onmessage=e=>{this.messageHandler(e)},connection.onerror=e=>{connection.close()}}function disconnectWebSocket(){connection&&(connection.close(4e3,"Closing connection permanent"),localStorage.removeItem("wsConnectionId"))}async function messageHandler(e){switch(e.data){case webSocketEventsEnums.PROFILE_UPDATED:break;case webSocketEventsEnums.TIME_ENTRY_STARTED:{const{entry:n,error:t}=await TimeEntry.getEntryInProgress();null===n||t||(setTimeEntryInProgress(n),aBrowser.action.setIcon({path:iconPathStarted}),aBrowser.runtime.sendMessage({eventName:"entryStarted",options:{entry:n}})),this.sendWebSocketEventToExtension(e.data),this.addIdleListenerIfIdleIsEnabled(),this.removeReminderTimer(),this.restartPomodoro(),this.addPomodoroTimer();break}case webSocketEventsEnums.TIME_ENTRY_CREATED:this.sendWebSocketEventToExtension(e.data);break;case webSocketEventsEnums.TIME_ENTRY_STOPPED:setTimeEntryInProgress(null),aBrowser.action.setIcon({path:iconPathEnded}),this.sendWebSocketEventToExtension(e.data),this.removeIdleListenerIfIdleIsEnabled(),this.addReminderTimer(),this.restartPomodoro(),aBrowser.runtime.sendMessage({eventName:"entryEnded"});break;case webSocketEventsEnums.TIME_ENTRY_UPDATED:{const{entry:n,error:t}=await TimeEntry.getEntryInProgress();null===n||t||setTimeEntryInProgress(e.data),this.sendWebSocketEventToExtension(e.data);break}case webSocketEventsEnums.TIME_ENTRY_DELETED:{const{entry:n,error:t}=await TimeEntry.getEntryInProgress();null===n||t?(setTimeEntryInProgress(null),aBrowser.action.setIcon({path:iconPathEnded}),this.removeIdleListenerIfIdleIsEnabled(),this.addReminderTimer(),this.restartPomodoro()):(setTimeEntryInProgress(n),aBrowser.action.setIcon({path:iconPathStarted})),this.sendWebSocketEventToExtension(e.data);break}case webSocketEventsEnums.USER_SETTINGS_UPDATED:UserService.getAndStoreUser();break;case webSocketEventsEnums.WORKSPACE_SETTINGS_UPDATED:this.sendWebSocketEventToExtension(e.data),UserWorkspaceStorage.getSetWorkspaceSettings(),UserService.getSetUserRoles();break;case webSocketEventsEnums.ACTIVE_WORKSPACE_CHANGED:UserService.getAndStoreUser().then((()=>{this.sendWebSocketEventToExtension(e.data)})).catch((e=>console.log(e))),this.restartPomodoro();break;case webSocketEventsEnums.CHANGED_ADMIN_PERMISSION:this.sendWebSocketEventToExtension(e.data),UserWorkspaceStorage.getSetWorkspaceSettings(),UserService.getSetUserRoles();break;case webSocketEventsEnums.USER_EMAIL_VERIFIED:aBrowser.runtime.sendMessage({eventName:"USER_EMAIL_VERIFIED"});break;case webSocketEventsEnums.USER_LOGGEDOUT_FROM_WEB_APP:aBrowser.action.setIcon({path:iconPathEnded})}}function sendWebSocketEventToExtension(e){aBrowser.runtime.sendMessage({eventName:e})}function authenticate(e){connection&&e&&connection.send(e)}function backgroundWebSocketConnect(){connection||this.connectWebSocket()}function getReconnectTimeout(){return Math.floor(10001*Math.random())+5e3}Object.freeze(webSocketEventsEnums),aBrowser.runtime.onMessage.addListener(((e,n,t)=>{switch(e.eventName){case"webSocketConnect":connection||this.connectWebSocket();break;case"webSocketDisconnect":connection&&this.disconnectWebSocket()}}));