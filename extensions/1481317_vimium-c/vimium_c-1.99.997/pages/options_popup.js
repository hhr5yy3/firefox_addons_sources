import{OnFirefox as e,OnEdge as t,OnChrome as l,$ as n,pageTrans_ as s,enableNextTick_ as o,nextTick_ as u,IsEdg_ as i,post_ as r,toggleReduceMotion_ as a,hasShift_ as c,PageOs_ as f,setupPageOs_ as h,prevent_ as p,CurCVer_ as d}from"./async_bg.js";import{bgSettings_ as m,ExclusionRulesOption_ as _,setupBorderWidth_ as w,showI18n_ as g,setupSettingsCache_ as v}from"./options_base.js";let b,y,R,k,x="",j=0,O=true,P=null,T=null,E=0,L=/^[a-z][\+\-\.\da-z]+:\/\//,$=n("#state-action"),S=n("#saveOptions"),D=$.nextElementSibling,N=D.nextElementSibling,U=Object.create(null),z=(e,t)=>s(e,t)||"";class A extends _{G(e,t){super.G(A.ue(),t)}et(e){return e.st=e.it.pattern&&U[e.it.pattern]||false,B(e.st)}N(e){super.N(e),this.N=null,A.prototype.et=_.prototype.et;let t,l=this.q.filter(e=>e.nt),n=l.length>0;j=n?2:1,n?(t=l[0].lt,H(true)):(this.G("",false),t=this.q[this.q.length-1].lt),setTimeout(()=>{t.focus()},67)}J(e){let t=super.J(e),l=M(`${b.tabId}/reset/silent`);return Promise.all([t,l]).then(([e])=>e)}ot(e,t,l){let n=e.it.pattern===t,s=e.st;super.ot(e,t,l);let o=t?l?l.length>1&&"^"===l[0]?z("onlyHook")||"only hook such keys":z("passThrough")||"pass through such keys":z("completelyDisabled")||"completely disabled":"";e.tt.title!==t&&(e.tt.title=t),e.lt.title!==o&&(e.lt.title=o),n?e.st=s:this.ae(e,t)}ae(e,t){let l,n=e.tt;e.U&=-5,t&&t!==A.ue()?(l=F(e))instanceof Promise?l.then(()=>{this.ae(e,t)}):B(l)?n.title=n.style.color="":(e.U|=4,n.style.color="red",n.title="Red text means that the pattern does not\nmatch the current URL."):n.title=n.style.color=""}static ue(){let e=y.split(/[?#]/)[0],t=e.startsWith("http:")?"^https?://"+e.split("/",3)[2].replace(/[$()*+.?\[\\\]\^{|}]/g,"\\$&")+"/":e.startsWith(location.origin+"/")?":vimium:/"+new URL(e).pathname.replace("/pages",""):/^[^:]+:\/\/./.test(e)&&!e.startsWith("file:")?":"+e.split("/",3).join("/")+"/":":"+e;return U[t]||(U[t]=G("^"===t[0]?{t:1,v:t}:{t:2,v:t.startsWith(":vimium:")?e:t.slice(1)})),A.ue=()=>t,t}}let H=e=>{T.z(true);let t=T.q.filter(e=>e.nt&&(!!e.it.pattern||!!(4&e.U))),l=j;j=2,Promise.all(t.map(e=>null!==e.st?e.st:F(e))).then(()=>{V(l,e,t)})},V=(e,t,l)=>{let n=3===e,s=K(!!x,l);s&&(s=I(s)),t&&(P=e>=2?s:null);let o=s===P,u=!!s&&s.length>2&&"^"===s[0];$.textContent=(n?s?z("137")+z(u?"138":"139"):z("140"):z(o?"141":"142")+z(s?u?"138":"139":o?"143":"143_2")).replace(" to be","")+z("colon")+z("NS"),D.className=s?"code":"",D.textContent=s?u?s.slice(2):s:z("143_3")+z(null!==s?"144":"145"),N.textContent=null!==b.lock&&!n&&o?z("147",[z(0!==b.lock?"144":"145")]):null!==b.lock?z("148"):"";let i=l.some(e=>!!(4&e.U)&&(e.it.pattern!==e.Y.pattern||e.it.passKeys!==e.Y.passKeys));S.disabled=o&&!i,S.firstChild.data=z(n?"115_3":o&&!i?"115":"115_2")},C=()=>{if(!S.disabled)return o(8),T.P().then(()=>{o(0,8),j=3,Q(),H(true),S.firstChild.data=z("115_3"),S.blur(),S.disabled=true,O=true})},I=e=>{let t=(e=e.trim()).length>2&&e.startsWith("^");t&&(e=e.slice(1).trimLeft());let l=Object.create(null);for(let t of e.split(" "))l[t]=1;return(t?"^ ":"")+Object.keys(l).sort().join(" ")},M=e=>r(22,[e,b.tabId,b.frameId]).then(e=>{b.status=e[0],b.lock=e[1]}),q=(e,t)=>{t&&p(t);let l=t&&(t.ctrlKey||t.metaKey);M(`${b.tabId}/${e}`).then(()=>{l?(Q(),H(false)):window.close()})},B=e=>!!e&&(2===e.t?y.startsWith(e.v)||!!x&&x.startsWith(e.v):3===e.t?e.v.p.test(y)||!!x&&e.v.p.test(x):e.v.test(y)||!!x&&e.v.test(x)),F=e=>{let t=e.it.pattern,l=U[t];if(l)return e.st=l instanceof Promise?l.then(t=>e.st=t):l;let n=r(23,t);return U[t]=e.st=n.then(l=>U[t]=e.st=G(l))},G=e=>2===e.t?{t:e.t,v:e.v}:3===e.t?{t:e.t,v:{p:new URLPattern(e.v,"http://localhost",{ignoreCase:true}),s:e.v}}:{t:e.t,v:new RegExp(e.v,"")},J=()=>{let{rules:e,matchers:t}=b.exclusions;for(let l=0,n=e.length;l<n;l++){let n=e[l].pattern;U["__proto__"!==n?n:"_"]=G(t[l])}},K=(e,t)=>{let l="";for(let e of t){let t=e.st;if(t&&(2===t.t?y.startsWith(t.v):3===t.t?t.v.p.test(y):t.v.test(y))){let t=e.it.passKeys;if(0===t.length||k||"^"===t[0]&&t.length>2)return t;l+=t}}return!l&&e&&y.lastIndexOf("://",5)<0&&!L.test(y)&&x?K(false,t):l||null},Q=()=>{R=2!==b.status?"Disable":"Enable";let e=n("#toggleOnce"),t=e.nextElementSibling;u(()=>{e.firstElementChild.textContent=(z(R)||R)+(null!==b.lock?"":z("Once")),e.onclick=q.bind(null,R),D.id="state-value",t.classList.toggle("hidden",null===b.lock),null!==b.lock&&(t.firstElementChild.onclick=q.bind(null,"Reset"))})},W=e=>{let t=n(".options-link"),l=location.origin+"/pages/options.html";e.startsWith(l)?u(()=>{t.nextElementSibling.remove(),t.remove()}):(t.href!==l&&u(()=>{t.href=l}),t.onclick=e=>{p(e),r(15,{u:l,p:true}).then(()=>{window.close()})})},X=()=>{window.addEventListener("keydown",e=>{13===e.keyCode&&e.metaKey?Y(e):e.altKey&&(88===e.keyCode||null!==b.lock&&90===e.keyCode)&&!(e.ctrlKey||e.metaKey||c(e))&&(p(e),e.stopImmediatePropagation(),q(88===e.keyCode?R:"Reset"))}),T=new A(n("#exclusionRules"),()=>{if(O){O=false;let e=!E&&n("#helpSpan");e&&(e.nextElementSibling.style.display="",e.remove(),E=1)}H(j<2)}),T.w()};r(20).then(e=>{b=e,h(b.os);let t=b.url,l=n("#blocked-msg");if(o(1),!b.runnable)return ee(l),W(t),u(g),void u(Z);u(e=>{l.remove(),l=null,a(b.reduceMotion),e.textContent=b.ver},n("#version")),x=b.topUrl||t,y=b.frameUrl||x,k=b.exclusions.onlyFirst,m.r={exclusionRules:b.exclusions.defaults},v({exclusionRules:b.exclusions.rules}),J(),b.exclusions=null,S.onclick=C,document.addEventListener("keyup",Y),W(t),Q(),X(),u(g),w&&u(w),u(Z)});let Y=e=>{if(13===e.keyCode){let t=e.target;if(t instanceof HTMLAnchorElement)t.hasAttribute("href")||setTimeout(e=>{e.click(),e.blur()},0,t);else if(e.ctrlKey||e.metaKey){let e=!O&&C();e&&e.then(()=>{setTimeout(window.close,300)})}}},Z=()=>{let e=document.documentElement;e.classList.remove("loading"),e.style.width="",e.style.height=""},ee=e=>{let t=document.body;t.innerText="",e.style.display="",e.querySelector("#version").textContent=b.ver,e.querySelector("#refresh-after-install").remove(),t.append(e);let l=b.unknownExt;if(l){let e=n("#injection-refused");e.style.display="",e.nextElementSibling.remove(),n("#doAllowExt").onclick=function(){this.onclick=null,r(21,[b.tabId,l]).then(()=>{setTimeout(()=>{location.reload()},0)})}}let s=n("#retryInject");s&&(s.nextElementSibling.remove(),s.remove())};