function getText(){let e=window.getSelection().toString();if(!e){e=[...document.querySelectorAll("iframe")].map((e=>e?.contentWindow?.getSelection()?.toString())).find((e=>e))}return e||""}async function getSelectedText(){const e=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0],[t]=await chrome.scripting.executeScript({target:{tabId:e.id},func:getText});return t?.result?.trim()||""}function setButtonActive(e,t){const n=e.currentTarget,o=e.target;t?"true"===o.getAttribute("data-active")?o.setAttribute("data-active",!1):o.setAttribute("data-active",!0):(n.querySelectorAll("button").forEach((e=>e.removeAttribute("data-active"))),o.setAttribute("data-active",!0))}function setStatus(e="waiting",t=!0){const n=document.getElementById("write-btn");n.textContent={waiting:"Write ‚úèÔ∏è",thinking:"ü§î Thinking...",writing:"üìù Writing...",revise:"Revise üîÑ"}[e],t?n.removeAttribute("disabled"):n.setAttribute("disabled",!0)}function setError(e="",t){const n=document.getElementById("error");let o;t?"unknown"===t?o=`Oops, Ellie encountered an error. If this keeps happening, please let us know. Error: ${message}`:"invalid-licence"===t?o='You need to enter your licence key to use Ellie, you can do this from the <a href="#" class="ellie-settings-link">settings page</a>.':"licence-overused"===t?o="Your licence key is being used on too many devices, if you want to de-register a device or upgrade your plan please contact us.":"overdue-invoice"===t&&(o='Your invoice is overdue and your subscription will be canceled soon. Please manage your plan and pay your invoice, you can do this from the <a href="#" class="ellie-settings-link">settings page</a>.'):o=e,n.innerHTML=o,"invalid-licence"!==t&&"overdue-invoice"!==t||n.querySelector(".ellie-settings-link").addEventListener("click",(()=>chrome.runtime.sendMessage({type:"open-options",tab:"licence"}))),o?document.getElementById("error").classList.remove("hidden"):document.getElementById("error").classList.add("hidden")}function copyToClipboard(e){const t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="absolute",t.style.left="-9999px",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}function showUpgrade({accountEmail:e,userUuid:t}){let n={ref:"plugin",client:"popup"};e&&(n={...n,e:e}),t&&(n={...n,u:t});const o=`https://tryellie.com/upgrade?${new URLSearchParams(n).toString()}`;document.getElementById("ellie-upgrade-link").href=o,document.getElementById("upgrade").classList.remove("hidden"),document.getElementById("write-btn").classList.add("hidden")}function getBrowser(){return"undefined"!=typeof chrome?"undefined"!=typeof browser?"Firefox":"Chrome":"Edge"}function normalize(e){return 0===e.trim().length?"":e}"undefined"!=typeof chrome?"undefined"!=typeof browser?(console.log("Ellie is running in browser: Safari or Firefox"),chrome=browser):console.log("Ellie is running in browser: Chrome"):console.log("Ellie is running in browser: unsupported"),document.querySelector(".ellies-moods").addEventListener("click",setButtonActive),document.querySelector(".ellies-interest").addEventListener("click",setButtonActive),document.querySelector(".ellies-reply-length").addEventListener("click",(e=>setButtonActive(e,!0))),document.getElementById("close-btn").addEventListener("click",(e=>window.close())),document.getElementById("feedback-btn").addEventListener("click",(()=>{window.close(),chrome.runtime.sendMessage({type:"open-options"},(function(e){}))})),document.getElementById("write-btn").addEventListener("click",(async e=>{try{setError(""),setStatus("thinking",!1);const e=document.getElementById("ellies-reply-to"),t=e?e.value:"",n=await getSelectedText();if(!n&&!t)return setError("You haven't selected or entered any text! Highlight some text on the page or paste some text into the 'text to reply to' box. This works best if it's email content!"),void setStatus("waiting",!0);const o=document.querySelector('.ellies-moods button[data-active="true"]'),r=document.querySelector('.ellies-interest button[data-active="true"]'),i=document.querySelector('.ellies-reply-length button[data-active="true"]'),l=o?o.getAttribute("data-value"):"respectful",d=r?r.getAttribute("data-value"):"interested",s=i?i.getAttribute("data-value"):"",c=document.getElementById("ellie-roles").getAttribute("data-selected-role"),a=document.getElementById("ellies-thoughts"),u=a?a.value:"",m={type:"popup-prompt",emailText:normalize(t||n),mood:l,interest:d,thinkingText:normalize(u).substr(0,500),roleUuid:c,replyLength:s};chrome.runtime.sendMessage(m,(function(e){}))}catch(e){console.error(e),setError("Something went wrong, please try again!"),setStatus("waiting",!0)}})),document.getElementById("copy-btn").addEventListener("click",(e=>{const t=document.getElementById("copy-reply").textContent;setTimeout((()=>{document.getElementById("copy-btn").textContent="Copy üìÑ"}),3e3),copyToClipboard(t),document.getElementById("copy-btn").textContent="Copied!"})),chrome.runtime.onMessage.addListener((async function(e){"popup-response"==e.type?(setStatus("waiting",!0),!1===e.allowed?setError(e.text,e.reason):e.text&&(document.getElementById("done").classList.remove("hidden"),document.getElementById("reply").textContent=e.text,document.getElementById("copy-reply").textContent=e.text,copyToClipboard(e.text)),e.openUpgradeBox&&showUpgrade(e),e.openOverdueBox&&setError("","overdue-invoice")):"popup-error"==e.type&&(setStatus("waiting",!1),setError(e.text)),"popup:roles"==e.type&&populateRolesDropdown(e.data);const t=await getSelectedText();document.getElementById("ellies-reply-to").value=t||""}));let roleToggleBtn=document.getElementById("roles-toggle-btn"),rolesDropdown=document.getElementById("ellie-roles"),replyLengthToggleBtn=document.getElementById("reply-length-toggle-btn"),replyLengthDropdown=document.getElementById("ellie-reply-length");function truncateString(e,t){return e.length<=t?e:e.slice(0,t-3)+"..."}function populateRolesDropdown(e=[]){const t=document.getElementById("ellie-roles"),n=document.getElementById("role-options"),o=document.createElement("li");o.textContent="No role",o.value="",o.setAttribute("data-role-uuid",""),o.setAttribute("data-role-none","true"),n.appendChild(o);const r=e.find((e=>e.isDefault));for(let t of e){const{uuid:e,name:o}=t;if(!!n.querySelector(`[data-role-uuid="${e}"]`))continue;const r=document.createElement("li");r.value=e,r.textContent=o,r.setAttribute("data-role-uuid",e),n.appendChild(r)}if(!n.querySelector(".list-item-separated")){const t=document.createElement("li");t.classList.add("list-item-separated"),t.value=null,t.textContent=0===e.length?"Create a Role":"Edit Roles",t.addEventListener("click",(function(){window.close(),chrome.runtime.sendMessage({type:"open-options",tab:"roles"})})),n.appendChild(t)}let i={uuid:"",name:"No role"};r&&(i=r),t.setAttribute("data-selected-role",i.uuid),document.getElementById("roles-toggle-btn").innerHTML=`üßë‚Äçüíº ${i.name} <span>‚ñº</span>`}document.addEventListener("DOMContentLoaded",(function(){chrome.runtime.sendMessage({type:"popup:fetch-roles"})})),rolesDropdown.addEventListener("click",(function(e){const t=document.getElementById("ellie-roles"),n=document.getElementById("role-options");(e.target.getAttribute("data-role-uuid")||e.target.getAttribute("data-role-none"))&&(t.setAttribute("data-selected-role",e.target.getAttribute("data-role-uuid")),roleToggleBtn.innerHTML=`üßë‚Äçüíº ${truncateString(e.target.textContent,10)} <span>‚ñº</span>`),n.style.display="none"===n.style.display?"block":"none"}));