var U=Object.defineProperty;var O=(e,t,s)=>t in e?U(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var y=(e,t,s)=>(O(e,typeof t!="symbol"?t+"":t,s),s);import{B as N,S as x,a as T,g as u,aw as p,d as M,aK as C,ap as P,av as G,ai as R}from"./enum.js";import{R as c}from"./mention-audio.js";var v;(e=>{async function t(){let l=N.getGlobalEmotes().then(h=>n(h.body)),i=x.getGlobalEmotes().then(h=>a(h.body.emotes)),r=T.getGlobalEmotes().then(h=>o(h.body.sets)),[d,w,E]=await Promise.allSettled([l,i,r]);return{bttv:d.status=="fulfilled"?d.value:{},seventv:w.status=="fulfilled"?w.value:{},ffz:E.status=="fulfilled"?E.value:{}}}e.getGlobalEmotes=t;async function s(l){let i=N.getUser(l).then(f=>({channelEmotes:n(f.body.channelEmotes||[]),sharedEmotes:n(f.body.sharedEmotes||[])})),r=x.getUser(l).then(f=>({channelEmotes:a(f.body.emote_set.emotes||[])})),d=T.getUserByTwitchId(l).then(f=>({channelEmotes:o(f.body.sets||[])})),[w,E,h]=await Promise.allSettled([i,r,d]);return{bttv:w.status=="fulfilled"?w.value:void 0,seventv:E.status=="fulfilled"?E.value:void 0,ffz:h.status=="fulfilled"?h.value:void 0}}e.getChannelEmotes=s;function n(l){return l.reduce((i,r)=>(i[r.code]=r.id,i),{})}function a(l){return l.reduce((i,r)=>(i[r.name]=r.id,i),{})}function o(l){return Object.values(l).reduce((i,r)=>(r.emoticons.forEach(d=>{i[d.name]=String(d.id)}),i),{})}})(v||(v={}));var I;(e=>{async function t(){return await(await fetch("https://raw.githubusercontent.com/Chimildic/streamer-ids/main/VkToTwitch.json")).json()}e.getVkToTwitchIds=t})(I||(I={}));var S;(e=>{async function t(o){try{return(await T.getUserByTwitchLogin(o)).body.room.twitch_id.toString()||""}catch{return await s(o)||await n(o)||""}}e.getUserId=t;async function s(o){var i;return((i=(await a(`https://www.streamdatabase.com/twitch/channels/${o}`)).match(/"id":"([0-9]+)"/))==null?void 0:i.at(1))||void 0}async function n(o){var i;return((i=(await a(`https://twitchtracker.com/${o}/subscribers`)).match(/id:.?([0-9]+)/))==null?void 0:i.at(1))||void 0}async function a(o){try{return await(await fetch(o)).text()}catch{return""}}})(S||(S={}));class b{constructor(){y(this,"queue");this.queue=[],this.begin()}begin(){this.queue.push({funcName:"begin"})}commit(){this.queue.push({funcName:"commit"})}resetEmptyTwitchId(){return this.queue.push({funcName:"resetEmptyTwitchId"}),this}updateTwitchIndex(){return this.queue.push({funcName:"updateTwitchIndex"}),this}updateGlobalEmotes(){return this.queue.push({funcName:"updateGlobalEmotes"}),this}updateChannelEmotes(){return this.queue.push({funcName:"updateChannelEmotes"}),this}addChannelNames(...t){return this.queue.push({funcName:"addChannelNames",args:t}),this}async build(){if(this.queue[this.queue.length-1].funcName=="commit")throw"Already built";this.commit();let t=new V;for(let s=0;s<this.queue.length;s++){let n=this.queue[s],a=n.args||[];await t[n.funcName](...a)}}}class V{constructor(){y(this,"emotes");y(this,"vkToTwitchIds");y(this,"channelNames");this.emotes={},this.vkToTwitchIds={},this.channelNames=new Set}async begin(){this.emotes=await u("emotes"),this.vkToTwitchIds=await I.getVkToTwitchIds()}async commit(){await p("emotes",this.emotes)}resetEmptyTwitchId(){this.emotes.twitchIndex=Object.fromEntries(Object.entries(this.emotes.twitchIndex).filter(([t,s])=>s!=""))}async updateTwitchIndex(){for(let t of this.channelNames)this.emotes.twitchIndex[t]==null&&(this.emotes.twitchIndex[t]=await S.getUserId(t));Object.entries(this.vkToTwitchIds).forEach(([t,s])=>{this.emotes.twitchIndex[t]!=null&&this.emotes.twitchIndex[t]!=s&&(this.emotes.twitchIndex[t]=s,this.channelNames.add(t))})}async updateGlobalEmotes(){let t=await v.getGlobalEmotes(),s={bttv:[],seventv:[],ffz:[]};Object.entries(t).forEach(([n,a])=>{Object.entries(a).forEach(([o,l])=>{this.emotes.emoteIndex[n][o]=l,s[n].push(o)}),s[n].length==0&&(s[n]=this.emotes.globalEmotes[n])}),this.emotes.globalEmotes=s}async updateChannelEmotes(){for(let t of this.channelNames){let s=this.emotes.twitchIndex[t]||"",n={bttv:{channelEmotes:[],sharedEmotes:[]},seventv:{channelEmotes:[]},ffz:{channelEmotes:[]}};if(s.length==0){this.emotes.channelEmotes[t]=n;return}let a=await v.getChannelEmotes(s);Object.entries(a).forEach(([o,l])=>{var i;if(l==null){n[o]=((i=this.emotes.channelEmotes[t])==null?void 0:i[o])||void 0;return}Object.keys(l).forEach(r=>{Object.entries(l[r]).forEach(([d,w])=>{this.emotes.emoteIndex[o][d]=w,n[o][r].push(d)})})}),this.emotes.channelEmotes[t]=n}}addChannelNames(...t){t.forEach(s=>this.channelNames.add(s))}}var g=(e=>(e.UpdateGlobalEmotes="updateGlobalEmotes",e.UpdateChannelEmotes="updateChannelEmotes",e.UpdateChannelAndGlobalEmotes="updateChannelAndGlobalEmotes",e.UpdateTwitchIndex="updateTwitchIndex",e.ResetEmptyTwitchId="resetEmptyTwitchId",e))(g||{}),m;(e=>{const t="TaskManager:";function s(){new b().updateGlobalEmotes().build(),console.log(t,"updateGlobalEmotes","worker complete")}e.updateGlobalEmotes=s;function n(i){new b().addChannelNames(i).updateTwitchIndex().updateChannelEmotes().build(),console.log(t,"updateChannelEmotes","worker complete")}e.updateChannelEmotes=n;async function a(i,r){let d=new b;r===!0&&d.resetEmptyTwitchId(),d.addChannelNames(i).updateTwitchIndex().updateChannelEmotes().updateGlobalEmotes().build(),console.log(t,"updateChannelAndGlobalEmotes","worker complete")}e.updateChannelAndGlobalEmotes=a;async function o(){new b().updateTwitchIndex().updateChannelEmotes().build(),console.log(t,"updateTwitchIndex","worker complete")}e.updateTwitchIndex=o;async function l(){new b().resetEmptyTwitchId().build(),console.log(t,"resetEmptyTwitchId","worker complete")}e.resetEmptyTwitchId=l})(m||(m={}));var A;(e=>{const t="AlarmManager:";function s(){browser.alarms.onAlarm.addListener(n),a(g.UpdateGlobalEmotes,10080),a(g.UpdateTwitchIndex,10080)}e.setAlarms=s;function n(o){o.name==g.UpdateGlobalEmotes?m.updateGlobalEmotes():o.name==g.UpdateTwitchIndex&&m.updateTwitchIndex(),console.log(t,"onAlarmFire -",o.name)}function a(o,l){browser.alarms.get(o,i=>{(i==null||i.name==o&&i.periodInMinutes!=l)&&(browser.alarms.create(o,{periodInMinutes:l}),console.log(o,"alarm set"))})}})(A||(A={}));async function j(e){let t=Number((e.previousVersion||browser.runtime.getManifest().version).replaceAll(".",""));e.reason==browser.runtime.OnInstalledReason.UPDATE&&(t<152&&await D(),t<200&&await L(),t<220&&await q(),t<230&&await B(),t<235&&await F(),t<260&&await k())}async function k(){await browser.storage.local.set({isClaimMessageBonus:!1})}async function F(){let e=await browser.storage.local.get(["emotes"]),t=Object.keys(e.emotes.twitchIndex),s=[];for(let n=0;n<t.length;n++){let a=e.emotes.channelEmotes[t[n]];a!=null&&a.seventv==null&&Object.keys(a).length>0&&s.push(t[n])}await new b().addChannelNames(...s).updateTwitchIndex().updateChannelEmotes().build()}async function B(){let e=await browser.storage.local.get(["isAutoCollectPointsEnabled"]);await browser.storage.local.set({isClaimChestBonus:e.isAutoCollectPointsEnabled}),await browser.storage.local.remove(["isAutoCollectPointsEnabled"])}async function q(){await browser.storage.local.set({emotes:M.emotes})}async function L(){try{let e=["twitchIndex","emoteIndex","globalEmotes","channelEmotes"],t=await browser.storage.local.get(e);await browser.storage.local.set({emotes:t}),await browser.storage.local.remove(e)}catch{}}async function D(){var e;try{browser.storage.local.remove(["alreadyNotifiedStreamIds"]);let t=await browser.storage.local.get(["subscribedChannels"]);(e=t.subscribedChannels)==null||e.forEach(s=>s.isShowNotification=!0),await browser.storage.local.set({subscribedChannels:t.subscribedChannels})}catch(t){console.error(t)}}const z='div[class*="CatalogShowcase_container"] { display: none !important; }';browser.runtime.onInstalled.addListener(W);browser.runtime.onMessage.addListener(K);browser.action.onClicked.addListener(_);browser.tabs.onUpdated.addListener(Z);A.setAlarms();async function W(e){await j(e),e.reason==browser.runtime.OnInstalledReason.INSTALL&&C("isWelcomeViewShown",!1),(e.reason==browser.runtime.OnInstalledReason.INSTALL||e.reason==browser.runtime.OnInstalledReason.UPDATE)&&(C("isChangelogPageShown",!1),browser.runtime.setUninstallURL("https://docs.google.com/forms/d/e/1FAIpQLSfrTPgGFFy6KJzElJ30MXD-dQZlEebEU7ECFWN2DDfU92g4dw/viewform"),m.resetEmptyTwitchId(),m.updateGlobalEmotes(),Math.abs(Date.now()-await u("installedAtMs"))<5e3&&p("installedAtMs",Date.now()))}async function _(e){e.id==null?browser.runtime.openOptionsPage():browser.tabs.sendMessage(e.id,{type:c.OpenOptionPageEvent,data:{page:P.ChatOptions}},t=>{(browser.runtime.lastError!=null||t==null)&&browser.runtime.openOptionsPage()})}async function K(e,t){var s;if(e.type!=c.KeepServiceWorkerAlive)if(e.type==c.UpdateChannelAndGlobalEmotesEvent&&e.data!=null)m.updateChannelAndGlobalEmotes(e.data.channelName,e.data.isRequestedByUser);else if(e.type==c.UpdateChannelEmotesEvent&&e.data!=null)m.updateChannelEmotes(e.data.channelName);else if(e.type==c.ShowNotificationEvent)J(e.data);else if(e.type==c.UpdateSubscribedChannels)C("subscribedChannels",e.data);else if(e.type==c.OpenOptionPageEvent&&((s=t.tab)==null?void 0:s.id))browser.tabs.sendMessage(t.tab.id,e);else if(e.type==c.GetNotifyAudioParams){let n=await G(["customNotifyAudioSrc","notifyAudioSrc","isNotifyAudioMentionEnabled","notifyAudioVolume"]),a=n.customNotifyAudioSrc;return a.length==0&&(a=n.notifyAudioSrc),{isEnabled:n.isNotifyAudioMentionEnabled,src:a,volume:n.notifyAudioVolume}}else if(e.type==c.SetSubscriptions)Q(e.data);else{if(e.type==c.GetSubscribedChannelCount)return(await u("subscribedChannels")).length;if(e.type==c.SentEmoteCodes)$(e.data);else if(e.type==c.WhenClaimBonusFromMessage){let n=await u("nextMessageBonusTimecodes"),a=n[e.data.channelName];return a==null&&(n[e.data.channelName]=Date.now()+61*6e4,await p("nextMessageBonusTimecodes",n)),a||Date.now()}else if(e.type==c.SetMessageBonusTimecode){let n=await u("nextMessageBonusTimecodes"),a=e.data.timecode+61*6e4;return n[e.data.channelName]=a,await p("nextMessageBonusTimecodes",n),a}else{if(e.type==c.GetValueFromStorage)return await u(e.data);if(e.type==c.GetValueArrayFromStorage)return await G(e.data)}}}async function Z(e,t,s){if((t==null?void 0:t.status)=="loading"&&s.url=="https://live.vkvideo.ru/"){let n={target:{tabId:e},css:z};(await u("isRemoveCatalogShowcase")?browser.scripting.insertCSS:browser.scripting.removeCSS)(n)}else(t==null?void 0:t.status)=="complete"&&browser.tabs.sendMessage(e,new R(c.OnPageStatusComplete,void 0,"content","background"),H)}function H(e){browser.runtime.lastError}async function J(e){browser.notifications.create(e.notificationId,e.notificationOptions);let t=await u("autoCloseNotificationAboutStreamSeconds");t>0&&setTimeout(()=>browser.notifications.clear(e.notificationId),t*1e3)}async function Q(e){let t=await u("subscribedChannels");e.forEach(s=>{let n=t.find(a=>a.ownerId==s.ownerId);s.isShowNotification=n!=null&&n.hasOwnProperty("isShowNotification")?n.isShowNotification:!0}),p("subscribedChannels",e)}async function $(e){let t=await u("oftenUsedEmotes");Object.entries(e).forEach(([s,n])=>{t[s]=(t[s]||0)+n}),await p("oftenUsedEmotes",t)}
