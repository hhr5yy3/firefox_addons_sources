import{s as Z}from"./content-script-D7YBjZpd.js";import{u as ie,d as le}from"./storeTypes-CGrbvTi_.js";console.log("shared-functions loaded");const{data:g,promise:se}=ie("settings",le),b=new Date,N=b.toISOString().split("T")[0],oe=navigator.userAgent,ae=/mobile|streamingEnhanced/i.test(oe);let m=window.location.href;const R=window.location.hostname,re=document.title,A=/amazon|primevideo/i.test(R)&&(/video/i.test(re)||/video/i.test(m));let v=/netflix/i.test(R),y=/disneyplus|starplus/i.test(R);const D=/hotstar/i.test(R);let w=/max.com/i.test(R);const F=document.documentElement.lang,ce=".dv-player-fullscreen video";let o={};var ue=(e=>(e.Netflix="netflix",e.Amazon="amazon",e.StarPlus="starplus",e.Disney="disney",e.Hotstar="hotstar",e.Crunchyroll="crunchyroll",e.HBO="hbo",e))(ue||{});async function Ce(e){e=="netflix"&&(v=!0),e=="disney"&&(y=!0),e=="hbo"&&(w=!0),await se,g.value.Video.playOnFullScreen&&be(),de()}async function de(){chrome.storage.local.get("DBCache",function(e){var t,l,n,d;if(o=e==null?void 0:e.DBCache,typeof o!="object"){console.log("DBCache not found, creating new one",o);try{chrome.storage.local.set({DBCache:{}})}catch(f){console.log(f)}o={}}v&&((t=g.value.Netflix)!=null&&t.showRating)?E():y||D?(l=g.value.Disney)!=null&&l.showRating&&E():(A&&((n=g.value.Amazon)!=null&&n.showRating)||w&&((d=g.value.HBO)!=null&&d.showRating))&&E(),C(g.value.General.GCdate,b)>=O&&fe()}),chrome.storage.local.onChanged.addListener(function(e){e!=null&&e.DBCache&&(o=e.DBCache.newValue)})}async function ee(){const l=new TextEncoder().encode(JSON.stringify(o)).length/1024/1024;l<5?(console.log("updateDBCache size:",l.toFixed(4)+" MB"),chrome.storage.local.set({DBCache:o})):(console.log("DBCache cleared",l),o={},chrome.storage.local.set({DBCache:o}))}const O=30;async function fe(){console.log("garbageCollection started, deleting old ratings:");const e=Object.keys(o);for(const t of e)(C(o[t].date,b)>=O||o[t].db!="tmdb")&&(console.log(o[t].date,t),delete o[t]);g.value.General.GCdate=N,ee()}function we(e){var l,n;if(!e)return!1;const t=parseInt(((l=/:\d+/.exec(e??""))==null?void 0:l[0].substring(1))??"")+parseInt(((n=/\d+/.exec(e??""))==null?void 0:n[0])??"")*60;return isNaN(t)?!1:t}function xe(e,t,l,n,d,f=""){t.value=t.value||e.playbackRate;const a=document.createElement("input");a.id="videoSpeedSlider",a.type="range",a.min=g.value.General.sliderMin.toString(),a.max=g.value.General.sliderMax.toString(),a.value=(t.value*10).toString(),a.step=g.value.General.sliderSteps.toString(),a.style.cssText=n;const c=document.createElement("p");if(c.id="videoSpeed",c.textContent=t.value?t.value.toFixed(1)+"x":"1.0x",c.style.cssText=d,f){const u=document.createElement("div");u.style.cssText=f,u.appendChild(a),u.appendChild(c),l.prepend(u)}else l.prepend(a,c);return t.value&&(e.playbackRate=t.value),c.onclick=function(){a.style.display=a.style.display==="block"?"none":"block"},a.oninput=function(){const u=parseFloat(a.value);c.textContent=(u/10).toFixed(1)+"x",e.playbackRate=u/10,t.value=u/10},{slider:a,speed:c}}async function te(e,t,l=null,n=null){var u;const d=F||(navigator==null?void 0:navigator.language)||"en-US",f=l??"multi";let a=`https://api.themoviedb.org/3/search/${f}?query=${encodeURI(e)}&include_adult=false&language=${d}&page=1`;n&&(a+=`&year=${n}`);const c=await Z("fetch",{url:a},"background");if(c!=null){const i=(u=c==null?void 0:c.results)==null?void 0:u[0],S={id:i==null?void 0:i.id,media_type:f=="multi"?i==null?void 0:i.media_type:f,score:i==null?void 0:i.vote_average,vote_count:i==null?void 0:i.vote_count,release_date:(i==null?void 0:i.release_date)||(i==null?void 0:i.first_air_date),title:(i==null?void 0:i.title)||(i==null?void 0:i.original_title)||(i==null?void 0:i.name)||(i==null?void 0:i.original_name),date:N,db:"tmdb"};o[e]=S,ne(t,S,e)}}const ge=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/g;function X(){var e,t,l;if(y){if(m=window.location.href,m.includes("search"))return!1;if(m.includes("entity")){const n=document.querySelector('[aria-selected="true"]');return ge.test(((t=(e=n==null?void 0:n.id)==null?void 0:e.split("_control"))==null?void 0:t[0])??"")&&(n==null?void 0:n.getAttribute("aria-label"))!="EXTRAS"}return!0}else return A&&window.location.href.includes("detail")?((l=document.querySelector('[data-testid="btf-related-tab"]'))==null?void 0:l.getAttribute("tabIndex"))=="0":!0}async function E(){X()&&K();const e=setInterval(function(){var t,l,n,d;if(v&&!((t=g.value.Netflix)!=null&&t.showRating)||A&&!((l=g.value.Amazon)!=null&&l.showRating)||(y||D)&&!((n=g.value.Disney)!=null&&n.showRating)||w&&!((d=g.value.HBO)!=null&&d.showRating)){console.log("stopped adding Rating"),clearInterval(e);return}X()&&K()},1e3)}function C(e,t){return!e||!t?31:Math.round(Math.abs(new Date(t).getTime()-new Date(e).getTime())/(1e3*60*60*24))}function pe(e,t,l){var f,a,c,u;(f=o[e])!=null&&f.date||(o[e].date=N);const n=((a=o[e])==null?void 0:a.vote_count)||100,d=n<100&&C(o[e].date,b)>0&&C((c=o[e])==null?void 0:c.release_date,b)<=50;C(o[e].date,b)>=O||d?(d?console.log("update recent movie:",e,",Age:",C((u=o[e])==null?void 0:u.release_date,b),"Vote count:",n):console.log("update old rating:",e,",Age:",C(o[e].date,b)),te(e,t,l)):ne(t,o[e],e)}function me(e){return e?e.toLowerCase().includes("tv")?"tv":e.toLowerCase().includes("movie")?"movie":null:null}async function K(){var n,d,f,a,c,u,i,S,_,B,h,I,V,L,z;m=window.location.href;let e=[];v?e=[document.querySelectorAll(".title-card .boxart-container:not(.imdb)")]:y?e=[document.querySelectorAll("a[data-testid='set-item']:not(.imdb)")]:D?e=[document.querySelectorAll(".swiper-slide img:not(.imdb)")]:w?e=[document.querySelectorAll("a[class*='StyledTileLinkNormal-Beam-Web-Ent']:not(.imdb)")]:A&&(e=[document.querySelectorAll("li:not(.imdb) article[data-card-title]:not([data-card-entity-type='EVENT']):not([data-card-title='Live-TV'])"),document.querySelectorAll("article[data-testid*='-card']:not(.imdb):not(:has(a#rating))")]);let t="",l=!1;for(let x=0;x<e.length;x++){const M=e[x];let p=null;for(let k=0;k<M.length;k++){const s=M[k];v||y||D||w?s.classList.add("imdb"):A&&(x==0?(n=s==null?void 0:s.closest("li"))==null||n.classList.add("imdb"):x==1&&(s==null||s.classList.add("imdb")));let r;if(v)r=(f=(d=s==null?void 0:s.parentElement)==null?void 0:d.getAttribute("aria-label"))==null?void 0:f.split(" (")[0],m.includes("genre/83")?p="tv":m.includes("genre/34399")&&(p="movie");else if(y)r=(c=(a=s==null?void 0:s.getAttribute("aria-label"))==null?void 0:a.replace(" Disney+ Original",""))==null?void 0:c.replace(" STAR Original",""),m.includes("entity")&&((u=document.querySelector('[aria-selected="true"]'))==null?void 0:u.id.split("_control")[0])!=((i=s.closest('div[role="tabpanel"]'))==null?void 0:i.id)&&(r=""),m.includes("browse/series")?p="tv":m.includes("browse/movies")?p="movie":/(Staffel)|(Nummer)|(Season)|(Episod)|(Number)/g.test(r??"")&&(p="tv"),F=="de"?r=r==null?void 0:r.replace(/Nummer \d* /,"").split(" Für Details")[0].split(" Staffel")[0].split("Staffel")[0].split(" Neue")[0].split(" Alle")[0].split(" Demnächst")[0].split(" Altersfreigabe")[0].split(" Mach dich bereit")[0].split(" Jeden")[0].split(" Noch")[0].split(" Premiere")[0]:F=="en"&&(r=r==null?void 0:r.replace(/Number \d* /,"").replace(" Select for details on this title.","").split(" Season")[0].split("Season")[0].split(" New ")[0].split(" All Episodes")[0].split(" Coming")[0].split(" Two-Episode")[0].split(" Rated")[0].split(" Prepare for")[0].split(" Streaming ")[0].replace(/ \d+ minutes remaining/g,""));else if(D)r=(S=s==null?void 0:s.getAttribute("alt"))==null?void 0:S.replace(/(S\d+\sE\d+)/g,"");else if(A){let q=function(T){var G,H,$,j,U,J,W,Y,P;return(P=(Y=(W=(J=(U=(j=($=(H=(G=T==null?void 0:T.split(" - ")[0])==null?void 0:G.split(" – ")[0])==null?void 0:H.replace(/(S\d+)/g,""))==null?void 0:$.replace(/ \[.*\]/g,""))==null?void 0:j.replace(/\s\(.*\)/g,""))==null?void 0:U.replace(/:?\sStaffel-?\s\d+/g,""))==null?void 0:J.replace(/:?\sSeason-?\s\d+/g,""))==null?void 0:W.replace(/ \/ \d/g,""))==null?void 0:Y.split(": Die komplette")[0])==null?void 0:P.split(": The complete")[0]};(B=(_=s.querySelector("a"))==null?void 0:_.href)!=null&&B.includes("detail")&&(x==0?r=q(s.getAttribute("data-card-title")??""):x==1&&(r=q(((h=s.querySelector("a"))==null?void 0:h.getAttribute("aria-label"))??""))),m.includes("video/tv")?p="tv":m.includes("video/movie")?p="movie":p=me(s.getAttribute("data-card-entity-type")??"")}else w&&(r=((I=s.querySelector("p[class*='md_strong-Beam-Web-Ent']"))==null?void 0:I.textContent)??"");(!y||!(s!=null&&s.classList.contains("_1p76x1y4")))&&r&&t!=r&&!r.includes("Netflix")&&!r.includes("Prime Video")&&(t=r,((V=o[r])!=null&&V.score||C((L=o[r])==null?void 0:L.date,b)<=7)&&(!p||((z=o[r])==null?void 0:z.media_type)==p)?pe(r,s,p):(te(r,s,p),l=!0))}}l&&setTimeout(function(){ee()},5e3)}function ye(e,t){return!e||t?"grey":e<=5.5?"red":e<=7?"rgb(245, 197, 24)":"rgb(0, 166, 0)"}function he(e,t){return`https://www.themoviedb.org/${t}/${e}`}async function ne(e,t,l){var f,a,c,u,i,S,_,B;let n;t!=null&&t.id?(n=document.createElement("a"),n.href=he(t.id,t.media_type),n.target="_blank"):n=document.createElement("div");const d=(t==null?void 0:t.vote_count)||100;if(n.id="rating",Object.assign(n.style,{position:"absolute",bottom:"0",color:"black",textDecoration:"none",background:ye(t==null?void 0:t.score,d<50),borderRadius:"5px",padding:"0 2px 0 2px",right:v?"0.2vw":"0",zIndex:y?"":"9999",fontSize:ae?"4vw":"1vw"}),(t==null?void 0:t.score)>=0){let h="";(f=g.value.Video)!=null&&f.showYear&&(t!=null&&t.release_date)&&(h=((a=new Date(t==null?void 0:t.release_date))==null?void 0:a.getFullYear())+"-"),n.textContent=h+((c=t.score)==null?void 0:c.toFixed(1)),n.setAttribute("alt",(t==null?void 0:t.title)+", OG title: "+l+", Vote count: "+d)}else n.textContent="?",n.setAttribute("alt",l),console.log("no score found:",l,t);if(v)(u=e.closest(".title-card-container"))==null||u.appendChild(n);else if(w)e.appendChild(n);else if(y){const h=e==null?void 0:e.closest("div");h&&(e.nextElementSibling&&(n.style.top=e.offsetHeight+"px",n.style.bottom=""),h.style.position="relative",h.appendChild(n))}else D?(i=e==null?void 0:e.parentElement)==null||i.appendChild(n):A&&(e.getAttribute("data-card-title")?(_=(S=e==null?void 0:e.firstChild)==null?void 0:S.firstChild)==null||_.appendChild(n):e.querySelector('div[data-testid="title-metadata-main"]')?(B=e.querySelector('div[data-testid="title-metadata-main"]'))==null||B.appendChild(n):e.appendChild(n))}function Q(){let e;y?e=Array.from(document.querySelectorAll("video")).find(t=>t.checkVisibility()):v||D||w?e=document.querySelector("video"):e=document.querySelector(ce),document.fullscreenElement&&e&&(e.play(),console.log("auto-played on fullscreen"),g.value.Statistics.SegmentsSkipped++,Z("increaseBadge",{},"background"))}async function be(){var e;(e=g.value.Video)!=null&&e.playOnFullScreen?addEventListener("fullscreenchange",Q):removeEventListener("fullscreenchange",Q)}export{ue as P,xe as c,we as p,Ce as s};
