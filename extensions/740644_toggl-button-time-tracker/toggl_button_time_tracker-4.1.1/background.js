import{D as d,l as s,i as Oe,w as Qe}from"./assets/errorReport.js";import{P as S,T as b,C as f,U as w,W as k,R as Xe,i as Ze,a as Q,e as et,b as N,c as Pe,d as Re}from"./assets/constants.js";import{B as c,b as l}from"./assets/browser-polyfill.js";import{F as z,W as U,c as Ae,T as tt,g as Ce,a as nt,O as le,U as de}from"./assets/UserUpdateService.js";import{i as W,d as rt,l as P,T as x,C as L,S as X,a as I,_ as it,D as O,b as E,c as Be,o as at,P as fe,O as Y}from"./assets/ProjectsCreateService.js";const st=async(e,t)=>{const n=await d.get("rememberProjectPer");if(n!=="none"){const r=await d.getLocal("defaultProjects")||"{}";await d.setLocal("defaultProjects",{...r,[n==="integration"?e.origin:e.url]:t!=null?t:void 0})}},ot=async(e,t)=>{var a,o,u,p,m;const n=e,r=await d.get("rememberProjectPer"),i=await d.get("defaultProject");if(t.type==="contentScript"&&r!=="none"&&!n.project_id){const _=await d.getLocal("defaultProjects")||{},T=await S.retrieve();n.project_id=r==="integration"?_[t.origin]:_[t.url],T&&(n.billable=n.billable||((o=T[(a=n.project_id)!=null?a:""])==null?void 0:o.billable),n.workspace_id=(m=(p=T[(u=n.project_id)!=null?u:""])==null?void 0:p.workspace_id)!=null?m:n.workspace_id)}if(!n.project_id&&i){const _=await S.retrieve();if(_){const T=_[i];n.project_id=i,n.workspace_id=T.workspace_id,n.billable=n.billable||_[i].billable}}return n},De=async e=>{var n;const t=Object.assign({},e);if(delete t.pid,delete t.tid,delete t.wid,delete t.uid,t.project_id){const r=await S.retrieve();if(r){const i=r[t.project_id];t.workspace_id=i.workspace_id}}if((n=t.tag_ids)!=null&&n.length){const r=await b.retrieve();r&&(t.tags=t.tag_ids.map(i=>{var a;return(a=r[i])==null?void 0:a.name}))}else t.tags=[];return delete t.tag_ids,t};async function ct(e){await c.action.setIcon({path:e?{19:"images/icon-19.png",38:"images/icon-38.png"}:{19:"images/inactive-19.png",38:"images/inactive-38.png"}})}async function ut(e){e?await c.action.setBadgeText({text:""}):await Promise.all([c.action.setBadgeText({text:"x"}),c.action.setBadgeTextColor({color:"#fff"}),c.action.setBadgeBackgroundColor({color:"#f00"})])}const lt=async(e,t)=>{try{if(t==="local"&&f.storageKey in e){const n=e[f.storageKey].newValue,r=n&&(n==null?void 0:n.duration)<0;await ct(r)}if(t==="local"&&w.storageKey in e){const n=e[w.storageKey].newValue;await ut(n)}}catch(n){s.error(n,"onIconHandlerStateChangeListener")}};class dt{constructor(){this.events={},this.state=W}async init({force:t=!1}={}){if(await this.fillSettings(),t)this.state={...W,duration:this.settings.focusDuration};else{const n=await this.getStoredState();n?this.state=n:this.state={...W,duration:this.settings.focusDuration}}this.emit("clock:init",this.getState()),this.emit("state:change",this.getState())}getStoredSettings(){return c.storage.sync.get("Settings.Pomodoro").then(t=>t["Settings.Pomodoro"])}setStoredSettings(t){return c.storage.sync.set({"Settings.Pomodoro":t})}getStoredState(){return c.storage.local.get("Pomodoro.State").then(t=>t["Pomodoro.State"])}async isSettingsStorageInitialized(){return await this.getStoredSettings()!==void 0}async fillSettings(){await this.isSettingsStorageInitialized()||await this.setStoredSettings(rt),this.settings=await this.getStoredSettings()}start(t=Date.now()){if(this.state.isRunning)return!1;this.state.isRunning=t,this.emit("clock:start",this.getState()),this.emit("state:change",this.getState())}goToBreak(t){this.state.isLargeBreak=this.isLargeBreakNeeded(),this.state.isBreak=!this.state.isLargeBreak,this.state.duration=this.state.isLargeBreak?this.settings.longBreakDuration:this.settings.breakDuration,this.pause(),t&&this.start()}goToFocus(t){if(this.state.isBreak=!1,this.state.isLargeBreak=!1,this.state.duration=this.settings.focusDuration,this.state.session<this.settings.sessions)this.state.session++;else return this.reset();this.pause(),t&&this.start()}pause(){this.state.isRunning&&(this.state.isRunning=null),this.emit("state:change",this.getState())}reset(){this.state={...W,duration:this.settings.focusDuration},this.emit("clock:reset",this.getState()),this.emit("state:change",this.getState())}goToNextState(){this.isOnBreak()?this.goToFocus(!1):this.goToBreak(this.settings.autoStartBreak),this.emit("state:change",this.getState())}isLargeBreakNeeded(){return this.state.session===this.settings.sessions}isOnBreak(){return this.state.isBreak||this.state.isLargeBreak}getState(){return{...this.state,computed:this.getComputedState()}}getComputedState(){return{isIdle:!this.state.isRunning&&!this.isOnBreak(),isIdleBreak:!this.state.isRunning&&this.isOnBreak(),isRunningBreak:!!this.state.isRunning&&this.isOnBreak(),isRunningFocus:!!this.state.isRunning&&!this.isOnBreak()}}getSettings(){return this.settings}on(t,n){this.events[t]||(this.events[t]=[]),this.events[t].push(n)}emit(t,...n){this.events[t]&&this.events[t].forEach(r=>r(...n))}}const g=new dt;function B(e){return e!=null&&typeof e=="object"&&e["@@functional/placeholder"]===!0}function A(e){return function t(n){return arguments.length===0||B(n)?t:e.apply(this,arguments)}}function Z(e){return function t(n,r){switch(arguments.length){case 0:return t;case 1:return B(n)?t:A(function(i){return e(n,i)});default:return B(n)&&B(r)?t:B(n)?A(function(i){return e(i,r)}):B(r)?A(function(i){return e(n,i)}):e(n,r)}}}function F(e,t){return Object.prototype.hasOwnProperty.call(t,e)}var ge=Object.prototype.toString,ft=function(){return ge.call(arguments)==="[object Arguments]"?function(t){return ge.call(t)==="[object Arguments]"}:function(t){return F("callee",t)}}(),gt=ft,pt=!{toString:null}.propertyIsEnumerable("toString"),pe=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],ye=function(){return arguments.propertyIsEnumerable("length")}(),yt=function(t,n){for(var r=0;r<t.length;){if(t[r]===n)return!0;r+=1}return!1},wt=A(typeof Object.keys=="function"&&!ye?function(t){return Object(t)!==t?[]:Object.keys(t)}:function(t){if(Object(t)!==t)return[];var n,r,i=[],a=ye&&gt(t);for(n in t)F(n,t)&&(!a||n!=="length")&&(i[i.length]=n);if(pt)for(r=pe.length-1;r>=0;)n=pe[r],F(n,t)&&!yt(i,n)&&(i[i.length]=n),r-=1;return i}),we=wt,ht=A(function(t){return t===null?"Null":t===void 0?"Undefined":Object.prototype.toString.call(t).slice(8,-1)}),he=ht;function mt(e){return e}var St=A(mt),vt=St;function me(e){for(var t=[],n;!(n=e.next()).done;)t.push(n.value);return t}function Se(e,t,n){for(var r=0,i=n.length;r<i;){if(e(t,n[r]))return!0;r+=1}return!1}function kt(e){var t=String(e).match(/^function (\w*)/);return t==null?"":t[1]}function _t(e,t){return e===t?e!==0||1/e===1/t:e!==e&&t!==t}var K=typeof Object.is=="function"?Object.is:_t;function ve(e,t,n,r){var i=me(e),a=me(t);function o(u,p){return ee(u,p,n.slice(),r.slice())}return!Se(function(u,p){return!Se(o,p,u)},a,i)}function ee(e,t,n,r){if(K(e,t))return!0;var i=he(e);if(i!==he(t)||e==null||t==null)return!1;if(typeof e["fantasy-land/equals"]=="function"||typeof t["fantasy-land/equals"]=="function")return typeof e["fantasy-land/equals"]=="function"&&e["fantasy-land/equals"](t)&&typeof t["fantasy-land/equals"]=="function"&&t["fantasy-land/equals"](e);if(typeof e.equals=="function"||typeof t.equals=="function")return typeof e.equals=="function"&&e.equals(t)&&typeof t.equals=="function"&&t.equals(e);switch(i){case"Arguments":case"Array":case"Object":if(typeof e.constructor=="function"&&kt(e.constructor)==="Promise")return e===t;break;case"Boolean":case"Number":case"String":if(!(typeof e==typeof t&&K(e.valueOf(),t.valueOf())))return!1;break;case"Date":if(!K(e.valueOf(),t.valueOf()))return!1;break;case"Error":return e.name===t.name&&e.message===t.message;case"RegExp":if(!(e.source===t.source&&e.global===t.global&&e.ignoreCase===t.ignoreCase&&e.multiline===t.multiline&&e.sticky===t.sticky&&e.unicode===t.unicode))return!1;break}for(var a=n.length-1;a>=0;){if(n[a]===e)return r[a]===t;a-=1}switch(i){case"Map":return e.size!==t.size?!1:ve(e.entries(),t.entries(),n.concat([e]),r.concat([t]));case"Set":return e.size!==t.size?!1:ve(e.values(),t.values(),n.concat([e]),r.concat([t]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var o=we(e);if(o.length!==we(t).length)return!1;var u=n.concat([e]),p=r.concat([t]);for(a=o.length-1;a>=0;){var m=o[a];if(!(F(m,t)&&ee(t[m],e[m],u,p)))return!1;a-=1}return!0}var Et=Z(function(t,n){return ee(t,n,[],[])}),bt=Et;function Tt(e,t,n){var r,i;if(typeof e.indexOf=="function")switch(typeof t){case"number":if(t===0){for(r=1/t;n<e.length;){if(i=e[n],i===0&&1/i===r)return n;n+=1}return-1}else if(t!==t){for(;n<e.length;){if(i=e[n],typeof i=="number"&&i!==i)return n;n+=1}return-1}return e.indexOf(t,n);case"string":case"boolean":case"function":case"undefined":return e.indexOf(t,n);case"object":if(t===null)return e.indexOf(t,n)}for(;n<e.length;){if(bt(e[n],t))return n;n+=1}return-1}function ke(e,t){return Tt(t,e,0)>=0}var xt=function(){function e(){this._nativeSet=typeof Set=="function"?new Set:null,this._items={}}return e.prototype.add=function(t){return!_e(t,!0,this)},e.prototype.has=function(t){return _e(t,!1,this)},e}();function _e(e,t,n){var r=typeof e,i,a;switch(r){case"string":case"number":return e===0&&1/e===-1/0?n._items["-0"]?!0:(t&&(n._items["-0"]=!0),!1):n._nativeSet!==null?t?(i=n._nativeSet.size,n._nativeSet.add(e),a=n._nativeSet.size,a===i):n._nativeSet.has(e):r in n._items?e in n._items[r]?!0:(t&&(n._items[r][e]=!0),!1):(t&&(n._items[r]={},n._items[r][e]=!0),!1);case"boolean":if(r in n._items){var o=e?1:0;return n._items[r][o]?!0:(t&&(n._items[r][o]=!0),!1)}else return t&&(n._items[r]=e?[!1,!0]:[!0,!1]),!1;case"function":return n._nativeSet!==null?t?(i=n._nativeSet.size,n._nativeSet.add(e),a=n._nativeSet.size,a===i):n._nativeSet.has(e):r in n._items?ke(e,n._items[r])?!0:(t&&n._items[r].push(e),!1):(t&&(n._items[r]=[e]),!1);case"undefined":return n._items[r]?!0:(t&&(n._items[r]=!0),!1);case"object":if(e===null)return n._items.null?!0:(t&&(n._items.null=!0),!1);default:return r=Object.prototype.toString.call(e),r in n._items?ke(e,n._items[r])?!0:(t&&n._items[r].push(e),!1):(t&&(n._items[r]=[e]),!1)}}var Lt=xt,Ot=Z(function(t,n){for(var r=new Lt,i=[],a=0,o,u;a<n.length;)u=n[a],o=t(u),r.add(o)&&i.push(u),a+=1;return i}),Pt=Ot,Rt=Pt(vt),At=Rt,Ct=Z(function(t,n){for(var r=0,i=t.length,a,o=n.length,u=[];r<i;){for(a=0;a<o;)u[u.length]=[t[r],n[a]],a+=1;r+=1}return u}),q=Ct;(()=>{const e=q(q(q(["h","hh","H","HH","k"],["m","mm",""]),[""," ",",",";",":","."]),["","aaa"," aaa"]).reduce((t,[[[n,r],i],a])=>{let o="";return r?o+=`${n}${i}${r}`:o+=n,n.includes("H")||n.includes("k")||(o+=a),t.push(o),t},[]);return At(e)})();const J=e=>e.duration<0,R=1e3,Bt=P.exports.debounce(async()=>{await z.handler()},R),Ie=P.exports.debounce(async e=>{await x.invoke(e?null:await x.since())},R),Dt=P.exports.debounce(async()=>{await L.invoke(await L.since())},R),It=P.exports.debounce(async()=>{await b.invoke(await b.since())},R),Ee=P.exports.debounce(async()=>{const e=await S.invoke(await S.since());Object.keys(e!=null?e:{}).length&&await Ie(!0)},R),Mt=P.exports.debounce(async()=>{await k.invoke(await k.since())},R),jt=P.exports.debounce(async e=>{await U.invoke(e,{store:!0})},R),Wt=P.exports.debounce(async e=>{const t=await f.retrieve();(t==null?void 0:t.id)===e.id&&(J(e)||g.reset())},R);async function Nt(e){switch(e.model){case"time_entry":{const t=await f.retrieve();if(Wt(e.data),J(e.data)||(t==null?void 0:t.id)===e.data.id)return f.store(Object.assign(e.data,{workspace_id:e.data.wid,project_id:e.data.pid,task_id:e.data.tid}));J(e.data)||(e.action==="delete"?await I.deleteFromStore(e.data.id):await I.updateStore(e.data));break}case"client":return Dt();case"group_entity_roles":case"user_entity_roles":return e.data.project_id?Ee():Bt();case"workspace":{const t=e.data.id,n=await w.retrieve(),r=[Mt()];return n&&await X.retrieve()===t&&r.push(jt(t)),Promise.all(r)}case"project":case"project_user":return Ee();case"tag":return It();case"task":return Ie();default:s.debug("Unidentified websocket event model: "+e.model)}}async function Ut(e){s.debug("WS::onDataReceived",e);try{await Nt(e)}catch(t){s.error(t,"Error in onWebSocketDataReceived")}}async function Ft(){var r;const e=Object.keys((r=await k.retrieve())!=null?r:{}),t=await k.invoke(await k.since()),n=Object.keys(t!=null?t:{});return!it.isEqual(e,n)}async function $t(){var e;s.debug("Lib::doFetchUsingSince");try{if(await w.invoke({store:!0}),await Ft()){await z.handler();return}await Promise.all([f.invoke({store:!0}),b.invoke(await b.since()),L.invoke(await L.since())]);const t=await S.invoke(await S.since(),{returnApiData:!0});await x.invoke(Object.keys(t!=null?t:{}).length===0?await x.since():null)}catch(t){t instanceof Xe&&((e=t.response)==null?void 0:e.status)!==403&&c.alarms.create(z.retryAlarmName,{when:Date.now()+5*60*1e3}),s.error(t)}}let Kt,te=!1;function qt(){(async()=>{try{s.debug("WS::onAuthenticated"),Kt||await $t(),te=!0}catch(e){s.error(e,"WS::onAuthenticated")}})()}function Me(){s.debug("WS::onWebsocketDisconnected"),te=!1}const je="WEBSOCKET_ALARM",$="WEBSOCKET_ALARM_RETRY",Vt=10/60,Ht=5*1e3,We=60*1e3;let y,ne=null;function Ne(){ne=Date.now()}function zt(){return new Promise((e,t)=>{chrome.cookies.get({url:"https://track.toggl.com",name:"__Secure-accounts-session"},n=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(n==null?void 0:n.value)})})}async function Yt(e){s.debug("WS::onSocketOpen",e),Ne();let t="";try{if(Ze()){const n=await zt(),r={type:"authenticate",auth_type:"oauth",token:n};t=JSON.stringify(r)}else{const n={type:"authenticate",auth_type:"cookie"};t=JSON.stringify(n)}y.send(t)}catch(n){s.error(n,"Error authenticating websocket")}}const Jt=()=>{const e=JSON.stringify({type:"pong"});try{y.send(e)}catch(t){s.error(t,"Error ponging websocket server")}};function Gt(e){Ne();const t=JSON.parse(e.data),n=!!t.model,r=!!t.session_id;n?Ut(t):!r&&!n?Jt():r&&qt()}const Qt=e=>{s.error(new Error(JSON.stringify(e)),"Websocket unexpected error"),Me()},Xt=async()=>{Me(),s.debug("WS::onSocketClose");const e=ne?Ht:We;try{await c.alarms.clear($),c.alarms.create($,{when:Date.now()+e})}catch(t){s.error(t,"Error setting up retry alarm")}};async function Zt(){const e=await w.retrieve();return!!(e!=null&&e.id)}async function en(){try{await c.alarms.clear($),c.alarms.create($,{when:Date.now()+We})}catch(e){s.error(e,"Error setting up authentication retry alarm")}}async function tn(){if(!((y==null?void 0:y.readyState)===WebSocket.OPEN||(y==null?void 0:y.readyState)===WebSocket.CONNECTING))try{if(!await Zt()){await en();return}ne=null,y=new WebSocket("wss://track.toggl.com/stream"),y.onopen=Yt,y.onmessage=Gt,y.onclose=Xt,y.onerror=Qt,await rn()}catch(e){s.error(e,"Error connecting to websocket")}}const nn=async()=>{s.debug("WS::reconnect"),y.close(),await Ue()},Ue=async()=>{await c.alarms.clear(je)},rn=async()=>{await Ue(),c.alarms.create(je,{periodInMinutes:Vt})},an=async(e,t)=>{var n,r;try{if(t==="local"&&w.storageKey in e){const i=(n=e[w.storageKey].newValue)==null?void 0:n.id;((r=e[w.storageKey].oldValue)==null?void 0:r.id)!==i&&(y&&await nn(),await tn())}}catch(i){s.error(i,"onWebsocketStateChangesListener")}},re="time-tracking-reminder",Fe="reminder-notification";async function G(){const e=await d.get("remindersCheckEnabled");await c.alarms.clear(re),e&&await sn()}async function sn(){const e=await d.get("remindersInterval");c.alarms.create(re,{periodInMinutes:e})}async function on(){await c.alarms.clear(re)}async function cn(){await c.notifications.clear(Fe),await d.set("remindersCheckEnabled",!1)}const un=(e,t)=>{try{t==="sync"&&(e.remindersCheckEnabled||e.remindersInterval)&&(s.debug("Reminders::onRemindersStateChangeListener",new Date),G()),t==="local"&&e[f.storageKey]&&(e[f.storageKey].newValue?(s.debug("Reminders::onRemindersStateChangeListener","alarm cleared on storage change"),on()):(s.debug("Reminders::onRemindersStateChangeListener","alarm configuring on storage change",new Date),G()))}catch(n){s.error(n,"onRemindersStateChangeListener")}},h={eventKey:"NOTIFY_USER_V4_E",create(e,t,n=2){return c.notifications.create({type:"basic",iconUrl:c.runtime.getURL("images/icon-128.png"),title:e,message:t,priority:n})},dispatch(e,t){return c.runtime.sendMessage({type:h.eventKey,payload:{title:e,message:t}})}};async function ie(e,t){var n,r,i;try{if(((n=e.response)==null?void 0:n.status)===401||((r=e.response)==null?void 0:r.status)===403)await c.storage.local.clear();else if(((i=e.response)==null?void 0:i.status)===404&&t){const a=await f.retrieve();(a==null?void 0:a.id)===t.id&&await f.clear()}}catch(a){s.error(a,"handleTimeEntryEndpointError")}}const ln=async(e,t)=>{try{const n=te?await f.retrieve():await f.invoke();n&&await C(n,null);const r=Object.assign({},e);delete r.stop;const{data:i}=await Q.workspaces.timeEntries.create({...r,created_with:`TrackExtension/4.1.1${t!=null&&t.source?`-${t.source}`:""}`});return i}catch(n){throw s.error(n),n}},j=async(e,t)=>{try{let n=await ot(e,t);n=await De(n),d.set(Ae.storage,"finished");const r=await ln(n,t);return g.getSettings().isEnabled&&g.start(new Date(r.start).getTime()),await f.store(r),r}catch(n){throw await ie(n),n}},$e=async(e,t,n={isManuallyStopped:!0})=>{try{t.type==="contentScript"&&st(t,e.project_id);const r=await De(e);delete r.stop;const{data:i}=await Q.workspaces.timeEntries.update(r),a=i.duration<0?i:null;return await f.store(a),g.getSettings().isEnabled&&n.isManuallyStopped&&a===null&&g.reset(),i}catch(r){throw s.error(r),await ie(r,e),r}},Ke=async e=>{try{const t=await f.retrieve();await Q.workspaces.timeEntries.delete(e.workspace_id,[e.id]),(t==null?void 0:t.id)===e.id&&g.reset()}catch(t){throw s.error(t),await ie(t,e),t}},be=Be({timeEntryConstraints:{id:"timeEntries.notifications.timeEntryConstraints",defaultMessage:"To stop the timer, add required {fields} field(s)."},requiredField:{id:"timeEntries.notifications.requiredFields",defaultMessage:"{field, select, description {description} tag {tag} project {project} task {task} other {Unknown}}"}});async function C(e,t,n={isManuallyStopped:!0}){var u,p;const r=t?O.fromISO(t):O.now(),i=O.fromISO(e.start);r<i&&await Ke(e);const a=await k.retrieve();let o=[];if(a&&e.workspace_id in a&&(o=tt.check((u=a[e.workspace_id].te_constraints)!=null?u:null,e)),o.length===0)return $e({...e,tag_ids:(p=e.tag_ids)!=null?p:[],stop:r.toISO(),duration:Math.floor(r.diff(i).as("seconds"))},{type:"popup"},n);throw new Error(E.formatMessage(be.timeEntryConstraints,{fields:E.formatList(o.map(m=>E.formatMessage(be.requiredField,{field:m})))}))}const dn=async()=>{const e=await f.invoke();e&&await C(e,null)},fn=async e=>{s.debug("stopTimeAtDayEnd::configureStopAtDayEnd:",e);let t=O.fromISO(e).set({second:0});t<O.now()&&(t=t.plus({days:1})),await l.exports.alarms.clear(M.name),l.exports.alarms.create(M.name,{when:t.toMillis(),periodInMinutes:60*24})},M={name:"STOP_AT_DAY_END",handler:async()=>{try{await dn()}catch(e){s.error(e),await h.create("Something went wrong",e.message)}},async configure(){const e=await d.get("stopAtDayEnd"),t=await d.get("dayEndTime");e?await fn(t):await M.clear()},async clear(){await l.exports.alarms.clear(M.name)}},gn=async(e,t)=>{try{t==="sync"&&(e.stopAtDayEnd||e.dayEndTime)&&await M.configure()}catch(n){s.error(n,"onStopAtDayEndStateChangesListener")}},pn=async(e,t)=>{try{if(t==="local"&&f.storageKey in e){const n=e[f.storageKey].oldValue,r=e[f.storageKey].newValue,i=g.getState();(n==null?void 0:n.id)===(r==null?void 0:r.id)&&(n==null?void 0:n.duration)!==(r==null?void 0:r.duration)&&(i==null?void 0:i.isRunning)&&await C(r,r.stop)}"Settings.Pomodoro"in e&&t==="sync"&&(g.reset(),await g.init({force:!0}))}catch(n){s.error(n,"onPomodoroV2StateChangesListener")}};d.addStateChangeListener((e,t)=>{lt(e,t),un(e,t),an(e,t),gn(e,t),at(e,t),pn(e,t)});const qe="idle-notification";async function yn(e,t){var n,r;try{await c.notifications.clear(qe);const i=t===1,a=await f.retrieve(),o=await d.getLocal("lastIdleTimeEntry");if(a&&o&&(await C(a,o.since),i)){const u=new Date,p={at:u.toISOString(),billable:a.billable,description:a.description,duration:-parseInt((u.getTime()/1e3).toFixed(0),10),start:u.toISOString(),tags:(n=a.tags)!=null?n:[],tag_ids:(r=a.tag_ids)!=null?r:[],task_id:a.task_id,project_id:a.project_id,workspace_id:a.workspace_id};await j(p,{type:"contentScript"})}}catch(i){s.error(i,"Error processing idleNotificationClickHandler"),await h.create("Something went wrong",i.message)}}async function Ve(){s.debug("Idle::configureIdleDetector");const e=await d.get("idleInterval");c.idle.setDetectionInterval(Number(e))}c.storage.onChanged.addListener(async(e,t)=>{t==="sync"&&"idleInterval"in e&&await Ve()});c.notifications.onButtonClicked.addListener((e,t)=>{e===qe?yn(e,t):e===Fe&&cn()});let V;function wn(){if(!V){const e=new Uint8Array(100);crypto.getRandomValues(e);let t="";for(let n=0;n<e.length;++n)t+=e[n].toString(36);V=t}return V}l.exports.runtime.onMessage.addListener(e=>{if(typeof e=="string"&&e.includes("worker_proxy"))return Promise.resolve(wn())});const hn=async()=>{try{const e=await c.windows.getAll({windowTypes:["popup"]});await Promise.all(e.map(async t=>t.id&&await c.windows.remove(t.id)))}catch(e){s.error(e,"sounds.ts - closePopups")}},mn=e=>{let t=chrome.runtime.getURL("src/content/audio/index.html");t+=`?volume=${e.volume}&src=${e.src}&length=${e.audioLength}`,c.windows.create({type:"popup",focused:!1,top:0,left:0,width:1,height:1,url:t})},He=async e=>{try{if(!chrome.offscreen){mn({src:e.src,volume:e.volume,audioLength:e.audioLength});return}await chrome.offscreen.hasDocument()||await chrome.offscreen.createDocument({url:"src/content/offscreen/index.html",reasons:["AUDIO_PLAYBACK"],justification:"Play pomodoro alerts"}),await c.runtime.sendMessage({type:"OFFSCREEN_PLAY_POMODORO_SOUND",payload:{src:e.src,volume:e.volume,audioLength:e.audioLength}})}catch(t){s.error(t,"playSoundV2")}},Sn=async()=>{const e=await g.getStoredSettings();!e.isAlarmEnabled||await He({src:c.runtime.getURL("sounds/time_is_up_1.mp3"),audioLength:2e3,volume:e.alarmVolumePercent})},ze=async e=>{const t=await g.getStoredSettings();!t.isTickingEnabled||await He({src:c.runtime.getURL("sounds/tick-tock.mp3"),audioLength:e*1e3,volume:t.alarmVolumePercent})},vn=async()=>{if(chrome.offscreen)return c.runtime.sendMessage({type:"OFFSCREEN_PLAY_POMODORO_SOUND_STOP"});await hn()};c.runtime.onConnect.addListener(e=>{e.name==="POPUP"&&(e.onMessage.addListener(t=>{t.type==="Pomodoro.start"&&g.start(),t.type==="Pomodoro.goToNextState"&&g.goToNextState()}),e.onDisconnect.addListener(()=>{s.debug("POPUP channel disconnected.")}))});g.init();g.on("clock:init",e=>{c.alarms.clear("Pomodoro.Alarm");try{if(e.isRunning){const t=Ce(e.isRunning,e.duration);c.alarms.create("Pomodoro.Alarm",{when:Date.now()+t*1e3}),!e.isBreak&&!e.isLargeBreak&&ze(t)}}catch(t){s.error(t)}});g.on("clock:start",e=>{try{if(e.isRunning){const t=Ce(e.isRunning,e.duration);c.alarms.create("Pomodoro.Alarm",{when:Date.now()+t*1e3}),!e.isBreak&&!e.isLargeBreak&&ze(t)}}catch(t){s.error(t)}});g.on("clock:reset",()=>{c.alarms.clear("Pomodoro.Alarm"),vn()});g.on("state:change",async e=>{try{const t=g.getSettings();if(await c.storage.local.set({"Pomodoro.State":e}),e.computed.isIdle&&e.session>1&&await h.create("Back to Work!","Let's dive into another focused session."),e.isBreak&&!e.isRunning&&await h.create("Take a Break!","Time to rest and recharge for a bit."),e.isLargeBreak&&await h.create("Long Break Time!",`Relax for ${t.longBreakDuration/60} minutes. You've earned it!`),e.isBreak||e.isLargeBreak){const n=await f.retrieve();n&&await C(n,O.fromISO(n.start).plus({seconds:t.focusDuration}).toISO(),{isManuallyStopped:!1})}(e.computed.isIdleBreak||e.computed.isIdle&&e.session>1)&&await Sn()}catch(t){s.error(t)}});class kn{constructor(t){this.config=t}async sendRequest(t,n){const r=`${this.config.baseUrl}${t}`;s.debug("Sending HEAP Request",r);try{const i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(s.debug("HEAP Request Sent, status:",i.status),!i.ok)throw new Error(`HTTP error! status: ${i.status}`);return i.text()}catch(i){s.debug("Failed to send HEAP Request",i.message)}return Promise.reject(new Error("Failed to send HEAP Request"))}track(t){var n;return this.sendRequest("/track",{app_id:this.config.defaultAppId,identity:t.identity,event:t.event,timestamp:(n=t.timestamp)!=null?n:new Date().toISOString(),properties:t.properties})}dispatch(t){return c.runtime.sendMessage({type:"HEAP_EVENT_TRACK",payload:t})}}const _n=new kn({baseUrl:"https://heapanalytics.com/api",defaultAppId:"3384833326"});function Te(e,t){const[n,r,i]=e.split(".").map(Number),[a,o,u]=t.split(".").map(Number);return n>a?1:n<a?-1:r>o?1:r<o?-1:i>u?1:i<u?-1:0}const En={version:"4.1.0",name:"Pomodoro v4 settings migration",run:async function(){const{pomodoroModeEnabled:t}=await c.storage.sync.get("pomodoroModeEnabled"),{pomodoroSoundEnabled:n}=await c.storage.sync.get("pomodoroSoundEnabled"),{pomodoroSoundVolume:r}=await c.storage.sync.get("pomodoroSoundVolume"),{pomodoroInterval:i}=await c.storage.sync.get("pomodoroInterval");if(!t)return;await g.fillSettings();const a=g.getSettings();await g.setStoredSettings({...a,isEnabled:t,focusDuration:i*60,isAlarmEnabled:n,alarmVolumePercent:r})}},bn=[En];async function Tn(e){try{s.info(`Updated from ${e.previousVersion} to 4.1.1.`);const t="4.1.1",n=await xn();if(Te(n,t)>=0)return;for(const r of bn)Te(r.version,t)>=0&&(s.info(`Running migration: ${r.name}`),await r.run());await Ln(t)}catch(t){s.error(t,"runMigration")}}async function xn(){const{migrationVersion:e}=await c.storage.sync.get("migrationVersion");return e!=null?e:"0.0.0"}async function Ln(e){await c.storage.sync.set({migrationVersion:e})}const On=e=>{l.exports.scripting.executeScript({target:{tabId:e},files:["./login.js"]})},H=async(e,t)=>{s.debug("adding content scripts"),await l.exports.scripting.insertCSS({target:{tabId:e},files:["src/content/style.css"]}).catch(n=>s.error(n)),await l.exports.scripting.executeScript({target:{tabId:e},files:["src/content/index.js"]}).catch(n=>s.error(n)),l.exports.scripting.executeScript({target:{tabId:e},files:[`src/content/${t}`]}).catch(n=>s.error(n))},Pn=async(e,t)=>{var m,_,T,ae,se,oe,ce;if(t.url===void 0)return;try{if((await l.exports.tabs.sendMessage(e,{type:"ping"})).type==="pong")return}catch(v){s.debug(v)}const n=et(t.url),r=N(t.url);if(r.includes("toggl.com")||r.includes("toggl.space"))return On(e);const i=await d.get("integrations"),a=await d.get("customIntegrations"),o=await d.get("customScripts"),u=N(t.url);if((!i||!i[n])&&!(a!=null&&a[u])&&!(o!=null&&o[u]))return;const p=Pe[n];if(p){const v=(m=p==null?void 0:p.file)!=null?m:`${p.name.toLocaleLowerCase().replace(" ","-")}.js`;i&&i[n]&&H(e,v)}else if(((_=a==null?void 0:a[u])==null?void 0:_.name)||((T=a==null?void 0:a[u])==null?void 0:T.file)){const v=(se=(ae=a==null?void 0:a[u])==null?void 0:ae.file)!=null?se:`${a[u].name.toLocaleLowerCase().replace(" ","-")}.js`;v&&H(e,v)}if(o!=null&&o[u]){const v=u,ue=(ce=(oe=o==null?void 0:o[v])==null?void 0:oe.file)!=null?ce:`${o[v].name.toLocaleLowerCase().replace(" ","-")}.js`;ue&&H(e,ue)}},D=Be({startTimerWithDescription:{id:"contextMenu.startTimerWithDescription",defaultMessage:"Start timer with description"},startTimer:{id:"contextMenu.startTimer",defaultMessage:"Start timer"},disableTinyButton:{id:"contextMenu.disableTinyButton",defaultMessage:"Disable tiny button on this page"},enableTinyButton:{id:"contextMenu.enableTinyButton",defaultMessage:"Re-enable tiny button on this page"}}),xe=async(e,t)=>{try{e.menuItemId==="TrackExtension"||e.menuItemId==="TrackExtensionSelection"?await An(e,t):await Rn(e,t)}catch(n){s.error(n),await h.create("Something went wrong",n.message)}},Rn=async(e,t)=>{const n=await d.get("tinyButtonBlocklist"),r=N(t.url),i=!n.includes(r);i?await d.set("tinyButtonBlocklist",[...n,r]):await d.set("tinyButtonBlocklist",n.filter(a=>a!==r)),await l.exports.tabs.sendMessage(t.id,{type:i?"hide-tiny-button":"show-tiny-button"}),await l.exports.contextMenus.update("TrackExtensionDisableTinyButton",{title:i?E.formatMessage(D.enableTinyButton):E.formatMessage(D.disableTinyButton)})},An=async(e,t)=>{const n=O.now(),r=(e==null?void 0:e.selectionText)||t.title,i={at:n.toISO(),billable:!1,description:r,duration:-parseInt((n.toMillis()/1e3).toFixed(0),10),start:n.toISO(),tags:[],tag_ids:[],workspace_id:await X.retrieve()};await j(i,{type:"contentScript"})},Cn=async e=>{const t=await d.get("showRightClickButton"),n=await d.get("tinyButtonBlocklist"),r=(n!=null?n:[]).includes(N(e.url||""));try{await l.exports.contextMenus.remove("TrackExtension")}catch{}try{await l.exports.contextMenus.remove("TrackExtensionSelection")}catch{}try{await l.exports.contextMenus.remove("TrackExtensionDisableTinyButton")}catch{}t&&(l.exports.contextMenus.create({id:"TrackExtension",title:E.formatMessage(D.startTimer),contexts:["page"]}),l.exports.contextMenus.create({id:"TrackExtensionSelection",title:E.formatMessage(D.startTimerWithDescription)+" '%s'",contexts:["selection"]})),await d.get("enableTinyButton")&&l.exports.contextMenus.create({id:"TrackExtensionDisableTinyButton",title:r?E.formatMessage(D.enableTinyButton):E.formatMessage(D.disableTinyButton),contexts:["page"]}),l.exports.contextMenus.onClicked.removeListener(xe),l.exports.contextMenus.onClicked.addListener(xe)},Bn=async(e,t)=>{if(t.url!==void 0){try{if((await c.tabs.sendMessage(e,{type:"ping-tiny-button"})).type==="pong-tiny-button")return}catch(n){s.debug(n)}c.scripting.executeScript({target:{tabId:e},files:["src/tinyButton.js"]}).catch(n=>s.error(n))}},Dn={type:"popup"},In=()=>{l.exports.windows.onRemoved.addListener(async function(){try{if(!await d.get("stopAutomatically"))return;if((await l.exports.windows.getAll()).length<=0){const n=await f.retrieve();n&&await C(n,null)}}catch(e){s.error(e),await h.create("Error stopping time entry",e.message)}}),l.exports.windows.onCreated.addListener(async()=>{var e;try{if((await l.exports.windows.getAll()).length>1||!await d.get("startAutomatically"))return!1;const n=await I.invoke({store:!0}),i=Object.values(n).pop();if(!i||i.duration<0)return;const a=O.now();await j({...i,start:a,duration:-parseInt((a.toMillis()/1e3).toFixed(0),10),stop:void 0,tag_ids:(e=i.tag_ids)!=null?e:[]},Dn)}catch(t){s.error(t),await h.create("Something went wrong",t.message)}})};In();M.configure();Ve();G();l.exports.permissions.onAdded.addListener(e=>{var t;(t=e.origins)!=null&&t.includes("<all_urls>")&&d.set("integrations",Object.keys(Pe).reduce((n,r)=>(n[r]=!0,n),{})).then(()=>{d.set(Ae.storage,"all_enabled")})});l.exports.tabs.onUpdated.addListener(async(e,t,n)=>{const r=await d.get("enableTinyButton");t.status==="complete"&&(Re()||await l.exports.scripting.executeScript({target:{tabId:e},files:["worker_proxy.js"]}).catch(i=>s.error(i)),Cn(n),Pn(e,n),r&&Bn(e,n))});l.exports.runtime.onInstalled.addListener(async e=>{if(s.debug("SW::onInstalled"),e.reason==="install"&&(Re()?await l.exports.tabs.create({url:l.exports.runtime.getURL("src/pages/dataConsent/index.html")}):await l.exports.tabs.create({url:l.exports.runtime.getURL("src/pages/postInstallLP/index.html")})),e.reason==="update"){const t=await d.get("showChangelog");(t||t===void 0)&&await l.exports.tabs.create({url:l.exports.runtime.getURL("settings.html#/whats-new")})}await Tn(e)});l.exports.commands.onCommand.addListener(async e=>{await Oe(),Qe(function(){e==="quick-start-stop-entry"&&I.retrieve().then(async t=>{var r,i,a;const n=Object.values(t!=null?t:{}).sort((o,u)=>o.start>u.start?-1:u.start>o.start?1:0);if(((r=n[0])==null?void 0:r.duration)<0)await C(n[0],null);else{const o=new Date,u=n[0],p={at:o.toISOString(),billable:!1,description:u.description,duration:-parseInt((o.getTime()/1e3).toFixed(0),10),start:o.toISOString(),tags:(i=u.tags)!=null?i:[],tag_ids:(a=u.tag_ids)!=null?a:[],project_id:u.project_id,workspace_id:u.workspace_id};await j(p,{type:"contentScript"})}}).catch(t=>{s.debug(t),h.create("Error",t.message)})})});const Ye=async(e=!1)=>{var t;try{return await w.invoke({store:!0}),Promise.all([f.invoke({store:!0}),b.invoke(null),x.invoke(null),L.invoke(null),S.invoke(null),k.invoke(null),Y.invoke(),U.invoke((t=await X.retrieve())!=null?t:0,{store:!0})])}catch(n){if(s.debug(n),e)throw n}},Je=async()=>{await l.exports.storage.local.clear()};var Le;const Ge=(Le="https://accounts.toggl.com/track".includes("toggl.space"))!=null?Le:!1,Mn=async(e,t)=>{if(t&&!Ge)return;const n=await w.retrieve();(n==null?void 0:n.id)!==e&&(await Je(),await Ye())};l.exports.runtime.onMessage.addListener(async e=>{var t;switch(await Oe(),s.debug(`SW::onMessage -> at: ${Date.now()}`,e),typeof e=="object"?e.type:""){case w.eventKey:return w.invoke({store:!0});case de.eventKey:return de.invoke(e.payload);case f.eventKey:return f.invoke({store:!0});case I.eventKey:return I.invoke({store:!0});case b.eventKey:return b.invoke(await b.since());case x.eventKey:return x.invoke(await x.since());case L.eventKey:return L.invoke(await L.since());case S.eventKey:return S.invoke(await S.since());case k.eventKey:return k.invoke(await k.since());case Y.eventKey:return Y.invoke();case le.eventKey:return le.invoke();case fe.eventKey:return fe.invoke(e.payload.data,e.payload.workspaceId);case"CREATE_TAG_V4":return nt.create(e.payload.name,e.payload.workspaceId);case h.eventKey:return h.create(e.payload.title,e.payload.message);case w.logoutKey:return w.logout();case U.eventKey:return U.invoke(e.payload.workspaceId,{store:!0});case"HEAP_EVENT_TRACK":return _n.track(e.payload);case"start-entry":return j(e.payload.entry,e.payload.from);case"update-entry":return $e(e.payload.entry,e.payload.from);case"delete-entry":return Ke(e.payload);case"activate":return Ye((t=e==null?void 0:e.payload)==null?void 0:t.forwardError);case"VERIFY_USER":return Mn(e.payload.userId,e.payload.isStaging);case"CLEAR_DATA":return e.payload.isStaging&&!Ge?void 0:Je();case"testing":s.debug("payload: ",e.payload);break;default:s.debug("nothing")}});
//# sourceMappingURL=background.js.map
