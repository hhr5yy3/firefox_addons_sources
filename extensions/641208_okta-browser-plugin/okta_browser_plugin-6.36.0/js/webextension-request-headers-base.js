Okta.RequestHeadersBase=function(e,t,s,r,i){var u={};var c=Okta.Constants.Auth0;var n=Okta.fn.url.isOktaPage;var o=Okta.fn.url.isOktaAppSSOPath;var l=Okta.fn.url.replaceUrlPartsPath;var d=Okta.fn.url.hrefToUrlParts;var f=Okta.fn.api.prependPath;var p=Okta.fn.storage.siteFlowDataToFlow;var h=Okta.fn.accounts.changeActiveAccount;var v=Okta.Q;var g=Okta.Url;var a=Okta._okta;var m=a.find;var k=a.isNumber;var S=a.each;var w=a.extend;var A=a.now;var I=a.partial;var L=a.size;var b=Okta.fn.browserType;var U=Okta.fn.promises.pollP;var C=Okta.fn.base.emptyOrTimeout;var O=b.isSafariWebExt(t);var R="DOMAINS";var E=String.fromCharCode.apply(null,[79,75,84,65,95,65,67,67,79,85,78,84,95,87,72,73,84,69,95,76,73,83,84]);var P="DBG_PLUGIN_SETTINGS";var N="WebExtension::onAuth0BeforeRedirect: ";var _="WebExtension::onPOktaAppHomeRedirect: ";var y="WebExtension::onPOktaAppLoginRedirect: ";var T="WebExtension::onPOktaNewIDPInitUrlDetected: ";var F=[302];var x=[302];var q=1e3*60*30;var z=O?{urls:["https://*.auth0.com/authorize*"]}:{urls:["https://*.auth0.com/authorize?*"]};var D={urls:["https://personal.trexcloud.com/home/*/*/*","https://personal.okta.com/home/*/*/*","https://personal.clouditude.com/home/*/*/*"]};var M={urls:["https://personal.trexcloud.com/login/token/redirect?stateToken=*","https://personal.okta.com/login/token/redirect?stateToken=*","https://personal.clouditude.com/login/token/redirect?stateToken=*"]};function G(){var e=["https://personal.okta.com","https://personal.trexcloud.com","https://personal.clouditude.com"];if(Okta.Config.allowLocalHostOrServer){e.push("http://localhost");e.push("https://rain.okta1.com");e.push("https://personal.okta1.com")}return e}u.pOktaNewArchitectureIDPRegexStr=G().map(function(e){return"^"+e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"/okta-personal-app/"+"([0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12})/launch(\\/?|\\?.*)$"}).join("|");if(Okta.Config&&Okta.Config.allowLocalHostOrServer){D.urls.push("https://rain.okta1.com/home/*/*/*");D.urls.push("https://personal.okta1.com/home/*/*/*");D.urls.push("https://qa-plugin-fpa-idx.trexcloud.com/home/*/*/*");M.urls.push("https://rain.okta1.com/login/token/redirect?stateToken=*");M.urls.push("https://personal.okta1.com/login/token/redirect?stateToken=*");M.urls.push("https://qa-plugin-fpa-idx.trexcloud.com/login/token/redirect?stateToken=*")}var H=function(e){var t=e.queryKey;return e.path==="/authorize"&&!!t.client_id&&!!t.redirect_uri&&!!t.scope&&!!t.state};var B=function(){return s.getPluginSettings().then(function(e){return e&&e.orgSettings&&e.orgSettings.pluginPersonalFastIdpEnabled})};var $=function(e){return r.makeGetRequestWithToken(e).then(function(e){if(e&&e.errorCode){Log.warn(_+"failed to obtain sites, error code: {0} and summary: {1}",e.errorCode,e.errorSummary);return}return v.all([s.setMonitoredSites(e.site),s.setAuthSites(e.authSite),s.setFormSitesNoPw(e.formSites),s.setSocialSites(e.socialSites)])}).fail(function(e){Log.warn(_+"failed to obtain sites, error: "+e)})};var K=function(o,e,a,t){var i=t?_:y;return r.makeGetRequest(e,t).then(function(e){if(e&&e.errorCode){Log.warn(i+"failed to obtain site-flow, error code: {0} and summary: {1}",e.errorCode,e.errorSummary);return}var t={flow:e,message:a.matchedSite.progressMessage,statusURI:a.matchedSite.callbackURI};var r=p(t);var n=w({},a,{requestComplete:true});Log.info(i+"successfully obtained site-flow, will update tab storage");delete Q[o];return v.all([s.setCurrentFlow(r,o),s.setCurrentFastIdpApp(n,o)])}).fail(function(e){Log.warn(i+"failed to obtain site-flow, error: "+e)})};var W=function(e,t){if(!e.url||!e.redirectUrl||!k(e.tabId)||!k(e.statusCode)){Log.info(t+"url, redirectUrl, tabId or statusCode is missing");return false}if(!x.includes(e.statusCode)||e.method!="GET"){Log.info(t+"statusCode or method mismatch");return false}return true};var j=function(e){if(!W(e,_)){return false}if(!o(new g(e.redirectUrl))){Log.info(_+"redirectUrl is not appSSO url");return false}return true};var X=function(e){if(!W(e,y)){return false}if(n(new g(e.redirectUrl))){Log.info(y+"redirectUrl is still okta page, exit");return false}return true};var Y=function(r){return s.getMonitoredSites().then(function(e){var t=m(e,function(e){return r.startsWith(e.siteURL)});return t})};u.HeaderConstants={EXTENDED_USER_AGENT_KEY:"X-Okta-User-Agent-Extended",PLUGIN_USER_AGENT_VALUE:"okta-browser-plugin/"+e,EXTENDED_PLUGIN_ACCOUNTS_USER_AGENT_KEY:"X-Okta-User-Agent-Account-Data"};u.getStorageCache=function(){return{domains:{key:R,val:null},dbgPluginSettings:{key:P,val:null},allowListedAccounts:{key:E,val:null}}};u.onAuth0BeforeRedirect=function(a){return s.getPluginSettings().then(function(e){if(!e||!e.orgSettings||!e.orgSettings.pluginSocialLoginEnabled){return}if(!k(a.tabId)){return}if(!F.includes(a.statusCode)||a.method!="GET"){Log.info(N+"statusCode or method mismatch");return}var t=new g(a.url);if(!H(t)){Log.info(N+"not a valid auth0 authorize call");return}if(c.POktaIdPDomain.includes(t.host)){Log.info(N+"authorize from POkta Idp, skip");return}var r=m(a.responseHeaders,function(e){return e.name.toLowerCase()==="x-auth0-requestid"});if(!r){Log.info(N+"no auth0 x-auth0-requestid header");return}var n=t.queryKey;var o={signOnMode:"oauth_authorize",audience:decodeURIComponent(n.audience),host:t.host,auth0Client:n.auth0Client,clientId:n.client_id,scope:decodeURIComponent(n.scope),redirectUri:decodeURIComponent(n.redirect_uri),timeStamp:a.timeStamp};return s.setCurrentSelfServiceAppCredentials(o,a.tabId)})};var Q={};var V=function(e,t){S(Q,function(e,t){if(e.timestamp+q<A()){delete Q[t]}});t.timestamp=A();Q[e]=t;Log.info("stored pOkta fastIdP info on tab {0}, current size: {1}",e,L(Q))};u.onPOktaAppHomeRedirect=function(t){return B().then(function(e){if(!e){return}if(!j(t)){return}var n=t.redirectUrl;var o=new g(n);var a=t.tabId;var i={appSSOUrl:n};return s.setCurrentFastIdpApp(i,a).then(I(Y,n)).then(function(e){if(!e){Log.warn(_+"siteUrl {0} is not in MonitoredSites, will try to resync app cache",n);var t=l(o,f("/sites"));return $(t).then(I(Y,n))}return e}).then(function(e){if(!e){Log.warn(_+"siteUrl {0} is not in MonitoredSites after syncing app cache, exit",n);return}var t=w({},i,{matchedSite:e});V(a,t);var r=l(o,e.scriptURI);return K(a,r,t,true)})})};u.onPOktaAppLoginRedirect=function(s){return B().then(function(e){if(!e){return}if(!X(s)){return}var t=s.tabId;var r=Q[t];if(!r||!r.appSSOUrl||!r.matchedSite){Log.warn(y+"missing fast IdP data in the previous redirection, exit");return}var n=r.appSSOUrl;var o=r.matchedSite;var a=new g(n);var i=l(a,o.scriptURI);return K(t,i,r,false).fin(function(){Log.info(y+"request done, deleting fastIdp data on tab");delete Q[t]})})};u.makeSiteFlowNoCredsCallAndUpdateTabStorage=function(o,e,a){return r.makeGetRequest(e,true).then(function(e){if(e&&e.errorCode){Log.warn(T+"failed to obtain site-flow, error code: {0} and summary: {1}",e.errorCode,e.errorSummary);return}var t={flow:e,message:a.matchedSite.progressMessage,statusURI:a.matchedSite.callbackURI};var r=p(t);var n=w({},a,{requestComplete:true});Log.info(T+"successfully obtained site-flow, will update tab storage");delete Q[o];return v.all([s.setCurrentFlow(r,o),s.setCurrentFastIdpApp(n,o)])}).fail(function(e){Log.warn(T+"failed to obtain site-flow, error: "+e)})};u.initiateSiteFlowNoCredsRequestNoCreds=function(e){var t=e.url;var n=new g(t);var o=e.tabId;var a={appSSOUrl:t};return s.setCurrentFastIdpApp(a,o).then(I(Y,t)).then(function(e){if(!e){throw Error("No matching site found.")}return e}).then(function(e){var t=w({},a,{matchedSite:e});V(o,t);var r=l(n,e.scriptURI);return u.makeSiteFlowNoCredsCallAndUpdateTabStorage(o,r,t)})};u.findAppInstanceId=function(e){var t=/\b[A-Fa-f0-9]{8}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{12}\b/;var r=e.match(t);if(r){return r[0]}return null};u.getAllMonitoredSites=function(){return v.all([s.getAllMonitoredSites(),s.getAllTabs()]).spread(function(e,i){var s={};if(e&&e.length>0){e.forEach(function(e){var t=e.data;var a=e.account.index;if(t&&t.length>0){t.forEach(function(e){var t=e.siteURL;var r=u.findAppInstanceId(t);var n=i.filter(function(e){return e.account.index===a})[0]?.data;var o=n&&n.appLinks.find(function(e){return e.appInstanceId===r});if(o){s[e.siteURL]={loginRedirectUrl:o.loginRedirectUrl,accountIndex:a}}})}})}return s}).fail(function(e){i.amplitudeEvents.trackErrorAppLaunchFailFetchMonitoredSites(e,{userAction:"Failed to fetch all monitored sites from storage"})})};function J(e){var t=new URL(e);t.search="";return t.toString()}u.navigateToAppLoginUrl=function(o,a){return u.getAllMonitoredSites().then(function(e){a=J(a);var t=e[a];if(t){return h(s,t.accountIndex).fail(function(e){i.amplitudeEvents.trackErrorAppLaunchChangeActiveAccount(e,{userAction:"Failed to change a user's active account"});throw e}).finally(function(){chrome.tabs.update(o,{url:t.loginRedirectUrl})})}else{const r="No matching URL found for: "+a;const n=new Error(r);i.amplitudeEvents.trackErrorAppLaunchNoMatchingUrlFound(n,{userAction:"No matching app url found in plugin monitored sites"});throw n}}).fail(function(e){i.amplitudeEvents.trackErrorAppLaunchUrlNavigation(e,{userAction:"Failed to navigate to app login page"});throw e})};u.onPOktaNewIDPInitUrlDetected=function(n){Log.info(T+"chrome.webNavigation.onBeforeNavigate: "+n.url);var e=u.findAppInstanceId(n.url);if(e){return v.all([chrome.tabs.update(n.tabId,{url:"/SigningIn.html"}),new Promise(e=>setTimeout(e,1e3))]).then(function(){return U(s.getSyncingOktaPersonalDashboard,I(C,30*1e3),500).then(function(){return u.navigateToAppLoginUrl(n.tabId,n.url).then(function(){return s.setCurrentFlowAppInstanceId(e,n.tabId).then(function(){return u.initiateSiteFlowNoCredsRequestNoCreds(n)})}).catch(function(e){const t=new URL(n.url).hostname;const r=`/SigningInError.html?hostname=${t}`;chrome.tabs.update(n.tabId,{url:r});throw e})}).catch(function(){})})}};var Z={};u.getPluginAuthorizeResponseParams=function(e,t){var r=`${e.state}_${e.nonce}`;var n=v.defer();Z[r]=n;var o=t?.timeout||Okta.Constants.AuthOptions.TIMEOUT_BG;return n.promise.timeout(o,new Error("Authorize flow timed out")).fin(function(){delete Z[r];Log.info(`Authorize resp ${r} is fulfilled and deleted`)})};u.interceptPluginAuthorizeRedirectLocation=function(e){var t=d(e.url);var r=`${t.queryKey.state}_${t.queryKey.nonce}`;var n=Z[r];if(!n){Log.warn("can not find deferred by state and nonce for request: "+e.url);return}if(e.statusCode===404){n.reject({code:"client_not_found",error_description:"authorize 404, please check client App and corresponding FF"});return}if(e.statusCode!=302){n.reject({code:"response_not_redirect",error_description:`authorize response status ${e.statusCode}`});return}var o=e.responseHeaders&&e.responseHeaders.find(e=>{return e.name&&e.name.toLowerCase()==="location"});if(!o){n.reject({code:"no_location_header",error_description:"no location header in authorize response"});return}var a=o.value;var i=d(a);var s=i.queryKey;n.resolve(s)};u.initialize=function(){chrome.webRequest.onBeforeRedirect.addListener(u.onAuth0BeforeRedirect,z,["responseHeaders"]);chrome.webRequest.onBeforeRedirect.addListener(u.onPOktaAppHomeRedirect,D);chrome.webRequest.onBeforeRedirect.addListener(u.onPOktaAppLoginRedirect,M);chrome.webNavigation.onBeforeNavigate.addListener(u.onPOktaNewIDPInitUrlDetected,{url:[{urlMatches:u.pOktaNewArchitectureIDPRegexStr}]});chrome.webRequest.onHeadersReceived.removeListener(u.interceptPluginAuthorizeRedirectLocation);chrome.webRequest.onHeadersReceived.addListener(u.interceptPluginAuthorizeRedirectLocation,{urls:["*://*/oauth2/v1/authorize?*"],types:["xmlhttprequest"],tabId:chrome.tabs.TAB_ID_NONE},["responseHeaders"])};return u};