function drawMessage(msg,img){img=$("<img />").attr("src",img).css({margin:"auto",width:"128px",height:"auto"}),msg=$("<div />").text(browser.i18n.getMessage(msg)).css({margin:"auto","font-weight":"bold"}),img=$("<div />").addClass("popup_center").append(img).append(msg);$("#content").empty(),$("#content").css({height:"100%",display:"flex"}).append(img)}function yesOrNo(l){return l?"Yes":"no"}function getContainerDebugString(container,secretSquirrel){return"true"===secretSquirrel?"Autofill: "+yesOrNo(container.Autofill)+", Autosubmit: "+yesOrNo(container.Autosubmit)+", Exact domain check: "+yesOrNo(container.MatchSubdomain):""}async function drawContainers(containers){var profiles=await loadDatabaseProfiles(),secretSquirrel=await getIndexedDBrecord("options","secretSquirrel");if($("#content").css({"text-align":"left",height:"100%",display:"block"}).empty(),null==containers||containers.length<=0)drawMessage("passwordsempty","../img/image_eye.png");else for(var i=0;i<containers.length;i++){var container=containers[i];if(null!=container.Urls){var name=(name=container.ContainerName)||browser.i18n.getMessage("no_name"),userName=(userName=container.ContainerUserName)||"",url=(url=container.Urls[0])||"",outlookContainer=$("<div />").prop("id",container.ContainerId).prop("tabindex",i).addClass("menu_entry").click(function(e){onContainerClick($(this))}).keydown(function(e){13===e.keyCode&&onContainerClick($(this))}).attr("title",getContainerDebugString(container,secretSquirrel)),name=(container.Color&&outlookContainer.css({"border-left":"5px solid "+container.Color}),$("<span />").text(name).addClass("container_name")),userName=$("<span />").text(userName).addClass("container_username"),url=$("<span />").text(url).addClass("container_url");const databaseProfile=profiles.find(p=>p.profileId===container.ProfileId),profileId=databaseProfile?databaseProfile.profileId:null,containerId=container.ContainerId;var openInWebClientItem=$("<img />").attr("src","../img/image_open_in_webapp.svg").css({position:"absolute",bottom:20,right:container.HasOtpField?75:55,visibility:"hidden",display:databaseProfile&&databaseProfile.webClientUrl?void 0:"none",padding:"2px",height:"20px",width:"20px"}).addClass("open_in_webclient button_item").hover(onButtonHover,onButtonLeave).click(event=>{event.stopPropagation(),extension.setOpenInWebClientProfileId(profileId),browser.tabs.create({url:new URL(databaseProfile.webClientUrl+"/password/edit/"+containerId).href})}).prop("tag",container.ContainerId).attr("title",browser.i18n.getMessage("open_in_webclient")).prop("alt",browser.i18n.getMessage("open_in_webclient")),copyUserName=$("<img />").attr("src","../img/image_copy_username.svg").css({position:"absolute",bottom:20,right:container.HasOtpField?55:35,visibility:"hidden",padding:"2px",height:"20px",width:"20px"}).addClass("copy_username button_item").hover(onButtonHover,onButtonLeave).click(copyUserNameClick).prop("tag",container.ContainerId).attr("title",browser.i18n.getMessage("copy_username_clipboard")).prop("alt",browser.i18n.getMessage("copy_username_clipboard")),copyPassword=$("<img />").attr("src","../img/image_copy_password.svg").css({position:"absolute",bottom:20,right:container.HasOtpField?35:15,visibility:"hidden",padding:"2px",height:"20px",width:"20px"}).addClass("copy_password button_item").hover(onButtonHover,onButtonLeave).click(copyPasswordClick).prop("tag",container.ContainerId).attr("title",browser.i18n.getMessage("copy_password_clipboard")).prop("alt",browser.i18n.getMessage("copy_password_clipboard"));let copyToken;container.HasOtpField&&(copyToken=$("<img />").attr("src","../img/image_copy_token.svg").css({position:"absolute",bottom:20,right:15,visibility:"hidden",padding:"2px",height:"20px",width:"20px"}).addClass("copy_otp button_item").hover(onButtonHover,onButtonLeave).click(copyOtpTokenClick).prop("tag",container.ContainerId).prop("title",browser.i18n.getMessage("copy_token")).prop("alt",browser.i18n.getMessage("copy_token"))),$(outlookContainer).mouseover(function(){$(this).find(".button_item").css({visibility:"visible"})}),$(outlookContainer).mouseleave(function(){$(this).find(".button_item").css({visibility:"hidden"})}),$(outlookContainer).append(name,userName,url,openInWebClientItem,copyUserName,copyPassword),copyToken&&$(outlookContainer).append(copyToken),$("#content").append(outlookContainer)}}}(window.screenLeft<0||window.screenTop<0||window.screenLeft>window.screen.width||window.screenTop>window.screen.height)&&chrome.runtime.getPlatformInfo(function(info){"mac"===info.os&&((info=new CSSStyleSheet).insertRule(`
        @keyframes redraw {
          0% {
            opacity: 1;
          }
          100% {
            opacity: .99;
          }
        }
      `),info.insertRule(`
        html {
          animation: redraw 1s linear infinite;
        }
      `),document.adoptedStyleSheets=[...document.adoptedStyleSheets,info])}),setTimeout(async()=>{focusSearch(),await changeInfoPanel()},100);let clientAuthInformation,uiUserFields=[],changePasswordData=null,daysTillMspTrialExpiry=void 0,daysTillExpiryDisplay,dayText,username=$("#server_username").val();async function passwordLogin(){return performAuthFlowLogin()}async function performAuthFlowLogin(){try{var initialAuthRunData,result,profile=await this.getActiveProfile(),username=$("#server_username").val();showLoader(),$("#login").hide(),clearErrorText();let authResult=clientAuthInformation?.authRunData?.originalAuthenticationResult;if($("#server_username").is(":visible")||!authResult){if(!username||""===username.trim())return;authResult=await sendMessagePromise({command:"GetFirstAuthentication",profile:profile,username:username})}if(clientAuthInformation?.authRunData){clientAuthInformation.authResult.userFields=uiUserFields.map(uf=>uf.toUserField()),clientAuthInformation.authRunData.userFields=uiUserFields.map(uf=>uf.toUserField());const allUserFields=clientAuthInformation.authRunData.allUserFields;for(const userField of clientAuthInformation.authResult.userFields){var uf=Object.keys(allUserFields).flatMap(k=>allUserFields[k]).find(f=>f.key===userField.key);uf&&(uf.value=userField.value)}}clientAuthInformation?.authResult?.userFields&&!clientAuthInformation.authResult.userFields.every(f=>!!f.value)||(initialAuthRunData={database:profile.databaseName,username:username,userGreetName:authResult?.UserName,allUserFields:{}},authResult.$type.includes("AuthenticationUserKeySignatureRequirement")&&(clientAuthInformation.authRunData.encryptionVersion=authResult.EncryptionVersion),result=await sendMessagePromise({command:"Authenticate",authResult:authResult,authRunData:clientAuthInformation?.authRunData||initialAuthRunData}),await handleAuthenticationResult(clientAuthInformation=result))}catch(err){await handleAuthenticationError(err)}finally{hideLoader(),$("#login").show()}}function parseTypeFromTypeString(typeString){typeString=/\.(\w*),/.exec(typeString);return typeString&&typeString[1]?typeString[1]:""}function setWelcomeMessage(authType){var firstCredReq;$("#welcome-description").removeClass("text-left").removeClass("welcome-description-qr-code"),"change-2fa"===authType?$("#welcome-description").text(browser.i18n.getMessage("ChooseYourSecondAuthenticator")):authType.includes("GoogleAuthConfigurationRequirement")?($("#welcome-title").text(""),$("#welcome-description").addClass("text-left").addClass("welcome-description-qr-code"),$("#welcome-description").text(browser.i18n.getMessage(authType+"Desc"))):authType.includes("OidcCredentialRequirement")?(firstCredReq=(clientAuthInformation?.authRunData?.originalAuthenticationResult)?.PossibleAuthenticationCredentialRequirements[0])?.ProviderId&&$("#welcome-description").text(browser.i18n.getMessage("OidcCredentialRequirementDesc"+firstCredReq.ProviderId)):authType&&$("#welcome-description").text(browser.i18n.getMessage(authType+"Desc"))}function setNextButtonText(authType){return"DeleteFactorConfigurationRequirement"===authType?$("#button_next").text(browser.i18n.getMessage("NextStepButtonActionDeleteFactor")):"PasswordHashAuthConfigurationRequirement"===authType?$("#button_next").text(browser.i18n.getMessage("NextStepButtonSave")):"GoogleAuthCredentialRequirement"===authType||"SafeNetOneTimePasswordCredentialRequirement"===authType||"RsaSecurIdTokenCredentialRequirement"===authType||"Fido2CredentialRequirement"===authType?$("#button_next").text(browser.i18n.getMessage("NextStepButtonActionSecondFactor")):"YubicoOneTimePasswordCredentialRequirement"===authType?$("#button_next").text(browser.i18n.getMessage("NextStepButtonActionSecurityKey")):authType.includes("ConfigurationRequirement")?$("#button_next").text(browser.i18n.getMessage("NextStepButtonActionConfigure")):authType.includes("OidcCredentialRequirement")?(authType=(clientAuthInformation?.authRunData?.originalAuthenticationResult)?.PossibleAuthenticationCredentialRequirements[0])?.ProviderId?$("#button_next").text(browser.i18n.getMessage("NextStepButtonOidc"+authType.ProviderId)):$("#button_next").text(browser.i18n.getMessage("NextStepButtonOidc")):$("#button_next").text(browser.i18n.getMessage("NextStepButtonActionAuthenticate"))}async function handleAuthenticationResult(result,isPendingState){result.profile&&await finalizeLogin(result.profile,result.username),result.authRunData?.userGreetName&&$("#welcome-title").text(browser.i18n.getMessage("hello").format(result.authRunData.userGreetName));let authType=parseTypeFromTypeString(clientAuthInformation.authResult.userFieldType);var qrString,allUserFields;!authType&&clientAuthInformation.authResult.configurationRequirements&&(authType="change-2fa",show2faSelector(clientAuthInformation.authResult.configurationRequirements,async selectedRequirement=>{clientAuthInformation.authRunData.selectedRequirement=selectedRequirement,clientAuthInformation.authResult=await sendMessagePromise({command:"GetHandledRequirement",configRequirement:selectedRequirement,authRunData:clientAuthInformation.authRunData}),$("#button_next").show(),await handleAuthenticationResult(clientAuthInformation)}),$("#button_next").hide()),setWelcomeMessage(authType),setNextButtonText(authType),result.authResult.loginLock?($("#back_enter_username").show(),await handleUserLock(result.authResult.loginLock)):(clientAuthInformation.authRunData.userFields=clientAuthInformation.authResult.userFields,result.authResult.userFields&&(clearNewAuthFlowFields(),result.authResult.userFields.find(field=>"secret"===field.key)&&(qrString=result.authResult.userFields.find(field=>"secret"===field.key).value.toString(),$("#welcome-description-container").prepend($("<img/>").attr("src",qrString).prop("class","mto-qr-code"))),createDynamicFields(uiUserFields=result.authResult.userFields.map(uf=>new InputField(uf.name,uf.type,uf.key,"secret"===uf.key?uf.requirement.SecretBase32:uf.value))),$("#back_enter_username").show(),qrString=clientAuthInformation.authResult.userFieldType,allUserFields=clientAuthInformation.authRunData.allUserFields,qrString)&&!allUserFields[qrString]&&(allUserFields[qrString]=clientAuthInformation.authResult.userFields)),!isPendingState&&isActionlessLoginRequirement(result.authResult?.userFieldType)?await performAuthFlowLogin():result.authResult?.userFieldType?.includes("PasswordHashAuthConfigurationRequirement")&&handlePasswordHashAuthConfigurationRequirement(result)}function isActionlessLoginRequirement(classType){if(classType)for(const loginRequirement of["Fido2ConfigurationRequirement","Fido2CredentialRequirement","OidcCredentialRequirement"])if(classType.includes(loginRequirement))return!0;return!1}async function handleAuthenticationError(err){if(err.requirementName&&err.humanReadableName)console.warn("Unsupported authentication requirements: ",err.requirementName),alert(browser.i18n.getMessage("unsupported_authentication_requirement").format(err.humanReadableName));else if("FIDO2 was cancelled"===err.message)console.warn(err),alert(browser.i18n.getMessage("authentication_process_canceled"));else if(!0===err.isFetchError){var msg=browser.i18n.getMessage("error_login_server_unreachable");let url=(await getActiveProfile()).endpoint;var urlText=url=0!==url.indexOf("https://")?"https://"+url:url;setErrorText(msg,url,urlText)}else setErrorText(getErrorText(err)),console.error(err)}function handlePasswordHashAuthConfigurationRequirement(result){result=result.authResult.originalAuthenticationResult?.PossibleAuthenticationConfigurationRequirements.find(r=>r.$type.includes("PasswordHashAuthConfigurationRequirement"));result&&(changePasswordData={passwordQualityLevel1:result.PasswordQualityLevel1Percentage,passwordQualityLevel2:result.PasswordQualityLevel2Percentage,passwordPolicy:JSON.parse(result.PasswordPolicy),newPassword:"",newPasswordRepetition:"",validationError:""},showPasswordReset())}function createDynamicFields(fieldsToCreate){if(fieldsToCreate){var newAuthFlowFieldDiv=$("#newAuthFlowFields");for(const field of fieldsToCreate)newAuthFlowFieldDiv.append(field.createHtml());this.clearFields(),newAuthFlowFieldDiv.show(),setTimeout(()=>fieldsToCreate.find(f=>!f.getFieldValue()).focus())}else console.error("ERROR - NO FIELDS TO CREATE")}function clearNewAuthFlowFields(){[].slice.call(document.getElementById("newAuthFlowFields").children).forEach(c=>c.remove()),$(".mto-qr-code").remove()}function clearFields(){$("#enter_username").hide(),$("#enter_password").hide()}function addNewAuthFlowFieldToUi(){this.clearFields(),$("#newAuthFlowFields").show()}function showPasswordReset(){this.clearFields(),$("#welcome-description").text(""),$("#button_next").text(browser.i18n.getMessage("save")),uiUserFields=[],$("#newAuthFlowFields").empty(),$("#password_reset").show(),setTimeout(()=>$("#newPassword1").focus()),onChangePasswordValueChanged(),setSubmitEnabledState()}function displayPasswordResetValidationError(){var container=$("#change_password_validation_message_container");changePasswordData.validationError?(container.show(),$("#change_password_validation_message").text(changePasswordData.validationError)):container.hide()}function onNewPasswordValueChanged(event){changePasswordData.newPassword=event.target.value,clientAuthInformation.authResult.userFields.find(f=>"new-password"===f.key).value=event.target.value,onChangePasswordValueChanged()}function onNewPasswordConfirmationValueChanged(event){changePasswordData.newPasswordRepetition=event.target.value,onChangePasswordValueChanged()}async function onChangePasswordValueChanged(){if(changePasswordData.newPassword){const passwordPolicyErrors=await sendMessagePromise({command:"ValidateUserPassword",policy:changePasswordData.passwordPolicy,password:changePasswordData.newPassword});var exCodes=passwordPolicyErrors.errors;if(exCodes&&exCodes.length)exCodes=exCodes.map(code=>browser.i18n.getMessage("error_"+code).format(passwordPolicyErrors.missingCategoryCount)),changePasswordData.validationError=exCodes.join(", "),displayPasswordResetValidationError(),setSubmitEnabledState();else{const allUserFields=clientAuthInformation.authRunData.allUserFields;exCodes=Object.keys(allUserFields).find(key=>allUserFields[key].some(f=>"password"===f.key)),exCodes=allUserFields[exCodes]?.find(f=>"password"===f.key);exCodes&&(exCodes.value===changePasswordData.newPassword?changePasswordData.validationError=browser.i18n.getMessage("pw_reset_must_be_different"):changePasswordData.newPassword!==changePasswordData.newPasswordRepetition?changePasswordData.validationError=browser.i18n.getMessage("pw_reset_differs_from_confirmation"):changePasswordData.validationError="",displayPasswordResetValidationError(),setSubmitEnabledState())}}else changePasswordData.validationError="",displayPasswordResetValidationError()}function setSubmitEnabledState(){var disabled=!!changePasswordData?.validationError||!!currentUserLock;$("#button_next").prop("disabled",disabled)}function showOldPassword(){$("#enter_username").hide(),$("#back_enter_username").show(),$("#enter_password").show(),$("#server_password").focus(),$("#welcome-description").text(browser.i18n.getMessage("enterPassword")),$("#button_next").text(browser.i18n.getMessage("authenticate"))}async function onPopupKeyDown(e){$("#login").is(":visible")?(13!=e.keyCode||$("#button_next").prop("disabled")||"INPUT"!==window.document.activeElement?.tagName||await passwordLogin(),window.document.activeElement===$("#server_username").get(0)&&(currentMfa=null,await clearLockInterval(),clearErrorText())):(e.shiftKey&&9===e.keyCode?(e.preventDefault(),e.keyCode=38):9===e.keyCode?(e.preventDefault(),e.keyCode=40):13===e.keyCode&&popupMoveFocusDown(),40===e.keyCode?(e.preventDefault(),popupMoveFocusDown()):38===e.keyCode&&(e.preventDefault(),popupMoveFocusUp()))}function popupMoveFocusUp(){document.activeElement===$("#search").get(0)?$(".menu_entry:last-child").focus():document.activeElement===$(".menu_entry:first-child").get(0)?focusSearch():$(".menu_entry:focus").prev().focus()}function popupMoveFocusDown(){document.activeElement===$("#search").get(0)?$(".menu_entry:first-child").focus():document.activeElement===$(".menu_entry:last-child").get(0)?focusSearch():$(".menu_entry:focus").next().focus()}function onButtonHover(){"IMG"===this.tagName?$(this).css("background-color","#C3C3C3"):$(this).css("background-color","#CDE6F7")}function onButtonLeave(){$(this).css("background-color","")}function searchCurrentUrlContainers(cont,url){var result=[];if(null!=url&&""!=url)for(var i=0;i<cont.length;i++)checkSsoContainerUrl(cont[i],url)&&result.push(cont[i]);return result}function utf8Decode(value){return decodeURIComponent(escape(value))}function checkSsoContainerUrl(ssoContainer,url){for(var lowerCaseUrl=url.toLowerCase(),i=0;i<ssoContainer.Urls.length;i++)if(-1<ssoContainer.Urls[i].toLowerCase().indexOf(lowerCaseUrl))return!0;return!1}function focusSearch(){$("#search").focus().select()}function cleanSearch(search){return search=(search=0===(search=0===search.indexOf("-")?search.slice(1,search.length):search).indexOf('"')?search.slice(1,search.length):search).indexOf('"')===search.length-1?search.slice(0,search.length-1):search}function searchTextInContainerFound(container,inqlude){var found=[];for(let i=0;i<inqlude.length;i++){var searchText=cleanSearch(inqlude[i]);if(container.ContainerName&&-1!==container.ContainerName.toLowerCase().indexOf(searchText))found.push(inqlude[i]);else if(container.ContainerUserName&&-1!==container.ContainerUserName.toLowerCase().indexOf(searchText))found.push(inqlude[i]);else if(null!==container.Urls&&0<container.Urls.length)for(var u=0;u<container.Urls.length;u++)if(-1<container.Urls[u].toLowerCase().indexOf(searchText)){found.push(inqlude[i]);break}}return JSON.stringify(inqlude)==JSON.stringify(found)}function negationTextInContainer(container,searchText){if(container.ContainerName&&-1!==container.ContainerName.toLowerCase().indexOf(searchText))return!0;if(container.ContainerUserName&&-1!==container.ContainerUserName.toLowerCase().indexOf(searchText))return!0;if(null!==container.Urls&&0<container.Urls.length)for(var i=0;i<container.Urls.length;i++)if(-1<container.Urls[i].toLowerCase().indexOf(searchText))return!0;return!1}function searchTextOccurrence(container,exqlude,inqlude){for(let i=0;i<exqlude.length;i++)if(negationTextInContainer(container,cleanSearch(exqlude[i])))return!1;return!!(0<inqlude.length&&searchTextInContainerFound(container,inqlude))}async function filterContainers(){if(profilesActive)containersFromLastServerQuery=[];else if(isServerConnected(sessions)){var searchText=$("#search").val()?.toLowerCase();if(isServerConnected(sessions)&&searchText){let foundContainers=[];try{foundContainers=await sendMessagePromise({command:"SearchForContainer",search:searchText})}catch{foundContainers=!1}if(!1!==foundContainers&&Array.isArray(foundContainers)){if(containersFromLastServerQuery=foundContainers,await saveIndexedDBrecord("options",searchText,"lastsearch"),0<foundContainers.length)return void await drawContainers(foundContainers.sort(function(c1,c2){return c1.ContainerName.localeCompare(c2.ContainerName)}))}else containersFromLastServerQuery=[]}let activeUrl="";activeTab&&(activeUrl=activeTab.url);var matchingContainers=[];let sortedContainers;if(searchText){let queries=searchText.match(/-{0,1}"[^"]*"|[^\s"]+/g);for(var exclude=(queries=queries?queries.slice(0,10):[""]).filter(q=>0===q.indexOf("-")),inqlude=queries.filter(q=>0!==q.indexOf("-")),i=0,l=containers.length;i<l;i++){var current=containers[i];searchTextOccurrence(current,exclude,inqlude)&&matchingContainers.push(current)}sortedContainers=matchingContainers.sort(function(c1,c2){return c1.ContainerName.localeCompare(c2.ContainerName)}).splice(0,MAX_CONTAINERS)}else matchingContainers=getMatchingContainersForUrl(containers,activeUrl),sortedContainers=orderByRelevance(matchingContainers,MAX_CONTAINERS);await drawContainers(sortedContainers),await saveIndexedDBrecord("options",searchText,"lastsearch")}else containersFromLastServerQuery=[],await showProfiles()}function onContainerClick(e){e=$(e).prop("id");extension.onContainerClicked(e),window.close()}function copyUserNameClick(e){if(isServerConnected(sessions)){var container=containers.find(c=>c.ContainerId==this.tag)||containersFromLastServerQuery.find(c=>c.ContainerId==this.tag);if(null==container)return;copyTextToClipboard(container.ContainerUserName);container=browser.i18n.getMessage("copy_clipboard_msg").format(container.ContainerName,browser.i18n.getMessage("server_username"));showNotification(container)}else extension.copyToClipboard("ContainerItemUserName",this.tag);e.stopPropagation()}async function copyPasswordClick(e){if(e.stopPropagation(),isServerConnected(sessions)){let container=containers.find(c=>c.ContainerId==this.tag)||containersFromLastServerQuery.find(c=>c.ContainerId==this.tag);container&&(await isProtected(container.ContainerId)?showNotification(browser.i18n.getMessage("error_clipboard_protected")):await isSealed(container.ContainerId)?showNotification(browser.i18n.getMessage("password_is_sealed")):(e=await isSecretReasonRequired(this.tag)?window.prompt(browser.i18n.getMessage("revealPasswordReason"),browser.i18n.getMessage("revealPasswordReasonDescription")):browser.i18n.getMessage("clipboard_reason"),getItemData(this.tag,e,"1",(name,value)=>{copyTextToClipboard(value);value=browser.i18n.getMessage("copy_clipboard_msg").format(container.ContainerName,name);showNotification(value)})))}else extension.copyToClipboard("ContainerItemPassword",this.tag)}async function copyOtpTokenClick(e){if(e.stopPropagation(),isServerConnected(sessions)){let container=containers.find(c=>c.ContainerId==this.tag)||containersFromLastServerQuery.find(c=>c.ContainerId==this.tag);container&&(e=await isSecretReasonRequired(this.tag,16)?window.prompt(browser.i18n.getMessage("token_reason_title"),browser.i18n.getMessage("token_reason")):browser.i18n.getMessage("clipboard_reason"),getItemData(this.tag,e,16,(name,value)=>{let msg="";(msg=value&&"object"==typeof value&&value.hasOwnProperty("OneTimePassword")?(copyTextToClipboard(value.OneTimePassword),browser.i18n.getMessage("copy_clipboard_msg").format(container.ContainerName,name)):browser.i18n.getMessage("no_otp_field_or_secret").format(container.ContainerName))&&showNotification(msg)}))}}function copyTextToClipboard(text){copyToClipboard(text)}function reloadContainersClick(){$("#loader").is(":visible")||isServerConnected(sessions)&&extension.refreshData()}function generatePassword(){browser.runtime.sendMessage({command:"GeneratePassword"},copyToClipboard)}function onTemplateClick(){extension.createTemplate(),window.close()}async function changeInfoPanel(){var infoMessage=await getInfoMessage();infoMessage?($("#info_panel").show(),$("#info_panel_message").text(infoMessage)):$("#info_panel").hide()}async function localize(){var selectedProfile;$("#search").prop("placeholder",browser.i18n.getMessage("search")),$("#button_refresh").text(browser.i18n.getMessage("reload_containers")),document.getElementById("button_generate_password").title=browser.i18n.getMessage("generate_password_and_copy_to_clipboard"),$("#button_transfer_database_profile").text(browser.i18n.getMessage("transfer_database_profile")),$("#button_template").text(browser.i18n.getMessage("create_template")),$("#button_server_login").text(browser.i18n.getMessage("server_login")),$("#label_webclienturl").text(browser.i18n.getMessage("webclient_url")),$("#action").prop("title",browser.i18n.getMessage("show_profiles")),$("#info_panel [data-action=show_never_again]").text(browser.i18n.getMessage("never_show_again")),$("#info_panel [data-action=close]").text("x"),$("#server_username").prop("placeholder",browser.i18n.getMessage("server_username")),$("#server_password").prop("placeholder",browser.i18n.getMessage("server_password")),$("#back_enter_username").text(browser.i18n.getMessage("change_user")),$("#return_password_list_link").text(browser.i18n.getMessage("return_password_list")),$("#welcome-title").text(browser.i18n.getMessage("welcome")),$("#password_change_warning_user").text(browser.i18n.getMessage("pw_reset_warning")),$("label[for=newPassword1]").text(browser.i18n.getMessage("login_change_password_new_password")+":"),$("label[for=newPassword2]").text(browser.i18n.getMessage("login_change_password_confirm_password")+":"),databaseIdClicked&&(selectedProfile=await loadDatabaseProfile(databaseIdClicked),$(".mto-qr-code").remove(),$("#welcome-description").text(browser.i18n.getMessage("welcomeDescription").format(selectedProfile.databaseName)),$("#welcome-description").removeClass("text-left").removeClass("welcome-description-qr-code")),$("#button_next").text(browser.i18n.getMessage("next"))}let searchTimeout;function addEvents(){$(document).keydown(onPopupKeyDown),$("#search").focus().on("textInput input",function(evt){clearTimeout(searchTimeout),searchTimeout=setTimeout(async function(){await filterContainers()},300)}),$("#search").on("keyup",async event=>{13===event.keyCode&&"secret squirrel"===$("#search").val().toLowerCase()&&(event="true"===await getIndexedDBrecord("options","secretSquirrel"),await saveIndexedDBrecord("options",(!event).toString(),"secretSquirrel"),showNotification("Secret Squirrel "+(event?"deactivated":"activated")))}),$(".button_item, .nav_button").hover(onButtonHover,onButtonLeave),$("#button_info").hover(changeInfoPanel,changeInfoPanel),$("#button_refresh").click(reloadContainersClick),$("#button_generate_password").click(generatePassword),$("#back_enter_username").click(async function(){await sendMessagePromise({command:"SetPendingAuthInformation",pendingAuthInformation:null}),clearErrorText(),showLogin(!1)}),$("#button_transfer_database_profile").click(transferDatabaseProfile),$("#button_template").click(onTemplateClick),$("#action").click(onProfilesClick),$("#button_next").click(passwordLogin),$("#msp-trial-banner-dont-show").click(mspBannerOnDontShowClicked),$("#msp-trial-banner-close").click(mspBannerClose),$("#search").on("focus",()=>{setTimeout(()=>$("#search").select(),0)}),$("#return_password_list_link").click(hideProfiles),$("#newPassword1").on("input",onNewPasswordValueChanged),$("#newPassword2").on("input",onNewPasswordConfirmationValueChanged)}function setVisibility(){var showTransferDatabaseProfile=activeTab&&activeTab.isWebClientLoggedIn&&!isServerConnected(sessions);$("#button_info").css("display",showTemplateInfo?"inline":"none"),$("#button_template").css("display",optionCanAddTemplate?"inline":"none"),$("#button_refresh").css("display",showTransferDatabaseProfile?"none":"inline"),$("#button_transfer_database_profile").css("display",showTransferDatabaseProfile?"inline":"none")}function updateProfiles(profile){profile&&(databaseIdClicked=profile.profileId,$("#server_username").val(profile.userName),$("#server_password").focus(),localize())}function transferDatabaseProfile(){extension.addDatabaseProfileOfActiveTab()}async function onProfilesClick(){$("#loader").is(":visible")||(profilesActive?await hideServerMode():await showServerMode())}async function showServerMode(){profilesActive=!0,await showProfiles()}async function hideServerMode(){profilesActive=!1,await hideProfiles()}async function onProfileChanged(){var profileId=databaseIdClicked;null!=profileId&&(null==currentMfa&&null==currentUserLock||(extension.cleanSessions(),await clearLockInterval(),currentMfa=null),clearErrorText(),hideLoader(),$("#server_password").val(""),$(".mfa").remove(),$("#enter_mfa").hide(),$("#newAuthFlowFields").hide(),$("#2faSelector").hide(),$("#password_reset").hide(),null!==(profileId=await loadDatabaseProfile(profileId)))&&(await saveIndexedDBrecord("options",profileId.profileId,"lastProfileSelection"),isServerConnected(sessions)&&$("#profile_tutorial").hide(),$("#login, #content").hide(),showLogin(!1),null!=profileId.userName)&&$("#server_username").val(profileId.userName)}async function onLogoutClick(){$("#msp-trial-banner").hide(),this.daysTillMspTrialExpiry=void 0;var activeProfile=await getActiveProfile();null!=activeProfile&&(await extension.logout(activeProfile.profileId),refreshFromBackground(async()=>{await onProfileChanged()}))}function showOptions(){browser.runtime.openOptionsPage()}async function showProfiles(){$("#search-container, #msp-trial-banner, #content, #login, #profile_tutorial, #enter_password, #back_enter_username, #password_reset").hide(),$("#server_mode_login").css("display","flex");var profiles=await loadDatabaseProfiles();profiles&&profiles.length?$("#login").show():($("#profile_tutorial").show(),initializeProfileTutorial()),$("#action").prop("src","../img/image_search.png").prop("title",browser.i18n.getMessage("show_records")),isServerConnected(sessions)?$("#action").show():$("#action").hide(),await onProfileChanged()}function initializeProfileTutorial(){document.getElementById("profile_tutorial_content").textContent||$("#profile_tutorial_content").append($("<div>").text(browser.i18n.getMessage("no_database_profile")).css({"font-weight":"bold","text-align":"center","margin-bottom":"20px"})).append($("<div>").text(browser.i18n.getMessage("profile_create_database_info")).css({"margin-bottom":"12px"})).append($("<div>").append($("<span>").text(browser.i18n.getMessage("profile_create_automatically_bold")).css({"font-weight":"bold"})).append($("<span>").text(browser.i18n.getMessage("profile_create_automatically")))).append($("<div>").text(browser.i18n.getMessage("profile_automatically_step_one"))).append($("<div>").text(browser.i18n.getMessage("profile_automatically_step_two"))).append($("<div>").text(browser.i18n.getMessage("profile_automatically_step_three")).css({"margin-bottom":"8px"})).append($("<div>").append($("<span>").text(browser.i18n.getMessage("profile_create_manually_bold")).css({"font-weight":"bold"})).append($("<span>").text(browser.i18n.getMessage("profile_create_manually")))).append($("<div>").text(browser.i18n.getMessage("profile_manually_step_one"))).append($("<div>").text(browser.i18n.getMessage("profile_manually_step_two"))).append($("<div>").text(browser.i18n.getMessage("profile_manually_step_three")))}async function hideProfiles(){$("#search-container, #content").show(),$("#server_mode_login, #login").hide(),$("#action").prop("src","../img/image_db.png").prop("title",browser.i18n.getMessage("show_profiles")),focusSearch(),await filterContainers(),$("#msp-trial-banner").hide(),await setMspTrialBannerText()}async function loadOptions(){var lastsearch;await prepareServerModeUi(),isServerConnected(sessions)&&""!=(lastsearch=await getIndexedDBrecord("options","lastsearch"))&&($("#search").val(lastsearch),focusSearch())}async function prepareServerModeUi(){var iconLogoutAll,text,databaseProfiles=await loadDatabaseProfiles();if(0<databaseProfiles.length){[].slice.call(document.getElementById("profiles-menu").children).forEach(c=>c.remove()),databaseProfiles.forEach(profile=>{var text=$("<span>").text(profile.profileName),isProfileLoggedIn=isLoggedIn(sessions,profile.profileId),iconOpenWebApp=$("<i>").addClass("fa-arrow-up-right-from-square").addClass("fas").addClass("fa-sm").addClass("dropdown-no-click-icon"),iconLoginLogout=$("<i>").addClass("fas").addClass("fa-sm").addClass("dropdown-click-icon").click(function(e){e.stopPropagation(),$("#profiles-menu").removeClass("show"),loginOrLogout($(this).closest(".profile-container"))}),isProfileLoggedIn=(isProfileLoggedIn?(iconLoginLogout.addClass("fa-arrow-right-from-bracket"),iconLoginLogout.attr("title",browser.i18n.getMessage("log_out"))):(iconLoginLogout.addClass("fa-arrow-right-to-bracket"),iconLoginLogout.attr("title",browser.i18n.getMessage("log_in"))),$("<div>").prop("id",profile.profileId).addClass("dropdown-item").addClass("profile-container").addClass(isProfileLoggedIn?"signed-in":"signed-out").click(function(e){openWebApp(profile)}).append(text).append(iconOpenWebApp).append(iconLoginLogout).attr("title",browser.i18n.getMessage("open_web_app")));$("#profiles-menu").append(isProfileLoggedIn)}),isServerConnected(sessions)&&1<databaseProfiles.length&&(text=$("<span>").text(browser.i18n.getMessage("log_out_all")),iconLogoutAll=$("<i>").addClass("fas").addClass("fa-sm").addClass("dropdown-click-icon").addClass("fa-arrow-right-from-bracket").click(function(e){e.stopPropagation(),$("#profiles-menu").removeClass("show"),onLogoutAllDatabaseProfilesClicked()}),text=$("<div>").addClass("dropdown-item").addClass("signed-out-all").click(function(e){onLogoutAllDatabaseProfilesClicked()}).append(text).append(iconLogoutAll),$("#profiles-menu").append(text));const lastProfileId=await getLastProfileSelection();lastProfileId&&databaseProfiles.find(p=>p.profileId===lastProfileId)&&(databaseIdClicked=lastProfileId)}else $("#action").hide();0===[].slice.call(document.getElementById("profiles-menu").children).length?$(".dropdown").hide():$(".dropdown").show()}function getLastProfileSelection(){return getIndexedDBrecord("options","lastProfileSelection")}function openWebApp(profile){profile.webClientUrl&&(profile=makeValidUrl(profile.webClientUrl),window.open(profile,"_blank"))}async function loginOrLogout(e){e=$(e).prop("id");databaseIdClicked=e,isLoggedIn(sessions,e)?await onLogoutClick():await onProfileChanged()}async function onLogoutAllDatabaseProfilesClicked(){this.daysTillMspTrialExpiry=void 0,$("#msp-trial-banner").hide(),sessions.forEach(async s=>{s.profileId&&s.connected&&await extension.logout(s.profileId)}),await onProfileChanged()}async function getActiveProfile(){return(await loadDatabaseProfiles()).find(p=>p.profileId===databaseIdClicked)}function getMfaRequirementByAuthenticatorType(authenticatorType){switch(authenticatorType){case 1:return browser.i18n.getMessage("mfa_google");case 2:return browser.i18n.getMessage("mfa_rsa_securId");case 3:return browser.i18n.getMessage("mfa_safenet");case 5:return browser.i18n.getMessage("mfa_yubico");default:return""}}function handleMultiFactorRequest(mfa){mfa.requiredFields&&([].slice.call(document.getElementById("enter_mfa").children).forEach(c=>c.remove()),(currentMfa=mfa).requiredFields.forEach((field,index)=>{var type="Pin"===field.type?"password":"text",index=$("<label></label>").prop("class","mfa container_input").text(getAuthenticatorLabel(field.type,mfa.displayName,index)),type=$('<input type="'+type+'">').prop("class","mfa form-control").keyup(evt=>{field.value=evt.target.value}),img=$('<img src="../img/ImagePassword.svg"/>').prop("class","mto-icon"),img=$("<div></div>").prop("class","input-group-text").append(img),img=$("<div></div>").prop("class","input-group-prepend").append(img),img=$("<div></div>").prop("class","input-group mb-1").append(img).append(type);$("#enter_mfa").append(index),$("#enter_mfa").append(img)}),$("#login").show(),$("#enter_mfa").show(),hideLoader(),$("#enter_password").hide(),$(".mfa").filter("input").first().focus(),$("#welcome-description").text(getMfaRequirementByAuthenticatorType(mfa.authenticatorType)))}function getAuthenticatorLabel(multiFactorField,displayName,index){var name=0===index?multiFactorField=displayName:multiFactorField;switch(name){case"OneTimeToken":return displayName;case"NextOneTimeToken":return browser.i18n.getMessage("login_mfa_nextTokenCode");case"Pin":return browser.i18n.getMessage("login_mfa_pin");case"NewPinRequired":return browser.i18n.getMessage("login_mfa_newPin");default:return name}}async function finalizeLogin(loggedInProfile,loggedInUserName){await sendMessagePromise({command:"SetPendingAuthInformation",pendingAuthInformation:null}),hideLoader(),await clearLockInterval(),loggedInProfile.userName=loggedInUserName,await updateDatabaseProfile(loggedInProfile),await onProfilesClick(),setVisibility(),sendNativeMessage_LoginStatusChanged({DatabaseProfileId:loggedInProfile.profileId,DatabaseId:loggedInProfile.databaseId,DatabaseName:loggedInProfile.databaseName,UserName:loggedInProfile.userName,WebClientUrl:loggedInProfile.webClientUrl,HostIp:null},"LoggedIn",!0),refreshFromBackground(async()=>{await filterContainers(),focusSearch(),await sendMessagePromise({command:"FinalizeLogin"})})}async function showLogin(skipUsernameInput){clearLockInterval(),clientAuthInformation=null,uiUserFields=[],changePasswordData=null,$("#search-container, #msp-trial-banner, profile_tutorial, #enter_password, #enter_mfa, #back_enter_username, #return_password_list, #newAuthFlowFields, #2faSelector, #password_reset").hide(),$("#server_mode_login, #login, #enter_username").show(),null!==$("#server_username").val()&&skipUsernameInput?performAuthFlowLogin():($("#server_password").val(""),$("#server_username").focus());skipUsernameInput=await loadDatabaseProfile(databaseIdClicked);$(".mto-qr-code").remove(),$("#welcome-description").text(browser.i18n.getMessage("welcomeDescription").format(skipUsernameInput.databaseName)),$("#welcome-description").removeClass("text-left").removeClass("welcome-description-qr-code"),$("#welcome-title").text(browser.i18n.getMessage("welcome")),$("#button_next").text(browser.i18n.getMessage("NextStepButtonActionNext")),$("#button_next").show(),isServerConnected(sessions)&&$("#return_password_list").show()}async function handleUserLock(userlock){setErrorText(browser.i18n.getMessage("UserLockedMessage")),await setLock(currentUserLock=userlock),setSubmitEnabledState(),currentUserLockInterval=setInterval(lockInterval,1e3)}async function setLock(userlock){var currentDate=new Date,userlock=new Date(userlock.LockedUntilUtc),currentDate=(userlock.getTime()-currentDate.getTime())/1e3;if(currentDate<=0)await clearLockInterval();else{let lockedString="";lockedString=currentDate<60?browser.i18n.getMessage("locked_for").format(Math.round(currentDate)):browser.i18n.getMessage("locked_until").format(userlock.toLocaleString()),$("#server_password").prop({disabled:!0,type:"text"}).val(lockedString),$("#server_username").prop({disabled:!0}).val(lockedString);for(const userField of uiUserFields)$(userField.getJqueryFieldIndicator()).prop({disabled:!0,type:"text"}).val(lockedString)}}function lockInterval(){null==currentUserLock?window.clearInterval(currentUserLockInterval):setLock(currentUserLock)}async function clearLockInterval(){if(currentUserLock){var profile=await getActiveProfile();currentUserLock=null,setSubmitEnabledState(),window.clearInterval(currentUserLock),clearErrorText(),$("#server_password").prop({disabled:!1,type:"password"}).val(""),$("#server_username").prop({disabled:!1}).val(profile.userName);for(const userField of uiUserFields)$(userField.getJqueryFieldIndicator()).prop({disabled:!1,type:userField.getInputType()}).val("");uiUserFields.find(f=>!f.getFieldValue())?.focus()}}function setErrorText(text,url,urlText){text?($("#label_login_error").text(text),$("#login_error_panel").show(),url&&urlText&&$("#login_error_url").text(urlText).attr("href",url).show()):clearErrorText()}function clearErrorText(){$("#label_login_error").text(""),$("#login_error_panel").hide(),$("#login_error_url").text("").attr("href","").hide()}function showLoader(){$("#content-container").hide(),$("#loader").show()}function hideLoader(){$("#content-container").show(),$("#loader").hide()}async function getInfoMessage(){JSON.parse(await getIndexedDBrecord("options","info_message_dismisses")||"{}"),JSON.parse(sessionStorage.info_message_dismisses||"{}");var showNeverAgain=$("#info_panel [data-action=show_never_again]"),close=$("#info_panel [data-action=close]");return showNeverAgain.off("click"),close.off("click"),browser.i18n.getMessage("")}async function ensureDatabaseIdClicked(){let lastProfileSelection=await getLastProfileSelection();var profiles;lastProfileSelection||(profiles=await loadDatabaseProfiles()).length&&(lastProfileSelection=profiles[0].profileId),databaseIdClicked=lastProfileSelection}let databaseIdClicked=null,profilesActive=!1,currentUserLock=null,currentUserLockInterval=null,currentMfa=null,extension=null,authenticationMechanism=null;function sendNativeMessage(message){chrome.runtime.sendMessage({Command:"SendNativeMessage",message:message})}function sendNativeMessage_LoginStatusChanged(userLogin,loginStatus,informOtherClients){sendNativeMessage({Command:"LoginStatusChanged",UserLogin:userLogin,LoginStatus:loginStatus,InformOtherClients:informOtherClients})}function getActiveTab(callback){browser.tabs.query({active:!0,currentWindow:!0},function(arrayOfTabs){arrayOfTabs=arrayOfTabs[0];callback(arrayOfTabs)})}function refreshFromBackground(callback){browser.runtime.getBackgroundPage(page=>{getActiveTab(async tab=>{extension=page,isWebSocketConnected=page.isWebSocketConnected,containers=page.containers,templates=page.templates,sessions=page.sessions,optionCanAddTemplate=page.optionCanAddTemplate,showTemplateInfo=page.showTemplateInfo,activeTab=tab,page.activeTab&&(activeTab.isWebClientLoggedIn=page.activeTab.isWebClientLoggedIn),await prepareServerModeUi(),$("#action").hide(),profilesActive=$(".dropdown").is(":visible"),isServerConnected(sessions)?await hideServerMode():await showServerMode(),isServerConnected(sessions)&&$("#action").show(),await changeInfoPanel(),callback&&callback()})})}async function setMspTrialBannerText(){if(void 0===this.daysTillMspTrialExpiry)try{this.daysTillMspTrialExpiry=await this.getRemainingMspDays()}catch(error){}this.daysTillMspTrialExpiry&&this.daysTillMspTrialExpiry<=7?(await setDayTxt(),$("#mspTrialExpirytext").text(browser.i18n.getMessage("MspTrialBannerTitel").format(this.daysTillExpiryDisplay,this.dayText)),$("#msp-trial-banner-dont-show").text(browser.i18n.getMessage("MspTrialBannerDontShowAgain")),$("#msp-trial-banner").show()):$("#msp-trial-banner").hide()}async function mspBannerClose(){$("#msp-trial-banner").hide();var activeProfile=await getActiveProfile();await sendMessagePromise({command:"updateMspBannerDisabledOption",disabledUntilUtc:getDisabledUntilUtc(864e5),currentUserId:activeProfile})}async function mspBannerOnDontShowClicked(){$("#msp-trial-banner").hide();var activeProfile=await getActiveProfile();await sendMessagePromise({command:"updateMspBannerDisabledOption",disabledUntilUtc:getDisabledUntilUtc(1e3*this.daysTillMspTrialExpiry*60*60*24),currentUserId:activeProfile})}function getDisabledUntilUtc(addedDaysMilliseconds){addedDaysMilliseconds=(new Date).getTime()+addedDaysMilliseconds;return new Date(addedDaysMilliseconds).toUTCString()}async function getRemainingMspDays(){return await sendMessagePromise({command:"getRemainingMspDays",currentUserId:await getActiveProfile()})}function setDayTxt(){this.daysTillMspTrialExpiry<=1?(this.daysTillExpiryDisplay=browser.i18n.getMessage("MspTrialExpiryDayOneText"),this.dayText=browser.i18n.getMessage("MspTrialExpiryDayText")):(this.daysTillExpiryDisplay=this.daysTillMspTrialExpiry,this.dayText=browser.i18n.getMessage("MspTrialExpiryDaysText"))}function sendMessagePromise(item){return new Promise((resolve,reject)=>{browser.runtime.sendMessage(item,response=>{var error;!0===response?.isError?(error=deserializeError(response),reject(error)):resolve(response)})})}function deserializeError(serializedError){var error=new Error;return Object.assign(error,serializedError),error}function onBackgroundMessage(request,sender,callback){"Refresh"===request.msg&&refreshFromBackground(async()=>{setVisibility(),await filterContainers(),updateProfiles(request.profile)}),"RefreshProfile"===request.msg&&updateProfiles(request.profile),"ShowLoader"===request.msg&&showLoader(),"HideLoader"===request.msg&&hideLoader()}document.addEventListener("DOMContentLoaded",async()=>{await ensureDatabaseIdClicked(),showLoader(),setVisibility(),localize(),addEvents(),await loadOptions(),refreshFromBackground(async()=>{hideLoader(),setVisibility(),await filterContainers();var pendingAuthInformation=await sendMessagePromise({command:"GetPendingAuthInformation"});pendingAuthInformation&&(pendingAuthInformation.authResult.loginLock?await sendMessagePromise({command:"SetPendingAuthInformation",pendingAuthInformation:null}):(clientAuthInformation=pendingAuthInformation).error?await handleAuthenticationError(clientAuthInformation.error):await handleAuthenticationResult(pendingAuthInformation,!0))})}),browser.runtime.onMessage.addListener(onBackgroundMessage);