!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=11)}([function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}e.exports=function(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){function n(t){return e.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},e.exports.default=e.exports,e.exports.__esModule=!0,n(t)}e.exports=n,e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,n){var o=n(8);e.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,n){var o=n(9).default,r=n(10);e.exports=function(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?r(e):t},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=PouchDB},function(e,t){e.exports=function(e,t,n){var o=n&&n.lexicographical,r=n&&n.zeroExtend,i=e.split("."),s=t.split(".");function a(e){return(o?/^\d+[A-Za-z]*$/:/^\d+$/).test(e)}if(!i.every(a)||!s.every(a))return NaN;if(r){for(;i.length<s.length;)i.push("0");for(;s.length<i.length;)s.push("0")}o||(i=i.map(Number),s=s.map(Number));for(var u=0;u<i.length;++u){if(s.length==u)return 1;if(i[u]!=s[u])return i[u]>s[u]?1:-1}return i.length!=s.length?-1:0}},function(e,t){function n(t,o){return e.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},e.exports.default=e.exports,e.exports.__esModule=!0,n(t,o)}e.exports=n,e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){function n(t){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?(e.exports=n=function(e){return typeof e},e.exports.default=e.exports,e.exports.__esModule=!0):(e.exports=n=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.default=e.exports,e.exports.__esModule=!0),n(t)}e.exports=n,e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,n){"use strict";n.r(t);var o={getBrowser:function(){return window.chrome||chrome||browser}},r=n(0),i=n.n(r),s=n(1),a=n.n(s),u=n(4),c=n.n(u),l=n(5),d=n.n(l),f=n(3),h=n.n(f),p=n(2),g=n.n(p),v=function(){function e(){i()(this,e),this.browser=o.getBrowser(),this.port=null}return a()(e,[{key:"createPort",value:function(e){return this.port="string"==typeof e?this.browser.runtime.connect({name:e}):e,this}},{key:"createListener",value:function(){var e=this;this.port.onMessage.addListener((function(t,n){if(t.action&&"function"==typeof e[t.action+"Action"])e[t.action+"Action"].call(e,t.args,n)})),this.port.onDisconnect.addListener((function(){console.log("Disconnect")}))}},{key:"getRawId",value:function(t,n){if([e.illustType,e.novelType].indexOf(n)<0)throw Error('Invalid download record type "'.concat(n,'"'));return n+t}},{key:"sendMessageThroughPort",value:function(t,n,o){t.postMessage(Object.assign({channel:"".concat(e.portName,":").concat(n)},o))}},{key:"responseSuccess",value:function(e,t,n){this.sendMessageThroughPort(e,t,n?{data:n}:{})}},{key:"responseError",value:function(e,t,n){this.sendMessageThroughPort(e,t,{error:n})}},{key:"isChannel",value:function(t,n){return t==="".concat(e.portName,":").concat(n)}}]),e}();g()(v,"instance",void 0),g()(v,"illustType","I"),g()(v,"novelType","N"),g()(v,"portName","download-record-port");var m=n(6),w=n.n(m),y=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{max:1e4};i()(this,e),this.db=this.getDb(),this.maxLimit=t.max,this.init()}return a()(e,[{key:"getDb",value:function(){return new w.a("download_record",{revs_limit:1})}},{key:"init",value:function(){this.db.createIndex({index:{fields:["_id"]}}),this.db.createIndex({index:{fields:["downloaded_at"]}})}},{key:"checkLimitationAndRemove",value:function(){var e=this;this.db.allDocs().then((function(t){var n=t.rows.length-e.maxLimit;n>0&&e.db.find({selector:{downloaded_at:{$gte:null}},sort:[{downloaded_at:"desc"}],limit:n}).then((function(t){t.docs.forEach((function(t){e.db.remove(t).catch((function(e){console.log(e)}))}))}))}))}},{key:"putRecord",value:function(e){var t=this;return this.checkLimitationAndRemove(),e.downloaded_at=Math.floor(Date.now()/1e3),this.retrieveRecord(e._id).then((function(n){return n=Object.assign(n,e),t.db.put(n)})).catch((function(n){if(404===n.status)return t.db.put(e)}))}},{key:"getDownload",value:function(e){return this.db.get(e)}},{key:"deleteDownload",value:function(e){var t=this;return this.getDownload(e).then((function(e){return t.db.remove(e)})).catch((function(e){throw e}))}},{key:"listDownloads",value:function(e){var t={selector:e.selector||{downloaded_at:{$gte:null}},sort:e.sort||[{downloaded_at:"desc"}],limit:e.limit||50,skip:e.skip||0},n=e.fun||null;return n?(t.include_docs=!0,this.db.query(n,t).then((function(e){return e.rows.map((function(e){return e.doc}))}))):this.db.find(t).then((function(e){return e.docs}))}},{key:"clearDownloads",value:function(){var e=this;this.db.destroy().then((function(){e.db=e.getDb(),e.init()}))}},{key:"retrieveRecord",value:function(e){return this.db.get(e)}},{key:"retrieveRecordsFromIds",value:function(e){return this.db.query((function(t,n){e.indexOf(t._id)>-1&&n(t)}),{limit:e.length,include_docs:!0}).then((function(e){return e.rows.map((function(e){return e.doc}))}))}}],[{key:"getDefault",value:function(){return e.instance||(e.instance=new e),e.instance}}]),e}();g()(y,"instance",void 0);var b=y;function k(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=h()(e);if(t){var r=h()(this).constructor;n=Reflect.construct(o,arguments,r)}else n=o.apply(this,arguments);return d()(this,n)}}var x=function(e){c()(n,e);var t=k(n);function n(){var e;return i()(this,n),(e=t.call(this)).downloadRecordRepo=new b({max:window.$extension.items.maxDownloadRecords}),e}return a()(n,[{key:"saveDownloadRecordAction",value:function(e,t){var n=e.id,o=e.record,r=e.type;o._id=this.getRawId(n,r),this.downloadRecordRepo.putRecord(o)}},{key:"getDownloadRecordAction",value:function(e,t){var n=e.id,o=e.type;this.downloadRecordRepo.retrieveRecord(this.getRawId(n,o)).then((function(e){t.postMessage({channel:v.portName+":get-download-record",data:e})})).catch((function(e){t.postMessage({channel:v.portName+":get-download-record",error:e.message})}))}},{key:"getDownloadRecordsFromIdsAction",value:function(e,t){var n=e.ids,o=e.responseArgs;this.downloadRecordRepo.retrieveRecordsFromIds(n).then((function(e){t.postMessage({channel:v.portName+":get-download-records",data:{dataset:e,responseArgs:o}})})).catch((function(e){t.postMessage({channel:v.portName+":get-download-records",error:e.message})}))}},{key:"getDownloadAction",value:function(e,t){var n=e.id,o=e.type,r={channel:v.portName+":get-download"};this.downloadRecordRepo.getDownload(this.getRawId(n,o)).then((function(e){r.data={download:e}})).catch((function(e){r.error=e})).finally((function(){t.postMessage(r)}))}},{key:"deleteDownloadAction",value:function(e,t){var n=this,o=e.id;this.downloadRecordRepo.deleteDownload(o).then((function(){n.responseSuccess(t,"delete-download")})).catch((function(e){n.responseError(t,"delete-download",e.message)}))}},{key:"listDownloadsAction",value:function(e,t){var n=this,o=e.selector,r=e.sort,i=e.limit,s=e.skip,a=e.query,u={selector:o,sort:r,limit:i,skip:s};a&&(u.fun=function(e,t){(/\d+/.test(a)&&e._id.substr(1)===a||e.title&&e.title.toLowerCase().indexOf(a)>-1)&&t(e)}),this.downloadRecordRepo.listDownloads(u).then((function(e){n.responseSuccess(t,"list-downloads",{datasets:e})})).catch((function(e){n.responseError(t,"list-downloads",e.message)}))}},{key:"clearDownloadsAction",value:function(){this.downloadRecordRepo.clearDownloads()}}],[{key:"getInstance",value:function(e){return n.instance||(n.instance=new n),n.instance.port=e,n.instance.createListener(),n.instance}}]),n}(v);g()(x,"instance",void 0);var R=function(){function e(){i()(this,e),this.items=[],this.limit=5e3,this.browser=o.getBrowser()}return a()(e,[{key:"getKey",value:function(){return"historyBackup"}},{key:"reachLimit",value:function(){return this.items.length>=this.limit}},{key:"free",value:function(){this.items.length>this.limit&&this.items.splice(0,this.items.length-this.limit)}},{key:"saveItems",value:function(){var e=this;this.free();var t={};t[this.getKey()]=this.items,this.browser.storage.local.set(t,(function(){e.browser.runtime.lastError&&console.log(e.browser.runtime.lastError)}))}},{key:"putBackup",value:function(e){var t=this;this.items.forEach((function(n,o){e.id===n.id&&t.items.splice(o,1)})),this.items.push(e),this.saveItems()}},{key:"forgetBackup",value:function(e){var t=this;this.items.forEach((function(n,o){e===n.id&&t.items.splice(o,1)})),this.saveItems()}},{key:"forgetAll",value:function(){var e=this,t={};this.items=[],t[this.getKey()]=[],this.browser.storage.local.set(t,(function(){e.browser.runtime.lastError&&console.log(e.browser.runtime.lastError)}))}}],[{key:"getDefault",value:function(){if(!e.default){e.default=new e;var t=e.default.getKey();e.default.browser.storage.local.get(t,(function(n){e.default.items=n[t]||[]}))}return e.default}}]),e}();g()(R,"default",void 0);var _=function(){function e(){i()(this,e),this.browser=o.getBrowser(),this.port=null}return a()(e,[{key:"createPort",value:function(e){return this.port="string"==typeof e?this.browser.runtime.connect({name:e}):e,this}},{key:"createListener",value:function(){var e=this;this.port.onMessage.addListener((function(t,n){if(t.action&&"function"==typeof e[t.action+"Action"])e[t.action+"Action"].call(e,t.args,n)})),this.port.onDisconnect.addListener((function(){console.log("Disconnect")}))}},{key:"sendMessageThroughPort",value:function(t,n,o){t.postMessage({channel:"".concat(e.portName,":").concat(n),data:o})}},{key:"isChannel",value:function(t,n){return t==="".concat(e.portName,":").concat(n)}}]),e}();g()(_,"portName","illust-history-port");var I=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{max:1e4};i()(this,e),this.db=this.getDb(),this.maxLimit=t.max,this.properties=["id","title","userId","userName","type","r","images","viewed_at","isNovel","image"],this.init()}return a()(e,[{key:"getDb",value:function(){return new w.a("illust_histories",{revs_limit:1})}},{key:"init",value:function(){return this.db.createIndex({index:{fields:["viewed_at"]}})}},{key:"checkData",value:function(e){if(!e.id||!/^N?\d+$/.test(e.id))return!1;if(!e.title||"string"!=typeof e.title)return!1;if(e.isNovel){if(!e.image)return!1}else{if(!e.images)return!1;if([0,1,2].indexOf(e.type)<0)return!1;["thumb"].forEach((function(t){e.images[t]&&"string"==typeof e.images[t]||(e.images.thumb="")}))}return!(!e.viewed_at||!/^[1-9]\d+$/.test(e.viewed_at))&&"boolean"==typeof e.r}},{key:"putIllust",value:function(e){var t=this,n=this;return new Promise((function(o){if(t.checkData(e)){t.db.allDocs().then((function(e){if(e.rows.length>t.maxLimit){var n=e.rows.length-t.maxLimit;t.getIllusts({sort:[{viewed_at:"asc"}],limit:n}).then((function(e){e.forEach((function(e){t.db.remove(e)}))}))}})),(e.viewed_at+"").length>10&&(e.viewed_at=parseInt((e.viewed_at+"").substr(0,10))),e._rev&&delete e._rev;var r=Object.assign(e,{_id:e.id});n.db.get(r.id).then((function(e){var t=Object.assign(e,r);n.db.put(t).then((function(){o()})).catch((function(e){o()}))})).catch((function(e){n.db.put(r).then((function(){o()})).catch((function(e){o()}))}))}else o()}))}},{key:"putBatchHistories",value:function(e){var t=this,n={docs:[]},o=[],r={};return e.forEach((function(e){n.docs.push({id:e.id}),r[e.id]=e})),this.db.bulkGet(n).then((function(e){return e.results.forEach((function(e){var n=e.docs[0];if(void 0!==n.ok){var i=r[n.ok.id];t.checkData(i)&&parseInt(i.viewed_at)>n.ok.viewed_at&&o.push(Object.assign({},n.ok,i)),r[n.ok.id]&&delete r[n.ok.id]}})),Object.keys(r).forEach((function(e){t.checkData(r[e])&&o.push(r[e])})),t.db.bulkDocs(o)}))}},{key:"countItems",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.db.allDocs(e).then((function(e){return e.rows.length}))}},{key:"getIllusts",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.selector||{viewed_at:{$gte:null}},o=t.sort||[{viewed_at:"desc"}],r=t.limit,i=t.skip||0;return new Promise((function(t){e.db.find({selector:n,sort:o,limit:r,skip:i}).then((function(e){t(e.docs)})).catch((function(e){t(e.docs)}))}))}},{key:"searchIllusts",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.selector||{viewed_at:{$gte:null}},o=t.sort||[{viewed_at:"desc"}],r=t.limit,i=t.skip||0,s=t.fun;return new Promise((function(t,a){e.db.query(s,{selector:n,sort:o,limit:r,skip:i,include_docs:!0}).then((function(e){var n=e.rows.map((function(e){return e.doc}));t(n)})).catch((function(e){a(e)}))}))}},{key:"deleteIllust",value:function(e){var t=this,n=e.id,o=this;return new Promise((function(e){t.db.get(n).then((function(t){e(o.db.remove(t))})).catch((function(t){e()}))}))}},{key:"clearData",value:function(){var e=this;this.db.destroy().then((function(){e.db=e.getDb(),e.init()}))}}]),e}();function D(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=h()(e);if(t){var r=h()(this).constructor;n=Reflect.construct(o,arguments,r)}else n=o.apply(this,arguments);return d()(this,n)}}var A=function(e){c()(n,e);var t=D(n);function n(){var e;return i()(this,n),(e=t.call(this)).illustHistoryRepo=new I({max:window.$extension.items.maxHistoryItems}),e.historyBackupRepo=R.getDefault(),e}return a()(n,[{key:"saveIllustHistoryAction",value:function(e){return this.historyBackupRepo.putBackup(e),this.illustHistoryRepo.putIllust(e)}},{key:"saveBatchHistoriesAction",value:function(e,t){var n=this,o=e.items;return this.illustHistoryRepo.putBatchHistories(o).then((function(){n.sendMessageThroughPort(t,"save-batch-histories")})).catch((function(e){n.sendMessageThroughPort(t,"save-batch-histories",{error:e})}))}},{key:"countItemsAction",value:function(e,t){var n=this;this.illustHistoryRepo.countItems(e).then((function(e){n.sendMessageThroughPort(t,"items-count",{count:e})}))}},{key:"listItemsAction",value:function(e,t){var n=this;this.illustHistoryRepo.getIllusts(e).then((function(e){n.sendMessageThroughPort(t,"items-list",{dataset:e})})).catch((function(e){n.sendMessageThroughPort(t,"items-list",{error:e})}))}},{key:"searchItemsAction",value:function(e,t){var n=this;e.extra&&e.extra.query.length>0&&(e.fun=function(t,n){t.title.toLowerCase().indexOf(e.extra.query)>-1&&n(t)}),this.illustHistoryRepo.searchIllusts(e).then((function(e){n.sendMessageThroughPort(t,"items-list",{dataset:e})})).catch((function(e){n.sendMessageThroughPort(t,"items-list",{error:e})}))}},{key:"deleteIllustHistoryAction",value:function(e){return this.historyBackupRepo.forgetBackup(e),this.illustHistoryRepo.deleteIllust(e)}},{key:"clearHistoryAction",value:function(){this.illustHistoryRepo.clearData(),this.historyBackupRepo.forgetAll()}}],[{key:"getInstance",value:function(e){return n.instance||(n.instance=new n),n.instance.port=e,n.instance.createListener(),n.instance}}]),n}(_);g()(A,"instance",void 0);var O=function(){function e(){i()(this,e),this.runtime=o.getBrowser().runtime}return a()(e,null,[{key:"getInstance",value:function(){return void 0!==e.instance?e.instance:e.instance=new e}},{key:"getRuntime",value:function(){return e.getInstance().runtime}}]),e}();g()(O,"instance",void 0);var S=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"local";i()(this,e),this.storage=o.getBrowser().storage,this.storageArea=this.storage[t]}return a()(e,[{key:"get",value:function(e){var t=this;return new Promise((function(n){t.storageArea.get(e,(function(e){n(e)}))}))}},{key:"set",value:function(e){var t=this;return new Promise((function(n){t.storageArea.set(e,(function(){n()}))}))}},{key:"remove",value:function(e){var t=this;return new Promise((function(n){t.storageArea.remove(e,(function(){n()}))}))}},{key:"onChanged",value:function(){return this.storage.onChanged}}],[{key:"getInstance",value:function(t){return void 0!==e.instance?e.instance:e.instance=new e(t)}},{key:"getStorage",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"local",n=e.getInstance(t);return n.storageArea}}]),e}();g()(S,"instance",void 0);var P=function(){function e(){i()(this,e),this.tabs=o.getBrowser().tabs}return a()(e,null,[{key:"getInstance",value:function(){return void 0!==e.instance?e.instance:e.instance=new e}},{key:"getTabs",value:function(){return e.getInstance().tabs}}]),e}();g()(P,"instance",void 0);function H(){this.browser=o.getBrowser(),this.autoRender=!1,this.tabId,this.backgroundColor,this.text}H.prototype={setAutoRender:function(e){this.autoRender=e},setTabId:function(e){return this.tabId=e,this.conditionRender(),this},setBackgroundColor:function(e){return this.backgroundColor=e,this.conditionRender(),this},setText:function(e){return this.text=e,this.conditionRender(),this},conditionRender:function(){this.autoRender&&this.render()},render:function(){browser.browserAction.setBadgeText({text:this.text,tabId:this.tabId}),browser.browserAction.setBadgeBackgroundColor({color:this.bgColor,tabId:this.tabId})}};var M=function(){function e(){i()(this,e),this.i18n=o.getBrowser().i18n}return a()(e,null,[{key:"getInstance",value:function(){return e.instance?e.instance:e.instance=new e}},{key:"getI18n",value:function(){return e.getInstance().i18n}}]),e}();g()(M,"instance",void 0);var B=n(7),E=n.n(B),L=function(){function e(t,n){i()(this,e),this.currentSettings=t,this.browser=o.getBrowser(),this.defaultSettings=n}return a()(e,[{key:"isNewer",value:function(e){return!this.currentSettings.version||E()(this.currentSettings.version,e)<0}},{key:"mergeSettings",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.assign(this.currentSettings,t);var n=Object.keys(this.currentSettings),o=Object.keys(this.defaultSettings);o.forEach((function(t){void 0===e.currentSettings[t]&&(e.currentSettings[t]=e.defaultSettings[t])}));var r=n.filter((function(e){return-1===o.indexOf(e)}));return new Promise((function(t){e.browser.storage.local.set(e.currentSettings,(function(){e.browser.storage.local.remove(r,(function(){t()}))}))}))}}]),e}(),N=Object.assign({},{version:"1.0.0",enableExtend:!1,enableWhenUnderSeconds:1,extendDuration:3,ugoiraRenameFormat:"",ugoiraQuanlity:10,mangaRenameFormat:"",mangaImageRenameFormat:"",enableExtension:!0,enablePackUgoiraFramesInfo:!0,mangaPagesInChunk:99,enableExtTakeOverDownloads:!1,downloadRelativeLocation:null,downloadSaveAs:!1,featureKnown:!1,autoActivateDownloadPanel:!1,enablePtkSearch:!0,enableSaveVisitHistory:!0,notSaveNSFWWorkInHistory:!1,novelIncludeDescription:!1,novelRenameFormat:"",statUgoiraDownloaded:0,statMangaDownloaded:0,statNovelDownloaded:0,statIllustDownloaded:0,illustrationRenameFormat:"",illustrationImageRenameFormat:"",visitHistoryType:"list",guideShowed:!1,illustrationKeepPageNumber:!1,illustrationPageNumberStartWithOne:!1,MangaPageNumberStartWithOne:!1,askDownloadSavedWork:!0,importantNoticeDisplayed:!1,ugoiraRelativeLocation:"",illustrationRelativeLocation:"",mangaRelativeLocation:"",novelRelativeLocation:"",downloadTasksWhenDownloadingImages:3,historyBackup:[],animationJsonFormat:1,language:"default",alwaysPack:!1,maxHistoryItems:1e4,maxDownloadRecords:1e4,enableSaveDownloadHistory:1,displayWorkTypeLabel:!0,workCoverSize:1,mangaPageNumberLength:0,illustrationPageNumberLength:0}),T=window.browser=o.getBrowser();function q(){this.items=null,this.logs=[],this.logsMax=200,this.ports={}}q.prototype={getPorts:function(){var e={};return e[A.portName]=A,e[x.portName]=x,e},run:function(){var e=this;T.storage.local.get(null,(function(t){e.items=t,e.ports=e.getPorts(),e.update(),e.listenStorageChanged(),e.listenMessage(),e.listenPortConnect()}));var t=[T.webRequest.OnBeforeSendHeadersOptions.BLOCKING||"blocking",T.webRequest.OnBeforeSendHeadersOptions.REQUEST_HEADERS||"requestHeaders"],n=[T.webRequest.OnHeadersReceivedOptions.BLOCKING||"blocking",T.webRequest.OnHeadersReceivedOptions.RESPONSE_HEADERS||"responseHeaders"];T.webRequest.OnBeforeSendHeadersOptions.EXTRA_HEADERS&&t.push(T.webRequest.OnBeforeSendHeadersOptions.EXTRA_HEADERS),T.webRequest.OnHeadersReceivedOptions.EXTRA_HEADERS&&n.push(T.webRequest.OnHeadersReceivedOptions.EXTRA_HEADERS);var o=/^https:\/\/(www\.)[pixiv|fanbox]/,r=["*://*.pixiv.net/*","*://*.pximg.net/*","*://*.techorus-cdn.com/*","*://*.fanbox.cc/*"];T.webRequest.onBeforeSendHeaders.addListener((function(e){if("xmlhttprequest"===e.type){var t=!1,n=!1;return e.requestHeaders.forEach((function(r,i){var s=r.name.toLowerCase();"referer"===s?(n=!0,e.url.indexOf("i.pximg.net")>-1&&!o.test(r.value)&&(e.requestHeaders[i].value="https://www.pixiv.net/")):"origin"===s&&(t=!0)})),e.url.indexOf("api.fanbox.cc")>-1&&(t||e.requestHeaders.push({name:"Origin",value:e.initiator?e.initiator:"https://www.fanbox.cc"})),n||e.requestHeaders.push({name:"referer",value:"https://www.pixiv.net/"}),{requestHeaders:e.requestHeaders}}}),{urls:r},t),T.webRequest.onHeadersReceived.addListener((function(e){if("xmlhttprequest"===e.type){e.responseHeaders.forEach((function(t,n){"access-control-allow-origin"===t.name.toLowerCase()&&e.requestHeaders.splice(n,1)}));var t="";return 0===e.frameId&&/^https:\/\/[^.]+\.fanbox\.cc/.test(e.initiator)?(t=e.initiator,e.responseHeaders.push({name:"Access-Control-Allow-Credentials",value:"true"})):t="*",e.responseHeaders.push({name:"Access-Control-Allow-Origin",value:t}),{responseHeaders:e.responseHeaders}}}),{urls:r},n)},callMessageAction:function(e,t){var n=e+"Action";"function"==typeof this[n]&&this[n].call(this,t)},listenStorageChanged:function(){var e=this;T.storage.onChanged.addListener((function(t,n){for(var o in t)e.items[o]=t[o].newValue}))},listenMessage:function(){var e=this;T.runtime.onMessage.addListener((function(t,n,o){return t.action&&e.callMessageAction(t.action,{message:t,sender:n,sendResponse:o}),!0}))},listenPortConnect:function(){var e=this;T.runtime.onConnect.addListener((function(t){t.name&&e.ports[t.name]&&e.ports[t.name].getInstance(t)}))},activeIconAction:function(e){T.browserAction.setIcon({path:T.runtime.getURL("./icon_active.png"),tabId:e.sender.tab.id})},deactiveIconAction:function(e){T.browserAction.setIcon({path:T.runtime.getURL("./icon.png"),tabId:e.sender.tab.id})},requestPermissionsAction:function(e){T.permissions.request(e.message.permissions,(function(t){e.sendResponse&&"function"==typeof e.sendResponse&&e.sendResponse(t)}))},removePermissionsAction:function(e){T.permissions.remove(e.message.permissions,(function(t){e.sendResponse&&"function"==typeof e.sendResponse&&e.sendResponse(t)}))},containsPermissionsAction:function(e){T.permissions.contains(e.message.permissions,(function(t){e.sendResponse&&"function"==typeof e.sendResponse&&e.sendResponse(t)}))},downloadAction:function(e){e.message.options.arrayBuffer&&(e.message.options.url=URL.createObjectURL(new Blob([e.message.options.arrayBuffer],{type:"text/plain"})),delete e.message.options.arrayBuffer),T.downloads.download(e.message.options,(function(t){e.sendResponse&&"function"==typeof e.sendResponse&&e.sendResponse(t)}))},updateDownloadedStatAction:function(e){var t=e.message.args,n="";switch(t){case"ugoira":n="statUgoiraDownloaded";break;case"illust":n="statIllustDownloaded";break;case"manga":n="statMangaDownloaded";break;case"novel":n="statNovelDownloaded";break;default:throw'Unkown stat downloaded type "'+t+'"'}var o={};o[n]="number"==typeof this.items[n]?++this.items[n]:0,T.storage.local.set(o)},recordLogAction:function(e){this.logs.length>=200&&this.logs.pop();var t=e.error&&e.error.message?e.error.message:e.message;this.logs.push(t)},update:function(){var e=T.runtime.getManifest().version;T.storage.local.get(null,(function(t){var n=new L(t,N);n.isNewer(e)&&n.mergeSettings({version:e,importantNoticeDisplayed:!1}).then((function(){T.browserAction.setBadgeText({text:"NEW"}),T.browserAction.setBadgeBackgroundColor({color:"#FF0000"})}))}))}},(window.$extension=new q).run()}]);