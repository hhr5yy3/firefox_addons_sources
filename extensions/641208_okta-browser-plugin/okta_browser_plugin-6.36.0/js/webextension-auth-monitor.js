Okta.AuthenticationMonitor=function(t,e){var r=Okta.Q;var n=Okta._okta;var i=n.delay;var o=n.each;var a=n.find;var u=n.last;var s=Okta.fn.url.getOktaFederatedRequestMatchPatterns;var d=Okta.fn.url.isAllowedOktaRequestForAuthMonitoring;var l=Okta.fn.url.isOktaFederalDomain;var f=false;var m=false;var c=false;var h={};var v=20;var b=2e4;var g={};var p=Okta.Logging(t,e);function R(e){return g[e]}function q(e,r){g[e]=r}function L(e){delete g[e]}function w(e,r){if(!r||!e){return}r.push({url:e.url,startTimeStamp:e.timeStamp});q(e.tabId,r)}function S(e,r){var t=u(r);t.method=e.method;t.statusCode=e.statusCode;t.endTimeStamp=e.timeStamp;t.responseTimeMs=Math.round(t.endTimeStamp-t.startTimeStamp);t.error=e.error;q(e.tabId,r)}function O(r){return t.getOktaDomain().then(function(e){if(!e){return false}if(!r||!r.url||r.url.indexOf(e)!==0){return false}if(!d(r.url)){return false}return true})}function k(e,r,t){var n="Auth Interaction: ";o(e,function(e,r){e.startTimeStamp=undefined;e.endTimeStamp=undefined;e.url=r===0||c?encodeURI(e.url):undefined});n+=JSON.stringify(e);L(r);if(!t||m){return p.log("INFO",n,"AuthenticationMonitor::logInteraction: ")}}function I(e){if(!e||!e.transitionQualifiers){return false}if(e.transitionType==="link"&&e.transitionQualifiers.length>0&&e.transitionQualifiers[0]==="server_redirect"){return false}return e.transitionType==="auto_subframe"||!!a(e.transitionQualifiers,function(e){return e==="client_redirect"||e==="server_redirect"})}function T(e){if(!e||!e.transitionQualifiers){return false}return e.transitionType==="typed"||e.transitionType==="auto_bookmark"||e.transitionType==="reload"}function y(){if(!chrome.webRequest.onSendHeaders||!chrome.webRequest.onCompleted||!chrome.webRequest.onBeforeRedirect||!chrome.webRequest.onErrorOccurred||!chrome.webNavigation.onCommitted||!chrome.tabs.onRemoved){Log.warn("AuthenticationMonitor::isSupported: Current version of "+"the browser does not support this functionality");return false}return true}function A(r){return O(r).then(function(e){e&&w(r,[])})}function C(t){return O(t).then(function(e){if(!e){return}var r=R(t.tabId);if(!r||r.length===0){return}S(t,r);if(t.statusCode>=400||t.error){k(r,t.tabId,false);return}})}function _(e){var r=R(e.tabId);if(!r||r.length===0){return}if(r.length===1&&r[0].url===e.url){return}w(e,r)}function M(r){var e=R(r.tabId);if(!e||e.length===0){return}var t=e.length;if(t===1&&e[0].url===r.url){return}if(t===2&&r.method!=="POST"){L(r.tabId);return}var n=u(e);if(n.url!==r.url){w({timeStamp:n.endTimeStamp,url:r.url},e);n=u(e);t++}if(t===v){n.oktaError="request queue reached maximum capacity of "+v+" web requests"}S(r,e);if(r.statusCode>=400||r.error||t===v){return k(e,r.tabId,false)}if((r.method==="GET"||r.method==="POST")&&r.statusCode<300){i(function(){var e=R(r.tabId);if(!e){return}if(e.length>t){return}k(e,r.tabId,true)},b)}}function E(e){var r=R(e.tabId);if(!r||r.length<=2){return}if(T(e)){L(e.tabId);return}if(!I(e)){r.pop();return k(r,e.tabId,true)}}function H(e){L(e)}function F(){if(!f){Log.info("AuthenticationMonitor::removeRequestListeners: "+"no listeners are attached to be removed");return}chrome.webRequest.onSendHeaders.removeListener(A);chrome.webRequest.onCompleted.removeListener(C);chrome.webRequest.onErrorOccurred.removeListener(C);chrome.webRequest.onSendHeaders.removeListener(_);chrome.webRequest.onBeforeRedirect.removeListener(M);chrome.webRequest.onCompleted.removeListener(M);chrome.webRequest.onErrorOccurred.removeListener(M);chrome.webNavigation.onCommitted.removeListener(E);chrome.tabs.onRemoved.removeListener(H);f=false;Log.info("AuthenticationMonitor::removeRequestListeners: "+"removed all listeners")}function Q(){if(f){Log.info("AuthenticationMonitor::addRequestListeners: "+"listeners already attached");return}var e=s();chrome.webRequest.onSendHeaders.addListener(A,{urls:e},["requestHeaders"]);chrome.webRequest.onCompleted.addListener(C,{urls:e});chrome.webRequest.onErrorOccurred.addListener(C,{urls:e});chrome.webRequest.onSendHeaders.addListener(_,{urls:["<all_urls>"],types:["main_frame"]},["requestHeaders"]);chrome.webRequest.onBeforeRedirect.addListener(M,{urls:["<all_urls>"],types:["main_frame"]});chrome.webRequest.onCompleted.addListener(M,{urls:["<all_urls>"],types:["main_frame"]});chrome.webRequest.onErrorOccurred.addListener(M,{urls:["<all_urls>"],types:["main_frame"]});chrome.webNavigation.onCommitted.addListener(E);chrome.tabs.onRemoved.addListener(H);f=true;Log.info("AuthenticationMonitor::addRequestListeners: "+"added all listeners")}h.initialize=function(e){m=!!e;if(!y()){return}return r.all([t.getPluginSettings(),t.getOktaDomain()]).spread(function(e,r){if(e&&e.orgSettings&&e.orgSettings.pluginAuthFailureDetectionEnabled&&!l(r)){Q();c=e.orgSettings.pluginAuthFailureDetectionShowUrlEnabled;return}Log.info("AuthenticationMonitor::initialize: Auth monitoring feature "+"is disabled or on federal org");F();return})};return h};