import{c as E,d as T,a as C,P as u}from"./cplx-DC-QQLj-.js";import{c as D,f as m,p as L,a as M}from"./cplx-B814hFp-.js";import{b as P,E as x,g as k,r as F}from"./cplx-CVsLL7Ku.js";import{h as b,k as A}from"./cplx-Cdcyb6EG.js";import{r as N}from"./cplx-CIDXzIHh.js";import{r as R}from"./cplx-CEwbiDR6.js";import{r as O}from"./cplx-CvSOQQlQ.js";import{r as U}from"./cplx-BkZI4zpB.js";import"./cplx-BbAh7E-i.js";import"./cplx-M4JPizzD.js";import"./cplx-CzQHx1MX.js";import"./cplx-AFeO3sEC.js";import"./cplx-2ekRUlSR.js";var g=C(),s=new Map,p=new Map,h=new Map,w=(e,r)=>(p.set(e,(p.get(e)||new Set).add(r)),()=>{const n=p.get(e);n!=null&&n.delete(r)&&(n==null?void 0:n.size)===0&&p.delete(e)}),S=(e,r)=>{h.set(e,(h.get(e)||new Set).add(r))},l=e=>({withFingerprint:r=>{const n=o=>({and:()=>o}),a={aboutIncomingMessage:o=>{const t=s.get(e);return u.toExtensionContext(t.port,{status:"incoming",message:o}),n(a)},aboutSuccessfulDelivery:o=>{const t=s.get(e);return u.toExtensionContext(t.port,{status:"delivered",receipt:o}),n(a)},aboutMessageUndeliverability:(o,t)=>{const i=s.get(e);return(i==null?void 0:i.fingerprint)===r&&u.toExtensionContext(i.port,{status:"undeliverable",resolvedDestination:o,message:t}),n(a)},whenDeliverableTo:o=>{const t=()=>{const i=s.get(e);if((i==null?void 0:i.fingerprint)===r&&s.has(o))return u.toExtensionContext(i.port,{status:"deliverable",deliverableTo:o}),!0};if(!t()){const i=w(o,t);S(r,i)}return n(a)},aboutSessionEnded:o=>{const t=s.get(e);return(t==null?void 0:t.fingerprint)===r&&u.toExtensionContext(t.port,{status:"terminated",fingerprint:o}),n(a)}};return a}}),_=E(),v=D("background",e=>{var r;if(e.origin.context==="background"&&["content-script","devtools "].includes(e.destination.context)&&!e.destination.tabId)throw new TypeError("When sending messages from background page, use @tabId syntax to target specific tab");const n=m({...e.origin,...e.origin.context==="window"&&{context:"content-script"}}),a=m({...e.destination,...e.destination.context==="window"&&{context:"content-script"},tabId:e.destination.tabId||e.origin.tabId});e.destination.tabId=null,e.destination.frameId=null;const o=()=>s.get(a),t=()=>s.get(n),i=()=>{var c;l(a).withFingerprint(o().fingerprint).aboutIncomingMessage(e);const f={message:e,to:o().fingerprint,from:{endpointId:n,fingerprint:(c=t())==null?void 0:c.fingerprint}};e.messageType==="message"&&g.add(f),e.messageType==="reply"&&g.remove(e.messageID),t()&&l(n).withFingerprint(t().fingerprint).aboutSuccessfulDelivery(f)};(r=o())!=null&&r.port?i():e.messageType==="message"&&(e.origin.context==="background"?w(a,i):t()&&l(n).withFingerprint(t().fingerprint).aboutMessageUndeliverability(a,e).and().whenDeliverableTo(a))},e=>{const r=m({...e.origin,...e.origin.context==="window"&&{context:"content-script"}}),n=s.get(r),a={message:e,to:_,from:{endpointId:r,fingerprint:n.fingerprint}};l(r).withFingerprint(n.fingerprint).aboutSuccessfulDelivery(a)});P.runtime.onConnect.addListener(e=>{var r;const n=T(e.name);if(!n)return;n.endpointName||(n.endpointName=m({context:"content-script",tabId:e.sender.tab.id,frameId:e.sender.frameId}));const{tabId:a,frameId:o}=L(n.endpointName);s.set(n.endpointName,{fingerprint:n.fingerprint,port:e}),(r=p.get(n.endpointName))==null||r.forEach(t=>t()),p.delete(n.endpointName),S(n.fingerprint,()=>{const t=g.entries().filter(i=>i.to===n.fingerprint);g.remove(t),t.forEach(i=>{i.from.endpointId==="background"?v.endTransaction(i.message.transactionId):l(i.from.endpointId).withFingerprint(i.from.fingerprint).aboutSessionEnded(n.fingerprint)})}),e.onDisconnect.addListener(()=>{var t,i;((t=s.get(n.endpointName))==null?void 0:t.fingerprint)===n.fingerprint&&s.delete(n.endpointName),(i=h.get(n.fingerprint))==null||i.forEach(c=>c()),h.delete(n.fingerprint)}),e.onMessage.addListener(t=>{var i,c;if(t.type==="sync"){const f=[...s.values()].map(d=>d.fingerprint),y=t.pendingResponses.filter(d=>f.includes(d.to));g.add(...y),t.pendingResponses.filter(d=>!f.includes(d.to)).forEach(d=>l(n.endpointName).withFingerprint(n.fingerprint).aboutSessionEnded(d.to)),t.pendingDeliveries.forEach(d=>l(n.endpointName).withFingerprint(n.fingerprint).whenDeliverableTo(d));return}t.type==="deliver"&&((c=(i=t.message)==null?void 0:i.origin)!=null&&c.context)&&(t.message.origin.tabId=a,t.message.origin.frameId=o,v.handleMessage(t.message))})});var{sendMessage:oe,onMessage:I}=v;M(v);function $(){H(),W(),G(),B(),z()}function B(){chrome.contextMenus.removeAll(),chrome.contextMenus.create({id:"openOptionsPage",title:"Dashboard",contexts:["action"]}),chrome.contextMenus.onClicked.addListener(e=>{e.menuItemId==="openOptionsPage"&&chrome.tabs.create({url:b()})})}function W(){chrome.runtime.onInstalled.addListener(({reason:e,previousVersion:r})=>{e===chrome.runtime.OnInstalledReason.INSTALL?chrome.tabs.create({url:`${b()}#/onboarding`}):e===chrome.runtime.OnInstalledReason.UPDATE&&r&&A("1.0.0.0",r)>0&&chrome.tabs.create({url:`${b()}#/onboarding?fromAlpha=true`})})}function z(){I("bg:getTabId",({sender:e})=>e.tabId),I("bg:removePreloadedTheme",async({sender:e})=>{const r=(await x.get()).theme,n=await k(r);n&&chrome.scripting.removeCSS({target:{tabId:e.tabId},css:n})}),I("bg:openDirectReleaseNotes",({data:{version:e}})=>{const r=b();chrome.tabs.create({url:`${r}#/direct-release-notes?version=${e}`})})}function G(){chrome.runtime.onInstalled.addListener(({reason:e})=>{e===chrome.runtime.OnInstalledReason.UPDATE&&x.set(r=>{r.cdnLastUpdated=Date.now()})})}function H(){chrome.action.onClicked.addListener(async()=>{(await x.get()).extensionIconAction==="perplexity"?chrome.tabs.create({url:"https://perplexity.ai/"}):chrome.runtime.openOptionsPage()})}function j(){U(),F(),N(),O(),R()}j();$();
