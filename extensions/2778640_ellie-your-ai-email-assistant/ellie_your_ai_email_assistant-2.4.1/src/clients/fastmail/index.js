class FastmailEllie extends Ellie{client="fastmail";constructor(){super("fastmail");const e=createFastmailToolbar(),t=document.createElement("span");t.classList.add("v-Toolbar-divider"),this.UI.$el.insertBefore(t.cloneNode(),this.UI.$el.querySelector(".ellies-interest")),this.UI.$el.insertBefore(t.cloneNode(),this.UI.$el.querySelector(".ellies-actions-box"));const n=t.cloneNode();n.classList.add("slide-right"),this.UI.$el.insertBefore(n,this.UI.$el.querySelector(".ellies-feedback")),e.append(this.UI.$el),e.querySelectorAll("button").forEach((e=>e.classList.add("v-Button"))),this.$container=e}isOnComposePage(){return!!window.location.pathname.includes("/compose")&&!!document.querySelector(".v-RichText-toolbar")}onStartCompose(){this.attached=!0,this.attachHandlers(),this.getLimits(),this.insertEllie()}onEndCompose(){this.attached=!1,this.destroy()}insertEllie=()=>{console.log(`[ellie]: inserting Ellie for ${this.client}`),this.scrollableContainer=document.body;const e=document.querySelector(".v-RichText-toolbar");e.parentElement.insertBefore(this.$container,e.nextSibling),this.isReady=!0};addElementToDOM(e){e.classList.add("collapsed"),this.UI.$el.parentNode.parentNode.insertBefore(e,this.UI.$el.parentElement.nextElementSibling),setTimeout((()=>e.classList.remove("collapsed")),200)}removeElementFromDOM(e){this.UI.$el.parentNode.parentNode.removeChild(e)}getThreadId(){return window.location.pathname.match(/([^\/]+$)/)[0]}getEditor(){return document.querySelector(".v-RichText-input")}getReplyText(){const e=this.getEditor().cloneNode(!0),t=e.querySelector("blockquote");t&&t.parentElement.removeChild(t);const n=getNewlineLocations(e);return{text:e.textContent,newlines:n}}getThread(e=this.getEditor().cloneNode(!0)){let t=[];const n=[...e.querySelectorAll("blockquote")];for(let e=n.length-1;e>=0;e--)try{const l=n[e];let i="";l.previousElementSibling&&(i=l.previousElementSibling.textContent.trim()),i||console.warn("[ellie]: no author found for thread item"),t.push({text:l.textContent.trim(),author:i}),l.parentElement.removeChild(l.previousElementSibling),l.parentElement.removeChild(l)}catch(e){console.error(e);continue}return t.length||console.warn("[ellie]: no thread was found"),t}streamReply(e){const t=this.getEditor();if(!t)return!1;!this.lastEditableElement&&this.selected&&this.selected.textSelected&&(this.reselectSelected(),this.lastEditableElement=this.selected?this.selected.node:null),this.lastEditableElement||(this.lastEditableElement=t.firstChild);for(let t=0;t<e.length;t++)this.lastEditableElement=this.writeChar(e[t],{insertIndex:this.insertIndex+t,lastEditableElement:this.lastEditableElement});this.insertIndex=this.insertIndex+e.length}writeReply(e){const t=this.getEditor();if(!t)return!1;this.reselectSelected();let n=this.selected?this.selected.node:null;n||(n=t.firstChild);let l=this.selected?this.selected.insertIndex:0,i=0;const s=()=>{let t=e[i++];void 0!==t?(n=this.writeChar(t,{insertIndex:l++,lastEditableElement:n}),setTimeout(s,5)):this.setStatus("waiting",!0)};s()}writeChar(e,{insertIndex:t,lastEditableElement:n}={}){if("\n"===e){const e=document.createElement("div");"#text"===n.nodeName?n.parentNode.insertBefore(e,n.nextSibling):n.insertAdjacentElement("afterend",e),n&&"\n"===n.textContent&&n.replaceWith(document.createElement("br")),n=e}let l="#text"===n.nodeName?n:n.childNodes[0];if(l&&"#text"===l.nodeName){const i=l.textContent;l.textContent=[i.substring(0,t),e,i.substring(t)].join(""),n=l}else{let t=document.createTextNode(e);n.insertBefore(t,n.childNodes[0]),n=t}return n}attachHandlers(){document.querySelector(".s-send").addEventListener("click",this.onSendEmail),super.attachHandlers()}destroy(){this.$container.parentElement.removeChild(this.$container),super.destroy()}}function createFastmailToolbar(){const e=document.createElement("div");return e.classList.add("v-Toolbar","v-Toolbar--preventOverlap","v-RichText-toolbar"),e}const ellie=new FastmailEllie;ellie.watchForCompose({stopWatchingOnEnd:!1});