class Ellie{status="waiting";isReady=!1;hasSelection=!1;limits=[];insertIndex=0;streamBuffer=[];currentThread={limits:{}};constructor(e){this.client=e,console.log("[ellie]: created Ellie"),this.UI=new EllieUI({onBtnClicked:this.onBtnClicked.bind(this),onWriteClicked:this.onWriteClicked.bind(this),onReviewClicked:this.onReviewClicked.bind(this),onReviewResponse:this.onReviewResponse.bind(this),onSaveSelectedOption:this.onSaveSelectedOption.bind(this),client:this.client,browserName:this.getBrowserFromManifest()})}onWriteClicked(){this.closeErrorBox(),"revise"===this.status||"insert"===this.status?this.createReply():this.createReply({stream:!0})}onReviewClicked({response:e}={}){this.openReviewBox({step:"2",response:e})}onReviewResponse({response:e}={}){this.closeReviewBox(),e&&this.sendToBackground({type:"review-response",data:{response:e}})}onSaveSelectedOption({key:e,value:t}){this.sendToBackground({type:"save-selected-option",data:{key:e,value:t}})}watchForCompose({stopWatchingOnEnd:e=!0}={}){console.log("[ellie]: waiting for compose box to load fully");const t=setInterval((()=>{this.isOnComposePage()&&!this.attached?(this.UI.clearOptions(),this.UI.toggleWriteButton(!0),this.closeErrorBox(),this.onStartCompose()):!this.isOnComposePage()&&this.attached&&(this.onEndCompose(),e&&clearInterval(t))}),500)}isOnComposePage(){throw new Error("Not implemented yet for this client")}onStartCompose(){throw new Error("Not implemented yet for this client")}onEndCompose(){throw new Error("Not implemented yet for this client")}insertEllie({scrollableContainer:e}){throw new Error("Not implemented yet for this client")}onBtnClicked(e,t){t?e.classList.add("is-active"):e.classList.remove("is-active")}getLimits(){const e=this.getThreadId();chrome.runtime.sendMessage({type:"get-limits",threadId:e}),this.UI.context&&(this.UI.context.value="")}getThreadId(){throw new Error("Not implemented yet for this client")}getReplyText(){throw new Error("Not implemented yet for this client")}getQuotedText(){throw new Error("Not implemented yet for this client")}getThreadText(){throw new Error("Not implemented yet for this client")}getEml(){return null}writeReply(){throw new Error("Not implemented yet for this client")}openErrorBox({message:e,type:t}){document.body.classList.contains("ellie-error-is-open")||(document.body.classList.add("ellie-error-is-open"),this.UI.setError({message:e,type:t}),this.addElementToDOM(this.UI.$errorDropdown))}closeErrorBox(){document.body.classList.contains("ellie-error-is-open")&&(this.removeElementFromDOM(this.UI.$errorDropdown),document.body.classList.remove("ellie-error-is-open"))}openUpgradeBox(){document.body.classList.contains("ellie-upgrade-is-open")||(document.body.classList.add("ellie-upgrade-is-open"),this.addElementToDOM(this.UI.$upgradeDropdown))}closeUpgradeBox(){document.body.classList.contains("ellie-upgrade-is-open")&&(this.removeElementFromDOM(this.UI.$upgradeDropdown),document.body.classList.remove("ellie-upgrade-is-open"))}openReviewBox({step:e="1",response:t}){this.closeReviewBox(),document.body.classList.add("ellie-review-is-open"),"1"===e&&this.addElementToDOM(this.UI.$reviewDropdown),"2"===e&&"yes"===t&&this.addElementToDOM(this.UI.$reviewDropdownYes),"2"===e&&"no"===t&&this.addElementToDOM(this.UI.$reviewDropdownNo)}closeReviewBox(){try{this.removeElementFromDOM(this.UI.$reviewDropdown)}catch(e){}try{this.removeElementFromDOM(this.UI.$reviewDropdownYes)}catch(e){}try{this.removeElementFromDOM(this.UI.$reviewDropdownNo)}catch(e){}document.body.classList.remove("ellie-review-is-open")}getTextAdjacentToCursor(e){const[t,o]=getCaretPosition(e),{text:i,newlines:s}=this.getReplyText();return reinsertNewlines({text:i,newlines:s,cursorPos:{start:t,end:o}})}setStatus(e="waiting",t=!0){if(this.status===e)return;let o={waiting:"Write ✏️",thinking:"🤔 Thinking...",writing:"📝 Writing...",revise:"Revise 🔄",insert:"Insert ✏️"}[e],i=!t;this.status=e;const s=this.UI.$status;i?s.setAttribute("disabled",!0):s.removeAttribute("disabled"),s.innerHTML=o,document.querySelector(".ellies-actions-box").removeAttribute("data-shown")}onStartReply(){}onOpenEmail(){}onSendEmail=()=>{const e=this.getReplyText().text;if(this.currentThread.hasWritten){let t={requiredPayment:this.requiresPayment,includedLink:e.includes("written by Ellie")||e.includes("tryellie.com")};this.sendToBackground({type:"save-stats",stats:t})}};getTextSelectionInterval=()=>{const e=window.getSelection();if(!this.isReady||!this.isOnComposePage()||"writing"===this.status||"thinking"===this.status||"None"===e.type)return;const t=this.getEditor();let o=!1,i=e.anchorNode;for(;i!==document.body;){if(i===t){o=!0;break}i=i.parentElement}if(!o)return this.hasSelection=!1,void(this.selected=null);e.isCollapsed&&this.currentThread.hasWritten?this.setStatus("insert"):e.isCollapsed?this.setStatus("waiting"):this.setStatus("revise"),this.hasSelection=!0;const{anchorNode:s,anchorOffset:n,focusNode:r,focusOffset:l}=e;this.selected={selectionObject:{anchorNode:s,anchorOffset:n,focusNode:r,focusOffset:l},...this.getTextAdjacentToCursor(t),node:e.anchorNode,insertIndex:e.anchorOffset}};attachHandlers(){chrome.runtime.onMessage.addListener(this.onMessage),this.selectionInterval=setInterval(this.getTextSelectionInterval,500)}removeHandlers(){chrome.runtime.onMessage.removeListener(this.onMessage),clearInterval(this.selectionInterval)}onMessage=e=>{const t=document.getElementById("ellie-revisions");if("response-stream"===e.type){const{text:t}=e;if(this.streamBuffer.push(t),!this.writing){this.writing=!0;for(let e=0;e<this.streamBuffer.length;e++)this.streamReply(this.streamBuffer.shift());this.writing=!1}}if("response-stream-error"!==e.type&&"response-error"!==e.type||(this.setStatus("waiting",!0),this.openErrorBox({message:e.text})),"user-error"===e.type&&(this.setStatus("waiting",!0),this.UI.toggleWriteButton(!1),this.openErrorBox({type:e.reason})),"response-stream-done"===e.type){const{metadata:t}=e;this.setStatus("waiting",!0),t.openUpgradeBox?(this.requiresPayment=!0,this.openUpgradeBox(t),this.UI.toggleWriteButton(!1)):(this.closeUpgradeBox(),this.UI.toggleWriteButton(!0)),t.openOverdueBox?this.openErrorBox({type:"overdue-invoice"}):!t.openUpgradeBox&&t.openReviewBox&&this.openReviewBox({step:"1"})}if("response"===e.type){const{requiresPayment:o,text:i,revisionsLeft:s}=e;this.currentThread.hasWritten=!0,this.setStatus("writing",!1),this.writeReply(i,{requiresPayment:o}),this.currentThread.limits.revisions=s,t&&(t.textContent=e.revisionsLeft)}"limits"==e.type&&(this.currentThread=e.thread,t&&(t.textContent=e.thread.limits.revisions),this.UI.setAccountEmail(e.email,e.uuid),0===e.repliesRemaining?(this.openUpgradeBox(),this.UI.toggleWriteButton(!1)):this.UI.toggleWriteButton(!0),this.UI.populateRolesDropdown(e.roles),this.UI.restoreSelectedOptions(e.selectedOptions)),"open-tab"===e.type&&chrome.tabs.create({url:e.url})};createReply({stream:e=!1}={}){this.insertIndex=0,this.lastEditableElement=null,this.setStatus("thinking",!1);const t=this.getThreadId(),{context:o,mood:i,interest:s,roleUuid:n,replyLength:r}=this.UI.getSelectedOptions();let l={emailClient:this.client,type:e?"stream-prompt":"submit-prompt",thinkingText:normalize(o).substr(0,500),mood:i,interest:s,isRevision:this.currentThread.hasWritten,threadId:t,roleUuid:n,replyLength:r};const d=this.getEml();if(d)l={...l,parsedEml:d};else{const e=this.getThread();l={...l,thread:normalizeThread(e),emailText:normalize(e[0].text)}}l=this.selected?{...l,textBefore:normalize(this.selected.textBefore),textAfter:normalize(this.selected.textAfter)}:{...l,textBefore:this.getReplyText().text},this.sendToBackground(l)}reselectSelected({deleteSelected:e=!0}={}){if(this.selected&&this.selected.textSelected){const{anchorNode:t,anchorOffset:o,focusNode:i,focusOffset:s}=this.selected.selectionObject,n=document.getSelection();n.setBaseAndExtent(t,o,i,s),e&&n.deleteFromDocument()}}sendToBackground(e){console.log("[ellie]: sending to bg",e),chrome.runtime.sendMessage(e)}getBrowserFromManifest(){if(chrome&&chrome.runtime&&chrome.runtime.getManifest){const e=chrome.runtime.getManifest();if(e.applications)return"Firefox";if(e.manifest_version)return"Chrome"}return"Unknown"}destroy(){this.removeHandlers()}}function normalizeThread(e){let t=[],o=0;for(let i=0;i<e.length;i++){const s=e[i],{author:n,text:r}=s;if(o+=normalize(r).length,t.push({author:n,text:r}),o>10240)break}return t.reverse()}function normalize(e=""){if(0===e.trim().length)return"";const t=e.split("\n");return t.reduce(((e,o,i)=>{const s=!o.trim(),n=void 0!==t[i+1]&&!t[i+1].trim();return s&&n?e:[...e,o.trim()]}),[]).join("\n")}async function parseEml(e){const t=new PostalMime,o=await t.parse(e),{from:i,text:s,date:n,html:r,to:l=[]}=o,{name:d,address:a}=i;return{rawEmailText:s,rawEmailHtml:r,from:{name:d,email:a},date:n,to:l.map((e=>{const{address:t,name:o}=e;return{name:o,email:t}}))}}class EllieUI{positionListener=null;contextDropdown=null;interest=[{label:"Interested",value:"interested"},{label:"Not interested",value:"uninterested"}];btns=[{label:"Respectful",value:"respectful"},{label:"Casual",value:"casual"},{label:"Annoyed",value:"annoyed"}];replyLengths=[{label:"Short reply",value:"short"}];selectedOptions={mood:"respectful",roleUuid:null,interest:"interested",context:"",replyLength:""};role=null;constructor({scrollableContainer:e=document.body,onWriteClicked:t,onBtnClicked:o,onReviewClicked:i,onReviewResponse:s,onSaveSelectedOption:n,userUuid:r,client:l,browserName:d}){this.onWriteClicked=t,this.onBtnClicked=o,this.onReviewClicked=i,this.onReviewResponse=s,this.onSaveSelectedOption=n,this.scrollableContainer=e,this.client=l,this.userUuid=r,this.browserName=d,this.$el=this.createEllieUI()}createEllieUI(){const[e,t,o]=this.createMoodSelect(),i=document.createElement("div");i.classList.add("ellie"),i.appendChild(e),i.appendChild(t),i.appendChild(o);const[s,n]=this.createWriteActions(),r=this.createSettingsBtns();return n.addEventListener("click",this.onWriteClicked),i.appendChild(s),i.appendChild(r),this.$status=n,this.$moodSelect=e,this.$interestSelect=t,this.$replyLengthSelect=o,i}clearOptions(){this.selectedOptions.context="",this.$contextDropdownBtn.setAttribute("data-active",!1)}getSelectedOptions(){const{mood:e="respectful",roleUuid:t,interest:o="interested",context:i="",replyLength:s=""}=this.selectedOptions;return{mood:e,roleUuid:t,interest:o,context:i,replyLength:s}}restoreSelectedOptions(e){[{key:"mood",value:e.mood||this.selectedOptions.mood,$el:this.$moodSelect},{key:"interest",value:e.interest||this.selectedOptions.interest,$el:this.$interestSelect},{key:"replyLength",value:e.replyLength||this.selectedOptions.replyLength,$el:this.$replyLengthSelect}].forEach((({key:e,value:t,$el:o})=>{const i=o.querySelector(`[data-value="${t}"]`);i&&(i.setAttribute("data-active",!0),this.selectedOptions[e]=t,this.onBtnClicked(i,!0))}))}populateRolesDropdown(e=[]){let t=this.$rolesDropdown.querySelector(".list-item-separated");const o=this.$rolesDropdown.querySelector("ul");let i,s;if(!this.$rolesDropdown.querySelector(".none-item")){const e=document.createElement("li");e.classList.add("none-item");const t=document.createElement("button");t.setAttribute("data-selected",!0),t.textContent="No role",t.addEventListener("click",(()=>{this.onRoleSelected(t,o,{uuid:null,name:"Roles"})})),e.appendChild(t),o.appendChild(e)}if(!t){t=document.createElement("li"),t.classList.add("list-item-separated");const i=document.createElement("button");i.textContent=0===e.length?"Create a Role":"Edit Roles",i.addEventListener("click",(function(){chrome.runtime.sendMessage({type:"open-options",tab:"roles"})})),t.appendChild(i),o.appendChild(t)}let n="Roles";for(let r of e){const{uuid:e,name:l,isDefault:d}=r;if(!!o.querySelector(`[data-role-uuid="${e}"]`))continue;const a=document.createElement("li"),c=document.createElement("button");c.textContent=l,c.setAttribute("data-role-uuid",e),c.addEventListener("click",(()=>{this.onRoleSelected(c,o,{uuid:e,name:l})})),d&&(i=r,s=c),a.appendChild(c),o.insertBefore(a,t),this.selectedOptions.roleUuid===e&&(c.setAttribute("data-selected",!0),n=l)}const r=document.querySelector("#roles-toggle-btn > .label");r&&(r.innerHTML=`🧑‍💼 ${n}`),i&&this.onRoleSelected(s,o,i)}onDropdownItemSelected(e,t,{key:o,value:i}){t.querySelectorAll("button").forEach((e=>e.removeAttribute("data-selected"))),e.setAttribute("data-selected",!0),this.selectedOptions[o]=i,this.closeDropdown()}onRoleSelected(e,t,o){this.onDropdownItemSelected(e,t,{key:"roleUuid",value:o.uuid}),document.querySelector("#roles-toggle-btn > .label").innerHTML=`🧑‍💼 ${o.name}`}onOptionSelected(e,t){this.selectedOptions[e]=t,this.onSaveSelectedOption({key:e,value:t})}createMoodSelect(){const e=document.createElement("div"),t=document.createElement("div"),o=document.createElement("div"),i=this.onBtnClicked;e.classList.add("ellies-moods","ellies-btn-group"),t.classList.add("ellies-interest","ellies-btn-group"),o.classList.add("ellies-reply-length","ellies-btn-group");const s=(e,t,o=!1)=>s=>{const n=document.createElement("button");n.textContent=s.label,n.addEventListener("click",(()=>{o?n.getAttribute("data-active")?(n.removeAttribute("data-active"),this.onOptionSelected(t,""),i(n,!1)):(n.setAttribute("data-active",!0),this.onOptionSelected(t,s.value),i(n,!0)):(e.querySelectorAll("button").forEach((e=>{e.removeAttribute("data-active"),i(e,!1)})),n.setAttribute("data-active",!0),this.onOptionSelected(t,s.value),i(n,!0))})),n.setAttribute("data-value",s.value),e.appendChild(n)};return this.btns.forEach(s(e,"mood")),this.interest.forEach(s(t,"interest")),this.replyLengths.forEach(s(o,"replyLength",!0)),[e,t,o]}createWriteActions(){const e=document.createElement("div");e.classList.add("ellies-actions-box");const t=document.createElement("div");t.classList.add("ellies-actions");const o=document.createElement("button");return o.textContent="Write ✏️",o.classList.add("ellies-status"),this.$contextDropdownBtn=this.createContextDropdownBtn(),this.createDropdowns(this.$contextDropdownBtn),t.appendChild(this.$contextDropdownBtn),t.appendChild(o),e.appendChild(t),[e,o]}toggleWriteButton(e){e?(this.$status.classList.remove("disabled"),this.$status.removeAttribute("disabled")):(this.$status.classList.add("disabled"),this.$status.setAttribute("disabled","disabled"))}createSettingsBtns(){const e=document.createElement("div");e.classList.add("ellies-feedback");const t=this.createRolesDropdownBtn(),o=document.createElement("button");return o.classList.add("settings-btn"),o.textContent="❓",o.addEventListener("click",(()=>chrome.runtime.sendMessage({type:"open-options"}))),e.appendChild(t),e.appendChild(o),e}createRolesDropdownBtn(){const e=document.createElement("button");return e.classList.add("ellie-dropdown-btn"),e.setAttribute("id","roles-toggle-btn"),e.innerHTML='<span class="label">🧑‍💼 Roles</span> <span>▾</span>',e.addEventListener("click",this.toggleDropdown.bind(this,e,this.openRolesDropdown.bind(this))),e}createContextDropdownBtn(){const e=document.createElement("span");e.textContent="+";const t=document.createElement("button");return t.classList.add("ellies-extra"),t.addEventListener("click",this.toggleDropdown.bind(this,t,this.openContextDropdown.bind(this))),t.appendChild(e),t}toggleDropdown(e,t,o){o.preventDefault(),o.stopPropagation();return document.body.classList.contains("ellie-is-open")?this.closeDropdown():t(e)}createDropdowns(e){if(!this.$contextDropdown){this.$contextDropdown=document.createElement("div"),this.$contextDropdown.classList.add("ellie-dropdown","ellies-thoughts");const t=document.createElement("p");t.textContent="Extra context:",this.$contextDropdown.appendChild(t);const o=document.createElement("textarea");o.id="ellies-thoughts",o.setAttribute("maxlength",500),o.setAttribute("rows",3),o.setAttribute("placeholder","Keep it short! E.g. 'I am available on Friday' or 'Apologize for the late reply'"),o.addEventListener("input",(t=>{t.target.value?(e.setAttribute("data-active",!0),this.selectedOptions.context=t.target.value):(e.removeAttribute("data-active"),this.selectedOptions.context="")})),this.context=o,this.$contextDropdown.appendChild(o);const i=document.createElement("span");i.textContent="Ellie will try to include this information in the reply. Max 500 characters",this.$contextDropdown.appendChild(i)}if(!this.$upgradeDropdown){this.$upgradeDropdown=document.createElement("div"),this.$upgradeDropdown.classList.add("ellies-upgrade","ellies-notification");const e=document.createElement("p");let t={ref:"plugin",client:this.client};this.accountEmail&&(t={...t,e:this.accountEmail}),this.userUuid&&(t={...t,u:this.userUuid});const o=`https://tryellie.com/upgrade?${new URLSearchParams(t).toString()}`;e.innerHTML=["You've run out of replies for the day!",'Click <a rel="noopener noreferrer" target="_ellie-website" class="ellie-upgrade-link">here</a>',"to get more replies or remove the limit."].join(" "),e.querySelector(".ellie-upgrade-link").href=o,this.$upgradeDropdown.appendChild(e)}if(!this.$reviewDropdown){this.$reviewDropdown=document.createElement("div"),this.$reviewDropdown.classList.add("ellies-review","ellies-review-step-1","ellies-notification");const e=document.createElement("p");e.innerHTML=["Are you happy with Ellie's responses?",'<button id="ellie-review-yes" class="ellie-review-btn">✅ Yes</button>','<button id="ellie-review-no" class="ellie-review-btn">❌ No</button>'].join(" "),this.$reviewDropdown.appendChild(e);this.$reviewDropdown.querySelector("#ellie-review-yes").addEventListener("click",(()=>this.onReviewClicked({response:"yes"}))),this.$reviewDropdown.querySelector("#ellie-review-no").addEventListener("click",(()=>this.onReviewClicked({response:"no"})))}if(!this.$reviewDropdownYes){this.$reviewDropdownYes=document.createElement("div"),this.$reviewDropdownYes.classList.add("ellies-review","ellies-review-step-2","ellies-notification");const e=document.createElement("p");let t,o;"Firefox"===this.browserName?(t="https://addons.mozilla.org/en-US/firefox/addon/ellie-your-ai-email-assistant/reviews/",o="Firefox"):(t="https://chromewebstore.google.com/detail/ellie-your-ai-email-assis/mhcnlcilgicfodlpjcacgglchmpoojcp/reviews",o="Chrome"),e.innerHTML=[`Thank you! Could you give us a review on the ${o} store?`,`<a id="ellie-review-ok" rel="noopener noreferrer" target="_ellie-review" class="ellie-review-link ellie-review-positive" data-review-response="yes-ok" href=${t}>✅ OK!</a>`,'<button id="ellie-review-later" class="ellie-review-btn ellie-review-positive" data-review-response="yes-later">⏰ Later</button>','<button id="ellie-review-never" class="ellie-review-btn ellie-review-positive" data-review-response="yes-never">❌ Never</button>'].join(" "),this.$reviewDropdownYes.appendChild(e);this.$reviewDropdownYes.querySelectorAll(".ellie-review-positive").forEach((e=>e.addEventListener("click",(e=>{const t=e.currentTarget.dataset.reviewResponse;this.onReviewResponse({response:t})}))))}if(!this.$reviewDropdownNo){this.$reviewDropdownNo=document.createElement("div"),this.$reviewDropdownNo.classList.add("ellies-review","ellies-review-step-2","ellies-notification");const e=document.createElement("p"),t="https://airtable.com/appsMy7E6et2CvJB7/shrJ2k7IDtv2FgOSa";e.innerHTML=["We're sorry to hear that, could you give us some feedback on how to improve?",`<a id="ellie-feedback-yes" rel="noopener noreferrer" target="_ellie-feedback" class="ellie-review-link ellie-review-negative" data-review-response="no-ok" href=${t}>✅ OK</a>`,'<button id="ellie-feedback-no" class="ellie-review-btn ellie-review-negative" data-review-response="no-no">❌ No</button>'].join(" "),this.$reviewDropdownNo.appendChild(e);this.$reviewDropdownNo.querySelectorAll(".ellie-review-negative").forEach((e=>e.addEventListener("click",(e=>{const t=e.currentTarget.dataset.reviewResponse;this.onReviewResponse({response:t})}))))}if(!this.$errorDropdown){this.$errorDropdown=document.createElement("div"),this.$errorDropdown.classList.add("ellies-error","ellie-notification");const e=document.createElement("p");this.$errorDropdown.appendChild(e)}if(!this.$rolesDropdown){this.$rolesDropdown=document.createElement("div");const e=document.createElement("ul");this.$rolesDropdown.classList.add("ellie-dropdown","ellie-role-options"),this.$rolesDropdown.append(e),this.populateRolesDropdown()}}setError({type:e="unknown",message:t}){let o;"unknown"===e?o=`Oops, Ellie encountered an error. If this keeps happening, <a href="mailto:hi@tryellie.com">please let us know</a>. Error: ${t}`:"invalid-licence"===e?o='You need to enter your licence key to use Ellie, you can do this from the <a href="#" class="ellie-settings-link">settings page</a>.<br/>Already entered your key? Reload this page to get started!':"licence-overused"===e?o='Your licence key is being used on too many devices, if you want to de-register a device or upgrade your plan please <a href="mailto:hi@tryellie.com">contact us</a>.':"overdue-invoice"===e&&(o='Your invoice is overdue and your subscription will be canceled soon. Please manage your plan and pay your invoice, you can do this from the <a href="#" class="ellie-settings-link">settings page</a>.'),this.$errorDropdown.querySelector("p").innerHTML=o,"invalid-licence"!==e&&"overdue-invoice"!==e||this.$errorDropdown.querySelector(".ellie-settings-link").addEventListener("click",(()=>chrome.runtime.sendMessage({type:"open-options",tab:"licence"})))}setAccountEmail(e,t){this.accountEmail=encodeURIComponent(e),this.userUuid=t;const o=this.$upgradeDropdown.querySelector(".ellie-upgrade-link");if(o){const e=new URL(o.href);e.searchParams.set("e",this.accountEmail),t&&e.searchParams.set("u",this.userUuid),o.href=e.href}}openRolesDropdown(e){document.body.classList.contains("ellie-is-open")||(this.$activeDropdown=this.$rolesDropdown,this.positionListener=this.positionDropdown.bind(this,this.$rolesDropdown,e),this.scrollableContainer.addEventListener("scroll",this.positionListener.bind(this)),document.body.appendChild(this.$rolesDropdown),this.positionDropdown(this.$rolesDropdown,e),document.body.classList.add("ellie-is-open"),document.body.addEventListener("click",this.onBodyClicked.bind(this)))}openContextDropdown(e){document.body.classList.contains("ellie-is-open")||(this.$activeDropdown=this.$contextDropdown,this.positionListener=this.positionDropdown.bind(this,this.$contextDropdown,e),document.body.appendChild(this.$contextDropdown),this.scrollableContainer.addEventListener("scroll",this.positionListener.bind(this)),this.positionDropdown(this.$contextDropdown,e),this.$contextDropdown.querySelector("textarea").focus(),document.body.classList.add("ellie-is-open"),document.body.addEventListener("click",this.onBodyClicked.bind(this)))}positionDropdown(e,t){const{width:o}=e.getBoundingClientRect(),i=t.getBoundingClientRect(),{height:s,width:n,y:r,x:l}=i,d=r+window.scrollY+s+5,a=l-o+n;e.style.top=`${d}px`,e.style.left=`${a}px`}closeDropdown(){document.body.classList.contains("ellie-is-open")&&(document.body.removeChild(this.$activeDropdown),this.scrollableContainer.removeEventListener("scroll",this.positionListener),document.body.classList.remove("ellie-is-open"),document.body.removeEventListener("click",this.onBodyClicked))}onBodyClicked(e){let t=e.target;try{for(;!t.isEqualNode(document.body);){if(t.classList.contains("ellie-dropdown"))return;t=t.parentElement}this.closeDropdown()}catch(e){}}}function reinsertNewlines({text:e,newlines:t,cursorPos:o}){const{start:i,end:s}=o;let n=e.substring(0,i),r=e.substring(s),l=e.substring(i,s),d=0;for(let e of t)if(e<=i){let t=e+d++;n=`${n.substring(0,t)}\n${n.substring(t)}`}else if(e>i&&e<=s){let t=e-(n.length+d++);l=`${l.substring(0,t)}\n${l.substring(t)}`}else if(e>=s){let t=e-(n.length+l.length)+d++;r=`${r.substring(0,t)}\n${r.substring(t)}`}return{textAfter:r,textBefore:n,textSelected:l}}function nodeWalk(e,t){let o=t(e);for(e=e.firstChild;!1!==o&&e;e=e.nextSibling)o=nodeWalk(e,t);return o}function getCaretPosition(e){const t=window.getSelection();let o=[0,0];if(t.anchorNode==e)o=[t.anchorOffset,t.focusOffset];else{let i=[t.anchorNode,t.focusNode];if(!e.contains(t.anchorNode)||!e.contains(t.focusNode))return;{let s,n=[0,0];nodeWalk(e,(function(e){for(s=0;s<2;s++)if(e==i[s]&&(n[s]=!0,n[0==s?1:0]))return!1;if(e.textContent&&!e.firstChild)for(s=0;s<2;s++)n[s]||(o[s]+=e.textContent.length)})),o[0]+=t.anchorOffset,o[1]+=t.focusOffset}}return o[0]<=o[1]?o:[o[1],o[0]]}function getNewlineLocations(e){let t=0,o=[];const i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT,null,!1);let s;for(;s=i.nextNode();)"#text"===s.nodeName?t+=s.textContent.length:"BR"===s.nodeName&&(o=[...o,t]);return o}function waitForElement(e,t,o=document){const i=o.querySelector(e);return i&&null!==i.offsetParent?t(i.parentElement):setTimeout(waitForElement.bind(this,e,t),50)}