(()=>{"use strict";const e="browser"in self?browser:chrome;class t{constructor(t){if(this.behavior="disable",this.days=0,this.idleLength=60,this.timerInterval=1440,this.deleteMode="timer",this.notifications=!1,this.downloads=!1,this.icon="theme",this.lastRun=e.i18n.getMessage("lastRunNever"),this.deleteCount=0,void 0===t)return;const i=e.runtime.getManifest().manifest_version;"string"==typeof t.behavior&&["disable","days","all"].includes(t.behavior)?this.behavior=t.behavior:"number"==typeof t.days&&t.days>0&&(this.behavior="days"),"number"==typeof t.days&&t.days>=0&&(this.days=t.days),"number"==typeof t.idleLength&&t.idleLength>=15&&(this.idleLength=t.idleLength),"number"==typeof t.timerInterval&&t.timerInterval>=1&&(this.timerInterval=t.timerInterval),"string"==typeof t.deleteMode&&["idle","startup","timer"].includes(t.deleteMode)&&(this.deleteMode=t.deleteMode),3===i&&"idle"===this.deleteMode&&(this.deleteMode="timer"),"boolean"==typeof t.notifications&&(this.notifications=t.notifications),"boolean"==typeof t.downloads&&(this.downloads=t.downloads),"string"==typeof t.lastRun&&(this.lastRun=t.lastRun),"string"==typeof t.icon&&(this.icon=t.icon),3===i&&"theme"===this.icon&&(this.icon="icon_circle_gradient")}}async function i(i){const n=i??new t(await e.storage.local.get());if("days"===n.behavior){const t=new Date;t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0),t.setDate(t.getDate()-n.days),await e.history.deleteRange({startTime:0,endTime:t.getTime()}),n.downloads&&await e.downloads.erase({endedBefore:t.toISOString()});const i=e.i18n.getMessage("historyDeletedNotificationBody",[t.toLocaleString(),(new Date).toLocaleString()]);console.log(i),n.notifications&&e.notifications.create({type:"basic",iconUrl:"icons/icon-96.png",title:e.i18n.getMessage("historyDeletedNotification"),message:i}),e.storage.local.set({lastRun:i})}else if("all"===n.behavior){const t=e.i18n.getMessage("historyAllDeleted",[(new Date).toLocaleString()]);await e.history.deleteAll(),n.downloads&&await e.downloads.erase({endedBefore:(new Date).toISOString()}),console.log(t),n.notifications&&e.notifications.create({type:"basic",iconUrl:"icons/icon-96.png",title:e.i18n.getMessage("historyDeletedNotification"),message:t}),e.storage.local.set({lastRun:t})}}var n;!function(e){e[e.INVALID=-1]="INVALID",e[e.DELETE=0]="DELETE",e[e.SET_IDLE=1]="SET_IDLE",e[e.SET_STARTUP=2]="SET_STARTUP",e[e.SET_TIMER=3]="SET_TIMER",e[e.SET_ICON=4]="SET_ICON"}(n||(n={}));class s{constructor(e){this.state=e?.state??-1,this.idleLength=e?.idleLength??-1,this.timerInterval=e?.timerInterval??-1,this.icon=e?.icon??"theme"}}function a(e){switch(e){case"theme":default:return"icons/icon.svg";case"icon_circle":return"icons/icon_red_circle.png";case"icon_circle_gradient":return"icons/icon_red_circle_gradient.png";case"icon_square":return"icons/icon_red_square.png";case"icon_square_gradient":return"icons/icon_red_square_gradient.png"}}function o(e){"idle"===e&&i()}async function r(){const n=new t(await e.storage.local.get());switch(n.deleteMode){case"idle":e.idle.setDetectionInterval(n.idleLength),e.idle.onStateChanged.addListener(o);break;case"startup":i();break;case"timer":e.alarms.create("DeleteHistoryAlarm",{delayInMinutes:1,periodInMinutes:n.timerInterval})}e.browserAction.setIcon({path:a(n.icon)})}e.alarms.onAlarm.addListener((async function(e){"DeleteHistoryAlarm"===e.name&&i()})),e.runtime.onMessage.addListener((async function(t){const r=new s(t);switch(r.state){case n.DELETE:i();break;case n.SET_IDLE:e.idle.onStateChanged.hasListener(o)&&e.idle.onStateChanged.removeListener(o),e.idle.setDetectionInterval(r.idleLength),e.idle.onStateChanged.addListener(o),e.alarms.clear("DeleteHistoryAlarm");break;case n.SET_STARTUP:e.idle.onStateChanged.hasListener(o)&&e.idle.onStateChanged.removeListener(o),e.alarms.clear("DeleteHistoryAlarm");break;case n.SET_TIMER:e.idle.onStateChanged.hasListener(o)&&e.idle.onStateChanged.removeListener(o),e.alarms.clear("DeleteHistoryAlarm"),e.alarms.create("DeleteHistoryAlarm",{delayInMinutes:1,periodInMinutes:r.timerInterval});break;case n.SET_ICON:e.browserAction.setIcon({path:a(r.icon)})}})),e.runtime.onInstalled.addListener((async function(i){if("install"===i.reason||"update"===i.reason){const n=new t(await e.storage.local.get());await e.storage.local.set(n);const s=new t(await e.storage.sync.get());await e.storage.sync.set(s),r(),"install"===i.reason&&e.runtime.openOptionsPage()}})),e.runtime.onStartup.addListener(r)})();
//# sourceMappingURL=background.bundle.js.map