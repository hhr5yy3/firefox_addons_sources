!function(){"use strict";customCss006.c();const e=+new URL(location.href).searchParams.get("batchId"),t=index001.a({maxActiveReader:3});let n,r;pref002.b.runtime.sendMessage({method:"getBatchData",batchId:e}).then((async r=>{await pref002.p.ready(),n=function({tabs:n,env:r}){var o=document.querySelector(".main-container"),c=document.createDocumentFragment();const i=n.map((n=>({tabId:n.tabId,images:[].concat(...n.frames.map((r=>r.images.map((a=>{const o=function({url:n,frameId:r,tabId:a,referrer:o,alt:c,pickaId:i}){const s=document.createElement("label"),d=document.createElement("input");let l;s.className="image-checkbox checked",s.onclick=e=>{if(e.target==d||d.disabled)return;const t=d.checked;setTimeout((()=>{d.checked==t&&(l.toggleCheck(),d.focus())}))},d.type="checkbox",d.checked=!0,d.onchange=()=>{s.classList.toggle("checked",d.checked)},s.title=n;const m=document.createElement("div");m.className="image-checkbox-image-container";const u=new Image;u.className="image-checkbox-cover",u.alt="",env005.I?u.draggable=!1:u.ondragstart=()=>!1;let h=!1;return u.onmousedown=e=>{1==e.button&&(e.preventDefault(),h=!0)},u.onmouseup=e=>{h&&1==e.button&&(h=!1,expandEnv003.c({url:n,openerTabId:"CURRENT_TAB",active:!1}),e.preventDefault())},m.append(u),s.append(d,m),l={url:n,data:null,alt:c,pickaId:i,el:s,cover:u,tabId:a,frameId:r,toggleEnable(e){s.classList.toggle("disabled",!e),d.disabled=!e},toggleCheck(){s.classList.toggle("checked"),d.checked=!d.checked},selected:()=>!d.disabled&&d.checked,load:g};function f(e){try{return new URL(e),!0}catch{return!1}}async function g(){let c;try{c=new URL(n).origin}catch{}try{return c?await t.read([c],i):await i()}catch(e){throw l.error=!0,s.classList.add("error"),e}async function i(){if(!f(n))throw new Error(`Invalid URL: ${n}`);const t=await pref002.b.runtime.sendMessage({method:"cacheImage",url:n,tabId:a,frameId:r,referrer:o,batchId:e});if(l.data=t,u.parentNode.insertBefore(function(e,t){const n=document.createElementNS("http://www.w3.org/2000/svg","svg");return n.classList.add("image-checkbox-image"),n.setAttribute("height",t),n.setAttribute("viewBox",`0 0 ${e} ${t}`),n}(t.width,t.height),u),u.dataset.src=n,function(e){let t=!1,n="";const r=index001.c();if("undefined"==typeof IntersectionObserver)return void o();const a=new IntersectionObserver((e=>{for(const t of e)t.isIntersecting?o():i()}));function o(){r.write((()=>t?c():s(e,e.dataset.src).catch((()=>(t=!0,c())))))}function c(){return pref002.b.runtime.sendMessage({method:"getCacheURL",url:e.dataset.src}).then((t=>{n=t,e.style.backgroundImage=`url(${t})`,e.style.backgroundSize="100%"}))}function i(){r.write((()=>{if(t||(e.src=""),e.style.backgroundImage="",n)return pref002.b.runtime.sendMessage({method:"revokeURL",url:n}).catch(console.error)}))}function s(e,t){return new Promise(((n,r)=>{function a(){n(),c()}function o(){r(new Error(`Failed to load image: ${t}`)),c()}function c(){e.removeEventListener("load",a),e.removeEventListener("error",o)}e.src=t,e.addEventListener("load",a),e.addEventListener("error",o)}))}a.observe(e)}(u),pref002.p.get("displayImageSizeUnderThumbnail")){const e=document.createElement("span");e.className="image-checkbox-info",e.textContent=`${t.width} x ${t.height}`,s.append(e)}else t.width&&(s.title+=` (${t.width} x ${t.height})`);var c;s.title+=` [${c=t.size,`${(c/1024).toFixed(2)} KB`}]`,u.dispatchEvent(new CustomEvent("imageLoad",{bubbles:!0,detail:{image:l}}))}}}({frameId:r.frameId,tabId:n.tabId,...a});return pref002.p.get("selectByDefault")||o.toggleCheck(),o}))))),env:n.env}))),s=function(){let e=0,t=0,n=0;const r=document.createElement("div");return r.className="progress-bar",a(),document.body.appendChild(r),{add:function(o){e++,a(),o.catch((e=>{console.error(e),r.classList.add("error"),n++})).then((()=>{t++,a()}))}};function a(){r.classList.toggle("started",e>0),r.classList.toggle("finished",t===e),r.style.setProperty("--progress-total",e),r.style.setProperty("--progress-completed",t);const a=pref002.b.i18n.getMessage("pickerProgress",[Math.floor(100*t/e),t,e,n]);document.title=a}}();if(pref002.p.get("isolateTabs")&&1!==i.length){const e=document.createElement("ul");e.className="tab-container";for(const t of i){if(!t.images.length)continue;const n=document.createElement("li");n.className="image-container";for(const e of t.images)n.appendChild(e.el),s.add(e.load());const r=document.createElement("div");r.className="tab-image-counter",n.appendChild(r),e.appendChild(n)}c.appendChild(e)}else{const e=document.createElement("div");e.className="image-container";const t=new Set;for(const n of i)for(const r of n.images)t.has(r.url)||(t.add(r.url),e.append(r.el),s.add(r.load()));c.appendChild(e)}o.appendChild(c),function(e,t){var n=pref002.p.getAll(),r=["minFileSize","minWidth","minHeight","matchUrl","matchType"];n.matchUrl&&(n.matchUrl=a(n.matchUrl));function a(e){try{return new RegExp(e,"i")}catch(e){console.error(e)}return null}function o(e){if(e.error||!e.data)return!1;const{width:t,height:r,size:a}=e.data,o=e.url;return a&&(!t||t>=n.minWidth)&&(!r||r>=n.minHeight)&&(!n.matchUrl||n.matchUrl.test(o)==("include"==n.matchType))&&a>=1024*n.minFileSize}function c(e){e.toggleEnable(o(e))}function i(){for(var e of t)c(e)}pref002.p.on("change",(e=>{r.some((t=>null!=e[t]))&&(Object.assign(n,e),n.matchUrl&&"string"==typeof n.matchUrl&&(n.matchUrl=a(n.matchUrl)),i())})),e.addEventListener("imageLoad",(e=>{var{image:t}=e.detail;c(t)})),i()}(o,f()),function(e){const t={previewMaxHeight:e=>document.documentElement.style.setProperty("--previewMaxHeight",e),previewMaxHeightUpperBound:e=>document.querySelector("#previewMaxHeight").max=e,filePatternBatch:a(e)};pref002.p.on("change",(e=>{for(const n in e)t[n]&&t[n](e[n])}));for(const e in t)t[e](pref002.p.get(e))}(i);var d={invert(){f().forEach((e=>e.toggleCheck()))},async save(t){t.target.disabled=!0;try{await pref002.b.runtime.sendMessage({method:"batchDownload",tabs:i.map((e=>Object.assign({},e,{images:e.images.filter((e=>e.selected())).map((e=>({url:e.url,filename:e.data.filename,alt:e.alt})))}))),env:r,batchId:e}),await pref002.b.runtime.sendMessage({method:"closeTab"})}catch(e){console.error(e),alert(e)}finally{t.target.disabled=!1}},copyUrl(){const e=document.createElement("textarea");e.value=h(f()).join("\n"),document.body.appendChild(e),e.select(),document.execCommand("copy"),e.remove(),this.originalTextContent||(this.originalTextContent=this.textContent),this.style.minWidth=this.offsetWidth+"px",this.textContent=pref002.b.i18n.getMessage("pickerActionCopyUrlCopied"),null!=this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{this.textContent=this.originalTextContent,this.style.minWidth="",this.timer=null}),1e3)},cancel(){pref002.b.runtime.sendMessage({method:"closeTab"})}},l=document.querySelector(".actions");for(var[m,u]of Object.entries(d))l.querySelector(`.${m}`).onclick=u;return{coverToCheck:g};function h(e){return e.filter((e=>e.selected())).map((e=>e.url))}function f(){return[].concat(...i.map((e=>e.images)))}function g(e){for(const t of f())if(t.cover===e)return t;throw new Error("Failed converting cover to check")}}(r)}));for(const e of document.querySelectorAll(".toolbar"))e.querySelector(".toolbar-expand-button").addEventListener("click",(()=>{e.classList.toggle("expanded")}));inputHistory007.a({pref:pref002.p,root:document.body,keyPrefix:""}),customCss006.t(document.body);for(const e of document.querySelectorAll(".history-container input"))inputHistory007.s(e,e.id);function a(e){let t,n;return r=>{if(!n||!n.selected){const[r,a]=function(e){let t,n;for(const r of e){t=r.env;for(const e of r.images)if(e.selected())return n=e,[t,n]}for(const t of e)if(t.images.length)return[t.env,t.images[0]];throw new Error("failed finding selected image, no image available")}(e);t=Object.assign({},r),n=a}expandEnv003.e(t),expandEnv003.b(t,{index:1,url:n.url,base:n.data&&n.data.filename,alt:n.alt});const a=expandEnv003.a(r)(t);document.querySelector("#filePatternBatch").closest(".toolbar-control").title=`Preview: ${a}`}}document.addEventListener("contextmenu",(e=>{r=e.target})),pref002.b.runtime.onMessage.addListener((e=>{if("viewSourceElementClicked"===e.method)return async function(e){let t;t=e.elementId?pref002.b.menus.getTargetElement(e.elementId):r;if(!t)throw new Error("No element found");const a=n.coverToCheck(t);await Promise.all([pref002.b.tabs.update(a.tabId,{active:!0}),pref002.b.tabs.sendMessage(a.tabId,{method:"viewSourceElement",pickaId:a.pickaId},{frameId:a.frameId})])}(e)}))}();
//# sourceMappingURL=picker.js.map
