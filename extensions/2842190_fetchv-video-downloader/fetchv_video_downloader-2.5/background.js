const e=browser;let t=!1;const n={};let r={};e.browserAction.setBadgeTextColor({color:"#FFFFFF"}),e.browserAction.setBadgeBackgroundColor({color:"#FF0000"});const o=()=>{const t=e=>{e?.size?.min&&(e.size.min=1024*e.size.min,e.size.min<0&&(e.size.min=0)),e?.size?.max&&(e.size.max=1024*e.size.max,e.size.max<0&&(e.size.max=0))};return new Promise((n=>{try{e.storage.sync.get(["options"]).then((e=>{if(void 0!==e.options){const t=e.options;for(let e in OPTION)void 0!==t[e]&&(OPTION[e]=t[e])}t(OPTION),n()}))}catch(e){t(OPTION),n()}}))},i=(t,n)=>{let r=Object.keys(t).length;r=r>0?r.toString():"",e.browserAction.setBadgeText({text:r,tabId:n})};e.runtime.onConnect.addListener((function(e){if("POPUP"===e.name)return t=!0,void e.onDisconnect.addListener((function(){t=!1,r={}}))})),e.runtime.onMessage.addListener((function(t,i,s){const{cmd:a,parameter:l}=t;if("FIREFOX_FETCH"===a){const{url:e,options:t}=l,{headers:n,method:r}=t,o=new AbortController,i=setTimeout((()=>{o.abort()}),2e4),a={signal:o.signal,method:r,mode:"cors",credentials:"omit",headers:n};return fetch(e,a).then((e=>{if(e.ok)return e.blob();s({ok:!1,statusText:`Fetch Error-${e.status}`})})).then((function(e){s({ok:!0,blobURL:URL.createObjectURL(e)})})).catch((function(e){"AbortError"===e.name?s({ok:!1,statusText:"Request Timeout"}):s({ok:!1,statusText:e.messsage})})).finally((()=>{clearTimeout(i)})),!0}if("OPEN_INITIATOR"===a){const{initiator:t}=l;return e.tabs.create({url:t,index:i.tab.index+1}),s(""),!0}if("RESET_OPTIONS"===a){const{storageKey:e}=l;return o().then((()=>{if(!e)return void s();const t=n[e],r=[];for(const e in t){const n=t[e],o=new URL(n.url).hostname;o&&OPTION.domain.includes(o)&&r.push(e)}if(r.length>0){for(const e of r)delete t[e];0===Object.keys(t).length&&delete n[e]}s()})),!0}if("GET_STORAGE"===a){const{storageKey:e}=l;return s(n[e]||{}),!0}if("ADD_POPUP_PLAYER_HEADER"===a){const e=JSON.stringify(l.url);return r[e]=l.headers,s(),!0}})),e.tabs.onRemoved.addListener((function(e){const t=`storage${e}`;n[t]&&delete n[t]})),e.tabs.onUpdated.addListener((function(e,t,r){if("loading"===t.status&&t.url){const t=`storage${e}`;i({},e),n[t]&&delete n[t]}})),async function(){await o();const s=(e,t)=>{e=e.toLowerCase();for(let n=0;n<t.length;n++)if(t[n].name.toLowerCase()===e)return t[n].value.toLowerCase();return null},a=(e,t)=>{let n={m3u8:"video/mp4",m3u:"video/mp4",mp4:"video/mp4","3gp":"video/3gpp",flv:"video/x-flv",mov:"video/quicktime",avi:"video/x-msvideo",wmv:"video/x-ms-wmv",webm:"video/webm",ogg:"video/ogg",ogv:"video/ogg",f4v:"video/x-f4v",acc:"application/vnd.americandynamics.acc",mkv:"video/x-matroska",rmvb:"application/vnd.rn-realmedia-vbr",m4s:"video/iso.segment",mp3:"audio/mpeg",wav:"audio/wav"};return n[e]?n[e]:t},l={},u=["youtube.com","globo.com"],m=["m3u8","m3u","mp4","3gp","flv","mov","avi","wmv","webm","f4v","acc","mkv","mp3","wav","ogg"],c=["range","content-length","content-type","accept-encoding","accept","accept-language"];e.webRequest.onBeforeSendHeaders.addListener((function(e){let{originUrl:t,requestHeaders:n,requestId:o,type:i,url:s}=e;if(0===t.indexOf("moz-extension")){if(t.endsWith("popup.html")){const e=JSON.stringify(s);if(void 0!==r[e]){const t=r[e];n=n.filter((e=>!["referer","origin","referrer"].includes(e.name.toLowerCase())));for(const e in t){const r=e.toLowerCase(),o=n.filter((e=>e.name.toLowerCase()===r));if(o.length>0)for(const n of o)n.name=e,n.value=t[e];else n.push({name:e,value:t[e]})}setTimeout((()=>{delete r[e]}),1e3)}}else if("xmlhttprequest"===i){n=n.filter((e=>{const t=e.name.toLowerCase();return!["referer","origin","referrer"].includes(t)&&(!!t.startsWith("fv_")||!n.find((e=>e.name.toLowerCase()===`fv_${t}`)))}));for(const e of n)e.name.toLowerCase().startsWith("fv_")&&(e.name=e.name.substring(3))}}else l[o]=n;return{requestHeaders:n}}),{urls:["<all_urls>"],types:["media","xmlhttprequest","object","other"]},["blocking","requestHeaders"]),e.webRequest.onResponseStarted.addListener((async function(r){let{requestId:o,originUrl:d,url:f,tabId:g,responseHeaders:p,statusCode:v}=r,h={};if(l[o]&&(h=l[o],delete l[o]),0!==f.indexOf("http"))return;if(!d)return;if(0!==d.indexOf("http"))return;const O=new URL(d).hostname;for(const e of u)if(O.endsWith(e))return;if(0===d.indexOf(OPTION.site))return;if(-1===g){if(!await new Promise((t=>{e.tabs.query({active:!0,lastFocusedWindow:!0}).then((([e])=>{e&&e.url.includes(d)?(g=e.id,t(!0)):t(!1)}))})))return}if(p.length<1)return;if(v<200||v>300)return;const w=new URL(f).hostname;if(w){if((e=>{const t=["zg9wcglvy2ru","ywr0bmc=","amf2agrozwxsbw==","ywzjzg4=","c2fjzg5zc2vkz2u=","c3vycml0"],n=e.split(".");n.pop();const r=n.length;if(r>1){const e=n[r-1];if(t.indexOf(btoa(e).toLowerCase())>-1)return!0}return!1})(w))return;if(OPTION.domain.includes(w))return}let b=0,x=(e=>{let t=s("Content-Range",e);return t?(t=t.split(" "),2!==t.length?null:(t=t[1].split("/"),2!==t.length?null:(t[1]=parseInt(t[1]),t[1]?{chunk:t[0],total:t[1]}:null))):null})(p);b=x?x.total:(e=>{let t=s("Content-Length",e);return t?(t=parseInt(t),t<1?0:t):0})(p);let T=s("content-type",p);if(!T)return;let y=(e=>{const{responseHeaders:t,url:n}=e;let r=null,o=s("content-disposition",t);if(o){o=o.split(";");for(let e=0;e<o.length;e++)if(o[e].indexOf("filename=")>-1){if(o[e]=o[e].replace(/filename=/i,"").replace(/\"/g,"").replace(/\'/g,"").replace(/(^\s*)|(\s*$)/g,""),r=o[e],r)return r;break}}return o=n.replace(/http:\/\//i,"").replace(/https:\/\//i,""),o=o.split("?"),o=o[0].split("/"),o.length<2?null:(o=o[o.length-1],o||r)})(r);y||(y="no-filename");let P=((e,t)=>{if(e.includes("master.txt")&&0===t.indexOf("text/plain"))return"m3u8";let n=(e=>{let t=e.split(".");return t.length<2?null:t[t.length-1].toLowerCase()})(e);const r=["m3u8","m3u","mp4","webm","avi","ogg","flv","mkv","3gp","mp3"];let o={general:{"application/vnd.apple.mpegurl":["m3u8","m3u"],"application/x-mpegurl":["m3u8","m3u"],"application/vnd.americandynamics.acc":["acc"],"application/vnd.rn-realmedia-vbr":["rmvb"],"video/mp4":["mp4","m4s"],"video/3gpp":["3gp"],"video/3gpp2":["3gp2"],"video/x-flv":["flv"],"video/quicktime":["mov"],"video/x-msvideo":["avi"],"video/x-ms-wmv":["wmv"],"video/webm":["webm"],"video/ogg":["ogg","ogv"],"video/x-f4v":["f4v"],"video/x-matroska":["mkv"],"video/iso.segment":["m4s"],"audio/mpeg":["mp3"],"audio/wav":["wav"],"audio/ogg":["ogg"]},stream:{"application/octet-stream":r,"binary/octet-stream":r}};if(o.general[t]){if(!n)return o.general[t][0];let e=o.general[t].indexOf(n);return e<0?o.general[t][0]:o.general[t][e]}if(o.stream[t]){if(!n)return null;let e=o.stream[t].indexOf(n);return e<0?null:o.stream[t][e]}return r.includes(n)?n:null})(y,T);if(!P)return;if(m.indexOf(P)<0)return;let L=P;if("m3u8"!==P&&"m3u"!==P){if(!b)return;if(OPTION.size.min&&b<OPTION.size.min)return;if(OPTION.size.max&&b>OPTION.size.max)return}else L="hls";const I=`storage${g}`;let z=n[I];if(z||(z={},n[I]=z),Object.keys(z).length>30)return;if(((e,t)=>{for(let n in t)if(t[n].url===e)return!0;return!1})(f,z))return;const k={};for(const e in h){const t=h[e];c.includes(t.name.toLowerCase())||(k[`FV_${t.name}`]=t.value)}const C="POST"===r.method?"POST":"GET";z[o]={storageKey:I,requestId:o,url:f,method:C,format:P,contentType:a(P,T),name:y,size:b,headers:k,type:L},t&&e.runtime.sendMessage({cmd:"POPUP_APPEND_ITEMS",parameter:{tab:g,item:{[o]:z[o]}}}),i(z,g)}),{urls:["<all_urls>"],types:["media","xmlhttprequest","object","other"]},["responseHeaders"])}();