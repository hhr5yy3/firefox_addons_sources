class TagSelectPanel extends SelectPanel{originalParams;searchKeyword;rawData;onChanged;onClosed;pinSelected=!0;static open(t){angular.element("html").scope().$broadcast("TAG.SELECT.PANEL.OPEN",t)}constructor(t){super(t)}init(t){this.originalParams=t,super.init(t),this.pinSelected=t.pinSelected??!0,this.reset(),this.initRawData(t),this.updateItemList(),this.onChanged=t.onChanged||(()=>{}),this.showCreateTagBtn=t.showCreateTagBtn??!0}reset(){super.reset(),this.listData.selectedTags={},this.rawData={tags:[],tagItemsMap:{},tagGroups:[],tagGroupsMap:{},selectedTags:{}}}initRawData(t){this.rawData={tagManager:t.tagManager,tags:angular.copy(t.tagManager.allTags)||[],tagItemsMap:{},tagGroups:angular.copy(t.tagManager.groups)||[],tagGroupsMap:{},tagGroupsIndexMap:{},selectedTags:t.selectedTags||{},recentTagsMap:{}},this.rawData.tagGroupsMap.none={},this.rawData.tagGroups.forEach((t,e)=>{this.rawData.tagGroupsMap[t.id]=t,this.rawData.tagGroupsIndexMap[t.id]=e}),this.rawData.tags.forEach(t=>{var{name:t,pinyin:e,groups:a,imageCount:s}=t,r=a[0],i=a.reduce((t,e)=>(t[e]=!0,t),{}),r=(r||(i.none=!0),{type:"tag",id:t,name:t,color:r?this.rawData.tagGroupsMap[r]?.color:void 0,size:26,group:r||"none",groups:a,groupsMap:i,pinyin:e,imageCount:s});this.rawData.tagItemsMap[t]=r}),Object.keys(this.rawData.selectedTags).forEach(t=>{var e;this.rawData.tagItemsMap[t]||(e={type:"tag",id:t,name:t,color:void 0,size:26,group:"none",groups:[],groupsMap:{none:!0},pinyin:Pinyin.convertToPinyin(t),imageCount:0},this.rawData.tagItemsMap[t]=e,this.rawData.tags.push(e))});let a=1;t=t.tagManager.recentTags.filter(t=>void 0!==this.rawData.tagItemsMap[t]).slice(0,12).reduce((t,e)=>(t[e]=a++,t),{}),this.rawData.recentTagsMap=t,this.listData.selectedTags={...this.rawData.selectedTags},this.listData.tagGroups=this.rawData.tagGroups,this.listData.tagGroupsCountMap={},delete this.listData.currentGroup}updateItemList(){this.listData.currentIndex=-1,this.listData.items=[];const i=this.listData.searchKeyword;let n=this.showCreateTagBtn&&""!==i,o=[],h=[];var t=[];let p={};this.rawData.tags.forEach(t=>{var t=t.name,e={...this.rawData.tagItemsMap[t]},a=this.listData.selectedTags[t],s=p[t],r=void 0!==this.rawData.recentTagsMap[t];e.isRecent=r,a&&this.pinSelected?h.push(e):s||o.push(e),t===i&&(n=!1)}),0<t.length&&(o=[...t,...o]),h=(h=h.sort((t,e)=>(t=t.name)<(e=e.name)?-1:e<t?1:0)).sort((t,e)=>{var t=t.group,e=e.group,a=this.rawData.tagGroupsIndexMap[t],s=this.rawData.tagGroupsIndexMap[e];return!t&&e?1:t&&!e||a<s?-1:s<a?1:0}),o=(o=(o=(o=(o=o.sort((t,e)=>{var t="none"!==t.group?t.group:void 0,e="none"!==e.group?e.group:void 0,a=this.rawData.tagGroupsIndexMap[t],s=this.rawData.tagGroupsIndexMap[e];return!t&&e?1:t&&!e||a<s?-1:s<a?1:0})).sort((t,e)=>{var a="none"!==t.group?t.group:void 0,s="none"!==e.group?e.group:void 0,t=t.name,e=e.name;if(a===s){if(t<e)return-1;if(e<t)return 1}return 0})).sort((t,e)=>(t=t.isSuggestion,e=e.isSuggestion,t&&!e?-1:!t&&e?1:0))).sort((t,e)=>(t=t.isRecent,e=e.isRecent,t&&!e?-1:!t&&e?1:0))).sort((t,e)=>{var a=this.rawData.recentTagsMap[t.name],s=this.rawData.recentTagsMap[e.name],t=t.isRecent,e=e.isRecent;if(t&&e){if(a<s)return-1;if(s<a)return 1}return 0}),h=this.filterByKeyword(h),o=this.filterByKeyword(o);t=[...h,...o];this.listData.tagGroupsCountMap={},this.listData.tagGroupsCountMap.all=t.length,t.forEach(t=>{t.group,Object.keys(t.groupsMap).forEach(t=>{void 0===this.listData.tagGroupsCountMap[t]&&(this.listData.tagGroupsCountMap[t]=0),this.listData.tagGroupsCountMap[t]++})}),h=this.filterByGroup(h),o=this.filterByGroup(o),0<h.length?this.listData.items=[...h,{type:"separator",size:5},...o]:this.listData.items=[...o],n&&(0<this.listData.items.length?this.listData.items=[{type:"create",size:26,name:i},{type:"separator",size:5},...this.listData.items]:this.listData.items=[{type:"create",size:26,name:i}]),this.listData.items.forEach((t,e)=>{t.index=e}),""!==i?(t=this.listData.items.find(t=>"tag"===t.type))&&t.name.toLowerCase().startsWith(i.toLowerCase())?this.listData.currentIndex=t.index:0<this.listData.items.length?this.listData.currentIndex=0:this.listData.currentIndex=-1:this.listData.currentIndex=-1}filterByKeyword(t){if(0!==this.listData.searchKeyword.length){const a=chineseConvert.tw2cn(this.listData.searchKeyword);var e=(t=t.map(t=>{var e=chineseConvert.tw2cn(t.name);return 30<=t.name.length?{item:t,name:e,search:[e]}:{item:t,name:e,search:[e,...new Set(cartesianProduct(pinyinlite(e,{keepUnrecognized:!0}).filter(t=>0<t.length)).map(t=>t.join(" ")))]}}).map(t=>({item:t,name:`${t.name??""} `+(t.keywords??""),score:Math.max(...t.search.map(t=>t.score(a)))})).filter(t=>0<t.score).sort((t,e)=>e.score-t.score).map(t=>t.item.item)).reduce((t,e)=>((e.name.toLowerCase().startsWith(this.listData.searchKeyword.toLowerCase())?t.startWithKeyword:t.notStartWithKeyword).push(e),t),{startWithKeyword:[],notStartWithKeyword:[]});t=[...e.startWithKeyword,...e.notStartWithKeyword]}return t}filterByGroup(t){return this.listData.currentGroup?.id?t.filter(t=>{try{return t.groupsMap[this.listData.currentGroup.id]}catch(t){return!1}}):t}getCallbackResult(){var t,e=this.rawData.selectedTags,a=this.listData.selectedTags;return e=Object.entries(e),t=Object.entries(a),{isDirty:!(e.length===t.length&&e.every(([t,e])=>a[t]===e)),selectedTags:{...this.listData.selectedTags},deselectedTags:Object.entries(this.rawData.selectedTags).reduce((t,[e])=>(this.listData.selectedTags[e]||(t[e]=!0),t),{})}}close(){var t=this.getCallbackResult();t.isDirty&&this.onChanged(t),this.onClosed(),super.close(),this.reset()}selectGroup(t){this.listData.currentGroup="none"===t?{id:"none"}:t,this.updateItemList()}onPaste(e){var a=clipboard.readText();if(a){let t=this.parseTags(a);1<t.length&&(e.preventDefault(),e.stopPropagation(),t=(t=t.map(t=>t.trim())).filter(t=>t&&0<t.trim().length),this.createdTags(t))}}onTabKey(t){var t=t.shiftKey,e=[void 0,...this.rawData.tagGroups.map(t=>t.id),"none"],a=this.listData.currentGroup?.id,a=e.indexOf(a),t=t?e[(a-1)%e.length]:e[(a+1)%e.length];this.listData.currentGroup="none"===t?{id:"none"}:this.rawData.tagGroupsMap[t],this.updateItemList()}openItem(t){var e;"create"===t.type?(e=this.parseTags(this.listData.searchKeyword),this.createdTags(e)):(e=t.name,(t=this.listData.selectedTags)[e]?delete t[e]:t[e]=!0,""!==this.listData.searchKeyword&&(this.listData.searchKeyword="",this.clearSearchInput(),this.updateItemList()))}keywordChanged(){this.updateItemList()}isItemSelectable(t){return{tag:!0,create:!0}[t.type]}createdTags(t){if(0!==t.length){t=[...new Set(t)];let i={...this.listData.selectedTags};const n=this.rawData.tagGroupsMap[this?.listData?.currentGroup?.id];t.forEach(t=>{var e,a,s,r;this.rawData.tagItemsMap[t]||(e=n?n.id:"none",r=n?n.color:void 0,s=(a=n?[n.id]:[]).reduce((t,e)=>(t[e]=!0,t),{}),n||(s.none=!0),r={type:"tag",id:t,name:t,color:r,size:26,group:e,groups:a,groupsMap:s,pinyin:Pinyin.convertToPinyin(t),imageCount:0},this.rawData.tagItemsMap[t]=r,this.rawData.tags.push(r)),i[t]=!0}),this.listData.searchKeyword="",this.listData.selectedTags=i,this.clearSearchInput(),this.updateItemList()}}parseTags(t){try{return t.split(/[，,;、\n]+/).filter(t=>0<t.trim().length)}catch(t){return[]}}}EagleApp.directive("tagSelectPanel",["$timeout",r=>({restrict:"E",templateUrl:"js/directives/tag-select-panel.html",replace:!1,scope:{theme:"=theme"},link:(a,t)=>{const s=new TagSelectPanel({scope:a,panelSelector:"#tag-select-panel",searchInputSelector:"#tag-select-panel-search-input",onSelectChanged:t=>{"keyboard"===t.type&&a.$broadcast("VS-REPEAT-AUTO-SCROLL",t.index)}});a.$on("TAG.SELECT.PANEL.OPEN",(t,e)=>{s.init(e),r(()=>{s.open({preventCollisionWithElement:e.preventCollisionWithElement})},25),Object.assign(a,{listData:s.listData,selectGroup:t=>{s.selectGroup(t)},openItem:t=>{s.openItem(t)},hoverItem:t=>{s.hoverItem(t.index)},close:()=>{s.close()},focusSearchInput:()=>{s.focusSearchInput()}})})}})]);