class ProjectTaskService extends ClockifyService{static async wsSettings(){const t=await localStorage.getItem("workspaceSettings");return t?JSON.parse(t):null}static async getProjectFavorites(){const t=await this.wsSettings();return!t||t.projectFavorites}static async getUrlProjects(t=!1){return`${await this.apiEndpoint}/${t?"v1/":""}workspaces/${await this.workspaceId}/projects`}static async getOrCreateProjectAndTask(t,a){const{forceTasks:e}=await this.getForces();let{projectDB:s,taskDB:r,msg:i,found:c,created:o,onlyAdminsCanCreateProjects:n,projectArchived:l}=await this.getOrCreateProject(t),d=i||"";if(l&&(d+=t+" is archived."),n&&(d+="Only Admins can create projects."),s&&(c||o)){if(a&&a.name){const t=a.name.trim().replace(/\s+/g," "),{task:e,error:i}=await ProjectTaskService.getOrCreateTask(s,t);i&&(d+=i.message),r=e}if(e&&!r){const{projectDB:t,taskDB:a,msg:e,msgId:i}=await DefaultProject.getProjectTaskFromDB();e&&(d+=" "+e),t&&(s=t),r=a}}return{projectDB:s,taskDB:r,message:d}}static async getOrCreateProject(t){let a;const{projectPickerSpecialFilter:e}=await this.getForces();let s;t=t.trim().replace(/\s+/g," "),a=e?"@"+t:t;const{projects:r,error:i}=await this.getProjectWithFilter(a,0,50);if(i)return{projectDB:null,error:i};r&&r.length>0&&(s=r.find((a=>a.name===t)));let c=!1,o=!1;const n=await this.getCreateObjects();if(await this.getCanCreateProjects(),s){if(!s.archived)return{projectDB:s,found:!0};o=!0}else if(n){let a=await this.wsSettings();const e={name:t};null!=a?.defaultBillableProjects&&(e.billable=a.defaultBillableProjects);const{data:s,error:r,status:i}=await this.createProject(e);if(201===i)return{projectDB:s,created:!0};const{errorData:o}=r;o&&501===o.code&&await localStorage.setItem("createProjectError","true"),r&&403===r.status&&(c=!0)}const{projectDB:l,taskDB:d,msg:p,msgId:h}=await DefaultProject.getProjectTaskFromDB();return{projectDB:l,taskDB:d,msg:p,msgId:h,projectArchived:o,onlyAdminsCanCreateProjects:c}}static async getOrCreateTask(t,a){let e=null,s=(t.tasks||[]).find((t=>t.name===a));if(!s){let{data:r,error:i}=await this.getTaskOfProject({projectId:t.id,taskName:encodeURIComponent(a)});r=r?.filter((t=>t.name===a)),s=r&&r.length>0?r[0]:null,e=i}const r=await this.getCreateObjects(),i=await this.getCanCreateTasks();if(!s&&r&&i){const{data:r,error:i,status:c}=await this.createTask({projectId:t.id,name:a});s=r,i&&(i.status,e=i)}return{task:s,error:e}}static async getProjectWithFilter(t,a,e){const{projectPickerSpecialFilter:s}=JSON.parse(await localStorage.getItem("userSettings")),r=encodeURIComponent(t.trim()),i=`${await this.apiEndpoint}/workspaces/${await this.workspaceId}/project-picker/projects?page=${a}&${s?"search=@":"search="}${r}`,{data:c,error:o}=await this.apiCall(i);return{projects:c,error:o}}static async createProject(t){const a=await this.getUrlProjects(!0);return await this.apiCall(a,"POST",t)}static async createTask({projectId:t,name:a}){const e=`${await this.getUrlProjects(!0)}/${t}/tasks`,s={name:a,projectId:t};return await this.apiCall(e,"POST",s)}static async getLastUsedProjectFromTimeEntries(t){const a=await this.getUrlProjects();let e,s,r;if(t&&({data:e,error:s,status:r}=await this.getLastUsedProjectAndTaskFromTimeEntries()),e)return{data:e,error:s,status:r};{const t=`${a}/lastUsed?type=PROJECT`;({data:e,error:s,status:r}=await this.apiCall(t))}return{data:e,error:s,status:r}}static async getLastUsedProjectAndTaskFromTimeEntries(){let t=`${await this.getUrlProjects()}/lastUsed?type=PROJECT_AND_TASK`,{data:a,error:e,status:s}=await this.apiCall(t);return{data:a,error:e,status:s}}static getProjects(t,a,e){return this.getProjectsWithFilter("",t,a,e)}static async getProjectsByIds(t,a){const e=`${await this.getUrlProjects()}/ids`,s={ids:t},{data:r,error:i,status:c}=await this.apiCall(e,"POST",s);if(i)return{error:i};if(200===c&&r.length>0){const t=r[0];if(a){const{tasks:e,error:s,status:r}=await this.getAllTasks(a);s||(t.tasks=[e[0]])}return{projectDB:t,error:i,status:c}}return{projectDB:null,error:i,status:c}}static async getTask(t){const a=`${await this.getUrlProjects()}/taskIds`,e={ids:[t]},{data:s,error:r,status:i}=await this.apiCall(a,"POST",e);return 200===i&&s.length>0?s[0]:null}static async getTaskOfProject({projectId:t,taskName:a}){const e=`${await this.apiEndpoint}/v1/workspaces/${await this.workspaceId}/projects/${t}/tasks?name=${a}&strict-name-search=true`;return await this.apiCall(e)}static async getAllTasks(t){const a=`${await this.getUrlProjects()}/taskIds`,e={ids:t},{data:s,error:r,status:i}=await this.apiCall(a,"POST",e);return{tasks:s,error:r,status:i}}static async getProjectsWithFilter(t,a,e,s=!1,r=[]){const i=encodeURIComponent(t.trim()),c=await this.apiEndpoint,o=await this.workspaceId,n=`${c}/workspaces/${o}/project-picker/projects?search=${i}`,l=`${c}/workspaces/${o}/project-picker/projects?favorites=false&clientId=&excludedTasks=&search=${i}&userId=`;if(await this.getProjectFavorites()){const{data:t,error:i}=await this.addFavs(r,n,[],1,e,s);return i?{data:t,error:i}:t.length>=e?{data:t}:await this.addNonFavs(r,l,t,a,e,s)}return await this.addPage(r,l,[],a,e,s)}static async addFavs(t,a,e,s,r,i){let c=`${a}&page=${s}&pageSize=${r}&favorites=true`;const{data:o,error:n}=await this.apiCall(c);return n?{data:o,error:n}:(o.forEach((a=>{!t.includes(a.id)&&e.length<r&&(!i||a.taskCount>0)&&e.push(a)})),{data:e,error:n})}static async addNonFavs(t,a,e,s,r,i){let c=`${a}&pageSize=${r}&page=${s}`;const{data:o,error:n}=await this.apiCall(c);return n?{data:o,error:n}:(o.forEach((a=>{!a.favorite&&!t.includes(a.id)&&e.length<r&&(!i||a.taskCount>0)&&e.push(a)})),o.length<r||e.length>=r?{data:e,error:n}:await this.addNonFavs(t,a,e,s+1,r,i))}static async addPage(t,a,e,s,r,i){let c=`${a}&page=${s}`;const{data:o,error:n}=await this.apiCall(c);return n?{data:o,error:n}:(o.forEach((a=>{!t.includes(a.id)&&e.length<r&&(!i||a.taskCount>0)&&e.push(a)})),o.length<r||e.length>=r?{data:e,error:n}:await this.addPage(t,a,e,s+1,r,i))}static async getProjectTasksWithFilter(t,a,e){const s=encodeURIComponent(a.trim()),r=`${await this.apiEndpoint}/workspaces/${await this.workspaceId}/project-picker/projects/${t}/tasks?page=${e}&search=${s}`;return await this.apiCall(r)}static async makeProjectFavorite(t){const a=await this.apiEndpoint,e=await this.userId,s=`${a}/workspaces/${await this.workspaceId}/users/${e}/projects/favorites/${t}`;return await this.apiCall(s,"POST",{})}static async removeProjectAsFavorite(t){const a=await this.apiEndpoint,e=await this.userId,s=`${a}/workspaces/${await this.workspaceId}/users/${e}/projects/favorites/projects/${t}`;return await this.apiCall(s,"DELETE")}}