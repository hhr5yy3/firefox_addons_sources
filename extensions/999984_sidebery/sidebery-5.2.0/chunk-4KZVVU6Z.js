import{__export}from"./chunk-FF3JOXTG.js";var NavItemTypeNames={1:"bookmarks",2:"tabs",4:"history",100:"settings",101:"add_tp",103:"search",104:"hidden",105:"create_snapshot",106:"remute_audio_tabs",107:"collapse",200:"dynamic",201:"static"};var ButtonTypes={settings:100,search:103,add_tp:101,hidden:104,collapse:107,create_snapshot:105,remute_audio_tabs:106};var TabStatus=(TabStatus2=>(TabStatus2[TabStatus2.Complete=1]="Complete",TabStatus2[TabStatus2.Loading=2]="Loading",TabStatus2[TabStatus2.Pending=3]="Pending",TabStatus2))(TabStatus||{});var SubPanelType=(SubPanelType2=>(SubPanelType2[SubPanelType2.Null=0]="Null",SubPanelType2[SubPanelType2.RecentlyClosedTabs=1]="RecentlyClosedTabs",SubPanelType2[SubPanelType2.Bookmarks=2]="Bookmarks",SubPanelType2[SubPanelType2.History=3]="History",SubPanelType2))(SubPanelType||{});var DropType=(DropType2=>(DropType2[DropType2.Nowhere=0]="Nowhere",DropType2[DropType2.Tabs=1]="Tabs",DropType2[DropType2.Bookmarks=2]="Bookmarks",DropType2[DropType2.NavItem=3]="NavItem",DropType2[DropType2.TabsPanel=31]="TabsPanel",DropType2[DropType2.BookmarksPanel=32]="BookmarksPanel",DropType2[DropType2.BookmarksSubPanelBtn=41]="BookmarksSubPanelBtn",DropType2))(DropType||{});var MediaState=(MediaState2=>(MediaState2[MediaState2.Muted=-1]="Muted",MediaState2[MediaState2.Silent=0]="Silent",MediaState2[MediaState2.Audible=1]="Audible",MediaState2[MediaState2.Paused=2]="Paused",MediaState2))(MediaState||{});var LANG_REG=browser.i18n.getUILanguage().replace("-","_"),LANG=LANG_REG.slice(0,2),dict={};if(window.translations)for(let key of Object.keys(window.translations)){let prop=window.translations[key];dict[key]=prop[LANG_REG]??prop[LANG]??prop.en}function isString(r){return r.constructor===String}function translate(id,plurNum){if(!id)return"";let record=dict[id];return record===void 0?id:isString(record)?record:record(plurNum)}var DEFAULT_SETTINGS={nativeScrollbars:!0,nativeScrollbarsThin:!0,nativeScrollbarsLeft:!1,selWinScreenshots:!1,updateSidebarTitle:!0,markWindow:!1,markWindowPreface:"[Sidebery] ",ctxMenuNative:!1,ctxMenuRenderInact:!0,ctxMenuRenderIcons:!0,ctxMenuIgnoreContainers:"",navBarLayout:"horizontal",navBarInline:!0,navBarSide:"left",hideAddBtn:!1,hideSettingsBtn:!1,navBtnCount:!0,hideEmptyPanels:!0,hideDiscardedTabPanels:!1,navActTabsPanelLeftClickAction:"none",navActBookmarksPanelLeftClickAction:"none",navTabsPanelMidClickAction:"discard",navBookmarksPanelMidClickAction:"none",navSwitchPanelsWheel:!0,subPanelRecentlyClosedBar:!0,subPanelBookmarks:!0,subPanelHistory:!0,groupLayout:"grid",containersSortByName:!1,skipEmptyPanels:!1,dndTabAct:!0,dndTabActDelay:750,dndTabActMod:"none",dndExp:"pointer",dndExpDelay:750,dndExpMod:"none",dndOutside:"win",dndActTabFromLink:!0,dndActSearchTab:!0,dndMoveTabs:!1,dndMoveBookmarks:!1,searchBarMode:"dynamic",searchPanelSwitch:"same_type",searchBookmarksShortcut:"",searchHistoryShortcut:"",warnOnMultiTabClose:"collapsed",activateLastTabOnPanelSwitching:!0,activateLastTabOnPanelSwitchingLoadedOnly:!0,switchPanelAfterSwitchingTab:"always",tabRmBtn:"hover",activateAfterClosing:"next",activateAfterClosingStayInPanel:!1,activateAfterClosingGlobal:!1,activateAfterClosingNoFolded:!0,activateAfterClosingNoDiscarded:!0,askNewBookmarkPlace:!0,tabsRmUndoNote:!0,tabsUnreadMark:!1,tabsUpdateMark:"all",tabsUpdateMarkFirst:!0,tabsReloadLimit:5,tabsReloadLimitNotif:!0,showNewTabBtns:!0,newTabBarPosition:"after_tabs",tabsPanelSwitchActMove:!1,tabsPanelSwitchActMoveAuto:!0,tabsUrlInTooltip:"full",newTabCtxReopen:!1,tabWarmupOnHover:!0,tabSwitchDelay:0,moveNewTabPin:"start",moveNewTabParent:"last_child",moveNewTabParentActPanel:!1,moveNewTab:"end",moveNewTabActivePin:"start",pinnedTabsPosition:"panel",pinnedTabsList:!1,pinnedAutoGroup:!1,pinnedNoUnload:!1,pinnedForcedDiscard:!1,tabsTree:!0,groupOnOpen:!0,tabsTreeLimit:"none",autoFoldTabs:!1,autoFoldTabsExcept:"none",autoExpandTabs:!1,autoExpandTabsOnNew:!1,rmChildTabs:"folded",tabsLvlDots:!0,discardFolded:!1,discardFoldedDelay:0,discardFoldedDelayUnit:"sec",tabsTreeBookmarks:!0,treeRmOutdent:"branch",autoGroupOnClose:!1,autoGroupOnClose0Lvl:!1,autoGroupOnCloseMouseOnly:!1,ignoreFoldedParent:!1,showNewGroupConf:!0,sortGroupsFirst:!0,colorizeTabs:!1,colorizeTabsSrc:"domain",colorizeTabsBranches:!1,colorizeTabsBranchesSrc:"url",inheritCustomColor:!0,previewTabs:!1,previewTabsMode:"i",previewTabsPageModeFallback:"w",previewTabsInlineHeight:70,previewTabsPopupWidth:280,previewTabsSide:"right",previewTabsDelay:500,previewTabsFollowMouse:!0,previewTabsWinOffsetY:36,previewTabsWinOffsetX:6,previewTabsInPageOffsetY:0,previewTabsInPageOffsetX:0,previewTabsCropRight:0,hideInact:!1,hideFoldedTabs:!1,hideFoldedParent:"none",nativeHighlight:!1,warnOnMultiBookmarkDelete:"collapsed",autoCloseBookmarks:!1,autoRemoveOther:!1,highlightOpenBookmarks:!1,activateOpenBookmarkTab:!1,showBookmarkLen:!0,bookmarksRmUndoNote:!0,loadBookmarksOnDemand:!0,pinOpenedBookmarksFolder:!0,oldBookmarksAfterSave:"ask",loadHistoryOnDemand:!0,fontSize:"m",animations:!0,animationSpeed:"norm",theme:"proton",density:"default",colorScheme:"ff",sidebarCSS:!1,groupCSS:!1,snapNotify:!0,snapExcludePrivate:!1,snapInterval:0,snapIntervalUnit:"min",snapLimit:0,snapLimitUnit:"snap",snapAutoExport:!1,snapAutoExportType:"json",snapAutoExportPath:"Sidebery/snapshot-%Y.%M.%D-%h.%m.%s",snapMdFullTree:!1,hScrollAction:"none",onePanelSwitchPerScroll:!1,wheelAccumulationX:!0,wheelAccumulationY:!0,navSwitchPanelsDelay:128,scrollThroughTabs:"none",scrollThroughVisibleTabs:!0,scrollThroughTabsSkipDiscarded:!0,scrollThroughTabsExceptOverflow:!0,scrollThroughTabsCyclic:!1,scrollThroughTabsScrollArea:0,autoMenuMultiSel:!0,multipleMiddleClose:!1,longClickDelay:500,wheelThreshold:!1,wheelThresholdX:10,wheelThresholdY:60,tabDoubleClick:"none",tabsSecondClickActPrev:!0,tabsSecondClickActPrevPanelOnly:!1,shiftSelAct:!0,activateOnMouseUp:!1,tabLongLeftClick:"none",tabLongRightClick:"none",tabMiddleClick:"close",tabMiddleClickCtrl:"discard",tabMiddleClickShift:"duplicate",tabCloseMiddleClick:"close",tabsPanelLeftClickAction:"none",tabsPanelDoubleClickAction:"tab",tabsPanelRightClickAction:"menu",tabsPanelMiddleClickAction:"tab",newTabMiddleClickAction:"new_child",bookmarksLeftClickAction:"open_in_act",bookmarksLeftClickActivate:!1,bookmarksLeftClickPos:"default",bookmarksMidClickAction:"open_in_new",bookmarksMidClickActivate:!1,bookmarksMidClickRemove:!1,bookmarksMidClickPos:"default",historyLeftClickAction:"open_in_act",historyLeftClickActivate:!1,historyLeftClickPos:"default",historyMidClickAction:"open_in_new",historyMidClickActivate:!1,historyMidClickPos:"default",syncName:"",syncSaveSettings:!1,syncSaveCtxMenu:!1,syncSaveStyles:!1,syncSaveKeybindings:!1,selectActiveTabFirst:!0},SETTINGS_OPTIONS={navActTabsPanelLeftClickAction:["scroll","new_tab","none"],navActBookmarksPanelLeftClickAction:["scroll","none"],navTabsPanelMidClickAction:["rm_act_tab","rm_all","rm_rmp","discard","hide","bookmark","bkm_rmp","convert","conv_hide","none"],navBookmarksPanelMidClickAction:["convert","none"],tabsUrlInTooltip:["full","stripped","none"],groupLayout:["grid","list"],hScrollAction:["switch_panels","switch_act_tabs","none"],scrollThroughTabs:["panel","global","psp","psg","none"],discardFoldedDelayUnit:["sec","min"],tabDoubleClick:["reload","duplicate","dup_child","pin","mute","clear_cookies","exp","new_after","new_child","close","edit_title","none"],tabLongLeftClick:["reload","duplicate","dup_child","pin","mute","clear_cookies","new_after","new_child","edit_title","none"],tabLongRightClick:["reload","duplicate","dup_child","pin","mute","clear_cookies","new_after","new_child","edit_title","none"],tabMiddleClick:["close","discard","duplicate","dup_child","none"],tabMiddleClickModifier:["discard","duplicate","dup_child","edit_title","none"],tabCloseMiddleClick:["close","discard"],tabsPanelLeftClickAction:["prev","expand","parent","tab","none"],tabsPanelDoubleClickAction:["collapse","tab","undo","none"],tabsPanelRightClickAction:["next","expand","parent","menu","none"],tabsPanelMiddleClickAction:["rm_act_tab","tab","undo","none"],newTabAction:["new_child","reopen"],bookmarksLeftClickAction:["open_in_act","open_in_new"],bookmarksNewTabPos:["default","after"],bookmarksMidClickAction:["open_in_new","edit","delete"],historyLeftClickAction:["open_in_act","open_in_new"],historyNewTabPos:["default","after"],historyMidClickAction:["open_in_new","forget_visit"],tabRmBtn:["always","hover","none"],activateAfterClosing:["prev_act","next","prev","none"],tabsUpdateMark:["all","pin","norm","none"],pinnedTabsPosition:["panel","top","left","right"],tabsTreeLimit:[1,2,3,4,5,"none"],previewTabsMode:["i","p","w"],previewTabsPageModeFallback:["i","w","n"],previewTabsSide:["right","left"],hideFoldedParent:["any","group","none"],rmChildTabs:["all","folded","none"],fontSize:["xxs","xs","s","m","l","xl","xxl"],theme:["proton","plain"],density:["compact","default","loose"],colorScheme:["dark","light","sys","ff"],snapIntervalUnit:["min","hr","day"],snapAutoExportType:["json","md","both"],snapLimitUnit:["snap","kb","day"],moveNewTabPin:["start","end"],moveNewTabParent:["before","sibling","first_child","last_child","start","end","default","none"],moveNewTab:["start","end","before","after","first_child","last_child","none"],moveNewTabActivePin:["start","end"],warnOnMultiTabClose:["any","collapsed","none"],warnOnMultiBookmarkDelete:["any","collapsed","none"],navBarLayout:["horizontal","vertical","hidden"],navBarSide:["left","right"],navBarHorLayout:["inline","wrap"],navBarVertLayout:["left","right"],autoFoldTabsExcept:[1,2,3,4,5,"none"],dndTabActMod:["alt","shift","ctrl","none"],dndExp:["pointer","hover","none"],dndExpMod:["alt","shift","ctrl","none"],dndOutside:["win","data"],animationSpeed:["fast","norm","slow"],treeRmOutdent:["branch","first_child"],colorizeTabsSrc:["domain","container"],colorizeTabsBranchesSrc:["url","domain"],searchBarMode:["static","dynamic","none"],searchPanelSwitch:["any","same_type","none"],newTabBarPosition:["after_tabs","bottom"],oldBookmarksAfterSave:["ask","del","keep"],switchPanelAfterSwitchingTab:["always","mouseleave","no"]};var DEFAULT_CONTAINER={id:"",cookieStoreId:"",name:"",icon:"fingerprint",color:"blue",colorCode:"#37adff",proxified:!1,proxy:null,reopenRulesActive:!1,reopenRules:[],userAgentActive:!1,userAgent:""},DEFAULT_CONTAINER_ID="firefox-default",PRIVATE_CONTAINER_ID="firefox-private",CONTAINER_ID=browser.extension.inIncognitoContext?PRIVATE_CONTAINER_ID:DEFAULT_CONTAINER_ID;var TABS_MENU=[{opts:["undoRmTab","mute","reload","bookmark"]},"separator-1",{name:"%menu.tab.move_to_sub_menu_name",opts:["moveToNewWin","moveToWin","separator-5","moveToPanel","moveToNewPanel"]},{name:"%menu.tab.reopen_in_sub_menu_name",opts:["reopenInNewWin","reopenInWin","separator-6","reopenInCtr","reopenInNewCtr"]},{name:"%menu.tab.colorize_",opts:["colorizeTab"]},{name:"%menu.tab.sort_sub_menu_name",opts:["sortTabsByTitleAscending","sortTabsByTitleDescending","sortTabsByUrlAscending","sortTabsByUrlDescending","sortTabsByAccessTimeAscending","sortTabsByAccessTimeDescending","separator-45654","sortTabsTreeByTitleAscending","sortTabsTreeByTitleDescending","sortTabsTreeByUrlAscending","sortTabsTreeByUrlDescending","sortTabsTreeByAccessTimeAscending","sortTabsTreeByAccessTimeDescending"]},"separator-2","pin","duplicate","discard","copyTabsUrls","copyTabsTitles","editTabTitle","separator-3","group","flatten","separator-4","urlConf","clearCookies","close"],TABS_PANEL_MENU=[{opts:["undoRmTab","muteAllAudibleTabs","reloadTabs","discardTabs"]},"separator-1224",{name:"%menu.tabs_panel.sort_all_sub_menu_name",opts:["sortAllTabsByTitleAscending","sortAllTabsByTitleDescending","sortAllTabsByUrlAscending","sortAllTabsByUrlDescending","sortAllTabsByAccessTimeAscending","sortAllTabsByAccessTimeDescending"]},"separator-7","selectAllTabs","collapseInactiveBranches","closeTabsDuplicates","closeTabs","separator-8","bookmarkTabsPanel","restoreFromBookmarks","convertToBookmarksPanel","separator-9","openPanelConfig","hidePanel","removePanel"],BOOKMARKS_MENU=[{name:"%menu.bookmark.open_in_sub_menu_name",opts:["openInNewWin","openInNewPrivWin","separator-9","openInPanel","openInNewPanel","separator-10","openInCtr"]},{name:"%menu.bookmark.sort_sub_menu_name",opts:["sortByNameAscending","sortByNameDescending","sortByLinkAscending","sortByLinkDescending","sortByTimeAscending","sortByTimeDescending"]},"separator-5","createBookmark","createFolder","createSeparator","separator-8","openAsBookmarksPanel","openAsTabsPanel","separator-7","copyBookmarksUrls","copyBookmarksTitles","moveBookmarksTo","edit","delete"],BOOKMARKS_PANEL_MENU=["collapseAllFolders","switchViewMode","convertToTabsPanel","separator-9","unloadPanelType","openPanelConfig","hidePanel","removePanel"],HISTORY_MENU=["open","separator-1","copyHistoryUrls","copyHistoryTitles","separator-2","deleteVisits","deleteSites"],NEW_TAB_MENU=["newTabNoContainer","separator-10","newTabContainers","newTabNewContainer","separator-12","manageShortcuts","manageContainers"],OTHER_PANELS_MENU=["openPanelConfig","unloadPanelType","hidePanel","removePanel"];var BOOKMARKS_PANEL_CONFIG={type:1,id:"",name:"",iconSVG:"icon_bookmarks",iconIMGSrc:"",iconIMG:"",color:"toolbar",lockedPanel:!1,tempMode:!1,skipOnSwitching:!1,rootId:"root________",viewMode:"tree",autoConvert:!1,srcPanelConfig:null},BOOKMARKS_PANEL_STATE={...BOOKMARKS_PANEL_CONFIG,class:1,index:-1,topOffset:0,leftOffset:0,rightOffset:0,bottomOffset:0,scrollEl:null,scrollComponent:null,bounds:[],hidden:!1,ready:!1,reactive:{name:"",color:"toolbar",iconSVG:"icon_bookmarks",iconIMG:"",hidden:!1,tooltip:"",sel:!1,len:0,filteredLen:void 0,ready:!1,bookmarks:[],filteredBookmarks:void 0,viewMode:"tree",rootOffset:0}},TABS_PANEL_CONFIG={type:2,id:"",name:"",color:"toolbar",iconSVG:"icon_tabs",iconIMGSrc:"",iconIMG:"",lockedPanel:!1,skipOnSwitching:!1,noEmpty:!1,newTabCtx:"none",dropTabCtx:"none",moveRules:[],moveExcludedTo:-1,bookmarksFolderId:-1,newTabBtns:[],srcPanelConfig:null},TABS_PANEL_STATE={...TABS_PANEL_CONFIG,tabs:[],pinnedTabs:[],filteredTabs:void 0,updatedTabs:[],selNewTab:!1,startTabIndex:-1,endTabIndex:-1,nextTabIndex:-1,scrollRetainer:0,allDiscarded:!1,class:1,index:-1,topOffset:0,leftOffset:0,rightOffset:0,bottomOffset:0,scrollEl:null,scrollComponent:null,bounds:[],hidden:!1,ready:!0,reactive:{name:"",color:"toolbar",iconSVG:"icon_tabs",iconIMG:void 0,hidden:!1,tooltip:"",sel:!1,len:0,filteredLen:void 0,ready:!0,visibleTabIds:[],pinnedTabIds:[],updated:!1,selNewTab:!1,scrollRetainerHeight:0,empty:!0,allDiscarded:!1,newTabCtx:"none",newTabBtns:[],mediaState:0}},HISTORY_PANEL_CONFIG={type:4,id:"history",name:translate("panel.history.title"),color:"toolbar",iconSVG:"icon_clock",tempMode:!1,lockedPanel:!1,skipOnSwitching:!1,viewMode:"history"},HISTORY_PANEL_STATE={...HISTORY_PANEL_CONFIG,class:1,index:-1,topOffset:0,leftOffset:0,rightOffset:0,bottomOffset:0,scrollEl:null,scrollComponent:null,bounds:[],hidden:!1,ready:!1,reactive:{name:"",color:"toolbar",iconSVG:"icon_tabs",iconIMG:void 0,hidden:!1,tooltip:"",sel:!1,len:0,filteredLen:void 0,ready:!1}};var PRE_SCROLL=64,ADDON_HOST=browser.runtime.getURL(""),SIDEBAR_URL=browser.runtime.getURL("/sidebar/sidebar.html"),GROUP_URL=browser.runtime.getURL("/sidebery/group.html"),GROUP_URL_LEN=GROUP_URL.length,URL_URL=browser.runtime.getURL("/sidebery/url.html"),URL_URL_LEN=URL_URL.length,SETUP_URL=browser.runtime.getURL("/page.setup/setup.html"),SEARCH_URL=browser.runtime.getURL("/popup.search/search.html"),V4_GROUP_URL_LEN=69,V4_URL_URL_LEN=65,RGB_COLORS={blue:"#37adff",turquoise:"#00c79a",green:"#51cd00",yellow:"#ffcb00",orange:"#ff9f00",red:"#ff613d",pink:"#ff4bda",purple:"#af51f5",toolbar:"#686868"},COLOR_NAMES=["blue","turquoise","green","yellow","orange","red","pink","purple","toolbar"],IMG_RE=/(\.png|\.jpe?g|\.gif|\.webp|\.svg)([?#].*)?$/i,VID_RE=/(\.mp4|\.webm)([?#].*)?$/i,MUS_RE=/(\.mp3|\.flac)([?#].*)?$/i,FILE_RE=/(^file:.*|\.pdf)([?#].*)?$/,GROUP_RE=/\/sidebery\/group\.html/,URL_PAGE_RE=/\/sidebery\/url\.html/;var FOLDER_NAME_DATA_RE=/^(.*) \[(.*)\]$/,CONTAINER_IN_BOOKMARK_RE=/ \[(".+","\w+","\w+"(,"\w+")?)\]/,COLOR_IN_BOOKMARK_RE=/ \[(c\d)\]/,GROUP_INITIAL_TITLE="...",INITIAL_TITLE_RE=/^[0-9A-Za-z-]{1,63}(\.[0-9A-Za-z-]{1,63})+\//,SITE_URL_RE=/^([0-9A-Za-z-]{1,63}:\/\/[0-9A-Za-z-]{1,63}(\.[0-9A-Za-z-]{1,63})+)(\/|$)/,BTN_ICONS={tabs_panel:"icon_tabs",bookmarks_panel:"icon_bookmarks",settings:"icon_settings",history:"icon_clock",sp:"icon_ellipsis",sd:"icon_ellipsis",hdn:"icon_hide",add_tp:"icon_add_tabs_panel",search:"icon_search",collapse:"icon_collapse_all",create_snapshot:"icon_snapshot",remute_audio_tabs:"icon_mute"};var DOMAIN_RE=/^[0-9A-Za-z-]{1,63}:\/\/(www\.)?(.*?)(\/|$)/;var NOID=-1,SAMEID=-5,NEWID=-10,ASKID=-11,MOVEID=-12;var CONTAINER_ICON_OPTS=[{value:"fingerprint",icon:"#fingerprint"},{value:"briefcase",icon:"#briefcase"},{value:"dollar",icon:"#dollar"},{value:"cart",icon:"#cart"},{value:"circle",icon:"#circle"},{value:"gift",icon:"#gift"},{value:"vacation",icon:"#vacation"},{value:"food",icon:"#food"},{value:"fruit",icon:"#fruit"},{value:"pet",icon:"#pet"},{value:"tree",icon:"#tree"},{value:"chill",icon:"#chill"},{value:"fence",icon:"#fence"}],PANEL_ICON_OPTS=[{value:"icon_books",icon:"#icon_books"},{value:"icon_code",icon:"#icon_code"},{value:"icon_circle",icon:"#icon_circle"},{value:"icon_play",icon:"#icon_play"},{value:"icon_mail",icon:"#icon_mail"},{value:"icon_man",icon:"#icon_man"},{value:"icon_archive",icon:"#icon_archive"},{value:"icon_clipboard",icon:"#icon_clipboard"},{value:"icon_book",icon:"#icon_book"},{value:"icon_coffee",icon:"#icon_coffee"},{value:"icon_search",icon:"#icon_search"},{value:"icon_lock",icon:"#icon_lock"},{value:"icon_edu",icon:"#icon_edu"},{value:"icon_flask",icon:"#icon_flask"},{value:"icon_gamepad",icon:"#icon_gamepad"},{value:"fingerprint",icon:"#fingerprint"},{value:"briefcase",icon:"#briefcase"},{value:"dollar",icon:"#dollar"},{value:"cart",icon:"#cart"},{value:"circle",icon:"#circle"},{value:"gift",icon:"#gift"},{value:"vacation",icon:"#vacation"},{value:"food",icon:"#food"},{value:"fruit",icon:"#fruit"},{value:"pet",icon:"#pet"},{value:"tree",icon:"#tree"},{value:"chill",icon:"#chill"},{value:"fence",icon:"#fence"}],COLOR_OPTS=[{value:"toolbar",color:"toolbar"},{value:"blue",color:"blue"},{value:"turquoise",color:"turquoise"},{value:"green",color:"green"},{value:"yellow",color:"yellow"},{value:"orange",color:"orange"},{value:"red",color:"red"},{value:"pink",color:"pink"},{value:"purple",color:"purple"}],TAB_BOOKMARK_COLOR={blue:"c1",turquoise:"c2",green:"c3",yellow:"c4",orange:"c5",red:"c6",pink:"c7",purple:"c8"},BOOKMARK_TAB_COLOR={c1:"blue",c2:"turquoise",c3:"green",c4:"yellow",c5:"orange",c6:"red",c7:"pink",c8:"purple"},PROXY_OPTS=["http","https","socks4","socks","direct"],BKM_ROOT_ID="root________",BKM_OTHER_ID="unfiled_____",BKM_MENU_ID="menu________",BKM_MOBILE_ID="mobile______",BKM_TLBR_ID="toolbar_____",PIN_MARK="📌",MIN_SEARCH_QUERY_LEN=2;var ALPH=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","0","1","2","3","4","5","6","7","8","9","-","_"],UNDERSCORE_RE=/_/g,CSS_NUM_RE=/([\d.]+)(\w*)/;function uid(){let tp=Date.now(),rp1=Math.random()*2147483648|0,rp2=Math.random()*2147483648|0,chars=[];for(let i=0;i<5;i++)chars.push(ALPH[rp1&63]),rp1=rp1>>6;for(let i=5;i<7;i++)chars.push(ALPH[rp2&63]),rp2=rp2>>6;for(let i=7;i<12;i++)chars.push(ALPH[tp&63]),tp=tp>>6;return chars.join("")}function asap(cb,delay){let ctx={busy:!1,func:a=>{ctx.busy||(ctx.busy=!0,!delay&&window.requestAnimationFrame?window.requestAnimationFrame(()=>{cb(a),ctx.busy=!1}):setTimeout(()=>{cb(a),ctx.busy=!1},delay||66))}};return ctx}function debounce(cb){let ctx={timeout:-1,cb:cb.bind(self)};return(delay,...a)=>{ctx.timeout&&clearTimeout(ctx.timeout),ctx.timeout=setTimeout(()=>{ctx.timeout=null,ctx.cb(...a)},delay)}}function wait(timeout,delay,cb){return clearTimeout(timeout),setTimeout(()=>cb(),delay)}async function sleep(ms=1e3){return new Promise(wakeup=>{setTimeout(wakeup,ms)})}function bytesToStr(bytes){if(bytes<1e3)return`${bytes} b`;let kb=bytes/1024;if(kb<10)return`${Math.round(kb*100)/100} kb`;if(kb<100)return`${Math.round(kb*10)/10} kb`;if(kb<1e3)return`${Math.round(kb)} kb`;let mb=bytes/1048576;if(mb<10)return`${Math.round(mb*100)/100} mb`;if(mb<100)return`${Math.round(mb*10)/10} mb`;if(mb<1e3)return`${Math.round(mb)} mb`;let gb=bytes/1073741824;return gb<10?`${Math.round(gb*100)/100} gb`:gb<100?`${Math.round(gb*10)/10} gb`:`${Math.round(gb)} gb`}function strSize(str){let bytes=new Blob([str]).size;return bytesToStr(bytes)}function uDate(ms,delimiter,dayStartTime){if(delimiter||(delimiter="."),dayStartTime){if(ms>dayStartTime)return translate("time.today");if(ms>dayStartTime-864e5)return translate("time.yesterday")}let dt=new Date(ms),dtday=`${dt.getDate()}`.padStart(2,"0"),dtmth=`${dt.getMonth()+1}`.padStart(2,"0");return`${dt.getFullYear()}${delimiter}${dtmth}${delimiter}${dtday}`}function uTime(ms,delimiter=":",sec=!0){let dt=new Date(ms),time=`${dt.getHours()}`.padStart(2,"0");return time+=delimiter+`${dt.getMinutes()}`.padStart(2,"0"),sec&&(time+=delimiter+`${dt.getSeconds()}`.padStart(2,"0")),time}var DATE_TIME_TEMPLATE_RE=/%%|%Y|%M|%D|%h|%m|%s/g;function dateTimeTemplate(str,msOrDate){let dt;return typeof msOrDate=="number"?dt=new Date(msOrDate):dt=msOrDate,str=str.replace(DATE_TIME_TEMPLATE_RE,match=>match==="%%"?"%":match==="%Y"?dt.getFullYear().toString():match==="%M"?`${dt.getMonth()+1}`.padStart(2,"0"):match==="%D"?`${dt.getDate()}`.padStart(2,"0"):match==="%h"?`${dt.getHours()}`.padStart(2,"0"):match==="%m"?`${dt.getMinutes()}`.padStart(2,"0"):match==="%s"?`${dt.getSeconds()}`.padStart(2,"0"):""),str}function getDomainOf(url){return url&&(DOMAIN_RE.exec(url)?.[2]??url)}function colorFromString(str,minLightness=50){let h=0,s=0,l=0;for(let pcc,cc,i=1;i<str.length;i+=2)cc=str.charCodeAt(i),pcc=str.charCodeAt(i-1),h+=pcc+cc,s+=pcc,l+=cc;return minLightness<20?minLightness=20:minLightness>80&&(minLightness=80),`hsl(${h%181*2}deg, ${s%6*5+60}%, ${l%3*10+minLightness}%)`}var RGBA_RE=/rgba?\((\d+%?)[,\s]\s*(\d+%?)[,\s]\s*(\d+%?)(,|\s\/\s)?\s*([\d.]+%?)?\)/,HEXA_RE=/^#([0-f])([0-f])([0-f])([0-f])?$|^#([0-f][0-f])([0-f][0-f])([0-f][0-f])([0-f][0-f])?$/,HSLA_RE=/hsla?\((\d+%?)[,\s]\s*(\d+%?)[,\s]\s*(\d+%?)[,\s]?\s*([\d.]+%?)?\)/;function toRGBA(color){if(!color)return;if(Array.isArray(color))return color[3]===void 0&&(color[3]=1),color;let rgba=RGBA_RE.exec(color);if(rgba){let r=rgba[1],rn=parseInt(r);if(isNaN(rn))return;r.endsWith("%")&&(rn=Math.round(rn/100*255)),rn>255&&(rn=255);let g=rgba[2],gn=parseInt(g);if(isNaN(gn))return;g.endsWith("%")&&(gn=Math.round(rn/100*255)),gn>255&&(gn=255);let b=rgba[3],bn=parseInt(b);if(isNaN(bn))return;b.endsWith("%")&&(bn=Math.round(rn/100*255)),bn>255&&(bn=255);let a=rgba[5],an=1;return a!==void 0&&(an=parseFloat(a),a.endsWith("%")&&(an=an/100),isNaN(an)&&(an=1)),[rn,gn,bn,an]}let hexa=HEXA_RE.exec(color);if(hexa){let r=hexa[1]?.repeat(2)||hexa[5],rn=parseInt(r,16);if(isNaN(rn))return;let g=hexa[2]?.repeat(2)||hexa[6],gn=parseInt(g,16);if(isNaN(gn))return;let b=hexa[3]?.repeat(2)||hexa[7],bn=parseInt(b,16);if(isNaN(bn))return;let a=hexa[4]?.repeat(2)??hexa[8],an=1;return a!==void 0&&(an=parseInt(a,16)/255,isNaN(an)&&(an=1)),[rn,gn,bn,an]}let hsla=HSLA_RE.exec(color);if(hsla){let h=hsla[1],hn=parseInt(h);if(isNaN(hn))return;let s=hsla[2],sn=parseInt(s);if(isNaN(sn))return;let l=hsla[3],ln=parseInt(l);if(isNaN(ln))return;let a=hsla[4],an=1;a!==void 0&&(an=parseFloat(a),a.endsWith("%")&&(an=an/100),isNaN(an)&&(an=1));let rgb=HSLtoRGB(hn,sn,ln);return rgb.push(an),rgb}if(color==="black")return[0,0,0,1];if(color==="white")return[255,255,255,1];if(color==="gray")return[128,128,128,1];if(color==="transparent")return[0,0,0,0]}function hueToChan(p,q,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?p+(q-p)*6*t:t<1/2?q:t<2/3?p+(q-p)*(2/3-t)*6:p}function HSLtoRGB(hue,sat,lit){let r,g,b;if(hue=hue/360,sat=sat/100,lit=lit/100,sat===0)r=g=b=lit;else{let q=lit<.5?lit*(1+sat):lit+sat-lit*sat,p=2*lit-q;r=hueToChan(p,q,hue+1/3),g=hueToChan(p,q,hue),b=hueToChan(p,q,hue-1/3)}return[Math.round(r*255),Math.round(g*255),Math.round(b*255)]}function toCSSVarName(key){return`--${key.replace(UNDERSCORE_RE,"-")}`}function parseCSSNum(cssValue,or=0){let parseResult=CSS_NUM_RE.exec(cssValue.trim());if(!parseResult)return[0,""];let num=parseResult[1],unit=parseResult[2];return num.includes(".")?(num[0]==="."&&(num="0"+num),num=parseFloat(num)):num=parseInt(num),isNaN(num)&&(num=or),[num,unit]}function commonSubStr(strings){if(!strings||!strings.length)return"";if(strings.length===1)return strings[0];let first=strings[0],others=strings.slice(1),start3=0,end=1,out="",common="";for(;end<=first.length;)common=first.slice(start3,end),others.every(s=>s.toLowerCase().includes(common.toLowerCase()))?(common.length>out.length&&(out=common),end++):end=++start3+1;return out}async function _getStringFromDragItem(item){return new Promise(res=>item.getAsString(s=>res(s)))}async function parseDragEvent(event,lastFocusedId){return new Promise(async res=>{if(!event.dataTransfer)return res(void 0);let result={},types=event.dataTransfer.types,urlType;types.includes("text/x-moz-url-data")?urlType="text/x-moz-url-data":types.includes("text/x-moz-url")?urlType="text/x-moz-url":types.includes("text/x-moz-text-internal")&&(urlType="text/x-moz-text-internal");let isNativeTab=!1;types.includes("text/x-moz-text-internal")&&(isNativeTab=!0);let textType;types.includes("text/x-moz-url-desc")?textType="text/x-moz-url-desc":types.includes("text/plain")&&(textType="text/plain");for(let item of event.dataTransfer.items){if(!result.url&&item.type===urlType){let value=await _getStringFromDragItem(item);if(value&&urlType==="text/x-moz-url"){let urlAndTitle=value.split(`
`);result.url=urlAndTitle[0],result.text=urlAndTitle[1]}else isNativeTab&&lastFocusedId!==void 0?result.matchedNativeTabs=await browser.tabs.query({highlighted:!0,windowId:lastFocusedId}):result.url=value}!result.text&&item.type===textType&&(result.text=await _getStringFromDragItem(item)),!result.file&&item.kind==="file"&&(result.file=item.getAsFile())}res(result)})}function isV4GroupUrl(url){return url.startsWith("m")&&url.startsWith("/group/group.html",52)}function isGroupUrl(url){return url.startsWith("m")&&url.startsWith("/sidebery/group.html",52)}function isV4UrlUrl(url){return url.startsWith("m")&&url.startsWith("/url/url.html",52)}function isUrlUrl(url){return url.startsWith("m")&&url.startsWith("/sidebery/url.html",52)}function createGroupUrl(name,conf){let urlBase=browser.runtime.getURL("sidebery/group.html");return name||(name=uid()),conf&&conf.pin!==void 0&&(urlBase+="?pin="+conf.pin),urlBase+`#${encodeURIComponent(name)}`}function cloneArray(arr){let out=[];for(let item of arr)Array.isArray(item)?out.push(cloneArray(item)):typeof item=="object"&&item!==null?out.push(cloneObject(item)):out.push(item);return out}function cloneObject(obj){let out={};for(let prop of Object.keys(obj))Array.isArray(obj[prop])?out[prop]=cloneArray(obj[prop]):typeof obj[prop]=="object"&&obj[prop]!==null?out[prop]=cloneObject(obj[prop]):out[prop]=obj[prop];return out}function normalizeUrl(url,title){if(!url)return url;if(url!=="about:newtab"&&url!=="about:blank"){if(url.startsWith("about:reader?url="))try{url=decodeURIComponent(url.slice(17))}catch{}return url.startsWith("chrome:")||url.startsWith("javascript:")||url.startsWith("data:")||url.startsWith("file:")||url.startsWith("jar:file:")||url.startsWith("about:")?title?URL_URL+"#"+encodeURIComponent(JSON.stringify([url,title])):URL_URL+"#"+url:url}}function denormalizeUrl(url){if(!url)return url;if(url.startsWith("about:blank#url"))return url.slice(15);if(url.startsWith("m")&&URL_PAGE_RE.test(url)){let data=url.slice(71);try{data=decodeURIComponent(data);let[url2,_]=JSON.parse(data);return url2}catch{return data}}else return url}function recreateNormalizedObject(obj,defaults){let result=cloneObject(defaults);for(let key of Object.keys(defaults))obj[key]!==void 0&&(result[key]=obj[key]);return result}function normalizeObject(obj,defaults){let clonedDefaults=cloneObject(defaults);for(let key of Object.keys(clonedDefaults))obj[key]===void 0&&(obj[key]=clonedDefaults[key])}function updateObject(obj,src,keysSrc){let keys=Array.isArray(keysSrc)?keysSrc:Object.keys(keysSrc);for(let key of keys)src[key]!==void 0&&(obj[key]=src[key])}async function loadBinAsBase64(url){return new Promise(async res=>{let deadline=setTimeout(()=>res(null),2e3),response;try{response=await fetch(url,{method:"GET",mode:"no-cors",credentials:"omit"}),clearTimeout(deadline)}catch{return res(null)}if(!response)return res(null);let blob=await response.blob(),reader=new FileReader;reader.onload=()=>res(reader.result),reader.readAsDataURL(blob)})}function createCanvas(width,height){let canvasBoxEl=document.createElement("div");canvasBoxEl.style.position="absolute",canvasBoxEl.style.overflow="hidden",canvasBoxEl.style.opacity="0",canvasBoxEl.style.top="0",canvasBoxEl.style.left="0",canvasBoxEl.style.width="1px",canvasBoxEl.style.height="1px",document.body.appendChild(canvasBoxEl);let canvasEl=document.createElement("canvas");return canvasEl.width=width,canvasEl.height=height,canvasBoxEl.appendChild(canvasEl),canvasEl}async function setImageSrc(img,src){return new Promise((res,rej)=>{img.onload=()=>res(),img.onerror=e=>rej(e),img.src=src})}function setSvgImageSize(base64img,w,h){if(!base64img.startsWith("data:image/svg+xml;base64,"))return;let base64=base64img.slice(26),svg;try{svg=decodeURIComponent(atob(base64))}catch{return}svg=svg.replace("<svg ",`<svg width="${w}" height="${h}" `);try{base64=btoa(svg)}catch{return}return"data:image/svg+xml;base64,"+base64}function strHash(str){let hash=0,len=str.length;for(let chc,i=0;i<len;i++)chc=str.charCodeAt(i),hash=(hash<<5)-hash+chc,hash|=0;return hash}function getDayStartMS(){let now=new Date;return now.setMilliseconds(0),now.setSeconds(0),now.setMinutes(0),now.setHours(0),now.getTime()}function rmFromArray(arr,val){let index=arr.indexOf(val);return index>-1&&arr.splice(index,1),index}function isRegExp(value){return!!value.test}async function retry(conf){return new Promise(async res=>{let increment=conf.increment??0,count=conf.count,interval=conf.interval;for(;count--;){let result=!1;if(await conf.action(()=>result=!0),!result||count<=0)break;await sleep(interval),interval+=increment}res()})}function findNear(list,index,cb){let len=list.length,result,i=index,v;for(;i-- >0;)if(v=list[i],v!==void 0&&cb(v)){result=v;break}if(!result){for(i=index;++i<len;)if(v=list[i],v!==void 0&&cb(v)){result=v;break}}return result}function normalizeColor(color){return color==="blue"?"blue":color==="turquoise"?"turquoise":color==="green"?"green":color==="yellow"?"yellow":color==="orange"?"orange":color==="red"?"red":color==="pink"?"pink":color==="purple"?"purple":"toolbar"}function isNavBtn(item){return item?item.class===2:!1}function isNavSpace(item){return item?item.class===3:!1}function isNavPanel(item){return item?item.class===1:!1}function isTabsPanel(panel){return panel?panel.type===2:!1}function isBookmarksPanel(panel){return panel?panel.type===1:!1}function isHistoryPanel(panel){return panel?panel.type===4:!1}function findLast(arr,pred){for(let i=arr.length,v;i--;)if(v=arr[i],pred(v,i))return v}function findLastIndex(arr,pred){for(let i=arr.length,v;i--;)if(v=arr[i],pred(v,i))return i;return-1}var _waitingQueue=!1,_asyncQueue=[];async function inQueue(fn,...args){if(_waitingQueue)return new Promise((ok,err3)=>{_asyncQueue.push({ok,err:err3,fn,args})});_waitingQueue=!0;let result=args?await fn(...args):await fn();return _asyncQueue.length?_processQueue():_waitingQueue=!1,result}async function _processQueue(){let nextTask=_asyncQueue.shift();for(;nextTask;){try{nextTask.args?nextTask.ok(await nextTask.fn(...nextTask.args)):nextTask.ok(await nextTask.fn())}catch(err3){nextTask.err(err3)}nextTask=_asyncQueue.shift()}_waitingQueue=!1}function getRandomFrom(arr){let index=Math.round(Math.random()*(arr.length-1));return arr[index]}function settledOr(result,fallback){return result?.status==="fulfilled"?result.value??fallback:fallback}var info_actions_exports={};__export(info_actions_exports,{getInstanceName:()=>getInstanceName,getMajVer:()=>getMajVer,getProfileId:()=>getProfileId,isFreshInstall:()=>isFreshInstall,isMajorUpgrade:()=>isMajorUpgrade,loadCurrentTabInfo:()=>loadCurrentTabInfo,loadPlatformInfo:()=>loadPlatformInfo,loadVersionInfo:()=>loadVersionInfo,saveVersion:()=>saveVersion,setInstanceType:()=>setInstanceType3,versionToInt:()=>versionToInt});var ipc_exports={};__export(ipc_exports,{bg:()=>bg,broadcast:()=>broadcast,connectTo:()=>connectTo,disconnectFrom:()=>disconnectFrom,getConnection:()=>getConnection,groupPage:()=>groupPage,isConnected:()=>isConnected,onConnected:()=>onConnected,onDisconnected:()=>onDisconnected,registerActions:()=>registerActions,request:()=>request2,send:()=>send,sendToBg:()=>sendToBg,sendToLastFocusedSidebar:()=>sendToLastFocusedSidebar,sendToPreview:()=>sendToPreview,sendToSearchPopup:()=>sendToSearchPopup,sendToSidebar:()=>sendToSidebar,sendToSidebars:()=>sendToSidebars,setInstanceType:()=>setInstanceType2,setTabId:()=>setTabId2,setWinId:()=>setWinId2,setupConnectionListener:()=>setupConnectionListener,setupGlobalMessageListener:()=>setupGlobalMessageListener,setupPage:()=>setupPage,sidebar:()=>sidebar,sidebars:()=>sidebars,state:()=>state2});var _type="unknown",_winId="",_tabId="";function setInstanceType(type){_type=getInstanceName(type)}function setWinId(id){id!==NOID&&(_winId=`:${id}`)}function setTabId(id){id!==NOID&&(_tabId=`:${id}`)}function info(msg,...args){console.log(`[${_type}${_winId}${_tabId}] ${msg}`,...args)}function warn(msg,...args){console.warn(`[${_type}${_winId}${_tabId}] ${msg}`,...args)}function err(msg,err3){msg=`[${_type}${_winId}${_tabId}] ${msg}
`,err3!==void 0?console.error(msg,err3):console.error(msg)}var windows_actions_exports={};__export(windows_actions_exports,{activateSelectedWindow:()=>activateSelectedWindow,closeWindowsPopup:()=>closeWindowsPopup,createWithTabs:()=>createWithTabs,isWindowTabsLocked:()=>isWindowTabsLocked,loadWindowInfo:()=>loadWindowInfo,loadWindows:()=>loadWindows,selectWindow:()=>selectWindow,showWindowsPopup:()=>showWindowsPopup,updWindowPreface:()=>updWindowPreface});var tabs_bg_actions_exports={};__export(tabs_bg_actions_exports,{cacheTabsData:()=>cacheTabsData2,getGroupPageInitData:()=>getGroupPageInitData,getSidebarTabs:()=>getSidebarTabs,getUrlPageInitData:()=>getUrlPageInitData,hideProxyBadge:()=>hideProxyBadge,initInternalPageScripts:()=>initInternalPageScripts,injectGroupPageScript:()=>injectGroupPageScript,injectUrlPageScript:()=>injectUrlPageScript,loadTabs:()=>loadTabs,openTabs:()=>openTabs,reinitTabs:()=>reinitTabs2,setupTabsListeners:()=>setupTabsListeners2,showProxyBadge:()=>showProxyBadge,tabsApiProxy:()=>tabsApiProxy,updateBgTabsTreeData:()=>updateBgTabsTreeData});var containers_actions_exports={};__export(containers_actions_exports,{create:()=>create,findUnique:()=>findUnique,getCUID:()=>getCUID,getContainerFor:()=>getContainerFor,load:()=>load4,parseCUID:()=>parseCUID,saveContainers:()=>saveContainers,sortContainers:()=>sortContainers,updateContainers:()=>updateContainers,updateReopeningRules:()=>updateReopeningRules,upgradeV4Containers:()=>upgradeV4Containers});var web_req_actions_exports={};__export(web_req_actions_exports,{checkIpInfo:()=>checkIpInfo,disableAutoReopening:()=>disableAutoReopening,enableAutoReopening:()=>enableAutoReopening,updateReqHandlers:()=>updateReqHandlers,updateReqHandlersDebounced:()=>updateReqHandlersDebounced});var BG_URL=browser.runtime.getURL("bg/background.html"),handledReqId,includeHostsRules=[],excludeHostsRules={},proxyAuthCredentials={},pendingProxyAuthRequests=new Set,incHistory={},ipCheckCtx,userAgents={},disableReopeningForContainer,disableAutoReopeningTimeout;function disableAutoReopening(containerId,delay){disableReopeningForContainer=containerId,clearTimeout(disableAutoReopeningTimeout),disableAutoReopeningTimeout=setTimeout(()=>{disableReopeningForContainer=void 0},delay)}function enableAutoReopening(excludeTabIds){disableReopeningForContainer=void 0,clearTimeout(disableAutoReopeningTimeout);for(let id of excludeTabIds){let tab=Tabs.byId[id];tab&&(tab.preventAutoReopening=!0)}}async function recreateTab(tab,info2,cookieStoreId){let index;try{index=await sidebar(tab.windowId,"handleReopening",tab.id,cookieStoreId)}catch{}index===void 0&&(index=tab.index),await browser.tabs.create({windowId:tab.windowId,url:info2.url,cookieStoreId,active:tab.active,index,pinned:tab.pinned}),await browser.tabs.remove(tab.id)}async function checkIpInfoWithIPIFY_ORG(cookieStoreId){if(!cookieStoreId||!WebReq.containersProxies[cookieStoreId])return null;ipCheckCtx=cookieStoreId;let info2,result={};try{info2=await fetch("https://api.ipify.org",{cache:"reload"}).then(res=>res.text())}catch{return null}return info2&&(result.ip=info2),result}async function checkIpInfoWithEXTREME_IP_LOOKUP_COM(cookieStoreId){if(!cookieStoreId||!WebReq.containersProxies[cookieStoreId])return null;ipCheckCtx=cookieStoreId;let info2,result={};try{info2=await fetch("https://extreme-ip-lookup.com/json",{cache:"reload"}).then(r=>r.json())}catch{return null}return!info2||info2.status!=="success"?null:(info2.query&&(result.ip=info2.query),info2.country&&(result.country=info2.country),result)}async function checkIpInfo(cookieStoreId){let result;return result=await checkIpInfoWithEXTREME_IP_LOOKUP_COM(cookieStoreId),result||(result=await checkIpInfoWithIPIFY_ORG(cookieStoreId)),result}function updateReqHandlers(){WebReq.containersProxies={},includeHostsRules=[],excludeHostsRules={},proxyAuthCredentials={},pendingProxyAuthRequests.clear(),userAgents={};for(let ctr of Object.values(Containers.reactive.byId)){if(ctr.proxified&&ctr.proxy&&(WebReq.containersProxies[ctr.id]={...ctr.proxy},ctr.proxy.type.startsWith("http")&&ctr.proxy.username&&ctr.proxy.password&&(proxyAuthCredentials[ctr.id]={username:ctr.proxy.username,password:ctr.proxy.password})),ctr.reopenRulesActive){let ctrExclude=excludeHostsRules[ctr.id];for(let rule of ctr.reopenRules){if(!rule.active)continue;let urlMatchStr=rule.url.trim();if(!urlMatchStr)continue;let urlMatchRe;if(urlMatchStr.startsWith("/")&&urlMatchStr.endsWith("/"))try{urlMatchRe=new RegExp(urlMatchStr.slice(1,-1))}catch{warn(`WebReq.updateReqHandlers: Cannot parse RegExp: ${urlMatchStr}`)}rule.type===1?includeHostsRules.push({ctx:ctr.id,value:urlMatchRe??urlMatchStr}):ctrExclude?ctrExclude.push(urlMatchRe??urlMatchStr):(ctrExclude=[urlMatchRe??urlMatchStr],excludeHostsRules[ctr.id]=ctrExclude)}}ctr.userAgentActive&&(userAgents[ctr.id]=ctr.userAgent)}let hasIncRules=includeHostsRules.length>0,hasExcRules=Object.keys(excludeHostsRules).length>0,hasProxy=Object.keys(WebReq.containersProxies).length>0,hasCustomUserAgents=Object.keys(userAgents).length>0,hasAuthProxy=hasProxy&&Object.values(proxyAuthCredentials).length>0;if(hasProxy)for(let tab of Object.values(Tabs.byId))tab&&(WebReq.containersProxies[tab.cookieStoreId]&&!tab.proxified&&(tab.proxified=!0,Tabs.showProxyBadge(tab.id)),!WebReq.containersProxies[tab.cookieStoreId]&&tab.proxified&&(tab.proxified=!1,Tabs.hideProxyBadge(tab.id)));else for(let tab of Object.values(Tabs.byId))tab&&(tab.proxified=!1,Tabs.hideProxyBadge(tab.id));hasIncRules||hasExcRules||hasProxy?turnOnReqHandler():turnOffReqHandler(),hasAuthProxy?turnOnAuthHandler():turnOffAuthHandler(),hasCustomUserAgents?turnOnBeforeSendHeadersHandler():turnOffBeforeSendHeadersHandler()}var updateReqHandlersTimeout;function updateReqHandlersDebounced(){clearTimeout(updateReqHandlersTimeout),updateReqHandlersTimeout=setTimeout(()=>updateReqHandlers(),500)}function proxyReqHandler(info2){if(!Tabs.byId)return;let tab=Tabs.byId[info2.tabId];if(!tab&&ipCheckCtx&&info2.type==="xmlhttprequest"&&info2.originUrl===BG_URL&&WebReq.containersProxies[ipCheckCtx]){let ctx=ipCheckCtx;return ipCheckCtx=void 0,WebReq.containersProxies[ctx]}if(!info2.incognito&&tab&&!tab.preventAutoReopening&&info2.type==="main_frame"&&handledReqId!==info2.requestId&&(!disableReopeningForContainer||disableReopeningForContainer!==info2.cookieStoreId)){handledReqId=info2.requestId;let includedUrl;for(let rule of includeHostsRules){let ok;if(isRegExp(rule.value)?ok=rule.value.test(info2.url):ok=info2.url.indexOf(rule.value)!==-1,includedUrl||(includedUrl=ok),ok&&info2.cookieStoreId!==rule.ctx){if(incHistory[info2.cookieStoreId]===info2.url){incHistory[info2.cookieStoreId]=null;break}return incHistory[rule.ctx]=info2.url,inQueue(recreateTab,tab,info2,rule.ctx)}}if(!includedUrl&&excludeHostsRules[info2.cookieStoreId])for(let rule of excludeHostsRules[info2.cookieStoreId]){let ok;if(isRegExp(rule)?ok=rule.test(info2.url):ok=info2.url.indexOf(rule)!==-1,ok)return incHistory["firefox-default"]=info2.url,inQueue(recreateTab,tab,info2)}}if(WebReq.containersProxies[info2.cookieStoreId])return WebReq.containersProxies[info2.cookieStoreId]}function proxyAuthReqHandler(info2){if(!info2.isProxy)return;let authCredentials=proxyAuthCredentials[info2.cookieStoreId];if(authCredentials)return pendingProxyAuthRequests.has(info2.requestId)?{cancel:!0}:(pendingProxyAuthRequests.add(info2.requestId),{authCredentials})}function proxyAuthCompletedHandler(info2){pendingProxyAuthRequests.has(info2.requestId)&&(cancelDebouncedProxyAuthErrorHandler(info2.cookieStoreId),pendingProxyAuthRequests.delete(info2.requestId))}function proxyAuthWithErrorHandler(info2){pendingProxyAuthRequests.has(info2.requestId)&&proxyAuthErrorHandlerDebounced(info2.cookieStoreId,info2.error,640)}var proxyAuthErrorHandlerTimeouts=new Map;function proxyAuthErrorHandlerDebounced(containerId,error,delay){let timeout=proxyAuthErrorHandlerTimeouts.get(containerId);clearTimeout(timeout),timeout=setTimeout(()=>{warn(`WebReq.proxyAuthWithErrorHandler: ${error}`),sendToLastFocusedSidebar("notifyAboutWrongProxyAuthData",containerId)},delay),proxyAuthErrorHandlerTimeouts.set(containerId,timeout)}function cancelDebouncedProxyAuthErrorHandler(containerId){clearTimeout(proxyAuthErrorHandlerTimeouts.get(containerId))}function turnOnReqHandler(){browser.proxy&&(browser.proxy.onRequest.hasListener(proxyReqHandler)||browser.proxy.onRequest.addListener(proxyReqHandler,{urls:["<all_urls>"]}))}function turnOffReqHandler(){browser.proxy&&browser.proxy.onRequest.hasListener(proxyReqHandler)&&browser.proxy.onRequest.removeListener(proxyReqHandler)}function turnOnAuthHandler(){if(!browser.proxy||!browser.webRequest)return;let filter={urls:["<all_urls>"]};browser.webRequest.onAuthRequired.hasListener(proxyAuthReqHandler)||browser.webRequest.onAuthRequired.addListener(proxyAuthReqHandler,filter,["blocking"]),browser.webRequest.onCompleted.hasListener(proxyAuthCompletedHandler)||browser.webRequest.onCompleted.addListener(proxyAuthCompletedHandler,filter),browser.webRequest.onErrorOccurred.hasListener(proxyAuthWithErrorHandler)||browser.webRequest.onErrorOccurred.addListener(proxyAuthWithErrorHandler,filter)}function turnOffAuthHandler(){!browser.proxy||!browser.webRequest||(browser.webRequest.onAuthRequired.hasListener(proxyAuthReqHandler)&&browser.webRequest.onAuthRequired.removeListener(proxyAuthReqHandler),browser.webRequest.onCompleted.hasListener(proxyAuthCompletedHandler)&&browser.webRequest.onCompleted.removeListener(proxyAuthCompletedHandler),browser.webRequest.onErrorOccurred.hasListener(proxyAuthWithErrorHandler)&&browser.webRequest.onErrorOccurred.removeListener(proxyAuthWithErrorHandler))}function beforeSendHeadersHandler(info2){if(userAgents[info2.cookieStoreId]){let h=info2.requestHeaders?.find(rh=>rh.name==="User-Agent");if(h)return h.value=userAgents[info2.cookieStoreId],{requestHeaders:info2.requestHeaders}}}function turnOnBeforeSendHeadersHandler(){if(!browser.webRequest)return;let eventTarget=browser.webRequest.onBeforeSendHeaders;if(!eventTarget.hasListener(beforeSendHeadersHandler)){let filter={urls:["<all_urls>"]};eventTarget.addListener(beforeSendHeadersHandler,filter,["blocking","requestHeaders"])}}function turnOffBeforeSendHeadersHandler(){browser.webRequest&&browser.webRequest.onBeforeSendHeaders.hasListener(beforeSendHeadersHandler)&&browser.webRequest.onBeforeSendHeaders.removeListener(beforeSendHeadersHandler)}var WebReq={containersProxies:{},...web_req_actions_exports};var menu_actions_exports={};__export(menu_actions_exports,{activateOption:()=>activateOption,blockCtxMenu:()=>blockCtxMenu,close:()=>close2,createSettingsMenu:()=>createSettingsMenu,getContainersRules:()=>getContainersRules,isBlocked:()=>isBlocked,loadCtxMenu:()=>loadCtxMenu,onClose:()=>onClose,onOpen:()=>onOpen,open:()=>open5,parseContainersRules:()=>parseContainersRules,registerComponent:()=>registerComponent,resetListeners:()=>resetListeners4,saveCtxMenu:()=>saveCtxMenu,saveCtxMenuToSync:()=>saveCtxMenuToSync,selectOption:()=>selectOption,setupListeners:()=>setupListeners6,shrinkLabel:()=>shrinkLabel,upgradeMenuConf:()=>upgradeMenuConf});var settings_actions_exports={};__export(settings_actions_exports,{getOpts:()=>getOpts,loadSettings:()=>loadSettings,resetSettings:()=>resetSettings,saveDebounced:()=>saveDebounced,saveSettings:()=>saveSettings,setupSettingsChangeListener:()=>setupSettingsChangeListener,updateSettingsBg:()=>updateSettingsBg,updateSettingsFg:()=>updateSettingsFg});var sidebar_actions_exports={};__export(sidebar_actions_exports,{activatePanel:()=>activatePanel,addPanel:()=>addPanel,addToVisibleTabs:()=>addToVisibleTabs,askHowRemoveTabsPanel:()=>askHowRemoveTabsPanel,bookmarkTabsPanel:()=>bookmarkTabsPanel,checkDiscardedTabsInPanel:()=>checkDiscardedTabsInPanel,checkDiscardedTabsInPanelDebounced:()=>checkDiscardedTabsInPanelDebounced,closeHiddenPanelsPopup:()=>closeHiddenPanelsPopup,closeSubPanel:()=>closeSubPanel,convertToBookmarksPanel:()=>convertToBookmarksPanel,convertToTabsPanel:()=>convertToTabsPanel,createBookmarksPanel:()=>createBookmarksPanel,createHistoryPanel:()=>createHistoryPanel,createPanelFromConfig:()=>createPanelFromConfig,createTabsPanel:()=>createTabsPanel,getActivePanelConfig:()=>getActivePanelConfig,getIndexForNewTabsPanel:()=>getIndexForNewTabsPanel,getPanelAutoName:()=>getPanelAutoName,getPanelTooltip:()=>getPanelTooltip,getRecentTabsPanelId:()=>getRecentTabsPanelId,goToActiveTabPanel:()=>goToActiveTabPanel,hidePanel:()=>hidePanel,initSidebar:()=>initSidebar,loadNav:()=>loadNav,loadPanels:()=>loadPanels,moveNavItem:()=>moveNavItem,openHiddenPanelsPopup:()=>openHiddenPanelsPopup,openSubPanel:()=>openSubPanel,recalcBookmarksPanels:()=>recalcBookmarksPanels,recalcElementSizes:()=>recalcElementSizes,recalcElementSizesDebounced:()=>recalcElementSizesDebounced,recalcPanels:()=>recalcPanels,recalcSidebarSize:()=>recalcSidebarSize,recalcTabsPanels:()=>recalcTabsPanels,recalcVisibleTabs:()=>recalcVisibleTabs,registerHorizontalNavBarEl:()=>registerHorizontalNavBarEl,registerRootEl:()=>registerRootEl,rememberActivePanelScrollPosition:()=>rememberActivePanelScrollPosition,removeFromVisibleTabs:()=>removeFromVisibleTabs,removePanel:()=>removePanel,resetListeners:()=>resetListeners3,restoreActivePanelScrollPosition:()=>restoreActivePanelScrollPosition,restoreFromBookmarks:()=>restoreFromBookmarks,saveActivePanel:()=>saveActivePanel,saveActivePanelDebounced:()=>saveActivePanelDebounced,saveHiddenPanels:()=>saveHiddenPanels,saveSidebar:()=>saveSidebar,scrollActivePanel:()=>scrollActivePanel,scrollPanelToEdge:()=>scrollPanelToEdge,selectPanel:()=>selectPanel,setPanelEls:()=>setPanelEls,setPanelScrollBox:()=>setPanelScrollBox,setPanelsBoxEl:()=>setPanelsBoxEl,setViewMode:()=>setViewMode,setupListeners:()=>setupListeners5,showPanel:()=>showPanel,switchPanel:()=>switchPanel,switchPanelBack:()=>switchPanelBack,switchPanelBackResetTimeout:()=>switchPanelBackResetTimeout,switchPanelOnMouseLeave:()=>switchPanelOnMouseLeave,switchToNeighbourPanel:()=>switchToNeighbourPanel,switchToPanel:()=>switchToPanel,unloadPanelType:()=>unloadPanelType,updateBounds:()=>updateBounds,updateFontSize:()=>updateFontSize,updateMediaStateOfPanel:()=>updateMediaStateOfPanel,updateMediaStateOfPanelDebounced:()=>updateMediaStateOfPanelDebounced,updatePanelBoundsDebounced:()=>updatePanelBoundsDebounced,updatePanelsTooltips:()=>updatePanelsTooltips,updateSidebarTitle:()=>updateSidebarTitle});var selection_actions_exports={};__export(selection_actions_exports,{allowSelectionReset:()=>allowSelectionReset,deselectBookmark:()=>deselectBookmark,deselectHeader:()=>deselectHeader,deselectHistory:()=>deselectHistory,deselectNavItem:()=>deselectNavItem,deselectNewTabBtn:()=>deselectNewTabBtn,deselectTab:()=>deselectTab,deselectTabsBranch:()=>deselectTabsBranch,get:()=>get,getFirst:()=>getFirst,getLast:()=>getLast,getLength:()=>getLength,getTabsInfo:()=>getTabsInfo2,includes:()=>includes,isBookmarks:()=>isBookmarks,isHeader:()=>isHeader,isHistory:()=>isHistory,isNavItem:()=>isNavItem,isNewTabBar:()=>isNewTabBar,isSet:()=>isSet,isTabs:()=>isTabs,map:()=>map,preserveSelection:()=>preserveSelection,resetSelection:()=>resetSelection,select:()=>select,selectBookmark:()=>selectBookmark,selectBookmarks:()=>selectBookmarks,selectBookmarksRange:()=>selectBookmarksRange,selectHeader:()=>selectHeader,selectHistory:()=>selectHistory,selectNavItem:()=>selectNavItem,selectNewTabBtn:()=>selectNewTabBtn,selectTab:()=>selectTab,selectTabs:()=>selectTabs,selectTabsBranch:()=>selectTabsBranch,selectTabsRange:()=>selectTabsRange});var bookmarks_actions_exports={};__export(bookmarks_actions_exports,{attachTabInfoToTitle:()=>attachTabInfoToTitle,collapseAllBookmarks:()=>collapseAllBookmarks,convertOldTreeStruct:()=>convertOldTreeStruct,copyTitles:()=>copyTitles3,copyUrls:()=>copyUrls3,countBookmarks:()=>countBookmarks,createBookmarkNode:()=>createBookmarkNode,createFrom:()=>createFrom,createFromDragEvent:()=>createFromDragEvent2,editBookmarkNode:()=>editBookmarkNode,expandBookmark:()=>expandBookmark,extractTabInfoFromTitle:()=>extractTabInfoFromTitle,findBookmarkPanelOf:()=>findBookmarkPanelOf,foldBookmark:()=>foldBookmark,getMouseOpeningConf:()=>getMouseOpeningConf2,getPath:()=>getPath,isFolderWithURL:()=>isFolderWithURL,listBookmarks:()=>listBookmarks,load:()=>load3,markOpenBookmarks:()=>markOpenBookmarks,markOpenBookmarksDebounced:()=>markOpenBookmarksDebounced,markOpenBookmarksForAllTabs:()=>markOpenBookmarksForAllTabs,markParents:()=>markParents,move:()=>move2,open:()=>open4,openAsBookmarksPanel:()=>openAsBookmarksPanel,openAsTabsPanel:()=>openAsTabsPanel,openBookmarksPopup:()=>openBookmarksPopup,openInNewPanel:()=>openInNewPanel,openInNewWindow:()=>openInNewWindow,prepareBookmarks:()=>prepareBookmarks,reMarkOpenBookmark:()=>reMarkOpenBookmark,removeBookmarks:()=>removeBookmarks,restoreTree:()=>restoreTree,saveBookmarksTree:()=>saveBookmarksTree,saveToFolder:()=>saveToFolder,scrollToBookmark:()=>scrollToBookmark,scrollToBookmarkDebounced:()=>scrollToBookmarkDebounced,sortBookmarks:()=>sortBookmarks,toggleBranch:()=>toggleBranch2,unload:()=>unload3,unmarkAllOpenBookmarks:()=>unmarkAllOpenBookmarks,unmarkOpenBookmarks:()=>unmarkOpenBookmarks,unmarkOpenBookmarksDebounced:()=>unmarkOpenBookmarksDebounced,unmarkParents:()=>unmarkParents});var reactive={panelConfigPopup:null,containerConfigPopup:null,groupConfigPopup:null,newTabShortcutsPopup:null,siteConfigPopup:null,tabMoveRulesPopup:null,tabReopenRulesPopup:null,confirm:null,dialog:null},PopupsRState=reactive,reactFn;function initPopups(reactivate){reactivate&&(reactFn=reactivate,PopupsRState=reactive=reactFn(reactive))}function confirm(msg){return new Promise(res=>{reactive.confirm={msg,ok:()=>{reactive.confirm=null,res(!0)},cancel:()=>{reactive.confirm=null,res(!1)}}})}function finishConfirmation(accept){accept&&reactive.confirm?.ok?reactive.confirm.ok():reactive.confirm?.cancel&&reactive.confirm.cancel()}function ask(conf){return new Promise(ok=>{reactive.dialog={title:conf.title,note:conf.note,checkbox:conf.checkbox,buttons:conf.buttons,buttonsCentered:conf.buttonsCentered,buttonsInline:conf.buttonsInline,buttonsDefaultFocus:conf.buttonsDefaultFocus,result:answer=>{ok(answer),reactive.dialog=null}}})}function openPanelPopup(conf,index){return conf.type===void 0&&(conf.type=2),new Promise(res=>{let panel=Sidebar.panelsById[conf.id],panelConfig;if(panel)panelConfig=recreateNormalizedObject(panel,TABS_PANEL_CONFIG);else{if(conf.type===2)panelConfig=cloneObject(TABS_PANEL_CONFIG);else if(conf.type===1)panelConfig=cloneObject(BOOKMARKS_PANEL_CONFIG);else return res(null);updateObject(panelConfig,conf,conf)}reactive.panelConfigPopup={config:panelConfig,index,done:res}})}function closePanelPopup(){reactive.panelConfigPopup?.done&&reactive.panelConfigPopup.done(null),reactive.panelConfigPopup=null}function openContainerPopup(containerId){return new Promise(res=>{let container=Containers.reactive.byId[containerId];container||(container=cloneObject(DEFAULT_CONTAINER),container.name="",container.icon="fingerprint",container.color="toolbar"),reactive.containerConfigPopup={id:container?container.id:NOID,name:container.name,color:container.color,icon:container.icon,done:res}})}function closeContainerPopup(){reactive.containerConfigPopup?.done&&reactive.containerConfigPopup.done(null),reactive.containerConfigPopup=null}function openNewTabShortcutsPopup(panel){isTabsPanel(panel)&&(reactive.newTabShortcutsPopup={panelId:panel.id,rawShortcuts:cloneArray(panel.newTabBtns)})}function closeNewTabShortcutsPopup(){reactive.newTabShortcutsPopup&&(reactive.newTabShortcutsPopup=null)}function openSiteConfigPopup(tab){reactive.siteConfigPopup={url:tab.url,tabId:tab.id}}function closeSiteConfigPopup(){reactive.siteConfigPopup&&(reactive.siteConfigPopup=null)}function openTabMoveRulesPopup(panel){isTabsPanel(panel)&&(reactive.tabMoveRulesPopup={panelId:panel.id,rules:cloneArray(panel.moveRules)})}function closeTabMoveRulesPopup(){reactive.tabMoveRulesPopup&&(reactive.tabMoveRulesPopup=null)}function openTabReopenRulesPopup(containerId){let container=Containers.reactive.byId[containerId];container&&(reactive.tabReopenRulesPopup={container})}function closeTabReopenRulesPopup(){reactive.tabReopenRulesPopup&&(reactive.tabReopenRulesPopup=null)}var tabs_fg_actions_exports={};__export(tabs_fg_actions_exports,{SwitchingTabScope:()=>SwitchingTabScope,activateLastActiveTabOf:()=>activateLastActiveTabOf,activateParent:()=>activateParent,autoDiscardFolded:()=>autoDiscardFolded,bookmarkTabs:()=>bookmarkTabs,cacheTabsData:()=>cacheTabsData,clearTabsCookies:()=>clearTabsCookies,copyTitles:()=>copyTitles2,copyUrls:()=>copyUrls2,createReactiveProps:()=>createReactiveProps,dedupTabs:()=>dedupTabs,discardTabs:()=>discardTabs,duplicateTabs:()=>duplicateTabs,expTabsBranch:()=>expTabsBranch,findAncestor:()=>findAncestor,findSuccessorTab:()=>findSuccessorTab,flattenTabs:()=>flattenTabs,foldAllInactiveBranches:()=>foldAllInactiveBranches,foldTabsBranch:()=>foldTabsBranch,forEachDescendant:()=>forEachDescendant,getActiveTabsHistory:()=>getActiveTabsHistory,getBranch:()=>getBranch,getBranchLen:()=>getBranchLen,getStatus:()=>getStatus,getTabInfo:()=>getTabInfo,getTabs:()=>getTabs,getTabsInfo:()=>getTabsInfo,getTabsTreeData:()=>getTabsTreeData,getTooltip:()=>getTooltip,initTabs:()=>initTabs,load:()=>load2,mutateNativeTabToSideberyTab:()=>mutateNativeTabToSideberyTab,pinTabs:()=>pinTabs,pringDbgInfo:()=>pringDbgInfo,queryTab:()=>queryTab,reactivateTab:()=>reactivateTab,recalcBranchLen:()=>recalcBranchLen,reinitTabs:()=>reinitTabs,reloadTab:()=>reloadTab,reloadTabs:()=>reloadTabs,repinTabs:()=>repinTabs,saveTabData:()=>saveTabData,skipActiveTabsHistoryCollecting:()=>skipActiveTabsHistoryCollecting,sortNativeTabs:()=>sortNativeTabs,sortTabIds:()=>sortTabIds,switchTab:()=>switchTab,switchTabWithPreselect:()=>switchTabWithPreselect,switchToRecentlyActiveTab:()=>switchToRecentlyActiveTab,tabFlip:()=>tabFlip,toggleBranch:()=>toggleBranch,triggerFlashAnimation:()=>triggerFlashAnimation,unload:()=>unload2,unpinTabs:()=>unpinTabs,updateNativeTabsVisibility:()=>updateNativeTabsVisibility,updateSuccessionDebounced:()=>updateSuccessionDebounced,updateTabsIndexes:()=>updateTabsIndexes,updateTabsTree:()=>updateTabsTree,updateTabsTreeDebounced:()=>updateTabsTreeDebounced,updateTooltip:()=>updateTooltip,updateTooltipDebounced:()=>updateTooltipDebounced,updateUrlCounter:()=>updateUrlCounter,waitForTabsReady:()=>waitForTabsReady,writeActiveTabsHistory:()=>writeActiveTabsHistory});var permissions_actions_exports={};__export(permissions_actions_exports,{loadPermissions:()=>loadPermissions,request:()=>request,resetListeners:()=>resetListeners2,setupListeners:()=>setupListeners3});var history_actions_exports={};__export(history_actions_exports,{copyTitles:()=>copyTitles,copyUrls:()=>copyUrls,createVisit:()=>createVisit,deleteSites:()=>deleteSites,deleteVisits:()=>deleteVisits,getMouseOpeningConf:()=>getMouseOpeningConf,initHistory:()=>initHistory,load:()=>load,loadMore:()=>loadMore,normalizeHistory:()=>normalizeHistory,open:()=>open2,recalcDays:()=>recalcDays,resetListeners:()=>resetListeners,scrollToHistoryItem:()=>scrollToHistoryItem,scrollToHistoryItemDebounced:()=>scrollToHistoryItemDebounced,setupListeners:()=>setupListeners2,unload:()=>unload,unloadAfter:()=>unloadAfter});var setup_page_actions_exports={};__export(setup_page_actions_exports,{closePermissionsPopup:()=>closePermissionsPopup,copyDevtoolsUrl:()=>copyDevtoolsUrl,getDbgDetails:()=>getDbgDetails,goToPerm:()=>goToPerm,initialized:()=>initialized,open:()=>open,registerEl:()=>registerEl,setupListeners:()=>setupListeners,switchView:()=>switchView,updateActiveSection:()=>updateActiveSection,updateActiveView:()=>updateActiveView,waitForInit:()=>waitForInit});var reactive2={nav:[],panels:{}},SidebarConfigRState=reactive2,reactFn2;function initSidebarConfig(reactivate){reactivate&&(reactFn2=reactivate,SidebarConfigRState=reactive2=reactFn2(reactive2))}async function loadSidebarConfig(){let storage=await browser.storage.local.get("sidebar");if(storage.sidebar?.nav&&(SidebarConfigRState.nav=storage.sidebar.nav),storage.sidebar?.panels){for(let conf of Object.values(storage.sidebar.panels))isTabsPanel(conf)?normalizeObject(conf,TABS_PANEL_CONFIG):isBookmarksPanel(conf)?normalizeObject(conf,BOOKMARKS_PANEL_CONFIG):isHistoryPanel(conf)&&normalizeObject(conf,HISTORY_PANEL_CONFIG);SidebarConfigRState.panels=storage.sidebar.panels}}async function saveSidebarConfig(delay){return Store.set({sidebar:cloneObject(SidebarConfigRState)},delay)}function getSidebarConfigFromV4(panels_v4){let sidebar2={panels:{},nav:[]};for(let oldPanelConf of panels_v4)if(oldPanelConf.type==="bookmarks"){let panel=cloneObject(BOOKMARKS_PANEL_CONFIG);panel.id="bookmarks",panel.name=translate("panel.bookmarks.title"),panel.lockedPanel=oldPanelConf.lockedPanel,panel.skipOnSwitching=oldPanelConf.skipOnSwitching,sidebar2.panels[panel.id]=panel,sidebar2.nav.push(panel.id)}else{let panel=cloneObject(TABS_PANEL_CONFIG);panel.id=oldPanelConf.id,panel.name=oldPanelConf.name,panel.lockedPanel=oldPanelConf.lockedPanel,panel.skipOnSwitching=oldPanelConf.skipOnSwitching,panel.color=normalizeColor(oldPanelConf.color),panel.iconSVG=oldPanelConf.icon,panel.iconIMG=oldPanelConf.customIcon,panel.iconIMGSrc=oldPanelConf.customIconSrc,panel.noEmpty=oldPanelConf.noEmpty,panel.newTabCtx=oldPanelConf.newTabCtx,panel.dropTabCtx=oldPanelConf.dropTabCtx,oldPanelConf.moveTabCtx&&oldPanelConf.moveTabCtx!=="none"&&panel.moveRules.push({id:uid(),active:!0,containerId:oldPanelConf.moveTabCtx,topLvlOnly:!!oldPanelConf.moveTabCtxNoChild}),oldPanelConf.urlRules&&panel.moveRules.push(...convertOldUrlRulesToMoveRules(oldPanelConf)),sidebar2.panels[panel.id]=panel,sidebar2.nav.push(panel.id)}return Settings.state.hideAddBtn||sidebar2.nav.push("add_tp"),sidebar2.nav.push("sp-0"),Settings.state.hideSettingsBtn||sidebar2.nav.push("settings"),sidebar2}function convertOldUrlRulesToMoveRules(panel){let output=[],isActive=!!panel.urlRulesActive;for(let rawRule of panel.urlRules.split(`
`)){let rule=rawRule.trim();rule&&output.push({id:uid(),active:isActive,url:rule})}return output}function createTabsPanelConfig(conf){let panelConf=cloneObject(TABS_PANEL_CONFIG);return conf&&updateObject(panelConf,conf,conf),panelConf.id||(panelConf.id=uid()),panelConf.name||(panelConf.name=translate("panel.tabs.title")),panelConf}function createBookmarksPanelConfig(conf){let panelConf=cloneObject(BOOKMARKS_PANEL_CONFIG);return conf&&updateObject(panelConf,conf,conf),panelConf.id||(panelConf.id=uid()),panelConf.name||(panelConf.name=translate("panel.bookmarks.title")),panelConf.rootId||(panelConf.rootId=BKM_ROOT_ID),panelConf}function createHistoryPanelConfig(){return cloneObject(HISTORY_PANEL_CONFIG)}function createDefaultSidebarConfig(){let defaultTabsPanelConfig=createTabsPanelConfig();return{panels:{[defaultTabsPanelConfig.id]:defaultTabsPanelConfig},nav:[defaultTabsPanelConfig.id,"add_tp","sp-0","settings"]}}function setupSidebarConfigListeners(){Store.onKeyChange("sidebar",updateSidebarConfig)}function updateSidebarConfig(newConfig){if(newConfig?.nav?.length||(newConfig={nav:[],panels:{}}),newConfig.nav&&(SidebarConfigRState.nav=newConfig.nav),newConfig.panels){for(let conf of Object.values(newConfig.panels))isTabsPanel(conf)?normalizeObject(conf,TABS_PANEL_CONFIG):isBookmarksPanel(conf)?normalizeObject(conf,BOOKMARKS_PANEL_CONFIG):isHistoryPanel(conf)&&normalizeObject(conf,HISTORY_PANEL_CONFIG);SidebarConfigRState.panels=newConfig.panels}}var isReady=!1,readyStateResolve=[],navLockTimeout,els={};async function open(section){let url=browser.runtime.getURL("page.setup/setup.html"),existedTab=Tabs2.list.find(t=>t.url.startsWith(url)),activeTab=Tabs2.byId[Tabs2.activeId],activePanel=Sidebar.panelsById[Sidebar.activePanelId];isTabsPanel(activePanel)||(activePanel=Sidebar.panelsById[Sidebar.lastTabsPanelId]),!isTabsPanel(activePanel)&&activeTab&&!activeTab.pinned&&(activePanel=Sidebar.panelsById[activeTab.panelId]),section&&(url+="#"+section),existedTab?existedTab.url===url?browser.tabs.update(existedTab.id,{active:!0}):await browser.tabs.update(existedTab.id,{url,active:!0}):activeTab&&!activeTab.pinned&&(activeTab.url==="about:newtab"||activeTab.url==="about:blank")?await browser.tabs.update(activeTab.id,{url,active:!0}):isTabsPanel(activePanel)?Tabs2.createTabInPanel(activePanel,{url}):browser.tabs.create({url,windowId:Windows.id})}function goToPerm(permId){document.title="Sidebery / Settings",SetupPage.reactive.activeView="settings",SetupPage.reactive.permissions=permId,setTimeout(()=>{let scrollHighlightConf={behavior:"smooth",block:"center"},el=els[permId];el&&el.scrollIntoView(scrollHighlightConf)},120)}function closePermissionsPopup(){SetupPage.reactive.permissions=!1,location.hash=""}async function updateActiveView(){let hash=location.hash?location.hash.slice(1):location.hash,hashArg=hash.split(".");hash=hashArg[0];let arg=hashArg[1],scrollSectionConf={behavior:"smooth",block:"start"};if(navLockTimeout&&clearTimeout(navLockTimeout),SetupPage.reactive.navLock=!0,SetupPage.reactive.activeSection=hash,navLockTimeout=setTimeout(()=>{SetupPage.reactive.navLock=!1},1250),hash==="all-urls")return goToPerm("all_urls");if(hash==="tab-hide")return goToPerm("tab_hide");if(hash==="clipboard-write")return goToPerm("clipboard_write");if(hash==="history")return goToPerm("history");if(hash==="bookmarks")return goToPerm("bookmarks");if(hash.startsWith("menu_editor")){setTimeout(()=>els[hash]?.scrollIntoView(scrollSectionConf),SetupPage.reactive.activeView==="menu_editor"?0:250),document.title="Sidebery / Menu Editor",SetupPage.reactive.activeView="menu_editor",SetupPage.reactive.permissions=!1;return}if(hash.startsWith("styles_editor")){document.title="Sidebery / Styles Editor",SetupPage.reactive.activeView="styles_editor",SetupPage.reactive.activeSection="styles_editor",SetupPage.reactive.permissions=!1;return}if(hash.startsWith("snapshots")){document.title="Sidebery / Snapshots",SetupPage.reactive.activeView="snapshots",SetupPage.reactive.activeSection="snapshots",SetupPage.reactive.permissions=!1;return}if(hash.startsWith("storage")){document.title="Sidebery / Storage",SetupPage.reactive.activeView="storage",SetupPage.reactive.activeSection="storage",SetupPage.reactive.permissions=!1;return}if(hash.startsWith("keybindings")){document.title="Sidebery / Keybindings",SetupPage.reactive.activeView="keybindings",SetupPage.reactive.activeSection="keybindings",SetupPage.reactive.permissions=!1;return}await waitForInit(),setTimeout(()=>{els[hash]&&els[hash].scrollIntoView(scrollSectionConf),arg&&hash==="settings_containers"&&setTimeout(()=>{let container=Containers.reactive.byId[arg];container&&(SetupPage.reactive.selectedContainer=container)},120),arg&&hash==="settings_nav"&&(SetupPage.reactive.selectedPanelConfig&&(SetupPage.reactive.selectedPanelConfig=null),setTimeout(()=>{let panelConf=SidebarConfigRState.panels[arg];panelConf&&(SetupPage.reactive.selectedPanelConfig=panelConf)},120))},SetupPage.reactive.activeView==="settings"?0:250),document.title="Sidebery / Settings",SetupPage.reactive.activeView="settings"}async function waitForInit(){return new Promise(res=>{isReady?res():readyStateResolve.push(res)})}function initialized(){readyStateResolve&&readyStateResolve.forEach(cb=>cb()),isReady=!0,readyStateResolve=[]}function switchView(name){location.hash=name}function registerEl(name,el){el&&(els[name]=el)}function setupListeners(){window.addEventListener("hashchange",updateActiveView)}function updateActiveSection(scrollTop){for(let name,el,i=SetupPage.reactive.nav.length;i--;)if(name=SetupPage.reactive.nav[i]?.name,el=els[name],!(!name||!el||!name.startsWith(SetupPage.reactive.activeView))&&scrollTop>=el.offsetTop-8){SetupPage.reactive.activeSection=name;break}}async function getDbgDetails(){let dbg={addonVersion:browser.runtime.getManifest().version,firefoxVersion:(await browser.runtime.getBrowserInfo()).version,settings:cloneObject(Settings.state)};try{let perms=await Promise.all([browser.permissions.contains({origins:["<all_urls>"]}),browser.permissions.contains({permissions:["webRequest"]}),browser.permissions.contains({permissions:["webRequestBlocking"]}),browser.permissions.contains({permissions:["proxy"]}),browser.permissions.contains({permissions:["tabHide"]}),browser.permissions.contains({permissions:["clipboardWrite"]}),browser.permissions.contains({permissions:["history"]}),browser.permissions.contains({permissions:["bookmarks"]}),browser.permissions.contains({permissions:["downloads"]})]);dbg.permissions={allUrls:perms[0],webRequest:perms[1],webRequestBlocking:perms[2],proxy:perms[3],tabHide:perms[4],clipboardWrite:perms[5],history:perms[6],bookmarks:perms[7],downloads:perms[8]}}catch(err3){dbg.permissions=err3.toString()}try{let stored=await browser.storage.local.get();dbg.storage={size:strSize(JSON.stringify(stored)),props:{}};for(let prop of Object.keys(stored))dbg.storage.props[prop]=strSize(JSON.stringify(stored[prop]))}catch(err3){dbg.storage=err3.toString()}try{let stored=await browser.storage.local.get("sidebar");if(stored.sidebar){for(let panel of Object.values(stored.sidebar.panels))panel.name=`len: ${panel.name.length}`,panel.iconIMGSrc&&(panel.iconIMGSrc=`len: ${panel.iconIMGSrc.length}`),panel.iconIMG&&(panel.iconIMG=`len: ${panel.iconIMG.length}`);dbg.sidebar=stored.sidebar}}catch(err3){dbg.sidebar=err3.toString()}try{let{containers}=await browser.storage.local.get("containers");if(containers){dbg.containers=[];for(let container of Object.values(containers)){let clone=cloneObject(container);clone.name&&(clone.name=clone.name.length.toString()),clone.icon&&(clone.icon="..."),clone.proxy&&(clone.proxy={type:clone.proxy.type}),clone.includeHosts&&(clone.includeHosts=clone.includeHosts.length.toString()),clone.excludeHosts&&(clone.excludeHosts=clone.excludeHosts.length.toString()),clone.userAgent&&(clone.userAgent=clone.userAgent.length.toString()),dbg.containers.push(clone)}}}catch(err3){dbg.containers=err3.toString()}try{let s=await browser.storage.local.get(["sidebarCSS","groupCSS"]);s.sidebarCSS&&(dbg.sidebarCSSLen=s.sidebarCSS.length.toString()),s.groupCSS&&(dbg.groupCSSLen=s.groupCSS.length.toString())}catch{}try{let windows=await browser.windows.getAll({populate:!0});dbg.windows=[];for(let w of windows)dbg.windows.push({state:w.state,incognito:w.incognito,tabsCount:w.tabs?.length??-1})}catch(err3){dbg.windows=err3.toString()}try{let s=await browser.storage.local.get(["tabsMenu","bookmarksMenu","tabsPanelMenu","bookmarksPanelMenu"]);s.tabsMenu&&(dbg.tabsMenu=s.tabsMenu),s.bookmarksMenu&&(dbg.bookmarksMenu=s.bookmarksMenu),s.tabsPanelMenu&&(dbg.tabsPanelMenu=s.tabsPanelMenu),s.bookmarksPanelMenu&&(dbg.bookmarksPanelMenu=s.bookmarksPanelMenu)}catch(err3){dbg.tabsMenu=err3.toString(),dbg.bookmarksMenu=err3.toString(),dbg.tabsPanelMenu=err3.toString(),dbg.bookmarksPanelMenu=err3.toString()}try{let bookmarks2=await browser.bookmarks.getTree(),bookmarksCount=0,foldersCount=0,separatorsCount=0,lvl=0,maxDepth=0,walker=nodes=>{lvl>maxDepth&&(maxDepth=lvl);for(let node of nodes)node.type==="bookmark"&&bookmarksCount++,node.type==="folder"&&foldersCount++,node.type==="separator"&&separatorsCount++,node.children&&(lvl++,walker(node.children),lvl--)};bookmarks2[0]?.children&&walker(bookmarks2[0].children),dbg.bookmarks={bookmarksCount,foldersCount,separatorsCount,maxDepth}}catch(err3){dbg.bookmarks=err3.toString()}return dbg}function copyDevtoolsUrl(){navigator.clipboard.writeText("about:devtools-toolbox?id=%7B3c078156-979c-498b-8990-85f7987dd929%7D&type=extension")}var nav=[{active:!1,name:"settings"},{active:!1,name:"settings_general",sub:!0},{active:!1,name:"settings_menu",sub:!0},{active:!1,name:"settings_nav",sub:!0},{active:!1,name:"settings_group",sub:!0},{active:!1,name:"settings_containers",sub:!0},{active:!1,name:"settings_dnd",sub:!0},{active:!1,name:"settings_search",sub:!0},{active:!1,name:"settings_tabs",sub:!0},{active:!1,name:"settings_bookmarks",sub:!0},{active:!1,name:"settings_history",sub:!0},{active:!1,name:"settings_appearance",sub:!0},{active:!1,name:"settings_mouse",sub:!0},{active:!1,name:"settings_snapshots",sub:!0},{active:!1,name:"settings_sync",sub:!0},{active:!1,name:"settings_help",sub:!0},{active:!1,name:"keybindings"},{active:!1,name:"menu_editor"},{active:!1,name:"menu_editor_tabs",sub:!0},{active:!1,name:"menu_editor_tabs_panel",sub:!0},{active:!1,name:"menu_editor_bookmarks",sub:!0},{active:!1,name:"menu_editor_bookmarks_panel",sub:!0},{active:!1,name:"styles_editor"},{active:!1,name:"snapshots"}],SetupPage={reactive:{nav,activeView:"settings",activeSection:"settings_general",selectedContainer:null,selectedPanelConfig:null,detailsText:"",detailsTitle:"",navLock:!1,exportDialog:!1,importedData:null,permissions:!1},...setup_page_actions_exports};var Notifications={reactive:{list:[]},hiddenRecently:!1,err:err2,notify,resetTimer,resetTimers,restartTimer,restartTimers,progress,finishProgress,updateProgress,setHiddenRecently,notifyAboutWrongProxyAuthData};function err2(title,details){return notify({title,details,lvl:"err"})}function notify(config,timeout=5555){let id=uid();config.id=id,config.lvl||(config.lvl="info"),config.timeout=timeout,timersEnabled&&restartTimer(config);let len=Notifications.reactive.list.push(config);return Notifications.reactive.list[len-1]}var timersEnabled=!0;function resetTimer(nn){nn.timer&&clearTimeout(nn.timer),nn.timer=void 0}function resetTimers(){timersEnabled=!1,Notifications.reactive.list.forEach(resetTimer)}function restartTimer(nn){nn.timer&&clearTimeout(nn.timer),nn.timeout&&(nn.timer=setTimeout(()=>{let index=Notifications.reactive.list.findIndex(n=>n.id===nn.id);index!==-1&&Notifications.reactive.list.splice(index,1)},nn.timeout))}function restartTimers(){timersEnabled=!0,Notifications.reactive.list.forEach(restartTimer)}function progress(config){let id=uid();config.id=id,config.lvl="progress",config.progress||(config.progress={percent:0});let len=Notifications.reactive.list.push(config);return Notifications.reactive.list[len-1]}function updateProgress(notification,done,all){if(!notification.progress)return;let prcnt=Math.floor(100/all*done);prcnt>100&&(prcnt=100),prcnt<0&&(prcnt=0),notification.progress.percent=prcnt}function finishProgress(notification,delay=120){notification.progress&&(notification.progress.percent=100,setTimeout(()=>{let index=Notifications.reactive.list.indexOf(notification);index!==-1&&Notifications.reactive.list.splice(index,1)},delay))}var hiddenRecentlyTimeout;function setHiddenRecently(){Notifications.hiddenRecently=!0,clearTimeout(hiddenRecentlyTimeout),hiddenRecentlyTimeout=setTimeout(()=>{Notifications.hiddenRecently=!1},1e3)}function notifyAboutWrongProxyAuthData(containerId){let config={lvl:"err",title:translate("notif.proxy_auth_err"),details:translate("notif.proxy_auth_err_details"),ctrl:translate("notif.proxy_auth_err_ctrl"),callback:()=>SetupPage.open(`settings_containers.${containerId}`)};Notifications.notify(config)}var search_actions_exports={};__export(search_actions_exports,{INPUT_TIMEOUT:()=>INPUT_TIMEOUT,bookmarks:()=>bookmarks,check:()=>check,close:()=>close,enter:()=>enter,focus:()=>focus,getSearchQuery:()=>getSearchQuery,hideBar:()=>hideBar,history:()=>history,init:()=>init,menu:()=>menu,next:()=>next,onOutsideSearchExit:()=>onOutsideSearchExit,onOutsideSearchInput:()=>onOutsideSearchInput,parseShortcuts:()=>parseShortcuts,prev:()=>prev,registerInputEl:()=>registerInputEl,reset:()=>reset,search:()=>search,searchDebounced:()=>searchDebounced,selectAll:()=>selectAll,showBar:()=>showBar,start:()=>start,stop:()=>stop,toggleBar:()=>toggleBar});var prevActivePanelId;function onTabsSearch(activePanel,noSel){if(!isTabsPanel(activePanel))return;let value=Search.reactive.value,samePanel=prevActivePanelId===activePanel.id;if(prevActivePanelId=activePanel.id,activePanel.tabs.length){if(value){let prevValue=Search.prevValue,moreSpecific=value.length>prevValue.length,tabs;prevValue&&moreSpecific&&value.startsWith(prevValue)&&samePanel&&(tabs=activePanel.filteredTabs),tabs||(tabs=activePanel.tabs);let filtered=[],filteredIds=[],filteredInvisible=[],filteredInvisibleIds=[];for(let tab of tabs)(Search.check(tab.title)||Search.check(tab.url))&&(tab.invisible?(filteredInvisible.push(tab),filteredInvisibleIds.push(tab.id)):(filtered.push(tab),filteredIds.push(tab.id)));activePanel.filteredTabs=filtered.concat(filteredInvisible),activePanel.reactive.filteredLen=activePanel.filteredTabs.length,activePanel.reactive.visibleTabIds=filteredIds.concat(filteredInvisibleIds)}else activePanel.filteredTabs=void 0,activePanel.reactive.filteredLen=void 0,Sidebar.recalcVisibleTabs(activePanel.id);if(value&&!noSel){let firstTab=activePanel.filteredTabs?.[0];firstTab&&(Selection.resetSelection(),Selection.selectTab(firstTab.id),Tabs2.scrollToTab(firstTab.id))}Search.prevValue&&!value&&Selection.resetSelection()}else Search.reset(activePanel)}function onTabsSearchNext(panel){if(panel||(panel=Sidebar.panelsById[Sidebar.activePanelId]),!isTabsPanel(panel)||!panel.filteredTabs)return;let selId=Selection.getFirst(),index=panel.filteredTabs.findIndex(t=>t.id===selId);if(index+=1,index<0||index>=panel.filteredTabs.length)return;Selection.resetSelection();let tab=panel.filteredTabs[index];tab&&(Selection.selectTab(tab.id),Tabs2.scrollToTab(tab.id,!0))}function onTabsSearchPrev(panel){if(panel||(panel=Sidebar.panelsById[Sidebar.activePanelId]),!isTabsPanel(panel)||!panel.filteredTabs)return;let selId=Selection.getFirst(),index=panel.filteredTabs.findIndex(t=>t.id===selId);if(index-=1,index<0||index>=panel.filteredTabs.length)return;Selection.resetSelection();let tab=panel.filteredTabs[index];tab&&(Selection.selectTab(tab.id),Tabs2.scrollToTab(tab.id,!0))}function onTabsSearchEnter(panel){if(!isTabsPanel(panel))return;if(Search.reactive.value&&!panel.filteredTabs?.length)return findInAnotherPanel();let selId=Selection.getFirst(),tab=Tabs2.byId[selId];tab&&browser.tabs.update(tab.id,{active:!0}),Search.stop()}function onTabsSearchSelectAll(panel){if(!panel.filteredTabs)return;let ids=[],allSelected=!0;for(let tab of panel.filteredTabs)allSelected&&!tab.sel&&(allSelected=!1),ids.push(tab.id);Selection.resetSelection(),!allSelected&&ids.length&&Selection.selectTabs(ids)}function findInAnotherPanel(){let firstMatch=Tabs2.list.find(t=>!t.pinned&&(Search.check(t.title)||Search.check(t.url)));if(!firstMatch)return;let panel=Sidebar.panelsById[firstMatch.panelId];isTabsPanel(panel)&&(panel.filteredTabs=void 0,panel.reactive.filteredLen=void 0,Sidebar.recalcVisibleTabs(panel.id),Sidebar.activatePanel(firstMatch.panelId))}function ancestorIsFiltered(node,folders){let parent=Bookmarks.reactive.byId[node.parentId];for(;parent;){if(!!folders[parent.id])return!0;parent=Bookmarks.reactive.byId[parent.parentId]}return!1}function searchTreeWalker(nodes,filtered,folders={}){for(let n of nodes)ancestorIsFiltered(n,folders)||(n.title&&n.url&&(Search.check(n.title)||Search.check(n.url))&&filtered.push(n),n.title&&!n.url&&n.parentId!==BKM_ROOT_ID&&Search.check(n.title)&&(folders[n.id]=n,filtered.unshift(n)),n.children&&searchTreeWalker(n.children,filtered,folders))}function searchHistoryWalker(nodes,filtered){for(let n of nodes)n.title&&n.url&&(Search.check(n.title)||Search.check(n.url))&&filtered.push(n),n.children&&searchHistoryWalker(n.children,filtered)}var prevActivePanelId2,expandedBookmarks;function onBookmarksSearch(activePanel,panel,noSel){if(!Bookmarks.reactive.tree.length||(panel||(panel=activePanel),!isBookmarksPanel(panel)))return;let samePanel=prevActivePanelId2===panel.id;if(prevActivePanelId2=panel.id,Search.reactive.value){let value=Search.reactive.value,prevValue=Search.prevValue,rootBookmark=Bookmarks.reactive.byId[panel.rootId],bookmarks2;if(value.length>prevValue.length&&value.startsWith(prevValue)&&samePanel&&(bookmarks2=panel.reactive.filteredBookmarks),!bookmarks2)if(panel.reactive.rootOffset){let folder=Bookmarks.reactive.byId[panel.rootId];for(let i=panel.reactive.rootOffset;i--&&folder;)folder=Bookmarks.reactive.byId[folder.parentId];folder?bookmarks2=folder.children:bookmarks2=Bookmarks.reactive.tree}else bookmarks2=rootBookmark?.children;bookmarks2||(bookmarks2=Bookmarks.reactive.tree);let filtered=[];if(panel.viewMode==="tree"?(Search.prevExpandedBookmarks||(Search.prevExpandedBookmarks=Bookmarks.reactive.expanded,Bookmarks.reactive.expanded={}),Bookmarks.reactive.expanded[activePanel.id]||(Bookmarks.reactive.expanded[activePanel.id]={}),expandedBookmarks=Bookmarks.reactive.expanded[activePanel.id],searchTreeWalker(bookmarks2,filtered)):panel.viewMode==="history"&&(searchHistoryWalker(bookmarks2,filtered),filtered.sort((a,b)=>(b.dateAdded??0)-(a.dateAdded??0))),panel.reactive.filteredBookmarks=filtered,panel.reactive.filteredLen=filtered.length,panel.reactive.filteredBookmarks.length&&!noSel){let first=panel.reactive.filteredBookmarks[0];Selection.resetSelection(),Selection.selectBookmark(first.id),Bookmarks.scrollToBookmarkDebounced(first.id)}}else expandedBookmarks={},panel.reactive.filteredBookmarks=void 0,panel.reactive.filteredLen=void 0,Search.prevValue&&Selection.resetSelection()}var nextWalkerPrevNode;function nextWalker(nodes){for(let node of nodes){if(nextWalkerPrevNode?.sel)return node.id;if(nextWalkerPrevNode=node,expandedBookmarks[node.id]&&node.children){let nextId=nextWalker(node.children);if(nextId!==void 0)return nextId}}}function onBookmarksSearchNext(panel){if(panel||(panel=Sidebar.panelsById[Sidebar.activePanelId]),!isBookmarksPanel(panel)||!panel.reactive.filteredBookmarks)return;nextWalkerPrevNode=void 0;let filtered=panel.reactive.filteredBookmarks,nextId;if(panel.viewMode==="tree")nextId=Selection.isSet()?nextWalker(filtered):filtered[0]?.id;else if(panel.viewMode==="history"){let selIndex=filtered.findIndex(b=>b.sel);nextId=filtered[selIndex+1]?.id}nextId&&(Selection.resetSelection(),Selection.selectBookmark(nextId),Bookmarks.scrollToBookmark(nextId))}var prevWalkerPrevId;function prevWalker(nodes){for(let node of nodes){if(node.sel&&prevWalkerPrevId)return prevWalkerPrevId;if(prevWalkerPrevId=node.id,expandedBookmarks[node.id]&&node.children){let id=prevWalker(node.children);if(id!==void 0)return id}}}function onBookmarksSearchPrev(panel){if(panel||(panel=Sidebar.panelsById[Sidebar.activePanelId]),!isBookmarksPanel(panel)||!panel.reactive.filteredBookmarks)return;prevWalkerPrevId=void 0;let filtered=panel.reactive.filteredBookmarks,filteredLen=filtered.length,prevId;if(panel.viewMode==="tree")prevId=Selection.isSet()?prevWalker(filtered):filtered[filteredLen-1]?.id;else if(panel.viewMode==="history"){let selIndex=filtered.findLastIndex(b=>b.sel);selIndex===-1&&(selIndex=filtered.length),prevId=filtered[selIndex-1]?.id}prevId&&(Selection.resetSelection(),Selection.selectBookmark(prevId),Bookmarks.scrollToBookmark(prevId))}function onBookmarksSearchEnter(actPanel,panel){if(panel||(panel=actPanel),!isBookmarksPanel(panel)||!panel.reactive.filteredBookmarks)return;if(Search.reactive.value&&!panel.reactive.filteredBookmarks?.length)return findInAnotherPanel2();let selId=Selection.getFirst(),bookmark=Bookmarks.reactive.byId[selId];if(bookmark){if(bookmark.type==="folder")return Bookmarks.toggleBranch(bookmark.id,actPanel.id);if(bookmark.type==="bookmark"){let dst={};if(isTabsPanel(actPanel))dst.panelId=actPanel.id;else{dst.panelId=Sidebar.getRecentTabsPanelId();let panel2=Sidebar.panelsById[dst.panelId];isTabsPanel(panel2)&&(dst.index=Tabs2.getIndexForNewTab(panel2))}Bookmarks.open([bookmark.id],dst,!1,!0)}}Search.stop(),Sidebar.subPanelActive&&Sidebar.closeSubPanel()}function*visibleBookmarks(nodes){for(let n of nodes){yield n;let isExpanded=expandedBookmarks[n.id];n.children&&isExpanded&&(yield*visibleBookmarks(n.children))}}function onBookmarksSearchSelectAll(panel){if(!panel.reactive.filteredBookmarks)return;let ids=[],allSelected=!0;for(let node of visibleBookmarks(panel.reactive.filteredBookmarks))allSelected&&!node.sel&&(allSelected=!1),ids.push(node.id);Selection.resetSelection(),!allSelected&&ids.length&&Selection.selectBookmarks(ids)}function firstMatchWalker(nodes,path2){for(let n of nodes){if(n.title&&n.url&&(Search.check(n.title)||Search.check(n.url))||n.title&&!n.url&&n.parentId!==BKM_ROOT_ID&&Search.check(n.title))return n;if(n.children){path2.push(n.id);let result=firstMatchWalker(n.children,path2);if(result)return result;path2.pop()}}}function findPanelWithRoot(path2){for(let id of Sidebar.reactive.nav){let panel=Sidebar.panelsById[id];if(isBookmarksPanel(panel)&&(panel.rootId===NOID||path2.includes(panel.rootId)))return panel}}function findInAnotherPanel2(){let path2=[BKM_ROOT_ID];if(!firstMatchWalker(Bookmarks.reactive.tree,path2))return;let panel=findPanelWithRoot(path2);panel&&Sidebar.activatePanel(panel.id)}async function onHistorySearch(noSel){if(History.ready=!1,History.reactive.loading=!0,History.reactive.days=[],Search.reactive.value){let first;try{let result=await browser.history.search({text:Search.reactive.value,maxResults:100,startTime:0}),norm=await History.normalizeHistory(result,!1,void 0,void 0,!0);History.filtered=norm,first=History.filtered[0]}catch{History.filtered=void 0}History.reactive.days=History.recalcDays(),first&&!noSel&&(Selection.resetSelection(),Selection.selectHistory(first.id),History.scrollToHistoryItemDebounced(120,first.id))}else History.filtered=void 0,History.reactive.days=History.recalcDays(),Search.prevValue&&Selection.resetSelection();History.ready=!0,History.reactive.loading=!1}function onHistorySearchNext(){if(!History.ready||!History.filtered)return;let selId=Selection.getFirst(),index=History.filtered.findIndex(t=>t.id===selId);if(index+=1,index<0||index>=History.filtered.length)return;Selection.resetSelection();let visit=History.filtered[index];visit&&(Selection.selectHistory(visit.id),History.scrollToHistoryItem(visit.id))}function onHistorySearchPrev(){if(!History.ready||!History.filtered)return;let selId=Selection.getFirst(),index=History.filtered.findIndex(t=>t.id===selId);if(index-=1,index<0||index>=History.filtered.length)return;Selection.resetSelection();let visit=History.filtered[index];visit&&(Selection.selectHistory(visit.id),History.scrollToHistoryItem(visit.id))}function onHistorySearchEnter(){let panel=Sidebar.panelsById.history;if(!panel||!panel.ready||!History.filtered)return;let selId=Selection.getFirst(),visit=History.filtered.find(t=>t.id===selId);visit&&History.open(visit,{panelId:Sidebar.getRecentTabsPanelId()},!1,!0),Search.stop()}var INPUT_TIMEOUT=300;function init(){Settings.state.searchBarMode==="static"&&(Search.reactive.barIsShowed=!0)}var inputTimeout;function onOutsideSearchInput(value){Windows.focused&&(!Search.reactive.barIsShowed&&Search.rawValue&&Search.toggleBar(),Search.reactive.rawValue=Search.rawValue=value,clearTimeout(inputTimeout),inputTimeout=setTimeout(()=>{Search.search(Search.rawValue)},INPUT_TIMEOUT))}function onOutsideSearchExit(){if(!Search.reactive.barIsShowed)return;Sidebar.subPanelActive&&subPanelOpenBySearch&&Sidebar.closeSubPanel(),searchPrevPanelId!==void 0&&(Sidebar.activatePanel(searchPrevPanelId,!0,!0),searchPrevPanelId=void 0),document.hasFocus()?inputEl&&inputEl!==document.activeElement&&(Search.reactive.barIsActive=!1):Search.close()}function next(){if(!Search.reactive.barIsShowed)return;if(Menu.isOpen)return Menu.selectOption(1);let actPanel=Sidebar.panelsById[Sidebar.activePanelId];actPanel&&(isTabsPanel(actPanel)?Sidebar.subPanelActive?Sidebar.subPanelType===2&&Sidebar.subPanels.bookmarks?onBookmarksSearchNext(Sidebar.subPanels.bookmarks):Sidebar.subPanelType===3&&onHistorySearchNext():onTabsSearchNext(actPanel):isBookmarksPanel(actPanel)?onBookmarksSearchNext(actPanel):isHistoryPanel(actPanel)&&onHistorySearchNext())}function prev(){if(!Search.reactive.barIsShowed)return;if(Menu.isOpen)return Menu.selectOption(-1);let actPanel=Sidebar.panelsById[Sidebar.activePanelId];actPanel&&(isTabsPanel(actPanel)?Sidebar.subPanelActive?Sidebar.subPanelType===2&&Sidebar.subPanels.bookmarks?onBookmarksSearchPrev(Sidebar.subPanels.bookmarks):Sidebar.subPanelType===3&&onHistorySearchPrev():onTabsSearchPrev(actPanel):isBookmarksPanel(actPanel)?onBookmarksSearchPrev(actPanel):isHistoryPanel(actPanel)&&onHistorySearchPrev())}function enter(){if(!Search.reactive.barIsShowed)return;if(Menu.isOpen){Menu.activateOption()&&Search.close();return}let actPanel=Sidebar.panelsById[Sidebar.activePanelId];if(actPanel){if(query.startsWith(". ")){Search.stop(),Sidebar.switchToPanel(actPanel.id);return}isTabsPanel(actPanel)?Sidebar.subPanelActive?Sidebar.subPanelType===2&&Sidebar.subPanels.bookmarks?onBookmarksSearchEnter(actPanel,Sidebar.subPanels.bookmarks):Sidebar.subPanelType===3&&onHistorySearchEnter():onTabsSearchEnter(actPanel):isBookmarksPanel(actPanel)?onBookmarksSearchEnter(actPanel):isHistoryPanel(actPanel)&&onHistorySearchEnter()}}var searchPrevPanelId,subPanelOpenBySearch=!1;function bookmarks(){if(!Search.reactive.barIsShowed)return;let actPanel=Sidebar.panelsById[Sidebar.activePanelId];if(isTabsPanel(actPanel)&&Settings.state.subPanelBookmarks)if(Sidebar.subPanelActive&&Sidebar.subPanelType===2&&Sidebar.subPanels.bookmarks){let panel=Sidebar.subPanels.bookmarks;if(!(panel.rootId===BKM_ROOT_ID||panel.rootId===NOID)&&panel.reactive.rootOffset===0){let folder=Bookmarks.reactive.byId[panel.rootId];if(folder){let path2=Bookmarks.getPath(folder);panel.reactive.rootOffset=path2.length+1,Search.reset(panel),onBookmarksSearch(actPanel,Sidebar.subPanels.bookmarks)}}else Sidebar.closeSubPanel()}else Sidebar.openSubPanel(2,actPanel),subPanelOpenBySearch=!0;else if(Sidebar.hasBookmarks){let firstPanel,nextPanel,rootPanel;for(let p of Sidebar.panels)isBookmarksPanel(p)&&(firstPanel||(firstPanel=p),!rootPanel&&p.rootId===BKM_ROOT_ID&&(rootPanel=p),nextPanel===null&&(nextPanel=p),p.id===actPanel.id&&(nextPanel=null));if(!firstPanel)return;isBookmarksPanel(actPanel)?nextPanel?Sidebar.activatePanel(nextPanel.id,!0,!0):searchPrevPanelId!==void 0&&(Sidebar.activatePanel(searchPrevPanelId,!0,!0),searchPrevPanelId=void 0):(searchPrevPanelId=actPanel.id,Sidebar.activatePanel(firstPanel.id,!0,!0))}}function history(){if(!Search.reactive.barIsShowed)return;let actPanel=Sidebar.panelsById[Sidebar.activePanelId];isTabsPanel(actPanel)&&Settings.state.subPanelHistory?Sidebar.subPanelActive&&Sidebar.subPanelType===3?Sidebar.closeSubPanel():(Sidebar.openSubPanel(3,actPanel),subPanelOpenBySearch=!0):Sidebar.hasHistory&&(isHistoryPanel(actPanel)?searchPrevPanelId!==void 0&&(Sidebar.activatePanel(searchPrevPanelId,!0,!0),searchPrevPanelId=void 0):(searchPrevPanelId=actPanel.id,Sidebar.activatePanel("history",!0,!0)))}function selectAll(){if(!Search.reactive.barIsShowed||Menu.isOpen)return;let actPanel=Sidebar.panelsById[Sidebar.activePanelId];actPanel&&(isTabsPanel(actPanel)?Sidebar.subPanelActive?Sidebar.subPanelType===2&&Sidebar.subPanels.bookmarks&&onBookmarksSearchSelectAll(Sidebar.subPanels.bookmarks):onTabsSearchSelectAll(actPanel):isBookmarksPanel(actPanel)&&onBookmarksSearchSelectAll(actPanel))}function getMenuCoordinates(type){let sRect=document.getElementById("search_bar")?.getBoundingClientRect(),sx=sRect?.left??16,sy=(sRect?.bottom??16)+2,firstSelectedId=Selection.getFirst(),rect;if(type===1)rect=document.getElementById(`tab${firstSelectedId}`)?.getBoundingClientRect();else if(type===2){let id=`bookmark${Sidebar.activePanelId}${firstSelectedId}`;rect=document.getElementById(id)?.getBoundingClientRect()}else type===3&&(rect=document.getElementById(`history${firstSelectedId}`)?.getBoundingClientRect());return rect?[rect.left+2,rect.bottom+2]:[sx,sy]}function menu(){if(!Search.reactive.barIsShowed)return;if(Menu.isOpen)return Menu.close();let actPanel=Sidebar.panelsById[Sidebar.activePanelId];if(actPanel){if(isTabsPanel(actPanel))if(Sidebar.subPanelActive){if(Sidebar.subPanelType===2&&Sidebar.subPanels.bookmarks){let[x,y]=getMenuCoordinates(2);Menu.open(2,x,y,!0)}else if(Sidebar.subPanelType===3){let[x,y]=getMenuCoordinates(3);Menu.open(3,x,y,!0)}}else{let[x,y]=getMenuCoordinates(1);Menu.open(1,x,y,!0)}else if(isBookmarksPanel(actPanel)){let[x,y]=getMenuCoordinates(2);Menu.open(2,x,y,!0)}else if(isHistoryPanel(actPanel)){let[x,y]=getMenuCoordinates(3);Menu.open(3,x,y,!0)}}}var searchTimeout;function searchDebounced(delay,value,noSel){clearTimeout(searchTimeout),searchTimeout=setTimeout(()=>search(value,noSel),delay)}var query="",beforeSwitchingPanelId;function search(value,noSel){if(value!==void 0){if(value.length<MIN_SEARCH_QUERY_LEN&&(value=""),Search.reactive.value===value)return;Search.prevValue=Search.reactive.value,Search.reactive.value=value,query=value.toLowerCase()}if(Menu.isOpen&&Menu.close(),query.startsWith(". ")){let val=query.slice(2);if(!val)return;let panel=Sidebar.panels.find(p=>p.name.toLowerCase().includes(val));panel&&panel.id!==Sidebar.activePanelId&&(beforeSwitchingPanelId===void 0&&(beforeSwitchingPanelId=Sidebar.activePanelId),Sidebar.activatePanel(panel.id));return}let actPanel=Sidebar.panelsById[Sidebar.activePanelId];if(!actPanel)return;let targetPanelId=actPanel.id;if(isTabsPanel(actPanel)?Sidebar.subPanelActive?Sidebar.subPanelType===2&&Sidebar.subPanels.bookmarks?(targetPanelId=Sidebar.subPanels.bookmarks.id,onBookmarksSearch(actPanel,Sidebar.subPanels.bookmarks,noSel)):Sidebar.subPanelType===3&&(targetPanelId=NOID,onHistorySearch(noSel)):onTabsSearch(actPanel,noSel):isBookmarksPanel(actPanel)?onBookmarksSearch(actPanel,void 0,noSel):isHistoryPanel(actPanel)&&(targetPanelId=NOID,onHistorySearch(noSel)),value===""){for(let panel of Sidebar.panels)panel.id!==targetPanelId&&reset(panel);if(Search.prevExpandedBookmarks&&(Bookmarks.reactive.expanded=Search.prevExpandedBookmarks,Search.prevExpandedBookmarks=void 0),Sidebar.subPanels.bookmarks&&Sidebar.subPanels.bookmarks.id!==targetPanelId&&reset(Sidebar.subPanels.bookmarks),targetPanelId!==NOID&&(History.filtered=void 0,History.reactive.days=History.recalcDays()),beforeSwitchingPanelId!==void 0){let panel=Sidebar.panelsById[beforeSwitchingPanelId];panel&&Sidebar.activatePanel(panel.id),beforeSwitchingPanelId=void 0}}}function reset(panel){if(isTabsPanel(panel)){let wasFiltered=panel.filteredTabs!==void 0;panel.reactive.filteredLen=panel.filteredTabs=void 0,wasFiltered&&Sidebar.recalcVisibleTabs(panel.id)}else isBookmarksPanel(panel)&&(panel.reactive.filteredBookmarks=void 0,panel.reactive.filteredLen=void 0)}function stop(){searchPrevPanelId!==void 0&&(Sidebar.activatePanel(searchPrevPanelId,!0,!0),searchPrevPanelId=void 0),Settings.state.searchBarMode==="dynamic"&&Search.hideBar(),Search.reactive.rawValue=Search.rawValue="",Search.search(""),subPanelOpenBySearch=!1,blur()}function check(str){return str===void 0?!1:(str=str.toLowerCase(),str.includes(query))}var inputEl;function registerInputEl(el){inputEl=el}function focus(){inputEl&&inputEl.focus({preventScroll:!0})}function blur(){inputEl&&inputEl.blur()}function toggleBar(){Search.reactive.barIsShowed?Search.rawValue?stop():hideBar():showBar()}function showBar(){Settings.state.searchBarMode!=="none"&&(Search.reactive.barIsShowed=!0,focus())}function hideBar(){if(sendToSearchPopup(Windows.id,"closePopup"),Settings.state.searchBarMode!=="static"&&(Search.reactive.barIsShowed=!1),Menu.isOpen)return Menu.close()}function start(){if(Settings.state.searchBarMode==="none")return;document.hasFocus()||(browser.browserAction.setPopup({popup:SEARCH_URL}),browser.browserAction.openPopup(),Search.reactive.barIsActive=!0,setTimeout(()=>browser.browserAction.setPopup({popup:null}),500)),showBar()}function close(){Search.reactive.barIsActive=!1,Search.reactive.rawValue=Search.rawValue="",Search.search(""),hideBar(),subPanelOpenBySearch=!1}function parseShortcuts(){Settings.state.searchBookmarksShortcut?Search.shortcuts.bookmarks=parseShortcut(Settings.state.searchBookmarksShortcut):Search.shortcuts.bookmarks=void 0,Settings.state.searchHistoryShortcut?Search.shortcuts.history=parseShortcut(Settings.state.searchHistoryShortcut):Search.shortcuts.history=void 0}function parseShortcut(shortcut){let parts=shortcut.trim().toLowerCase().split("+").map(p=>p),alt=!1,ctrl=!1,meta=!1,key="";for(let part of parts){let trimmed=part.trim();trimmed==="alt"?alt=!0:trimmed==="ctrl"?ctrl=!0:trimmed==="meta"||trimmed==="win"||trimmed==="cmd"?meta=!0:trimmed.length===1&&(key=trimmed)}if(key)return{alt,ctrl,meta,key}}function getSearchQuery(){return Search.rawValue}var Search={reactive:{barIsShowed:!1,barIsActive:!1,barIsFocused:!1,value:"",rawValue:""},rawValue:"",prevValue:"",prevExpandedBookmarks:void 0,shortcuts:{},...search_actions_exports};var UNLIMITED=1234567,INITIAL_COUNT=100,LOAD_RANGE=432e6,lastItemTime=0,reactFn3;function initHistory(react){reactFn3=react,History.reactive=reactFn3(History.reactive)}function createVisit(nItem,nVisit,itemDomain,itemDecodedUrl){if(!nItem.url||nItem.lastVisitTime===void 0||nVisit&&nVisit.visitTime===void 0)return;let time=nVisit?.visitTime??nItem.lastVisitTime,dt=new Date(time),dtday=`${dt.getDate()}`.padStart(2,"0"),dtmth=`${dt.getMonth()+1}`.padStart(2,"0"),dayId=`${dt.getFullYear()}.${dtmth}.${dtday}`,h=dt.getHours().toString(),m=dt.getMinutes().toString(),timeStr=`${h.padStart(2,"0")}:${m.padStart(2,"0")}`,domain;itemDomain?domain=itemDomain:domain=getDomainOf(nItem.url);let decodedUrl;if(itemDecodedUrl)decodedUrl=itemDecodedUrl;else try{decodedUrl=decodeURI(nItem.url)}catch{decodedUrl=nItem.url}let title=nItem.title||domain,tooltip=title+`
---
`+decodedUrl,visit={id:(nVisit?.visitId??nItem.id)+time.toString(36),dayId,url:nItem.url,decodedUrl,domain,title,noTitle:!nItem.title,time,timeStr,tooltip,reactive:{title,tooltip,sel:!1}};return reactFn3&&(visit.reactive=reactFn3(visit.reactive)),visit}async function load(){if(!browser.history)return;History.ready=!1,History.reactive.loading=!0;let endTime=Date.now(),startTime=endTime-LOAD_RANGE,result=await browser.history.search({text:"",endTime,startTime,maxResults:INITIAL_COUNT}),lastItemVisitTime=result[result.length-1]?.lastVisitTime,visits=await normalizeHistory(result,!0,lastItemVisitTime);lastItemTime=getLastVisitTime(visits)-1,visits.length?History.visits=visits:await loadMore(),History.reactive.days=History.recalcDays(),History.setupListeners();let historyPanel=Sidebar.panelsById.history;historyPanel&&(historyPanel.reactive.ready=historyPanel.ready=!0),History.ready=!0,History.reactive.loading=!1}function unload(){History.reactive.loading=!1,History.reactive.days=[],History.ready=!1,History.allLoaded=!1,History.visits=[],History.byId={};let historyPanel=Sidebar.panelsById.history;historyPanel&&(historyPanel.reactive.ready=historyPanel.ready=!1),History.resetListeners(),cachedVisits={}}function getDayTitle(time,dayStartTime){return time===void 0?"???":(dayStartTime||(dayStartTime=getDayStartMS()),uDate(time,".",dayStartTime))}function recalcDays(){let days=[],dayStart=getDayStartMS(),day,lastDayId="",prevVisit,visits=History.filtered??History.visits;for(let visit of visits){if(visit.noTitle)continue;(lastDayId!==visit.dayId||!day)&&(lastDayId=visit.dayId,day={id:lastDayId,title:getDayTitle(visit.time,dayStart),visits:[]},days.push(day),prevVisit=void 0),visit.reactive.moreVisits=void 0;let vTitle=visit.title,pvTitle=prevVisit?.title;if(prevVisit&&pvTitle&&vTitle.length===pvTitle.length&&vTitle===pvTitle){prevVisit.reactive.moreVisits?prevVisit.reactive.moreVisits.push(visit.id):prevVisit.reactive.moreVisits=[visit.id];continue}prevVisit=visit,day.visits.push(visit.id)}return days}function recalcToday(){let days=[],dayStart=getDayStartMS(),day,lastDayId="",prevVisit,visits=History.filtered??History.visits;for(let visit of visits){if(visit.noTitle)continue;if(!day)lastDayId=visit.dayId,day={id:lastDayId,title:getDayTitle(visit.time,dayStart),visits:[]},days.push(day),prevVisit=void 0;else if(lastDayId!==visit.dayId)break;visit.reactive.moreVisits=void 0;let vTitle=visit.title,pvTitle=prevVisit?.title;if(prevVisit&&pvTitle&&vTitle.length===pvTitle.length&&vTitle===pvTitle){prevVisit.reactive.moreVisits?prevVisit.reactive.moreVisits.push(visit.id):prevVisit.reactive.moreVisits=[visit.id];continue}prevVisit=visit,day.visits.push(visit.id)}day&&(History.reactive.days[0]=day)}var unloadAfterTimeout;function unloadAfter(delay){clearTimeout(unloadAfterTimeout),unloadAfterTimeout=setTimeout(()=>{let historyPanel=Sidebar.panelsById.history;historyPanel&&Sidebar.activePanelId===historyPanel.id||historyPanel&&!historyPanel.ready||Sidebar.subPanelActive&&Sidebar.subPanelType===3||History.unload()},delay)}var cachedVisits={};async function normalizeHistory(items,allVisits,after,before,noTitleless){let normalized=[];for(let item of items){if(!item.url)continue;let iVisit=createVisit(item),domain=iVisit?.domain,decodedUrl=iVisit?.decodedUrl;if(allVisits&&item.visitCount!==void 0&&item.visitCount>1&&item.url){let visits=cachedVisits[item.url];visits||(visits=await browser.history.getVisits({url:item.url}),cachedVisits[item.url]=visits);for(let visit of visits){let vVisit=createVisit(item,visit,domain,decodedUrl);vVisit&&(noTitleless&&vVisit.noTitle||after!==void 0&&vVisit.time<after||before!==void 0&&vVisit.time>before||(normalized.push(vVisit),History.byId[vVisit.id]=vVisit))}}else{if(!iVisit||noTitleless&&iVisit.noTitle||after!==void 0&&iVisit.time<after||before!==void 0&&iVisit.time>before)continue;normalized.push(iVisit),History.byId[iVisit.id]=iVisit}}return normalized.sort((a,b)=>b.time-a.time),normalized}async function loadMore(){if(History.allLoaded)return;let before=lastItemTime,after=lastItemTime-LOAD_RANGE,result=await browser.history.search({text:"",maxResults:UNLIMITED,startTime:after,endTime:before});if(result.length){let newVisits=await normalizeHistory(result,!0,after,before);if(newVisits.length){History.visits.push(...newVisits),History.reactive.days=History.recalcDays(),lastItemTime=getLastVisitTime()-1;return}}if(result=await browser.history.search({text:"",maxResults:100,startTime:0,endTime:before}),result.length){let oldestTime=result[result.length-1]?.lastVisitTime??0,newVisits=await normalizeHistory(result,!0,oldestTime,before);if(newVisits.length){History.visits.push(...newVisits),History.reactive.days=History.recalcDays(),lastItemTime=getLastVisitTime()-1;return}}History.allLoaded=!0}function getLastVisitTime(list){list||(list=History.visits);let lastVisit=list[list.length-1];return lastVisit?lastVisit.time:Date.now()}function onVisit(item){let visit=createVisit(item);if(!visit)return;let firstVisit=History.visits[0],sortNeeded=!!firstVisit&&firstVisit.time>visit.time;if(History.visits.unshift(visit),History.byId[visit.id]=visit,sortNeeded&&History.visits.sort((a,b)=>b.time-a.time),!(visit.noTitle||Search.rawValue))if(sortNeeded)History.reactive.days=History.recalcDays();else{let day=History.reactive.days.find(day2=>day2.id===visit.dayId);day?day.visits.unshift(visit.id):History.reactive.days=History.recalcDays()}}function onRemoved(info2){if(info2.allHistory)History.visits=[],cachedVisits={};else for(let url of info2.urls)History.visits=History.visits.filter(v=>v.url!==url),cachedVisits[url]=[];Search.rawValue||(History.reactive.days=History.recalcDays())}function onTitleChange(info2){let visit=History.visits.find(v=>v.id.startsWith(info2.id));visit&&(visit.reactive.title=visit.title=info2.title,visit.reactive.tooltip=visit.tooltip=visit.title+`
---
`+visit.decodedUrl,visit.noTitle&&(visit.noTitle=!1,Search.rawValue||recalcToday()))}function setupListeners2(){browser.history&&(browser.history.onVisited.addListener(onVisit),browser.history.onVisitRemoved.addListener(onRemoved),browser.history.onTitleChanged.addListener(onTitleChange))}function resetListeners(){browser.history&&(browser.history.onVisited.removeListener(onVisit),browser.history.onVisitRemoved.removeListener(onRemoved),browser.history.onTitleChanged.removeListener(onTitleChange))}var scrollConf={behavior:"smooth",top:0};function scrollToHistoryItem(id){let elId="history"+id,el=document.getElementById(elId),bodyEl=el?.firstElementChild;if(!el||!bodyEl)return;let scrollEl;if(Sidebar.subPanelActive?scrollEl=History.subPanelScrollEl:scrollEl=History.panelScrollEl,!scrollEl)return;let sR=scrollEl.getBoundingClientRect(),bR=el.getBoundingClientRect(),pH=scrollEl.offsetHeight,pS=scrollEl.scrollTop,bH=bodyEl.offsetHeight,bY=bR.top-sR.top+pS;if(bY<pS+PRE_SCROLL){if(pS>0){let y=bY-PRE_SCROLL;y<0&&(y=0),scrollConf.top=y,scrollEl.scroll(scrollConf)}}else bY+bH>pS+pH-PRE_SCROLL&&(scrollConf.top=bY+bH-pH+PRE_SCROLL,scrollEl.scroll(scrollConf))}var scrollToHistoryItemDebounced=debounce(scrollToHistoryItem);async function open2(visit,dst,useActiveTab,activateFirstTab){if(!visit.url)return;if(useActiveTab){browser.tabs.update({url:normalizeUrl(visit.url,visit.title)});return}let tabInfo={id:0,url:visit.url,title:visit.title,active:activateFirstTab},dstInfo={windowId:Windows.id,discarded:!1,panelId:dst.panelId},panel=Sidebar.panelsById[dstInfo.panelId??NOID];isTabsPanel(panel)&&(dstInfo.panelId=panel.id,dstInfo.containerId=Containers.getContainerFor(visit.url),!dstInfo.containerId&&Containers.reactive.byId[panel.newTabCtx]&&(dstInfo.containerId=panel.newTabCtx),dst.index!==void 0&&(dstInfo.index=dst.index),await Tabs2.open([tabInfo],dstInfo))}async function copyUrls(ids){if(!Permissions.reactive.clipboardWrite&&!await Permissions.request("clipboardWrite"))return;let urls="";for(let id of ids){let visit=History.visits.find(i=>i.id===id);visit&&visit.url&&(urls+=`
`+visit.url)}let resultString=urls.trim();resultString&&navigator.clipboard.writeText(resultString)}async function copyTitles(ids){if(!Permissions.reactive.clipboardWrite&&!await Permissions.request("clipboardWrite"))return;let titles="";for(let id of ids){let visit=History.visits.find(i=>i.id===id);visit&&visit.title&&(titles+=`
`+visit.title)}let resultString=titles.trim();resultString&&navigator.clipboard.writeText(resultString)}function deleteVisits(ids){for(let id of ids){let list=History.filtered??History.visits,vIndex=list.findIndex(i=>i.id===id),visit=list[vIndex];if(!visit||!visit.time)continue;let ts=visit.time;if(visit.url){let cached=cachedVisits[visit.url];if(cached){let index=cached.findIndex(ci=>ci.visitTime===ts);index!==-1&&cached.splice(index,1)}}browser.history.deleteRange({startTime:ts,endTime:ts+1}),list.splice(vIndex,1),delete History.byId[id]}History.reactive.days=History.recalcDays()}async function deleteSites(ids){History.reactive.loading=!0,History.resetListeners();let stopDeletion=!1,progressNotification=Notifications.progress({icon:"#icon_trash",title:translate("notif.history_del_sites"),progress:{percent:-1},unconcealed:!0,ctrl:translate("btn.stop"),callback:()=>{stopDeletion=!0}}),sites=new Set;for(let id of ids){let list=History.filtered??History.visits,vIndex=list.findIndex(i=>i.id===id),visit=list[vIndex];if(!visit||!visit.url)continue;let reResult=SITE_URL_RE.exec(visit.url);reResult?.[1]&&sites.add(reResult[1])}let items=[];for(let url of sites){delete cachedVisits[url];try{let filteredResults=(await browser.history.search({text:url,maxResults:999999,startTime:0})).filter(i=>i.url?.startsWith(url)),visits=await History.normalizeHistory(filteredResults,!1);items.push(...visits)}catch{warn("History.deleteSites: Cannot get visits to remove")}}if(items.length===0){Notifications.finishProgress(progressNotification,0),Notifications.notify({icon:"#icon_clock",title:translate("notif.history_del_sites_nothing")}),History.reactive.loading=!1;return}let initialCount=items.length+1,count=1;Notifications.updateProgress(progressNotification,count,initialCount),progressNotification.detailsList=[];let detailsList=progressNotification.detailsList;for(let item of items){if(stopDeletion)break;if(Notifications.updateProgress(progressNotification,++count,initialCount),!!item.url){detailsList[0]=item.url;try{await browser.history.deleteUrl({url:item.url})}catch{warn(`History.deleteSites: Cannot delete url: ${item.url}`);continue}}}History.unload(),await History.load(),Notifications.finishProgress(progressNotification,0)}function getMouseOpeningConf(button){let conf={dst:{},useActiveTab:!1,activateFirstTab:!1};if(button===0){let panelId=Sidebar.getRecentTabsPanelId(),panel=Sidebar.panelsById[panelId];if(conf.useActiveTab=Settings.state.historyLeftClickAction==="open_in_act",conf.activateFirstTab=Settings.state.historyLeftClickActivate,conf.dst.panelId=panelId,!conf.useActiveTab&&Settings.state.historyLeftClickPos==="after"){let activeTab=Tabs2.byId[Tabs2.activeId];activeTab&&!activeTab.pinned&&activeTab.panelId===panelId&&(conf.dst.index=activeTab.index+1,conf.dst.parentId=activeTab.parentId)}else isTabsPanel(panel)&&(conf.dst.index=Tabs2.getIndexForNewTab(panel))}else if(button===1){let panelId=Sidebar.getRecentTabsPanelId(),panel=Sidebar.panelsById[panelId];if(conf.activateFirstTab=Settings.state.historyMidClickActivate,conf.dst.panelId=panelId,Settings.state.historyMidClickPos==="after"){let activeTab=Tabs2.byId[Tabs2.activeId];activeTab&&!activeTab.pinned&&activeTab.panelId===panelId&&(conf.dst.index=activeTab.index+1,conf.dst.parentId=activeTab.parentId)}else isTabsPanel(panel)&&(conf.dst.index=Tabs2.getIndexForNewTab(panel))}return conf}var History={reactive:{days:[],loading:!1},visits:[],filtered:void 0,byId:{},ready:!1,allLoaded:!1,panelScrollEl:null,subPanelScrollEl:null,...history_actions_exports};async function loadPermissions(){let perms=await Promise.all([browser.permissions.contains({origins:["<all_urls>"]}),browser.permissions.contains({permissions:["webRequest"]}),browser.permissions.contains({permissions:["webRequestBlocking"]}),browser.permissions.contains({permissions:["proxy"]}),browser.permissions.contains({permissions:["tabHide"]}),browser.permissions.contains({permissions:["clipboardWrite"]}),browser.permissions.contains({permissions:["history"]}),browser.permissions.contains({permissions:["bookmarks"]}),browser.permissions.contains({permissions:["downloads"]})]);Permissions.allUrls=perms[0],Permissions.webRequest=perms[1],Permissions.webRequestBlocking=perms[2],Permissions.proxy=perms[3],Permissions.tabHide=perms[4],Permissions.clipboardWrite=perms[5],Permissions.history=perms[6],Permissions.bookmarks=perms[7],Permissions.downloads=perms[8],Permissions.reactive.webData=Permissions.allUrls&&Permissions.webRequest&&Permissions.webRequestBlocking&&Permissions.proxy,Permissions.reactive.tabHide=Permissions.tabHide,Permissions.reactive.clipboardWrite=Permissions.clipboardWrite,Permissions.reactive.history=Permissions.history,Permissions.reactive.bookmarks=Permissions.bookmarks,Permissions.reactive.downloads=Permissions.downloads,Permissions.reactive.webData||onRemovedWebData(),Permissions.tabHide||onRemovedTabHide(),Permissions.history||onRemovedHistory(),Permissions.bookmarks||onRemovedBookmarks(),Permissions.downloads||onRemovedDownloads()}async function request(...perms){try{let origins=[],permissions=[];return perms.includes("<all_urls>")&&(origins.push("<all_urls>"),permissions.push("webRequest","webRequestBlocking","proxy"),rmFromArray(perms,"<all_urls>")),permissions.push(...perms),await browser.permissions.request({origins,permissions})}catch{return perms.includes("<all_urls>")?SetupPage.open("all-urls"):perms.includes("tabHide")?SetupPage.open("tab-hide"):perms.includes("history")?SetupPage.open("history"):perms.includes("bookmarks")?SetupPage.open("bookmarks"):perms.includes("clipboardWrite")?SetupPage.open("clipboard-write"):perms.includes("downloads")&&SetupPage.open("downloads"),!1}}function onAdded(info2){info2.origins?.includes("<all_urls>")&&(Permissions.allUrls=!0),info2.permissions?.includes("webRequest")&&(Permissions.webRequest=!0),info2.permissions?.includes("webRequestBlocking")&&(Permissions.webRequestBlocking=!0),info2.permissions?.includes("proxy")&&(Permissions.proxy=!0),Permissions.reactive.webData=Permissions.allUrls&&Permissions.webRequest&&Permissions.webRequestBlocking&&Permissions.proxy,info2.permissions?.includes("tabHide")&&(Permissions.tabHide=!0,Permissions.reactive.tabHide=!0),info2.permissions?.includes("clipboardWrite")&&(Permissions.clipboardWrite=!0,Permissions.reactive.clipboardWrite=!0),info2.permissions?.includes("history")&&(Permissions.history=!0,Permissions.reactive.history=!0,onAddedHistory()),info2.permissions?.includes("bookmarks")&&(Permissions.bookmarks=!0,Permissions.reactive.bookmarks=!0,onAddedBookmarks()),info2.permissions?.includes("downloads")&&(Permissions.downloads=!0,Permissions.reactive.downloads=!0)}function onRemoved2(info2){let webDataRemoved;info2.origins?.includes("<all_urls>")&&(Permissions.allUrls=!1,webDataRemoved=!0),info2.permissions?.includes("webRequest")&&(Permissions.webRequest=!1,webDataRemoved=!0),info2.permissions?.includes("webRequestBlocking")&&(Permissions.webRequestBlocking=!1,webDataRemoved=!0),info2.permissions?.includes("proxy")&&(Permissions.proxy=!1,webDataRemoved=!0),webDataRemoved&&(Permissions.reactive.webData=!1,onRemovedWebData()),info2.permissions?.includes("tabHide")&&(Permissions.tabHide=!1,Permissions.reactive.tabHide=!1,onRemovedTabHide()),info2.permissions?.includes("clipboardWrite")&&(Permissions.clipboardWrite=!1,Permissions.reactive.clipboardWrite=!1),info2.permissions?.includes("history")&&(Permissions.history=!1,Permissions.reactive.history=!1,onRemovedHistory()),info2.permissions?.includes("bookmarks")&&(Permissions.bookmarks=!1,Permissions.reactive.bookmarks=!1,onRemovedBookmarks()),info2.permissions?.includes("downloads")&&(Permissions.downloads=!1,Permissions.reactive.downloads=!1,onRemovedDownloads())}function setupListeners3(){browser.permissions.onAdded.addListener(onAdded),browser.permissions.onRemoved.addListener(onRemoved2)}function resetListeners2(){browser.permissions.onAdded.removeListener(onAdded),browser.permissions.onRemoved.removeListener(onRemoved2)}function onRemovedWebData(){Info.isBg?onRemovedWebDataBg():onRemovedWebDataFg()}function onRemovedWebDataBg(){let containersSaveNeeded=!1,settingsSaveNeeded=!1;for(let c of Object.values(Containers.reactive.byId))c.proxified&&(c.proxified=!1,containersSaveNeeded=!0),c.proxy&&c.proxy.type!=="direct"&&(c.proxy.type="direct",containersSaveNeeded=!0),c.reopenRulesActive&&(c.reopenRulesActive=!1,containersSaveNeeded=!0),c.userAgentActive&&(c.userAgentActive=!1,containersSaveNeeded=!0);Settings.state.selWinScreenshots&&(Settings.state.selWinScreenshots=!1,settingsSaveNeeded=!0),Settings.state.newTabCtxReopen&&(Settings.state.newTabCtxReopen=!1,settingsSaveNeeded=!0),Settings.state.previewTabs&&(Settings.state.previewTabs=!1,settingsSaveNeeded=!0),containersSaveNeeded&&Store.set({containers:cloneObject(Containers.reactive.byId)}),settingsSaveNeeded&&Settings.saveSettings()}function onRemovedWebDataFg(){if(Info.isSetup){for(let c of Object.values(Containers.reactive.byId))c.proxified&&(c.proxified=!1),c.proxy&&(c.proxy.type="direct"),c.reopenRulesActive&&(c.reopenRulesActive=!1),c.userAgentActive&&(c.userAgentActive=!1);Settings.state.selWinScreenshots&&(Settings.state.selWinScreenshots=!1),Settings.state.newTabCtxReopen&&(Settings.state.newTabCtxReopen=!1)}}function onRemovedTabHide(){Info.isBg?onRemovedTabHideBg():onRemovedTabHideFg()}function onRemovedTabHideBg(){let saveNeeded=!1;Settings.state.hideInact&&(Settings.state.hideInact=!1,saveNeeded=!0),Settings.state.hideFoldedTabs&&(Settings.state.hideFoldedTabs=!1,saveNeeded=!0),saveNeeded&&Settings.saveSettings()}function onRemovedTabHideFg(){Info.isSetup&&(Settings.state.hideInact=!1,Settings.state.hideFoldedTabs=!1)}function onAddedHistory(){Info.isBg||onAddedHistoryFg()}function onAddedHistoryFg(){if(Info.isSidebar){if(!Sidebar.hasHistory)return;let panel=Sidebar.panelsById.history;if(!panel)return;!panel.ready&&Sidebar.activePanelId==="history"&&History.load()}}function onRemovedHistory(){Info.isBg||onRemovedHistoryFg()}function onRemovedHistoryFg(){Info.isSidebar&&History.ready&&History.unload()}function onAddedBookmarks(){Info.isBg||onAddedBookmarksFg()}function onAddedBookmarksFg(){if(Info.isSidebar){if(!Sidebar.hasBookmarks)return;let panel=Sidebar.panels.find(p=>isBookmarksPanel(p));if(!panel)return;let actPanel=Sidebar.panelsById[Sidebar.activePanelId];!panel.ready&&isBookmarksPanel(actPanel)&&Bookmarks.load()}}function onRemovedBookmarks(){Info.isBg||onRemovedBookmarksFg()}function onRemovedBookmarksFg(){Info.isSidebar&&Bookmarks.unload()}function onRemovedDownloads(){Info.isBg?onRemovedDownloadsBg():onRemovedDownloadsFg()}function onRemovedDownloadsBg(){let saveNeeded=!1;Settings.state.snapAutoExport&&(Settings.state.snapAutoExport=!1,saveNeeded=!0),saveNeeded&&Settings.saveSettings()}function onRemovedDownloadsFg(){Info.isSetup&&(Settings.state.snapAutoExport=!1)}var Permissions={reactive:{webData:!1,bookmarks:!1,tabHide:!1,clipboardWrite:!1,history:!1,downloads:!1},allUrls:!1,webRequest:!1,webRequestBlocking:!1,proxy:!1,bookmarks:!1,tabHide:!1,clipboardWrite:!1,history:!1,downloads:!1,...permissions_actions_exports};var URL_WITHOUT_PROTOCOL_RE=/^(.+\.)\/?(.+\/)?\w+/,reactFn4;function initTabs(react){reactFn4=react,Tabs2.reactive=reactFn4(Tabs2.reactive)}function mutateNativeTabToSideberyTab(nativeTab){let tab=nativeTab;return tab.isParent===void 0&&(tab.isParent=!1),tab.folded===void 0&&(tab.folded=!1),tab.invisible===void 0&&(tab.invisible=!1),tab.parentId===void 0&&(tab.parentId=NOID),tab.panelId===void 0&&(tab.panelId=NOID),tab.prevPanelId===void 0&&(tab.prevPanelId=NOID),tab.dstPanelId===void 0&&(tab.dstPanelId=NOID),tab.relGroupId===void 0&&(tab.relGroupId=NOID),tab.lvl===void 0&&(tab.lvl=0),tab.sel===void 0&&(tab.sel=!1),tab.updated===void 0&&(tab.updated=!1),tab.loading===void 0&&(tab.loading=!1),tab.status===void 0&&(tab.status="complete"),tab.warn===void 0&&(tab.warn=!1),tab.internal===void 0&&(tab.internal=tab.url.startsWith(ADDON_HOST)),tab.internal?tab.favIconUrl=void 0:(tab.favIconUrl==="chrome://global/skin/icons/warning.svg"&&(tab.warn=!0),(tab.favIconUrl===void 0||tab.favIconUrl.startsWith("chrome:"))&&(tab.favIconUrl=void 0)),tab.mediaPaused===void 0&&(tab.mediaPaused=!1),tab.isGroup===void 0&&(tab.isGroup=tab.internal&&isGroupUrl(tab.url)),tab.reactive===void 0&&(tab.reactive={active:tab.active,mediaAudible:tab.audible??!1,mediaMuted:tab.mutedInfo?.muted??!1,mediaPaused:tab.mediaPaused,containerColor:Containers.reactive.byId[tab.cookieStoreId]?.color??null,discarded:tab.discarded??!1,favIconUrl:tab.favIconUrl,pinned:tab.pinned,status:Tabs2.getStatus(tab),isParent:tab.isParent,folded:tab.folded,title:tab.title,tooltip:Settings.state.previewTabs?"":getTooltip(tab),customTitle:tab.customTitle??null,customTitleEdit:!1,customColor:tab.customColor??null,url:tab.url,lvl:tab.lvl,branchLen:0,sel:tab.sel,warn:tab.warn,updated:tab.updated,unread:!!tab.unread,flash:!1,branchColor:null,color:null,isGroup:tab.isGroup,preview:!1}),tab}function reactivateTab(tab){!tab.reactive||!reactFn4||(tab.reactive=reactFn4(tab.reactive))}function createReactiveProps(tab){let rProps={active:tab.active,mediaAudible:tab.audible??!1,mediaMuted:tab.mutedInfo?.muted??!1,mediaPaused:tab.mediaPaused,containerColor:Containers.reactive.byId[tab.cookieStoreId]?.color??null,discarded:tab.discarded??!1,favIconUrl:tab.favIconUrl,pinned:tab.pinned,status:Tabs2.getStatus(tab),isParent:tab.isParent,folded:tab.folded,title:tab.title,tooltip:Settings.state.previewTabs?"":getTooltip(tab),customTitle:tab.customTitle??null,customTitleEdit:!1,customColor:tab.customColor??null,url:tab.url,lvl:tab.lvl,branchLen:0,sel:tab.sel,warn:tab.warn,updated:tab.updated,unread:!!tab.unread,flash:!1,branchColor:null,color:null,isGroup:tab.isGroup,preview:!1};return reactFn4?reactFn4(rProps):(warn("Tabs.createReactiveProps: No reactFn"),rProps)}function getStatus(tab){return tab.status==="loading"?2:tab.status==="pending"?3:1}var waitingForTabs=[];async function waitForTabsReady(){if(!Tabs2.ready)return new Promise(ok=>{waitingForTabs.push(ok)})}async function load2(){let ts=performance.now();info("Tabs.load"),Tabs2.shadowMode&&Tabs2.unloadShadowed(),Tabs2.setupTabsListeners(),await retry({action:async again=>{try{await restoreTabsState()}catch(err3){err3===1?again():err("Tabs.load: Cannot restore tabs state",err3)}},interval:1e3,increment:500,count:5}),Tabs2.updateActiveGroupPage();let activeTab=Tabs2.byId[Tabs2.activeId];activeTab&&!activeTab.pinned&&Tabs2.scrollToTab(activeTab.id),Tabs2.updateNativeTabsVisibility(),Tabs2.cacheTabsData(1e3),Tabs2.list.forEach(t=>{Tabs2.updateUrlCounter(t.url,1),t.isGroup&&Tabs2.linkGroupWithPinnedTab(t,Tabs2.list),Tabs2.saveTabData(t.id),t.folded&&t.invisible&&Tabs2.recalcBranchLen(t.id)});for(let panel of Sidebar.panels)isTabsPanel(panel)&&(panel.ready=!0,panel.tabs.length&&Sidebar.updateMediaStateOfPanel(panel.id));Settings.state.colorizeTabs&&Tabs2.colorizeTabs(),Settings.state.colorizeTabsBranches&&Tabs2.colorizeBranches(),Tabs2.ready=!0,waitingForTabs.forEach(cb=>cb()),waitingForTabs=[],info(`Tabs.load: Done: ${performance.now()-ts}ms`)}function unload2(){Tabs2.ready=!1,Tabs2.resetTabsListeners(),Tabs2.reactive.pinnedIds=[],Tabs2.reactive.recentlyRemovedLen=0,Tabs2.recentlyRemoved=[],Tabs2.list=[],Tabs2.byId={},Tabs2.urlsInUse={},Tabs2.tabsReinitializing=!1,Tabs2.removedTabs=[],Tabs2.newTabsPosition={},Tabs2.movingTabs=[],Tabs2.attachingTabs=[],Tabs2.normTabsMoving=!1,Tabs2.activeTabsGlobal.actTabOffset=-1,Tabs2.activeTabsGlobal.actTabs=[],Tabs2.activeTabsPerPanel={},Tabs2.removingTabs=[],Tabs2.ignoreTabsEvents=!1,Tabs2.activeId=-1;for(let panel of Sidebar.panels)isTabsPanel(panel)&&(panel.tabs=[],panel.pinnedTabs=[],panel.reactive.visibleTabIds=[],panel.reactive.pinnedTabIds=[],panel.reactive.len=0,panel.reactive.empty=!0,panel.ready=!1);Tabs2.loadInShadowMode()}async function restoreTabsState(){if(!Sidebar.hasTabs)return;let ts=performance.now();info("Tabs.restoreTabsState");let results=await Promise.allSettled([browser.tabs.query({windowId:browser.windows.WINDOW_ID_CURRENT}),browser.storage.local.get("tabsDataCache"),bg("isWindowTabsLocked",Windows.id)]),nativeTabs=settledOr(results[0],[]),storage=settledOr(results[1],{}),isWindowTabsLocked2=settledOr(results[2],!1);if(isWindowTabsLocked2){if(isWindowTabsLocked2===!0)throw 1;storage.tabsDataCache=[isWindowTabsLocked2]}let tabs,tabsCache,tabsSessionData,lastPanel=Sidebar.panels.find(p=>isTabsPanel(p));if(!lastPanel)return err("Cannot load tabs: No tabs panels");if(storage.tabsDataCache&&(tabsCache=findCachedData(nativeTabs,storage.tabsDataCache)),tabsCache)tabs=restoreTabsFromCache(nativeTabs,tabsCache,lastPanel);else{let querying=nativeTabs.map(t=>browser.sessions.getTabValue(t.id,"data").catch(()=>{}));try{tabsSessionData=await Promise.all(querying)??[]}catch(err3){err("Tabs.restoreTabsState: Cannot get tabs data from session:",err3),tabsSessionData=[]}tabs=restoreTabsFromSessionData(nativeTabs,tabsSessionData,lastPanel)}Tabs2.list=tabs,Sidebar.recalcTabsPanels(),Settings.state.tabsTree&&updateTabsTree(),Sidebar.recalcVisibleTabs();let activeTab=tabs.find(t=>t.active);if(activeTab){let actTabIsGloballyPinned=activeTab.pinned&&Settings.state.pinnedTabsPosition!=="panel",currentActivePanel=Sidebar.panelsById[Sidebar.activePanelId];if(isTabsPanel(currentActivePanel)){let currentActivePanelHidden=currentActivePanel.hidden||Settings.state.hideEmptyPanels&&!currentActivePanel.reactive.len||Settings.state.hideDiscardedTabPanels&&currentActivePanel.allDiscarded,targetPanel;if(!actTabIsGloballyPinned)targetPanel=Sidebar.panelsById[activeTab.panelId];else if(currentActivePanelHidden||Sidebar.activePanelId===NOID){let panelId=tabs.find(t=>!t.pinned)?.panelId;panelId&&(targetPanel=Sidebar.panelsById[panelId])}targetPanel&&targetPanel.id!==Sidebar.activePanelId&&Sidebar.activatePanel(targetPanel.id,!1)}Tabs2.activeId=activeTab.id,Tabs2.updateSuccessionDebounced(0)}Tabs2.deferredEventHandling.length&&warn("Tabs: Deferred event handlers:",Tabs2.deferredEventHandling.length),Tabs2.deferredEventHandling.forEach(cb=>cb()),Tabs2.deferredEventHandling=[],info(`Tabs.restoreTabsState: Done: ${performance.now()-ts}ms`)}function restoreTabsFromCache(nativeTabs,cache,lastPanel){info("Tabs.restoreTabsFromCache");let logWrongPanels,firstPanelId=lastPanel.id,idsMap={},tabs=[];Tabs2.byId={};for(let nativeTab of[...nativeTabs]){let data=cache[nativeTab.id],tab=mutateNativeTabToSideberyTab(nativeTab);if(tab.pinned&&(tab.panelId=firstPanelId),data){data.parentId===void 0&&(data.parentId=NOID),tab.panelId=data.panelId??lastPanel.id;let actualParentId=idsMap[data.parentId];actualParentId!==void 0&&(tab.parentId=actualParentId),tab.reactive.folded=tab.folded=!!data.folded,data.customTitle&&(tab.reactive.customTitle=tab.customTitle=data.customTitle),data.customColor&&(tab.reactive.customColor=tab.customColor=data.customColor),idsMap[data.id]=tab.id}let panel=Sidebar.panelsById[tab.panelId];panel?tab.pinned||(panel.index<lastPanel.index?tab.panelId=lastPanel.id:lastPanel=panel):(logWrongPanels||(logWrongPanels={}),logWrongPanels[tab.panelId]=null,tab.panelId=lastPanel.id),tab.parentId===-1&&tab.openerTabId!==void 0&&Tabs2.byId[tab.openerTabId]&&(tab.parentId=tab.openerTabId),Tabs2.reactivateTab(tab),Tabs2.byId[tab.id]=tab,tabs.push(tab)}return logWrongPanels&&warn("Tabs loading: Cannot find panels: "+Object.keys(logWrongPanels).join(" ")),tabs}function restoreTabsFromSessionData(nativeTabs,tabsData,lastPanel){info("Tabs.restoreTabsFromSessionData");let logWrongPanels,firstPanelId=lastPanel.id,idsMap={},tabs=[];Tabs2.byId={};for(let data,nativeTab,i=0;i<nativeTabs.length;i++){if(nativeTab=nativeTabs[i],!nativeTab){err("Tabs.restoreTabsFromSessionData: No tab");break}data=tabsData[i];let tab=mutateNativeTabToSideberyTab(nativeTab);if(tab.pinned&&(tab.panelId=firstPanelId),data){data.parentId===void 0&&(data.parentId=NOID),tab.panelId=data.panelId??lastPanel.id;let actualParentId=idsMap[data.parentId];actualParentId!==void 0&&(tab.parentId=actualParentId),tab.reactive.folded=tab.folded=!!data.folded,data.customTitle&&(tab.reactive.customTitle=tab.customTitle=data.customTitle),data.customColor&&(tab.reactive.customColor=tab.customColor=data.customColor),idsMap[data.id]=tab.id}let panel=Sidebar.panelsById[tab.panelId];panel?tab.pinned||(panel.index<lastPanel.index?tab.panelId=lastPanel.id:lastPanel=panel):(logWrongPanels||(logWrongPanels={}),logWrongPanels[tab.panelId]=null,tab.panelId=lastPanel.id),tab.parentId===-1&&tab.openerTabId!==void 0&&Tabs2.byId[tab.openerTabId]&&(tab.parentId=tab.openerTabId),Tabs2.reactivateTab(tab),Tabs2.byId[tab.id]=tab,tabs.push(tab)}return logWrongPanels&&warn("Tabs loading: Cannot find panels: "+Object.keys(logWrongPanels).join(" ")),tabs}function findCachedData(tabs,data){let maxEqualityCounter=1,result;if(Windows.uniqWinId&&Windows.uniqWinId!==NOID){let winTabsCache=data.find(winTabs=>winTabs[0]?.uniqWinId===Windows.uniqWinId);winTabsCache&&(data=[winTabsCache])}for(let winTabs of data){let equalityCounter=0,existedTabs={},dataIndex=0,tabIndex=0;perTab:for(let tab,tabData;dataIndex<winTabs.length&&(tab=tabs[tabIndex],!(!tab||(tabData=winTabs[dataIndex],!tabData)));dataIndex++,tabIndex++){let blindspot=tab.status==="loading"&&tab.url==="about:blank";if(tabData.url===tab.url&&!!tabData.pin===tab.pinned||blindspot)existedTabs[tab.id]=tabData,equalityCounter++;else{for(let j=tabIndex+1;j<tabIndex+5;j++){let tabj=tabs[j];if(tabj&&tabj.url===tabData.url){tabIndex=j,existedTabs[tabj.id]=tabData,equalityCounter++;continue perTab}}tabIndex--}}let mismatchedLen=tabs.length-equalityCounter,mismatchedTh=tabs.length<3?0:tabs.length<10?1:2;if(tabs.length<=winTabs.length&&mismatchedLen>mismatchedTh||tabs.length>winTabs.length&&mismatchedLen>mismatchedTh+tabs.length-winTabs.length){warn("Tabs.findCachedData: mismatched:",mismatchedLen,tabs.length,winTabs.length);continue}if(maxEqualityCounter<=equalityCounter&&(maxEqualityCounter=equalityCounter,result=existedTabs),equalityCounter===tabs.length)break}return result}function cacheTabsData(delay=300){cacheTabsDataTimeout&&clearTimeout(cacheTabsDataTimeout),cacheTabsDataTimeout=setTimeout(()=>{if(Tabs2.tabsReinitializing)return;let data=[];for(let tab of Tabs2.list){let info2={id:tab.id,url:tab.url};tab.pinned&&(info2.pin=!0),+tab.parentId>-1&&(info2.parentId=tab.parentId),tab.panelId!==NOID&&(info2.panelId=tab.panelId),tab.folded&&(info2.folded=tab.folded),tab.cookieStoreId!==CONTAINER_ID&&(info2.ctx=tab.cookieStoreId),tab.customTitle&&(info2.customTitle=tab.customTitle),tab.customColor&&(info2.customColor=tab.customColor),data.push(info2)}Windows.uniqWinId&&data[0]&&(data[0].uniqWinId=Windows.uniqWinId),bg("cacheTabsData",Windows.id,data)},delay)}var cacheTabsDataTimeout;function saveTabData(tabId){let tab=Tabs2.byId[tabId];if(!tab)return;let data=tab.sessionData;if(data){if(data.parentId===tab.parentId&&data.folded===tab.folded&&data.panelId===tab.panelId&&data.customColor===tab.customColor&&data.customTitle===tab.customTitle)return;data.id=tabId,data.panelId=tab.panelId,data.parentId=tab.parentId,data.folded=tab.folded}else data={id:tabId,panelId:tab.panelId,parentId:tab.parentId,folded:tab.folded},tab.sessionData=data;tab.customTitle?data.customTitle=tab.customTitle:delete data.customTitle,tab.customColor?data.customColor=tab.customColor:delete data.customColor,browser.sessions.setTabValue(tabId,"data",data).catch(err3=>{err("Tabs.saveTabData: Cannot set value in session:",err3)})}var normTabsTimeout;function reinitTabs(delay=500){Tabs2.tabsReinitializing||(Tabs2.tabsReinitializing=!0),clearTimeout(normTabsTimeout),normTabsTimeout=setTimeout(async()=>{warn("Tabs.reinitTabs");let panelsList=[];for(let panel of Sidebar.panels)isTabsPanel(panel)&&panelsList.push({id:panel.id,index:-1});let normTabs=[],normTabsMap={},nativeTabs=await browser.tabs.query({windowId:browser.windows.WINDOW_ID_CURRENT}),moves=[],panelId,index=0,panelIndex=0;for(let nativeTab of nativeTabs){let tab=Tabs2.list.find(t=>t.id===nativeTab.id);if(tab){if(tab.index=index++,tab.status="complete",tab.active=nativeTab.active,nativeTab.active&&(Tabs2.activeId=nativeTab.id),!tab.pinned){let panelInfo=panelsList[panelIndex];if(!panelInfo){err("Tabs.reinitTabs: > > No panelInfo 1");break}if(panelInfo.id!==tab.panelId){let pi=panelsList.findIndex(p=>(p.index===-1&&(p.index=index-1),p.id===tab.panelId));if(pi>panelIndex){panelIndex=pi;let panelInfo2=panelsList[panelIndex];panelInfo2&&(panelInfo2.index=index)}else if(pi===-1)tab.panelId=panelId??NOID;else{let panelInfo2=panelsList[pi];if(!panelInfo2)return;moves.push([tab.id,panelInfo2.index]);for(let i=pi;i<panelsList.length;i++){let panelInfo3=panelsList[i];if(!panelInfo3)break;panelInfo3.index++}}}else panelInfo.index=index}normTabs.push(tab),normTabsMap[tab.id]=tab,tab.reactive=Tabs2.createReactiveProps(tab),panelId=tab.panelId}else{let tab2=mutateNativeTabToSideberyTab(nativeTab);Tabs2.reactivateTab(tab2),normTabs.push(tab2),nativeTab.active&&(Tabs2.activeId=nativeTab.id),normTabsMap[nativeTab.id]=tab2,index++}}if(moves.length&&!Tabs2.normTabsMoving){Tabs2.normTabsMoving=!0;let moving=moves.map(m=>browser.tabs.move(m[0],{index:m[1]}));await Promise.all(moving),reinitTabs(0);return}Tabs2.list=normTabs,Tabs2.byId=normTabsMap,Sidebar.recalcTabsPanels(!0),updateTabsTree(),Sidebar.recalcVisibleTabs(),Sidebar.reMountSidebar&&Sidebar.reMountSidebar(),Tabs2.tabsReinitializing=!1,Tabs2.normTabsMoving=!1,Settings.state.colorizeTabs&&Tabs2.colorizeTabs(),Settings.state.colorizeTabsBranches&&Tabs2.colorizeBranches(),Tabs2.list.forEach(t=>saveTabData(t.id)),cacheTabsData()},delay)}var sortNativeTabsTimeout,sortingNativeTabs=!1;function sortNativeTabs(delayMS=500){sortingNativeTabs=!1,clearTimeout(sortNativeTabsTimeout),sortNativeTabsTimeout=setTimeout(async()=>{sortingNativeTabs=!0;let nativeTabs=await browser.tabs.query({currentWindow:!0});if(!sortingNativeTabs)return sortNativeTabs();let nativeTabsById={};for(let nativeTab of nativeTabs)if(nativeTabsById[nativeTab.id]=nativeTab,!Tabs2.byId[nativeTab.id])return warn(`Tabs.sortNativeTabs: Cannot find sidebery tab: ${nativeTab.id}`),Tabs2.reinitTabs();let moves=[],prevMove,prevMoveStep=0;for(let tab of Tabs2.list){let nativeTabById=nativeTabsById[tab.id];if(!nativeTabById)return warn("Tabs.sortNativeTabs: Cannot find native tab"),Tabs2.reinitTabs();let nativeTabByIndex=nativeTabs[tab.index];if(!nativeTabByIndex||nativeTabByIndex.id!==tab.id){let step=nativeTabById.index-tab.index;nativeTabs.splice(nativeTabById.index,1),nativeTabs.splice(tab.index,0,nativeTabById),prevMoveStep===step&&prevMove?prevMove.ids.push(tab.id):(prevMove={index:tab.index,ids:[tab.id],step},moves.push(prevMove)),prevMoveStep=step}else prevMove=void 0,prevMoveStep=0}for(let move3 of moves){if(move3.step<move3.ids.length){let k=move3.index+move3.ids.length,targetIndex=move3.index+move3.ids.length,tabs=Tabs2.list.slice(k,k+move3.step),ids=tabs.map(t=>(t.moving=!0,t.id));Tabs2.movingTabs.push(...ids),await browser.tabs.move(ids,{index:targetIndex,windowId:Windows.id}).catch(err3=>{err("Tabs.sortNativeTabs: Cannot move tabs",err3)}),tabs.forEach(t=>t.moving=void 0)}else Tabs2.movingTabs.push(...move3.ids),move3.ids.forEach(id=>{let tab=Tabs2.byId[id];tab&&(tab.moving=!0)}),await browser.tabs.move(move3.ids,{index:move3.index,windowId:Windows.id}).catch(e=>{err("Tabs.sortNativeTabs: Cannot move tabs",e)}),move3.ids.forEach(id=>{let tab=Tabs2.byId[id];tab&&(tab.moving=void 0)});Tabs2.movingTabs=[]}sortingNativeTabs=!1},delayMS)}var switchTabPause;function switchTab(globaly,cycle,step,pinned){if(switchTabPause)return;let delay=Settings.state.tabSwitchDelay??0;delay>0&&(switchTabPause=setTimeout(()=>{clearTimeout(switchTabPause),switchTabPause=void 0},delay));let pinnedAndPanel=Settings.state.pinnedTabsPosition==="panel"||globaly&&cycle,visibleOnly=Settings.state.scrollThroughVisibleTabs,skipDiscarded=Settings.state.scrollThroughTabsSkipDiscarded,activeTab=Tabs2.byId[Tabs2.activeId];if(activeTab||(activeTab=Tabs2.list.find(t2=>t2.active)),!activeTab)return;let activePanel=Sidebar.panelsById[Sidebar.activePanelId];if(!isTabsPanel(activePanel))return;let targetTabId=NOID,index=activeTab.index,panelTabs=activePanel.tabs??[],t=!0,cycled=!1;if(!pinned&&!globaly&&activeTab.panelId!==activePanel.id||!pinned&&!pinnedAndPanel&&activeTab.pinned){let i=step>0?0:panelTabs.length-1,pTab=panelTabs[i];for(;pTab&&(pTab=panelTabs[i],i+=step,!!pTab);)if(!(visibleOnly&&pTab.invisible)&&!(skipDiscarded&&pTab.discarded)){targetTabId=pTab.id;break}targetTabId!==NOID&&browser.tabs.update(targetTabId,{active:!0}).catch(err3=>{err("Tabs.switchTab: Cannot activate tab (1):",err3)});return}for(let i=index+step;t;i+=step){if(t=Tabs2.list[i],!t)if(cycle&&!cycled){step>0?i=-1:i=Tabs2.list.length,cycled=t=!0;continue}else break;if(!(visibleOnly&&t.invisible)&&!(skipDiscarded&&t.discarded)&&!(pinned&&!t.pinned)&&!(!pinned&&!globaly&&t.panelId!==activeTab.panelId)&&!(!pinned&&!pinnedAndPanel&&t.pinned)){targetTabId=t.id;break}}targetTabId!==NOID&&targetTabId!==activeTab.id&&(Tabs2.scrollToTab(targetTabId,!1),browser.tabs.update(targetTabId,{active:!0}).catch(err3=>{err("Tabs.switchTab: Cannot activate tab (2):",err3)}))}var switchPreselectTabPause;function switchTabWithPreselect(globaly,cycle,dir){if(switchPreselectTabPause)return;switchPreselectTabPause=setTimeout(()=>{clearTimeout(switchPreselectTabPause),switchPreselectTabPause=void 0},50);let activePanel=Sidebar.panelsById[Sidebar.activePanelId];if(!isTabsPanel(activePanel))return;let tabs;if(globaly?tabs=[...Tabs2.list]:Settings.state.pinnedTabsPosition==="panel"?tabs=[...activePanel.pinnedTabs,...activePanel.tabs]:tabs=[...Tabs2.pinned,...activePanel.tabs],!tabs.length)return;let selIsSet=Selection.isSet(),target;if(Settings.state.selectActiveTabFirst&&!selIsSet){target=Tabs2.byId[Tabs2.activeId];let wrongPanel=target&&(!target.pinned||Settings.state.pinnedTabsPosition==="panel")&&target.panelId!==activePanel.id;(!target||wrongPanel)&&(target=dir>0?tabs[0]:tabs[tabs.length-1])}else{let afterSel=!1,tabFinder=tab=>{if(tab.invisible)return!1;if(afterSel)return!0;(selIsSet&&tab.sel||!selIsSet&&tab.active)&&(afterSel=!0)};target=dir>0?tabs.find(tabFinder):tabs.findLast(tabFinder)}target||(cycle?dir>0?target=tabs[0]:target=tabs[tabs.length-1]:dir>0?target=tabs[tabs.length-1]:target=tabs[0]),target&&(Selection.resetSelection(),globaly&&(!target.pinned||Settings.state.pinnedTabsPosition==="panel")&&target.panelId!==activePanel.id&&Sidebar.switchToPanel(target.panelId,!0,!0),Selection.selectTab(target.id),Tabs2.activateSelectedOnMouseLeave=!0,Tabs2.scrollToTab(target.id,!1))}var RELOADING_QUEUE=[],CHECK_INTERVAL=300,MAX_CHECK_COUNT=35;function reloadTabs(tabIds=[]){if(!Settings.state.tabsReloadLimit||typeof Settings.state.tabsReloadLimit!="number"){for(let id of tabIds){let tab=Tabs2.byId[id];tab&&reloadTab(tab)}return}let tabs=[];for(let tabId of tabIds){let tab=Tabs2.byId[tabId];if(tab&&(RELOADING_QUEUE.includes(tab)||(tab.reactive.status=3,tab.status="pending",tab.reloadingChecks=1,tabs.push(tab)),tab.folded)){let parentLvl=tab.lvl;for(tab=Tabs2.list[tab.index+1];tab&&tab.lvl>parentLvl;){if(tab&&!tabIds.includes(tab.id)){if(RELOADING_QUEUE.includes(tab))continue;tab.reactive.status=3,tab.status="pending",tab.reloadingChecks=1,tabs.push(tab)}tab=Tabs2.list[tab.index+1]}}}if(RELOADING_QUEUE.length>0){tabs.splice(0,Settings.state.tabsReloadLimit).forEach(tab=>reloadTab(tab)),RELOADING_QUEUE.push(...tabs);return}let progressNotification;Settings.state.tabsReloadLimitNotif&&tabs.length>Settings.state.tabsReloadLimit&&(progressNotification=Notifications.progress({icon:"#icon_reload",title:translate("notif.tabs_reloading"),ctrl:translate("notif.tabs_reloading_stop"),callback:()=>stopReloading()}));let reloadingTabs=tabs.splice(0,Settings.state.tabsReloadLimit);if(reloadingTabs.forEach(tab=>reloadTab(tab)),RELOADING_QUEUE.push(...tabs),RELOADING_QUEUE.length){let interval=setInterval(()=>{if(!RELOADING_QUEUE.length)return progressNotification&&Notifications.finishProgress(progressNotification),clearInterval(interval);let loading=reloadingTabs.filter(tab=>tab.reloadingChecks===void 0?!1:tab&&tab.reloadingChecks++<=MAX_CHECK_COUNT&&tab.status==="loading");for(let i=Settings.state.tabsReloadLimit-loading.length;i-- >0;){let nextTab=RELOADING_QUEUE.shift();if(!nextTab)break;reloadingTabs.push(nextTab),reloadTab(nextTab)}if(progressNotification){let all=RELOADING_QUEUE.length+reloadingTabs.length;Notifications.updateProgress(progressNotification,all-RELOADING_QUEUE.length,all)}},CHECK_INTERVAL)}}function stopReloading(){for(;RELOADING_QUEUE.length;){let tab=RELOADING_QUEUE.pop();tab&&tab.status==="pending"&&(tab.reactive.status=1,tab.status="complete")}}function reloadTab(tab){if(tab){if(tab.url==="about:blank"&&URL_WITHOUT_PROTOCOL_RE.test(tab.title)){browser.tabs.update(tab.id,{url:"https://"+tab.title}).catch(err3=>{err("Tabs.reloadTab: Cannot set url:",err3)});return}tab.url.startsWith("about:")&&tab.status==="loading"||browser.tabs.reload(tab.id).catch(err3=>{err("Tabs.reloadTab: Cannot reload:",err3)})}}async function discardTabs(tabIds=[]){Settings.state.pinnedNoUnload&&(tabIds=tabIds.filter(id=>{let tab=Tabs2.byId[id];return!(!tab||tab.pinned)}));let activeTab=Tabs2.byId[Tabs2.activeId];if(activeTab){let target=findSuccessorTab(activeTab,tabIds);target&&(tabIds.includes(Tabs2.activeId)?await browser.tabs.update(target.id,{active:!0}):activeTab.successorTabId!==target.id&&(browser.tabs.moveInSuccession([activeTab.id],target.id).catch(err3=>{err("Tabs.discardTabs: Cannot update succession:",err3)}),activeTab.successorTabId=target.id))}browser.tabs.discard(tabIds).catch(err3=>{err("Tabs.discardTabs: Cannot discard:",err3)})}function activateLastActiveTabOf(panelId){let panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel))return;let panelTabs=panel.tabs??[];if(!panelTabs.length)return;let p=getActiveTabsHistory(panel?.id),activeTab=Tabs2.byId[Tabs2.activeId];if(activeTab&&activeTab.panelId===p.id)return;let tab;if(p.actTabs&&p.actTabs.length){let index;p.actTabOffset>=0&&p.actTabOffset<p.actTabs.length?index=p.actTabOffset:index=p.actTabs.length-1;let tabId=p.actTabs[index];tab=Tabs2.byId[tabId]}if((!tab||tab.panelId!==p.id)&&(tab=panelTabs[0]),tab&&tab.discarded&&Settings.state.activateLastTabOnPanelSwitchingLoadedOnly&&(tab=panelTabs.find(t=>!t.discarded)),tab)return browser.tabs.update(tab.id,{active:!0}).catch(err3=>{err("Tabs.activateLastActiveTabOf: Cannot activate tab:",err3)})}function pinTabs(tabIds){Tabs2.sortTabIds(tabIds);for(let tabId of tabIds){let tab=Tabs2.byId[tabId];if(tab){for(let i=tab.index+1;i<Tabs2.list.length;i++){let child=Tabs2.list[i];if(child.lvl<=tab.lvl)break;child.parentId===tab.id&&(child.parentId=tab.parentId)}browser.tabs.update(tabId,{pinned:!0}).catch(err3=>{err("Tabs.pinTabs: Cannot pin tab:",err3)})}}}function unpinTabs(tabIds){Tabs2.sortTabIds(tabIds,!0);for(let tabId of tabIds)browser.tabs.update(tabId,{pinned:!1}).catch(err3=>{err("Tabs.unpinTabs: Cannot unpin tab:",err3)})}function repinTabs(tabIds){for(let tabId of tabIds){let tab=Tabs2.byId[tabId];if(tab){for(let i=tab.index+1;i<Tabs2.list.length;i++){let child=Tabs2.list[i];if(child.lvl<=tab.lvl)break;child.parentId===tab.id&&(child.parentId=tab.parentId)}browser.tabs.update(tabId,{pinned:!tab.pinned}).catch(err3=>{err("Tabs.repinTabs: Cannot repin tab:",err3)})}}}async function duplicateTabs(tabIds,asChild){let active=tabIds.length===1;Tabs2.sortTabIds(tabIds);let processed=[];for(let tabId of tabIds){let tab=Tabs2.byId[tabId];if(!tab||processed.includes(tab.id))continue;processed.push(tab.id);let descendantsToDuplicate=[],index=tab.index+1,dstPanelId=tab.panelId;if(tab.pinned){let panel;if(Settings.state.pinnedTabsPosition==="panel"){if(panel=Sidebar.panelsById[tab.panelId],!isTabsPanel(panel))return}else if(panel=Sidebar.panelsById[Sidebar.activePanelId],isTabsPanel(panel)||(panel=Sidebar.panels.find(p=>isTabsPanel(p))),!isTabsPanel(panel))return;dstPanelId=panel.id,Settings.state.moveNewTabPin==="start"?index=panel.startTabIndex:Settings.state.moveNewTabPin==="end"&&(index=panel.nextTabIndex),index<0&&(dstPanelId=NOID,index=Tabs2.list.length)}else for(let t;index<Tabs2.list.length&&(t=Tabs2.list[index],!(t.lvl<=tab.lvl));index++)if(tabIds.includes(t.id)){let dupAncestorId=Tabs2.findAncestor(t.id,id=>tabIds.includes(id));dupAncestorId!==void 0&&(descendantsToDuplicate.push([t.id,dupAncestorId]),processed.push(t.id))}let oldNewIds={};Tabs2.setNewTabPosition(index,asChild?tab.id:tab.parentId,dstPanelId);let dupTab=await browser.tabs.duplicate(tabId,{active,index});oldNewIds[tabId]=dupTab.id;for(let[descendantTabId,descendantParentId]of descendantsToDuplicate){index++;let dupDescendantParentId=oldNewIds[descendantParentId];Tabs2.setNewTabPosition(index,dupDescendantParentId,dstPanelId);let dupDescendantTab=await browser.tabs.duplicate(descendantTabId,{active,index});oldNewIds[descendantTabId]=dupDescendantTab.id}}}function findAncestor(tabId,cb){let tab=Tabs2.byId[tabId];if(!tab)throw"Tabs.getAncestors: No target tab";let parent=Tabs2.byId[tab.parentId];for(;parent;){if(cb(parent.id))return parent.id;parent=Tabs2.byId[parent.parentId]}}function dedupTabs(tabIds){if(!tabIds||!tabIds.length)return;let urls=[],toRemove=[];for(let id of tabIds){let tab=Tabs2.byId[id];if(!tab)return;urls.includes(tab.url)?toRemove.push(tab.id):urls.push(tab.url)}Tabs2.removeTabs(toRemove)}async function bookmarkTabs(tabIds){if(!Permissions.reactive.bookmarks&&!await Permissions.request("bookmarks"))return;let parentId=BKM_OTHER_ID,tabs=[];for(let id of tabIds){let tab=Tabs2.byId[id];tab&&tabs.push(tab)}if(!tabs.length)return;let panelId=tabs[0].panelId,panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel))return;let hasDefaultFolder=panel.bookmarksFolderId!==NOID&&panel.bookmarksFolderId!==BKM_ROOT_ID;if(hasDefaultFolder&&(parentId=panel.bookmarksFolderId),tabs.length===1&&Settings.state.askNewBookmarkPlace){let tab=tabs[0],result=await Bookmarks.openBookmarksPopup({title:translate("popup.bookmarks.save_in_bookmarks"),name:tab.customTitle??tab.title,nameField:!0,url:tab.url,urlField:!0,location:parentId,locationField:!0,recentLocations:!0,recentLocationAsDefault:!hasDefaultFolder,controls:[{label:"btn.save"}],validate:popupState=>{popupState.nameValid=!!popupState.name,popupState.urlValid=!!popupState.url;let ctrl=popupState.controls?.[0];ctrl&&(!popupState.nameValid||!popupState.urlValid?ctrl.inactive=!0:ctrl.inactive=!1)}});if(result){parentId=result.location??BKM_OTHER_ID,parentId===NOID&&(parentId=BKM_OTHER_ID);let info2={id:tab.id,title:result.name,container:tab.cookieStoreId};Bookmarks.attachTabInfoToTitle(info2),await browser.bookmarks.create({parentId,type:"bookmark",title:info2.title,url:result.url})}}else{if(Settings.state.askNewBookmarkPlace){let result=await Bookmarks.openBookmarksPopup({title:translate("popup.bookmarks.save_in_bookmarks"),location:parentId,locationField:!0,locationTree:!1,recentLocations:!0,recentLocationAsDefault:!hasDefaultFolder,controls:[{label:"btn.save"}]});if(!result)return;result.location&&(parentId=result.location)}tabs.sort((a,b)=>a.index-b.index);let items=tabs.map(t=>({id:t.id,parentId:t.parentId,url:t.url,title:t.customTitle??t.title}));await Bookmarks.createFrom(items,{parentId})}if(!Settings.state.askNewBookmarkPlace){let parentName=Bookmarks.reactive.byId[parentId]?.title;Notifications.notify({icon:"#icon_bookmarks",title:translate("notif.new_bookmark"),details:parentName?`Folder: ${parentName}`:void 0})}}async function clearTabsCookies(tabIds){if(!(!Permissions.reactive.webData&&!await Permissions.request("<all_urls>")))for(let tabId of tabIds){let tab=Tabs2.byId[tabId];if(!tab)continue;let domain=new URL(tab.url).hostname.split(".").slice(-2).join(".");if(!domain){Notifications.notify({lvl:"err",icon:"#icon_cookie",title:translate("notif.cc.err"),details:`${translate("notif.cc.err_url")}"${decodeURI(tab.url)}"`});continue}tab.reactive.status=2;let cookies=await browser.cookies.getAll({domain,storeId:tab.cookieStoreId}),fpcookies=await browser.cookies.getAll({firstPartyDomain:domain,storeId:tab.cookieStoreId}),clearing=cookies.concat(fpcookies).map(c=>browser.cookies.remove({storeId:tab.cookieStoreId,url:tab.url,name:c.name}));Promise.all(clearing).then(()=>{Notifications.notify({icon:"#icon_cookie",title:translate("notif.cc.ok"),details:domain}),tab.reactive.status=Tabs2.getStatus(tab)}).catch(()=>{Notifications.notify({lvl:"err",icon:"#icon_cookie",title:translate("notif.cc.err"),details:domain}),tab.reactive.status=Tabs2.getStatus(tab)})}}function sortTabIds(tabIds,reverse){tabIds.sort((a,b)=>{let aTab=Tabs2.byId[a],bTab=Tabs2.byId[b];return!aTab||!bTab?0:reverse?bTab.index-aTab.index:aTab.index-bTab.index})}function updateNativeTabsVisibility(){let hideFolded=Settings.state.hideFoldedTabs,hideFoldedParent=hideFolded&&Settings.state.hideFoldedParent==="any",hideFoldedGroup=hideFolded&&Settings.state.hideFoldedParent==="group",hideInact=Settings.state.hideInact;if(!browser.tabs.hide)return;let actTab=Tabs2.byId[Tabs2.activeId],actPanel;actTab?.pinned?actPanel=Sidebar.panelsById[Sidebar.activePanelId]:actTab&&(actPanel=Sidebar.panelsById[actTab.panelId]);let toShow=[],toHide=[];for(let tab of Tabs2.list)if(!tab.pinned){if(hideFolded&&tab.invisible){tab.hidden||toHide.push(tab.id);continue}if(tab.folded&&!tab.active&&(hideFoldedParent||hideFoldedGroup&&tab.isGroup)){tab.hidden||toHide.push(tab.id);continue}if(isTabsPanel(actPanel)&&hideInact&&tab.panelId!==actPanel.id){tab.hidden||toHide.push(tab.id);continue}tab.hidden&&toShow.push(tab.id)}toShow.length&&browser.tabs.show(toShow),toHide.length&&browser.tabs.hide(toHide)}function getBranchLen(id){let tab=Tabs2.byId[id];if(!tab)return;let count=0,tabsLen=Tabs2.list.length;for(let i=tab.index+1;i<tabsLen&&!(Tabs2.list[i].lvl<=tab.lvl);i++)count++;return count}function recalcBranchLen(id){let branchLen=Tabs2.getBranchLen(id);if(branchLen===void 0)return;let tab=Tabs2.byId[id];tab&&(tab.reactive.branchLen=branchLen)}function autoDiscardFolded(rootTab){if(Settings.state.discardFolded)if(Settings.state.discardFoldedDelay===0){let childIds=Tabs2.getBranch(rootTab,!1).map(t=>t.id);if(!childIds.length)return;browser.tabs.discard(childIds)}else{let delayMS=Settings.state.discardFoldedDelay;Settings.state.discardFoldedDelayUnit==="sec"&&(delayMS*=1e3),Settings.state.discardFoldedDelayUnit==="min"&&(delayMS*=6e4),clearTimeout(rootTab.autoUnloadFoldedTimeout),rootTab.autoUnloadFoldedTimeout=setTimeout(()=>{let parentTab=Tabs2.byId[rootTab.id];if(parentTab?.isParent&&parentTab.folded){let childIds=Tabs2.getBranch(rootTab,!1).map(t=>t.id);if(!childIds.length)return;browser.tabs.discard(childIds)}},delayMS)}}function foldTabsBranch(rootTabId){let toHide=[],rootTab=Tabs2.byId[rootTabId];if(!rootTab)return;let panel=Sidebar.panelsById[rootTab.panelId];if(!isTabsPanel(panel))return;let hideFolded=Settings.state.hideFoldedTabs,hideFoldedParent=hideFolded&&Settings.state.hideFoldedParent==="any",hideFoldedGroup=hideFolded&&Settings.state.hideFoldedParent==="group";rootTab.folded=!0,rootTab.reactive.folded=!0;let len=0;for(let i=rootTab.index+1;i<Tabs2.list.length;i++){let t=Tabs2.list[i];if(t.lvl<=rootTab.lvl)break;t.active&&browser.tabs.update(rootTabId,{active:!0}),t.invisible||(t.invisible=!0,toHide.push(t.id)),len++}Sidebar.recalcVisibleTabs(rootTab.panelId),rootTab.reactive.branchLen=len,Tabs2.incrementScrollRetainer(panel,len),Settings.state.discardFolded&&Tabs2.autoDiscardFolded(rootTab),hideFolded&&toHide.length&&browser.tabs.hide?.(toHide).catch(err3=>{err("Tabs.foldTabsBranch: Cannot hide tabs:",err3)}),!rootTab.active&&(hideFoldedParent||hideFoldedGroup&&rootTab.isGroup)&&browser.tabs.hide?.(rootTabId).catch(err3=>{err("Tabs.foldTabsBranch: Cannot hide parent tab:",err3)}),rootTab.active&&Tabs2.updateSuccessionDebounced(0),saveTabData(rootTabId),cacheTabsData()}function expTabsBranch(rootTabId,noRecursive,noAutoFold){let autoFoldTabs=Settings.state.autoFoldTabs&&!noAutoFold,hideFolded=Settings.state.hideFoldedTabs,hideFoldedParent=hideFolded&&Settings.state.hideFoldedParent==="any",hideFoldedGroup=hideFolded&&Settings.state.hideFoldedParent==="group",toShow=[],preserve=[],autoFold=[],rootTab=Tabs2.byId[rootTabId];if(!rootTab)return;let panel=Sidebar.panelsById[rootTab.panelId];if(!isTabsPanel(panel))return;rootTab.lastExpanded=Date.now(),rootTab.invisible&&!noRecursive&&expTabsBranch(rootTab.parentId);let count=0;for(let tab of Tabs2.list)tab.pinned||tab.panelId!==tab.panelId||(autoFoldTabs&&tab.id!==rootTabId&&tab.isParent&&!tab.folded&&tab.lvl===rootTab.lvl&&autoFold.push(tab),tab.id===rootTabId&&(tab.reactive.folded=tab.folded=!1),tab.id!==rootTabId&&tab.folded&&preserve.push(tab.id),(tab.parentId===rootTabId||toShow.includes(tab.parentId))&&tab.invisible&&(tab.parentId===rootTabId||!preserve.includes(tab.parentId))&&(tab.invisible=!1,count++,tab.folded&&!tab.active&&(hideFoldedParent||hideFoldedGroup&&tab.isGroup)||toShow.push(tab.id)));if(rootTab.invisible||Sidebar.recalcVisibleTabs(rootTab.panelId),!rootTab.invisible&&count&&Tabs2.decrementScrollRetainer(panel,count),Settings.state.autoFoldTabs){autoFold.sort((a,b)=>{let aMax=a.lastAccessed,bMax=b.lastAccessed;return a.childLastAccessed&&(aMax=Math.max(a.lastAccessed,a.childLastAccessed)),a.lastExpanded&&(aMax=Math.max(aMax,a.lastExpanded)),b.childLastAccessed&&(bMax=Math.max(b.lastAccessed,b.childLastAccessed)),b.lastExpanded&&(bMax=Math.max(bMax,b.lastExpanded)),aMax-bMax}),Settings.state.autoFoldTabsExcept!=="none"&&(autoFold=autoFold.slice(0,-Settings.state.autoFoldTabsExcept));for(let t of autoFold)foldTabsBranch(t.id)}hideFolded&&(hideFoldedParent||hideFoldedGroup&&rootTab.isGroup)&&browser.tabs.show?.(rootTabId).catch(err3=>{err("Tabs.expTabsBranch: Cannot show parent tab:",err3)}),hideFolded&&toShow.length&&browser.tabs.show?.(toShow).catch(err3=>{err("Tabs.expTabsBranch: Cannot show tabs:",err3)}),rootTab.active&&Tabs2.updateSuccessionDebounced(0),saveTabData(rootTabId),cacheTabsData()}function toggleBranch(tabId){if(!Settings.state.tabsTree||tabId===void 0)return;let tab=Tabs2.byId[tabId];tab||(tab=Tabs2.byId[Tabs2.activeId]),tab&&!tab.isParent&&+tab.parentId>-1&&(tab=Tabs2.byId[tab.parentId]),tab&&(tab.folded?expTabsBranch(tabId):foldTabsBranch(tabId))}function foldAllInactiveBranches(tabs=[]){let activeTab=Tabs2.byId[Tabs2.activeId];if(!activeTab)return;let activeBranch=[activeTab.id],parent=Tabs2.byId[activeTab.parentId];for(;parent;)activeBranch.push(parent.id),parent=Tabs2.byId[parent.parentId];for(let tab,i=tabs.length;i--;)tab=tabs[i],tab.isParent&&!tab.folded&&!activeBranch.includes(tab.id)&&foldTabsBranch(tab.id)}function activateParent(tabId){if(!Settings.state.tabsTree)return;tabId===void 0&&(tabId=Tabs2.activeId);let tab=Tabs2.byId[tabId];tab&&Tabs2.byId[tab.parentId]&&browser.tabs.update(tab.parentId,{active:!0})}function flattenTabs(tabIds){if(sortTabIds(tabIds),tabIds.length===1){let tab=Tabs2.byId[tabIds[0]];if(tab&&!tab.isParent&&tab.lvl>0){let parentTab=Tabs2.byId[tab.parentId];parentTab&&tabIds.unshift(parentTab.id)}}let minLvlTab={lvl:999},idsToFlatten=[],tabsToFlatten=[];for(let id of tabIds){let tab=Tabs2.byId[id];tab&&(idsToFlatten.push(id),tabsToFlatten.push(tab))}for(let tab of Tabs2.list)tab.hidden||(idsToFlatten.includes(tab.id)&&tab.lvl<minLvlTab.lvl&&(minLvlTab=tab),idsToFlatten.includes(tab.parentId)&&(idsToFlatten.includes(tab.id)||(idsToFlatten.push(tab.id),tabsToFlatten.push(tab)),tab.lvl<minLvlTab.lvl&&(minLvlTab=tab)));if(!minLvlTab.parentId)return;let updVisPanelId=NOID;for(let tab of tabsToFlatten)tab.reactive.lvl=tab.lvl=minLvlTab.lvl,tab.parentId=minLvlTab.parentId,tab.invisible&&(tab.invisible=!1,updVisPanelId===NOID?updVisPanelId=tab.panelId:updVisPanelId&&updVisPanelId!==tab.panelId&&(updVisPanelId=void 0)),tab.parentId===-1&&browser.tabs.update(tab.id,{openerTabId:tab.id});updateTabsTree(tabsToFlatten[0].index-1,tabsToFlatten[tabsToFlatten.length-1].index+1),updVisPanelId!==NOID&&Sidebar.recalcVisibleTabs(updVisPanelId),tabsToFlatten.forEach(t=>saveTabData(t.id)),cacheTabsData()}var updateTabsTreeTimeout;function updateTabsTreeDebounced(startIndex=0,endIndex=-1,delay=150){clearTimeout(updateTabsTreeTimeout),updateTabsTreeTimeout=setTimeout(()=>{updateTabsTree(startIndex,endIndex)},delay)}function updateTabsTree(startIndex=0,endIndex=-1){if(!Settings.state.tabsTree||!Tabs2.list||!Tabs2.list.length)return;startIndex<0&&(startIndex=0),endIndex===-1&&(endIndex=Tabs2.list.length);let maxLvl=typeof Settings.state.tabsTreeLimit=="number"?Settings.state.tabsTreeLimit:123;if(Tabs2.list[endIndex-1]){let tab=Tabs2.list[endIndex-1];tab&&(tab.reactive.isParent=tab.isParent=!1,tab.reactive.folded=tab.folded=!1)}let foldedBranchLenCount=0,foldedBranchLvl=-1,foldedBranchRoot;for(let prevTab,tab,i=startIndex;i<endIndex;i++){if(tab=Tabs2.list[i],!tab)return err("Tabs.updateTabsTree: Cannot get tab");if(tab.pinned){tab.parentId=-1,tab.reactive.lvl=tab.lvl=0,tab.invisible=!1,tab.reactive.isParent=tab.isParent=!1,tab.reactive.folded=tab.folded=!1;continue}prevTab=Tabs2.list[i-1];let parent=Tabs2.byId[tab.parentId];if(parent&&(parent.pinned||parent.index>=tab.index)&&(parent=void 0),parent&&!parent.pinned&&parent.panelId===tab.panelId){if(parent.lvl===maxLvl?(parent.reactive.isParent=parent.isParent=!1,parent.reactive.folded=parent.folded=!1,tab.parentId=parent.parentId,tab.reactive.lvl=tab.lvl=parent.lvl,tab.invisible=parent.invisible):(parent.reactive.isParent=parent.isParent=!0,tab.reactive.lvl=tab.lvl=parent.lvl+1,tab.invisible=parent.folded||parent.invisible),prevTab&&prevTab.id!==tab.parentId&&prevTab.lvl<tab.lvl)for(let j=tab.index;j--;){let backTab=Tabs2.list[j];if(backTab.id===parent.id||backTab.panelId!==tab.panelId)break;parent.lvl===maxLvl?(backTab.parentId=parent.parentId,backTab.reactive.isParent=backTab.isParent=!1,backTab.reactive.folded=backTab.folded=!1):backTab.parentId=parent.id,backTab.reactive.lvl=backTab.lvl=tab.lvl,backTab.invisible=tab.invisible}}else tab.parentId=-1,tab.reactive.lvl=tab.lvl=0,tab.invisible=!1;prevTab&&prevTab.lvl>=tab.lvl&&(prevTab.reactive.isParent=prevTab.isParent=!1,prevTab.reactive.folded=prevTab.folded=!1),tab.parentId===-1&&tab.openerTabId!==void 0&&(browser.tabs.update(tab.id,{openerTabId:tab.id}).catch(err3=>{err("Tabs.updateTabsTree: Cannot reset openerTabId:",err3)}),tab.openerTabId=void 0),tab.parentId!==-1&&tab.openerTabId!==tab.parentId&&(browser.tabs.update(tab.id,{openerTabId:tab.parentId}).catch(err3=>{err("Tabs.updateTabsTree: Cannot set openerTabId:",err3)}),tab.openerTabId=tab.parentId),foldedBranchLvl>-1&&(tab.lvl<=foldedBranchLvl&&foldedBranchRoot?(foldedBranchRoot.reactive.branchLen=foldedBranchLenCount,foldedBranchLvl=-1,foldedBranchLenCount=0,foldedBranchRoot=void 0):foldedBranchLenCount++),tab.folded&&!tab.invisible&&foldedBranchLvl===-1&&(foldedBranchLvl=tab.lvl,foldedBranchRoot=tab)}foldedBranchLvl>-1&&foldedBranchRoot&&(foldedBranchRoot.reactive.branchLen=foldedBranchLenCount)}function queryTab(props){let tab=Tabs2.list.find(t=>Object.keys(props).every(p=>t[p]===props[p]));return tab?cloneObject(tab):null}function getTabs(tabIds){let tabs=tabIds?Tabs2.list.filter(t=>tabIds.includes(t.id)):Tabs2.list;if(tabs.length)return cloneArray(tabs)}function getTabsTreeData(){let tree=[],prevPanelId=NOID;for(let tab of Tabs2.list){let data={id:tab.id};tab.panelId!==NOID&&(tab.panelId===prevPanelId?data.pid=SAMEID:data.pid=tab.panelId),tab.parentId!==NOID&&(data.tid=tab.parentId),tab.customTitle&&(data.ct=tab.customTitle),tab.customColor&&(data.cc=tab.customColor),prevPanelId=tab.panelId,tree.push(data)}return tree}function updateTabsIndexes(fromIndex=0,toIndex=-1){let tabs=Tabs2.list;toIndex===-1&&(toIndex=tabs.length);for(let t,i=fromIndex;i<toIndex;i++)t=tabs[i],t&&t.index!==i&&(t.index=i)}function findSuccessorTab(tab,exclude){let target,tree=Settings.state.tabsTree,rmFolded=Settings.state.rmChildTabs==="folded",rmChild=Settings.state.rmChildTabs==="all",skipFolded=Settings.state.activateAfterClosingNoFolded,skipDiscarded=Settings.state.activateAfterClosingNoDiscarded,dirNext=Settings.state.activateAfterClosing==="next",dirPrev=Settings.state.activateAfterClosing==="prev",stayInPanel=Settings.state.activateAfterClosingStayInPanel;if(Tabs2.removingTabs&&!exclude&&(exclude=Tabs2.removingTabs),tab.pinned&&(dirNext||dirPrev)){let discardedFallback2,pinInPanels=Settings.state.pinnedTabsPosition==="panel",dirDir=dirNext?1:-1,opDir=dirDir*-1;if(Tabs2.byId[tab.relGroupId]&&(target=Tabs2.byId[tab.relGroupId]),!target)for(let foundTab2,i=tab.index+dirDir;(foundTab2=Tabs2.list[i])&&foundTab2?.pinned;i+=dirDir){if(skipDiscarded&&foundTab2.discarded){discardedFallback2||(discardedFallback2=foundTab2);continue}pinInPanels&&foundTab2.panelId===tab.panelId?target=foundTab2:pinInPanels||(target=foundTab2)}if(!target)for(let foundTab2,i=tab.index+opDir;(foundTab2=Tabs2.list[i])&&foundTab2?.pinned;i+=opDir){if(skipDiscarded&&foundTab2.discarded){discardedFallback2||(discardedFallback2=foundTab2);continue}pinInPanels&&foundTab2.panelId===tab.panelId?target=foundTab2:pinInPanels||(target=foundTab2)}if(!target){let panel2;if(pinInPanels?panel2=Sidebar.panelsById[tab.panelId]:panel2=Sidebar.panelsById[Sidebar.activePanelId],isTabsPanel(panel2))for(let tab2 of panel2.tabs){if(skipDiscarded&&tab2.discarded){discardedFallback2||(discardedFallback2=tab2);continue}target=tab2;break}}if(!target){let prevTabsPanelHistory=Tabs2.getActiveTabsHistory(Sidebar.lastTabsPanelId);if(prevTabsPanelHistory?.actTabs.length){let panelId=Sidebar.lastTabsPanelId,actTabs=prevTabsPanelHistory.actTabs,prevActTab=Tabs2.byId[actTabs[actTabs.length-1]];if(prevActTab&&prevActTab.panelId===panelId&&!prevActTab.discarded)return prevActTab}}if(!target)for(let tab2 of Tabs2.list){if(skipDiscarded&&tab2.discarded){discardedFallback2||(discardedFallback2=tab2);continue}target=tab2;break}return target??discardedFallback2}if(tab.url.startsWith(GROUP_URL)){let pin=new URL(tab.url).searchParams.get("pin");if(pin){let[containerId,url]=pin.split("::");if(target=Tabs2.list.find(t=>t.pinned&&t.cookieStoreId===containerId&&t.url===url),target)return target}}let panel=Sidebar.panelsById[tab.panelId];if(!isTabsPanel(panel))return;let dir=dirNext?1:-1,mode=1;(!tree||!dirNext||tab.parentId===-1)&&(mode=2);let inBranch=!0,upI=tab.index-1,downI=tab.index+1,foundTab,discardedFallback,foldedFallback;mainLoop:for(;upI>=0||downI<Tabs2.list.length;){if(dir===1?foundTab=Tabs2.list[downI]:dir===-1&&(foundTab=Tabs2.list[upI]),mode===1||mode===11){if(!foundTab||dir===1&&foundTab.lvl<tab.lvl||dir===-1&&!inBranch){mode===1?mode=11:mode=2,dir*=-1;continue}dir===-1&&foundTab.parentId===-1&&(inBranch=!1)}if((mode===2||mode===22)&&(!foundTab||foundTab.panelId!==panel.id||foundTab.pinned!==tab.pinned)){if(mode===2)mode=22;else{if(panel.pinnedTabs.length)for(let i=panel.pinnedTabs.length;i--;){let pTab=panel.pinnedTabs[i];if(!pTab)break;if(skipDiscarded&&pTab.discarded){discardedFallback||(discardedFallback=Tabs2.byId[pTab.id]);continue}if(!(exclude&&exclude.includes(pTab.id))){target=Tabs2.byId[pTab.id];break mainLoop}}if(stayInPanel&&(discardedFallback||foldedFallback))return discardedFallback||foldedFallback;let prevTabsPanelHistory=Tabs2.getActiveTabsHistory(Sidebar.lastTabsPanelId);if(prevTabsPanelHistory?.actTabs.length){let panelId=Sidebar.lastTabsPanelId,actTabs=prevTabsPanelHistory.actTabs,prevActTab=Tabs2.byId[actTabs[actTabs.length-1]];if(prevActTab&&prevActTab.panelId===panelId&&!prevActTab.discarded)return prevActTab}mode=3}dir*=-1;continue}if((mode===3||mode===33)&&!foundTab){if(mode===3)mode=33;else break;dir*=-1;continue}if(!foundTab)break;if(dir===1?downI++:upI--,!(exclude&&exclude.includes(foundTab.id))&&!(rmFolded&&foundTab.invisible)&&!(rmChild&&foundTab.lvl>tab.lvl)){if(dir===-1&&foundTab.invisible){foldedFallback||(foldedFallback=foundTab);continue}if(skipDiscarded&&foundTab.discarded){discardedFallback||(discardedFallback=foundTab);continue}target=foundTab;break}}if(Settings.state.activateAfterClosing==="prev_act"){let history2;if(Settings.state.activateAfterClosingGlobal?history2=Tabs2.activeTabsGlobal:history2=Tabs2.activeTabsPerPanel[tab.panelId]||Tabs2.activeTabsGlobal,!history2||!history2.actTabs)return;let targetId2,prev2;for(let i=history2.actTabs.length;i--;)if(targetId2=history2.actTabs[i],prev2=Tabs2.byId[targetId2],!(exclude&&exclude.includes(targetId2))){if(skipDiscarded&&prev2&&prev2.discarded){discardedFallback||(discardedFallback=prev2);continue}if(!(skipFolded&&prev2&&prev2.invisible)&&targetId2!==tab.id&&prev2){target=prev2;break}}}return target||(target=discardedFallback),target}var skipActTabsCollecting=!1;function skipActiveTabsHistoryCollecting(){skipActTabsCollecting=!0}function writeActiveTabsHistory(prevTab,activeTab){if(skipActTabsCollecting){skipActTabsCollecting=!1;return}let samePanel=prevTab.panelId===activeTab.panelId,g=Tabs2.activeTabsGlobal,p=Tabs2.activeTabsPerPanel[prevTab.panelId];p||(p={id:prevTab.panelId,actTabOffset:-1,actTabs:[]},Tabs2.activeTabsPerPanel[prevTab.panelId]=p),g.actTabOffset>=0&&g.actTabOffset<g.actTabs.length&&samePanel&&(g.actTabs=g.actTabs.slice(0,g.actTabOffset),g.actTabOffset=-1),g.actTabs.length>128&&(g.actTabs=g.actTabs.slice(32)),g.actTabs.push(prevTab.id),(!prevTab.pinned||Settings.state.pinnedTabsPosition==="panel")&&(p.actTabOffset>=0&&p.actTabOffset<p.actTabs.length&&samePanel&&(p.actTabs=p.actTabs.slice(0,p.actTabOffset),p.actTabOffset=-1),p.actTabs.length>128&&(p.actTabs=p.actTabs.slice(32)),p.actTabs.push(prevTab.id))}function getActiveTabsHistory(panelId){return panelId!==void 0?(Tabs2.activeTabsPerPanel[panelId]||(Tabs2.activeTabsPerPanel[panelId]={id:panelId,actTabOffset:-1,actTabs:[]}),Tabs2.activeTabsPerPanel[panelId]):Tabs2.activeTabsGlobal}function tabFlip(){let actTab=Tabs2.byId[Tabs2.activeId];if(!actTab)return;let panelId;Settings.state.tabsSecondClickActPrevPanelOnly&&(actTab.pinned&&Settings.state.pinnedTabsPosition!=="panel"?panelId=Sidebar.activePanelId:panelId=actTab.panelId);let history2=Tabs2.getActiveTabsHistory(panelId),prevTabId=findLast(history2.actTabs,id=>id!==Tabs2.activeId);prevTabId!==void 0&&browser.tabs.update(prevTabId,{active:!0})}function getTabInfo(id,setPanelId){let tab=Tabs2.byId[id];if(!tab)return;let info2={id,url:tab.url,parentId:tab.parentId,title:tab.title,active:tab.active,index:tab.index,pinned:tab.pinned,container:tab.cookieStoreId};return tab.customTitle&&(info2.customTitle=tab.customTitle),tab.customColor&&(info2.customColor=tab.customColor),setPanelId&&(info2.panelId=tab.panelId),info2}function getTabsInfo(ids,setPanelId){let items=[];for(let id of ids){let tab=Tabs2.byId[id];if(tab){let info2={id,url:tab.url,parentId:tab.parentId,title:tab.title,active:tab.active,index:tab.index,pinned:tab.pinned,container:tab.cookieStoreId};if(tab.customTitle&&(info2.customTitle=tab.customTitle),tab.customColor&&(info2.customColor=tab.customColor),setPanelId&&(info2.panelId=tab.panelId),items.push(info2),tab.folded)for(let i=tab.index+1;i<Tabs2.list.length;i++){let child=Tabs2.list[i];if(!child.invisible)break;if(ids.includes(child.id))continue;let subInfo={id:child.id,url:child.url,parentId:child.parentId,title:child.title,active:child.active,index:child.index,pinned:child.pinned,container:child.cookieStoreId};setPanelId&&(subInfo.panelId=child.panelId),items.push(subInfo)}}}return items}function getBranch(tab,withRoot=!0){let result=[];withRoot&&result.push(tab);let target=Tabs2.list[tab.index];if(!target||target.id!==tab.id)return result;let rootLvl=tab.lvl,index=tab.index+1,child=Tabs2.list[index++];for(;child&&child.lvl>rootLvl;)result.push(child),child=Tabs2.list[index++];return result}function forEachDescendant(rootTab,cb){let target=Tabs2.list[rootTab.index];if(!target||target.id!==rootTab.id)return warn("Tabs.forEachDescendant: Wrong index");let rootLvl=rootTab.lvl,index=rootTab.index+1,child=Tabs2.list[index++];for(;child&&child.lvl>rootLvl;)cb(child),child=Tabs2.list[index++]}async function copyUrls2(ids){if(!Permissions.reactive.clipboardWrite&&!await Permissions.request("clipboardWrite"))return;let urls="";for(let id of ids){let tab=Tabs2.byId[id];tab&&(urls+=`
`+tab.url)}let resultString=urls.trim();resultString&&navigator.clipboard.writeText(resultString)}async function copyTitles2(ids){if(!Permissions.reactive.clipboardWrite&&!await Permissions.request("clipboardWrite"))return;let titles="";for(let id of ids){let tab=Tabs2.byId[id];tab&&(titles+=`
`+tab.title)}let resultString=titles.trim();resultString&&navigator.clipboard.writeText(resultString)}var flashAnimationTimeout;function triggerFlashAnimation(tab){flashAnimationTimeout||(tab.reactive.flash=!0,flashAnimationTimeout=setTimeout(()=>{flashAnimationTimeout=void 0,tab.reactive.flash=!1},1e3))}function updateUrlCounter(url,delta){let count=Tabs2.urlsInUse[url];return count===void 0?delta>0?Tabs2.urlsInUse[url]=delta:0:(count+=delta,count<=0?(delete Tabs2.urlsInUse[url],0):(Tabs2.urlsInUse[url]=count,count))}var SwitchingTabScope=(SwitchingTabScope2=>(SwitchingTabScope2[SwitchingTabScope2.global=1]="global",SwitchingTabScope2[SwitchingTabScope2.panel=2]="panel",SwitchingTabScope2))(SwitchingTabScope||{}),switchTabActHistoryPause;function switchToRecentlyActiveTab(scope=1,dir){if(switchTabActHistoryPause)return;switchTabActHistoryPause=setTimeout(()=>{clearTimeout(switchTabActHistoryPause),switchTabActHistoryPause=void 0},120);let history2;if(scope===1&&(history2=Tabs2.getActiveTabsHistory()),scope===2){let panel=Sidebar.panelsById[Sidebar.activePanelId];if(!isTabsPanel(panel))return;history2=Tabs2.getActiveTabsHistory(panel.id)}if(!history2?.actTabs?.length)return;let offset=history2.actTabOffset;(offset===void 0||offset<0||offset>history2.actTabs.length)&&(history2.actTabOffset=history2.actTabs.length);let targetTabId,targetIdIndex,tabId;for(let i=history2.actTabOffset+dir;i>=0&&i<history2.actTabs.length;i+=dir)if(tabId=history2.actTabs[i],Tabs2.byId[tabId]&&tabId!==Tabs2.activeId){targetIdIndex=i,targetTabId=tabId;break}if(targetTabId!==void 0){if(dir<0&&targetIdIndex===history2.actTabs.length-1){let actTab=Tabs2.byId[Tabs2.activeId];(scope===1||scope===2&&actTab&&actTab.panelId===history2.id)&&history2.actTabs.push(Tabs2.activeId)}if(targetIdIndex!==void 0&&(history2.actTabOffset=targetIdIndex),Tabs2.skipActiveTabsHistoryCollecting(),tabId!==void 0){let tab=Tabs2.byId[tabId];tab&&(!tab.pinned||Settings.state.pinnedTabsPosition==="panel")&&tab.panelId!==Sidebar.activePanelId&&Sidebar.activatePanel(tab.panelId),browser.tabs.update(tabId,{active:!0}).catch(err3=>{err("Tabs.switchToRecentlyActiveTab: Cannot activate tab:",err3)})}}}function pringDbgInfo(reset3=!1){for(let tab of Tabs2.list)reset3?tab.reactive.title=tab.title:tab.reactive.title=`${tab.id} i${tab.index} p${tab.parentId} l${tab.lvl} ${tab.title}`}var updateTooltipBuf=new Map;function updateTooltipDebounced(tabId,delay){clearTimeout(updateTooltipBuf.get(tabId)),updateTooltipBuf.set(tabId,setTimeout(updateTooltip,delay,tabId))}function updateTooltip(tabId){updateTooltipBuf.delete(tabId);let tab=Tabs2.byId[tabId];tab&&(tab.reactive.tooltip=Settings.state.previewTabs?"":getTooltip(tab))}function getTooltip(tab){let decodedUrl;try{decodedUrl=decodeURI(tab.url)}catch{decodedUrl=tab.url}let str=`${tab.title}`;return Settings.state.tabsUrlInTooltip==="full"?str+=`
---
${decodedUrl}`:Settings.state.tabsUrlInTooltip==="stripped"&&(str+=`
---
${decodedUrl.split("?")[0]}`),str}var updateSuccesionTimeout;function updateSuccessionDebounced(delay,exclude){if(Settings.state.activateAfterClosing!=="none"){if(clearTimeout(updateSuccesionTimeout),!delay)return updateSuccession(exclude);updateSuccesionTimeout=setTimeout(()=>updateSuccession(exclude),delay)}}function updateSuccession(exclude){let activeTab=Tabs2.byId[Tabs2.activeId];if(activeTab){let target=Tabs2.findSuccessorTab(activeTab,exclude);if(target)return browser.tabs.moveInSuccession([activeTab.id],target.id).catch(err3=>{err("Tabs.updateSuccession: Cannot update succession:",err3)}),activeTab.successorTabId=target.id,target}}var tabs_fg_handlers_exports={};__export(tabs_fg_handlers_exports,{resetTabsListeners:()=>resetTabsListeners,setupTabsListeners:()=>setupTabsListeners});var favicons_fg_exports={};__export(favicons_fg_exports,{MAX_COUNT_LIMIT:()=>MAX_COUNT_LIMIT,SHARD_SIZE:()=>SHARD_SIZE,SIZE:()=>SIZE,fillIcon:()=>fillIcon,getFavPlaceholder:()=>getFavPlaceholder,getFavicon:()=>getFavicon,getIcon:()=>getIcon,initFavicons:()=>initFavicons,loadFavicons:()=>loadFavicons,loadFaviconsData:()=>loadFaviconsData,reactive:()=>reactive3,ready:()=>ready,resizeFavicon:()=>resizeFavicon,set:()=>set,waitForFaviconsReady:()=>waitForFaviconsReady});var MAX_COUNT_LIMIT=2e3,SHARD_SIZE=400;async function loadFaviconsData(){let keys=["favicons","favicons_01","favicons_02","favicons_03","favicons_04","favicons_05","favHashes","favDomains"],storage=await browser.storage.local.get(keys),fullList,RC4toRC52=!!storage.favicons;return storage.favicons_01?.length?(fullList=storage.favicons_01,storage.favicons_02?.length&&fullList.push(...storage.favicons_02),storage.favicons_03?.length&&fullList.push(...storage.favicons_03),storage.favicons_04?.length&&fullList.push(...storage.favicons_04),storage.favicons_05?.length&&fullList.push(...storage.favicons_05)):storage.favicons?.length&&(fullList=storage.favicons),(!fullList?.length||!storage.favHashes?.length||!storage.favDomains)&&(fullList=[],storage.favHashes=[],storage.favDomains={}),fullList.length>MAX_COUNT_LIMIT&&(fullList=fullList.slice(0,MAX_COUNT_LIMIT)),{favicons:fullList,favHashes:storage.favHashes,favDomains:storage.favDomains,RC4toRC5:RC4toRC52}}var SIZE=Math.trunc(16*window.devicePixelRatio),THRESHOLD_BYTES_DIFF=150*window.devicePixelRatio,favRescaleCanvas,favPrescaleCanvas,favRescaleCanvasCtx=null,favPrescaleCanvasCtx=null,favRescaleImg;async function resizeFavicon(fav){let ds=SIZE*2;if((!favRescaleCanvas||!favRescaleCanvasCtx)&&(favRescaleCanvas=createCanvas(SIZE,SIZE),favPrescaleCanvas=createCanvas(ds,ds),favRescaleCanvasCtx=favRescaleCanvas.getContext("2d"),favPrescaleCanvasCtx=favPrescaleCanvas.getContext("2d")),!favRescaleCanvasCtx||!favPrescaleCanvasCtx)return fav;favRescaleImg||(favRescaleImg=new Image),favRescaleCanvasCtx.clearRect(0,0,SIZE,SIZE),favPrescaleCanvasCtx.clearRect(0,0,ds,ds),await setImageSrc(favRescaleImg,fav);try{let sw=favRescaleImg.naturalWidth,sh=favRescaleImg.naturalHeight;if(sw===0||sh===0){let svgWithSize=setSvgImageSize(fav,ds,ds);if(!svgWithSize)return fav;await setImageSrc(favRescaleImg,svgWithSize),sw=favRescaleImg.naturalWidth,sh=favRescaleImg.naturalHeight}if(sw===0||sh===0)return fav;sw>ds&&favPrescaleCanvas?(favPrescaleCanvasCtx.drawImage(favRescaleImg,0,0,sw,sh,0,0,ds,ds),favRescaleCanvasCtx.drawImage(favPrescaleCanvas,0,0,ds,ds,0,0,SIZE,SIZE)):favRescaleCanvasCtx.drawImage(favRescaleImg,0,0,sw,sh,0,0,SIZE,SIZE)}catch{return fav}let newFav=favRescaleCanvas.toDataURL("image/png");return newFav.length+THRESHOLD_BYTES_DIFF>=fav.length?fav:newFav}function getFavPlaceholder(url){if(url.startsWith("m")){if(url.startsWith(GROUP_URL))return"#icon_group";if(url.startsWith(URL_URL))return"#icon_link_favicon";if(url.startsWith(SETUP_URL))return"#icon_settings"}if(IMG_RE.test(url))return"#icon_img";if(VID_RE.test(url))return"#icon_vid";if(MUS_RE.test(url))return"#icon_music";if(FILE_RE.test(url))return"#icon_local_file";if(url.startsWith("a")){if(url.startsWith("about:new")||url.startsWith("about:bla"))return"#icon_ff";if(url.startsWith("about:pre")||url.startsWith("about:con"))return"#icon_pref";if(url.startsWith("about:add"))return"#icon_addons";if(url.startsWith("about:per"))return"#icon_perf";if(url.startsWith("about:dev"))return"#icon_code";if(url.startsWith("about:proc"))return"#icon_perf";if(url.startsWith("about:prot"))return"#icon_dashboard";if(url.startsWith("about:debug"))return"#icon_dev"}return"#icon_ff"}var ready=!1,reactive3={byDomains:{}},reactFn5;function initFavicons(react){reactFn5=react,reactive3=reactFn5(reactive3)}async function loadFavicons(){let favData;try{favData=await loadFaviconsData()}catch(err3){return err("loadFavicons: Cannot get favicons",err3)}let byDomains={};for(let domain of Object.keys(favData.favDomains)){let domainInfo=favData.favDomains[domain];if(domainInfo.index===void 0)continue;let favicon=favData.favicons[domainInfo.index];favicon&&(byDomains[domain]=favicon)}if(reactive3.byDomains=byDomains,Info.isSidebar)for(let tab of Tabs2.list){if(tab?.internal||tab?.favIconUrl)continue;let domain=getDomainOf(tab.url),favicon=reactive3.byDomains[domain];favicon&&(tab.reactive.favIconUrl=tab.favIconUrl=favicon)}ready=!0,waitingForFavicons.forEach(cb=>cb()),waitingForFavicons=[]}var waitingForFavicons=[];async function waitForFaviconsReady(){if(!ready)return new Promise(ok=>{waitingForFavicons.push(ok)})}function set(domain,icon){reactive3.byDomains[domain]=icon}function getFavicon(url){return reactive3.byDomains[getDomainOf(url)]||""}function getIcon(url){return reactive3.byDomains[getDomainOf(url)]||getFavPlaceholder(url)}var iconFillCanvas,iconFillCanvasCtx=null,iconFillImg;async function fillIcon(icon,color){let ds=SIZE*2;if(!iconFillCanvas||!iconFillCanvasCtx)if(iconFillCanvas=createCanvas(ds,ds),iconFillCanvasCtx=iconFillCanvas.getContext("2d"),iconFillCanvasCtx)iconFillCanvasCtx.save();else return icon;iconFillImg||(iconFillImg=new Image),iconFillCanvasCtx.clearRect(0,0,ds,ds);try{await setImageSrc(iconFillImg,icon)}catch{return icon}try{let sw=iconFillImg.naturalWidth,sh=iconFillImg.naturalHeight;if(sw===0||sh===0){let svgWithSize=setSvgImageSize(icon,ds,ds);if(!svgWithSize)return icon;await setImageSrc(iconFillImg,svgWithSize),sw=iconFillImg.naturalWidth,sh=iconFillImg.naturalHeight}iconFillCanvasCtx.fillStyle=color,iconFillCanvasCtx.fillRect(0,0,ds,ds),iconFillCanvasCtx.globalCompositeOperation="destination-in",iconFillCanvasCtx.drawImage(iconFillImg,0,0,sw,sh,0,0,ds,ds),iconFillCanvasCtx.globalCompositeOperation="source-over"}catch{return icon}let filledIcon=iconFillCanvas.toDataURL("image/png");return iconFillCanvasCtx.restore(),filledIcon}var drag_and_drop_actions_exports={};__export(drag_and_drop_actions_exports,{initPointer:()=>initPointer,isDropEventConsumed:()=>isDropEventConsumed,onDragEnd:()=>onDragEnd,onDragEnter:()=>onDragEnter,onDragLeave:()=>onDragLeave,onDragMove:()=>onDragMove,onDrop:()=>onDrop,onPointerExpanded:()=>onPointerExpanded,reset:()=>reset2,resetOther:()=>resetOther,setActivePointer:()=>setActivePointer,start:()=>start2,updatePointerLeftPosition:()=>updatePointerLeftPosition});var lastDragStartTime=0;function start2(info2,dstType){if(info2.windowId===void 0&&(info2.windowId=Windows.id),info2.panelId===void 0&&(info2.panelId=Sidebar.activePanelId),lastDragStartTime=Date.now(),(info2.type===1||info2.type===31)&&info2.windowId===Windows.id&&info2.items&&info2.items.length>1&&info2.items.find(i=>i.id===Tabs2.activeId)){let dndIds=info2.items.map(i=>i.id);Tabs2.updateSuccessionDebounced(0,dndIds)}DnD.dropEventConsumed=!1,DnD.srcType=info2.type,DnD.isExternal=info2.windowId!==Windows.id,DnD.items=info2.items||[],DnD.startX=info2.x,DnD.startY=info2.y,DnD.srcIncognito=info2.incognito??!1,DnD.srcPin=info2.pinnedTabs??!1,DnD.srcWinId=info2.windowId,DnD.srcPanelId=info2.panelId,DnD.srcIndex=info2.index??-1,DnD.dropMode=info2.copy?"copy":"auto",DnD.reactive.dstPanelId=info2.panelId,DnD.inheritContainer=!!info2.inheritContainer,dstType&&(DnD.reactive.dstType=dstType),updateTooltip2(info2),DnD.reactive.isStarted=!0}function updateTooltip2(info2){if(info2.items)if(info2.type===1)if(info2.items.length===1)DnD.reactive.dragTooltipTitle=info2.items[0].title??"",DnD.reactive.dragTooltipInfo=info2.items[0].url??"";else{let label=translate("dnd.tooltip.tabs",info2.items.length);DnD.reactive.dragTooltipTitle=`${info2.items.length} ${label}`,DnD.reactive.dragTooltipInfo=""}else if(info2.type===2)if(info2.items.length===1)DnD.reactive.dragTooltipTitle=info2.items[0].title??"",DnD.reactive.dragTooltipInfo=info2.items[0].url??"";else{let label=translate("dnd.tooltip.bookmarks",info2.items.length);DnD.reactive.dragTooltipTitle=`${info2.items.length} ${label}`,DnD.reactive.dragTooltipInfo=""}else if(info2.type===32)DnD.reactive.dragTooltipTitle=translate("dnd.tooltip.bookmarks_panel"),DnD.reactive.dragTooltipInfo="";else if(info2.type===31){let panel=Sidebar.panelsById[info2.panelId??NOID];panel?.name?(DnD.reactive.dragTooltipTitle=`"${panel.name}" ${translate("dnd.tooltip.tabs_panel")}`,DnD.reactive.dragTooltipInfo=""):(DnD.reactive.dragTooltipTitle="---",DnD.reactive.dragTooltipInfo="")}else info2.type===3?(DnD.reactive.dragTooltipTitle=translate("dnd.tooltip.nav_item"),DnD.reactive.dragTooltipInfo=""):info2.type===11?(DnD.reactive.dragTooltipTitle=translate("dnd.tooltip.new_tab"),DnD.reactive.dragTooltipInfo=""):info2.type===5?(DnD.reactive.dragTooltipTitle=info2.items[0].title??"",DnD.reactive.dragTooltipInfo=info2.items[0].url??""):(DnD.reactive.dragTooltipTitle="---",DnD.reactive.dragTooltipInfo="")}function reset2(){DnD.srcType=0,DnD.isExternal=!1,DnD.items=[],DnD.startX=0,DnD.startY=0,DnD.srcIncognito=!1,DnD.srcPin=!1,DnD.srcWinId=NOID,DnD.srcPanelId=NOID,DnD.srcIndex=-1,DnD.dropMode="auto",DnD.inheritContainer=!1,DnD.reactive.dstIndex=-1,DnD.reactive.dstPanelId="",DnD.reactive.dstPin=!1,DnD.reactive.dstParentId="",DnD.reactive.isStarted=!1,resetExpandTimeout(),resetTabActivateTimeout(),resetPanelSwitchTimeout(),resetSubPanelOpenTimeout()}function resetDragPointer(){pointerEl&&(pointerEl.style.transform="translateY(0px)"),DnD.reactive.pointerMode=0,DnD.reactive.pointerExpanding=!1,DnD.reactive.pointerLvl=0,DnD.reactive.pointerHover=!1,xLock=!1,yLock=!1,pointerPos=0,dropLvlOffset=0,prevDropLvlOffset=0,dropPos=0,inPointerArea=!1}var _expandTimeout;function expandTimeout(cb,delay){if(clearTimeout(_expandTimeout),delay===0)return cb();delay&&delay<0||(_expandTimeout=setTimeout(()=>cb(),delay??Settings.state.dndExpDelay))}function resetExpandTimeout(){clearTimeout(_expandTimeout)}var _tabActivateTimeout;function tabActivateTimeout(cb,delay){if(clearTimeout(_tabActivateTimeout),delay===0)return cb();delay<0||(_tabActivateTimeout=setTimeout(()=>cb(),delay))}function resetTabActivateTimeout(){clearTimeout(_tabActivateTimeout)}var _panelSwitchTimeout;function panelSwitchTimeout(cb,delay){if(clearTimeout(_panelSwitchTimeout),delay===0)return cb();delay<0||(_panelSwitchTimeout=setTimeout(()=>cb(),delay))}function resetPanelSwitchTimeout(){clearTimeout(_panelSwitchTimeout)}var _subPanelOpenTimeout;function subPanelOpenTimeout(cb,delay){if(clearTimeout(_subPanelOpenTimeout),delay===0)return cb();delay<0||(_subPanelOpenTimeout=setTimeout(()=>cb(),delay))}function resetSubPanelOpenTimeout(){clearTimeout(_subPanelOpenTimeout)}function getDestInfo(){let info2={panelId:DnD.reactive.dstPanelId,parentId:DnD.reactive.dstParentId,index:DnD.reactive.dstIndex},toTabs=DnD.reactive.dstType===1;DnD.reactive.dstPin?info2.pinned=!0:toTabs&&(info2.pinned=!1);let dstPanel;if(info2.panelId===Sidebar.subPanels.bookmarks?.id?dstPanel=Sidebar.subPanels.bookmarks:dstPanel=Sidebar.panelsById[DnD.reactive.dstPanelId],!dstPanel)return info2;if(isTabsPanel(dstPanel)&&(Containers.reactive.byId[dstPanel.dropTabCtx??""]?info2.containerId=dstPanel.dropTabCtx:DnD.inheritContainer||(info2.containerId=CONTAINER_ID)),info2.index===-1){if(info2.inside=!0,isTabsPanel(dstPanel)&&(toTabs||DnD.reactive.dstType===31)){let parent=Tabs2.byId[DnD.reactive.dstParentId];if(parent){let branchLen=Tabs2.getBranchLen(parent.id)??0;info2.index=parent.index+branchLen+1}else info2.index=dstPanel.nextTabIndex??Tabs2.list.length}else if(DnD.reactive.dstType===2||DnD.reactive.dstType===32||DnD.reactive.dstType===41){let parent=Bookmarks.reactive.byId[DnD.reactive.dstParentId];info2.index=parent?.children?.length||0}}return info2}function getSrcInfo(){return{windowId:DnD.srcWinId,panelId:DnD.srcPanelId,pinned:DnD.srcPin}}function assertExpandMod(e){return Settings.state.dndExpMod==="alt"&&e.altKey||Settings.state.dndExpMod==="shift"&&e.shiftKey?!0:!!(Settings.state.dndExpMod==="ctrl"&&e.ctrlKey)}function assertTabActivateMod(e){return Settings.state.dndTabActMod==="alt"&&e.altKey||Settings.state.dndTabActMod==="shift"&&e.shiftKey?!0:!!(Settings.state.dndTabActMod==="ctrl"&&e.ctrlKey)}function applyLvlOffset(lvl){lvl<0&&(lvl=0);let panel;if(Sidebar.subPanelActive&&Sidebar.subPanelType===2?panel=Sidebar.subPanels.bookmarks:panel=Sidebar.panelsById[DnD.reactive.dstPanelId],!panel)return;let parentBounds=panel.bounds?.find(b=>b.id===DnD.reactive.dstParentId),prevParentBounds;if(parentBounds&&parentBounds.lvl>=lvl){for(;parentBounds&&parentBounds.lvl>=lvl;)prevParentBounds=parentBounds,parentBounds=panel.bounds?.find(b=>b.id===parentBounds?.parent);if(parentBounds)DnD.reactive.dstParentId=parentBounds.id,prevParentBounds&&DnD.reactive.dstPanelId==="bookmarks"&&(DnD.reactive.dstIndex=prevParentBounds.index+1);else if(isTabsPanel(panel))DnD.reactive.dstParentId=-1;else if(isBookmarksPanel(panel)){panel.rootId!==NOID&&panel.rootId!==BKM_ROOT_ID?DnD.reactive.dstParentId=panel.rootId:DnD.reactive.dstParentId=BKM_OTHER_ID;let dstParent=Bookmarks.reactive.byId[DnD.reactive.dstParentId];dstParent&&(DnD.reactive.dstIndex=dstParent.children?.length??-1)}}}function isNativeTabs(event){return event.dataTransfer?event.dataTransfer.types.includes("text/x-moz-text-internal"):!1}function isContainerChanged(){if(DnD.srcIncognito!==Windows.incognito)return!0;if(Windows.incognito)return!1;let dstPanel=Sidebar.panelsById[DnD.reactive.dstPanelId],destContainer;if(isTabsPanel(dstPanel)&&(destContainer=dstPanel.dropTabCtx),!destContainer||!(destContainer===CONTAINER_ID||Containers.reactive.byId[destContainer])||DnD.reactive.dstPin&&Settings.state.pinnedTabsPosition!=="panel")return!1;for(let item of DnD.items)if(item.container!==destContainer)return!0;return!1}function onDragEnter(e){if(!e.target.getAttribute)return;if(!DnD.reactive.isStarted&&!e?.relatedTarget){if(!e.dataTransfer?.items.length)return;let dndInfo=e.dataTransfer?.getData("application/x-sidebery-dnd");if(Sidebar.updateBounds(),dndInfo){let info2;try{info2=JSON.parse(dndInfo)}catch{return}if(DnD.start(info2,1),DnD.srcType===31||DnD.srcType===32)Selection.selectNavItem(DnD.srcPanelId);else for(let item of DnD.items)DnD.srcType===1?Selection.selectTab(item.id):DnD.srcType===2&&Selection.selectBookmark(item.id)}else{let leftOffset=Sidebar.panelsById[Sidebar.activePanelId]?.leftOffset??0;DnD.start({x:(Sidebar.width>>1)+leftOffset,y:e.clientX,type:4,panelId:NOID,windowId:NOID})}return}let type=e.target.getAttribute("data-dnd-type"),id=e.target.getAttribute("data-dnd-id");if(DnD.reactive.pointerHover=!1,resetPanelSwitchTimeout(),resetSubPanelOpenTimeout(),resetTabActivateTimeout(),resetExpandTimeout(),!type&&!id){DnD.reactive.dstType=0,DnD.reactive.dstPin=!1;return}if(type==="bspb"){DnD.reactive.dstPin=!1;let panel=Sidebar.panelsById[Sidebar.activePanelId];if(!isTabsPanel(panel)){DnD.reactive.dstType=0;return}panel.bookmarksFolderId!==NOID&&panel.bookmarksFolderId!==BKM_ROOT_ID?DnD.reactive.dstParentId=panel.bookmarksFolderId:DnD.reactive.dstParentId=BKM_OTHER_ID,DnD.reactive.dstPanelId=panel.id,DnD.reactive.dstType=41,DnD.reactive.dstIndex=0,subPanelOpenTimeout(()=>Sidebar.openSubPanel(2,panel),500)}if(type==="nav-item"&&id)if(DnD.reactive.dstPin=!1,DnD.reactive.dstParentId=NOID,id==="hidden_panels_btn")DnD.reactive.dstType=0,DnD.reactive.dstPanelId=NOID,Sidebar.reactive.hiddenPanelsPopup||panelSwitchTimeout(()=>Sidebar.openHiddenPanelsPopup(),250);else{Sidebar.reactive.hiddenPanelsPopup&&(Sidebar.reactive.hiddenPanelsPopup=!1);let panel=Sidebar.panelsById[id],isTabsPanel2=isTabsPanel(panel),isBookmarksPanel2=isBookmarksPanel(panel);isTabsPanel2?DnD.reactive.dstType=31:isBookmarksPanel2?DnD.reactive.dstType=32:DnD.reactive.dstType=3,panel?DnD.reactive.dstPanelId=panel.id??NOID:id==="add_tp"&&(DnD.reactive.dstPanelId=id),DnD.reactive.dstIndex=Sidebar.reactive.nav.indexOf(id),!(DnD.srcType===3||DnD.srcType===31||DnD.srcType===32)&&(isTabsPanel2||isBookmarksPanel2)&&panelSwitchTimeout(()=>Sidebar.switchToPanel(id),750)}if(type==="hidden-panel"&&id&&(DnD.reactive.dstType=31,DnD.reactive.dstPanelId=id,DnD.reactive.dstIndex=Sidebar.reactive.nav.indexOf(id)),type==="hidden-layer"&&DnD.reactive.dstPanelId!==NOID&&Sidebar.reactive.hiddenPanelsPopup&&Sidebar.closeHiddenPanelsPopup(!0),type==="pinned-bar"){let isPinnedTabsGlobal=Settings.state.pinnedTabsPosition!=="panel";if(DnD.reactive.dstPin=!0,DnD.reactive.dstPanelId=id??NOID,isPinnedTabsGlobal){let pinnedTabsLen=Tabs2.pinned.length,lastPinnedTab=Tabs2.list[pinnedTabsLen-1];DnD.reactive.dstIndex=pinnedTabsLen,DnD.reactive.dstPanelId=lastPinnedTab?.panelId??NOID}else{let panel=Sidebar.panelsById[DnD.reactive.dstPanelId];if(isTabsPanel(panel)&&panel.pinnedTabs.length){let lastTab=panel.pinnedTabs[panel.pinnedTabs.length-1];lastTab&&(DnD.reactive.dstIndex=lastTab.index+1)}}}if(type==="tab"&&id){Sidebar.reactive.hiddenPanelsPopup&&(Sidebar.reactive.hiddenPanelsPopup=!1);let tab=Tabs2.byId[id];if(!tab)return;if(DnD.reactive.dstType=1,DnD.reactive.dstPin=tab.pinned,tab.pinned?DnD.reactive.dstIndex=tab.index:DnD.reactive.dstPanelId=tab.panelId,Settings.state.dndTabAct&&tab.pinned){let delay=assertTabActivateMod(e)?0:Settings.state.dndTabActDelay;tabActivateTimeout(()=>browser.tabs.update(tab.id,{active:!0}),delay)}}if(type==="bookmark"&&id){if(Sidebar.reactive.hiddenPanelsPopup&&(Sidebar.reactive.hiddenPanelsPopup=!1),!Bookmarks.reactive.byId[id])return;let dstPanel;Sidebar.subPanelActive?dstPanel=Sidebar.subPanels.bookmarks:dstPanel=Sidebar.panelsById[Sidebar.activePanelId];let panelId=dstPanel?.id;DnD.reactive.dstType=2,DnD.reactive.dstPanelId=panelId??NOID,DnD.reactive.dstPin=!1}}function onDragLeave(e){e?.relatedTarget||(Sidebar.reactive.hiddenPanelsPopup&&(Sidebar.reactive.hiddenPanelsPopup=!1),Selection.resetSelection(),resetDragPointer(),reset2())}function onPointerEnter(e){if(resetTabActivateTimeout(),DnD.reactive.pointerMode!==2)return;let panel;Sidebar.subPanelActive?panel=Sidebar.subPanels.bookmarks:panel=Sidebar.panelsById[DnD.reactive.dstPanelId];let isTabs2=isTabsPanel(panel),isBookmarks2=isBookmarksPanel(panel);if(isTabs2){if(Settings.state.dndExp==="pointer"){let delay=assertExpandMod(e)?0:Settings.state.dndExpDelay,tab=Tabs2.byId[DnD.reactive.dstParentId];if(!tab||!tab.isParent)return;delay!==0&&(DnD.reactive.pointerHover=!0),expandTimeout(()=>{DnD.reactive.pointerHover=!1,DnD.reactive.pointerExpanding=!0,Tabs2.toggleBranch(tab.id),Sidebar.updatePanelBoundsDebounced(128)},delay)}return}if(isBookmarks2){if(Settings.state.dndExp==="pointer"){let delay=assertExpandMod(e)?0:Settings.state.dndExpDelay,bookmark=Bookmarks.reactive.byId[DnD.reactive.dstParentId],isParent=!!bookmark?.children?.length;if(!bookmark||!isParent)return;delay!==0&&(DnD.reactive.pointerHover=!0),expandTimeout(()=>{DnD.reactive.pointerHover=!1,DnD.reactive.pointerExpanding=!0,Bookmarks.toggleBranch(bookmark.id,Sidebar.activePanelId),Sidebar.updatePanelBoundsDebounced(128)},delay)}return}}var pointers=new Map;function initPointer(el,panelId){if(!el)return err("Drag and Drop: No pointer element");pointers.set(panelId,el)}var pointerEl=null;function setActivePointer(panelId){let el=pointers.get(panelId);el?pointerEl=el:pointerEl=null}function updatePointerLeftPosition(left){DnD.reactive.pointerLeft=left}function onPointerExpanded(){DnD.reactive.pointerExpanding=!1}var xLock=!1,yLock=!1,pointerPos=0,dropLvlOffset=0,prevDropLvlOffset=0,dropPos=0,inPointerArea=!1,prevEventKeys={alt:!1,ctrl:!1,shift:!1},path=[];function onDragMove(e){if(!DnD.reactive.isStarted||!pointerEl||Sidebar.reactive.hiddenPanelsPopup)return;let panel;if(Sidebar.subPanelActive&&Sidebar.subPanelType===2&&Sidebar.subPanels.bookmarks?panel=Sidebar.subPanels.bookmarks:panel=Sidebar.panelsById[Sidebar.activePanelId],!panel||!panel.scrollEl)return;let altKeyChanged=prevEventKeys.alt!==e.altKey,shiftKeyChanged=prevEventKeys.shift!==e.shiftKey,ctrlKeyChanged=prevEventKeys.ctrl!==e.ctrlKey,eventKeyChanged=altKeyChanged||shiftKeyChanged||ctrlKeyChanged;if(prevEventKeys.alt=e.altKey,prevEventKeys.shift=e.shiftKey,prevEventKeys.ctrl=e.ctrlKey,altKeyChanged&&!e.altKey||shiftKeyChanged&&!e.shiftKey||ctrlKeyChanged&&!e.ctrlKey)return;eventKeyChanged&&(xLock||yLock)&&onDragEnter(e);let boundsLen=panel.bounds?.length??0,bounds=panel.bounds,scroll=panel.scrollEl.scrollTop??0,panelTopOffset=panel.topOffset??0,panelRightOffset=panel.rightOffset??0,panelBottomOffset=panel.bottomOffset??0,y=e.clientY-panelTopOffset+scroll,x=e.clientX-(panel.leftOffset??0);if(!yLock&&(e.clientY<panelTopOffset||e.clientY>panelBottomOffset)){DnD.reactive.pointerMode=0,yLock=!0;return}if(yLock&&e.clientY>panelTopOffset&&e.clientY<panelBottomOffset&&DnD.reactive.pointerMode===0&&(yLock=!1,xLock||(pointerPos--,DnD.reactive.pointerMode=1)),!xLock&&(x<0||e.clientX>panelRightOffset)){DnD.reactive.pointerMode=0,xLock=!0;return}if(xLock&&x>0&&e.clientX<panelRightOffset&&DnD.reactive.pointerMode===0&&(xLock=!1,yLock||(pointerPos--,DnD.reactive.pointerMode=1)),xLock||yLock)return;dropLvlOffset=~~((e.clientX-DnD.startX)/12);let lvlChanged=prevDropLvlOffset!==dropLvlOffset;if(prevDropLvlOffset=dropLvlOffset,x>0&&x<32&&(!inPointerArea||eventKeyChanged)){inPointerArea=!0,onPointerEnter(e);return}else x>32&&inPointerArea&&(inPointerArea=!1,DnD.reactive.pointerHover=!1,pointerPos--,resetExpandTimeout());if(boundsLen===0){if(dropPos=-12,pointerPos!==dropPos){pointerPos=dropPos,pointerEl.style.transform=`translateY(${pointerPos}px)`,DnD.reactive.pointerMode=1,DnD.reactive.pointerLvl=0;let activePanel=Sidebar.panelsById[Sidebar.activePanelId];DnD.reactive.dstIndex=isTabsPanel(activePanel)?activePanel.startTabIndex:-1,DnD.reactive.dstParentId=-1}return}if(y>bounds[boundsLen-1].bottom){let slot=bounds[boundsLen-1];dropPos=slot.end-12,(lvlChanged||pointerPos!==dropPos)&&(resetTabActivateTimeout(),pointerPos=dropPos,pointerEl.style.transform=`translateY(${pointerPos}px)`,DnD.reactive.pointerMode=1,DnD.reactive.pointerLvl=dropLvlOffset<0?slot.lvl+dropLvlOffset:slot.lvl,DnD.reactive.dstIndex=slot.folded?-1:slot.index+1,DnD.reactive.dstParentId=slot.parent);return}for(let slot,i=0;i<boundsLen;i++)if(slot=bounds[i],y>slot.end&&(path[slot.lvl]=slot),!(!lvlChanged&&(y>slot.end||y<slot.start))){if(slot.in?y<slot.top:y<slot.center){if(i===0?dropPos=-12:dropPos=slot.start-12,lvlChanged||pointerPos!==dropPos){resetTabActivateTimeout(),pointerPos=dropPos,pointerEl.style.transform=`translateY(${pointerPos}px)`;let prevSlot=bounds[i-1];if(!prevSlot){DnD.reactive.pointerLvl=0,DnD.reactive.pointerMode=1,DnD.reactive.dstIndex=slot.index,DnD.reactive.dstParentId=-1;break}let slotIsTab=slot.type===1,node=slotIsTab?Tabs2.byId[slot.id]:Bookmarks.reactive.byId[slot.id];if((slotIsTab?Tabs2.byId[prevSlot.id]:Bookmarks.reactive.byId[prevSlot.id])?.sel&&node?.sel?DnD.reactive.pointerMode=0:DnD.reactive.pointerMode=1,prevSlot.id===slot.parent)DnD.reactive.pointerLvl=prevSlot.lvl+1,DnD.reactive.dstIndex=slot.index,DnD.reactive.dstParentId=slot.parent;else{let lvl=prevSlot.lvl;prevSlot.lvl>slot.lvl&&lvlChanged&&dropLvlOffset<0&&(lvl=prevSlot.lvl+dropLvlOffset,lvl>prevSlot.lvl&&(lvl=prevSlot.lvl),lvl<slot.lvl&&(lvl=slot.lvl));let parentSlot=path[lvl-1],index=-1;DnD.reactive.dstType===1&&(index=slot.index),DnD.reactive.dstType===2&&(prevSlot.lvl===slot.lvl?index=prevSlot.index+1:lvl===slot.lvl&&(index=slot.index)),DnD.reactive.pointerLvl=lvl,DnD.reactive.dstIndex=index,DnD.reactive.dstParentId=parentSlot?.id??NOID}}break}if(slot.in&&y<slot.bottom){if(dropPos=slot.center-12,pointerPos!==dropPos||eventKeyChanged){if(pointerPos=dropPos,pointerEl.style.transform=`translateY(${pointerPos}px)`,Selection.includes(slot.id)?DnD.reactive.pointerMode=0:DnD.reactive.pointerMode=2,DnD.reactive.pointerLvl=slot.lvl+1,DnD.reactive.dstIndex=-1,DnD.reactive.dstParentId=slot.id,x<32&&Settings.state.dndExp==="pointer"){onPointerEnter(e);break}if(DnD.reactive.dstType===1){let targetId2=slot.id;if(Settings.state.dndTabAct){let delay=assertTabActivateMod(e)?0:Settings.state.dndTabActDelay;tabActivateTimeout(()=>browser.tabs.update(targetId2,{active:!0}),delay)}if(Settings.state.dndExp==="hover"){let delay=assertExpandMod(e)?0:Settings.state.dndExpDelay;expandTimeout(()=>{Tabs2.toggleBranch(targetId2),Sidebar.updatePanelBoundsDebounced(128)},delay)}}if(DnD.reactive.dstType===2){let targetId2=slot.id;if(!!Bookmarks.reactive.byId[targetId2].children?.length&&Settings.state.dndExp==="hover"){let delay=assertExpandMod(e)?0:Settings.state.dndExpDelay;expandTimeout(()=>{Bookmarks.toggleBranch(targetId2,Sidebar.activePanelId),Sidebar.updatePanelBoundsDebounced(128)},delay)}}}break}}let locOffset=y-scroll;locOffset<PRE_SCROLL?panel.scrollEl.scrollTop=scroll-(PRE_SCROLL-locOffset):locOffset>panel.scrollEl.offsetHeight-PRE_SCROLL&&(panel.scrollEl.scrollTop=scroll+(locOffset-(panel.scrollEl.offsetHeight-PRE_SCROLL)))}var dropEventWasConsumedTimeout;function dropEventWasConsumed(){DnD.dropEventConsumed=!0,clearTimeout(dropEventWasConsumedTimeout),dropEventWasConsumedTimeout=setTimeout(()=>{DnD.dropEventConsumed=!1},1500)}function isDropEventConsumed(){return DnD.dropEventConsumed}async function onDrop(e){if(dropEventWasConsumed(),e.ctrlKey&&(DnD.dropMode="copy"),isNativeTabs(e)){let result=await parseDragEvent(e,Windows.lastFocusedId);if(result?.matchedNativeTabs?.length&&result.matchedNativeTabs?.length){let firstTab=result.matchedNativeTabs[0];DnD.srcWinId=firstTab.windowId,DnD.srcIncognito=firstTab.incognito,DnD.srcIndex=firstTab.index,DnD.srcPanelId=NOID,DnD.srcPin=firstTab.pinned,DnD.srcType=1,DnD.items=result.matchedNativeTabs.map(tab=>({id:tab.id,container:tab.cookieStoreId,pinned:tab.pinned,title:tab.title,url:tab.url}))}}let srcType=DnD.srcType,dstType=DnD.reactive.dstType,fromTabs=srcType===1,toTabs=dstType===1,fromTabsPanel=srcType===31,toTabsPanel=dstType===31,fromBookmarks=srcType===2,toBookmarks=dstType===2,fromBookmarksPanel=srcType===32,toBookmarksPanel=dstType===32||dstType===41,fromNav=srcType===3,toNav=dstType===3,fromNewTabBar=srcType===11,fromHistory=srcType===5;if(Sidebar.reactive.hiddenPanelsPopup&&Sidebar.closeHiddenPanelsPopup(),(toTabs&&!DnD.reactive.dstPin||toBookmarks)&&(Sidebar.subPanelActive&&Sidebar.subPanels.bookmarks?DnD.reactive.dstPanelId=Sidebar.subPanels.bookmarks.id:DnD.reactive.dstPanelId=Sidebar.activePanelId,applyLvlOffset(DnD.reactive.pointerLvl)),fromNewTabBar&&toTabs){let dstInfo=getDestInfo(),item=DnD.items[0];dstInfo.containerId=item.container??CONTAINER_ID;let newTabConf={id:NOID,url:item.url??"about:newtab",active:!0};await Tabs2.open([newTabConf],dstInfo)}let tabsPanelsSaveNeeded=!1,newTabPanel;if(DnD.reactive.dstPanelId==="add_tp"&&(fromTabs||fromBookmarks)){newTabPanel=Sidebar.createTabsPanel({color:getRandomFrom(COLOR_NAMES)});let index=Sidebar.getIndexForNewTabsPanel();Sidebar.addPanel(index,newTabPanel),Sidebar.recalcPanels(),Sidebar.recalcTabsPanels(),DnD.reactive.dstPanelId=newTabPanel.id,DnD.reactive.dstIndex=newTabPanel.nextTabIndex,toTabsPanel=!0,tabsPanelsSaveNeeded=!0}toTabsPanel&&!fromTabsPanel&&!fromBookmarksPanel&&!fromNav&&(DnD.reactive.dstIndex=-1);let setTabsPanelFolder=!1;if(toBookmarksPanel&&!fromTabsPanel&&!fromBookmarksPanel&&!fromNav){DnD.reactive.dstIndex=-1;let panel=Sidebar.panelsById[DnD.reactive.dstPanelId];if(isBookmarksPanel(panel)){let existedFolder=Bookmarks.reactive.byId[panel.rootId];DnD.reactive.dstParentId=existedFolder?panel.rootId:BKM_OTHER_ID}else if(isTabsPanel(panel)){let parentId;panel.bookmarksFolderId!==NOID&&panel.bookmarksFolderId!==BKM_ROOT_ID&&Bookmarks.reactive.byId[panel.bookmarksFolderId]?parentId=panel.bookmarksFolderId:(parentId=BKM_OTHER_ID,setTabsPanelFolder=!0),DnD.reactive.dstParentId=parentId;let parentFolder=Bookmarks.reactive.byId[parentId??NOID];parentFolder?.children?.length?DnD.reactive.dstIndex=parentFolder.children.length:DnD.reactive.dstIndex=0}}if(fromTabs&&toTabs||fromTabs&&toTabsPanel||fromTabsPanel&&toTabs){let srcInfo=getSrcInfo(),dstInfo=getDestInfo(),reopenNeeded=isContainerChanged();DnD.dropMode==="copy"?await Tabs2.open(DnD.items,dstInfo):reopenNeeded?await Tabs2.reopen(DnD.items,dstInfo):await Tabs2.move(DnD.items,srcInfo,dstInfo)}if(fromTabs&&toBookmarks||fromTabs&&toBookmarksPanel||fromTabsPanel&&toBookmarks){let panel=Sidebar.panelsById[DnD.reactive.dstPanelId],bookmarksWasUnloaded=!Bookmarks.reactive.tree.length,copyMode=DnD.dropMode==="copy",dstInfo=getDestInfo(),items=DnD.items,toRemove=Settings.state.dndMoveTabs&&DnD.items.map(t=>t.id);if(setTabsPanelFolder&&isTabsPanel(panel)&&!await setFolderForTabsPanel(panel,dstInfo)){resetDragPointer(),DnD.resetOther(),DnD.reset(),Selection.resetSelection();return}if(!await Bookmarks.prepareBookmarks())return;if(dstInfo.index===0&&bookmarksWasUnloaded&&toBookmarksPanel){let parent=Bookmarks.reactive.byId[dstInfo.parentId??NOID];parent?.children?.length&&(dstInfo.index=parent.children.length)}await Bookmarks.createFrom(items,dstInfo),toRemove&&!copyMode&&Tabs2.removeTabs(toRemove,!0)}if(fromBookmarks&&toTabs||fromBookmarks&&toTabsPanel||fromBookmarksPanel&&toTabs){let dst=getDestInfo(),ids=DnD.items.map(i=>i.id),copyMode=DnD.dropMode==="copy",ok=!0,panel=Sidebar.panelsById[dst.panelId??NOID];dst.index===-1&&isTabsPanel(panel)&&(dst.index=panel.nextTabIndex);try{await Bookmarks.open(ids,dst)}catch(err3){ok=!1,err("onDrop: Cannot open bookmark[s]",err3),newTabPanel&&Sidebar.removePanel(newTabPanel.id,{tabsMode:"close"})}ok&&Settings.state.dndMoveBookmarks&&!copyMode&&Bookmarks.removeBookmarks(ids,{noNotif:!0,noWarn:!0}),newTabPanel&&Sidebar.activatePanel(newTabPanel.id)}if(fromBookmarks&&toBookmarks){let dstPanel;Sidebar.subPanelActive&&Sidebar.subPanelType===2?dstPanel=Sidebar.subPanels.bookmarks:dstPanel=Sidebar.panelsById[Sidebar.activePanelId];let dst=getDestInfo();if(isBookmarksPanel(dstPanel)&&dstPanel.viewMode==="tree")if(DnD.dropMode==="copy")Bookmarks.createFrom(DnD.items,dst);else{let ids=DnD.items.map(i=>i.id);Bookmarks.move(ids,dst)}}(fromHistory&&toTabs||fromHistory&&toTabsPanel)&&Tabs2.open(DnD.items,getDestInfo()),(fromTabsPanel||fromBookmarksPanel||fromNav)&&(toTabsPanel||toBookmarksPanel||toNav)&&Sidebar.moveNavItem(DnD.srcIndex,DnD.reactive.dstIndex),srcType===4&&(toTabs||toTabsPanel)&&Tabs2.createFromDragEvent(e,getDestInfo()),srcType===4&&(toBookmarks||toBookmarksPanel)&&Bookmarks.createFromDragEvent(e,getDestInfo()),resetDragPointer(),DnD.resetOther(),DnD.reset(),Selection.resetSelection(),tabsPanelsSaveNeeded&&Sidebar.saveSidebar()}async function setFolderForTabsPanel(panel,dst){if(!isTabsPanel(panel)||Bookmarks.reactive.byId[panel.bookmarksFolderId])return!0;let result=await Bookmarks.openBookmarksPopup({title:translate("popup.bookmarks.set_folder_for_tabs_panel"),name:panel.name,nameField:!0,location:BKM_MENU_ID,locationField:!0,locationTree:!0,controls:[{label:"btn.save"}]});if(result&&Bookmarks.reactive.byId[result.location??NOID]){let parentId=result.location??NOID,parent=Bookmarks.reactive.byId[parentId],index=parent.children?.length??0;if(parent&&result.name){let rootFolder;try{rootFolder=await browser.bookmarks.create({type:"folder",title:result.name.trim(),parentId,index})}catch(err3){err("DnD.onDrop: Cannot set folder for tabs panel",err3)}if(rootFolder)return panel.bookmarksFolderId=rootFolder.id,Sidebar.saveSidebar(),dst.parentId=rootFolder.id,dst.index=0,!0}}}var resetOtherTimeout;function resetOther(){clearTimeout(resetOtherTimeout),resetOtherTimeout=setTimeout(()=>{broadcast({dstType:2,action:"stopDrag"})},150)}var dragEndedRecentlyTimeout;async function onDragEnd(e){resetDragPointer(),DnD.resetOther();let mode=DnD.dropMode;if(DnD.reactive.isStarted&&DnD.reset(),Selection.resetSelection(),e.ctrlKey&&(mode="copy"),!DnD.dropEventConsumed&&e.dataTransfer?.types.length===1&&Date.now()-lastDragStartTime>150){let dndInfoStr=e.dataTransfer?.getData("application/x-sidebery-dnd"),requestingDropStatus=[];for(let win of Windows.otherWindows)win.id&&requestingDropStatus.push(sidebar(win.id,"isDropEventConsumed"));let consumed;try{consumed=await Promise.all(requestingDropStatus)}catch(err3){err("DnD.onDragEnd: Cannot get drop status from other windows",err3);return}if(consumed?.includes(!0)||!dndInfoStr)return;let info2;try{info2=JSON.parse(dndInfoStr)}catch{return}let fromTabs=info2.type===1,fromTabsPanel=info2.type===31,fromBookmarks=info2.type===2,fromBookmarksPanel=info2.type===32;if(fromTabs&&info2.items?.length){let dst={windowId:NEWID,incognito:Windows.incognito,panelId:info2.panelId};mode==="copy"?Tabs2.open(info2.items,dst):Tabs2.move(info2.items,{},dst)}if(fromTabsPanel&&info2.items?.length){let dst={windowId:NEWID,incognito:Windows.incognito,panelId:info2.panelId};mode==="copy"?Tabs2.open(info2.items,dst):Tabs2.move(info2.items,{},dst)}if(fromBookmarks&&info2.items?.length&&Bookmarks.openInNewWindow(info2.items.map(i=>i.id)),fromBookmarksPanel&&info2.items?.length){let panelId=info2.items[0]?.id??NOID,panel=Sidebar.panelsById[panelId];if(!isBookmarksPanel(panel))return;Bookmarks.reactive.tree.length||await Bookmarks.load();let rootFolder=Bookmarks.reactive.byId[panel.rootId];if(!rootFolder||!rootFolder.children?.length)return;Bookmarks.openInNewWindow(rootFolder.children.map(n=>n.id))}}DnD.dragEndedRecently=!0,clearTimeout(dragEndedRecentlyTimeout),dragEndedRecentlyTimeout=setTimeout(()=>{DnD.dragEndedRecently=!1},100);let successionExclude=Tabs2.detachingTabIds.length?[...Tabs2.detachingTabIds]:void 0;Tabs2.updateSuccessionDebounced(0,successionExclude)}var DndPointerModeNames={0:"none",1:"between",2:"inside"},DnD={reactive:{isStarted:!1,pointerExpanding:!1,pointerMode:0,pointerLvl:0,pointerHover:!1,pointerLeft:0,dstType:0,dstIndex:-1,dstParentId:NOID,dstPanelId:NOID,dstPin:!1,dragTooltipTitle:"",dragTooltipInfo:""},dropEventConsumed:!1,dropMode:"auto",inheritContainer:!1,items:[],isExternal:!1,goOutside:!1,startX:0,startY:0,srcType:0,srcIncognito:!1,srcPin:!1,srcWinId:NOID,srcPanelId:NOID,srcIndex:-1,dragEndedRecently:!1,...drag_and_drop_actions_exports};var styles_actions_exports={};__export(styles_actions_exports,{applyThemeSrcVars:()=>applyThemeSrcVars,convertVarsToCSS:()=>convertVarsToCSS,getColorSchemeName:()=>getColorSchemeName,getCustomCSS:()=>getCustomCSS,getSystemColorScheme:()=>getSystemColorScheme,hasCustomCSS:()=>hasCustomCSS,initColorScheme:()=>initColorScheme,loadCustomCSS:()=>loadCustomCSS,loadCustomGroupCSS:()=>loadCustomGroupCSS,loadCustomSidebarCSS:()=>loadCustomSidebarCSS,removeCustomCSS:()=>removeCustomCSS,resetThemeSrcVars:()=>resetThemeSrcVars,saveStylesToSync:()=>saveStylesToSync,setCustomCSS:()=>setCustomCSS,setupListeners:()=>setupListeners4,updateColorScheme:()=>updateColorScheme,upgradeCustomStyles:()=>upgradeCustomStyles});var SRC_VARS=["frame_bg","frame_fg","toolbar_bg","toolbar_fg","toolbar_border","act_el_bg","act_el_fg","act_el_border","popup_bg","popup_fg","popup_border","accent","top_padding","darker_border_width"],PREF_DARK_MEDIA="(prefers-color-scheme: dark)",darkMedia;async function initColorScheme(){await updateColorScheme(),setupAutoColorSchemeListener(()=>updateColorScheme()),browser.theme.onUpdated.addListener(upd=>{if(!(upd&&upd.windowId!==void 0&&Windows.id!==NOID&&upd.windowId!==Windows.id)){if(Info.isBg&&upd&&upd.windowId!==void 0){updateColorScheme({});return}updateColorScheme(upd?.theme)}})}function getColorSchemeName(colorScheme){return colorScheme===1?"dark":"light"}async function updateColorScheme(theme){if(Settings.state.colorScheme==="ff"){theme||(theme=await browser.theme.getCurrent(Windows.id!==NOID?Windows.id:void 0));let result=parseFirefoxTheme(theme);Info.isBg||(result.error?resetThemeSrcVars():applyThemeSrcVars(result)),result.error?useAutoColorScheme():(Styles.reactive.frameColorScheme=getColorSchemeName(result.frameVariant),Styles.reactive.toolbarColorScheme=getColorSchemeName(result.toolbarVariant),Styles.reactive.actElColorScheme=getColorSchemeName(result.actElVariant),Styles.reactive.popupColorScheme=getColorSchemeName(result.popupVariant),Styles.theme=theme,Styles.parsedTheme=result)}else Info.isBg||resetThemeSrcVars(),Styles.theme={},Styles.parsedTheme=void 0;Settings.state.colorScheme==="sys"?useAutoColorScheme():Settings.state.colorScheme==="dark"?(Styles.reactive.frameColorScheme="dark",Styles.reactive.toolbarColorScheme="dark",Styles.reactive.actElColorScheme="dark",Styles.reactive.popupColorScheme="dark"):Settings.state.colorScheme==="light"&&(Styles.reactive.frameColorScheme="light",Styles.reactive.toolbarColorScheme="light",Styles.reactive.actElColorScheme="light",Styles.reactive.popupColorScheme="light")}function useAutoColorScheme(){darkMedia||(darkMedia=window.matchMedia(PREF_DARK_MEDIA)),darkMedia.matches?(Styles.reactive.frameColorScheme="dark",Styles.reactive.toolbarColorScheme="dark",Styles.reactive.actElColorScheme="dark",Styles.reactive.popupColorScheme="dark"):(Styles.reactive.frameColorScheme="light",Styles.reactive.toolbarColorScheme="light",Styles.reactive.actElColorScheme="light",Styles.reactive.popupColorScheme="light")}function setupAutoColorSchemeListener(cb){darkMedia||(darkMedia=window.matchMedia(PREF_DARK_MEDIA)),darkMedia.onchange||(darkMedia.onchange=()=>cb())}function getColorSchemeVariant(bg2,fg){let variant;if(bg2&&fg&&bg2[3]>.1){let bgn=(bg2[0]+bg2[1]+bg2[2])/3,fgn=(fg[0]+fg[1]+fg[2])/3;bgn>fgn?variant=2:variant=1}return variant}function shiftColor(rgba,shift){let r=rgba[0],g=rgba[1],b=rgba[2],a=rgba[3];return shift<2&&shift>0?((r*=shift)>255&&(r=255),(g*=shift)>255&&(g=255),(b*=shift)>255&&(b=255)):((r+=shift)>255&&(r=255),(g+=shift)>255&&(g=255),(b+=shift)>255&&(b=255),r<0&&(r=0),g<0&&(g=0),b<0&&(b=0)),[r,g,b,a]}function mergeColors(a,b,alpha){if(!a||!b)return;if(alpha===void 0&&(alpha=b[3]),alpha===1)return b;let cr=Math.round(a[0]*(1-alpha)+b[0]*alpha),cg=Math.round(a[1]*(1-alpha)+b[1]*alpha),cb=Math.round(a[2]*(1-alpha)+b[2]*alpha);return[cr,cg,cb,1]}function isTransparent(color){return color?color[3]!==1:!1}function toColorString(rgba,noAlpha){return rgba?Array.isArray(rgba)?rgba[3]===void 0||rgba[3]===1||noAlpha?`rgb(${rgba[0]}, ${rgba[1]}, ${rgba[2]})`:`rgba(${rgba[0]}, ${rgba[1]}, ${rgba[2]}, ${rgba[3]})`:rgba:"#000"}function getSystemColorScheme(){let probeEl=document.getElementById("moz_dialog_color_scheme_probe");if(!probeEl)return"dark";let styles=window.getComputedStyle(probeEl),bg2=toRGBA(styles.backgroundColor),fg=toRGBA(styles.color);if(!bg2||!fg)return"dark";let colorScheme=getColorSchemeVariant(bg2,fg);return colorScheme?colorScheme===1?"dark":"light":"dark"}function parseFirefoxTheme(theme){let parsed={error:!1,vars:{}};moz_dialog_fallback:if(!theme.colors){let probeEl=document.getElementById("moz_dialog_color_scheme_probe");if(!probeEl)break moz_dialog_fallback;let styles=window.getComputedStyle(probeEl),bg2=toRGBA(styles.backgroundColor),fg=toRGBA(styles.color);if(!bg2||!fg)break moz_dialog_fallback;theme.colors={frame:toColorString(bg2),toolbar:toColorString(shiftColor(bg2,15)),popup:toColorString(shiftColor(bg2,5)),tab_background_text:styles.color}}parsed.error=!theme.colors;let frame_bg=theme.colors?.frame??theme.colors?.frame_inactive,frame_fg=theme.colors?.tab_background_text??theme.colors?.toolbar_text??theme.colors?.bookmark_text,toolbar_bg=theme.colors?.toolbar??frame_bg,toolbar_fg=theme.colors?.icons??theme.colors?.toolbar_text??theme.colors?.bookmark_text??theme.colors?.icons_attention??theme.colors?.tab_background_text,act_el_bg=theme.colors?.tab_selected??toolbar_bg,act_el_fg=theme.colors?.tab_text??theme.colors?.toolbar_text??theme.colors?.bookmark_text??theme.colors?.tab_background_text,popup_bg=theme.colors?.popup??frame_bg,popup_fg=theme.colors?.popup_text??frame_fg,popup_border=theme.colors?.popup_border,accentFg=theme.colors?.tab_line??theme.colors?.bookmark_text,isProton=Settings.state.theme==="proton";per_theme_stuff:if(isProton){if(parsed.vars.frame_bg=toColorString(frame_bg),parsed.frameBg=toRGBA(parsed.vars.frame_bg),isTransparent(parsed.frameBg)&&(parsed.frameBg=mergeColors([0,0,0,0],parsed.frameBg),parsed.vars.frame_bg=toColorString(parsed.frameBg)),parsed.vars.frame_fg=toColorString(frame_fg),parsed.frameFg=toRGBA(parsed.vars.frame_fg),parsed.frameVariant=getColorSchemeVariant(parsed.frameBg,parsed.frameFg),parsed.vars.toolbar_bg=toColorString(toolbar_bg),parsed.vars.toolbar_fg=toColorString(toolbar_fg),parsed.toolbarBg=toRGBA(parsed.vars.toolbar_bg),isTransparent(parsed.toolbarBg)&&(parsed.toolbarBg=mergeColors(parsed.frameBg,parsed.toolbarBg),parsed.vars.toolbar_bg=toColorString(parsed.toolbarBg)),parsed.toolbarFg=toRGBA(parsed.vars.toolbar_fg),parsed.toolbarVariant=getColorSchemeVariant(parsed.toolbarBg,parsed.toolbarFg),normalizeContrast(parsed),parsed.error)return parsed;parsed.vars.act_el_bg=toColorString(act_el_bg),parsed.vars.act_el_fg=toColorString(act_el_fg),parsed.actElBg=toRGBA(parsed.vars.act_el_bg),parsed.actElFg=toRGBA(parsed.vars.act_el_fg),parsed.actElVariant=getColorSchemeVariant(parsed.actElBg,parsed.actElFg)}else if(Settings.state.theme==="plain"){if(parsed.vars.toolbar_bg=toColorString(theme.colors?.sidebar??toolbar_bg),parsed.vars.toolbar_fg=toColorString(theme.colors?.sidebar_text??toolbar_fg),parsed.toolbarBg=toRGBA(parsed.vars.toolbar_bg),isTransparent(parsed.toolbarBg)){let frameBg=toRGBA(frame_bg);isTransparent(frameBg)?parsed.toolbarBg=mergeColors([0,0,0,0],parsed.toolbarBg):parsed.toolbarBg=mergeColors(frameBg,parsed.toolbarBg),parsed.vars.toolbar_bg=toColorString(parsed.toolbarBg)}if(parsed.toolbarFg=toRGBA(parsed.vars.toolbar_fg),parsed.toolbarVariant=getColorSchemeVariant(parsed.toolbarBg,parsed.toolbarFg),parsed.frameVariant=parsed.toolbarVariant,parsed.actElVariant=parsed.toolbarVariant,parsed.popupVariant=parsed.toolbarVariant,!parsed.toolbarBg)break per_theme_stuff;let toolbarBgAvrg=(parsed.toolbarBg[0]+parsed.toolbarBg[1]+parsed.toolbarBg[2])/3;if(toolbarBgAvrg<36?parsed.frameBg=shiftColor(parsed.toolbarBg,.1+(toolbarBgAvrg*.023)**2):toolbarBgAvrg<200?parsed.frameBg=shiftColor(parsed.toolbarBg,.8):parsed.frameBg=shiftColor(parsed.toolbarBg,.9),parsed.frameBg&&(parsed.vars.frame_bg=toColorString(parsed.frameBg)),parsed.frameFg=parsed.toolbarFg,parsed.vars.frame_fg=parsed.vars.toolbar_fg,normalizeContrast(parsed),parsed.error)return parsed;parsed.toolbarVariant===1?parsed.actElBg=mergeColors(parsed.toolbarBg,parsed.toolbarFg,.1):parsed.actElBg=shiftColor(parsed.toolbarBg,1.1),parsed.actElBg&&(parsed.vars.act_el_bg=toColorString(parsed.actElBg)),parsed.vars.act_el_fg=parsed.vars.toolbar_fg}parsed.vars.popup_bg=toColorString(popup_bg),parsed.vars.popup_fg=toColorString(popup_fg),parsed.vars.popup_border=toColorString(popup_border),parsed.popupBg=toRGBA(popup_bg),parsed.popupFg=toRGBA(popup_fg),parsed.popupBorder=toRGBA(popup_border),parsed.popupVariant=getColorSchemeVariant(parsed.popupBg,parsed.popupFg);fixing_popup_border:if(!popup_border||parsed.popupBorder?.[3]===0||isSimilarColor(8,parsed.popupBg,parsed.popupBorder)){let border=toRGBA(popup_bg);if(!border)break fixing_popup_border;parsed.popupVariant===1?parsed.popupBorder=shiftColor(border,9):parsed.popupBorder=shiftColor(border,-38),parsed.vars.popup_border=toColorString(parsed.popupBorder)}accent_parsing:if(accentFg){let accent=toRGBA(accentFg);if(!accent||accent[3]===0)break accent_parsing;let frame=parsed.frameBg,toolbar=parsed.toolbarBg,actEl=parsed.actElBg;if(!frame||!toolbar||!actEl)break accent_parsing;let accentAvrg=(accent[0]+accent[1]+accent[2])/3,frameAvrg=(frame[0]+frame[1]+frame[2])/3,toolbarAvrg=(toolbar[0]+toolbar[1]+toolbar[2])/3,actElAvrg=(actEl[0]+actEl[1]+actEl[2])/3,accentIsBrighter=accentAvrg>frameAvrg,isDark=(parsed.actElVariant??parsed.frameVariant??parsed.toolbarVariant)===1;if(accentIsBrighter!==accentAvrg>toolbarAvrg||accentIsBrighter!==accentAvrg>actElAvrg||isDark&&accentAvrg<50||!isDark&&Math.abs(accentAvrg-actElAvrg)<8||isSimilarColor(8,accent,parsed.frameBg)||isSimilarColor(8,accent,parsed.toolbarBg))break accent_parsing;parsed.actElBorder=accent,parsed.vars.act_el_border=toColorString(accentFg),parsed.accent=accent,parsed.vars.accent=toColorString(accentFg)}if(isProton&&!parsed.vars.accent&&parsed.actElBg&&parsed.frameBg){let actElBgAvrg=(parsed.actElBg[0]+parsed.actElBg[1]+parsed.actElBg[2])/3,frameBgAvrg=(parsed.frameBg[0]+parsed.frameBg[1]+parsed.frameBg[2])/3;Math.abs(actElBgAvrg-frameBgAvrg)<8&&(parsed.toolbarVariant===1?parsed.actElBg=mergeColors(parsed.frameBg,parsed.toolbarFg,.1):parsed.actElBg=shiftColor(parsed.frameBg,1.1),parsed.actElBg&&(parsed.vars.act_el_bg=toColorString(parsed.actElBg)))}detecting_top_border:if(theme.colors?.sidebar&&theme.colors.sidebar_border){let border=toRGBA(theme.colors.sidebar_border),frame=parsed.frameBg,toolbar=parsed.toolbarBg;if(!border||!frame||!toolbar||border[3]===0||theme.colors.sidebar_border===theme.colors.sidebar)break detecting_top_border;let borderAvrg=(border[0]+border[1]+border[2])/3;(toolbar[0]+toolbar[1]+toolbar[2])/3-borderAvrg>8&&(parsed.vars.darker_border_width="1px")}return theme.colors?.toolbar_top_separator&&calcToolbarBorder(theme.colors,parsed),(parsed.error||!theme.colors)&&(darkMedia||(darkMedia=window.matchMedia(PREF_DARK_MEDIA)),darkMedia.matches?parsed.frameVariant=1:parsed.frameVariant=2,parsed.toolbarVariant=parsed.frameVariant,parsed.actElVariant=parsed.frameVariant),parsed}var CONTRAST_THRESHOLD=70;function normalizeContrast(parsed){let frameContrastOk=!0;if(parsed.frameBg&&parsed.frameFg){let frameBgAvrg=(parsed.frameBg[0]+parsed.frameBg[1]+parsed.frameBg[2])/3,frameFgAvrg=(parsed.frameFg[0]+parsed.frameFg[1]+parsed.frameFg[2])/3;frameContrastOk=Math.abs(frameFgAvrg-frameBgAvrg)>CONTRAST_THRESHOLD}let toolbarContrastOk=!0;if(parsed.toolbarBg&&parsed.toolbarFg){let toolbarBgAvrg=(parsed.toolbarBg[0]+parsed.toolbarBg[1]+parsed.toolbarBg[2])/3,toolbarFgAvrg=(parsed.toolbarFg[0]+parsed.toolbarFg[1]+parsed.toolbarFg[2])/3;toolbarContrastOk=Math.abs(toolbarFgAvrg-toolbarBgAvrg)>CONTRAST_THRESHOLD}if(!frameContrastOk&&toolbarContrastOk&&Settings.state.theme==="proton"&&(parsed.frameBg=parsed.toolbarBg,parsed.vars.frame_bg=parsed.vars.toolbar_bg,parsed.frameFg=parsed.toolbarFg,parsed.vars.frame_fg=parsed.vars.toolbar_fg,parsed.frameVariant=getColorSchemeVariant(parsed.frameBg,parsed.frameFg)),frameContrastOk&&!toolbarContrastOk&&(parsed.toolbarBg=parsed.frameBg,parsed.vars.toolbar_bg=parsed.vars.frame_bg,parsed.toolbarFg=parsed.frameFg,parsed.vars.toolbar_fg=parsed.vars.frame_fg,parsed.toolbarVariant=getColorSchemeVariant(parsed.frameBg,parsed.frameFg)),!frameContrastOk&&!toolbarContrastOk){parsed.error=!0;return}}function isSimilarColor(thr,a,b){if(a===void 0||b===void 0)return!1;if(thr===0)return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2];{let dr=Math.abs(a[0]-b[0]),dg=Math.abs(a[1]-b[1]),db=Math.abs(a[2]-b[2]);return dr<=thr&&dg<=thr&&db<=thr}}function calcToolbarBorder(themeColors,parsed){let monoColorScheme=parsed.frameVariant===parsed.toolbarVariant,borderRaw=themeColors.toolbar_top_separator,border=toRGBA(borderRaw),frame=parsed.frameBg,bar=parsed.toolbarBg;if(!borderRaw||!border||borderRaw===themeColors.toolbar||borderRaw===themeColors.frame||border[3]===0||!monoColorScheme||!frame||!bar)return;let borderAvrg=(border[0]+border[1]+border[2])/3,frameAvrg=(frame[0]+frame[1]+frame[2])/3,barAvrg=(bar[0]+bar[1]+bar[2])/3;if(borderAvrg>=frameAvrg||borderAvrg>=barAvrg)return;if(monoColorScheme&&borderRaw&&border?.[3]===1){parsed.vars.toolbar_border=toColorString(borderRaw);return}let frameAv=(frame[0]+frame[1]+frame[2])/3,barAv=(bar[0]+bar[1]+bar[2])/3,base=frameAv<barAv?frame:bar;parsed.vars.toolbar_border=`rgb(${base[0]-8}, ${base[1]-8}, ${base[2]-8})`}function applyThemeSrcVars(parsed,rootEl2){if(rootEl2||(rootEl2=document.body),!!rootEl2){for(let colorName of SRC_VARS)parsed.vars[colorName]||rootEl2.style.removeProperty(toCSSVarName("s_"+colorName));for(let prop of Object.keys(parsed.vars)){let value=parsed.vars[prop];value?rootEl2.style.setProperty(toCSSVarName("s_"+prop),value):rootEl2.style.removeProperty(toCSSVarName("s_"+prop))}}}function resetThemeSrcVars(){let rootEl2=document.body;if(rootEl2)for(let colorName of SRC_VARS)rootEl2.style.removeProperty(toCSSVarName("s_"+colorName))}async function loadCustomSidebarCSS(){let stored=await browser.storage.local.get("sidebarCSS");applyCustomCSS(stored.sidebarCSS),Sidebar.recalcElementSizesDebounced()}async function loadCustomGroupCSS(){let stored=await browser.storage.local.get("groupCSS");applyCustomCSS(stored.groupCSS)}function applyCustomCSS(css){if(css==null)return;let customStyleEl=document.getElementById("custom_css");if(!customStyleEl)customStyleEl=document.createElement("style"),customStyleEl.id="custom_css",document.head.appendChild(customStyleEl);else for(;customStyleEl.lastChild;)customStyleEl.removeChild(customStyleEl.lastChild);css&&customStyleEl.appendChild(document.createTextNode(css))}function removeCustomCSS(){let customStyleEl=document.getElementById("custom_css");customStyleEl&&customStyleEl.remove()}async function getCustomCSS(target){let fieldName=target+"CSS",ans=await browser.storage.local.get(fieldName);return!ans||!ans[fieldName]?"":ans[fieldName]}async function hasCustomCSS(){let storage=await browser.storage.local.get(["sidebarCSS","groupCSS"]);return!!storage.sidebarCSS||!!storage.groupCSS}function setCustomCSS(target,css){let fieldName=target+"CSS",settingsChanged=!1;if(fieldName==="sidebarCSS"){if(Styles.sidebarCSS===css)return;Settings.state.sidebarCSS!==!!css&&(settingsChanged=!0),Styles.sidebarCSS=css,Settings.state.sidebarCSS=!!css}else if(fieldName==="groupCSS"){if(Styles.groupCSS===css)return;Settings.state.groupCSS!==!!css&&(settingsChanged=!0),Styles.groupCSS=css,Settings.state.groupCSS=!!css}settingsChanged&&Settings.saveSettings(),Store.set({[fieldName]:css}),Settings.state.syncSaveStyles&&saveStylesToSync()}function upgradeCustomStyles(stored,newStorage){let legacyCSSVars=stored.cssVars?convertVarsToCSS(stored.cssVars):"",sidebarCSS="";stored.sidebarCSS&&(sidebarCSS=`/* OLD STYLES
${stored.sidebarCSS}
*/`),legacyCSSVars&&(sidebarCSS=legacyCSSVars+`

`+sidebarCSS);let groupCSS="";stored.groupCSS&&(groupCSS=`/* OLD STYLES
${stored.groupCSS}
*/`),legacyCSSVars&&(groupCSS=legacyCSSVars+`

`+groupCSS),newStorage.sidebarCSS=sidebarCSS,newStorage.groupCSS=groupCSS}function convertVarsToCSS(vars){let cssVars=[];for(let key of Object.keys(vars)){let value=vars[key];if(!value)continue;let varName="--"+key.replace(UNDERSCORE_RE,"-");cssVars.push(`#root.root {${varName}: ${value};}`)}return cssVars.length?`/* OLD CSS VARS
${cssVars.join(`
`)}
*/`:""}async function loadCustomCSS(){let stored=await browser.storage.local.get(["sidebarCSS","groupCSS"]);stored.sidebarCSS&&(Styles.sidebarCSS=stored.sidebarCSS),stored.groupCSS&&(Styles.groupCSS=stored.groupCSS)}async function saveStylesToSync(){let value={};Settings.state.sidebarCSS&&Styles.sidebarCSS&&(value.sidebarCSS=Styles.sidebarCSS),Settings.state.groupCSS&&Styles.groupCSS&&(value.groupCSS=Styles.groupCSS),await Store.sync("styles",value)}function setupListeners4(){Info.isSidebar&&Store.onKeyChange("sidebarCSS",css=>{applyCustomCSS(css),Sidebar.recalcElementSizesDebounced()})}var defaultColorScheme=getSystemColorScheme(),Styles={reactive:{colorScheme:defaultColorScheme,frameColorScheme:defaultColorScheme,toolbarColorScheme:defaultColorScheme,actElColorScheme:defaultColorScheme,popupColorScheme:defaultColorScheme},sidebarCSS:"",groupCSS:"",theme:void 0,parsedTheme:void 0,...styles_actions_exports};var mouse_actions_exports={};__export(mouse_actions_exports,{blockWheel:()=>blockWheel,getWheelDebouncer:()=>getWheelDebouncer,isCtxTarget:()=>isCtxTarget,isLocked:()=>isLocked,isTarget:()=>isTarget,onMouseMove:()=>onMouseMove,resetClickLock:()=>resetClickLock,resetCtxTarget:()=>resetCtxTarget,resetTarget:()=>resetTarget,setTarget:()=>setTarget,startLongClick:()=>startLongClick,startMultiSelection:()=>startMultiSelection,startResizing:()=>startResizing,stopLongClick:()=>stopLongClick,stopMultiSelection:()=>stopMultiSelection,stopResizing:()=>stopResizing});var startY=0,multiSelectionStartId=null,multiSelectionStartY=0,multiSelectionPreselected,targetType=null,targetId,ctxTargetType=null,ctxTargetId;function setTarget(type,id){targetType=type,targetId=id,ctxTargetType=type,ctxTargetId=id,Mouse.longClickApplied=!1}function resetTarget(){targetType=null,targetId=void 0,Mouse.resizing&&stopResizing()}function resetCtxTarget(){ctxTargetType=null,ctxTargetId=void 0}function isTarget(type,id){return id!==void 0?id===targetId&&targetType===type:targetType===type}function isCtxTarget(type,id){return id!==void 0?id===ctxTargetId&&ctxTargetType===type:ctxTargetType===type}function onMouseMove(e){if(Mouse.resizing){Mouse.resizing==="x"&&(resizingStart===-1&&(resizingStart=e.clientX),resizingDelta=e.clientX-resizingStart),Mouse.resizing==="y"&&(resizingStart===-1&&(resizingStart=e.clientY),resizingDelta=e.clientY-resizingStart),resizingCallback&&resizingCallback(resizingStart,resizingDelta);return}if(state.status===2&&state.mode!==1&&Settings.state.previewTabsFollowMouse){setPreviewPopupPosition(e.clientY);return}if(multiSelectionStartId!==null){if(!Mouse.multiSelectionMode&&Math.abs(e.clientY-multiSelectionStartY)>5){let activePanel;if(Sidebar.subPanelType===2&&Sidebar.subPanels.bookmarks?activePanel=Sidebar.subPanels.bookmarks:activePanel=Sidebar.panelsById[Sidebar.activePanelId],!activePanel)return;Menu.close(),Selection.resetSelection(),Mouse.multiSelectionMode=!0;let tab=Tabs2.byId[multiSelectionStartId];tab&&!tab.pinned&&tab.isParent&&tab.folded?Selection.selectTabsBranch(tab):Selection.select(multiSelectionStartId),Sidebar.updateBounds(),stopLongClick();let scroll=activePanel.scrollEl?.scrollTop||0;startY=multiSelectionStartY-activePanel.topOffset+scroll,Settings.state.previewTabs&&closePreview();return}if(Mouse.multiSelectionMode){let activePanel;if(Sidebar.subPanelType===2&&Sidebar.subPanels.bookmarks?activePanel=Sidebar.subPanels.bookmarks:activePanel=Sidebar.panelsById[Sidebar.activePanelId],!activePanel||!activePanel.scrollEl)return;let scroll=activePanel.scrollEl?.scrollTop||0,y=e.clientY-activePanel.topOffset+scroll,topY=Math.min(startY,y),bottomY=Math.max(startY,y);y-scroll<PRE_SCROLL?activePanel.scrollEl.scrollTop=scroll-15:y-scroll>activePanel.scrollEl.offsetHeight-PRE_SCROLL&&(activePanel.scrollEl.scrollTop=scroll+15);for(let slot of activePanel.bounds)if(slot.end>=topY&&slot.start+1<=bottomY){if(!Selection.includes(slot.id)){if(slot.type===1){let tab=Tabs2.byId[slot.id];tab&&!tab.pinned&&tab.isParent&&tab.folded?Selection.selectTabsBranch(tab):Selection.selectTab(slot.id)}slot.type===2&&Selection.selectBookmark(slot.id)}}else if(Selection.includes(slot.id)){if(slot.type===1){let tab=Tabs2.byId[slot.id];tab&&!tab.pinned&&tab.isParent&&tab.folded?Selection.deselectTabsBranch(tab):Selection.deselectTab(slot.id)}slot.type===2&&Selection.deselectBookmark(slot.id)}}}}var longClickTimeout;function startLongClick(e,type,id,cb){clearTimeout(longClickTimeout),longClickTimeout=setTimeout(()=>{if(Settings.state.previewTabs&&closePreview(),DnD.reactive.isStarted)return;Mouse.longClickApplied=!0;let action;if(type==="tab"){e.button===0?action=Settings.state.tabLongLeftClick:e.button===2&&(action=Settings.state.tabLongRightClick,stopMultiSelection(),Selection.resetSelection());let tab=Tabs2.byId[id];if(!tab)return;action==="reload"&&Tabs2.reloadTabs([tab.id]),action==="duplicate"&&Tabs2.duplicateTabs([tab.id]),action==="pin"&&Tabs2.repinTabs([tab.id]),action==="mute"&&Tabs2.remuteTabs([tab.id]),action==="clear_cookies"&&Tabs2.clearTabsCookies([tab.id]),action==="new_after"&&Tabs2.createTabAfter(tab.id),action==="new_child"&&!tab.pinned&&Tabs2.createChildTab(tab.id),action==="edit_title"&&!tab.pinned&&Tabs2.editTabTitle([tab.id]),action!=="none"&&(clickLock=!0)}longClickTimeout=void 0,cb&&clickLock&&cb()},Settings.state.longClickDelay)}function stopLongClick(){clearTimeout(longClickTimeout),clickLock=!1}var clickLock=!1;function isLocked(){return clickLock}function resetClickLock(delay=0){clickLock&&(delay?setTimeout(()=>clickLock=!1,delay):clickLock=!1)}function startMultiSelection(e,id,preselected){Settings.state.ctxMenuNative&&e.button===2||(multiSelectionStartId=id,multiSelectionStartY=e.clientY,multiSelectionPreselected=preselected)}function stopMultiSelection(){let preselected=multiSelectionPreselected;return multiSelectionStartId=null,Mouse.multiSelectionMode=!1,multiSelectionStartY=0,multiSelectionPreselected=void 0,preselected}var resizingStart=-1,resizingDelta=-1,resizingCallback=null,resizingEndCallback=null;function startResizing(mode,callback,endCallback){Mouse.resizing=mode,resizingEndCallback=endCallback,resizingCallback=callback}function stopResizing(){resizingEndCallback&&(resizingEndCallback(resizingStart,resizingDelta),resizingEndCallback=null),resizingCallback=null,Mouse.resizing=null,resizingStart=-1,resizingDelta=-1}function getWheelDebouncer(direction,cb){if(!Settings.state.wheelThreshold)return cb;let stopTimeout,first=!0,delta=0,deltaBuf=0;return e=>{let threshold=0,accumulation=!0;if(direction===2?(threshold=Settings.state.wheelThresholdY,accumulation=Settings.state.wheelAccumulationY):(threshold=Settings.state.wheelThresholdX,accumulation=Settings.state.wheelAccumulationX),clearTimeout(stopTimeout),stopTimeout=setTimeout(()=>{accumulation?(deltaBuf=0,first=!0):delta=0,stopTimeout=void 0},500),!(wheelYIsBlocked&&direction===2)&&!(wheelXIsBlocked&&direction===1)){if(e.deltaMode!==0)return cb(e);delta=direction===2?e.deltaY:e.deltaX,accumulation?!first&&delta?deltaBuf+=delta:first=!1:deltaBuf=delta,(deltaBuf>threshold||deltaBuf<-threshold)&&(accumulation?deltaBuf=0:delta=0,cb(e))}}}var wheelXIsBlocked=!1,blockWheelXTimeout,wheelYIsBlocked=!1,blockWheelYTimeout;function blockWheel(direction){(direction===void 0||direction===2)&&(wheelYIsBlocked=!0,clearTimeout(blockWheelYTimeout),blockWheelYTimeout=setTimeout(()=>{wheelYIsBlocked=!1},500)),(direction===void 0||direction===1)&&(wheelXIsBlocked=!0,clearTimeout(blockWheelXTimeout),blockWheelXTimeout=setTimeout(()=>{wheelXIsBlocked=!1},500))}var Mouse={multiSelectionMode:!1,resizing:null,longClickApplied:!1,mouseIn:!1,...mouse_actions_exports};var state={status:0,mode:0,modeFallback:!1,popupWinId:NOID,targetTabId:NOID,mouseEnterTimeout:void 0,mouseLeaveTimeout:void 0},approxFFToolbarsHeight=70,approxPopupHeaderHeight=40,inlinePreviewConf={format:"jpeg",quality:90,scale:window.devicePixelRatio/2},currentWinWidth=0,currentWinHeight=0,currentWinY=0,currentWinX=0,currentWinOffsetY=0,currentWinOffsetX=0,deadOnArrival=!1,listening=!1,tooltipUpdTimeout;function setTargetTab(tabId,y){if(clearTimeout(state.mouseEnterTimeout),Settings.state.previewTabsFollowMouse&&clearTimeout(state.mouseLeaveTimeout),state.targetTabId=tabId,!Menu.isOpen&&!Mouse.multiSelectionMode&&!Selection.selected.length){if(clearTimeout(tooltipUpdTimeout),tooltipUpdTimeout=setTimeout(()=>{let tab=Tabs2.byId[tabId];if(tab){let isClosed=state.status===0;Settings.state.previewTabsMode==="p"&&state.mode===0||state.mode===3&&isClosed&&(tab.discarded||tab.active)||state.mode===2&&isClosed&&(tab.discarded||tab.active)||state.mode===1&&tab.discarded?tab.reactive.tooltip=Tabs2.getTooltip(tab):tab.reactive.tooltip=""}},64),state.mode===1){state.mouseEnterTimeout=setTimeout(()=>{state.mouseEnterTimeout=void 0,showPreviewInline(state.targetTabId)},Settings.state.previewTabsDelay);return}if(Settings.state.previewTabsFollowMouse&&state.status===2){state.mouseEnterTimeout=setTimeout(()=>{state.mouseEnterTimeout=void 0,updatePreviewPopup(state.targetTabId)},128);return}if(state.status===0){state.mouseEnterTimeout=setTimeout(()=>{state.mouseEnterTimeout=void 0,showPreview(state.targetTabId,y)},Settings.state.previewTabsDelay);return}}}function resetTargetTab(tabId){clearTimeout(state.mouseEnterTimeout),clearTimeout(state.mouseLeaveTimeout),(tabId===void 0||tabId===state.targetTabId)&&(state.targetTabId=NOID),state.mouseEnterTimeout=void 0,state.mode!==1&&(state.mouseLeaveTimeout=setTimeout(()=>{closePreviewPopup()},36))}async function injectTabPreview(tabId,y){let activeTab=Tabs2.byId[Tabs2.activeId];if(!activeTab)return;let initData=getTabPreviewInitData(tabId,y),initDataJson=JSON.stringify(initData),injectingData=browser.tabs.executeScript(activeTab.id,{code:`window.sideberyInitData=${initDataJson};window.onSideberyInitDataReady?.();true;`,runAt:"document_start",allFrames:!1,matchAboutBlank:!0}).catch(()=>{}),injectingScript=browser.tabs.executeScript(activeTab.id,{file:"../injections/tab-preview.js",runAt:"document_start",allFrames:!1,matchAboutBlank:!0}).catch(()=>{}),[result,_]=await Promise.all([injectingData,injectingScript]);return result}function getTabPreviewInitData(tabId,y){let tab=Tabs2.byId[tabId];return{bg:Styles.parsedTheme?.vars.frame_bg,fg:Styles.parsedTheme?.vars.frame_fg,hbg:Styles.parsedTheme?.vars.toolbar_bg,hfg:Styles.parsedTheme?.vars.toolbar_fg,tabId,winId:Windows.id,title:tab?.title??"---",url:tab?.url??"---",y:y??0,dpr:window.devicePixelRatio,popupWidth:Settings.state.previewTabsPopupWidth,offsetY:Settings.state.previewTabsInPageOffsetY,offsetX:Settings.state.previewTabsInPageOffsetX,atTheLeft:Settings.state.previewTabsSide==="right",rCrop:Settings.state.previewTabsCropRight}}async function showPreview(tabId,y){let tab=Tabs2.byId[tabId];if(!(!tab||tab.invisible||tab.discarded||tab.active)){if(state.mode===1)return showPreviewInline(tabId);if(state.mode===3){if(state.status=1,(await injectTabPreview(tabId,y))?.[0]){state.status=2,(deadOnArrival||tab.invisible)&&(deadOnArrival=!1,closePreviewPopup());return}if(state.status=0,state.modeFallback=!0,Settings.state.previewTabsPageModeFallback==="n"){state.mode=0,tab.reactive.tooltip=Tabs2.getTooltip(tab);return}if(Settings.state.previewTabsPageModeFallback==="i")return state.mode=1,showPreviewInline(tabId);if(Windows.focused&&Settings.state.previewTabsPageModeFallback==="w")return state.mode=2,showPreveiwPopupWindow(tabId,y)}else if(Windows.focused&&state.mode===2)return showPreveiwPopupWindow(tabId,y)}}function closePreview(){if(clearTimeout(state.mouseEnterTimeout),clearTimeout(state.mouseLeaveTimeout),state.mode===1)return closePreviewInline();if(state.mode===3||state.mode===2)return closePreviewPopup()}function resetMode(){state.status!==0&&closePreview(),Settings.state.previewTabsMode==="i"?state.mode=1:Settings.state.previewTabsMode==="p"?state.mode=3:state.mode=2,state.modeFallback=!1}async function showPreveiwPopupWindow(tabId,y){let tab=Tabs2.byId[tabId];if(!tab||tab.invisible||tab.discarded)return;state.status=1;let currentWindow=await browser.windows.getCurrent({populate:!1});if(currentWinWidth=currentWindow.width??0,currentWinHeight=currentWindow.height??0,currentWinY=currentWindow.top??0,currentWinX=currentWindow.left??0,currentWinWidth===0||currentWinHeight===0){state.status=0;return}listening||setupPopupDisconnectionListener(),currentWinOffsetY=0,currentWinOffsetX=0;let previewWidth=Settings.state.previewTabsPopupWidth,previewData={bg:Styles.parsedTheme?.vars.frame_bg??"",fg:Styles.parsedTheme?.vars.frame_fg??"",hbg:Styles.parsedTheme?.vars.toolbar_bg??"",hfg:Styles.parsedTheme?.vars.toolbar_fg??"",tabId:tab.id.toString(),winId:Windows.id.toString(),title:tab.title,url:tab.url},pageWidth=currentWinWidth-Sidebar.width,previewHeight=Math.round(currentWinHeight/pageWidth*previewWidth);previewHeight>previewWidth&&(previewHeight=previewWidth);let w=pageWidth/previewWidth,h=currentWinHeight/previewHeight,scale=window.devicePixelRatio/Math.min(w,h)*1.5;scale>window.devicePixelRatio&&(scale=window.devicePixelRatio),previewHeight+=approxPopupHeaderHeight,previewData.scale=String(scale),tab.discarded&&(previewData.off="y");let params=new URLSearchParams(previewData).toString(),top=(currentWinY??0)+(y??0)+Settings.state.previewTabsWinOffsetY,left=getPopupX(),previewWindow=await browser.windows.create({allowScriptsToClose:!0,focused:!0,top,left,width:previewWidth,height:previewHeight,incognito:!1,state:"normal",type:"popup",url:`/popup.tab-preview/tab-preview.html?${params}`,titlePreface:"Tab Preview‎"});if(previewWindow.id===void 0){state.status=0;return}if(state.popupWinId=previewWindow.id,state.status=2,deadOnArrival||tab.invisible){deadOnArrival=!1,closePreviewPopup();return}let updPosition=!1,updSize=!1,dw=(previewWindow.width??previewWidth)-previewWidth,dh=(previewWindow.height??previewHeight)-previewHeight;(dw!==0||dh!==0)&&(updSize=!0);let dt=(previewWindow.top??top)-top,dl=(previewWindow.left??left)-left;Math.abs(dt)<30&&Math.abs(dl)<5?(currentWinOffsetY=dt,currentWinOffsetX=dl):updPosition=!0,updSize&&await browser.windows.update(previewWindow.id,{width:previewWidth,height:previewHeight}),updPosition&&await browser.windows.update(previewWindow.id,{top,left})}function setPreviewPopupPosition(y){state.popupWinId!==NOID?browser.windows.update(state.popupWinId,{top:currentWinY+y+Settings.state.previewTabsWinOffsetY+currentWinOffsetY,left:getPopupX()}):state2.previewConnection&&sendToPreview("setY",y)}function updatePreviewPopup(tabId){if(state.status!==2)return;let tab=Tabs2.byId[tabId];tab&&(state2.previewConnection?sendToPreview("updatePreview",tabId,tab.title,tab.url,!!tab.discarded):closePreviewPopup())}async function closePreviewPopup(){if(state.status===1){deadOnArrival=!0;return}state.status===2&&(state.status=-1,state.popupWinId!==NOID?await browser.windows.remove(state.popupWinId):Settings.state.previewTabsMode==="p"&&state2.previewConnection&&sendToPreview("close"),state.popupWinId=NOID,state.status=0)}function getPopupX(){return Settings.state.previewTabsSide==="right"?currentWinX+Sidebar.width+Settings.state.previewTabsWinOffsetX+currentWinOffsetX:currentWinX+currentWinWidth-Sidebar.width-Settings.state.previewTabsPopupWidth-Settings.state.previewTabsWinOffsetX+currentWinOffsetX}function setupPopupDisconnectionListener(){let checkPart=ADDON_HOST.slice(50,52)+"/p";onDisconnected(7,async()=>{if(!Settings.state.previewTabs)return;let recentlyClosedItems=await browser.sessions.getRecentlyClosed({maxResults:3});for(let rc of recentlyClosedItems)rc.window?.sessionId&&rc.window.tabs?.length===1&&rc.window.tabs[0].url.startsWith(checkPart,50)&&browser.sessions.forgetClosedWindow(rc.window.sessionId)}),listening=!0}var inlinePreviewTabId=NOID;async function showPreviewInline(tabId){if(inlinePreviewTabId===tabId)return;let tab=Tabs2.byId[tabId];if(!tab||tab.discarded)return;state.status=1;let currentWindow=await browser.windows.getCurrent({populate:!1}),pageWidth=(currentWindow.width??0)-Sidebar.width,pageHeight=(currentWindow.height??0)-approxFFToolbarsHeight;if(pageWidth<=0)return;let w=pageWidth/Sidebar.width;inlinePreviewConf.scale=window.devicePixelRatio/w*1.5,inlinePreviewConf.scale>window.devicePixelRatio&&(inlinePreviewConf.scale=window.devicePixelRatio);let preview=await browser.tabs.captureTab(tabId,inlinePreviewConf).catch(()=>""),prevTabId=inlinePreviewTabId;if(inlinePreviewTabId=tabId,state.status=2,deadOnArrival){deadOnArrival=!1,closePreviewInline();return}let previewHeight=Settings.state.previewTabsInlineHeight;Settings.state.previewTabsInlineHeight===0&&(previewHeight=Math.round(pageHeight/pageWidth*Sidebar.width),previewHeight>Sidebar.width&&(previewHeight=Sidebar.width)),document.body.style.setProperty("--tabs-inline-preview-height",`${previewHeight}px`);let prevTab=Tabs2.byId[prevTabId];prevTab&&(prevTab.reactive.preview=!1),tab.pinned?(prevTab&&!prevTab.pinned&&(Tabs2.reactive.inlinePreviewTabId=NOID),Tabs2.reactive.inlinePreviewPinnedImg=`url("${preview}")`):(prevTab&&prevTab.pinned&&(Tabs2.reactive.inlinePreviewPinnedImg=""),tab.previewImg=`url("${preview}")`,tab.reactive.preview=!0,Tabs2.reactive.inlinePreviewTabId=tabId)}function closePreviewInline(){if(state.status===1){deadOnArrival=!0;return}let tab=Tabs2.byId[inlinePreviewTabId];if(!tab){Tabs2.reactive.inlinePreviewPinnedImg="",Tabs2.reactive.inlinePreviewTabId=NOID,inlinePreviewTabId=NOID,state.status=0;return}tab.pinned?Tabs2.reactive.inlinePreviewPinnedImg="":(Tabs2.reactive.inlinePreviewTabId=NOID,tab.reactive.preview=!1),inlinePreviewTabId=NOID,state.status=0}var EXT_HOST=browser.runtime.getURL("").slice(16),URL_HOST_PATH_RE=/^([a-z0-9-]{1,63}\.)+\w+(:\d+)?\/[A-Za-z0-9-._~:/?#[\]%@!$&'()*+,;=]*$/,NEWTAB_URL=browser.extension.inIncognitoContext?"about:privatebrowsing":"about:newtab";function setupTabsListeners(){Sidebar.hasTabs&&(browser.tabs.onCreated.addListener(onTabCreated),browser.tabs.onUpdated.addListener(onTabUpdated,{properties:["audible","discarded","favIconUrl","hidden","mutedInfo","pinned","status","title","url"]}),browser.tabs.onRemoved.addListener(onTabRemoved),browser.tabs.onMoved.addListener(onTabMoved),browser.tabs.onDetached.addListener(onTabDetached),browser.tabs.onAttached.addListener(onTabAttached),browser.tabs.onActivated.addListener(onTabActivated))}function resetTabsListeners(){browser.tabs.onCreated.removeListener(onTabCreated),browser.tabs.onUpdated.removeListener(onTabUpdated),browser.tabs.onRemoved.removeListener(onTabRemoved),browser.tabs.onMoved.removeListener(onTabMoved),browser.tabs.onDetached.removeListener(onTabDetached),browser.tabs.onAttached.removeListener(onTabAttached),browser.tabs.onActivated.removeListener(onTabActivated)}var waitForOtherReopenedTabsTimeout,waitForOtherReopenedTabsBuffer=null,waitForOtherReopenedTabsCheckLen=0,waitForOtherReopenedTabsBufferRelease=!1;function waitForOtherReopenedTabs(tab){waitForOtherReopenedTabsBuffer||(waitForOtherReopenedTabsBuffer=[]),waitForOtherReopenedTabsBuffer.push(tab),waitForOtherReopenedTabsCheckLen++,browser.sessions.getTabValue(tab.id,"data").then(data=>{tab.reopened=!!data,waitForOtherReopenedTabsBuffer&&(waitForOtherReopenedTabsCheckLen--,waitForOtherReopenedTabsCheckLen<=0&&(clearTimeout(waitForOtherReopenedTabsTimeout),releaseReopenedTabsBuffer()))}).catch(err3=>{err("Tabs.waitForOtherReopenedTabs: Cannot get tab data from session:",err3)}),clearTimeout(waitForOtherReopenedTabsTimeout),waitForOtherReopenedTabsTimeout=setTimeout(()=>{releaseReopenedTabsBuffer()},80)}function releaseReopenedTabsBuffer(){waitForOtherReopenedTabsBuffer&&(waitForOtherReopenedTabsBufferRelease=!0,waitForOtherReopenedTabsBuffer.sort((a,b)=>a.index-b.index),waitForOtherReopenedTabsBuffer.forEach(tab=>onTabCreated(tab)),waitForOtherReopenedTabsBuffer=null,waitForOtherReopenedTabsBufferRelease=!1,waitForOtherReopenedTabsCheckLen=0,Tabs2.deferredEventHandling.forEach(cb=>cb()),Tabs2.deferredEventHandling=[])}function onTabCreated(nativeTab,attached){if(nativeTab.windowId!==Windows.id)return;if(Tabs2.list.length===0||Tabs2.sorting){Tabs2.deferredEventHandling.push(()=>onTabCreated(nativeTab));return}if(Tabs2.ignoreTabsEvents)return;if(Tabs2.tabsReinitializing)return Tabs2.reinitTabs();Sidebar.reactive.hiddenPanelsPopup&&Sidebar.closeHiddenPanelsPopup(!0),Settings.state.highlightOpenBookmarks&&Bookmarks.markOpenBookmarksDebounced(nativeTab.url),Menu.close(),Selection.resetSelection();let panel,index,reopenedTabInfo,reopenedTabPanel,createGroup,autoGroupTab,initialOpenerSpec="",initialOpenerId=nativeTab.openerTabId,initialOpener=Tabs2.byId[nativeTab.openerTabId??-1],tab=Tabs2.mutateNativeTabToSideberyTab(nativeTab);if(Settings.state.pinnedAutoGroup&&initialOpener&&initialOpener.pinned&&Settings.state.tabsTree&&(initialOpenerSpec=encodeURIComponent(initialOpener.cookieStoreId+"::"+initialOpener.url),autoGroupTab=Tabs2.list.find(t=>t.url.startsWith(GROUP_URL)&&t.url.lastIndexOf("pin="+initialOpenerSpec)>-1),autoGroupTab?(tab.openerTabId=autoGroupTab.id,tab.autoGroupped=!0):createGroup=!0),Tabs2.removedTabs.length&&!tab.discarded&&tab.reopened!==!1&&!attached){let prevPosIndex=Tabs2.removedTabs.findIndex(t=>t.title===tab.title);if(reopenedTabInfo=Tabs2.removedTabs[prevPosIndex],reopenedTabInfo){if(!waitForOtherReopenedTabsBufferRelease){waitForOtherReopenedTabs(tab);return}Tabs2.removedTabs.splice(prevPosIndex,1),reopenedTabPanel=Sidebar.panelsById[reopenedTabInfo.panelId]}}if(Tabs2.newTabsPosition[tab.index]){let position=Tabs2.newTabsPosition[tab.index];if(panel=Sidebar.panelsById[position.panel],!isTabsPanel(panel)){let prevTab=Tabs2.list[tab.index-1];prevTab&&!prevTab.pinned&&prevTab.panelId!==NOID?panel=Sidebar.panelsById[prevTab.panelId]:panel=Sidebar.panels.find(p=>isTabsPanel(p))}index=tab.index,tab.openerTabId=position.parent,position.unread!==void 0&&(tab.unread=position.unread),delete Tabs2.newTabsPosition[tab.index];let oldTab=Tabs2.list[tab.index];oldTab?.reopening&&(oldTab.reopening.id=tab.id)}else if(reopenedTabInfo&&isTabsPanel(reopenedTabPanel)){panel=reopenedTabPanel,index=reopenedTabPanel.nextTabIndex;for(let rmTab of Tabs2.removedTabs)rmTab.parentId===reopenedTabInfo.id&&(rmTab.parentId=tab.id);let parentTab=Tabs2.byId[reopenedTabInfo.parentId],nextTab=Tabs2.list[tab.index];if(parentTab){let branchEndIndex=parentTab.index;for(let i=parentTab.index+1;i<Tabs2.list.length&&!(Tabs2.list[i].lvl<=parentTab.lvl);i++)branchEndIndex=i;branchEndIndex++,parentTab.index<tab.index&&tab.index<=branchEndIndex&&(!nextTab||nextTab.panelId===panel.id&&nextTab.lvl<=parentTab.lvl+1)?index=tab.index:index=branchEndIndex,tab.openerTabId=reopenedTabInfo.parentId}else(!nextTab||nextTab.panelId===panel.id&&nextTab.lvl===0)&&tab.index>=panel.startTabIndex&&tab.index<=panel.nextTabIndex?index=tab.index:index=Tabs2.getIndexForNewTab(panel,tab)}else{let parent=Tabs2.byId[tab.openerTabId??NOID];if(!attached&&parent?.folded&&Settings.state.ignoreFoldedParent&&(tab.openerTabId=parent.parentId),panel=Tabs2.getPanelForNewTab(tab),!panel)return err("Cannot handle new tab: Cannot find target panel");index=Tabs2.getIndexForNewTab(panel,tab),autoGroupTab||(Settings.state.groupOnOpen?tab.openerTabId=Tabs2.getParentForNewTab(panel,tab.openerTabId):tab.openerTabId=void 0)}panel&&!tab.pinned&&tab.index!==index&&(tab.dstPanelId=panel.id,Tabs2.movingTabs.push(tab.id),tab.moving=!0,browser.tabs.move(tab.id,{index}).catch(err3=>{err("Tabs.onTabCreated: Cannot move the tab to the correct position:",err3)}).finally(()=>{tab.moving=void 0}));for(let i=index;i<Tabs2.list.length;i++)Tabs2.list[i].index++;if(Settings.state.tabsUnreadMark&&tab.unread===void 0&&!tab.active&&(tab.reactive.unread=tab.unread=!0),panel&&(tab.panelId=panel.id),tab.internal=tab.url.startsWith(ADDON_HOST),tab.internal&&(tab.isGroup=isGroupUrl(tab.url)),tab.index=index,tab.parentId=Settings.state.tabsTree?tab.openerTabId??NOID:NOID,!tab.favIconUrl&&!tab.internal&&!tab.url.startsWith("a")&&(tab.reactive.favIconUrl=tab.favIconUrl=getFavicon(tab.url)),!attached&&!Settings.state.autoExpandTabsOnNew&&Tabs2.byId[tab.parentId]?.folded&&(tab.invisible=!0),!attached&&tab.cookieStoreId===DEFAULT_CONTAINER_ID&&panel&&panel.newTabCtx!=="none"){let container=Containers.reactive.byId[panel.newTabCtx];container&&(tab.reopenInContainer=container.id)}if(Tabs2.byId[tab.id]=tab,Tabs2.list.splice(index,0,tab),Tabs2.reactivateTab(tab),Sidebar.recalcTabsPanels(),tab.invisible||Sidebar.addToVisibleTabs(panel.id,tab),Tabs2.updateUrlCounter(tab.url,1),Settings.state.tabsTree&&!tab.pinned&&panel){let treeHasChanged=!1;if(tab.openerTabId===void 0){let nextTab=Tabs2.list[tab.index+1];nextTab&&tab.panelId===nextTab.panelId&&(tab.parentId=nextTab.parentId,tab.lvl=nextTab.lvl,tab.reactive.lvl=nextTab.lvl)}else{let parent=Tabs2.byId[tab.openerTabId];if(parent&&parent.panelId===tab.panelId){parent.folded&&!attached&&(Settings.state.autoExpandTabsOnNew?Tabs2.expTabsBranch(parent.id):Tabs2.triggerFlashAnimation(parent));let insideBranch=!1;for(let t,i=parent.index+1;i<Tabs2.list.length&&(t=Tabs2.list[i],insideBranch=t.id===tab.id,!(insideBranch||t.lvl<=parent.lvl));i++);insideBranch?(tab.parentId=tab.openerTabId,treeHasChanged=!0):(tab.parentId=-1,tab.openerTabId=void 0)}}if(reopenedTabInfo&&reopenedTabInfo.children)for(let t,i=tab.index+1;i<Tabs2.list.length&&(t=Tabs2.list[i],!(t.lvl<tab.lvl||t.panelId!==panel.id));i++)if(reopenedTabInfo.children.includes(t.id))t.parentId=tab.id,treeHasChanged=!0;else break;if(treeHasChanged&&Tabs2.updateTabsTree(panel.startTabIndex,panel.nextTabIndex),!attached){let groupTab=Tabs2.getGroupTab(tab);groupTab&&!groupTab.discarded&&groupPage(groupTab.id,{index:groupTab.index,createdTab:{id:tab.id,index:tab.index,lvl:tab.lvl-groupTab.lvl-1,title:tab.title,url:tab.url,discarded:!!tab.discarded,favIconUrl:tab.favIconUrl}})}if(Settings.state.colorizeTabs&&Tabs2.colorizeTabDebounced(tab.id,120),Settings.state.colorizeTabsBranches&&tab.lvl>0&&Tabs2.setBranchColor(tab.id),tab.openerTabId!==void 0&&Settings.state.inheritCustomColor){let parent=Tabs2.byId[tab.openerTabId];parent?.customColor&&(tab.reactive.customColor=tab.customColor=parent.customColor)}}if(Tabs2.saveTabData(tab.id),Tabs2.cacheTabsData(),initialOpenerId!==tab.openerTabId){let newOpenerTabId;tab.openerTabId===void 0||tab.openerTabId===-1?newOpenerTabId=tab.id:newOpenerTabId=tab.openerTabId,browser.tabs.update(tab.id,{openerTabId:newOpenerTabId}).catch(err3=>{err("Tabs.onTabCreated: Cannot update openerTabId",err3)})}if(Tabs2.updateSuccessionDebounced(100),createGroup&&!tab.pinned&&initialOpener&&Tabs2.groupTabs([tab.id],{active:!1,title:initialOpener.title,pin:initialOpenerSpec,pinnedTab:initialOpener}),Settings.state.hideInact&&!tab.active){let activeTab=Tabs2.byId[Tabs2.activeId];activeTab&&activeTab.panelId!==panel.id&&browser.tabs.hide?.(tab.id).catch(err3=>{err("Tabs.onTabCreated: Cannot hide tab:",err3)})}!tab.pinned&&!tab.active&&!tab.invisible&&tab.panelId===Sidebar.activePanelId&&Tabs2.scrollToTabDebounced(120,tab.id,!0),tab.active&&deferredActivationHandling.id===tab.id&&deferredActivationHandling.cb&&(deferredActivationHandling.cb(),deferredActivationHandling.cb=null),panel&&Tabs2.decrementScrollRetainer(panel),attached&&(tab.audible||tab.mediaPaused||tab.mutedInfo?.muted)&&Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab)}function onTabUpdated(tabId,change,nativeTab){if(nativeTab.windowId!==Windows.id)return;if(Tabs2.list.length===0||waitForOtherReopenedTabsBuffer||Tabs2.sorting){Tabs2.deferredEventHandling.push(()=>onTabUpdated(tabId,change,nativeTab));return}let tab=Tabs2.byId[tabId];if(!tab)return warn(`Tabs.onTabUpdated: Cannot find local tab: ${tabId}`);if(change.discarded!==void 0){if(change.discarded){Tabs2.updateSuccessionDebounced(15),tab.status==="loading"&&(tab.status="complete",tab.reactive.status=1),tab.loading&&(tab.loading=!1);let mediaStateChanged=!1;tab.audible&&(mediaStateChanged=!0,tab.audible=!1,tab.reactive.mediaAudible=!1),tab.mediaPaused&&(mediaStateChanged=!0,tab.mediaPaused=!1,tab.reactive.mediaPaused=!1),mediaStateChanged&&Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab);let groupTab=Tabs2.getGroupTab(tab);groupTab&&!groupTab.discarded&&Tabs2.updateGroupChild(groupTab.id,nativeTab.id),tab.favIconUrl||(tab.favIconUrl=getFavicon(tab.url),tab.reactive.favIconUrl=tab.favIconUrl)}Sidebar.checkDiscardedTabsInPanelDebounced(tab.panelId,120)}change.status!==void 0&&(change.status==="complete"&&nativeTab.url[0]!=="a"&&(Settings.state.animations&&change.status!==tab.status&&Tabs2.triggerFlashAnimation(tab),reloadTabFaviconDebounced(tab)),change.url&&tab.mediaPaused&&(tab.mediaPaused=!1,tab.reactive.mediaPaused=!1,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab)));let branchColorizationNeeded=!1;if(change.url!==void 0&&change.url!==tab.url){let isInternal=change.url.startsWith(ADDON_HOST),isGroup=isInternal&&isGroupUrl(change.url);if(tab.isGroup!==isGroup&&(tab.reactive.isGroup=tab.isGroup=isGroup),tab.internal=isInternal,Tabs2.cacheTabsData(),change.url.startsWith(tab.url.slice(0,16))||(tab.favIconUrl="",tab.reactive.favIconUrl=""),tab.pinned&&tab.relGroupId!==void 0){let groupTab=Tabs2.byId[tab.relGroupId];if(groupTab){let oldUrl=encodeURIComponent(tab.url),newUrl=encodeURIComponent(change.url),groupUrl=groupTab.url.replace(oldUrl,newUrl);browser.tabs.update(groupTab.id,{url:groupUrl}).catch(err3=>{err("Tabs.onTabUpdated: Cannot reload related group page:",err3)})}}tab.mediaPaused&&(tab.mediaPaused=!1,tab.reactive.mediaPaused=!1,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab)),Settings.state.colorizeTabs&&Tabs2.colorizeTabDebounced(tabId,120),Settings.state.colorizeTabsBranches&&(branchColorizationNeeded=tab.isParent&&tab.lvl===0,tab.lvl===0&&(tab.reactive.branchColor=null)),Tabs2.moveRules.length&&!tab.pinned&&change.url!=="about:blank"&&Tabs2.moveByRule(tabId,120);let oldUrlCount=Tabs2.updateUrlCounter(tab.url,-1);Tabs2.updateUrlCounter(change.url,1),Settings.state.highlightOpenBookmarks&&(oldUrlCount||Bookmarks.unmarkOpenBookmarksDebounced(tab.url),Bookmarks.markOpenBookmarksDebounced(change.url)),Tabs2.updateTooltipDebounced(tabId,1e3),Search.rawValue&&Sidebar.activePanelId===tab.panelId&&!Sidebar.subPanelActive&&Search.searchDebounced(500,void 0,!0)}if(change.favIconUrl&&change.favIconUrl.startsWith("chrome:")&&(change.favIconUrl==="chrome://global/skin/icons/warning.svg"&&(tab.warn=!0,tab.reactive.warn=!0),change.favIconUrl=""),change.title!==void 0){if(change.title.startsWith(EXT_HOST)&&(change.title=tab.title),(Settings.state.tabsUpdateMark==="all"||Settings.state.tabsUpdateMark==="pin"&&tab.pinned||Settings.state.tabsUpdateMark==="norm"&&!tab.pinned)&&!nativeTab.active&&!tab.internal&&Date.now()-nativeTab.lastAccessed>5e3&&tab.url===nativeTab.url&&(Settings.state.tabsUpdateMarkFirst||!URL_HOST_PATH_RE.test(tab.title))&&!URL_HOST_PATH_RE.test(nativeTab.title)){let panel=Sidebar.panelsById[tab.panelId];tab.updated=!0,tab.reactive.updated=!0,isTabsPanel(panel)&&(!nativeTab.pinned||Settings.state.pinnedTabsPosition==="panel")&&panel.updatedTabs&&!panel.updatedTabs.includes(tabId)&&(panel.updatedTabs.push(tabId),panel.reactive.updated=panel.updatedTabs.length>0)}tab.isGroup&&tab.active&&change.title!==GROUP_INITIAL_TITLE&&tab.reactive.customTitle&&(tab.customTitle=void 0,tab.reactive.customTitle=null),Tabs2.updateTooltipDebounced(tabId,1e3),Search.rawValue&&Sidebar.activePanelId===tab.panelId&&!Sidebar.subPanelActive&&Search.searchDebounced(500,void 0,!0)}if(change.audible!==void 0&&change.audible&&tab.mediaPaused&&(tab.mediaPaused=!1,tab.reactive.mediaPaused=!1),Object.assign(tab,change),change.audible!==void 0&&(tab.reactive.mediaAudible=change.audible),change.discarded!==void 0&&(tab.reactive.discarded=change.discarded),change.favIconUrl!==void 0&&(tab.internal?tab.reactive.favIconUrl=void 0:tab.reactive.favIconUrl=change.favIconUrl),change.mutedInfo?.muted!==void 0&&(tab.reactive.mediaMuted=change.mutedInfo.muted),change.pinned!==void 0&&(tab.reactive.pinned=change.pinned),change.status!==void 0&&(tab.reactive.status=Tabs2.getStatus(tab)),change.title!==void 0&&(tab.reactive.title=change.title),change.url!==void 0&&(tab.reactive.url=change.url),(change.audible!==void 0||change.mutedInfo?.muted!==void 0)&&Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab),change.pinned!==void 0&&!change.pinned){let panel;if(Settings.state.pinnedTabsPosition==="panel"?panel=Sidebar.panelsById[tab.panelId]:(panel=Sidebar.panelsById[Sidebar.activePanelId],isTabsPanel(panel)||(panel=Sidebar.panelsById[Sidebar.lastTabsPanelId])),isTabsPanel(panel)||(panel=Sidebar.panels.find(isTabsPanel)),isTabsPanel(panel)){if(!tab.unpinning){let startIndex=panel.startTabIndex;tab.dstPanelId=tab.panelId=panel.id,Tabs2.list.splice(tab.index,1),Tabs2.list.splice(startIndex-1,0,tab),Tabs2.updateTabsIndexes(),Sidebar.recalcTabsPanels(),Sidebar.recalcVisibleTabs(tab.panelId);let relGroupTab=Tabs2.byId[tab.relGroupId];relGroupTab?Tabs2.replaceRelGroupWithPinnedTab(relGroupTab,tab):(tab.moving=!0,browser.tabs.move(tabId,{index:startIndex-1}).catch(err3=>{err("Tabs.onTabUpdated: Cannot move unpinned tab:",err3)}).finally(()=>{tab.moving=void 0}))}nativeTab.active&&Sidebar.activatePanel(panel.id)}(tab.audible||tab.mediaPaused||tab.mutedInfo?.muted)&&Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab)}if(change.pinned!==void 0&&change.pinned){let prevPanelId=tab.prevPanelId,panelId=tab.panelId,prevPanel=Sidebar.panelsById[prevPanelId],panel=Sidebar.panelsById[panelId];prevPanel&&tab.moveTime&&tab.moveTime+1e3>Date.now()&&(tab.panelId=prevPanelId,Tabs2.saveTabData(tab.id),tab.active&&panelId===Sidebar.activePanelId&&prevPanelId!==Sidebar.activePanelId&&Sidebar.activatePanel(tab.panelId)),Sidebar.recalcTabsPanels(),Tabs2.updateTabsTree(),panel&&Sidebar.recalcVisibleTabs(panelId),prevPanel&&panelId!==prevPanelId&&Sidebar.recalcVisibleTabs(prevPanelId);let actualPanel=Sidebar.panelsById[tab.panelId];isTabsPanel(actualPanel)&&!actualPanel.reactive.len&&actualPanel.noEmpty&&Tabs2.createTabInPanel(actualPanel)}branchColorizationNeeded&&Tabs2.colorizeBranch(tab.id)}var reloadTabFaviconTimeout={};function reloadTabFaviconDebounced(tab,delay=500){clearTimeout(reloadTabFaviconTimeout[tab.id]),reloadTabFaviconTimeout[tab.id]=setTimeout(()=>{if(delete reloadTabFaviconTimeout[tab.id],tab.internal){tab.favIconUrl=void 0,tab.reactive.favIconUrl=void 0;return}browser.tabs.get(tab.id).then(tabInfo=>{tabInfo.favIconUrl&&!tabInfo.favIconUrl.startsWith("chrome:")?(tab.favIconUrl=tabInfo.favIconUrl,tab.reactive.favIconUrl=tabInfo.favIconUrl):(tabInfo.favIconUrl==="chrome://global/skin/icons/warning.svg"?(tab.warn=!0,tab.reactive.warn=!0):tab.warn&&(tab.warn=!1,tab.reactive.warn=!1),tab.favIconUrl="",tab.reactive.favIconUrl="");let groupTab=Tabs2.getGroupTab(tab);groupTab&&!groupTab.discarded&&Tabs2.updateGroupChild(groupTab.id,tab.id)}).catch(()=>{})},delay)}var recentlyRemovedChildParentMap=null,rememberChildTabsTimeout;function rememberChildTabs(childId,parentId){recentlyRemovedChildParentMap||(recentlyRemovedChildParentMap={}),recentlyRemovedChildParentMap[childId]=parentId,clearTimeout(rememberChildTabsTimeout),rememberChildTabsTimeout=setTimeout(()=>{recentlyRemovedChildParentMap=null},100)}function onTabRemoved(tabId,info2,detached){if(info2.windowId!==Windows.id)return;if(Tabs2.list.length===0||waitForOtherReopenedTabsBuffer||Tabs2.sorting){Tabs2.deferredEventHandling.push(()=>onTabRemoved(tabId,info2,detached));return}if(info2.isWindowClosing||Tabs2.ignoreTabsEvents)return;if(Tabs2.tabsReinitializing)return Tabs2.reinitTabs();let removedExternally=!Tabs2.removingTabs||!Tabs2.removingTabs.length;if(Tabs2.removingTabs.length>0){Tabs2.checkRemovedTabs();let rmIndex=Tabs2.removingTabs.indexOf(tabId);rmIndex!==-1&&Tabs2.removingTabs.splice(rmIndex,1)}Tabs2.removingTabs.length||(Menu.close(),Selection.resetSelection());let tab=Tabs2.byId[tabId];if(!tab)return warn(`Tabs.onTabRemoved: Cannot find tab: ${tabId}`),Tabs2.reinitTabs();let toShow=[],nextTab=Tabs2.list[tab.index+1],hasChildren=Settings.state.tabsTree&&tab.isParent&&nextTab&&nextTab.parentId===tab.id&&nextTab.panelId===tab.panelId,removedTabInfo;!detached&&tab.url!==NEWTAB_URL&&tab.url!=="about:blank"&&(tab.isParent||!tab.url.startsWith("m"))&&(removedTabInfo={id:tab.id,index:tab.index,title:tab.title,parentId:recentlyRemovedChildParentMap?.[tab.id]??tab.parentId,panelId:tab.panelId},Tabs2.removedTabs.unshift(removedTabInfo),Tabs2.removedTabs.length>64&&(Tabs2.removedTabs=Tabs2.removedTabs.slice(0,50))),removedExternally&&!detached&&Tabs2.rememberRemoved([tab]);let autoGroup=!tab.isGroup&&!tab.folded&&hasChildren&&Settings.state.autoGroupOnClose&&!Settings.state.autoGroupOnCloseMouseOnly&&(tab.lvl===0||!Settings.state.autoGroupOnClose0Lvl),fullVisTabsRecalcNeeded=!1;handling_descendants:if(hasChildren){let toRemove=[],outdentOnlyFirstChild=!autoGroup&&Settings.state.treeRmOutdent==="first_child",firstChild=nextTab;if(tab.reopening&&tab.reopening.id!==NOID){let newTab=Tabs2.byId[tab.reopening.id];if(newTab){newTab.folded=tab.folded,newTab.reactive.folded=tab.folded,newTab.isParent=tab.isParent,newTab.reactive.isParent=tab.isParent,Tabs2.forEachDescendant(tab,t=>{t.parentId===tab.id&&(t.parentId=newTab.id)});break handling_descendants}}for(let i=tab.index+1,t;i<Tabs2.list.length&&(t=Tabs2.list[i],!(t.lvl<=tab.lvl));i++){if(detached&&Tabs2.detachingTabIds.indexOf(t.id)!==-1)continue;t.parentId===tab.id&&!detached&&(rememberChildTabs(t.id,tab.id),removedTabInfo?.children?removedTabInfo.children.push(t.id):removedTabInfo&&(removedTabInfo.children=[t.id]));let willBeRemoved=Tabs2.removingTabs.includes(t.id);if(!willBeRemoved)if(Settings.state.rmChildTabs==="folded"&&tab.folded&&!detached&&!tab.reopening||Settings.state.rmChildTabs==="all"&&!detached&&!tab.reopening){toRemove.push(t.id);continue}else t.invisible&&(t.parentId===tabId||!Tabs2.byId[t.parentId]?.folded)&&(t.invisible=!1,fullVisTabsRecalcNeeded=!0,t.hidden&&toShow.push(t.id));if(autoGroup&&t.parentId===tabId&&Tabs2.groupOnClosing(tab.id,tab.title,tab.active,t.id),firstChild.id===t.id)t.parentId=tab.parentId,t.reactive.lvl=t.lvl=tab.lvl;else if(t.parentId===tab.id)outdentOnlyFirstChild?(t.parentId=firstChild.id,firstChild.isParent||(firstChild.isParent=!0,firstChild.reactive.isParent=!0)):(t.parentId=tab.parentId,t.reactive.lvl=t.lvl=tab.lvl);else{let parentTab=Tabs2.byId[t.parentId];parentTab&&(t.reactive.lvl=t.lvl=parentTab.lvl+1)}willBeRemoved||Tabs2.saveTabData(t.id)}Settings.state.rmChildTabs!=="none"&&toRemove.length&&Tabs2.removeTabs(toRemove,!1,tab),toShow.length&&browser.tabs.show?.(toShow).catch(()=>{warn("Tabs.onTabRemoved: Cannot show native tabs")})}for(let i=tab.index+1;i<Tabs2.list.length;i++)Tabs2.list[i].index--;delete Tabs2.byId[tabId],Tabs2.list.splice(tab.index,1),Sidebar.recalcTabsPanels();let urlCount=Tabs2.updateUrlCounter(tab.url,-1),panel=Sidebar.panelsById[tab.panelId];if(!isTabsPanel(panel)){err("Tabs.onTabRemoved: Wrong panel");return}if(fullVisTabsRecalcNeeded&&!Tabs2.removingTabs.length?Sidebar.recalcVisibleTabs(panel.id):Sidebar.removeFromVisibleTabs(panel.id,tabId),!tab.pinned&&panel.noEmpty&&!panel.reactive.len&&Tabs2.createTabInPanel(panel,{active:!1}),panel.updatedTabs.length&&(rmFromArray(panel.updatedTabs,tabId),panel.reactive.updated=panel.updatedTabs.length>0),!Tabs2.removingTabs.length){if(Settings.state.tabsTree&&tab.parentId!==NOID){let parentTab=Tabs2.byId[tab.parentId];if(parentTab){removedExternally&&parentTab.reactive.branchLen--;let nextTab2=Tabs2.list[parentTab.index+1];(!nextTab2||nextTab2?.parentId!==tab.parentId)&&(parentTab.isParent=!1,parentTab.folded=!1,parentTab.reactive.isParent=!1,parentTab.reactive.folded=!1)}}Tabs2.cacheTabsData();let tabSuccessor=Tabs2.updateSuccessionDebounced(0);if(Settings.state.hideEmptyPanels&&!panel.tabs.length&&Tabs2.activeId!==tabId&&!panel.pinnedTabs.length&&Sidebar.activePanelId===panel.id&&!Sidebar.switchingLock){let activeTab=Tabs2.byId[Tabs2.activeId];activeTab&&!activeTab.pinned?Sidebar.activatePanel(activeTab.panelId):tabSuccessor?Sidebar.activatePanel(tabSuccessor.panelId):Sidebar.switchToNeighbourPanel()}Search.rawValue&&Search.search(),(tab.audible||tab.mediaPaused||tab.mutedInfo?.muted)&&Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId)}Settings.state.highlightOpenBookmarks&&!urlCount&&Bookmarks.unmarkOpenBookmarksDebounced(tab.url);let pinGroupTab=Tabs2.byId[tab.relGroupId];if(tab.pinned&&pinGroupTab){let groupUrl=new URL(pinGroupTab.url);groupUrl.searchParams.delete("pin"),browser.tabs.update(tab.relGroupId,{url:groupUrl.href}).catch(err3=>{err("Tabs.onTabRemoved: Cannot reload related group page:",err3)})}let groupTab=Tabs2.getGroupTab(tab);groupTab&&!groupTab.discarded&&groupPage(groupTab.id,{removedTab:tab.id}),state.status===2&&state.targetTabId===tabId&&resetTargetTab(tabId)}function onTabMoved(id,info2){if(info2.windowId!==Windows.id)return;if(Tabs2.list.length===0){Tabs2.deferredEventHandling.push(()=>onTabMoved(id,info2));return}if(Tabs2.ignoreTabsEvents)return;if(Tabs2.tabsReinitializing)return Tabs2.reinitTabs();let tab=Tabs2.byId[id];if(!tab){let msg=`Tab cannot be moved: #${id} ${info2.fromIndex} > ${info2.toIndex} (not found by id)`;warn(msg);return}Tabs2.movingTabs.splice(Tabs2.movingTabs.indexOf(id),1);let mvLen=Tabs2.movingTabs.length;if(mvLen||(Menu.close(),Selection.resetSelection()),tab.moving!==void 0){tab.dstPanelId=NOID,Tabs2.saveTabData(id),Tabs2.cacheTabsData(640),tab.active&&Tabs2.updateSuccessionDebounced(0);return}if(tab.unpinning)return;let toTab=Tabs2.list[info2.toIndex],movedTab=Tabs2.list[info2.fromIndex];if(movedTab&&movedTab.id===id)Tabs2.list.splice(info2.fromIndex,1);else return err(`Tabs.onTabMoved: #${id} ${info2.fromIndex} > ${info2.toIndex}: Not found by index`),Tabs2.reinitTabs();movedTab.moveTime=Date.now(),movedTab.prevPanelId=movedTab.panelId,Tabs2.list.splice(info2.toIndex,0,movedTab);let minIndex=Math.min(info2.fromIndex,info2.toIndex),maxIndex=Math.max(info2.fromIndex,info2.toIndex);Tabs2.updateTabsIndexes(minIndex,maxIndex+1);let srcPanel,dstPanel;if(!movedTab.pinned){srcPanel=Sidebar.panelsById[movedTab.panelId],dstPanel=Sidebar.panelsById[movedTab.dstPanelId],movedTab.dstPanelId=NOID;let outOfPanel=isTabsPanel(dstPanel)&&dstPanel.startTabIndex>-1&&dstPanel.endTabIndex>-1&&(dstPanel.startTabIndex>info2.toIndex||dstPanel.endTabIndex+1<info2.toIndex);(!dstPanel||outOfPanel)&&(dstPanel=Sidebar.panelsById[toTab.panelId]),isTabsPanel(srcPanel)&&isTabsPanel(dstPanel)&&srcPanel.id!==dstPanel.id&&(movedTab.panelId=dstPanel.id,Sidebar.updateMediaStateOfPanelDebounced(100,movedTab.panelId,movedTab))}Sidebar.recalcTabsPanels();let nativeTabsVisibilityUpdateNeeded=!1;if(Settings.state.tabsTree){let toTabFolded=toTab.folded;if(mvLen||Tabs2.updateTabsTree(),toTabFolded!==toTab.folded&&Settings.state.hideFoldedTabs&&(nativeTabsVisibilityUpdateNeeded=!0),Settings.state.colorizeTabsBranches&&tab.lvl>0&&Tabs2.setBranchColor(tab.id),Settings.state.inheritCustomColor&&tab.lvl>0){let parentTab=Tabs2.byId[tab.parentId];parentTab&&parentTab.customColor&&parentTab.customColor!==tab.customColor&&(tab.reactive.customColor=tab.customColor=parentTab.customColor)}}srcPanel&&Sidebar.recalcVisibleTabs(srcPanel.id),dstPanel&&dstPanel!==srcPanel&&Sidebar.recalcVisibleTabs(dstPanel.id),movedTab.panelId!==Sidebar.activePanelId&&movedTab.active&&(Sidebar.activatePanel(movedTab.panelId),Settings.state.hideInact&&(nativeTabsVisibilityUpdateNeeded=!0)),mvLen||Tabs2.cacheTabsData(),Tabs2.saveTabData(movedTab.id),mvLen||Tabs2.updateSuccessionDebounced(0),nativeTabsVisibilityUpdateNeeded&&Tabs2.updateNativeTabsVisibility()}function onTabDetached(id,info2){if(info2.oldWindowId!==Windows.id)return;if(Tabs2.list.length===0||Tabs2.sorting){Tabs2.deferredEventHandling.push(()=>onTabDetached(id,info2));return}if(Tabs2.ignoreTabsEvents)return;if(Tabs2.tabsReinitializing)return Tabs2.reinitTabs();let tab=Tabs2.byId[id];tab&&(tab.folded=!1,tab.reactive.folded=!1);let di=Tabs2.detachingTabIds.indexOf(id);di!==-1&&Tabs2.detachingTabIds.splice(di,1),onTabRemoved(id,{windowId:Windows.id,isWindowClosing:!1},!0),Tabs2.detachingTabIds.length===0&&Settings.state.hideFoldedTabs&&Tabs2.updateNativeTabsVisibility()}var deferredActivationHandling={id:NOID,cb:null};async function onTabAttached(id,info2){if(info2.newWindowId!==Windows.id)return;if(Tabs2.list.length===0||Tabs2.sorting){Tabs2.deferredEventHandling.push(()=>onTabAttached(id,info2));return}if(Tabs2.ignoreTabsEvents)return;if(Tabs2.tabsReinitializing)return Tabs2.reinitTabs();let ai=Tabs2.attachingTabs.findIndex(t=>t.id===id),tab;if(ai>-1)tab=Tabs2.attachingTabs.splice(ai,1)[0];else{deferredActivationHandling.id=id;let nativeTab=await browser.tabs.get(id);tab=Tabs2.mutateNativeTabToSideberyTab(nativeTab)}tab.windowId=Windows.id,tab.index=info2.newPosition,tab.panelId=NOID,tab.reactive.sel=tab.sel=!1,Tabs2.reactivateTab(tab),onTabCreated(tab,!0),tab.active&&browser.tabs.update(tab.id,{active:!0}).catch(err3=>{err("Tabs.onTabAttached: Cannot activate tab",err3)}),Tabs2.attachingTabs.length===0&&Settings.state.hideFoldedTabs&&Tabs2.updateNativeTabsVisibility(),deferredActivationHandling.id=NOID}var bufTabActivatedEventIndex=-1;function onTabActivated(info2){if(info2.windowId!==Windows.id)return;if(Tabs2.list.length===0||waitForOtherReopenedTabsBuffer){bufTabActivatedEventIndex!==-1&&Tabs2.deferredEventHandling.splice(bufTabActivatedEventIndex,1),bufTabActivatedEventIndex=Tabs2.deferredEventHandling.push(()=>onTabActivated(info2))-1;return}if(bufTabActivatedEventIndex=-1,Tabs2.ignoreTabsEvents)return;if(Tabs2.tabsReinitializing)return Tabs2.reinitTabs();DnD.reactive.isStarted||Selection.resetSelection();let tab=Tabs2.byId[info2.tabId];if(!tab){if(deferredActivationHandling.id===info2.tabId){deferredActivationHandling.cb=()=>onTabActivated(info2);return}return err("Tabs.onTabActivated: Cannot get target tab",info2.tabId),Tabs2.reinitTabs()}let prevActive=Tabs2.byId[Tabs2.activeId];if(prevActive){prevActive.reactive.active=prevActive.active=!1,Tabs2.writeActiveTabsHistory(prevActive,tab);let hideFolded=Settings.state.hideFoldedTabs,hideFoldedParent=hideFolded&&Settings.state.hideFoldedParent==="any",hideFoldedGroup=hideFolded&&Settings.state.hideFoldedParent==="group";prevActive?.folded&&(hideFoldedParent||hideFoldedGroup&&prevActive.isGroup)&&browser.tabs.hide?.(prevActive.id).catch(err3=>{err("Tabs.onTabActivated: Cannot hide prev active tab",err3)})}tab.reactive.active=tab.active=!0,Settings.state.tabsUpdateMark!=="none"&&(tab.reactive.updated=tab.updated=!1),Settings.state.tabsUnreadMark&&(tab.reactive.unread=tab.unread=!1),tab.lastAccessed=Date.now(),Tabs2.activeId=info2.tabId;let panel=Sidebar.panelsById[tab.panelId];if(!isTabsPanel(panel))return;panel.updatedTabs.length&&(rmFromArray(panel.updatedTabs,tab.id),panel.reactive.updated=panel.updatedTabs.length>0);let activePanel=Sidebar.panelsById[Sidebar.activePanelId];if(Settings.state.switchPanelAfterSwitchingTab!=="no"&&(!tab.pinned||Settings.state.pinnedTabsPosition==="panel")&&!activePanel?.lockedPanel&&!Sidebar.switchingLock&&(Settings.state.switchPanelAfterSwitchingTab==="mouseleave"&&Mouse.mouseIn?activePanel.id!==tab.panelId&&(Sidebar.switchOnMouseLeave=!0):Sidebar.subPanelActive||Sidebar.activatePanel(panel.id)),(!prevActive||prevActive.panelId!==tab.panelId)&&Settings.state.hideInact&&Tabs2.updateNativeTabsVisibility(),Settings.state.tabsTree&&tab.parentId!==-1&&Settings.state.autoFoldTabs&&Settings.state.autoFoldTabsExcept!=="none"){let parent=Tabs2.byId[tab.parentId];if(parent)for(parent.childLastAccessed=tab.lastAccessed;parent=Tabs2.byId[parent.parentId];)parent.childLastAccessed=tab.lastAccessed}if(Settings.state.autoExpandTabs&&tab.isParent&&tab.folded&&!DnD.reactive.isStarted){let prevActiveChild;for(let i=tab.index+1;i<Tabs2.list.length&&!(Tabs2.list[i].lvl<=tab.lvl);i++)if(Tabs2.list[i].id===info2.previousTabId){prevActiveChild=!0;break}prevActiveChild||Tabs2.expTabsBranch(tab.id)}tab.invisible&&Tabs2.expTabsBranch(tab.parentId),tab.pinned||Tabs2.scrollToTabDebounced(3,tab.id,!0),Tabs2.updateSuccessionDebounced(10),Settings.state.previewTabs&&state.modeFallback&&resetMode()}var tabs_fg_groups_exports={};__export(tabs_fg_groups_exports,{getGroupConfig:()=>getGroupConfig,getGroupInfo:()=>getGroupInfo,getGroupTab:()=>getGroupTab,groupOnClosing:()=>groupOnClosing,groupTabs:()=>groupTabs,linkGroupWithPinnedTab:()=>linkGroupWithPinnedTab,openGroupConfigPopup:()=>openGroupConfigPopup,replaceRelGroupWithPinnedTab:()=>replaceRelGroupWithPinnedTab,setGroupName:()=>setGroupName,updateActiveGroupPage:()=>updateActiveGroupPage,updateGroupChild:()=>updateGroupChild,updateGroupTab:()=>updateGroupTab});function linkGroupWithPinnedTab(groupTab,tabs){let info2=new URL(groupTab.url),pin=info2.searchParams.get("pin");if(!pin)return;let[ctx,url]=pin.split("::"),pinnedTab;for(let tab of tabs){if(!tab.pinned)break;if(tab.pinned&&tab.cookieStoreId===ctx&&tab.url===url){pinnedTab=tab;break}}if(!pinnedTab){info2.searchParams.delete("pin"),groupTab.url=info2.href,browser.tabs.update(groupTab.id,{url:info2.href}).catch(err3=>{err("Tabs.linkGroupWithPinnedTab: Cannot update url:",err3)});return}pinnedTab.relGroupId=groupTab.id}async function replaceRelGroupWithPinnedTab(groupTab,pinnedTab){await browser.tabs.move(pinnedTab.id,{index:groupTab.index-1}),sleep(120),groupTab.parentId=pinnedTab.id,Tabs2.updateTabsTree(),await browser.tabs.remove(groupTab.id)}async function groupTabs(tabIds,conf){let noConfig=!conf;conf||(conf={});let tabs=[];for(let t of Tabs2.list)tabIds.includes(t.id)?tabs.push(t):tabIds.includes(t.parentId)&&(tabIds.push(t.id),tabs.push(t));if(!tabs.length||Settings.state.tabsTreeLimit!=="none"&&tabs[0].lvl>=Settings.state.tabsTreeLimit)return;if(!conf.title){let titles=tabs.map(t=>t.title),commonPart=commonSubStr(titles),isOk=commonPart?commonPart[0]===commonPart[0].toUpperCase():!1,groupTitle=commonPart.replace(/^(\s|\.|_|-|—|–|\(|\)|\/|=|;|:)+/g," ").replace(/(\s|\.|_|-|—|–|\(|\)|\/|=|;|:)+$/g," ").trim();if(!isOk||groupTitle.length<4){let hosts=tabs.filter(t=>!t.url.startsWith("about:")).map(t=>t.url.split("/")[2]);groupTitle=commonSubStr(hosts),groupTitle.startsWith(".")&&(groupTitle=groupTitle.slice(1)),groupTitle=groupTitle.replace(/^www\./,"")}(!isOk||groupTitle.length<4)&&(groupTitle=tabs[0].title),conf.title=groupTitle}if(noConfig&&Settings.state.showNewGroupConf&&await Tabs2.openGroupConfigPopup(conf)===2)return;let panelId=tabs[0].panelId,panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel))return;Tabs2.setNewTabPosition(tabs[0].index,tabs[0].parentId,tabs[0].panelId);let groupTab=await browser.tabs.create({active:!!conf.active,cookieStoreId:tabs[0].cookieStoreId,index:tabs[0].index,url:createGroupUrl(conf.title,conf),windowId:Windows.id});conf.pinnedTab&&(conf.pinnedTab.relGroupId=groupTab.id);let properIndex=tabs[0].index,tabsToMove=[],indexToMoveTo=-1;for(let tab of tabs)tab.index!==properIndex&&(indexToMoveTo===-1&&(indexToMoveTo=properIndex),tabsToMove.push(tab)),properIndex++;let dst={index:groupTab.index+1,panelId:panel.id,parentId:groupTab.id};await Tabs2.move(tabs,{},dst)}async function openGroupConfigPopup(config){return new Promise(ok=>{reactive.groupConfigPopup={config,done:result=>ok(result)}})}function getPinInfo(groupUrl){if(!groupUrl.includes("pin="))return;let pinValue=new URL(groupUrl).searchParams.get("pin");if(!pinValue)return;let[ctr,url]=pinValue.split("::"),pinnedTab=Tabs2.list.find(t=>t.pinned&&t.cookieStoreId===ctr&&t.url===url);if(pinnedTab)return{id:pinnedTab.id,title:pinnedTab.title,url:pinnedTab.url,favIconUrl:pinnedTab.favIconUrl??""}}async function getGroupInfo(groupTabId){Tabs2.ready||await Tabs2.waitForTabsReady(),ready||await waitForFaviconsReady();let groupTab=Tabs2.byId[groupTabId];if(!groupTab)return warn("Tabs.getGroupInfo: No group tab:",groupTabId),null;let out={id:groupTab.id,index:groupTab.index,len:0,tabs:[]},parentTab=Tabs2.byId[groupTab.parentId];parentTab&&parentTab.isGroup&&(out.parentId=parentTab.id);let pinInfo=getPinInfo(groupTab.url);pinInfo&&(out.pin=pinInfo);let subGroupLvl=null;for(let i=groupTab.index+1;i<Tabs2.list.length;i++){let tab=Tabs2.list[i];if(tab.lvl<=groupTab.lvl)break;out.len++,!(subGroupLvl&&tab.lvl>subGroupLvl)&&(subGroupLvl=null,tab.isGroup&&(subGroupLvl=tab.lvl),out.tabs.push({id:tab.id,index:tab.index,lvl:tab.lvl-groupTab.lvl-1,title:tab.customTitle??tab.title,url:tab.url,discarded:!!tab.discarded,favIconUrl:tab.favIconUrl??""}))}return out}function getGroupTab(tab){if(!tab||!Settings.state.tabsTree&&!tab.lvl)return;let i=tab.lvl||0;for(;i--;){if(tab=Tabs2.byId[tab.parentId],!tab)return;if(tab&&tab.isGroup)return tab}}var grouppingTimeout,grouppingBuffers=new Map;function groupOnClosing(id,title,active,childTabId){let conf=grouppingBuffers.get(id);conf||(conf={title,active,ids:[]},grouppingBuffers.set(id,conf)),conf.ids.push(childTabId),clearTimeout(grouppingTimeout),grouppingTimeout=setTimeout(()=>{for(let[id2,conf2]of grouppingBuffers)groupTabs(conf2.ids,{title:conf2.title,active:conf2.active});grouppingBuffers.clear()},250)}function updateGroupTab(groupTab){let tabsCount=Tabs2.list.length,tabs=[],subGroupLvl=null,len=0;for(let i=groupTab.index+1;i<tabsCount;i++){let tab=Tabs2.list[i];if(tab.lvl<=groupTab.lvl)break;len++,!(subGroupLvl&&tab.lvl>subGroupLvl)&&(subGroupLvl=null,tab.isGroup&&(subGroupLvl=tab.lvl),tabs.push({id:tab.id,index:tab.index,lvl:tab.lvl-groupTab.lvl-1,title:tab.customTitle??tab.title,url:tab.url,discarded:!!tab.discarded,favIconUrl:tab.favIconUrl??""}))}let msg={index:groupTab.index,parentId:groupTab.parentId,tabs,len},parentTab=Tabs2.byId[groupTab.parentId];parentTab&&parentTab.isGroup&&(msg.parentId=parentTab.id),groupPage(groupTab.id,msg)}var updateGroupTabDebounced=debounce(updateGroupTab);function updateActiveGroupPage(){let activeTab=Tabs2.byId[Tabs2.activeId];activeTab||(activeTab=Tabs2.list.find(t=>t.active)),activeTab&&activeTab.isGroup&&updateGroupTabDebounced(256,activeTab)}var updateGroupChildTimeouts={};function updateGroupChild(groupId,childId,delay=250){clearTimeout(updateGroupChildTimeouts[childId]),updateGroupChildTimeouts[childId]=setTimeout(()=>{let groupTab=Tabs2.byId[groupId],childTab=Tabs2.byId[childId];if(!groupTab||groupTab.discarded||!childTab)return;let updatedTab={id:childTab.id,index:childTab.index,status:childTab.status,title:childTab.title,url:childTab.url,lvl:childTab.lvl-groupTab.lvl-1,discarded:!!childTab.discarded,favIconUrl:childTab.favIconUrl||getFavicon(childTab.url)};groupPage(groupTab.id,{updatedTab})},delay)}function getGroupConfig(groupTabId){let groupTab=Tabs2.byId[groupTabId];if(!groupTab)return;let urlInfo;try{urlInfo=new URL(groupTab.url)}catch{return}urlInfo.hash||(urlInfo.hash="");let config={active:groupTab.active},title=decodeURIComponent(urlInfo.hash.slice(1));config.title=title.split(":id:")[0];let pin=urlInfo.searchParams.get("pin");if(pin){let[ctx,url]=pin.split("::"),pinnedTab;for(let tab of Tabs2.list){if(!tab.pinned)break;if(url===tab.url&&ctx===tab.cookieStoreId){pinnedTab=tab;break}}pinnedTab&&(config.pin=pin,config.pinnedTab=pinnedTab)}return config}function setGroupName(groupTabId,newName){let groupTab=Tabs2.byId[groupTabId];if(!groupTab)return;let config=getGroupConfig(groupTabId);if(!config)return;let isDiscarded=groupTab.discarded,newUrl=createGroupUrl(newName,config);browser.tabs.update(groupTabId,{url:newUrl}).then(()=>{if(!isDiscarded)return groupPage(groupTabId,{title:newName})}).catch(()=>{warn("setGroupName: Cannot update url")})}var tabs_fg_shadow_exports={};__export(tabs_fg_shadow_exports,{loadInShadowMode:()=>loadInShadowMode,resetShadowListeners:()=>resetShadowListeners,setupShadowListeners:()=>setupShadowListeners,unloadShadowed:()=>unloadShadowed});async function loadInShadowMode(){setupShadowListeners(),Tabs2.shadowMode=!0;let tabs=await browser.tabs.query({windowId:browser.windows.WINDOW_ID_CURRENT});Tabs2.list=tabs;for(let tab of tabs)Tabs2.byId[tab.id]=tab,Tabs2.updateUrlCounter(tab.url,1);Tabs2.deferredEventHandling.length&&warn("Tabs: Deferred event handlers:",Tabs2.deferredEventHandling.length),Tabs2.deferredEventHandling.forEach(cb=>cb()),Tabs2.deferredEventHandling=[]}function unloadShadowed(){Tabs2.resetShadowListeners(),Tabs2.byId={},Tabs2.urlsInUse={},Tabs2.list=[],Tabs2.shadowMode=!1}function setupShadowListeners(){browser.tabs.onCreated.addListener(onShadowTabCreated),browser.tabs.onRemoved.addListener(onShadowTabRemoved),browser.tabs.onUpdated.addListener(onShadowTabUpdated,{properties:["pinned","title","status","favIconUrl","url"]}),browser.tabs.onActivated.addListener(onShadowTabActivated),browser.tabs.onMoved.addListener(onShadowTabMoved),browser.tabs.onAttached.addListener(onShadowTabAttached),browser.tabs.onDetached.addListener(onShadowTabDetached)}function resetShadowListeners(){browser.tabs.onCreated.removeListener(onShadowTabCreated),browser.tabs.onUpdated.removeListener(onShadowTabUpdated),browser.tabs.onRemoved.removeListener(onShadowTabRemoved),browser.tabs.onMoved.removeListener(onShadowTabMoved),browser.tabs.onDetached.removeListener(onShadowTabDetached),browser.tabs.onAttached.removeListener(onShadowTabAttached),browser.tabs.onActivated.removeListener(onShadowTabActivated)}function onShadowTabCreated(tab){if(tab.windowId!==Windows.id)return;if(Tabs2.list.length===0){Tabs2.deferredEventHandling.push(()=>onShadowTabCreated(tab));return}Tabs2.byId[tab.id]=tab,Tabs2.list.splice(tab.index,0,tab);let len=Tabs2.list.length;for(let i=tab.index;i<len;i++)Tabs2.list[i].index=i;Tabs2.updateUrlCounter(tab.url,1),Settings.state.highlightOpenBookmarks&&Bookmarks.markOpenBookmarksDebounced(tab.url)}function onShadowTabUpdated(tabId,change,tab){if(tab.windowId!==Windows.id)return;if(Tabs2.list.length===0){Tabs2.deferredEventHandling.push(()=>onShadowTabUpdated(tabId,change,tab));return}let targetTab=Tabs2.byId[tabId];if(targetTab){if(change.url){let oldUrlCount=Tabs2.updateUrlCounter(targetTab.url,-1);Tabs2.updateUrlCounter(change.url,1),Settings.state.highlightOpenBookmarks&&(oldUrlCount||Bookmarks.unmarkOpenBookmarksDebounced(targetTab.url),Bookmarks.markOpenBookmarksDebounced(change.url))}Object.assign(targetTab,change)}}function onShadowTabRemoved(tabId,info2){if(info2.windowId!==Windows.id)return;if(Tabs2.list.length===0){Tabs2.deferredEventHandling.push(()=>onShadowTabRemoved(tabId,info2));return}let targetTab=Tabs2.byId[tabId];if(!targetTab)return;let index=targetTab.index;if(targetTab!==Tabs2.list[index]&&(index=Tabs2.list.findIndex(t=>t.id===tabId)),index!==-1){Tabs2.list.splice(index,1);let len=Tabs2.list.length;for(let i=index;i<len;i++)Tabs2.list[i].index=i}delete Tabs2.byId[tabId];let urlCount=Tabs2.updateUrlCounter(targetTab.url,-1);Settings.state.highlightOpenBookmarks&&!urlCount&&Bookmarks.unmarkOpenBookmarksDebounced(targetTab.url)}function onShadowTabMoved(id,info2){if(info2.windowId!==Windows.id)return;if(Tabs2.list.length===0){Tabs2.deferredEventHandling.push(()=>onShadowTabMoved(id,info2));return}let movedTab=Tabs2.list.splice(info2.fromIndex,1)[0];Tabs2.list.splice(info2.toIndex,0,movedTab);for(let i=Tabs2.list.length;i--;)Tabs2.list[i].index=i}function onShadowTabDetached(tabId,info2){if(info2.oldWindowId===Windows.id){if(Tabs2.list.length===0){Tabs2.deferredEventHandling.push(()=>onShadowTabDetached(tabId,info2));return}onShadowTabRemoved(tabId,{windowId:info2.oldWindowId,isWindowClosing:!1})}}async function onShadowTabAttached(tabId,info2){if(info2.newWindowId!==Windows.id)return;if(Tabs2.list.length===0){Tabs2.deferredEventHandling.push(()=>onShadowTabAttached(tabId,info2));return}let tab=await browser.tabs.get(tabId);tab.windowId=Windows.id,tab.index=info2.newPosition,onShadowTabCreated(tab)}function onShadowTabActivated(info2){if(info2.windowId!==Windows.id)return;if(Tabs2.list.length===0){Tabs2.deferredEventHandling.push(()=>onShadowTabActivated(info2));return}let prevTab=Tabs2.byId[info2.previousTabId],targetTab=Tabs2.byId[info2.tabId];prevTab&&(prevTab.active=!1),targetTab&&(targetTab.active=!0)}var tabs_fg_scroll_exports={};__export(tabs_fg_scroll_exports,{decrementScrollRetainer:()=>decrementScrollRetainer,incrementScrollRetainer:()=>incrementScrollRetainer,resetScrollRetainer:()=>resetScrollRetainer,scrollToTab:()=>scrollToTab,scrollToTabDebounced:()=>scrollToTabDebounced});var scrollConf2={behavior:"auto",top:0};function scrollToTab(id,smooth){let panel=Sidebar.panelsById[Sidebar.activePanelId];if(!isTabsPanel(panel)||!panel.scrollEl)return;if(scrollConf2.behavior=smooth?"smooth":"auto",panel.tabs[panel.tabs.length-1]?.id===id){let scrolableEl=panel.scrollComponent?.getScrollableBox();if(!scrolableEl)return;let pH2=panel.scrollEl.offsetHeight;scrollConf2.top=scrolableEl.offsetHeight-pH2,panel.scrollEl.scroll(scrollConf2);return}let elId="tab"+id.toString(),el=document.getElementById(elId);if(!el)return warn("Tabs.scrollToTab: Cannot find tab element");let pH=panel.scrollEl.offsetHeight,pS=panel.scrollEl.scrollTop,tH=el.offsetHeight,tY=el.offsetTop;if(tY<pS+PRE_SCROLL){if(pS>0){let y=tY-PRE_SCROLL;y<0&&(y=0),scrollConf2.top=y,panel.scrollEl.scroll(scrollConf2)}}else tY+tH>pS+pH-PRE_SCROLL&&(scrollConf2.top=tY+tH-pH+PRE_SCROLL,panel.scrollEl.scroll(scrollConf2))}var scrollToTabDebounced=debounce(scrollToTab);function incrementScrollRetainer(panel,count){if(!panel.scrollEl)return;let scrollTop=panel.scrollEl.scrollTop;if(scrollTop===0)return;let tabFullHeight=Sidebar.tabHeight+Sidebar.tabMargin;if(panel.scrollRetainer===0){let scrollHeight=panel.scrollEl.offsetHeight,scrollableHeight=panel.scrollEl.scrollHeight,changedHeight=count*tabFullHeight,dy=scrollableHeight-scrollHeight-scrollTop-changedHeight;if(dy>=0)return;panel.scrollRetainer=count,panel.reactive.scrollRetainerHeight=Math.abs(dy),Tabs2.blockedScrollPosition=!0}else panel.scrollRetainer+=count,panel.reactive.scrollRetainerHeight+=count*tabFullHeight,Tabs2.blockedScrollPosition=!0}function decrementScrollRetainer(panel,count=1){if(panel.scrollRetainer<=0){Tabs2.blockedScrollPosition=!1;return}let scrollRetainerHeight=panel.reactive.scrollRetainerHeight,tabFullHeight=Sidebar.tabHeight+Sidebar.tabMargin,decrHeight=count*tabFullHeight;decrHeight>scrollRetainerHeight&&(decrHeight=scrollRetainerHeight),panel.scrollRetainer-=count,panel.scrollRetainer<0&&(panel.scrollRetainer=0),panel.reactive.scrollRetainerHeight-=decrHeight,Tabs2.blockedScrollPosition=!0}function resetScrollRetainer(panel){panel.scrollRetainer=0,panel.reactive.scrollRetainerHeight=0,Tabs2.blockedScrollPosition=!1}var tabs_fg_edit_title_exports={};__export(tabs_fg_edit_title_exports,{editTabTitle:()=>editTabTitle,saveCustomTitle:()=>saveCustomTitle});async function editTabTitle(tabIds){Tabs2.sortTabIds(tabIds);let firstTabId=tabIds[0],tab=Tabs2.byId[firstTabId];if(!tab)return;if(tab.pinned){let ptp=Settings.state.pinnedTabsPosition;if(!Settings.state.pinnedTabsList||ptp==="left"||ptp==="right")return}Tabs2.editableTabId=tab.id,tab.reactive.customTitleEdit=!0,tab.reactive.customTitle=tab.customTitle??tab.title,await sleep(1);let selector=`#tab${tab.id} .custom-title-input`,inputEl2=document.querySelector(selector);inputEl2&&(await sleep(1),inputEl2.focus(),inputEl2.select())}function saveCustomTitle(tabId){let tab=Tabs2.byId[tabId];if(!tab)return;let value=tab.reactive.customTitle;if(value&&(value=value.trim()),value===tab.title&&(value=""),isGroupUrl(tab.url)&&value){Tabs2.setGroupName(tab.id,value);return}else value?(tab.customTitle=value,tab.reactive.customTitle=value):(tab.customTitle=void 0,tab.reactive.customTitle=null);Tabs2.saveTabData(tab.id),Tabs2.cacheTabsData()}var tabs_fg_colors_exports={};__export(tabs_fg_colors_exports,{colorizeBranch:()=>colorizeBranch,colorizeBranches:()=>colorizeBranches,colorizeTab:()=>colorizeTab,colorizeTabDebounced:()=>colorizeTabDebounced,colorizeTabs:()=>colorizeTabs,setBranchColor:()=>setBranchColor,setCustomColor:()=>setCustomColor});var CONTAINER_COLORS={blue:"#37adff",turquoise:"#00c79a",green:"#51cd00",yellow:"#ffcb00",orange:"#ff9f00",red:"#ff613d",pink:"#ff4bda",purple:"#af51f5"};function colorizeTabs(){for(let tab of Tabs2.list)colorizeTab(tab.id)}var colorizeTabTimeouts={};function colorizeTabDebounced(tabId,delayMS=500){clearTimeout(colorizeTabTimeouts[tabId]),colorizeTabTimeouts[tabId]=setTimeout(()=>{delete colorizeTabTimeouts[tabId],colorizeTab(tabId)},delayMS)}function colorizeTab(tabId){let tab=Tabs2.byId[tabId];if(!tab)return;let srcStr,color;if(Settings.state.colorizeTabsSrc==="domain")srcStr=getDomainOf(tab.url),color=colorFromString(srcStr,60);else{let container=Containers.reactive.byId[tab.cookieStoreId];container?color=CONTAINER_COLORS[container.color]:color=null}tab.reactive.color=color}function colorizeBranches(){for(let tab of Tabs2.list)tab.isParent&&tab.lvl===0&&colorizeBranch(tab.id)}function colorizeBranch(rootId){let rootTab=Tabs2.byId[rootId];if(!rootTab||rootTab.lvl>0)return;let srcStr;Settings.state.colorizeTabsBranchesSrc==="url"?srcStr=rootTab.url:srcStr=getDomainOf(rootTab.url);let color=colorFromString(srcStr,60);rootTab.reactive.branchColor=color;for(let i=rootTab.index+1;i<Tabs2.list.length;i++){let tab=Tabs2.list[i];if(tab.lvl===0)break;tab.reactive.branchColor=color}}function setBranchColor(tabId){let tab=Tabs2.byId[tabId];if(!tab)return;if(tab.parentId===NOID){tab.isParent?Tabs2.colorizeBranch(tab.id):tab.reactive.branchColor&&(tab.reactive.branchColor=null);return}let parent=Tabs2.byId[tab.parentId];for(;parent&&parent.lvl>0;)parent=Tabs2.byId[parent.parentId];parent&&(parent.reactive.branchColor?tab.reactive.branchColor=parent.reactive.branchColor:Tabs2.colorizeBranch(parent.id))}function setCustomColor(tabIds,color){Tabs2.sortTabIds(tabIds);for(let id of tabIds){let tab=Tabs2.byId[id];tab&&(tab.customColor=color!=="toolbar"?color:void 0,tab.reactive.customColor=tab.customColor??null,Tabs2.saveTabData(tab.id))}Tabs2.cacheTabsData()}var tabs_fg_rm_exports={};__export(tabs_fg_rm_exports,{checkRemovedTabs:()=>checkRemovedTabs,isRemovingFinished:()=>isRemovingFinished,rememberRemoved:()=>rememberRemoved,removeBranches:()=>removeBranches,removeOtherTabs:()=>removeOtherTabs,removeTabs:()=>removeTabs,removeTabsAbove:()=>removeTabsAbove,removeTabsBelow:()=>removeTabsBelow,removeTabsDescendants:()=>removeTabsDescendants,undoRemove:()=>undoRemove,undoRmTab:()=>undoRmTab});function removeBranches(ids){for(let tab of Tabs2.list)ids.includes(tab.parentId)&&ids.push(tab.id);removeTabs(ids)}function removeTabsDescendants(tabIds){if(!tabIds||!tabIds.length)return;let toRm=[];for(let tabId of tabIds){let tab=Tabs2.byId[tabId];if(!(!tab||tabIds.includes(tab.parentId)))for(let i=tab.index+1,t;i<Tabs2.list.length&&(t=Tabs2.list[i],!(!t||t.lvl<=tab.lvl));i++)toRm.includes(t.id)||toRm.push(t.id)}removeTabs(toRm)}function removeTabsAbove(tabIds){if(tabIds||(tabIds=[Tabs2.activeId]),!tabIds.length)return;let minIndex=999999,startTab;for(let id of tabIds){let tab=Tabs2.byId[id];tab&&tab.index<minIndex&&(minIndex=tab.index,startTab=tab)}if(!startTab||startTab.pinned)return;let toRm=[];for(let i=startTab.index;i--;){let tab=Tabs2.list[i];if(!tab||tab.pinned||tab.panelId!==startTab.panelId)break;toRm.push(tab.id)}removeTabs(toRm)}function removeTabsBelow(tabIds){if(tabIds||(tabIds=[Tabs2.activeId]),!tabIds.length)return;let maxIndex=-1,startTab;for(let id of tabIds){let tab=Tabs2.byId[id];tab&&tab.index>maxIndex&&(maxIndex=tab.index,startTab=tab)}if(!startTab||startTab.pinned)return;let toRm=[];for(let i=startTab.index+1;i<Tabs2.list.length;i++){let tab=Tabs2.list[i];if(!tab||tab.panelId!==startTab.panelId)break;toRm.push(tab.id)}removeTabs(toRm)}function removeOtherTabs(tabIds){if(tabIds||(tabIds=[Tabs2.activeId]),!tabIds.length)return;let firstTabId=tabIds[0];if(firstTabId===void 0)return;let firstTab=Tabs2.byId[firstTabId];if(!firstTab||firstTab.pinned)return;let panel=Sidebar.panelsById[firstTab.panelId];if(!isTabsPanel(panel))return;let panelTabs=panel.tabs,toRm=[];for(let tab of panelTabs)tabIds.includes(tab.id)||toRm.push(tab.id);removeTabs(toRm)}var RECENTLY_REMOVED_LIMIT_MIN=100,RECENTLY_REMOVED_LIMIT_MAX=150;function rememberRemoved(tabs){let minLvl=0,parent,parentIndex=0,timestamp=Date.now();for(let tab of tabs){if(tab.reopening)continue;if((tab.parentId===NOID||tab.parentId!==parent?.id)&&(parent=void 0),tab.parentId!==NOID&&tab.parentId!==parent?.id){let index=Tabs2.recentlyRemoved.findIndex(t=>t.id===tab.parentId);index!==-1?(parent=Tabs2.recentlyRemoved[index],parent.isParent||(parent.isParent=!0),parentIndex=index):parent=void 0}tab.parentId!==NOID&&!parent?minLvl=tab.lvl:tab.parentId===NOID&&(minLvl=0),parent?parentIndex++:parentIndex=0;let removedTabInfo={id:tab.id,url:tab.url,title:tab.title,parentId:parent?.id??NOID,isParent:!1,lvl:parent?tab.lvl-minLvl:0,containerId:tab.cookieStoreId,containerColor:Containers.reactive.byId[tab.cookieStoreId]?.color,favIconUrl:tab.favIconUrl,favPlaceholder:getFavPlaceholder(tab.url),time:timestamp};Tabs2.recentlyRemoved.splice(parentIndex,0,removedTabInfo)}Tabs2.recentlyRemoved.length>RECENTLY_REMOVED_LIMIT_MAX&&(Tabs2.recentlyRemoved=Tabs2.recentlyRemoved.slice(0,RECENTLY_REMOVED_LIMIT_MIN)),Tabs2.reactive.recentlyRemovedLen=Tabs2.recentlyRemoved.length}async function removeTabs(tabIds,silent,removedParent){if(!tabIds||!tabIds.length)return;let firstTabId=tabIds[0];if(firstTabId===void 0)return;let firstTab=Tabs2.byId[firstTabId];if(!firstTab)return;let panelId=firstTab.panelId,panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel))return;Tabs2.sortTabIds(tabIds);let rmChildTabsFolded=Settings.state.rmChildTabs==="folded",rmChildTabsFoldedAll=Settings.state.rmChildTabs==="all",tabsMap={},tabs=[],toRemove=[],hasInvisibleTab=!1;for(let id of tabIds){let tab=Tabs2.byId[id];if(tab&&tab.panelId===panelId&&(tabsMap[tab.id]||(tabsMap[id]=tab,tabs.push(tab),toRemove.push(id),tab.invisible&&(hasInvisibleTab=!0)),rmChildTabsFolded&&tab.folded||rmChildTabsFoldedAll))for(let t,i=tab.index+1;i<Tabs2.list.length&&(t=Tabs2.list[i],!(!t||t.lvl<=tab.lvl));i++)tabsMap[t.id]||(tabsMap[t.id]=t,tabs.push(t),toRemove.push(t.id),t.invisible&&(hasInvisibleTab=!0))}let count=tabs.length,warn2=Settings.state.warnOnMultiTabClose==="any"||hasInvisibleTab&&Settings.state.warnOnMultiTabClose==="collapsed";if(!silent&&warn2&&count>1){let pre=translate("confirm.tabs_close_pre",count),post=translate("confirm.tabs_close_post",count);if(!await confirm(pre+String(count)+post)){let visTabsRecalcNeeded=!1;tabs.forEach(t=>{t.invisible&&!Tabs2.byId[t.parentId]&&(visTabsRecalcNeeded||(visTabsRecalcNeeded=!0),t.invisible=!1)}),Tabs2.updateTabsTree(panel.startTabIndex,panel.nextTabIndex),visTabsRecalcNeeded&&Sidebar.recalcVisibleTabs(panelId);return}}let parents={},lastTabToo=panel.tabs[panel.tabs.length-1]?.id===tabs[count-1]?.id,visibleLen=0,activeTab;tabs.forEach(t=>{parents[t.id]=t.parentId,t.invisible||visibleLen++,t.invisible=!0,t.active&&(activeTab=t)}),tabs.length===1?Sidebar.removeFromVisibleTabs(tabs[0].panelId,tabs[0].id):Sidebar.recalcVisibleTabs(tabs[0]?.panelId??NOID);let tabsInfo=Tabs2.getTabsInfo(toRemove,!0);if(Tabs2.removingTabs&&Tabs2.removingTabs.length?Tabs2.removingTabs=[...Tabs2.removingTabs,...toRemove]:Tabs2.removingTabs=[...toRemove],Tabs2.rememberRemoved(tabs),count===panel.reactive.len&&panel.noEmpty&&Tabs2.createTabInPanel(panel),activeTab&&Tabs2.updateSuccessionDebounced(0,toRemove),!silent&&count>1&&Settings.state.tabsRmUndoNote&&!warn2){if(removedParent){let parentInfo=Tabs2.getTabInfo(removedParent.id,!0);parentInfo&&(parents[removedParent.id]=removedParent.parentId,tabsInfo.unshift(parentInfo),count++)}let detailsList=(count>3?tabsInfo.slice(0,2):tabsInfo).map(t=>"- "+t.title);count>3&&(detailsList=detailsList.concat("- ...")),Notifications.notify({icon:"#icon_trash",title:String(count)+translate("notif.tabs_rm_post",count),detailsList,ctrl:translate("notif.undo_ctrl"),callback:async()=>undoRemove(tabsInfo,parents)})}!Selection.isSet()&&visibleLen>0&&Tabs2.incrementScrollRetainer(panel,lastTabToo?visibleLen-1:visibleLen),toRemove.reverse(),browser.tabs.remove(toRemove).catch(err3=>{err("Tabs.removeTabs: Cannot remove tabs:",err3)}),checkRemovedTabs()}var isRmFinishedInterval;function isRemovingFinished(checkDelay=100,stopThreshold=3){clearInterval(isRmFinishedInterval);let prevLen=Tabs2.removingTabs.length,sameCounter=0;return new Promise(res=>{isRmFinishedInterval=setInterval(()=>{Tabs2.removingTabs.length===prevLen&&sameCounter++,prevLen=Tabs2.removingTabs.length,Tabs2.removingTabs.length===0&&(clearInterval(isRmFinishedInterval),res(!0)),sameCounter>=stopThreshold&&(clearInterval(isRmFinishedInterval),res(!1))},checkDelay)})}async function undoRemove(tabs,parents){let firstTab=tabs[0];if(!firstTab)return;let panel=Sidebar.panelsById[firstTab.panelId??NOID];if(!isTabsPanel(panel))return;let nextTabIndex=panel.nextTabIndex,oldNewIds={};for(let i=0;i<tabs.length;i++){let tab=tabs[i],index=nextTabIndex+i,parentId=oldNewIds[parents[tab.id]],parent=Tabs2.byId[parents[tab.id]];parentId===void 0&&parent&&parent.index<index&&(parentId=parent.id),Tabs2.setNewTabPosition(index,parentId,panel.id,!1);let conf={windowId:Windows.id,index,url:normalizeUrl(tab.url,tab.title),cookieStoreId:tab.container,active:!1};conf.url&&(conf.discarded=!0,conf.title=tab.title);let newTab=await browser.tabs.create(conf);oldNewIds[tab.id]=newTab.id}}var checkRemovedTabsTimeout;function checkRemovedTabs(delay=750){clearTimeout(checkRemovedTabsTimeout),checkRemovedTabsTimeout=setTimeout(async()=>{if(!Tabs2.removingTabs||!Tabs2.removingTabs.length)return;let panelIds=new Set,checking=[];for(let tabId of Tabs2.removingTabs){let t=Tabs2.byId[tabId];t&&panelIds.add(t.panelId);let checkingTab=browser.tabs.get(tabId).then(()=>{let tab=Tabs2.byId[tabId];if(tab){let parent=Tabs2.byId[tab.parentId];tab.reactive.lvl=tab.lvl=parent?parent.lvl+1:0,tab.invisible=!1;let rmIndex=Tabs2.removingTabs.indexOf(tab.id);rmIndex!==-1&&Tabs2.removingTabs.splice(rmIndex,1)}}).catch(()=>{});checking.push(checkingTab)}await Promise.all(checking);for(let panelId of panelIds)Sidebar.recalcVisibleTabs(panelId)},delay)}async function undoRmTab(){let closed=await browser.sessions.getRecentlyClosed();if(closed&&closed.length){let session=closed.find(c=>c.tab);session&&session.tab?.sessionId&&await browser.sessions.restore(session.tab.sessionId)}}var tabs_fg_move_exports={};__export(tabs_fg_move_exports,{findMoveRule:()=>findMoveRule,findMoveRuleBy:()=>findMoveRuleBy,move:()=>move,moveByRule:()=>moveByRule,moveToNewPanel:()=>moveToNewPanel,moveToThisWin:()=>moveToThisWin,recalcMoveRules:()=>recalcMoveRules});async function move(tabsInfo,src,dst){if(!tabsInfo.length||dst.windowChooseConf&&(dst.windowId=await Windows.showWindowsPopup(dst.windowChooseConf),dst.windowId===NOID))return;if(src.windowId!==void 0&&src.windowId!==Windows.id){let tabIds=tabsInfo.map(t=>t.id),externalTabs;try{externalTabs=await bg("getSidebarTabs",src.windowId,tabIds)}catch{warn("Tabs.move: Move tabs from another window: Cannot get tabs from sidebar")}if(!externalTabs){let winNativeTabs=await browser.tabs.query({windowId:src.windowId});externalTabs=[];for(let tabInfo of tabsInfo){let nativeTab=winNativeTabs.find(t=>t.id===tabInfo.id);if(!nativeTab)continue;let tab=Tabs2.mutateNativeTabToSideberyTab(nativeTab);tab.panelId=tabInfo.panelId??dst.panelId??NOID,externalTabs.push(tab)}}externalTabs&&moveToThisWin(externalTabs,dst);return}if(dst.windowId===NEWID){Tabs2.detachingTabIds=[];let info2=tabsInfo.map(t=>(Tabs2.detachingTabIds.push(t.id),{id:t.id,url:t.url,parentId:t.parentId,panelId:t.panelId??dst.panelId})),conf={incognito:dst.incognito,tabId:MOVEID};bg("createWindowWithTabs",info2,conf).finally(()=>Tabs2.detachingTabIds=[]);return}if(dst.windowId!==void 0&&dst.windowId!==Windows.id){let tabIds=tabsInfo.map(t=>t.id);return moveTabsToWin(tabIds,dst)}if(dst.parentId===void 0&&(dst.parentId=NOID),dst.index===void 0&&(dst.index=0),dst.index===-1){let panel=Sidebar.panelsById[dst.panelId??NOID];if(!isTabsPanel(panel))return warn("Tabs.move: No panel");dst.index=panel.nextTabIndex}let dstTab=Tabs2.list[dst.index],dstParent=Tabs2.byId[dst.parentId],pinnedTabs=[],normalTabs=[],toPin,toUnpin,tabs=[],isPinnedActive=!1;for(let info2 of tabsInfo){let tab=Tabs2.byId[info2.id];tab&&(tab.pinned?pinnedTabs.push(tab):normalTabs.push(tab),tabs.push(tab))}if(!tabs.length)return;if(pinnedTabs.length&&dst.pinned===void 0&&Settings.state.pinnedTabsPosition==="panel"){for(let tab of pinnedTabs)!isPinnedActive&&tab.active&&(isPinnedActive=!0),dst.panelId!==void 0&&((tab.audible||tab.mutedInfo?.muted||tab.mediaPaused)&&(Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId),Sidebar.updateMediaStateOfPanelDebounced(100,dst.panelId)),tab.panelId=dst.panelId),Tabs2.saveTabData(tab.id);tabs=normalTabs}else if(pinnedTabs.length&&!dst.pinned){for(let tab of pinnedTabs)tab.reactive.pinned=tab.pinned=!1;toUnpin=pinnedTabs}else if(normalTabs.length&&dst.pinned){for(let tab of normalTabs)tab.reactive.pinned=tab.pinned=!0;toPin=normalTabs}if(!tabs.length){Sidebar.recalcTabsPanels(),Tabs2.cacheTabsData(),isPinnedActive&&dst.pinned===void 0&&dst.panelId!==void 0&&Settings.state.tabsPanelSwitchActMove&&Sidebar.activatePanel(dst.panelId);return}let oneAfterAnother=tabs.every((tab,ix)=>ix===0||tab.index===tabs[ix-1].index+1),srcIndex=tabs[0].index,ids=[],dstIndexIncluded=-1,prevIndex=0,panelIsChanged=!1,isActive=!1,isMediaActive=!1,mediaPrevPanelId,srcPanelId;for(let tab of tabs){let index=Tabs2.list.indexOf(tab,prevIndex);if(index===-1)continue;Tabs2.list.splice(index,1),tab.active&&(isActive=!0),prevIndex=index,ids.push(tab.id),dstTab&&dstTab.id===tab.id&&(dstIndexIncluded=index),dst.panelId!==void 0&&tab.panelId!==dst.panelId&&(panelIsChanged||(panelIsChanged=!0),srcPanelId=tab.panelId,!isMediaActive&&(tab.audible||tab.mutedInfo?.muted||tab.mediaPaused)&&(isMediaActive=!0,mediaPrevPanelId=tab.panelId),tab.panelId=dst.panelId);let oldParent=Tabs2.byId[tab.parentId];tab.parentId!==dst.parentId&&(!oldParent||!tabs.includes(oldParent))&&(tab.parentId=dst.parentId,dstParent?browser.tabs.update(tab.id,{openerTabId:dst.parentId}):browser.tabs.update(tab.id,{openerTabId:tab.id}))}if(dstTab){let dstIndex=dstIndexIncluded!==-1?dstIndexIncluded:Tabs2.list.indexOf(dstTab);if(dstIndex===-1)return warn("Tabs.move: Cannot find index of the dstTab");Tabs2.list.splice(dstIndex,0,...tabs)}else Tabs2.list.splice(Tabs2.list.length,0,...tabs);if(Tabs2.updateTabsIndexes(),Tabs2.updateTabsTree(),Sidebar.recalcTabsPanels(),srcPanelId&&Sidebar.recalcVisibleTabs(srcPanelId),dst.panelId&&dst.panelId!==srcPanelId&&Sidebar.recalcVisibleTabs(dst.panelId),isMediaActive&&mediaPrevPanelId&&dst.panelId&&(Sidebar.updateMediaStateOfPanelDebounced(100,mediaPrevPanelId),Sidebar.updateMediaStateOfPanelDebounced(100,dst.panelId)),isActive&&dst.pinned===void 0&&dst.panelId!==void 0&&Settings.state.tabsPanelSwitchActMove&&Sidebar.activatePanel(dst.panelId),Settings.state.colorizeTabsBranches)for(let tab of tabs)Tabs2.setBranchColor(tab.id);if(Settings.state.inheritCustomColor&&dstParent&&dstParent.customColor)for(let tab of tabs)tab.customColor!==dstParent.customColor&&(tab.reactive.customColor=tab.customColor=dstParent.customColor);if(isActive&&dstParent&&dstParent.folded&&browser.tabs.update(dstParent.id,{active:!0}).catch(err3=>{err("Tabs.move: Cannot activate tab:",err3)}),dstParent?.folded&&Settings.state.discardFolded&&Tabs2.autoDiscardFolded(dstParent),dstParent?.isGroup&&Tabs2.updateGroupTab(dstParent),tabs.forEach(t=>Tabs2.saveTabData(t.id)),Tabs2.cacheTabsData(),Tabs2.movingTabs.push(...ids),tabs.forEach(t=>t.moving=!0),toUnpin?.length)for(let tab of toUnpin)tab.unpinning=!0,await browser.tabs.update(tab.id,{pinned:!1}).catch(err3=>{err("Tabs.move: Cannot unpin tab",err3)}),tab.unpinning=!1;if(toPin?.length)for(let tab of toPin)await browser.tabs.update(tab.id,{pinned:!0,openerTabId:tab.id}).catch(err3=>{err("Tabs.move: Cannot pin tab",err3)});let samePosition=srcIndex===tabs[0].index;if(!(oneAfterAnother&&samePosition)){let nativeDstIndex=dst.index<=tabs[0].index?dst.index:dst.index-1;await browser.tabs.move(ids,{windowId:Windows.id,index:nativeDstIndex}).catch(err3=>{err("Tabs.move: Cannot move native tabs",err3)})}tabs.forEach(t=>t.moving=void 0),Tabs2.movingTabs=[],(Settings.state.hideFoldedTabs||Settings.state.hideInact&&panelIsChanged)&&Tabs2.updateNativeTabsVisibility()}async function moveTabsToWin(tabIds,dst){(dst.windowId===void 0||dst.windowId===NOID)&&(dst.windowChooseConf?dst.windowId=await Windows.showWindowsPopup(dst.windowChooseConf):dst.windowId=await Windows.showWindowsPopup()),Tabs2.sortTabIds(tabIds);let activeTabId=tabIds.find(id=>Tabs2.byId[id]?.active),activeTab=activeTabId!==void 0?Tabs2.byId[activeTabId]:void 0;if(activeTab){let target=Tabs2.findSuccessorTab(activeTab,tabIds);target&&await browser.tabs.moveInSuccession([activeTab.id],target.id)}let tabs=[];for(let id of tabIds){let tab=Tabs2.byId[id];tab&&(tabs.push(cloneObject(tab)),Tabs2.detachingTabIds.push(tab.id))}let sidebarIsOpen;dst.windowId!==Windows.id&&(sidebarIsOpen=await browser.sidebarAction.isOpen({windowId:dst.windowId}).catch(()=>!1));let moved;sidebarIsOpen&&(delete dst.windowChooseConf,moved=await sidebar(dst.windowId,"moveTabsToThisWin",tabs,dst).catch(()=>!1)),moved||await browser.tabs.move(tabs.map(t=>t.id),{windowId:dst.windowId,index:-1}),Tabs2.cacheTabsData()}async function moveToThisWin(tabs,dst){if(!tabs||!tabs.length)return!1;Tabs2.attachingTabs?Tabs2.attachingTabs.push(...tabs):Tabs2.attachingTabs=[...tabs];let isPinned=tabs[0].pinned,panel=Sidebar.panelsById[dst?.panelId??NOID];isTabsPanel(panel)||(panel=Sidebar.panelsById[tabs[0].panelId]);let nextIndex;isTabsPanel(panel)&&panel.nextTabIndex>-1?nextIndex=panel.nextTabIndex:nextIndex=Tabs2.list.length,dst||(dst={panelId:tabs[0].panelId,parentId:-1}),dst.index===void 0&&(dst.index=isPinned?Tabs2.pinned.length:nextIndex);let tabIds=tabs.map(t=>t.id);for(let i=0;i<tabs.length;i++){let tab=tabs[i],parent=Tabs2.byId[dst.parentId??tab.parentId??NOID],index=(dst.index??0)+i;!!tab.pinned!=!!dst.pinned&&(await browser.tabs.update(tab.id,{pinned:!!dst.pinned}),tab.pinned=!!dst.pinned,tab.reactive.pinned=tab.pinned),tab.hidden=!1,(tab.parentId===-1||tab.parentId!==-1&&!tabIds.includes(tab.parentId))&&(tab.reactive.lvl=tab.lvl=parent?parent.lvl+1:0,tab.parentId=parent?parent.id:-1),tab.isParent&&!tabs.find(t=>t.parentId===tab.id)&&(tab.isParent=!1,tab.folded=!1),Tabs2.setNewTabPosition(index,tab.parentId,dst.panelId??NOID),browser.tabs.move(tab.id,{windowId:Windows.id,index}).catch(err3=>{err("Tabs.moveToThisWin: Cannot move tab:",err3)})}return!0}async function moveToNewPanel(tabIds){if(!tabIds.length)return;Tabs2.sortTabIds(tabIds);let probeTab=Tabs2.byId[tabIds[0]];if(!probeTab)return warn("Tabs.moveToNewPanel: No first tab");let srcPanel=Sidebar.panelsById[probeTab?.panelId??NOID];if(!isTabsPanel(srcPanel))return warn("Tabs.moveToNewPanel: No src panel");let index=Sidebar.reactive.nav.indexOf(srcPanel.id);if(index===-1)return warn("Tabs.moveToNewPanel: Cannot find target index");let noTabsPanels=!Sidebar.hasTabs,result=await openPanelPopup({type:2},index+1);if(!result)return;let dstPanel=Sidebar.panelsById[result];if(!isTabsPanel(dstPanel))return;Sidebar.activatePanel(dstPanel.id),noTabsPanels&&await Tabs2.load();let items=Tabs2.getTabsInfo(tabIds),src={windowId:Windows.id,panelId:srcPanel.id,pinned:probeTab.pinned};await Tabs2.move(items,src,{panelId:dstPanel.id,index:dstPanel.nextTabIndex})}function recalcMoveRules(){let rules=[];for(let panel of Sidebar.panels)if(isTabsPanel(panel)&&panel.moveRules.length)for(let ruleConf of panel.moveRules){if(!ruleConf.active)continue;let rule=createMoveToPanelRule(ruleConf,panel.id);rule&&rules.push(rule)}rules.sort((a,b)=>{let aN=a.containerId?1:0;aN+=a.urlRE||a.urlStr?1:0;let bN=b.containerId?1:0;return bN+=b.urlRE||b.urlStr?1:0,bN-aN}),Tabs2.moveRules=rules}function createMoveToPanelRule(config,panelId){let rule={panelId};if(config.containerId&&(config.containerId===DEFAULT_CONTAINER_ID||Containers.reactive.byId[config.containerId])&&(rule.containerId=config.containerId),config.url)if(config.url.startsWith("/")&&config.url.endsWith("/"))try{rule.urlRE=new RegExp(config.url.slice(1,-1))}catch{rule.urlStr=config.url}else rule.urlStr=config.url;if(!(!rule.containerId&&!rule.urlRE&&!rule.urlStr))return config.topLvlOnly&&(rule.topLvlOnly=config.topLvlOnly),rule}var moveByRuleTimeouts=new Map;function moveByRule(tabId,delay){let timeout=moveByRuleTimeouts.get(tabId);clearTimeout(timeout),timeout=setTimeout(()=>{let tab=Tabs2.byId[tabId];if(!tab||!Tabs2.moveRules.length)return;let currentPanel=Sidebar.panelsById[tab.panelId],excludeTo=NOID;isTabsPanel(currentPanel)&&(excludeTo=currentPanel.moveExcludedTo);let rule=Tabs2.findMoveRule(tab);if(rule){if(rule.panelId===tab.panelId)return;let panelId=rule.panelId;moveTabToPanel(tab,panelId)}else excludeTo!==NOID&&excludeTo!==tab.panelId&&!tab.url.startsWith("a")&&!tab.url.startsWith("m")&&moveTabToPanel(tab,excludeTo)},delay),moveByRuleTimeouts.set(tabId,timeout)}function moveTabToPanel(tab,panelId){let panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel))return;let index=Settings.state.moveNewTabParent==="start"?panel.startTabIndex:panel.nextTabIndex,src={windowId:Windows.id,pinned:tab.pinned},dst={panelId,index};inQueue(Tabs2.move,[tab],src,dst),tab.active&&Settings.state.tabsPanelSwitchActMoveAuto&&Sidebar.switchToPanel(panelId,!0,!0)}function findMoveRuleBy(containerId,lvl){for(let rule of Tabs2.moveRules)if(!(rule.urlRE||rule.urlStr)&&!(rule.containerId&&rule.containerId!==containerId)&&!(rule.topLvlOnly&&lvl!==void 0&&lvl>0))return rule}function findMoveRule(tab){for(let rule of Tabs2.moveRules)if(!(rule.topLvlOnly&&tab.lvl>0)&&!(rule.containerId&&rule.containerId!==tab.cookieStoreId)){if(rule.urlStr){if(!tab.url.includes(rule.urlStr))continue}else if(rule.urlRE&&!rule.urlRE.test(tab.url))continue;return rule}}var tabs_fg_create_exports={};__export(tabs_fg_create_exports,{createChildTab:()=>createChildTab,createFromDragEvent:()=>createFromDragEvent,createTabAfter:()=>createTabAfter,createTabInNewContainer:()=>createTabInNewContainer,createTabInPanel:()=>createTabInPanel,getIndexForNewTab:()=>getIndexForNewTab,getPanelForNewTab:()=>getPanelForNewTab,getParentForNewTab:()=>getParentForNewTab,handleReopening:()=>handleReopening,open:()=>open3,openInContainer:()=>openInContainer,reopen:()=>reopen,reopenInContainer:()=>reopenInContainer,reopenTabsInNewContainer:()=>reopenTabsInNewContainer,setNewTabPosition:()=>setNewTabPosition});function createTabAfter(tabId){let targetTab=Tabs2.byId[tabId];if(!targetTab)return;let parentId=targetTab.parentId,index=targetTab.index+1;for(;Tabs2.list[index]&&Tabs2.list[index].lvl>targetTab.lvl;)index++;Tabs2.setNewTabPosition(index,parentId,targetTab.panelId),browser.tabs.create({index,cookieStoreId:targetTab.cookieStoreId,windowId:Windows.id}).catch(err3=>{err("Tabs.createTabAfter: Cannot create tab:",err3)})}function createChildTab(tabId,url,containerId){let targetTab=Tabs2.byId[tabId];if(!targetTab)return;let panel=Sidebar.panelsById[targetTab.panelId];if(!isTabsPanel(panel))return;let conf={openerTabId:tabId,autoGroupped:!1,index:targetTab.index+1},targetIndex=Tabs2.getIndexForNewTab(panel,conf);Tabs2.setNewTabPosition(targetIndex,targetTab.id,targetTab.panelId);let config={index:targetIndex,cookieStoreId:targetTab.cookieStoreId,windowId:Windows.id};url&&(config.url=url),containerId&&(config.cookieStoreId=containerId),browser.tabs.create(config).catch(err3=>{err("Tabs.createChildTab: Cannot create tab:",err3)})}var _creatingTabInPanel=!1,_createTabInPanelQueue=[];async function createTabInPanel(panel,conf){if(!isTabsPanel(panel))return;if(_creatingTabInPanel){_createTabInPanelQueue.push(()=>createTabInPanel(panel,conf));return}if(Tabs2.moveRules.length&&conf?.cookieStoreId){let rule=Tabs2.findMoveRuleBy(conf.cookieStoreId);if(rule){let panelByRule=Sidebar.panelsById[rule.panelId];isTabsPanel(panelByRule)&&(panel=panelByRule)}}let tabShell={},index=Tabs2.getIndexForNewTab(panel,tabShell),parentId=Tabs2.getParentForNewTab(panel);if(!isTabsPanel(panel))return;index===void 0&&panel.nextTabIndex>-1&&(index=panel.nextTabIndex);let config={index,windowId:Windows.id,cookieStoreId:conf?.cookieStoreId};if(conf?.url&&(config.url=conf.url),conf?.active!==void 0&&(config.active=conf.active),index!==void 0&&Tabs2.setNewTabPosition(index,parentId??NOID,panel.id),panel.newTabCtx!=="none"&&!conf?.cookieStoreId&&(config.cookieStoreId=panel.newTabCtx),_creatingTabInPanel=!0,await browser.tabs.create(config).catch(err3=>{err("Tabs.createTabInPanel: Cannot create tab:",err3)}),_creatingTabInPanel=!1,_createTabInPanelQueue.length){let cb=_createTabInPanelQueue.shift();cb&&cb()}}function handleReopening(tabId,dstContainerId){let targetTab=Tabs2.byId[tabId];if(!targetTab)return;dstContainerId||(dstContainerId=CONTAINER_ID),targetTab.reopening={id:NOID};let parentId=-1,panel,panelId,index;if(Tabs2.moveRules.length){let rule=Tabs2.findMoveRuleBy(dstContainerId,targetTab.lvl);rule&&(panel=Sidebar.panelsById[rule.panelId])}return panel?(index=Tabs2.getIndexForNewTab(panel,{}),index===void 0&&(index=panel.nextTabIndex),panelId=panel.id):(parentId=targetTab.parentId,panelId=targetTab.panelId),index===void 0&&(index=targetTab.index),Tabs2.setNewTabPosition(index,parentId,panelId),index}async function createFromDragEvent(e,dst){let dndInfo=e.dataTransfer?.getData("application/x-sidebery-dnd");if(dndInfo){let info2;try{info2=JSON.parse(dndInfo)}catch{return}if(info2.items){let groupUrlStartRe=/^moz-extension:\/\/.{36}\/(page.)?group\/group\.html(.+)$/;for(let item of info2.items)item.url&&groupUrlStartRe.test(item.url)&&(item.url=item.url.replace(groupUrlStartRe,(_,_1,$2)=>GROUP_URL+$2));Tabs2.open(info2.items,dst)}return}let result=await parseDragEvent(e),panel=Sidebar.panelsById[dst.panelId??NOID];if(!isTabsPanel(panel))return;let container=Containers.reactive.byId[panel.newTabCtx],inside=dst.index===-1;if(dst.parentId===void 0&&(dst.parentId=NOID),inside){let parentTab=Tabs2.byId[dst.parentId];parentTab&&(dst.index=parentTab.index+1)}if(result?.file&&(result.url=URL.createObjectURL(result.file)),result?.text&&!result?.url){let trimmedText=result.text.trim();/^https?:\/\/[^\s]{4,}$/.test(trimmedText)&&(result.url=trimmedText)}if(result?.url){if(dst.inside&&+dst.parentId>-1&&e.shiftKey)browser.tabs.update(dst.parentId,{url:result.url}).catch(err3=>{err("Tabs.createFromDragEvent: Cannot update tab url:",err3)});else{let conf={active:Settings.state.dndActTabFromLink,url:normalizeUrl(result.url),index:dst.index,cookieStoreId:container?.id,windowId:Windows.id,pinned:dst.pinned};e.ctrlKey&&(conf.active=!1),e.altKey&&(conf.active=!1,conf.discarded=!0,conf.title=result.text||result.url),Tabs2.setNewTabPosition(dst.index??0,dst.parentId,panel.id),browser.tabs.create(conf).catch(err3=>{err("Tabs.createFromDragEvent: Cannot create tab:",err3)})}return}if(result?.text){let tabId;if(dst.inside&&+dst.parentId>-1&&e.shiftKey)tabId=dst.parentId;else{let conf={active:Settings.state.dndActSearchTab,index:dst.index,cookieStoreId:container?.id,windowId:Windows.id,pinned:dst.pinned};e.ctrlKey&&(conf.active=!1),Tabs2.setNewTabPosition(dst.index??0,dst.parentId,panel.id),tabId=(await browser.tabs.create(conf)).id}browser.search.search({query:result.text,tabId})}}async function reopen(tabsInfo,dst,idsMap){let minIndex=tabsInfo[0]?.index??999999,maxIndex=tabsInfo[0]?.index??0;tabsInfo.sort((a,b)=>a.index===void 0||b.index===void 0?0:(minIndex>a.index&&(minIndex=a.index),minIndex>b.index&&(minIndex=b.index),maxIndex<a.index&&(maxIndex=a.index),maxIndex<b.index&&(maxIndex=b.index),a.index-b.index));let treeUpdate={};for(let info2 of tabsInfo){let tab=Tabs2.byId[info2.id];if(tab){treeUpdate[tab.id]=[];for(let i=tab.index+1;i<Tabs2.list.length;i++){let nextTab=Tabs2.list[i];if(!nextTab||nextTab.lvl<=tab.lvl)break;maxIndex<nextTab.index&&(maxIndex=nextTab.index),nextTab.parentId===tab.id&&treeUpdate[tab.id].push(nextTab.id)}}}if(idsMap||(idsMap={}),!await open3(tabsInfo,dst,idsMap))return err("Tabs: Cannot reopen tabs");let ids=tabsInfo.map(ti=>ti.id);dst.windowId!==void 0&&dst.windowId!==Windows.id&&ids.includes(Tabs2.activeId)&&Tabs2.updateSuccessionDebounced(0,ids);let toRemove=tabsInfo.map(t=>t.id);Tabs2.removingTabs=[...toRemove],await browser.tabs.remove(toRemove);let treeUpdateNeeded=!1;for(let oldId of Object.keys(treeUpdate)){let children=treeUpdate[oldId],newId=idsMap[oldId];if(!(!children?.length||newId===void 0)){treeUpdateNeeded||(treeUpdateNeeded=!0);for(let childId of children){let childTab=Tabs2.byId[childId];childTab&&(childTab.parentId=newId)}}}treeUpdateNeeded&&Tabs2.updateTabsTree(minIndex,maxIndex+1)}async function open3(items,dst,idsMap){if(idsMap||(idsMap={}),dst.inside&&dst.parentId===void 0)return!0;if(dst.windowId===NEWID)return await bg("createWindowWithTabs",items,{incognito:dst.incognito});if(dst.windowId!==void 0&&dst.windowId!==Windows.id){if(dst.windowId===ASKID){if(dst.windowChooseConf===void 0?dst.windowId=await Windows.showWindowsPopup():dst.windowId=await Windows.showWindowsPopup(dst.windowChooseConf),dst.windowId===void 0||dst.windowId===NOID)return!0;delete dst.windowChooseConf}return await bg("openTabs",items,dst),!0}let dstPanel=Sidebar.panelsById[dst.panelId??NOID];(dst.panelId===void 0||!dstPanel||dstPanel.type!==2)&&(dstPanel=Sidebar.panels.find(p=>p.type===2));let fallbackIndex;isTabsPanel(dstPanel)&&(fallbackIndex=dstPanel.nextTabIndex);let index;for(let item,i=0;i<items.length;i++){item=items[i];let groupCreationNeeded=item.title&&!item.url,parent=Tabs2.byId[dst.parentId??item.parentId??NOID];if(dst.index!==void 0)index=dst.index+i;else if(item.index!==void 0){let prevIndex=items[i-1]?.index;prevIndex!==void 0&&index!==void 0&&item.index-prevIndex===1?index++:index=item.index+i}else fallbackIndex!==void 0&&(index=fallbackIndex+i);if(dst.pinned&&index!==void 0){let lastPinnedTab=Tabs2.pinned[Tabs2.pinned.length-1],pinIndex=lastPinnedTab?lastPinnedTab.index+1:0;index>pinIndex&&(index=pinIndex+i)}if(!item.url&&!item.title||!Settings.state.tabsTree&&groupCreationNeeded||!Sidebar.hasTabs&&groupCreationNeeded||dst.pinned&&groupCreationNeeded||Settings.state.tabsTreeLimit!=="none"&&groupCreationNeeded)continue;let conf={index,url:groupCreationNeeded?createGroupUrl(item.title):normalizeUrl(item.url,item.title),windowId:Windows.id,pinned:dst.pinned,active:!!item.active,cookieStoreId:dst.containerId??item.container};dst.discarded===void 0&&items.length>1&&(dst.discarded=!0),dst.discarded&&conf.url&&!conf.url.startsWith("a")&&!dst.pinned&&!conf.active&&(conf.discarded=!0,conf.title=item.title);let parentId=NOID;dst.pinned||(item.parentId!==void 0&&+idsMap[item.parentId]>=0?parentId=idsMap[item.parentId]??NOID:parent&&(parentId=parent.id)),index!==void 0&&Tabs2.setNewTabPosition(index,parentId,dstPanel?.id??NOID);let tab=await browser.tabs.create(conf);if(idsMap[item.id]=tab.id,item.customTitle){let newTab=Tabs2.byId[tab.id];newTab&&(newTab.reactive.customTitle=newTab.customTitle=item.customTitle)}if(item.customColor){let newTab=Tabs2.byId[tab.id];newTab&&(newTab.reactive.customColor=newTab.customColor=item.customColor)}}return!0}async function reopenInContainer(ids,containerId){Tabs2.sortTabIds(ids);let firstTab=Tabs2.byId[ids[0]];if(!firstTab)return;let idsMap={};bg("disableAutoReopening",containerId,1e3);let items=Tabs2.getTabsInfo(ids);setURLsFromTitles(items);let rule=Tabs2.findMoveRuleBy(containerId,firstTab.lvl),panel=Sidebar.panelsById[rule?.panelId??NOID];if(isTabsPanel(panel)&&panel.id!==firstTab.panelId&&!firstTab.pinned){let dst={panelId:panel.id,containerId,index:panel.nextTabIndex};await Tabs2.reopen(items,dst,idsMap)}else{let dst={panelId:firstTab.panelId,containerId,pinned:firstTab.pinned};await Tabs2.reopen(items,dst,idsMap)}bg("enableAutoReopening",Object.values(idsMap))}function setURLsFromTitles(items){for(let item of items)item.url==="about:blank"&&item.title&&INITIAL_TITLE_RE.test(item.title)&&(item.url="https://"+item.title)}async function openInContainer(ids,containerId){Tabs2.sortTabIds(ids);let firstTab=Tabs2.byId[ids[0]],lastTab=Tabs2.byId[ids[ids.length-1]];if(!firstTab||!lastTab)return;let items=Tabs2.getTabsInfo(ids),rule=Tabs2.findMoveRuleBy(containerId,firstTab.lvl),panel=Sidebar.panelsById[rule?.panelId??NOID];if(isTabsPanel(panel)&&panel.id!==firstTab.panelId&&!firstTab.pinned){let dst={panelId:panel.id,containerId,index:panel.nextTabIndex};await Tabs2.open(items,dst)}else{let dst={panelId:firstTab.panelId,containerId,index:lastTab.index+1};await Tabs2.open(items,dst)}}async function createTabInNewContainer(){let panel=Sidebar.panelsById[Sidebar.activePanelId];if(!isTabsPanel(panel))throw"Current panel is not TabsPanel";let result=await openContainerPopup(NOID);if(result===null)return;let container=Containers.reactive.byId[result];if(!container)return;let dst={panelId:panel.id,containerId:container.id};await Tabs2.open([{id:-1,url:"about:newtab"}],dst)}async function reopenTabsInNewContainer(tabIds){let firstTab=Tabs2.byId[tabIds[0]];if(!firstTab)return;let result=await openContainerPopup(NOID);if(!result)return;let container=Containers.reactive.byId[result];if(!container)return;let items=Tabs2.getTabsInfo(tabIds);await Tabs2.reopen(items,{panelId:firstTab.panelId,containerId:container.id})}function setNewTabPosition(index,parentId,panelId,unread){Tabs2.newTabsPosition[index]={parent:parentId,panel:panelId,unread}}function findTabsPanelNearToTabIndex(tabIndex){let nearestPanel,prevTab=Tabs2.list[tabIndex-1],nextTab=Tabs2.list[tabIndex+1];return prevTab&&!prevTab.pinned&&(nearestPanel=Sidebar.panelsById[prevTab.panelId]),!nearestPanel&&nextTab&&(nearestPanel=Sidebar.panelsById[nextTab.panelId]),nearestPanel||(nearestPanel=Sidebar.panels.find(p=>isTabsPanel(p))),nearestPanel}function getPanelForNewTab(tab){let parentTab=Tabs2.byId[tab.openerTabId??NOID],activePanel=Sidebar.panelsById[Sidebar.activePanelId];if(isTabsPanel(activePanel)||(activePanel=Sidebar.panelsById[Sidebar.lastTabsPanelId]),isTabsPanel(activePanel)||(activePanel=void 0),Tabs2.moveRules.length){let hasParent=Settings.state.tabsTree&&parentTab&&!parentTab.pinned,rule=Tabs2.findMoveRuleBy(tab.cookieStoreId,hasParent?1:0);if(rule){let panel=Sidebar.panelsById[rule.panelId];if(isTabsPanel(panel))return panel}}if(parentTab&&parentTab.pinned&&(Settings.state.moveNewTabPin==="start"||Settings.state.moveNewTabPin==="end"))return activePanel||findTabsPanelNearToTabIndex(tab.index);if(parentTab&&!parentTab.pinned){let panelOfParent=Sidebar.panelsById[parentTab.panelId];if(!Settings.state.moveNewTabParentActPanel||panelOfParent===activePanel)return panelOfParent}if(Settings.state.moveNewTab==="start"||Settings.state.moveNewTab==="end")return activePanel||findTabsPanelNearToTabIndex(tab.index);if(Settings.state.moveNewTab==="before"||Settings.state.moveNewTab==="after"||Settings.state.moveNewTab==="first_child"||Settings.state.moveNewTab==="last_child"){let activeTab=Tabs2.byId[Tabs2.activeId],panelOfActiveTab=Sidebar.panelsById[activeTab?.panelId??NOID];return activeTab&&!activeTab.pinned&&panelOfActiveTab?panelOfActiveTab:activePanel||findTabsPanelNearToTabIndex(tab.index)}return findTabsPanelNearToTabIndex(tab.index)}function getIndexForNewTab(panel,conf){let parent=Tabs2.byId[conf?.openerTabId??NOID],startIndex=panel.startTabIndex>-1?panel.startTabIndex:0,nextIndex=panel.nextTabIndex>-1?panel.nextTabIndex:Tabs2.list.length,activeTab=Tabs2.byId[Tabs2.activeId],autoGroupped=conf?conf.autoGroupped:!1,fallbackIndex=conf?conf.index:nextIndex;if(parent&&parent.pinned){if(Settings.state.moveNewTabPin==="start")return startIndex;if(Settings.state.moveNewTabPin==="end")return nextIndex}if(parent&&!parent.pinned&&parent.panelId===panel.id){if(Settings.state.moveNewTabParent==="before"&&!autoGroupped)return parent.index;if(Settings.state.moveNewTabParent==="first_child")return parent.index+1;if(Settings.state.moveNewTabParent==="sibling"||Settings.state.moveNewTabParent==="last_child"||autoGroupped)if(Settings.state.tabsTree){let t,index=parent.index+1;for(;index<Tabs2.list.length&&(t=Tabs2.list[index],!(t.lvl<=parent.lvl));index++);return index}else{let ids={[parent.id]:!0},index=parent.index+1;for(let t;index<Tabs2.list.length&&(t=Tabs2.list[index],!!ids[t.openerTabId??NOID]);index++)ids[t.id]=!0;return index}if(Settings.state.moveNewTabParent==="start"&&!autoGroupped)return startIndex;if(Settings.state.moveNewTabParent==="end"&&!autoGroupped)return nextIndex;if(Settings.state.moveNewTabParent==="default"&&!autoGroupped)return fallbackIndex}if(Settings.state.moveNewTab==="start")return startIndex;if(Settings.state.moveNewTab==="end")return nextIndex;if(Settings.state.moveNewTab==="before")return!activeTab||activeTab.panelId!==panel.id?nextIndex:activeTab.pinned?Settings.state.moveNewTabActivePin==="end"?nextIndex:startIndex:activeTab.index;if(Settings.state.moveNewTab==="after"){if(!activeTab||activeTab.panelId!==panel.id)return nextIndex;if(activeTab.pinned)return Settings.state.moveNewTabActivePin==="end"?nextIndex:startIndex;{let index=activeTab.index+1;for(let t;index<Tabs2.list.length&&(t=Tabs2.list[index],!(t.lvl<=activeTab.lvl));index++);return index}}if(Settings.state.moveNewTab==="first_child")return!activeTab||activeTab.panelId!==panel.id?nextIndex:activeTab.pinned?Settings.state.moveNewTabActivePin==="end"?nextIndex:startIndex:activeTab.index+1;if(Settings.state.moveNewTab==="last_child"){if(!activeTab||activeTab.panelId!==panel.id)return nextIndex;if(activeTab.pinned)return Settings.state.moveNewTabActivePin==="end"?nextIndex:startIndex;{let index=activeTab.index+1;for(let t;index<Tabs2.list.length&&(t=Tabs2.list[index],!(t.lvl<=activeTab.lvl));index++);return index}}return fallbackIndex}function getParentForNewTab(panel,openerTabId){let activeTab=Tabs2.byId[Tabs2.activeId],parent;if(openerTabId&&(parent=Tabs2.byId[openerTabId]),!(parent&&parent.pinned)){if(parent&&!parent.pinned&&parent.panelId===panel.id){if(Settings.state.moveNewTabParent==="before"||Settings.state.moveNewTabParent==="sibling")return parent.parentId;if(Settings.state.moveNewTabParent==="first_child"||Settings.state.moveNewTabParent==="last_child")return openerTabId;if(Settings.state.moveNewTabParent==="start"||Settings.state.moveNewTabParent==="end")return;if(Settings.state.moveNewTabParent==="default"||Settings.state.moveNewTabParent==="none")return openerTabId}if(Settings.state.moveNewTab!=="start"&&Settings.state.moveNewTab!=="end"){if(activeTab&&activeTab.panelId===panel.id&&!activeTab.pinned){if(Settings.state.moveNewTab==="before")return activeTab.parentId;if(Settings.state.moveNewTab==="after")return activeTab.parentId;if(Settings.state.moveNewTab==="first_child")return activeTab.id;if(Settings.state.moveNewTab==="last_child")return activeTab.id}return openerTabId}}}var tabs_fg_media_exports={};__export(tabs_fg_media_exports,{muteAudibleTabsOfPanel:()=>muteAudibleTabsOfPanel,muteTabs:()=>muteTabs,pauseAllAudibleTabsMedia:()=>pauseAllAudibleTabsMedia,pauseTabMedia:()=>pauseTabMedia,pauseTabsMediaOfPanel:()=>pauseTabsMediaOfPanel,playAllPausedTabsMedia:()=>playAllPausedTabsMedia,playTabMedia:()=>playTabMedia,playTabsMediaOfPanel:()=>playTabsMediaOfPanel,remuteAudibleTabs:()=>remuteAudibleTabs,remuteTabs:()=>remuteTabs,resetPausedMediaState:()=>resetPausedMediaState,switchToFirstAudibleTab:()=>switchToFirstAudibleTab,unmuteAudibleTabsOfPanel:()=>unmuteAudibleTabsOfPanel,unmuteTabs:()=>unmuteTabs});function muteTabs(tabIds){for(let tabId of tabIds)browser.tabs.update(tabId,{muted:!0}).catch(err3=>{err("Tabs.muteTabs: Cannot mute tab:",err3)})}function unmuteTabs(tabIds){for(let tabId of tabIds)browser.tabs.update(tabId,{muted:!1}).catch(err3=>{err("Tabs.unmuteTabs: Cannot unmute tab:",err3)})}function remuteTabs(tabIds){for(let tabId of tabIds){let tab=Tabs2.byId[tabId];tab&&browser.tabs.update(tabId,{muted:!tab.mutedInfo?.muted}).catch(err3=>{err("Tabs.remuteTabs: Cannot remute tab:",err3)})}}function remuteAudibleTabs(){let audioIds=[],mutedIds=[];for(let tab of Tabs2.list)tab.audible&&!tab.mutedInfo?.muted&&audioIds.push(tab.id),tab.mutedInfo?.muted&&mutedIds.push(tab.id);audioIds.length?Tabs2.muteTabs(audioIds):mutedIds.length&&Tabs2.unmuteTabs(mutedIds)}function muteAudibleTabsOfPanel(id){let panel=Sidebar.panelsById[id];if(isTabsPanel(panel)){if(Settings.state.pinnedTabsPosition==="panel")for(let tab of Tabs2.list){if(!tab.pinned)break;tab.audible&&tab.panelId===panel.id&&browser.tabs.update(tab.id,{muted:!0})}for(let tab of panel.tabs)tab.audible&&browser.tabs.update(tab.id,{muted:!0})}}function unmuteAudibleTabsOfPanel(id){let panel=Sidebar.panelsById[id];if(isTabsPanel(panel)){if(Settings.state.pinnedTabsPosition==="panel")for(let tab of Tabs2.list){if(!tab.pinned)break;tab.mutedInfo?.muted&&tab.panelId===panel.id&&browser.tabs.update(tab.id,{muted:!1}).catch(err3=>{err("Tabs.unmuteAudibleTabsOfPanel: Cannot unmute tab:",err3)})}for(let tab of panel.tabs)tab.mutedInfo?.muted&&browser.tabs.update(tab.id,{muted:!1})}}function switchToFirstAudibleTab(){let tab=Tabs2.list.find(t=>t.audible&&!t.mutedInfo?.muted);tab&&browser.tabs.update(tab.id,{active:!0})}async function pauseTabMedia(id){if(!Permissions.reactive.webData&&!await Permissions.request("<all_urls>"))return;let tab=id!==void 0?Tabs2.byId[id]:Tabs2.list.find(t=>t.audible);tab&&(tab.url.startsWith("ab")||(tab.reactive.mediaPaused=tab.mediaPaused=!0,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab),browser.tabs.executeScript(tab.id,{file:"../injections/pauseMedia.js",runAt:"document_start",allFrames:!0}).then(results=>{results.every(result=>result===!1)&&(tab.reactive.mediaPaused=tab.mediaPaused=!1,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab))}).catch(err3=>{err("Tabs.pauseTabMedia: Cannot executeScript",err3)}),recheckPausedTabs()))}async function playTabMedia(id){if(!Permissions.reactive.webData&&!await Permissions.request("<all_urls>"))return;let tab;id!==void 0?tab=Tabs2.byId[id]:tab=Tabs2.list.find(t=>t.mediaPaused),tab&&(tab.reactive.mediaPaused=tab.mediaPaused=!1,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab),browser.tabs.executeScript(tab.id,{file:"../injections/playMedia.js",runAt:"document_start",allFrames:!0}).catch(err3=>{err("Tabs.playTabMedia: Cannot exec script:",err3)}))}function resetPausedMediaState(panelId){let panel=Sidebar.panelsById[panelId];if(isTabsPanel(panel))for(let tab of panel.tabs)tab&&tab.mediaPaused&&(tab.reactive.mediaPaused=tab.mediaPaused=!1,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab))}async function pauseTabsMediaOfPanel(panelId){if(!Permissions.reactive.webData&&!await Permissions.request("<all_urls>"))return;let panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel))return;let injectionConfig={file:"../injections/pauseMedia.js",runAt:"document_start",allFrames:!0};if(Settings.state.pinnedTabsPosition==="panel")for(let tab of Tabs2.list){if(!tab.pinned)break;tab.url.startsWith("ab")||(tab.audible||tab.mutedInfo?.muted)&&tab.panelId===panel.id&&(tab.reactive.mediaPaused=tab.mediaPaused=!0,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab),browser.tabs.executeScript(tab.id,injectionConfig).then(results=>{results.every(result=>result===!1)&&(tab.reactive.mediaPaused=tab.mediaPaused=!1,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab))}).catch(err3=>{err("Tabs.pauseTabsMediaOfPanel: Cannot executeScript",err3)}))}for(let tab of panel.tabs)tab.url.startsWith("ab")||(tab.audible||tab.mutedInfo?.muted)&&(tab.reactive.mediaPaused=tab.mediaPaused=!0,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab),browser.tabs.executeScript(tab.id,injectionConfig).then(results=>{results.every(result=>result===!1)&&(tab.reactive.mediaPaused=tab.mediaPaused=!1,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab))}).catch(err3=>{err("Tabs.pauseTabsMediaOfPanel: Cannot executeScript",err3)}));recheckPausedTabs()}async function playTabsMediaOfPanel(panelId){if(!Permissions.reactive.webData&&!await Permissions.request("<all_urls>"))return;let panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel))return;let injectionConfig={file:"../injections/playMedia.js",runAt:"document_start",allFrames:!0};if(Settings.state.pinnedTabsPosition==="panel")for(let tab of Tabs2.list){if(!tab.pinned)break;tab.mediaPaused&&tab.panelId===panel.id&&(tab.reactive.mediaPaused=tab.mediaPaused=!1,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab),browser.tabs.executeScript(tab.id,injectionConfig).catch(err3=>{err("Tabs.playTabsMediaOfPanel: Cannot exec script (pinned):",err3)}))}for(let tab of panel.tabs)tab.mediaPaused&&(tab.reactive.mediaPaused=tab.mediaPaused=!1,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab),browser.tabs.executeScript(tab.id,injectionConfig).catch(err3=>{err("Tabs.playTabsMediaOfPanel: Cannot exec script:",err3)}))}var recheckPausedTabsTimeout;function recheckPausedTabs(delay=3500){clearTimeout(recheckPausedTabsTimeout),recheckPausedTabsTimeout=setTimeout(()=>{for(let tab of Tabs2.list)tab.mediaPaused&&tab.audible&&(tab.reactive.mediaPaused=tab.mediaPaused=!1,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab))},delay)}async function pauseAllAudibleTabsMedia(){if(!Permissions.reactive.webData&&!await Permissions.request("<all_urls>"))return;let injectionConfig={file:"../injections/pauseMedia.js",runAt:"document_start",allFrames:!0};for(let tab of Tabs2.list)tab.audible&&(tab.reactive.mediaPaused=tab.mediaPaused=!0,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab),browser.tabs.executeScript(tab.id,injectionConfig).then(results=>{results.every(result=>result===!1)&&(tab.reactive.mediaPaused=tab.mediaPaused=!1,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab))}).catch(err3=>{err("Tabs.pauseTabsMediaOfPanel: Cannot executeScript",err3)}));recheckPausedTabs()}async function playAllPausedTabsMedia(){if(!Permissions.reactive.webData&&!await Permissions.request("<all_urls>"))return;let injectionConfig={file:"../injections/playMedia.js",runAt:"document_start",allFrames:!0};for(let tab of Tabs2.list)tab.mediaPaused&&(tab.reactive.mediaPaused=tab.mediaPaused=!1,Sidebar.updateMediaStateOfPanelDebounced(100,tab.panelId,tab),browser.tabs.executeScript(tab.id,injectionConfig).catch(err3=>{err("Tabs.playAllPausedTabsMedia: Cannot exec script:",err3)}))}var Tabs2={ready:!1,reactive:{pinnedIds:[],recentlyRemovedLen:0,inlinePreviewTabId:NOID,inlinePreviewPinnedImg:""},list:[],byId:{},pinned:[],recentlyRemoved:[],urlsInUse:{},shadowMode:!1,tabsReinitializing:!1,removedTabs:[],newTabsPosition:{},movingTabs:[],attachingTabs:[],detachingTabIds:[],normTabsMoving:!1,editableTabId:NOID,moveRules:[],activeTabsGlobal:{id:"global",actTabOffset:-1,actTabs:[]},activeTabsPerPanel:{},deferredEventHandling:[],removingTabs:[],ignoreTabsEvents:!1,activeId:NOID,blockedScrollPosition:!1,activateSelectedOnMouseLeave:!1,sorting:!1,...tabs_fg_actions_exports,...tabs_fg_handlers_exports,...tabs_fg_groups_exports,...tabs_fg_shadow_exports,...tabs_fg_scroll_exports,...tabs_fg_edit_title_exports,...tabs_fg_colors_exports,...tabs_fg_rm_exports,...tabs_fg_move_exports,...tabs_fg_create_exports,...tabs_fg_media_exports};async function load3(){if(browser.bookmarks&&!Info.isBg)return loadInFg()}async function loadInFg(){let bookmarks2=await browser.bookmarks.getTree();if(!bookmarks2[0].children)return;Bookmarks.reactive.byId={},Bookmarks.byUrl={};let list=[],walker=(nodes,count)=>{for(let n of nodes){if(Bookmarks.reactive.byId[n.id]=n,n.sel=!1,n.isOpen=!1,n.type==="separator")n.url=void 0;else if(n.url){count++,list.push(n);let rBookmark=Bookmarks.reactive.byId[n.id];Bookmarks.byUrl[n.url]?Bookmarks.byUrl[n.url].push(rBookmark):Bookmarks.byUrl[n.url]=[rBookmark]}n.children&&(n.len=walker(n.children,0),count+=n.len)}return count};Bookmarks.overallCount=walker(bookmarks2[0].children,0),Bookmarks.reactive.tree=bookmarks2[0].children,Sidebar.recalcBookmarksPanels(),Bookmarks.setupBookmarksListeners(),Settings.state.highlightOpenBookmarks&&Bookmarks.markOpenBookmarksForAllTabs(),Windows.incognito||await restoreTree();for(let panel of Sidebar.panels)isBookmarksPanel(panel)&&(panel.reactive.ready=panel.ready=!0);let activePanel=Sidebar.panelsById[Sidebar.activePanelId];DnD.reactive.isStarted&&isBookmarksPanel(activePanel)&&Sidebar.updateBounds()}async function restoreTree(){let expandedBookmarkFolders=(await browser.storage.local.get("expandedBookmarkFolders")).expandedBookmarkFolders;if(expandedBookmarkFolders)for(let panelId of Object.keys(expandedBookmarkFolders))Sidebar.panelsById[panelId]||delete expandedBookmarkFolders[panelId];Bookmarks.reactive.expanded=expandedBookmarkFolders??{}}function convertOldTreeStruct(struct){if(!struct)return{};let output={};for(let path2 of struct){let id=path2.pop?.();id&&(output[id]=!0)}return{bookmarks:output}}function unload3(){Bookmarks.resetBookmarksListeners(),Bookmarks.reactive.tree=[],Bookmarks.reactive.byId={},Bookmarks.byUrl={};for(let panel of Sidebar.panels)isBookmarksPanel(panel)&&(panel.ready=!1,panel.reactive.ready=!1,panel.reactive.len=0)}function countBookmarks(nodes){let count=0,walker=nodes2=>{for(let n of nodes2)n.type==="bookmark"&&count++,n.children&&walker(n.children)};return walker(nodes),count}var saveBookmarksTreeTimeout;function saveBookmarksTree(delay=128){Windows.focused&&(Bookmarks.reactive.popup||Search.rawValue||(clearTimeout(saveBookmarksTreeTimeout),saveBookmarksTreeTimeout=setTimeout(()=>{let expandedBookmarkFolders=cloneObject(Bookmarks.reactive.expanded);Store.set({expandedBookmarkFolders},500)},delay)))}function expandBookmark(nodeId,panelId,noRecursive,noAutoClose){let node=Bookmarks.reactive.byId[nodeId];if(!node)return;let isEmpty=!node.children?.length;Settings.state.autoCloseBookmarks&&!noAutoClose&&!isEmpty&&!Selection.isBookmarks()&&(Bookmarks.reactive.expanded[panelId]={}),Bookmarks.reactive.expanded[panelId]||(Bookmarks.reactive.expanded[panelId]={});let expandedInPanel=Bookmarks.reactive.expanded[panelId];if(noRecursive)expandedInPanel[nodeId]=!0;else{let expandPath=[nodeId],parent=Bookmarks.reactive.byId[node.parentId];for(;parent;)expandPath.push(parent.id),parent=Bookmarks.reactive.byId[parent.parentId];for(let id of expandPath)expandedInPanel[id]=!0}saveBookmarksTree()}function foldBookmark(nodeId,panelId){Bookmarks.reactive.expanded[panelId]||(Bookmarks.reactive.expanded[panelId]={}),delete Bookmarks.reactive.expanded[panelId][nodeId],saveBookmarksTree()}function toggleBranch2(nodeId,panelId){if(!Bookmarks.reactive.byId[nodeId])return;Bookmarks.reactive.expanded[panelId]?.[nodeId]?foldBookmark(nodeId,panelId):expandBookmark(nodeId,panelId)}function openInNewWindow(ids,incognito){let toOpen=[],walker=nodes=>{for(let node of nodes)node.type!=="separator"&&(ids.includes(node.parentId)?(toOpen.push(node),ids.push(node.id)):ids.includes(node.id)&&toOpen.push(node),node.children&&walker(node.children))};walker(Bookmarks.reactive.tree);let itemsInfo=[];for(let bookmark of toOpen){let info2={id:bookmark.id,title:bookmark.title};itemsInfo.find(i=>i.id===bookmark.parentId)&&(info2.parentId=bookmark.parentId),bookmark.type==="bookmark"&&(info2.url=bookmark.url),bookmark.type==="folder"&&Settings.state.tabsTree&&(info2.url=createGroupUrl(bookmark.title)),itemsInfo.push(info2)}bg("createWindowWithTabs",itemsInfo,{incognito})}async function openInNewPanel(ids){if(!ids.length)return;let isFirstTabsPanel=!Sidebar.hasTabs,panel=Sidebar.createTabsPanel(),index=Sidebar.getIndexForNewTabsPanel();return Sidebar.addPanel(index,panel),panel.ready=!0,panel.reactive.ready=!0,Sidebar.recalcPanels(),Sidebar.recalcTabsPanels(),Sidebar.saveSidebar(300),isFirstTabsPanel&&await Tabs2.load(),Bookmarks.open(ids,{panelId:panel.id})}function getMouseOpeningConf2(button){let conf={dst:{},useActiveTab:!1,activateFirstTab:!1,removeBookmark:!1};if(button===0){let panelId=Sidebar.getRecentTabsPanelId(),panel=Sidebar.panelsById[panelId];if(conf.useActiveTab=Settings.state.bookmarksLeftClickAction==="open_in_act",conf.activateFirstTab=Settings.state.bookmarksLeftClickActivate,conf.dst.panelId=panelId,!conf.useActiveTab&&Settings.state.bookmarksLeftClickPos==="after"){let activeTab=Tabs2.byId[Tabs2.activeId];activeTab&&!activeTab.pinned&&activeTab.panelId===panelId&&(conf.dst.index=activeTab.index+1,conf.dst.parentId=activeTab.parentId)}else isTabsPanel(panel)&&(conf.dst.index=Tabs2.getIndexForNewTab(panel))}else if(button===1){let panelId=Sidebar.getRecentTabsPanelId(),panel=Sidebar.panelsById[panelId];if(conf.activateFirstTab=Settings.state.bookmarksMidClickActivate,conf.removeBookmark=Settings.state.bookmarksMidClickRemove,conf.dst.panelId=panelId,Settings.state.bookmarksMidClickPos==="after"){let activeTab=Tabs2.byId[Tabs2.activeId];activeTab&&!activeTab.pinned&&activeTab.panelId===panelId&&(conf.dst.index=activeTab.index+1,conf.dst.parentId=activeTab.parentId)}else isTabsPanel(panel)&&(conf.dst.index=Tabs2.getIndexForNewTab(panel))}return conf}async function open4(ids,dst,useActiveTab,activateFirstTab){let firstBookmark=Bookmarks.reactive.byId[ids[0]];if(ids.length===1&&firstBookmark?.type==="separator")return;let dstContainerId=dst.containerId??CONTAINER_ID,dstPanel;if(dst.panelId!==void 0&&(dstPanel=Sidebar.panelsById[dst.panelId]),!isTabsPanel(dstPanel)){let dstCtxTabsPanel;for(let rule of Tabs2.moveRules)if(rule.containerId&&!rule.urlRE&&!rule.urlStr&&rule.containerId===dstContainerId){let panel=Sidebar.panelsById[rule.panelId];if(isTabsPanel(panel)){dstCtxTabsPanel=panel;break}}dstPanel=dstCtxTabsPanel}if(!dstPanel){let dstTabsPanel;for(let p of Sidebar.panels)if(isTabsPanel(p)){dstTabsPanel=p;break}dstPanel=dstTabsPanel}isTabsPanel(dstPanel)&&(dstPanel.newTabCtx&&dstPanel.newTabCtx!=="none"&&!dst.containerId&&(dst.containerId=dstPanel.newTabCtx),dst.index===void 0&&(dst.index=dstPanel?.nextTabIndex??Tabs2.list.length),!dst.panelId&&dstPanel&&(dst.panelId=dstPanel.id));let toOpen=[],toRemove=[],walker=nodes=>{for(let node of nodes){if(node.type==="separator")continue;let isDirectTarget=ids.includes(node.id),isIndirectTarget=ids.includes(node.parentId);if(isDirectTarget||isIndirectTarget){let info2={id:node.id,title:node.title};node.url&&(info2.url=node.url),isIndirectTarget&&(info2.parentId=node.parentId),!info2.url&&info2.title&&info2.title.length>20&&Bookmarks.extractTabInfoFromTitle(info2,!0);let prev2=toOpen[toOpen.length-1];if(prev2&&prev2.id===info2.parentId&&bookmarkIsParentTab(node,prev2.title)){prev2.url=info2.url;continue}isIndirectTarget&&node.type==="folder"&&ids.push(node.id),Settings.state.autoRemoveOther&&node.parentId===BKM_OTHER_ID&&node.type==="bookmark"&&toRemove.push(info2.id),toOpen.push(info2)}node.children&&walker(node.children)}};if(ids.length===1&&firstBookmark?.type==="bookmark"){if(useActiveTab){browser.tabs.update({url:normalizeUrl(firstBookmark.url,firstBookmark.title)}),Settings.state.autoRemoveOther&&firstBookmark.parentId===BKM_OTHER_ID&&Bookmarks.removeBookmarks([firstBookmark.id]);return}Settings.state.autoRemoveOther&&firstBookmark.parentId===BKM_OTHER_ID&&toRemove.push(firstBookmark.id),toOpen.push({id:firstBookmark.id,url:firstBookmark.url,title:firstBookmark.title})}else walker(Bookmarks.reactive.tree);toOpen.length&&(activateFirstTab&&(toOpen[0].active=!0),await Tabs2.open(toOpen,dst),toRemove.length&&Bookmarks.removeBookmarks(toRemove))}async function createBookmarkNode(type,target){let parentId,index=0;if(target.type==="bookmark"||target.type==="separator"?(parentId=target.parentId,index=target.index+1):target.type==="folder"&&(parentId=target.id),parentId||(parentId=BKM_OTHER_ID),type==="separator")browser.bookmarks.create({parentId,type:"separator",index});else{let isBookmark=type==="bookmark",result=await openBookmarksPopup({title:translate("popup.bookmarks."+(isBookmark?"create_bookmark":"create_folder")),nameField:!0,urlField:isBookmark,locationField:!0,location:parentId,controls:[{label:"btn.create"}],validate:popupState=>{popupState.nameValid=!!popupState.name,popupState.urlValid=!!popupState.url}});if(result){parentId!==result.location&&(index=0),parentId=result.location??BKM_OTHER_ID,parentId===NOID&&(parentId=BKM_OTHER_ID);try{await browser.bookmarks.create({parentId,title:result.name,type,url:result.url,index})}catch(err3){err("Bookmarks.createBookmarkNode: Cannot create bookmark",err3),Notifications.err(translate("notif.bookmarks_create_err"))}}}}async function editBookmarkNode(target){if(target.type==="separator")return;let isBookmark=target.type==="bookmark",result=await openBookmarksPopup({target,title:translate(isBookmark?"popup.bookmarks.edit_bookmark":"popup.bookmarks.edit_folder"),nameField:!0,urlField:isBookmark,controls:[{label:"btn.save"}],validate:popupState=>{popupState.nameValid=!!popupState.name,popupState.urlValid=!popupState.urlField||!!popupState.url,popupState.controls&&(!popupState.nameValid||!popupState.urlValid?popupState.controls[0].inactive=!0:popupState.controls[0].inactive=!1)}});result&&(isBookmark?browser.bookmarks.update(target.id,{title:result.name,url:result.url}):browser.bookmarks.update(target.id,{title:result.name}))}function openBookmarksPopup(config){return new Promise(res=>{let popupState={...config,name:config.target?.title??"",nameValid:!0,url:config.target?.url??"",urlValid:!0,close:result=>{res(result),Bookmarks.reactive.popup=null}};!popupState.name&&config.name&&(popupState.name=config.name),!popupState.url&&config.url&&(popupState.url=config.url),Bookmarks.reactive.popup=popupState})}async function removeBookmarks(ids,conf){conf||(conf={});let count=0,hasCollapsed=!1,expandedBookmarks2=Bookmarks.reactive.expanded[Sidebar.activePanelId],deleted=[],idsToRemove=[],walker=nodes=>{for(let n of nodes)count++,deleted.push(n),n.children&&n.children.length&&(expandedBookmarks2?.[n.id]||(hasCollapsed=!0),walker(n.children))};for(let id of ids){let n=Bookmarks.reactive.byId[id];n&&(ids.includes(n.parentId)||(count++,deleted.push(n),idsToRemove.push(id),n.children&&n.children.length&&(expandedBookmarks2?.[n.id]||(hasCollapsed=!0),walker(n.children))))}let warn2=Settings.state.warnOnMultiBookmarkDelete==="any"||Settings.state.warnOnMultiBookmarkDelete==="collapsed"&&hasCollapsed;if(!(warn2&&!conf.noWarn&&count>1&&!await confirm(translate("confirm.bookmarks_delete")))){for(let id of idsToRemove)await browser.bookmarks.removeTree(id);count>0&&Settings.state.bookmarksRmUndoNote&&!warn2&&!conf.noNotif&&Notifications.notify({icon:"#icon_trash",title:String(count)+translate("notif.bookmarks_rm_post",count),ctrl:translate("notif.undo_ctrl"),callback:()=>undoRemove2(deleted)})}}async function undoRemove2(deleted){let oldNewIds={},offset=0,prevParent;for(let n of deleted){prevParent!==n.parentId&&(offset=0);let conf={type:n.type,index:n.index+offset};Bookmarks.reactive.byId[n.parentId]&&(conf.parentId=n.parentId),oldNewIds[n.parentId]&&(conf.parentId=oldNewIds[n.parentId]),n.type!=="separator"&&(conf.title=n.title),n.type==="bookmark"&&(conf.url=n.url);let newNode=await browser.bookmarks.create(conf);prevParent=n.parentId,oldNewIds[n.id]=newNode.id,offset++}}function collapseAllBookmarks(panelId){Bookmarks.reactive.expanded[panelId]={},saveBookmarksTree()}async function sortBookmarks(type,nodeIds,dir=0){let byName=type==="name",byLink=type==="link",byTime=type==="time",notifIcon;byName?dir>0?notifIcon="#icon_sort_name_asc":notifIcon="#icon_sort_name_des":byLink?dir>0?notifIcon="#icon_sort_url_asc":notifIcon="#icon_sort_url_des":byTime&&(dir>0?notifIcon="#icon_sort_time_asc":notifIcon="#icon_sort_time_des");let expandedBookmarks2=Bookmarks.reactive.expanded[Sidebar.activePanelId],groups={},count=0,walker=nodes=>{for(let node of nodes)node.type!=="separator"&&((type!=="link"||node.url)&&(groups[node.parentId]||(groups[node.parentId]=[]),groups[node.parentId].push(node),count++),node.children&&expandedBookmarks2?.[node.id]&&walker(node.children))};for(let nodeId of nodeIds){let node=Bookmarks.reactive.byId[nodeId];node&&node.type!=="separator"&&((type!=="link"||node.url)&&(groups[node.parentId]||(groups[node.parentId]=[]),groups[node.parentId].push(node),count++),node.children&&expandedBookmarks2?.[node.id]&&walker(node.children))}let initialCount=count,progressNotification,stopSorting2=!1;count>25&&(progressNotification=Notifications.progress({icon:notifIcon,title:translate("notif.bookmarks_sort"),ctrl:translate("btn.stop"),callback:()=>{stopSorting2=!0}}));for(let nodes of Object.values(groups)){if(nodes.length===1){count--;continue}let minIndex=nodes.reduce((a,v)=>Math.min(a,v.index),9999);if(dir===0){let last=nodes[nodes.length-1],first=nodes.find(n=>n.type===last.type)??nodes[0];if(first===last&&(first=nodes[0]),!first)break;byName&&(dir=first.title.localeCompare(last.title)),byLink&&(first.url&&last.url?dir=first.url.localeCompare(last.url):dir=0),byTime&&(first.dateAdded===void 0||last.dateAdded===void 0?dir=0:dir=first.dateAdded-last.dateAdded)}if(dir===0)break;nodes.sort((aa,bb)=>{if(aa.type!==bb.type){if(aa.type==="folder")return-1;if(aa.type==="bookmark")return 1}let a=dir>0?aa:bb,b=dir>0?bb:aa;if(byName)return a.title.localeCompare(b.title);if(byLink&&a.url&&b.url){let aIndex=a.url.indexOf("://"),bIndex=b.url.indexOf("://"),aLink=aIndex===-1?a.url:a.url.slice(aIndex+3),bLink=bIndex===-1?b.url:b.url.slice(bIndex+3);return aLink.localeCompare(bLink)}return byTime&&a.dateAdded!==void 0&&b.dateAdded!==void 0?a.dateAdded-b.dateAdded:0});for(let n,i=0;i<nodes.length&&!stopSorting2;i++)n=nodes[i],await browser.bookmarks.move(n.id,{index:minIndex+i}),count--,progressNotification&&Notifications.updateProgress(progressNotification,initialCount-count,initialCount)}progressNotification&&Notifications.finishProgress(progressNotification)}var unmarkOpenBookmarksTimeout={};function unmarkOpenBookmarksDebounced(url,delay=500){clearTimeout(unmarkOpenBookmarksTimeout[url]),unmarkOpenBookmarksTimeout[url]=setTimeout(()=>{delete unmarkOpenBookmarksTimeout[url],unmarkOpenBookmarks(url)},delay)}function unmarkOpenBookmarks(url){clearTimeout(unmarkOpenBookmarksTimeout[url]),unmarkOpenBookmarksTimeout[url]=setTimeout(()=>{delete unmarkOpenBookmarksTimeout[url];let bookmarks2=Bookmarks.byUrl[url];if(bookmarks2)for(let b of bookmarks2)b.isOpen=!1,Bookmarks.unmarkParents(b)},500)}function reMarkOpenBookmark(bookmark){if(!bookmark.url)return;let tabIsOpen=!!Tabs2.urlsInUse[bookmark.url],bookmarkIsMarked=bookmark.isOpen??!1;tabIsOpen!==bookmarkIsMarked&&(bookmarkIsMarked?(bookmark.isOpen=!1,Bookmarks.unmarkParents(bookmark)):(bookmark.isOpen=!0,Bookmarks.markParents(bookmark)))}var markOpenBookmarksTimeout={};function markOpenBookmarksDebounced(url,delay=500){clearTimeout(markOpenBookmarksTimeout[url]),markOpenBookmarksTimeout[url]=setTimeout(()=>{delete markOpenBookmarksTimeout[url],markOpenBookmarks(url)},delay)}function markOpenBookmarks(url){let bookmarks2=Bookmarks.byUrl[url];if(bookmarks2)for(let b of bookmarks2)b.isOpen=!0,Bookmarks.markParents(b)}function unmarkAllOpenBookmarks(nodes){nodes||(nodes=Bookmarks.reactive.tree,Bookmarks.markedFolders={});for(let node of nodes)node.children?.length&&node.isOpen&&unmarkAllOpenBookmarks(node.children),node.isOpen=!1}function markOpenBookmarksForAllTabs(){for(let url of Object.keys(Tabs2.urlsInUse))markOpenBookmarks(url)}function markParents(node){let parent=Bookmarks.reactive.byId[node.parentId];for(;parent&&(Bookmarks.markedFolders[parent.id]=(Bookmarks.markedFolders[parent.id]??0)+1,!parent.isOpen);){parent.isOpen=!0;parent=Bookmarks.reactive.byId[parent.parentId]}}function unmarkParents(node){let parent=Bookmarks.reactive.byId[node.parentId];for(;parent&&(Bookmarks.markedFolders[parent.id]=(Bookmarks.markedFolders[parent.id]??1)-1,!Bookmarks.markedFolders[parent.id]&&parent.isOpen);){parent.isOpen=!1;parent=Bookmarks.reactive.byId[parent.parentId]}}async function createFromDragEvent2(e,dst){if(!dst.parentId||!Bookmarks.reactive.byId[dst.parentId])return;let dndInfo=e.dataTransfer?.getData("application/x-sidebery-dnd");if(dndInfo){let info2;try{info2=JSON.parse(dndInfo)}catch{return}if(info2.items){let groupUrlStartRe=/^moz-extension:\/\/.{36}\/(page.)?group\/group\.html(.+)$/;for(let item of info2.items)item.url&&groupUrlStartRe.test(item.url)&&(item.url=item.url.replace(groupUrlStartRe,(_,_1,$2)=>GROUP_URL+$2));Bookmarks.createFrom(info2.items,dst)}return}let result=await parseDragEvent(e);result?.url&&(result.text||(result.text=Tabs2.list.find(t=>t.url===result.url)?.title),await browser.bookmarks.create({url:result.url,title:result.text||result.url,index:dst.index,parentId:dst.parentId}))}async function move2(ids,dst){if(!dst.parentId){let firstNode=Bookmarks.reactive.byId[ids[0]];if(!firstNode)return warn("Bookmarks: Cannot move bookmarks: No first node");let result=await Bookmarks.openBookmarksPopup({title:translate("popup.bookmarks.move_to"),location:firstNode.parentId,locationField:!0,locationTree:!1,newFolderPosition:[firstNode.parentId,firstNode.index],recentLocations:!0,controls:[{label:translate("popup.bookmarks.move")}]});if(result?.location)dst.parentId=result.location;else return warn("Bookmarks: Cannot move bookmarks: No destination")}let dstIndex=dst.index;dstIndex===void 0&&(dstIndex=Bookmarks.reactive.byId[dst.parentId]?.children?.length??0);for(let id of ids){let bookmark=Bookmarks.reactive.byId[id];bookmark&&(ids.includes(bookmark.parentId)||(bookmark.parentId===dst.parentId&&bookmark.index<dstIndex&&dstIndex--,await browser.bookmarks.move(id,{parentId:dst.parentId,index:dstIndex++})))}}function attachTabInfoToTitle(item){if(item.pinned&&(item.title+=" "+PIN_MARK),item.container&&item.container!==CONTAINER_ID){let container=Containers.reactive.byId[item.container];container&&(item.title+=` [${Containers.getCUID(container)}]`)}item.customColor&&(item.title+=` [${TAB_BOOKMARK_COLOR[item.customColor]}]`)}function extractTabInfoFromTitle(item,updateTitleOnly){if(!item.title)return;let pinIndex=item.title.indexOf(" "+PIN_MARK);pinIndex!==-1&&(item.title=item.title.slice(0,pinIndex)+item.title.slice(pinIndex+1+PIN_MARK.length),updateTitleOnly||(item.pinned=!0)),item.title=item.title.replace(CONTAINER_IN_BOOKMARK_RE,(match,cuid)=>{if(typeof cuid!="string")return match;let info2=Containers.parseCUID(cuid),container=Containers.findUnique(info2);return container?(updateTitleOnly||(item.container=container.id),""):match}),item.title=item.title.replace(COLOR_IN_BOOKMARK_RE,(match,colorId)=>{let color=BOOKMARK_TAB_COLOR[colorId];return color?(updateTitleOnly||(item.customColor=color),""):match})}async function createFrom(items,dst,progress2){if(!dst.parentId)return warn("Bookmarks: Cannot create bookmarks: No parentId");let dstIndex=dst.index,n=0;if(dstIndex===void 0&&(dstIndex=Bookmarks.reactive.byId[dst.parentId]?.children?.length??0),Settings.state.tabsTreeBookmarks){let idsMap={};for(let item of items){let parent=items.find(t=>t.id===item.parentId),children=items.filter(t=>t.parentId===item.id),parentId=idsMap[item.parentId??NOID]??dst.parentId,index=parent?void 0:dstIndex++;if(children.length){let folderConf={title:item.title,parentId,index},folder=await browser.bookmarks.create(folderConf);if(idsMap[item.id]=folder.id,progress2&&Notifications.updateProgress(progress2,n++,items.length),item.url&&!GROUP_RE.test(item.url)){attachTabInfoToTitle(item);let url2=denormalizeUrl(item.url);await browser.bookmarks.create({title:item.title,url:url2,parentId:folder.id})}continue}attachTabInfoToTitle(item);let url=denormalizeUrl(item.url);await browser.bookmarks.create({title:item.title,url,parentId,index}),progress2&&Notifications.updateProgress(progress2,n++,items.length)}}else for(let t of items)attachTabInfoToTitle(t),await browser.bookmarks.create({url:denormalizeUrl(t.url),title:t.title,index:dstIndex++,parentId:dst.parentId}),progress2&&Notifications.updateProgress(progress2,n++,items.length)}async function saveToFolder(items,dst,removeOld,progress2,idsMap){if(!dst.parentId)return warn("Bookmarks.saveToFolder: No dst parentId");let dstFolder=Bookmarks.reactive.byId[dst.parentId];if(!dstFolder)return warn("Bookmarks.saveToFolder: No dst parent folder");let panelFolderId=dstFolder.id,bookmarksList=Array.from(listBookmarks(dstFolder.children)),n=0;if(Settings.state.tabsTreeBookmarks){idsMap?idsMap[NOID]=panelFolderId:idsMap={[NOID]:panelFolderId};let indexes={[panelFolderId]:0};for(let i=0;i<items.length;i++){let item=items[i],nextItem=items[i+1],parentFolderId=idsMap[item.parentId??NOID];if(parentFolderId===void 0){warn("Bookmarks.saveToFolder: No parentFolderId: Skipping");continue}let index=indexes[parentFolderId];if(index===void 0&&(index=0,indexes[parentFolderId]=0),indexes[parentFolderId]+=1,!item.url&&!item.title){let sepIndex=bookmarksList.findIndex(n2=>n2.type==="separator"),separator=bookmarksList[sepIndex];if(separator)bookmarksList.splice(sepIndex,1),(separator.index!==index||parentFolderId!==separator.parentId)&&await browser.bookmarks.move(separator.id,{index,parentId:parentFolderId});else{let createConf={type:"separator",index,parentId:parentFolderId};await browser.bookmarks.create(createConf)}continue}if(nextItem?.parentId===item.id||!item.url){attachTabInfoToTitle(item);let folderIndex=bookmarksList.findIndex(n2=>n2.type==="folder"&&n2.title===item.title),folder=bookmarksList[folderIndex];if(folder)bookmarksList.splice(folderIndex,1),(folder.index!==index||parentFolderId!==folder.parentId)&&await browser.bookmarks.move(folder.id,{index,parentId:parentFolderId});else{let createConf={title:item.title,index,parentId:parentFolderId};folder=await browser.bookmarks.create(createConf)}if(indexes[folder.id]=0,idsMap[item.id]=folder.id,progress2&&Notifications.updateProgress(progress2,n++,items.length),item.url&&!GROUP_RE.test(item.url)){let bookmarkIndex2=bookmarksList.findIndex(n2=>n2.type==="bookmark"&&n2.title===item.title&&n2.url===item.url),bookmark2=bookmarksList[bookmarkIndex2];if(bookmark2)bookmarksList.splice(bookmarkIndex2,1),(bookmark2.index!==0||folder.id!==bookmark2.parentId)&&await browser.bookmarks.move(bookmark2.id,{index:0,parentId:folder.id});else{let url2=denormalizeUrl(item.url),createConf={title:item.title,url:url2,index:0,parentId:folder.id};bookmark2=await browser.bookmarks.create(createConf)}indexes[folder.id]++}continue}attachTabInfoToTitle(item);let url=denormalizeUrl(item.url),bookmarkIndex=bookmarksList.findIndex(n2=>n2.type==="bookmark"&&n2.title===item.title&&n2.url===url),bookmark=bookmarksList[bookmarkIndex];if(bookmark)bookmarksList.splice(bookmarkIndex,1),(bookmark.index!==index||parentFolderId!==bookmark.parentId)&&await browser.bookmarks.move(bookmark.id,{index,parentId:parentFolderId});else{let createConf={title:item.title,url,index,parentId:parentFolderId};bookmark=await browser.bookmarks.create(createConf)}progress2&&Notifications.updateProgress(progress2,n++,items.length)}}else{let index=0;for(let item of items){if(item.url&&GROUP_RE.test(item.url))continue;attachTabInfoToTitle(item);let bookmarkIndex=bookmarksList.findIndex(n2=>n2.type==="bookmark"&&n2.title===item.title&&n2.url===item.url),bookmark=bookmarksList[bookmarkIndex];if(bookmark)bookmarksList.splice(bookmarkIndex,1),(bookmark.index!==index||panelFolderId!==bookmark.parentId)&&await browser.bookmarks.move(bookmark.id,{index,parentId:panelFolderId});else{let url=denormalizeUrl(item.url),createConf={title:item.title,url,index,parentId:panelFolderId};bookmark=await browser.bookmarks.create(createConf)}progress2&&Notifications.updateProgress(progress2,n++,items.length),index++}}bookmarksList.length>0&&!removeOld&&Settings.state.oldBookmarksAfterSave==="ask"&&await askWhatToDoWithOldUnusedBookmarks(dstFolder.title)==="delete"&&(removeOld=!0),Settings.state.oldBookmarksAfterSave==="del"&&(removeOld=!0);for(let node of bookmarksList)if(node.type==="folder"&&node.children&&!node.children.length)await browser.bookmarks.removeTree(node.id);else if(removeOld){if(bookmarksList.find(n2=>n2.id===node.parentId))continue;node.type==="folder"?await browser.bookmarks.removeTree(node.id):await browser.bookmarks.remove(node.id)}}async function askWhatToDoWithOldUnusedBookmarks(folderName){let remember=!1;if(folderName.length>16){let index=folderName.indexOf(" [");index>0&&(folderName=folderName.slice(0,index))}let conf={title:translate("popup.wtdwOldBookmarks.title",folderName),note:translate("popup.wtdwOldBookmarks.note"),checkbox:{label:translate("popup.wtdwOldBookmarks.checkbox_label"),value:remember,update:value=>remember=value},buttons:[{value:"delete",label:translate("popup.wtdwOldBookmarks.delete")},{value:"keep",label:translate("popup.wtdwOldBookmarks.keep")}],buttonsCentered:!0},result=await ask(conf);return remember&&(result==="delete"&&(Settings.state.oldBookmarksAfterSave="del"),result==="keep"&&(Settings.state.oldBookmarksAfterSave="keep"),Settings.saveDebounced(150)),result}function getPath(bookmark){let parent=Bookmarks.reactive.byId[bookmark.parentId],path2=[];for(;parent;)path2.unshift(parent.id),parent=Bookmarks.reactive.byId[parent.parentId];return path2}function findBookmarkPanelOf(bookmark){let path2=Bookmarks.getPath(bookmark);for(let panel of Sidebar.panels)if(isBookmarksPanel(panel)&&(panel.rootId===NOID||panel.rootId===BKM_ROOT_ID||path2.includes(panel.rootId)))return panel.id}var scrollToBookmarkTimeout;function scrollToBookmarkDebounced(id,forced,delay=120){clearTimeout(scrollToBookmarkTimeout),scrollToBookmarkTimeout=setTimeout(()=>scrollToBookmark(id,forced),delay)}var scrollConf3={behavior:"smooth",top:0};function scrollToBookmark(id,forced){let actPanelId=Sidebar.activePanelId,panel=Sidebar.panelsById[actPanelId];if(isTabsPanel(panel)&&Sidebar.subPanelActive&&Sidebar.subPanelType===2&&Sidebar.subPanels.bookmarks&&(panel=Sidebar.subPanels.bookmarks),!isBookmarksPanel(panel)||!panel.scrollEl)return;let elId=`bookmark${actPanelId}${id}`,el=document.getElementById(elId),bodyEl=el?.firstElementChild;if(!el||!bodyEl)return;let sR=panel.scrollEl.getBoundingClientRect(),bR=el.getBoundingClientRect(),pH=panel.scrollEl.offsetHeight,pS=panel.scrollEl.scrollTop,bH=bodyEl.offsetHeight,bY=bR.top-sR.top+pS;if(forced){let y=bY-PRE_SCROLL;y<0&&(y=0),scrollConf3.top=y,panel.scrollEl.scroll(scrollConf3);return}if(bY<pS+PRE_SCROLL){if(pS>0){let y=bY-PRE_SCROLL;y<0&&(y=0),scrollConf3.top=y,panel.scrollEl.scroll(scrollConf3)}}else bY+bH>pS+pH-PRE_SCROLL&&(scrollConf3.top=bY+bH-pH+PRE_SCROLL,panel.scrollEl.scroll(scrollConf3))}function*listBookmarks(nodes){nodes||(nodes=Bookmarks.reactive.tree);for(let n of nodes)yield n,n.children&&(yield*listBookmarks(n.children))}function openAsBookmarksPanel(node){if(node.type!=="folder"||Sidebar.reactive.nav.indexOf(Sidebar.activePanelId)===-1)return;let panelName,titleExec=FOLDER_NAME_DATA_RE.exec(node.title);titleExec?panelName=titleExec[1]:panelName=node.title,openPanelPopup({type:1,name:panelName,rootId:node.id})}async function openAsTabsPanel(folder,showConfigPopup){if(folder.type!=="folder")return;let noTabsPanels=!Sidebar.hasTabs,index=Sidebar.getIndexForNewTabsPanel(),tabsPanel;if(showConfigPopup){let result=await openPanelPopup({type:2,name:folder.title,bookmarksFolderId:folder.id},index);if(!result)return warn("Bookmarks.openAsTabsPanel: No result");tabsPanel=Sidebar.panelsById[result]}else tabsPanel=Sidebar.createTabsPanel(),tabsPanel.ready=!0,tabsPanel.reactive.ready=!0,Sidebar.addPanel(index,tabsPanel),Sidebar.recalcPanels(),Sidebar.recalcTabsPanels(),Sidebar.saveSidebar(300);if(!isTabsPanel(tabsPanel))return warn("Bookmarks.openAsTabsPanel: No tabsPanel");noTabsPanels&&await Tabs2.load();let ids=folder.children?.map(n=>n.id)??[];folder.children?.length&&folder.title===folder.children[0]?.title&&ids.unshift(folder.id),ids.length&&await Bookmarks.open(ids,{panelId:tabsPanel.id})}async function copyUrls3(ids){if(!Permissions.reactive.clipboardWrite&&!await Permissions.request("clipboardWrite"))return;let urls="";for(let node of Bookmarks.listBookmarks()){let includedItself=ids.includes(node.id);(includedItself||ids.includes(node.parentId))&&(!includedItself&&node.children?.length&&ids.push(node.id),node.url&&(urls+=`
`+node.url))}let resultString=urls.trim();resultString&&navigator.clipboard.writeText(resultString)}async function copyTitles3(ids){if(!Permissions.reactive.clipboardWrite&&!await Permissions.request("clipboardWrite"))return;let titles="";for(let node of Bookmarks.listBookmarks()){let includedItself=ids.includes(node.id);(includedItself||ids.includes(node.parentId))&&(!includedItself&&node.children?.length&&ids.push(node.id),node.title&&(titles+=`
`+node.title))}let resultString=titles.trim();resultString&&navigator.clipboard.writeText(resultString)}function isFolderWithURL(folder){if(!folder.children)return!1;let firstChild=folder.children[0];if(!firstChild?.url)return!1;let title=folder.title,childTitle=firstChild.title;return childTitle===title?!0:childTitle.startsWith(title)&&childTitle[title.length+1]==="["}function bookmarkIsParentTab(node,parentTitle){if(!node.url||!parentTitle)return!1;let childTitle=node.title;return childTitle===parentTitle?!0:childTitle.startsWith(parentTitle)&&childTitle[parentTitle.length+1]==="["}async function prepareBookmarks(){return!Permissions.reactive.bookmarks&&!await Permissions.request("bookmarks")?!1:(Bookmarks.reactive.tree.length||await Bookmarks.load(),!0)}var bookmarks_handlers_exports={};__export(bookmarks_handlers_exports,{resetBookmarksListeners:()=>resetBookmarksListeners,setupBookmarksListeners:()=>setupBookmarksListeners,updateTreeLen:()=>updateTreeLen});function setupBookmarksListeners(){browser.bookmarks&&(Info.isBg||(browser.bookmarks.onCreated.addListener(onBookmarkCreatedFg),browser.bookmarks.onChanged.addListener(onBookmarkChangedFg),browser.bookmarks.onMoved.addListener(onBookmarkMovedFg),browser.bookmarks.onRemoved.addListener(onBookmarkRemovedFg)))}function resetBookmarksListeners(){browser.bookmarks&&(Info.isBg||(browser.bookmarks.onCreated.removeListener(onBookmarkCreatedFg),browser.bookmarks.onChanged.removeListener(onBookmarkChangedFg),browser.bookmarks.onMoved.removeListener(onBookmarkMovedFg),browser.bookmarks.onRemoved.removeListener(onBookmarkRemovedFg)))}function onBookmarkCreatedFg(id,bookmark){if(!Bookmarks.reactive.tree.length)return;bookmark.sel=!1,bookmark.isOpen=!1,bookmark.type==="separator"&&(bookmark.url=void 0),bookmark.type==="folder"&&(bookmark.len=0,bookmark.children||(bookmark.children=[])),Settings.state.highlightOpenBookmarks&&bookmark.url&&(bookmark.isOpen=!!Tabs2.urlsInUse[bookmark.url],bookmark.isOpen&&Bookmarks.markParents(bookmark));let parent=Bookmarks.reactive.byId[bookmark.parentId];if(parent&&parent.children&&bookmark.index!==void 0){parent.children.splice(bookmark.index,0,bookmark);for(let i=bookmark.index+1;i<parent.children.length;i++)parent.children[i].index=i}Bookmarks.reactive.byId[id]=bookmark;let rBookmark=Bookmarks.reactive.byId[id];bookmark.url&&(Bookmarks.byUrl[bookmark.url]?Bookmarks.byUrl[bookmark.url].push(rBookmark):Bookmarks.byUrl[bookmark.url]=[rBookmark]);let addedLen=bookmark.len||1;bookmark.type==="bookmark"&&Bookmarks.updateTreeLen(parent,addedLen),Sidebar.recalcBookmarksPanels()}function onBookmarkChangedFg(id,info2){if(!Bookmarks.reactive.tree.length)return;let bookmark=Bookmarks.reactive.byId[id];if(!bookmark)return;let oldUrl=bookmark.url;if(oldUrl&&oldUrl!==info2.url&&Bookmarks.byUrl[oldUrl]){let iob=Bookmarks.byUrl[oldUrl].findIndex(b=>b.id===id);iob>-1&&Bookmarks.byUrl[oldUrl].splice(iob,1)}info2.title!==void 0&&bookmark.title!==info2.title&&(bookmark.title=info2.title),info2.url!==void 0&&oldUrl!==info2.url&&(bookmark.url=info2.url,Bookmarks.byUrl[info2.url]?Bookmarks.byUrl[info2.url].push(bookmark):Bookmarks.byUrl[info2.url]=[bookmark],Settings.state.highlightOpenBookmarks&&Bookmarks.reMarkOpenBookmark(bookmark))}function onBookmarkMovedFg(id,info2){if(!Bookmarks.reactive.tree.length)return;let oldParent=Bookmarks.reactive.byId[info2.oldParentId],newParent=Bookmarks.reactive.byId[info2.parentId];if(oldParent?.children&&newParent?.children){let node2=oldParent.children.splice(info2.oldIndex,1)[0];for(let i=info2.oldIndex;i<oldParent.children.length;i++)oldParent.children[i].index=i;node2.index=info2.index,node2.parentId=info2.parentId,newParent.children.splice(node2.index,0,node2);for(let i=info2.index+1;i<newParent.children.length;i++)newParent.children[i].index=i}let node=Bookmarks.reactive.byId[id];if(node&&oldParent&&newParent&&newParent.id!==oldParent.id){let movedLen=node?.len||1;if(Bookmarks.updateTreeLen(oldParent,-movedLen),Bookmarks.updateTreeLen(newParent,movedLen),node.isOpen){let parent=oldParent;for(;parent&&(Bookmarks.markedFolders[parent.id]=(Bookmarks.markedFolders[parent.id]??1)-1,!Bookmarks.markedFolders[parent.id]&&parent.isOpen);){parent.isOpen=!1;parent=Bookmarks.reactive.byId[parent.parentId]}for(parent=newParent;parent&&(Bookmarks.markedFolders[parent.id]=(Bookmarks.markedFolders[parent.id]??0)+1,!parent.isOpen);){parent.isOpen=!0;parent=Bookmarks.reactive.byId[parent.parentId]}}}Bookmarks.saveBookmarksTree(),Sidebar.recalcBookmarksPanels()}function onBookmarkRemovedFg(id,info2){if(!Bookmarks.reactive.tree.length)return;let parent=Bookmarks.reactive.byId[info2.parentId],node=Bookmarks.reactive.byId[id];if(!node)return;let removedLen=node.len||1;if(Bookmarks.updateTreeLen(parent,-removedLen),parent?.children){parent.children.splice(info2.index,1);for(let i=info2.index;i<parent.children.length;i++)parent.children[i].index=i}if(node.type==="folder"&&node.children?.length){for(let child of Bookmarks.listBookmarks(node.children))delete Bookmarks.reactive.byId[child.id];let p=parent;for(;p&&(Bookmarks.markedFolders[p.id]=(Bookmarks.markedFolders[p.id]??1)-1,!Bookmarks.markedFolders[p.id]&&p.isOpen);){p.isOpen=!1;p=Bookmarks.reactive.byId[p.parentId]}delete Bookmarks.markedFolders[node.id]}delete Bookmarks.reactive.byId[id];let url=node?.url;if(url&&Bookmarks.byUrl[url]){let ib=Bookmarks.byUrl[url].findIndex(b=>b.id===id);ib>-1&&Bookmarks.byUrl[url].splice(ib,1)}Sidebar.recalcBookmarksPanels()}function updateTreeLen(parent,delta){let p=parent;for(;p;)p.len!==void 0&&(p.len+=delta),p=Bookmarks.reactive.byId[p.parentId];Bookmarks.overallCount+=delta}var Bookmarks={reactive:{tree:[],byId:{},popup:null,expanded:{}},byUrl:{},markedFolders:{},overallCount:0,...bookmarks_handlers_exports,...bookmarks_actions_exports};var resetStop=!1,firstItem=null,selType=0;function getLength(){return Selection.selected.length}function getFirst(){return firstItem||Selection.selected[0]}function getLast(){return Selection.selected[0]===firstItem?Selection.selected[Selection.selected.length-1]:Selection.selected[0]}var isTabs=()=>selType===1,isBookmarks=()=>selType===2,isHistory=()=>selType===3,isNavItem=()=>selType===6,isNewTabBar=()=>selType===5,isHeader=()=>selType===7,isSet=()=>selType!==0;function get(){return[...Selection.selected]}function getTabsInfo2(setPanelId){if(selType!==1)return[];let tabIds=[...Selection.selected];return Tabs2.sortTabIds(tabIds),Tabs2.getTabsInfo(tabIds,setPanelId)}function map(cb){return Selection.selected.map(cb)}function select(id,type){!type&&(Tabs2.byId[id]?type=1:Bookmarks.reactive.byId[id]?type=2:Sidebar.panelsById[id]&&(type=6),!type)||(type===1?selectTab(id):type===2?selectBookmark(id):type===3?selectHistory(id):type===6?selectNavItem(id):type===7&&selectHeader(id))}function selectHeader(id){Sidebar.reactive.selectedHeader=id,Selection.selected.push(id),firstItem=id,selType=7}function selectTab(tabId){let target=Tabs2.byId[tabId];if(target){if(firstItem!==null){let firstTab=Tabs2.byId[firstItem];if(firstTab&&firstTab.pinned!==target.pinned)return}target.reactive.sel=target.sel=!0,Selection.selected.push(tabId),firstItem=tabId,selType=1,Settings.state.nativeHighlight&&updateHighlightedTabs(120)}}function selectTabs(tabIds){for(let id of tabIds){let target=Tabs2.byId[id];target&&(target.reactive.sel=target.sel=!0,Selection.selected.push(id))}firstItem=tabIds[0],selType=1,Settings.state.nativeHighlight&&updateHighlightedTabs(120)}function selectTabsRange(aTab,bTab){if(!bTab&&firstItem!==null&&(bTab=Tabs2.byId[firstItem]),!bTab)return;if(aTab.pinned!==bTab.pinned||aTab.panelId!==bTab.panelId)return resetSelection();if(Selection.selected.length){for(let id of Selection.selected){let tab=Tabs2.byId[id];tab&&(tab.reactive.sel=!1)}Selection.selected=[]}let minIndex=Math.min(aTab.index,bTab.index),maxIndex=Math.max(aTab.index,bTab.index),panel=Sidebar.panelsById[aTab.panelId];if(!isTabsPanel(panel))return resetSelection();if(panel.filteredTabs&&!aTab.pinned)for(let tab of panel.filteredTabs)tab.index>=minIndex&&tab.index<=maxIndex&&(tab.reactive.sel=tab.sel=!0,Selection.selected.push(tab.id));else for(let i=minIndex;i<=maxIndex;i++){let target=Tabs2.list[i];target.reactive.sel=target.sel=!0,Selection.selected.push(target.id)}selType=1,firstItem===null&&(firstItem=aTab.id),Settings.state.nativeHighlight&&updateHighlightedTabs(120)}function selectTabsBranch(parentTab){if(parentTab.reactive.sel=parentTab.sel=!0,Selection.selected.push(parentTab.id),firstItem=parentTab.id,Settings.state.tabsTree)for(let tab,i=parentTab.index+1;i<Tabs2.list.length&&(tab=Tabs2.list[i],!(tab.lvl<=parentTab.lvl));i++)tab.reactive.sel=tab.sel=!0,Selection.selected.push(tab.id);selType=1,Settings.state.nativeHighlight&&updateHighlightedTabs(120)}function selectBookmark(bookmarkId){let target=Bookmarks.reactive.byId[bookmarkId];target&&(target.sel=!0,Selection.selected.push(bookmarkId),firstItem=bookmarkId,selType=2)}function selectBookmarks(ids){for(let id of ids){let target=Bookmarks.reactive.byId[id];target&&(target.sel=!0,Selection.selected.push(id))}firstItem=ids[0],selType=2}function selectBookmarksRange(aBookmark,bBookmark){if(!bBookmark&&firstItem!==null&&(bBookmark=Bookmarks.reactive.byId[firstItem]),!bBookmark)return;Sidebar.updateBounds(),Selection.selected.length&&(Selection.selected.forEach(id=>{let bkm=Bookmarks.reactive.byId[id];bkm&&(bkm.sel=!1)}),Selection.selected=[]);let inside=!1,activePanel;if(Sidebar.subPanelActive?activePanel=Sidebar.subPanels.bookmarks:activePanel=Sidebar.panelsById[Sidebar.activePanelId],activePanel)for(let bound of activePanel.bounds){let bkm=Bookmarks.reactive.byId[bound.id];if(bkm){if(bound.id===aBookmark.id||bound.id===bBookmark.id)if(!inside)inside=!0;else{bkm.sel=!0,Selection.selected.push(bound.id);break}inside&&(bkm.sel=!0,Selection.selected.push(bound.id))}}selType=2,firstItem===null&&(firstItem=aBookmark.id)}function selectHistory(id){let target=History.byId[id];target&&(target.reactive.sel=!0,Selection.selected.push(id),firstItem=id,selType=3)}function selectNewTabBtn(panelId){let target=Sidebar.panelsById[panelId];isTabsPanel(target)&&(target.selNewTab=!0,target.reactive.selNewTab=!0,Selection.selected.push(panelId),firstItem=panelId,selType=5)}function selectNavItem(id){Sidebar.reactive.nav.indexOf(id)!==-1&&(Sidebar.reactive.selectedNavId=id,Selection.selected.push(id),firstItem=id,selType=6)}function deselectHeader(id){let index=Selection.selected.indexOf(id);index>=0&&Selection.selected.splice(index,1),firstItem===id&&(firstItem=null),Sidebar.reactive.selectedHeader=NOID}function deselectTab(tabId){let index=Selection.selected.indexOf(tabId);index>=0&&Selection.selected.splice(index,1);let target=Tabs2.byId[tabId];target&&(target.reactive.sel=target.sel=!1),Selection.selected.length||(selType=0),firstItem===tabId&&(firstItem=null),Settings.state.nativeHighlight&&updateHighlightedTabs(120)}function deselectTabsBranch(parentTab){if(Selection.deselectTab(parentTab.id),Settings.state.tabsTree)for(let tab,i=parentTab.index+1;i<Tabs2.list.length&&(tab=Tabs2.list[i],!(tab.lvl<=parentTab.lvl));i++)Selection.deselectTab(tab.id)}function deselectBookmark(bookmarkId){let index=Selection.selected.indexOf(bookmarkId);index>=0&&Selection.selected.splice(index,1);let target=Bookmarks.reactive.byId[bookmarkId];target&&(target.sel=!1),Selection.selected.length||(selType=0),firstItem===bookmarkId&&(firstItem=null)}function deselectHistory(id){let index=Selection.selected.indexOf(id);index>=0&&Selection.selected.splice(index,1);let target=History.byId[id];target&&(target.reactive.sel=!1),Selection.selected.length||(selType=0),firstItem===id&&(firstItem=null)}function deselectNewTabBtn(panelId){let index=Selection.selected.indexOf(panelId);index>=0&&Selection.selected.splice(index,1);let target=Sidebar.panelsById[panelId];isTabsPanel(target)&&(target.reactive.selNewTab=target.selNewTab=!1),Selection.selected.length||(selType=0),firstItem===panelId&&(firstItem=null)}function deselectNavItem(id){let index=Selection.selected.indexOf(id);index>=0&&Selection.selected.splice(index,1),Sidebar.reactive.selectedNavId=NOID,firstItem===id&&(firstItem=null),Selection.selected.length||(selType=0)}function resetSelection(forced){if(!(!forced&&resetStop)&&Selection.selected.length){if(selType===7&&(Sidebar.reactive.selectedHeader=NOID),selType===1){for(let id of Selection.selected){let target=Tabs2.byId[id];target&&(target.reactive.sel=target.sel=!1)}Settings.state.nativeHighlight&&updateHighlightedTabs(120)}if(selType===2)for(let id of Selection.selected){let target=Bookmarks.reactive.byId[id];target&&(target.sel=!1)}if(selType===3)for(let id of Selection.selected){let target=History.byId[id];target&&(target.reactive.sel=!1)}if(selType===5)for(let id of Selection.selected){let target=Sidebar.panelsById[id];isTabsPanel(target)&&(target.reactive.selNewTab=target.selNewTab=!1)}selType===6&&(Sidebar.reactive.selectedNavId=NOID),Selection.selected=[],selType=0,firstItem=null}}function includes(id){return Selection.selected.includes(id)}var updateHighlightedTabsTimeout;function updateHighlightedTabs(delay=250){clearTimeout(updateHighlightedTabsTimeout),updateHighlightedTabsTimeout=setTimeout(()=>{let conf={windowId:Windows.id,populate:!1,tabs:[]},activeTab=Tabs2.byId[Tabs2.activeId];activeTab&&conf.tabs.push(activeTab.index);for(let tabId of Selection.selected){let tab=Tabs2.byId[tabId];tab&&(tab.hidden||conf.tabs.push(tab.index))}browser.tabs.highlight(conf).catch(()=>{})},delay)}function preserveSelection(){resetStop=!0}var preserveSelectionTimeout;function allowSelectionReset(timeout){clearTimeout(preserveSelectionTimeout),preserveSelectionTimeout=setTimeout(()=>{resetStop=!1},timeout)}var Selection={selected:[],...selection_actions_exports,[Symbol.iterator](){let index=-1,list=Selection.selected;return{next:()=>({value:list[++index],done:!(index in list)})}}};var handledReqId2;function onBeforeRequestHandler(info2){if(!Tabs2.byId||info2.incognito)return;let tab=Tabs2.byId[info2.tabId];if(tab&&handledReqId2!==info2.requestId&&tab.reopenInContainer){handledReqId2=info2.requestId;let panel=Sidebar.panelsById[tab.panelId];if(!isTabsPanel(panel))return;let reopenInContainer2=tab.reopenInContainer;if(delete tab.reopenInContainer,panel.newTabCtx===reopenInContainer2&&info2.method==="GET"){let dst={panelId:tab.panelId,containerId:reopenInContainer2},item={id:tab.id,url:info2.url,active:tab.active,index:tab.index};return Tabs2.reopen([item],dst),{cancel:!0}}}}function turnOnBeforeRequestHandler(){if(!browser.webRequest)return;let eventTarget=browser.webRequest.onBeforeRequest;if(!eventTarget.hasListener(onBeforeRequestHandler)){let filter={urls:["<all_urls>"],windowId:Windows.id,incognito:!1,types:["main_frame"]};eventTarget.addListener(onBeforeRequestHandler,filter,["blocking"])}}function turnOffBeforeRequestHandler(){if(!browser.webRequest)return;let eventTarget=browser.webRequest.onBeforeRequest;eventTarget.hasListener(onBeforeRequestHandler)&&eventTarget.removeListener(onBeforeRequestHandler)}function updateWebReqHandlers(){if(Windows.incognito)return;let listen=!1;if(Settings.state.newTabCtxReopen){for(let panel of Sidebar.panels)if(isTabsPanel(panel)&&Containers.reactive.byId[panel.newTabCtx]){listen=!0;break}}listen?turnOnBeforeRequestHandler():turnOffBeforeRequestHandler()}var reactFn6;function initSidebar(react){reactFn6=react,Sidebar.reactive=reactFn6(Sidebar.reactive)}function setupListeners5(){Info.isBg&&Store.onKeyChange("sidebar",updateSidebarInBg),Info.isSetup&&Store.onKeyChange("sidebar",updateSidebarInSetup),Info.isSidebar&&(Store.onKeyChange("sidebar",updateSidebar),window.addEventListener("resize",onSidebarResize))}function resetListeners3(){window.removeEventListener("resize",onSidebarResize)}var rootEl=null;function registerRootEl(el){rootEl=el}var horizontalNavBarEl;function registerHorizontalNavBarEl(el){horizontalNavBarEl=el}async function loadPanels(){let ts=performance.now();info("Sidebar.loadPanels");let gettingActiveId=browser.sessions.getWindowValue(Windows.id,"activePanelId"),gettingHiddenPanels=browser.sessions.getWindowValue(Windows.id,"hiddenPanels"),gettingStorage=browser.storage.local.get("sidebar"),[activeId,storage,hiddenPanels]=await Promise.all([gettingActiveId,gettingStorage,gettingHiddenPanels]);storage.sidebar?.nav?.length||(warn("Sidebar.loadPanels: Creating default sidebar config"),storage.sidebar=createDefaultSidebarConfig());let sidebar2=storage.sidebar,panelConfigs=sidebar2?.panels?Object.values(sidebar2?.panels):[];sidebar2?.nav&&(Sidebar.reactive.nav=sidebar2.nav,Sidebar.nav=sidebar2.nav);for(let panelConfig of panelConfigs){let panel=createPanelFromConfig(panelConfig);if(panel){if(isTabsPanel(panel)){let newTabContainer=panel.newTabCtx?Containers.reactive.byId[panel.newTabCtx]:null;panel.newTabCtx!==DEFAULT_CONTAINER_ID&&!newTabContainer&&(panel.newTabCtx="none")}panel.reactive.tooltip=getPanelTooltip(panel),hiddenPanels?.length&&hiddenPanels.includes(panel.id)&&(panel.hidden=!0,panel.reactive.hidden=!0),Sidebar.panelsById[panel.id]=panel}}if(recalcPanels(),Tabs2.recalcMoveRules(),Windows.incognito){let tabsPanel=Sidebar.panels.find(p=>p.type===2);tabsPanel?Sidebar.reactive.activePanelId=Sidebar.activePanelId=tabsPanel.id:Sidebar.reactive.activePanelId=Sidebar.activePanelId=Sidebar.panels[0]?.id??NOID,Sidebar.lastActivePanelId=Sidebar.reactive.activePanelId}else{let actPanel=Sidebar.panelsById[activeId];actPanel||(actPanel=Sidebar.panels.find(p=>p.type===2)),actPanel?Sidebar.reactive.activePanelId=Sidebar.activePanelId=actPanel.id:Sidebar.reactive.activePanelId=Sidebar.activePanelId=Sidebar.panels[0]?.id??NOID,Sidebar.lastActivePanelId=Sidebar.reactive.activePanelId}Sidebar.ready=!0,info(`Sidebar.loadPanels: Done: ${performance.now()-ts}ms`)}async function loadNav(){let storage=await browser.storage.local.get("sidebar"),saveNeeded=!1;storage.sidebar?.nav?.length||(warn("Sidebar.loadNav: Creating default sidebar config and saving it"),storage.sidebar=createDefaultSidebarConfig(),saveNeeded=!0),storage.sidebar&&parseNav(storage.sidebar),saveNeeded&&await Store.set({sidebar:storage.sidebar},300)}function parseNav(config){Sidebar.hasTabs=!1,Sidebar.hasBookmarks=!1,Sidebar.hasHistory=!1;for(let id of config.nav){let panel=config.panels[id];panel&&(!Sidebar.hasTabs&&panel.type===2&&(Sidebar.hasTabs=!0),!Sidebar.hasBookmarks&&panel.type===1&&(Sidebar.hasBookmarks=!0),!Sidebar.hasHistory&&panel.type===4&&(Sidebar.hasHistory=!0))}}var resizeTimeout;function onSidebarResize(){clearTimeout(resizeTimeout),resizeTimeout=setTimeout(()=>{if(Sidebar.width!==document.body.offsetWidth&&(Sidebar.width=document.body.offsetWidth,horizontalNavBarEl&&(Sidebar.reactive.horNavWidth=horizontalNavBarEl.offsetWidth),panelsBoxEl&&!Settings.state.scrollThroughTabsExceptOverflow)){let panelsBoxBounds=panelsBoxEl.getBoundingClientRect(),area=Settings.state.scrollThroughTabsScrollArea;area>=0?(Sidebar.scrollAreaRightX=panelsBoxBounds.right-area,Sidebar.scrollAreaLeftX=0):area<0&&(Sidebar.scrollAreaRightX=0,Sidebar.scrollAreaLeftX=panelsBoxBounds.left-area)}if(Sidebar.height!==document.body.offsetHeight){Sidebar.height=document.body.offsetHeight;let activeTab=Tabs2.byId[Tabs2.activeId];activeTab&&!activeTab.pinned&&activeTab.panelId===Sidebar.activePanelId&&Tabs2.scrollToTab(activeTab.id)}},120)}function recalcElementSizes(){if(!rootEl)return;let compStyle=getComputedStyle(rootEl),nbwRaw=compStyle.getPropertyValue("--nav-btn-width");Sidebar.reactive.navBtnWidth=parseCSSNum(nbwRaw.trim())[0];let nbmRaw=compStyle.getPropertyValue("--nav-btn-margin");Sidebar.reactive.navBtnMargin=parseCSSNum(nbmRaw.trim())[0];let thRaw=compStyle.getPropertyValue("--tabs-height");Sidebar.tabHeight=parseCSSNum(thRaw.trim())[0];let tmRaw=compStyle.getPropertyValue("--tabs-margin");Sidebar.tabMargin=parseCSSNum(tmRaw.trim())[0];let bhRaw=compStyle.getPropertyValue("--bookmarks-bookmark-height");Sidebar.bookmarkHeight=parseCSSNum(bhRaw.trim())[0];let fhRaw=compStyle.getPropertyValue("--bookmarks-folder-height");Sidebar.folderHeight=parseCSSNum(fhRaw.trim())[0];let shRaw=compStyle.getPropertyValue("--bookmarks-separator-height");Sidebar.separatorHeight=parseCSSNum(shRaw.trim())[0];let bmRaw=compStyle.getPropertyValue("--bookmarks-margin");Sidebar.bookmarkMargin=parseCSSNum(bmRaw.trim())[0]}var recalcElementSizesTimeout;function recalcElementSizesDebounced(delay=500){clearTimeout(recalcElementSizesTimeout),recalcElementSizesTimeout=setTimeout(recalcElementSizes,delay)}function recalcSidebarSize(){setTimeout(()=>{if(Sidebar.width=document.body.offsetWidth,Sidebar.height=document.body.offsetHeight,panelsBoxEl&&!Settings.state.scrollThroughTabsExceptOverflow){let panelsBoxBounds=panelsBoxEl.getBoundingClientRect(),area=Settings.state.scrollThroughTabsScrollArea;area>=0?(Sidebar.scrollAreaRightX=panelsBoxBounds.right-area,Sidebar.scrollAreaLeftX=0):area<0&&(Sidebar.scrollAreaRightX=0,Sidebar.scrollAreaLeftX=panelsBoxBounds.left-area)}else Sidebar.scrollAreaRightX=0,Sidebar.scrollAreaLeftX=0;horizontalNavBarEl&&(Sidebar.reactive.horNavWidth=horizontalNavBarEl.offsetWidth)},500)}function updateFontSize(){let htmlEl=document.documentElement;Settings.state.fontSize==="xxs"?htmlEl.style.fontSize="14.5px":Settings.state.fontSize==="xs"?htmlEl.style.fontSize="15px":Settings.state.fontSize==="s"?htmlEl.style.fontSize="15.5px":Settings.state.fontSize==="m"?htmlEl.style.fontSize="16px":Settings.state.fontSize==="l"?htmlEl.style.fontSize="16.5px":Settings.state.fontSize==="xl"?htmlEl.style.fontSize="17px":Settings.state.fontSize==="xxl"?htmlEl.style.fontSize="17.5px":htmlEl.style.fontSize="16px"}function recalcTabsPanels(reset3){let pinnedTabIds=[],pinnedTabs=[],pinnedTabIdsByPanel={},pinnedTabsByPanel={},pinnedInPanel=Settings.state.pinnedTabsPosition==="panel",discarded={},tabIndex=0,tabPanelIndex=0,same=!reset3,samePinned=!reset3,tab,startIndex=-1,firstTabsPanel=Sidebar.panels.find(p=>isTabsPanel(p));for(;(tab=Tabs2.list[tabIndex])?.pinned;tabIndex++){if(samePinned&&Tabs2.pinned[tabIndex]?.id!==tab.id&&(samePinned=!1),pinnedInPanel){let panel=Sidebar.panelsById[tab.panelId];if(!panel)if(warn("Cannot find panel for pinned tab",tab.panelId),firstTabsPanel)tab.panelId=firstTabsPanel.id,panel=firstTabsPanel;else{tab.panelId=NOID;continue}let pinnedTabIdsOfPanel=pinnedTabIdsByPanel[panel.id],pinnedTabsOfPanel=pinnedTabsByPanel[panel.id];pinnedTabsOfPanel||(pinnedTabIdsOfPanel=pinnedTabIdsByPanel[panel.id]=[],pinnedTabsOfPanel=pinnedTabsByPanel[panel.id]=[]),isTabsPanel(panel)&&(pinnedTabIdsOfPanel.push(tab.id),pinnedTabsOfPanel.push(tab)),discarded[panel.id]===void 0&&(discarded[panel.id]=!0),!tab.discarded&&discarded[panel.id]&&(discarded[panel.id]=!1)}pinnedTabIds.push(tab.id),pinnedTabs.push(tab)}for(let panel of Sidebar.panels){if(!isTabsPanel(panel))continue;let panelId=panel.id;discarded[panelId]===void 0&&(discarded[panelId]=!0);let pinnedTabIdsOfPanel=pinnedTabIdsByPanel[panelId],pinnedTabsOfPanel=pinnedTabsByPanel[panelId];pinnedTabsOfPanel?(panel.pinnedTabs=pinnedTabsOfPanel,panel.reactive.pinnedTabIds=pinnedTabIdsOfPanel):panel.pinnedTabs.length>0&&(panel.pinnedTabs=[],panel.reactive.pinnedTabIds=[]);let panelTabIds=[],panelTabs=[];for(;(tab=Tabs2.list[tabIndex])&&(tab.panelId===NOID&&(tab.panelId=panelId),tab.panelId===panelId);tabIndex++){same&&panel.tabs[tabPanelIndex]?.id!==tab.id&&(same=!1),startIndex===-1&&(startIndex=tab.index),!tab.discarded&&discarded[panelId]&&(discarded[panelId]=!1);panelTabIds.push(tab.id),panelTabs.push(tab),tabPanelIndex++}let tabsCount=panel.tabs.length;(!same||tabsCount!==tabPanelIndex)&&(tabsCount=panelTabs.length,panel.tabs=panelTabs),tabsCount?(panel.reactive.len=tabsCount+panel.pinnedTabs.length,panel.reactive.empty=!1,panel.startTabIndex=startIndex,panel.endTabIndex=startIndex+tabsCount-1,panel.nextTabIndex=panel.endTabIndex+1):(panel.reactive.len=panel.pinnedTabs.length,panel.reactive.empty=panel.pinnedTabs.length===0,panel.startTabIndex=tabIndex,panel.endTabIndex=tabIndex,panel.nextTabIndex=tabIndex),pinnedTabsOfPanel?.length||tabsCount?panel.allDiscarded=!!discarded[panelId]:panel.allDiscarded=!1,panel.reactive.allDiscarded=panel.allDiscarded,startIndex=-1,tabPanelIndex=0,same=!reset3}(!samePinned||pinnedTabs.length!==Tabs2.pinned.length)&&(Tabs2.pinned=pinnedTabs,Tabs2.reactive.pinnedIds=pinnedTabIds)}function recalcVisibleTabs(panelId){if(panelId===void 0)for(let panel of Sidebar.panels)isTabsPanel(panel)&&recalcVisibleTabsInPanel(panel.id);else recalcVisibleTabsInPanel(panelId)}function recalcVisibleTabsInPanel(panelId){let panel=Sidebar.panelsById[panelId];if(isTabsPanel(panel))if(panel.filteredTabs)panel.reactive.visibleTabIds=panel.filteredTabs.map(t=>t.id);else{let visibleTabIds=[];for(let tab of panel.tabs)tab.invisible||visibleTabIds.push(tab.id);panel.reactive.visibleTabIds=visibleTabIds}}function addToVisibleTabs(panelId,tab){let panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel))return;if(panel.filteredTabs)return Search.search(void 0,!0);if(tab.index===panel.endTabIndex){panel.reactive.visibleTabIds.push(tab.id);return}let tabId=tab.id,invisibleShift=0,index=panel.tabs.findIndex(t=>{if(t.invisible&&invisibleShift++,t.id===tabId)return!0});if(index===-1)return recalcVisibleTabsInPanel(panelId);panel.reactive.visibleTabIds.splice(index-invisibleShift,0,tabId)}function removeFromVisibleTabs(panelId,tabId){let panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel))return;let visibleTabIds=panel.reactive.visibleTabIds,index=visibleTabIds.indexOf(tabId);index!==-1&&visibleTabIds.splice(index,1)}var checkDiscardedTabsInPanelTimeouts=new Map;function checkDiscardedTabsInPanelDebounced(panelId,delay){clearTimeout(checkDiscardedTabsInPanelTimeouts.get(panelId));let timeout=setTimeout(()=>{checkDiscardedTabsInPanel(panelId)},delay);checkDiscardedTabsInPanelTimeouts.set(panelId,timeout)}function checkDiscardedTabsInPanel(panelId){let panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel))return;let pinnedTabsLen=panel.pinnedTabs.length;if(panel.tabs.length===0&&pinnedTabsLen===0){panel.allDiscarded=!1,panel.reactive.allDiscarded=!1;return}let discarded=!0;if(pinnedTabsLen&&Settings.state.pinnedTabsPosition==="panel"&&panel.pinnedTabs.some(t=>!t.discarded)&&(discarded=!1),discarded){let startIndex=panel.startTabIndex,endIndex=panel.endTabIndex;for(let i=startIndex;i<=endIndex;i++){let tab=Tabs2.list[i];if(!tab)break;!tab.discarded&&discarded&&(discarded=!1)}}panel.allDiscarded=discarded,panel.reactive.allDiscarded=discarded}function recalcBookmarksPanels(){for(let panel of Sidebar.panels){if(!isBookmarksPanel(panel))continue;let rootFolder=Bookmarks.reactive.byId[panel.rootId],rootContent,count=0;!panel.rootId||panel.rootId===BKM_ROOT_ID||panel.rootId===NOID?(rootContent=Bookmarks.reactive.tree,count=Bookmarks.overallCount):(rootContent=Bookmarks.reactive.byId[panel.rootId]?.children||[],count=rootFolder?.len??0),panel.reactive.bookmarks=rootContent,panel.reactive.len=count}if(Sidebar.subPanels.bookmarks){let panel=Sidebar.subPanels.bookmarks,rootContent;if(!panel.rootId||panel.rootId===BKM_ROOT_ID||panel.rootId===NOID)rootContent=Bookmarks.reactive.tree;else if(panel.reactive.rootOffset>0){let folder=Bookmarks.reactive.byId[panel.rootId];if(folder)for(let i=panel.reactive.rootOffset;i--&&folder;){if(folder.parentId===BKM_ROOT_ID){folder=void 0;break}folder=Bookmarks.reactive.byId[folder.parentId]}rootContent=folder?.children??Bookmarks.reactive.tree}else rootContent=Bookmarks.reactive.byId[panel.rootId]?.children??[];panel.reactive.bookmarks=rootContent}}var panelsBoxEl;function setPanelsBoxEl(el){el&&(panelsBoxEl=el)}function setPanelEls(id,els2){let panel=Sidebar.panelsById[id];panel&&(panel.scrollEl=els2.scrollBox)}function setPanelScrollBox(id,scrollBoxComponent){let panel=Sidebar.panelsById[id];panel&&(panel.scrollComponent=scrollBoxComponent)}function updateBounds(){let panel=Sidebar.panelsById[Sidebar.activePanelId];if(!panel||!panelsBoxEl)return;let hostPanel;if(isTabsPanel(panel)&&Sidebar.subPanelType===2&&Sidebar.subPanels.bookmarks&&(hostPanel=panel,panel=Sidebar.subPanels.bookmarks),!panel.scrollEl||!panel.ready)return;let panelContentEl=panel.scrollComponent?.getScrollableBox();DnD.setActivePointer(panel.id),DnD.updatePointerLeftPosition(panelContentEl?.offsetLeft??0);let pb=panel.scrollEl.getBoundingClientRect(),bb=panelsBoxEl.getBoundingClientRect();if(Sidebar.panelsTop=bb.top,panel.topOffset=pb.top,panel.leftOffset=bb.left,panel.rightOffset=bb.right,panel.bottomOffset=pb.bottom,panel.scrollComponent){let firstChildEl=panel.scrollComponent.getScrollableBox()?.firstElementChild;firstChildEl?.offsetTop&&(panel.topOffset+=firstChildEl.offsetTop)}panel.type===1&&panel.viewMode==="tree"?panel.bounds=calcBookmarksTreeBounds(panel,hostPanel):panel.type===1&&panel.viewMode==="history"?panel.bounds=calcBookmarksHistoryBounds(panel):panel.type===2&&(panel.bounds=calcTabsBounds(panel))}function calcTabsBounds(panel){let result=[],th=Sidebar.tabHeight,tm=Sidebar.tabMargin;if(th===0)return result;let half=th>>1,marginA=Math.floor(tm/2),marginB=Math.ceil(tm/2),insideA=(half>>1)+marginB+2,insideB=(half>>1)+marginB-2,overallHeight=-marginA,tabs=Tabs2.list;if(panel?.filteredTabs){tabs=[];for(let rTab of panel.filteredTabs){let tab=Tabs2.byId[rTab.id];tab&&tabs.push(tab)}}for(let tab of tabs)tab.invisible||tab.pinned||tab.panelId===panel.id&&(result.push({type:1,id:tab.id,index:tab.index,in:!!Settings.state.tabsTree,lvl:tab.lvl,folded:tab.folded,parent:tab.parentId,start:overallHeight,top:overallHeight+insideA,center:overallHeight+marginA+half,bottom:overallHeight+marginA+half+insideB,end:overallHeight+th+tm}),overallHeight+=th+tm);return result}function calcBookmarksTreeBounds(panel,hostPanel){let result=[];if(!isBookmarksPanel(panel))return[];let expPanelId=hostPanel?.id||panel.id,expandedBookmarks2=Bookmarks.reactive.expanded[expPanelId]??{},margin=Sidebar.bookmarkMargin,marginA=Math.floor(margin/2),folderHeight=Sidebar.folderHeight,folderHalf=folderHeight>>1,folderQuarter=folderHalf>>1,bookmarkHeight=Sidebar.bookmarkHeight,bookmarkHalf=bookmarkHeight>>1,bookmarkQuarter=bookmarkHalf>>1,sepHeight=Sidebar.separatorHeight,sepHalf=sepHeight>>1,sepQuarter=sepHalf>>1,overallHeight=-marginA,lvl=0,height,half,quarter,walker=nodes=>{for(let i=0;i<nodes.length;i++){let n=nodes[i],isFolder=n.type==="folder";isFolder?(height=folderHeight,half=folderHalf,quarter=folderQuarter):n.type==="bookmark"?(height=bookmarkHeight,half=bookmarkHalf,quarter=bookmarkQuarter):(height=sepHeight,half=sepHalf,quarter=sepQuarter),result.push({type:2,id:n.id,index:n.index,lvl,in:isFolder,folded:!expandedBookmarks2[n.id],parent:n.parentId,start:overallHeight,top:overallHeight+marginA+quarter,center:overallHeight+marginA+half,bottom:overallHeight+marginA+half+quarter,end:overallHeight+height+margin}),overallHeight+=height+margin,n.children&&expandedBookmarks2[n.id]&&(lvl++,walker(n.children),lvl--)}};return walker(panel.reactive.filteredBookmarks??panel.reactive.bookmarks),result}function calcBookmarksHistoryBounds(panel){return isBookmarksPanel(panel)?panel.component?.getBounds()??[]:[]}function getPanelTooltip(panel){if(isTabsPanel(panel)){if(Settings.state.navTabsPanelMidClickAction==="rm_all")return panel.name+`
`+translate("nav.tabs_panel_tooltip_mid_rm_all");if(Settings.state.navTabsPanelMidClickAction==="rm_rmp")return panel.name+`
`+translate("nav.tabs_panel_tooltip_mid_rm_rmp");if(Settings.state.navTabsPanelMidClickAction==="rm_act_tab")return panel.name+`
`+translate("nav.tabs_panel_tooltip_mid_rm_act_tab");if(Settings.state.navTabsPanelMidClickAction==="discard")return panel.name+`
`+translate("nav.tabs_panel_tooltip_mid_discard");if(Settings.state.navTabsPanelMidClickAction==="hide")return panel.name+`
`+translate("nav.tabs_panel_tooltip_mid_hide");if(Settings.state.navTabsPanelMidClickAction==="bookmark")return panel.name+`
`+translate("nav.tabs_panel_tooltip_mid_bookmark");if(Settings.state.navTabsPanelMidClickAction==="bkm_rmp")return panel.name+`
`+translate("nav.tabs_panel_tooltip_mid_bkm_rmp");if(Settings.state.navTabsPanelMidClickAction==="convert")return panel.name+`
`+translate("nav.tabs_panel_tooltip_mid_convert");if(Settings.state.navTabsPanelMidClickAction==="conv_hide")return panel.name+`
`+translate("nav.tabs_panel_tooltip_mid_conv_hide")}return isBookmarksPanel(panel)&&Settings.state.navBookmarksPanelMidClickAction==="convert"?panel.name+`
`+translate("nav.bookmarks_panel_tooltip_mid_convert"):panel.name}function updatePanelsTooltips(){for(let panel of Sidebar.panels)panel.reactive.tooltip=getPanelTooltip(panel)}function recalcPanels(){let panels=[],index=0;Sidebar.hasTabs=!1,Sidebar.hasBookmarks=!1,Sidebar.hasHistory=!1;for(let id of Sidebar.reactive.nav){if(id.startsWith("sp-")||id.startsWith("sd-")||id==="settings"||id==="search"||id==="add_tp"||id==="create_snapshot"||id==="remute_audio_tabs"||id==="collapse"||id==="hdn")continue;let panel=Sidebar.panelsById[id];if(!panel){rmFromArray(Sidebar.reactive.nav,id);continue}panel.index=index++,panels.push(panel),Sidebar.hasTabs||(Sidebar.hasTabs=panel.type===2),Sidebar.hasBookmarks||(Sidebar.hasBookmarks=panel.type===1),Sidebar.hasHistory||(Sidebar.hasHistory=panel.type===4)}Sidebar.panels=panels}function getSidebarConfig(){let panels={};for(let id of Sidebar.reactive.nav){let panel=Sidebar.panelsById[id];panel&&(panels[id]=createPanelConfigFromPanel(panel))}return{panels,nav:cloneArray(Sidebar.reactive.nav)}}function saveSidebar(delay){return Store.set({sidebar:getSidebarConfig()},delay)}function moveNavItem(srcIndex,dstIndex){if(srcIndex===dstIndex)return;let targetId2=Sidebar.reactive.nav.splice(srcIndex,1)[0];if(targetId2===void 0)return;Sidebar.reactive.nav.splice(dstIndex,0,targetId2);let newSidebarConfig=getSidebarConfig();updateSidebar(newSidebarConfig),Sidebar.saveSidebar(500)}function createPanelFromConfig(config){let panelDefs;if(config.id===DEFAULT_CONTAINER_ID)panelDefs=TABS_PANEL_STATE;else if(config.type===2)panelDefs=TABS_PANEL_STATE;else if(config.type===1)panelDefs=BOOKMARKS_PANEL_STATE;else if(config.type===4)panelDefs=HISTORY_PANEL_STATE;else return null;let panel=recreateNormalizedObject(config,panelDefs);return panel.reactive.name=config.name,panel.reactive.color=config.color,panel.reactive.iconSVG=config.iconSVG,panel.reactive.iconIMG=config.iconIMG,isTabsPanel(panel)?(panel.reactive.newTabCtx=panel.newTabCtx,panel.reactive.newTabBtns=cloneArray(panel.newTabBtns)):isBookmarksPanel(panel)&&(panel.reactive.viewMode=panel.viewMode),reactFn6&&(panel.reactive=reactFn6(panel.reactive)),panel}function createPanelConfigFromPanel(srcPanel){if(srcPanel=cloneObject(srcPanel),isTabsPanel(srcPanel))return recreateNormalizedObject(srcPanel,TABS_PANEL_CONFIG);if(isBookmarksPanel(srcPanel))return recreateNormalizedObject(srcPanel,BOOKMARKS_PANEL_CONFIG);if(isHistoryPanel(srcPanel))return recreateNormalizedObject(srcPanel,HISTORY_PANEL_CONFIG);throw err("Sidebar: createPanelConfigFromPanel: Unknown panel type")}function updateSidebarInBg(newConfig){newConfig&&parseNav(newConfig)}function updateSidebarInSetup(newConfig){newConfig?.nav?.length||(newConfig=createDefaultSidebarConfig());let sidebar2=newConfig,panelConfigs=sidebar2?.panels?Object.values(sidebar2?.panels):[];sidebar2?.nav&&(Sidebar.reactive.nav=sidebar2.nav,Sidebar.nav=sidebar2.nav);let newPanelsMap={};for(let panelConfig of panelConfigs){let panel=createPanelFromConfig(panelConfig);if(panel){if(isTabsPanel(panel)){let newTabContainer=panel.newTabCtx?Containers.reactive.byId[panel.newTabCtx]:null;panel.newTabCtx!==DEFAULT_CONTAINER_ID&&!newTabContainer&&(panel.newTabCtx="none")}newPanelsMap[panel.id]=panel}}Sidebar.panelsById=newPanelsMap,recalcPanels(),Tabs2.recalcMoveRules()}async function updateSidebar(newConfig){if(!newConfig||!Sidebar.ready)return;let panelConfigs=Object.values(newConfig.panels),newPanelsMap={},oldNavItems=Sidebar.reactive.nav;Sidebar.reactive.nav=newConfig.nav,Sidebar.nav=newConfig.nav;let prevHasTabsPanels=Sidebar.hasTabs,prevHasBookmarksPanels=Sidebar.hasBookmarks,prevHasHistoryPanel=Sidebar.hasHistory,tabsSaveNeeded=!1,tabsPanelId,existedPanelId,webReqHandlerNeeded=!1;for(let panelConfig of panelConfigs){let panel=Sidebar.panelsById[panelConfig.id];if(panel){Object.assign(panel,panelConfig);let r=panel.reactive;r.name=panel.name,r.color=panel.color,r.iconSVG=panel.iconSVG,r.iconIMG=panel.iconIMG,isTabsPanel(panel)?(panel.reactive.newTabCtx=panel.newTabCtx,panel.reactive.newTabBtns=cloneArray(panel.newTabBtns)):isBookmarksPanel(panel)&&(panel.reactive.viewMode=panel.viewMode)}else{let newPanel=createPanelFromConfig(panelConfig);if(!newPanel)throw err("Sidebar.updateSidebar: Cannot create new panel");panel=newPanel,Sidebar.panelsById[panel.id]=panel}if(newPanelsMap[panel.id]=panel,isTabsPanel(panel)){let newTabContainer=panel.newTabCtx?Containers.reactive.byId[panel.newTabCtx]:null;panel.newTabCtx!==DEFAULT_CONTAINER_ID&&!newTabContainer&&(panel.newTabCtx="none"),!webReqHandlerNeeded&&Settings.state.newTabCtxReopen&&panel.newTabCtx!=="none"&&Containers.reactive.byId[panel.newTabCtx]&&(webReqHandlerNeeded=!0)}!tabsPanelId&&panel.type===2&&(tabsPanelId=panel.id),existedPanelId||(existedPanelId=panel.id),panel.reactive.tooltip=getPanelTooltip(panel)}for(let index=0;index<oldNavItems.length;index++){let panelId=oldNavItems[index];if(!panelId)continue;let panel=Sidebar.panelsById[panelId];if(panel){if(newPanelsMap[panel.id])panel.type===2&&(tabsPanelId=panel.id),existedPanelId=panel.id;else if(delete Sidebar.panelsById[panel.id],isTabsPanel(panel)){let firstTabsPanel=Sidebar.panels.find(p=>isTabsPanel(p)&&p.id!==panel.id),nearTabsPanelId=findNear(oldNavItems,index,id=>isTabsPanel(Sidebar.panelsById[id]));for(let tab of Tabs2.list)tab.pinned&&tab.panelId===panel.id&&(tab.panelId=firstTabsPanel?.id??NOID,tabsSaveNeeded=!0),!tab.pinned&&tab.panelId===panel.id&&(tab.panelId=nearTabsPanelId??NOID,tabsSaveNeeded=!0)}}}if(recalcPanels(),Tabs2.recalcMoveRules(),Settings.state.updateSidebarTitle&&updateSidebarTitle(),!prevHasTabsPanels&&Sidebar.hasTabs?Tabs2.load():prevHasTabsPanels&&!Sidebar.hasTabs&&Tabs2.unload(),!prevHasBookmarksPanels&&Sidebar.hasBookmarks?Bookmarks.load():prevHasBookmarksPanels&&!Sidebar.hasBookmarks&&Bookmarks.unload(),!prevHasHistoryPanel&&Sidebar.hasHistory?History.load():prevHasHistoryPanel&&!Sidebar.hasHistory&&History.unload(),Sidebar.hasTabs){let moves=[],tabIndex=Tabs2.list.findIndex(t=>!t.pinned);tabIndex===-1&&(tabIndex=0);for(let panel of Sidebar.panels){if(panel.type!==2)continue;let panelTabs=Tabs2.list.filter(t=>!t.pinned&&t.panelId===panel.id);for(let tab of panelTabs)tab.index!==tabIndex&&moves.push([tab,tabIndex]),tabIndex++}if(moves.length){tabsSaveNeeded=!0,Tabs2.ignoreTabsEvents=!0;let moving=[];for(let move3 of moves){let tab=move3[0];if(tab.index!==move3[1]){moving.push(browser.tabs.move(tab.id,{index:move3[1]})),Tabs2.list.splice(tab.index,1),Tabs2.list.splice(move3[1],0,tab);let minIndex=Math.min(tab.index,move3[1]),maxIndex=Math.max(tab.index,move3[1])+1;for(let i=minIndex;i<maxIndex;i++){let t=Tabs2.list[i];t&&(t.index=i)}}}await Promise.all(moving),Tabs2.ignoreTabsEvents=!1}recalcTabsPanels(),recalcVisibleTabs(),tabsSaveNeeded&&(Tabs2.list.forEach(t=>Tabs2.saveTabData(t.id)),Tabs2.cacheTabsData())}if(Sidebar.hasBookmarks&&recalcBookmarksPanels(),!Sidebar.panelsById[Sidebar.activePanelId]){if(Sidebar.hasTabs&&Tabs2.byId[Tabs2.activeId]){let activeTab=Tabs2.byId[Tabs2.activeId];if(activeTab){let targetPanelId=activeTab.panelId;Sidebar.panelsById[targetPanelId]&&Sidebar.activatePanel(targetPanelId)}}if(!Sidebar.panelsById[Sidebar.activePanelId]){let firstPanel=Sidebar.panels[0];firstPanel&&Sidebar.activatePanel(firstPanel.id)}Sidebar.saveActivePanel()}webReqHandlerNeeded?turnOnBeforeRequestHandler():turnOffBeforeRequestHandler()}function activatePanel(panelId,loadPanels2=!0,keepSearching){if(Sidebar.activePanelId===panelId)return;let prevPanel=Sidebar.panelsById[Sidebar.activePanelId],panel=Sidebar.panelsById[panelId];if(!panel)return;let loading;loadPanels2&&!panel.ready&&(panel.type===2&&(loading=Tabs2.load()),panel.type===1&&(loading=Bookmarks.load()),panel.type===4&&(loading=History.load())),prevPanel&&(Sidebar.lastActivePanelId=Sidebar.activePanelId),Sidebar.reactive.activePanelId=Sidebar.activePanelId=panelId,Search.rawValue&&prevPanel&&(keepSearching||Settings.state.searchPanelSwitch==="any"||Settings.state.searchPanelSwitch==="same_type"&&prevPanel.type===panel.type||Search.rawValue.startsWith(". ")?loading?loading.then(()=>Search.search()):Search.search():Search.stop()),isTabsPanel(prevPanel)&&(Sidebar.lastTabsPanelId=prevPanel.id),isHistoryPanel(prevPanel)&&History.unloadAfter(3e4),DnD.reactive.isStarted&&(DnD.reactive.dstPanelId=panelId),Settings.state.updateSidebarTitle&&Sidebar.updateSidebarTitle(0),!DnD.reactive.isStarted&&!Search.rawValue&&saveActivePanelDebounced(1e3),Sidebar.subPanelActive&&Sidebar.closeSubPanel(),Sidebar.switchOnMouseLeave&&(Sidebar.switchOnMouseLeave=!1),panel.hidden&&!Sidebar.reactive.hiddenPanelsPopup&&Sidebar.showPanel(panelId),Settings.updateWinPrefaceOnPanelSwitch&&Windows.updWindowPreface()}var prevSavedActPanelId=NOID;function saveActivePanel(){Windows.incognito||prevSavedActPanelId===Sidebar.activePanelId||(prevSavedActPanelId=Sidebar.activePanelId,browser.sessions.setWindowValue(Windows.id,"activePanelId",Sidebar.activePanelId))}var saveActivePanelDebounced=debounce(saveActivePanel),updatePanelBoundsTimeout;function updatePanelBoundsDebounced(delay=256){clearTimeout(updatePanelBoundsTimeout),updatePanelBoundsTimeout=setTimeout(()=>updateBounds(),delay)}function switchToPanel(id,withoutTabActivation,withoutTabCreation){Menu.close(),DnD.reactive.isStarted||Selection.resetSelection(),Sidebar.activatePanel(id);let panel=Sidebar.panelsById[id];if(!withoutTabCreation&&isTabsPanel(panel)&&(panel.noEmpty||Settings.state.hideInact||Settings.state.hideEmptyPanels)&&!panel.tabs.length&&!panel.pinnedTabs.length&&Tabs2.createTabInPanel(panel),isTabsPanel(panel)&&Settings.state.activateLastTabOnPanelSwitching&&!withoutTabActivation&&!Search.reactive.value){let actTab=Tabs2.byId[Tabs2.activeId];actTab&&(!actTab.pinned||Settings.state.pinnedTabsPosition==="panel")&&Tabs2.activateLastActiveTabOf(id)}DnD.reactive.isStarted&&updatePanelBoundsDebounced()}function switchToNeighbourPanel(){let target,activePanel=Sidebar.panelsById[Sidebar.activePanelId];if(activePanel||(activePanel=Sidebar.panels[0]),!target)for(let i=activePanel.index-1;i>0;i--){let panel=Sidebar.panels[i];if(panel){if(panel.hidden||isTabsPanel(panel)&&(Settings.state.hideEmptyPanels&&!panel.reactive.len||Settings.state.hideDiscardedTabPanels&&panel.allDiscarded))continue;target=Sidebar.panels[i];break}}if(!target)for(let i=activePanel.index+1;i<Sidebar.panels.length;i++){let panel=Sidebar.panels[i];if(panel){if(panel.hidden||isTabsPanel(panel)&&(Settings.state.hideEmptyPanels&&!panel.reactive.len||Settings.state.hideDiscardedTabPanels&&panel.allDiscarded))continue;target=Sidebar.panels[i];break}}target&&switchToPanel(target.id)}var switchPanelPaused=!1,switchPanelPause=debounce(()=>{switchPanelPaused=!1});function switchPanel(dir,ignoreHidden,withoutTabCreation,restartDebouncer){let delay=Settings.state.navSwitchPanelsDelay??128;if(switchPanelPaused){restartDebouncer&&switchPanelPause(delay);return}delay>0&&(switchPanelPause(delay),switchPanelPaused=!0),Menu.close(),Selection.resetSelection();let activePanelId=Sidebar.activePanelId,activePanel=Sidebar.panelsById[activePanelId];if(!activePanel){activePanel=Sidebar.panelsById[Sidebar.lastActivePanelId],activePanel||(activePanel=Sidebar.panels[0]),activePanel&&(Sidebar.reactive.activePanelId=Sidebar.activePanelId=activePanel.id,Settings.updateWinPrefaceOnPanelSwitch&&Windows.updWindowPreface());return}let hiddenPanelsPopupIsShown=Sidebar.reactive.hiddenPanelsPopup,visiblePanels=[],hiddenPanels=[],isInline=Settings.state.navBarLayout==="horizontal"&&Settings.state.navBarInline,hdnIndex=-1,actIndex=-1,actIsHidden=!1,newActIsHidden=!1;for(let id of Sidebar.nav){if(id==="hdn"){hdnIndex=visiblePanels.length;continue}let panel2=Sidebar.panelsById[id];if(!panel2)continue;let isTabsPanel2=isTabsPanel(panel2);panel2.hidden||isTabsPanel2&&Settings.state.hideEmptyPanels&&!panel2.reactive.len||isTabsPanel2&&Settings.state.hideDiscardedTabPanels&&panel2.allDiscarded?(hiddenPanels.push(panel2),panel2.id===activePanelId&&(actIndex=hiddenPanels.length-1,actIsHidden=!0)):(visiblePanels.push(panel2),panel2.id===activePanelId&&(actIndex=visiblePanels.length-1))}if(actIndex===-1)return;(hdnIndex===-1||isInline)&&(hdnIndex=visiblePanels.length);let panel;if(actIsHidden)for(let i=actIndex+dir;i>=0||i<hiddenPanels.length;i+=dir){if(panel=hiddenPanels[i],newActIsHidden=!0,!panel){if(visiblePanels.length){if(panel=visiblePanels[dir>0?hdnIndex:hdnIndex-1],!panel)break;hiddenPanelsPopupIsShown&&(Sidebar.reactive.hiddenPanelsPopup=!1),newActIsHidden=!1}break}if(!panel.skipOnSwitching)break}else for(let i=actIndex+dir;i>=0||i<visiblePanels.length;i+=dir){if(panel=visiblePanels[i],newActIsHidden=!1,dir>0&&i===hdnIndex||dir<0&&i+1===hdnIndex){hiddenPanels.length&&!ignoreHidden&&(Sidebar.openHiddenPanelsPopup(),dir>0?panel=hiddenPanels[0]:panel=hiddenPanels[hiddenPanels.length-1],newActIsHidden=!0);break}if(!panel)break;if(!panel.skipOnSwitching)break}newActIsHidden&&!hiddenPanelsPopupIsShown&&!ignoreHidden&&Sidebar.openHiddenPanelsPopup(),panel&&switchToPanel(panel.id,!1,withoutTabCreation)}function selectPanel(dir){let isSelected=!1,selPanelId;if(Selection.isNavItem()){let firstSelId=Selection.get()[0];Sidebar.panelsById[firstSelId]&&(selPanelId=firstSelId,isSelected=!0)}if((selPanelId===void 0||!Sidebar.panelsById[selPanelId])&&(selPanelId=Sidebar.activePanelId),!Sidebar.panelsById[selPanelId])return;Menu.close(),Selection.resetSelection();let hiddenPanelsPopupIsShown=Sidebar.reactive.hiddenPanelsPopup,visiblePanels=[],hiddenPanels=[],isInline=Settings.state.navBarLayout==="horizontal"&&Settings.state.navBarInline,hdnIndex=-1,actIndex=-1,actIsHidden=!1,newActIsHidden=!1;for(let id of Sidebar.nav){if(id==="hdn"){hdnIndex=visiblePanels.length;continue}let panel2=Sidebar.panelsById[id];if(!panel2)continue;let isTabsPanel2=isTabsPanel(panel2);panel2.hidden||isTabsPanel2&&Settings.state.hideEmptyPanels&&!panel2.reactive.len||isTabsPanel2&&Settings.state.hideDiscardedTabPanels&&panel2.allDiscarded?(hiddenPanels.push(panel2),panel2.id===selPanelId&&(actIndex=hiddenPanels.length-1,actIsHidden=!0)):(visiblePanels.push(panel2),panel2.id===selPanelId&&(actIndex=visiblePanels.length-1))}if(actIndex===-1)return;(hdnIndex===-1||isInline)&&(hdnIndex=visiblePanels.length);let panel;if(actIsHidden)for(let i=actIndex+dir;i>=0||i<hiddenPanels.length;i+=dir){if(panel=hiddenPanels[i],newActIsHidden=!0,!panel){if(visiblePanels.length){if(panel=visiblePanels[dir>0?hdnIndex:hdnIndex-1],!panel)break;hiddenPanelsPopupIsShown&&(Sidebar.reactive.hiddenPanelsPopup=!1),newActIsHidden=!1}break}break}else for(let i=actIndex+dir;i>=0||i<visiblePanels.length;i+=dir){if(panel=visiblePanels[i],newActIsHidden=!1,dir>0&&i===hdnIndex||dir<0&&i+1===hdnIndex){hiddenPanels.length&&(Sidebar.openHiddenPanelsPopup(),dir>0?panel=hiddenPanels[0]:panel=hiddenPanels[hiddenPanels.length-1],newActIsHidden=!0);break}if(!panel)break;break}if(newActIsHidden&&!hiddenPanelsPopupIsShown&&Sidebar.openHiddenPanelsPopup(),!panel){Selection.selectNavItem(selPanelId);return}Selection.selectNavItem(panel.id)}function openHiddenPanelsPopup(){let hiddenPanelsBtnEl=document.getElementById("hidden_panels_btn"),navBarEl=document.getElementById("nav_bar");if(!hiddenPanelsBtnEl||!navBarEl){Sidebar.reactive.hiddenPanelsPopupOffset=3,Sidebar.reactive.hiddenPanelsPopupOffsetSide="start",Sidebar.reactive.hiddenPanelsPopup=!0;return}let navRect=navBarEl.getBoundingClientRect(),btnRect=hiddenPanelsBtnEl.getBoundingClientRect();if(Settings.state.navBarLayout==="horizontal"){let relLeft=btnRect.left-navRect.left;if(relLeft<navRect.width/2)relLeft===0&&(relLeft=1),Sidebar.width<200&&(relLeft/=2),Sidebar.reactive.hiddenPanelsPopupOffset=relLeft,Sidebar.reactive.hiddenPanelsPopupOffsetSide="start";else{let right=Sidebar.width-(relLeft+btnRect.width);right===0&&(right=1),Sidebar.width<200&&(right=right/2+1),Sidebar.reactive.hiddenPanelsPopupOffset=right,Sidebar.reactive.hiddenPanelsPopupOffsetSide="end"}}else if(Settings.state.navBarLayout==="vertical"){let relTop=btnRect.top-navRect.top;relTop<navRect.height/2?(Sidebar.reactive.hiddenPanelsPopupOffset=relTop,Sidebar.reactive.hiddenPanelsPopupOffsetSide="start"):(Sidebar.reactive.hiddenPanelsPopupOffset=navRect.height-(btnRect.bottom-navRect.top),Sidebar.reactive.hiddenPanelsPopupOffsetSide="end")}Sidebar.reactive.hiddenPanelsPopup=!0}function closeHiddenPanelsPopup(withoutTabCreation){Sidebar.reactive.hiddenPanelsPopup=!1;let panel=Sidebar.panelsById[Sidebar.activePanelId];!withoutTabCreation&&isTabsPanel(panel)&&(panel.noEmpty||Settings.state.hideInact||Settings.state.hideEmptyPanels)&&!panel.tabs.length&&!panel.pinnedTabs.length&&Tabs2.createTabInPanel(panel),panel?.hidden&&Sidebar.showPanel(panel.id)}function goToActiveTabPanel(){let activeTab=Tabs2.byId[Tabs2.activeId];if(activeTab||(activeTab=Tabs2.list.find(t=>t.active)),!activeTab)return;Sidebar.panelsById[activeTab.panelId]&&switchToPanel(activeTab.panelId)}function getActivePanelConfig(){let panel=Sidebar.panelsById[Sidebar.activePanelId];if(!panel)throw err("Sidebar: getActivePanelConfig: Active panel not found");let defaults;if(isTabsPanel(panel)?defaults=TABS_PANEL_CONFIG:isBookmarksPanel(panel)?defaults=BOOKMARKS_PANEL_CONFIG:isHistoryPanel(panel)&&(defaults=HISTORY_PANEL_CONFIG),!!defaults)return cloneObject(recreateNormalizedObject(panel,defaults))}async function askHowRemoveTabsPanel(panelId){let panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel))return null;let note;Windows.otherWindows.length&&(note=translate("popup.tabs_panel_removing.other_win_note"));let conf={title:translate("popup.tabs_panel_removing.title"),note,buttons:[{value:"close",label:translate("popup.tabs_panel_removing.close")},{value:"cancel",label:translate("btn.cancel"),warn:!0}]};return panel.bookmarksFolderId===BKM_OTHER_ID||panel.bookmarksFolderId===BKM_MENU_ID||panel.bookmarksFolderId===BKM_MOBILE_ID||panel.bookmarksFolderId===BKM_TLBR_ID||conf.buttons.unshift({value:"save",label:translate("popup.tabs_panel_removing.save")}),!!Sidebar.panels.find(p=>p.type===2&&panelId!==p.id)?conf.buttons.unshift({value:"attach",label:translate("popup.tabs_panel_removing.attach")}):conf.buttons.unshift({value:"leave",label:translate("popup.tabs_panel_removing.leave")}),ask(conf)}function attachPanelTabsToNeighbourPanel(panel){let index=Sidebar.reactive.nav.indexOf(panel.id),firstPanelId=Sidebar.reactive.nav.find(id=>isTabsPanel(Sidebar.panelsById[id])&&id!==panel.id),nearPanelId=findNear(Sidebar.reactive.nav,index,v=>isTabsPanel(Sidebar.panelsById[v]));for(let tab of Tabs2.list)tab.pinned&&tab.panelId===panel.id&&(tab.panelId=firstPanelId??NOID),!tab.pinned&&tab.panelId===panel.id&&(tab.panelId=nearPanelId??NOID);return nearPanelId}function hidePanel(panelId){let panel=Sidebar.panelsById[panelId];if(panel){if(panelId===Sidebar.activePanelId){let actTab=Tabs2.byId[Tabs2.activeId],actTabPanel=Sidebar.panelsById[actTab?.panelId??NOID];actTab&&(!actTab.pinned||Settings.state.pinnedTabsPosition==="panel")&&actTab.panelId!==panelId&&isTabsPanel(actTabPanel)&&!actTabPanel.hidden&&(!Settings.state.hideEmptyPanels||actTabPanel.reactive.len)&&(!Settings.state.hideDiscardedTabPanels||!actTabPanel.allDiscarded)?Sidebar.switchToPanel(actTab.panelId):Sidebar.switchToNeighbourPanel()}panel.hidden=!0,panel.reactive.hidden=!0,Sidebar.saveHiddenPanels()}}function showPanel(panelId){let panel=Sidebar.panelsById[panelId];panel&&(panel.hidden=!1,panel.reactive.hidden=!1,Sidebar.saveHiddenPanels())}function saveHiddenPanels(){let hiddenPanels=[];for(let panel of Sidebar.panels)panel.hidden&&hiddenPanels.push(panel.id);browser.sessions.setWindowValue(Windows.id,"hiddenPanels",hiddenPanels)}async function removePanel(panelId,conf){let panel=Sidebar.panelsById[panelId];if(!panel)return;conf||(conf={});let index=Sidebar.reactive.nav.indexOf(panelId),tabsSaveNeeded=!1,newPanelIdForTabs;if(isTabsPanel(panel)&&panel.tabs.length){if(tabsSaveNeeded=!0,conf.tabsMode||(conf.tabsMode=await askHowRemoveTabsPanel(panel.id)),conf.tabsMode==="attach")newPanelIdForTabs=attachPanelTabsToNeighbourPanel(panel);else if(conf.tabsMode==="save"){let tabsIds=panel.tabs.map(t=>t.id);await Sidebar.bookmarkTabsPanel(panel.id,!0,!0),await Tabs2.removeTabs(tabsIds,!0)}else if(conf.tabsMode==="close"){let tabsIds=panel.tabs.map(t=>t.id);await Tabs2.removeTabs(tabsIds,!0)}else return;if(!await Tabs2.isRemovingFinished())return warn("Sidebar.removePanel: Panel is not empty")}if(panel.id===Sidebar.activePanelId){let nextActivePanelId;newPanelIdForTabs&&Sidebar.panelsById[newPanelIdForTabs]?nextActivePanelId=newPanelIdForTabs:Sidebar.lastActivePanelId!==panel.id?nextActivePanelId=Sidebar.lastActivePanelId:nextActivePanelId=findNear(Sidebar.reactive.nav,index,id=>!!Sidebar.panelsById[id]),nextActivePanelId!==void 0&&(Sidebar.activatePanel(nextActivePanelId),saveActivePanel())}rmFromArray(Sidebar.reactive.nav,panelId),delete Sidebar.panelsById[panelId],recalcPanels(),isTabsPanel(panel)&&(recalcTabsPanels(),newPanelIdForTabs&&recalcVisibleTabs(newPanelIdForTabs)),isTabsPanel(panel)&&!Sidebar.hasTabs&&Tabs2.unload(),isBookmarksPanel(panel)&&!Sidebar.hasBookmarks&&Bookmarks.unload(),isHistoryPanel(panel)&&!Sidebar.hasHistory&&History.unload(),tabsSaveNeeded&&(Tabs2.list.forEach(t=>Tabs2.saveTabData(t.id)),Tabs2.cacheTabsData()),saveSidebar(120)}function getPanelAutoName(type){let len=Sidebar.panels.length;if(type===2)return`${translate("panel.tabs.title")}-${len}`;if(type===1)return`${translate("panel.bookmarks.title")}-${len}`}function createTabsPanel(conf){let panel=cloneObject(TABS_PANEL_STATE);return conf&&updateObject(panel,conf,conf),panel.id=uid(),panel.name||(panel.name=translate("panel.tabs.title")),panel.reactive.name=panel.name,panel.reactive.color=panel.color,panel.reactive.iconSVG=panel.iconSVG,panel.reactive.iconIMG=panel.iconIMG,panel.reactive.newTabCtx=panel.newTabCtx,panel.reactive.newTabBtns=cloneArray(panel.newTabBtns),panel.reactive.tooltip=Sidebar.getPanelTooltip(panel),reactFn6&&(panel.reactive=reactFn6(panel.reactive)),panel}function getIndexForNewTabsPanel(){let activePanel=Sidebar.panelsById[Sidebar.activePanelId],index=-1;return isTabsPanel(activePanel)?index=activePanel.index:(index=findLastIndex(Sidebar.reactive.nav,id=>isTabsPanel(Sidebar.panelsById[id])),index===-1&&activePanel&&(index=activePanel.index)),index++,index}function createBookmarksPanel(conf){let panel=cloneObject(BOOKMARKS_PANEL_STATE);return conf&&updateObject(panel,conf,conf),panel.id||(panel.id=uid()),panel.name||(panel.name=translate("panel.bookmarks.title")),panel.rootId||(panel.rootId=BKM_ROOT_ID),panel.reactive.name=panel.name,panel.reactive.color=panel.color,panel.reactive.iconSVG=panel.iconSVG,panel.reactive.iconIMG=panel.iconIMG,panel.reactive.viewMode=panel.viewMode,reactFn6&&(panel.reactive=reactFn6(panel.reactive)),panel}function createHistoryPanel(){let panel=cloneObject(HISTORY_PANEL_STATE);return panel.reactive.name=panel.name,panel.reactive.color=panel.color,panel.reactive.iconSVG=panel.iconSVG,panel.reactive.iconIMG=panel.iconIMG,reactFn6&&(panel.reactive=reactFn6(panel.reactive)),panel}function addPanel(index,panel,replace){if(replace){let replaceableId=Sidebar.reactive.nav[index];replaceableId!==void 0&&(Sidebar.activePanelId===replaceableId&&(Sidebar.reactive.activePanelId=Sidebar.activePanelId=panel.id,Sidebar.lastActivePanelId=panel.id,Settings.updateWinPrefaceOnPanelSwitch&&Windows.updWindowPreface()),delete Sidebar.panelsById[replaceableId]),Sidebar.panelsById[panel.id]=panel,Sidebar.reactive.nav[index]=panel.id}else Sidebar.panelsById[panel.id]=panel,Sidebar.reactive.nav.splice(index,0,panel.id);return Sidebar.panelsById[panel.id]}function unloadPanelType(type){if(Sidebar.panelsById[Sidebar.activePanelId]?.type===type){let nextPanel=Sidebar.panels.find(p=>p.ready&&p.type!==type);if(nextPanel)switchToPanel(nextPanel.id);else return}type===1?Bookmarks.unload():type===4&&History.unload()}async function bookmarkTabsPanel(panelId,update=!1,silent,parentFolderId){let panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel)||!Permissions.reactive.bookmarks&&!await Permissions.request("bookmarks"))return;Bookmarks.reactive.tree.length||await Bookmarks.load();let oldFolderId=panel.bookmarksFolderId,oldFolder=Bookmarks.reactive.byId[oldFolderId],parentId=parentFolderId??oldFolder?.parentId,parent=Bookmarks.reactive.byId[parentId??NOID],isTopLvl=parentId===BKM_ROOT_ID,index=oldFolder?.index??-1,folderName=panel.name;if(!parent&&!(update&&oldFolder&&isTopLvl)){let defaultFolderId=oldFolder?.id??BKM_OTHER_ID,result=await Bookmarks.openBookmarksPopup({title:translate("popup.bookmarks.save_in_bookmarks"),name:folderName,nameField:!0,location:defaultFolderId,locationField:!0,locationTree:!1,recentLocations:!0,controls:[{label:"btn.save"}],validate:popupState=>{let ctrl=popupState.controls?.[0];ctrl&&(popupState.location===oldFolderId?ctrl.label="btn.update":ctrl.label="btn.save")}});if(!result?.location||result?.location===NOID)throw 2;parentId=result.location??NOID,parent=Bookmarks.reactive.byId[parentId],parent&&oldFolder&&parent?.id===oldFolderId&&(parentId=oldFolder.parentId,parent=Bookmarks.reactive.byId[parentId??NOID],update=!0,index=oldFolder.index),isTopLvl=parentId===BKM_ROOT_ID,result.name&&(folderName=result.name.trim())}if(!parent&&!isTopLvl)throw 2;index===-1&&parent&&(index=parent.children?.length??0);let progress2;!silent&&panel.tabs.length>5&&(progress2=Notifications.progress({icon:"#icon_bookmarks",title:translate("notif.tabs_panel_saving_bookmarks"),details:panel.name+" panel"}));let panelFolder;if(oldFolder){panelFolder=oldFolder;try{await browser.bookmarks.update(panelFolder.id,{title:folderName})}catch(err3){if(!silent){err("Sidebar.bookmarkTabsPanel: Cannot update panel folder");let title=translate("notif.tabs_panel_to_bookmarks_err"),details=translate("notif.tabs_panel_to_bookmarks_err.folder_upd");Notifications.err(title,details)}throw err3}}else{if(!parent)throw 2;let parentConf={title:folderName,index,parentId:parent.id};try{panelFolder=await browser.bookmarks.create(parentConf)}catch(err3){if(!silent){err("Sidebar.bookmarkTabsPanel: Cannot create panel folder");let title=translate("notif.tabs_panel_to_bookmarks_err"),details=translate("notif.tabs_panel_to_bookmarks_err.folder");Notifications.err(title,details)}throw err3}}let panelFolderId=panelFolder.id,items=[],dst={parentId:panelFolderId},idsMap={};if(Settings.state.pinnedTabsPosition==="panel"&&panel.pinnedTabs.length){for(let rTab of panel.pinnedTabs){let tab=Tabs2.byId[rTab.id];if(!tab)continue;let info2={id:tab.id,pinned:!0,title:tab.customTitle??tab.title,url:tab.url,parentId:tab.parentId};Containers.reactive.byId[tab.cookieStoreId]&&(info2.container=tab.cookieStoreId),tab.customColor&&(info2.customColor=tab.customColor),items.push(info2)}items.push({id:"separator"})}for(let tab of panel.tabs){let info2={id:tab.id,title:tab.customTitle??tab.title,url:tab.url,parentId:tab.parentId,folded:tab.folded};Containers.reactive.byId[tab.cookieStoreId]&&(info2.container=tab.cookieStoreId),tab.customColor&&(info2.customColor=tab.customColor),items.push(info2)}if(items.length)try{await Bookmarks.saveToFolder(items,dst,!1,progress2,idsMap)}catch(err3){if(!silent){err("Tabs.bookmarkTabsPanel: Cannot save bookmarks",err3);let title=translate("notif.tabs_panel_to_bookmarks_err"),details=translate("notif.tabs_panel_to_bookmarks_err.bookmarks");Notifications.err(title,details)}throw err3}for(let tabId of Object.keys(idsMap)){let tab=Tabs2.byId[tabId];if(!tab||!tab.isParent)continue;let bookmarkId=idsMap[tabId];if(bookmarkId===void 0)continue;let bookmark=Bookmarks.reactive.byId[bookmarkId];bookmark&&(tab.folded?Bookmarks.foldBookmark(bookmark.id,panel.id):Bookmarks.expandBookmark(bookmark.id,panel.id,!0,!0))}panel.bookmarksFolderId!==panelFolderId&&(panel.bookmarksFolderId=panelFolderId,Sidebar.saveSidebar(300)),silent||(progress2&&Notifications.finishProgress(progress2,120),await sleep(250),Notifications.notify({icon:"#icon_bookmarks",title:translate("notif.panel_bkmrkd")}))}function setViewMode(panel,mode){panel.viewMode=mode,panel.reactive.viewMode=mode,Sidebar.saveSidebar(300)}async function restoreFromBookmarks(panel,silent){if(!Permissions.bookmarks&&!await Permissions.request("bookmarks"))return;Bookmarks.reactive.tree.length||await Bookmarks.load();let panelFolder=Bookmarks.reactive.byId[panel.bookmarksFolderId];if(!panelFolder){let result=await Bookmarks.openBookmarksPopup({title:translate("popup.bookmarks.restore"),location:BKM_OTHER_ID,locationField:!0,locationTree:!1,recentLocations:!0,controls:[{label:"btn.restore"}]});if(!result?.location||result?.location===NOID)throw 2;panelFolder=Bookmarks.reactive.byId[result.location]}if(!panelFolder){let title=translate("notif.restore_from_bookmarks_err"),details=translate("notif.restore_from_bookmarks_err.root");throw Notifications.err(title,details),warn("Restoring panel from bookmarks: Root folder not found")}if(!panelFolder.children?.length)throw warn("Restoring panel from bookmarks: Root folder is empty");let existedNormalTabs=[...panel.tabs],existedPinnedTabs=[...panel.pinnedTabs],idsMap={},reusedTabs={},usedAsParent={},index=panel.startTabIndex,indexPinned=0;for(let node of Bookmarks.listBookmarks(panelFolder.children)){if(usedAsParent[node.id]||node.type==="separator")continue;let info2={id:node.id,title:node.title,parentId:node.parentId},rawUrl=node.url,lvl=0,parent=Bookmarks.reactive.byId[node.parentId];for(;parent&&parent.id!==panelFolder.id;)parent=Bookmarks.reactive.byId[parent.parentId],lvl++;if(!node.url&&node.children){let firstChild=node.children[0];if(Bookmarks.isFolderWithURL(node))rawUrl=firstChild.url,info2.url=normalizeUrl(firstChild.url,node.title),info2.title=firstChild.title,usedAsParent[firstChild.id]=!0;else{let titleExec=FOLDER_NAME_DATA_RE.exec(node.title);info2.url=createGroupUrl(titleExec?titleExec[1]:node.title),rawUrl=info2.url}}else info2.url=normalizeUrl(node.url,node.title);Bookmarks.extractTabInfoFromTitle(info2);let isPinned=info2.pinned,existedTab=(isPinned?existedPinnedTabs:existedNormalTabs).find(t=>(t.url===rawUrl||t.url===info2.url)&&t.title===info2.title&&!reusedTabs[t.id]);if(isPinned){if(existedTab)continue;let conf={index:indexPinned,url:info2.url,pinned:!0,windowId:Windows.id,active:!1,cookieStoreId:info2.container};if(Tabs2.setNewTabPosition(indexPinned,NOID,panel.id,!1),info2.url){let containerId=Containers.getContainerFor(info2.url);containerId&&(conf.cookieStoreId=containerId)}let newNativeTab=await browser.tabs.create(conf);if(idsMap[info2.id]=newNativeTab.id,indexPinned++,index++,info2.customColor){let newTab=Tabs2.byId[newNativeTab.id];newTab&&(newTab.reactive.customColor=newTab.customColor=info2.customColor)}continue}if(existedTab){if(reusedTabs[existedTab.id]=existedTab,info2.id=existedTab.id,index!==existedTab.index||lvl!==existedTab.lvl){let sameIndexTab=Tabs2.list[index];for(;sameIndexTab&&sameIndexTab.lvl>lvl;)sameIndexTab=Tabs2.list[++index];let toMove=Tabs2.getBranch(existedTab),src={panelId:panel.id,windowId:Windows.id},dst={windowId:Windows.id,index,panelId:panel.id,parentId:idsMap[info2.parentId??NOID]??NOID};await Tabs2.move(toMove,src,dst)}idsMap[node.id]=existedTab.id}else{let sameIndexTab=Tabs2.list[index];for(;sameIndexTab&&sameIndexTab.lvl>lvl;)sameIndexTab=Tabs2.list[++index];let conf={index,url:info2.url,windowId:Windows.id,active:!1,cookieStoreId:info2.container};if(info2.url){let containerId=Containers.getContainerFor(info2.url);containerId&&(conf.cookieStoreId=containerId)}let parentId=idsMap[info2.parentId??NOID]??NOID;conf.url&&!conf.url.startsWith("about")&&(conf.discarded=!0,conf.title=info2.title),Tabs2.setNewTabPosition(index,parentId,panel.id,!1);let newNativeTab=await browser.tabs.create(conf);if(idsMap[info2.id]=newNativeTab.id,info2.customColor){let newTab=Tabs2.byId[newNativeTab.id];newTab&&(newTab.reactive.customColor=newTab.customColor=info2.customColor)}}index++}let expandedFoldersMap=Bookmarks.reactive.expanded[panel.srcPanelConfig?.id??panel.id];if(expandedFoldersMap)for(let bookmarkId of Object.keys(idsMap)){let bookmark=Bookmarks.reactive.byId[bookmarkId];if(!bookmark)continue;let tabId=idsMap[bookmarkId],tab=Tabs2.byId[tabId];if(!tab||!tab.isParent)continue;!!expandedFoldersMap[bookmark.id]===tab.folded&&(tab.folded?Tabs2.expTabsBranch(tab.id,!0,!0):Tabs2.foldTabsBranch(tab.id))}silent||Notifications.notify({title:translate("notif.restore_from_bookmarks_ok")})}var updateSidebarTitleTimeout;function updateSidebarTitle(delay=456){clearTimeout(updateSidebarTitleTimeout),updateSidebarTitleTimeout=setTimeout(()=>{if(Settings.state.updateSidebarTitle){let panel=Sidebar.panelsById[Sidebar.activePanelId];if(!panel)return;browser.sidebarAction.setTitle({title:panel.name,windowId:Windows.id})}else browser.sidebarAction.setTitle({title:"Sidebery",windowId:Windows.id})},delay)}async function convertToBookmarksPanel(panel){if(!Permissions.bookmarks&&!await Permissions.request("bookmarks")||Sidebar.convertingPanelLock)return;Sidebar.convertingPanelLock=!0;let index=Sidebar.reactive.nav.indexOf(panel.id);if(index===-1){Sidebar.convertingPanelLock=!1;return}let isActive=Sidebar.activePanelId===panel.id,notif=Notifications.progress({icon:panel.iconIMG||(panel.iconSVG?"#"+panel.iconSVG:void 0),iconColor:panel.color,title:translate("notif.converting"),progress:{percent:-1}});Bookmarks.reactive.tree.length||await Bookmarks.load();let oldFolderId=panel.bookmarksFolderId,oldFolder=Bookmarks.reactive.byId[oldFolderId],targetFolderId;if(!oldFolder){let result=await Bookmarks.openBookmarksPopup({title:translate("popup.bookmarks.convert"),location:BKM_OTHER_ID,locationField:!0,locationTree:!1,recentLocations:!0,controls:[{label:translate("popup.bookmarks.convert")}]});if(!result){Notifications.finishProgress(notif),Sidebar.convertingPanelLock=!1;return}result.location&&(targetFolderId=result.location)}if(panel.tabs.length)try{await Sidebar.bookmarkTabsPanel(panel.id,!0,!0,targetFolderId)}catch(err3){Notifications.finishProgress(notif),Sidebar.convertingPanelLock=!1,err3!==2&&err("Sidebar.convertToBookmarksPanel:bookmarkTabsPanel",err3);return}isActive&&(Sidebar.switchingLock=!0);let tabsIds=[];if(Settings.state.pinnedTabsPosition==="panel"&&panel.pinnedTabs.length&&tabsIds.push(...panel.pinnedTabs.map(t=>t.id)),tabsIds.push(...panel.tabs.map(t=>t.id)),Tabs2.list.length===tabsIds.length&&await browser.tabs.create({}),tabsIds.length&&await Tabs2.removeTabs(tabsIds,!0),tabsIds.length&&!await Tabs2.isRemovingFinished())return Notifications.finishProgress(notif),Sidebar.convertingPanelLock=!1,warn("Sidebar.convertToBookmarksPanel: Cannot remove panel: Panel is not empty");let bookmarksPanelConfig={name:panel.name,rootId:panel.bookmarksFolderId,color:panel.color,iconSVG:panel.iconSVG==="icon_tabs"?"icon_bookmarks":panel.iconSVG,iconIMG:panel.iconIMG,iconIMGSrc:panel.iconIMGSrc,autoConvert:!0,srcPanelConfig:{id:panel.id,noEmpty:panel.noEmpty,newTabCtx:panel.newTabCtx,dropTabCtx:panel.dropTabCtx,moveRules:panel.moveRules,newTabBtns:panel.newTabBtns}};panel.srcPanelConfig&&(bookmarksPanelConfig.viewMode=panel.srcPanelConfig.viewMode,bookmarksPanelConfig.tempMode=panel.srcPanelConfig.tempMode,bookmarksPanelConfig.autoConvert=panel.srcPanelConfig.autoConvert);let bookmarksPanel=Sidebar.createBookmarksPanel(bookmarksPanelConfig);panel.srcPanelConfig&&(bookmarksPanel.id=panel.srcPanelConfig.id),bookmarksPanel=Sidebar.addPanel(index,bookmarksPanel,!0);let srcTreeState=Bookmarks.reactive.expanded[panel.id];return srcTreeState&&(Bookmarks.reactive.expanded[bookmarksPanel.id]=cloneObject(srcTreeState),Bookmarks.saveBookmarksTree()),Sidebar.recalcPanels(),Sidebar.recalcBookmarksPanels(),Sidebar.saveSidebar(500),setTimeout(()=>{Sidebar.switchingLock=!1,Bookmarks.reactive.tree.length&&(bookmarksPanel.reactive.ready=bookmarksPanel.ready=!0)},200),Notifications.finishProgress(notif,2e3),notif.title=translate("notif.panel_conv"),Sidebar.convertingPanelLock=!1,bookmarksPanel}async function convertToTabsPanel(bookmarksPanel,openTabs2){if(Sidebar.convertingPanelLock)return NOID;Sidebar.convertingPanelLock=!0;let index=Sidebar.reactive.nav.indexOf(bookmarksPanel.id);if(index===-1)return Sidebar.convertingPanelLock=!1,NOID;let notifIcon=bookmarksPanel.iconIMG;notifIcon||(notifIcon=bookmarksPanel.iconSVG&&"#"+bookmarksPanel.iconSVG);let notif=Notifications.progress({icon:notifIcon,iconColor:bookmarksPanel.color,title:translate("notif.converting"),progress:{percent:-1}});if(Bookmarks.reactive.tree.length||await Bookmarks.load(),!Bookmarks.reactive.byId[bookmarksPanel.rootId])return Notifications.finishProgress(notif),Sidebar.convertingPanelLock=!1,warn("Sidebar.convertToTabsPanel: No root folder"),NOID;let isFirstTabsPanel=!Sidebar.hasTabs,tabsPanelConfig={name:bookmarksPanel.name,bookmarksFolderId:bookmarksPanel.rootId,color:bookmarksPanel.color,iconSVG:bookmarksPanel.iconSVG==="icon_bookmarks"?"icon_tabs":bookmarksPanel.iconSVG,iconIMG:bookmarksPanel.iconIMG,iconIMGSrc:bookmarksPanel.iconIMGSrc,srcPanelConfig:{id:bookmarksPanel.id,autoConvert:bookmarksPanel.autoConvert,tempMode:bookmarksPanel.tempMode,viewMode:bookmarksPanel.viewMode}};bookmarksPanel.srcPanelConfig&&(tabsPanelConfig.noEmpty=bookmarksPanel.srcPanelConfig.noEmpty,tabsPanelConfig.newTabCtx=bookmarksPanel.srcPanelConfig.newTabCtx,tabsPanelConfig.dropTabCtx=bookmarksPanel.srcPanelConfig.dropTabCtx,tabsPanelConfig.moveRules=cloneArray(bookmarksPanel.srcPanelConfig.moveRules),tabsPanelConfig.newTabBtns=cloneArray(bookmarksPanel.srcPanelConfig.newTabBtns));let tabsPanel=Sidebar.createTabsPanel(tabsPanelConfig);if(bookmarksPanel.srcPanelConfig&&(tabsPanel.id=bookmarksPanel.srcPanelConfig.id),tabsPanel=Sidebar.addPanel(index,tabsPanel,!0),Sidebar.recalcPanels(),Sidebar.recalcTabsPanels(),Sidebar.activatePanel(tabsPanel.id,!1),isFirstTabsPanel&&await Tabs2.load(),openTabs2)try{await Sidebar.restoreFromBookmarks(tabsPanel,!0)}catch(err3){return Notifications.finishProgress(notif),Sidebar.convertingPanelLock=!1,err3!==2&&err("Sidebar.convertToTabsPanel: Cannot restore tabs",err3),NOID}return Sidebar.saveSidebar(300),Notifications.finishProgress(notif,2e3),notif.title=translate("notif.panel_conv"),Sidebar.convertingPanelLock=!1,tabsPanel.id}var scrollConf4={behavior:"smooth",top:0};function scrollActivePanel(y,offset){let panel;Sidebar.subPanelActive&&Sidebar.subPanelType===2&&(panel=Sidebar.subPanels.bookmarks),panel||(panel=Sidebar.panelsById[Sidebar.activePanelId]),panel?.scrollEl&&(offset?scrollConf4.top=panel.scrollEl.scrollTop-y:scrollConf4.top=y,panel.scrollEl.scroll(scrollConf4))}function scrollPanelToEdge(panel){if(panel||(panel=Sidebar.panelsById[Sidebar.activePanelId]),!panel.scrollComponent||!panel.scrollEl)return;let scrollableBoxEl=panel.scrollComponent.getScrollableBox();scrollableBoxEl&&(panel.scrollEl.scrollTop===0?scrollableBoxEl.scrollIntoView({behavior:"smooth",block:"end"}):scrollableBoxEl.scrollIntoView({behavior:"smooth",block:"start"}))}var switchPanelBackTimeout;function switchPanelBackResetTimeout(){clearTimeout(switchPanelBackTimeout)}function switchPanelBack(delay){clearTimeout(switchPanelBackTimeout),switchPanelBackTimeout=setTimeout(()=>{let prevPanel=Sidebar.panelsById[Sidebar.lastTabsPanelId];prevPanel&&Sidebar.switchToPanel(prevPanel.id)},delay)}var subPanelTypeResetTimeout;function openSubPanel(type,hostPanel){if(isTabsPanel(hostPanel)){if(hostPanel.filteredTabs&&Search.reset(hostPanel),type===2){let panel=Sidebar.subPanels.bookmarks;panel?panel.rootId=hostPanel.bookmarksFolderId:(panel=Sidebar.createBookmarksPanel({rootId:hostPanel.bookmarksFolderId}),panel.rootId===NOID&&(panel.rootId=BKM_ROOT_ID),Sidebar.subPanels.bookmarks=panel),Bookmarks.overallCount&&(panel.ready=!0)}clearTimeout(subPanelTypeResetTimeout),Sidebar.subPanelActive=!0,Sidebar.reactive.subPanelActive=!0,Sidebar.reactive.subPanelType=type,Sidebar.subPanelType=type,type===3&&!History.ready&&History.load(),Menu.isOpen&&Menu.close(),Selection.isSet()&&Selection.resetSelection(),Search.rawValue&&Search.search()}}function closeSubPanel(){Sidebar.subPanelActive&&(Sidebar.subPanelType===3&&Sidebar.activePanelId!=="history"&&History.unloadAfter(3e4),Sidebar.subPanelActive=!1,Sidebar.subPanelType=0,Sidebar.reactive.subPanelActive=!1,Selection.isSet()&&Selection.resetSelection(),Menu.isOpen&&Menu.close(),Search.rawValue&&Search.search(),DnD.items.length&&Sidebar.updateBounds(),clearTimeout(subPanelTypeResetTimeout),subPanelTypeResetTimeout=setTimeout(()=>{Sidebar.reactive.subPanelType=0,Sidebar.subPanels.bookmarks&&(Sidebar.subPanels.bookmarks.reactive.rootOffset=0,Sidebar.subPanels.bookmarks.reactive.filteredBookmarks=void 0,Sidebar.subPanels.bookmarks.reactive.filteredLen=void 0)},500))}function switchPanelOnMouseLeave(){if(Sidebar.switchOnMouseLeave=!1,Sidebar.subPanelActive)return;let activePanel=Sidebar.panelsById[Sidebar.activePanelId];if(!activePanel)return;let activeTab=Tabs2.byId[Tabs2.activeId];activeTab&&activeTab.panelId!==activePanel.id&&(activeTab.pinned&&Settings.state.pinnedTabsPosition!=="panel"||Sidebar.activatePanel(activeTab.panelId))}var updateMediaStateOfPanelTimeouts={};function updateMediaStateOfPanelDebounced(delay,panelId,tab){updateMediaStateOfPanelTimeouts[panelId]!==void 0&&(tab=void 0),clearTimeout(updateMediaStateOfPanelTimeouts[panelId]),updateMediaStateOfPanelTimeouts[panelId]=setTimeout(()=>{delete updateMediaStateOfPanelTimeouts[panelId],updateMediaStateOfPanel(panelId,tab)},delay)}function updateMediaStateOfPanel(panelId,tab){let panel=Sidebar.panelsById[panelId];if(!isTabsPanel(panel))return;if(tab&&(!tab.pinned||Settings.state.pinnedTabsPosition==="panel")){let tabMediaState=0;tab.mediaPaused?tabMediaState=2:tab.mutedInfo?.muted?tabMediaState=-1:tab.audible&&(tabMediaState=1);let panelMediaState=panel.reactive.mediaState;if(tabMediaState===1){panel.reactive.mediaState=1;return}else if(tabMediaState===2&&panelMediaState!==1){panel.reactive.mediaState=2;return}else if(tabMediaState===-1&&panelMediaState===0){panel.reactive.mediaState=-1;return}}let hasPaused=!1,hasMuted=!1;if(Settings.state.pinnedTabsPosition==="panel"){for(let t of panel.pinnedTabs)if(t.mediaPaused)hasPaused=!0;else if(t.mutedInfo?.muted)hasMuted=!0;else if(t.audible){panel.reactive.mediaState=1;return}}for(let t of panel.tabs)if(t.mediaPaused)hasPaused=!0;else if(t.mutedInfo?.muted)hasMuted=!0;else if(t.audible){panel.reactive.mediaState=1;return}hasPaused?panel.reactive.mediaState=2:hasMuted?panel.reactive.mediaState=-1:Tabs2.ready&&(panel.reactive.mediaState=0)}function getRecentTabsPanelId(){let panelId=Sidebar.activePanelId,panel=Sidebar.panelsById[panelId];if(isTabsPanel(panel)||(panelId=Sidebar.lastTabsPanelId,panel=Sidebar.panelsById[panelId]),!isTabsPanel(panel)){let activeTab=Tabs2.byId[Tabs2.activeId];activeTab?panel=Sidebar.panelsById[activeTab.panelId]:panel=Sidebar.panels.find(p=>isTabsPanel(p)),panelId=panel?.id??NOID}return panelId}var actPanelPrevScrollPos;function rememberActivePanelScrollPosition(){let actPanel=Sidebar.panelsById[Sidebar.activePanelId];actPanel?.scrollEl&&(actPanelPrevScrollPos=actPanel.scrollEl.scrollTop)}function restoreActivePanelScrollPosition(){let actPanel=Sidebar.panelsById[Sidebar.activePanelId];!actPanel?.scrollEl||!actPanel?.scrollComponent||actPanelPrevScrollPos===void 0||(actPanel.scrollEl.scrollTop=actPanelPrevScrollPos,actPanel.scrollComponent.recalcScroll())}var Sidebar={reactive:{nav:[],activePanelId:NOID,horNavWidth:0,navBtnWidth:0,navBtnMargin:0,hiddenPanelsPopup:!1,hiddenPanelsPopupOffset:0,hiddenPanelsPopupOffsetSide:"start",selectedNavId:NOID,selectedHeader:NOID,subPanelActive:!1,subPanelType:0},activePanelId:NOID,lastActivePanelId:NOID,panelsById:{},panels:[],nav:[],ready:!1,hasTabs:!1,hasBookmarks:!1,hasHistory:!1,lastTabsPanelId:NOID,scrollPositions:{},convertingPanelLock:!1,subPanelActive:!1,subPanelType:0,subPanelHost:null,subPanels:{},width:0,height:0,scrollAreaRightX:0,scrollAreaLeftX:0,panelsTop:0,tabHeight:0,tabMargin:0,bookmarkHeight:0,folderHeight:0,separatorHeight:0,bookmarkMargin:0,switchingLock:!1,switchOnMouseLeave:!1,reMountSidebar:null,...sidebar_actions_exports};var snapshots_actions_exports={};__export(snapshots_actions_exports,{MAX_SIZE_LIMIT:()=>MAX_SIZE_LIMIT,addSnapshot:()=>addSnapshot,convertFromV4:()=>convertFromV4,convertToMarkdown:()=>convertToMarkdown,createSnapshot:()=>createSnapshot,exportSnapshot:()=>exportSnapshot,getNormalizedSnapshot:()=>getNormalizedSnapshot,getStoredSnapshots:()=>getStoredSnapshots,isV4:()=>isV4,minimizeSnapshot:()=>minimizeSnapshot,notifyAboutNewSnapshot:()=>notifyAboutNewSnapshot,openWindows:()=>openWindows,parseSnapshot:()=>parseSnapshot,prepareExport:()=>prepareExport,removeSnapshot:()=>removeSnapshot,scheduleSnapshots:()=>scheduleSnapshots,updateInternalUrls:()=>updateInternalUrls});var MAX_SIZE_LIMIT=10240,MIN_SNAP_INTERVAL=6e4,MIN_LIMITING_COUNT=1,GLOB_PINNED_ID="global_pinned";async function createSnapshot(auto=!1){if(!Info.isBg)return await bg("createSnapshot");let waiting;try{waiting=await Promise.allSettled([browser.storage.local.get(["sidebar","containers","snapshots"]),Tabs.updateBgTabsTreeData()])}catch(err3){err("createSnapshot: Cannot get source data",err3);return}let storedResult=waiting[0],stored=storedResult?.status==="fulfilled"?storedResult.value:void 0;if(!stored)return;stored.containers||(stored.containers={}),stored.sidebar||(stored.sidebar=createDefaultSidebarConfig()),stored.snapshots||(stored.snapshots=[]);let tabs=[];for(let window2 of Object.values(Windows.byId)){if(Settings.state.snapExcludePrivate&&window2.incognito||window2.id===void 0||!window2.tabs||window2.type!=="normal")continue;let winTabs=[],snapTabsById={},panelTabs,targetGroup="";for(let tab of window2.tabs){let snapTab={url:tab.url,title:tab.title,panelId:tab.panelId},parent=snapTabsById[tab.parentId];parent&&parent.panelId===tab.panelId&&(snapTab.lvl=(parent.lvl??0)+1),tab.pinned&&(snapTab.pinned=!0,Settings.state.pinnedTabsPosition!=="panel"&&(snapTab.panelId=-1)),tab.cookieStoreId!==CONTAINER_ID&&(snapTab.containerId=tab.cookieStoreId),tab.customTitle&&(snapTab.customTitle=tab.customTitle),tab.customColor&&(snapTab.customColor=tab.customColor),snapTab.url=denormalizeUrl(snapTab.url)??snapTab.url,snapTabsById[tab.id]=snapTab,snapTab.panelId!==-1&&(stored.sidebar.panels[snapTab.panelId]||(snapTab.panelId=-1)),snapTab.containerId&&(stored.containers[snapTab.containerId]||delete snapTab.containerId),tab.pinned&&targetGroup!=="pinned"&&(panelTabs=[],winTabs.push(panelTabs),targetGroup="pinned"),!tab.pinned&&targetGroup!==tab.panelId&&(panelTabs=[],winTabs.push(panelTabs),targetGroup=tab.panelId),panelTabs&&panelTabs.push(snapTab)}tabs.push(winTabs)}let currentSnapshot={id:Math.random().toString(36).replace("0.",Date.now().toString(36)),time:Date.now(),containers:stored.containers,sidebar:stored.sidebar,tabs};Settings.state.snapAutoExport&&exportSnapshot(currentSnapshot),minimizeSnapshot(stored.snapshots,currentSnapshot);let prevSnapshot=stored.snapshots[stored.snapshots.length-1];if(!(auto&&prevSnapshot&&isSnapshotRedundant(prevSnapshot,currentSnapshot))){stored.snapshots.push(currentSnapshot);try{let limited=limitSnapshots(stored.snapshots);limited&&(stored.snapshots=limited)}catch(err3){err("Cannot limit snapshots",err3)}return await Store.set({snapshots:stored.snapshots,lastSnapTime:currentSnapshot.time}),Settings.state.snapNotify&&sendToSidebars("notifyAboutNewSnapshot"),currentSnapshot}}function getExportPath(expInfo){let snapAutoExportPath=Settings.state.snapAutoExportPath;return snapAutoExportPath||(snapAutoExportPath="Sidebery/snapshot-%Y.%M.%D-%h.%m.%s"),snapAutoExportPath=dateTimeTemplate(snapAutoExportPath,expInfo.time),snapAutoExportPath=snapAutoExportPath.replace(/^\.+/,""),snapAutoExportPath.split(/\/|\\/).filter(part=>!!part).join("/")}function exportSnapshot(snapshot){if(!browser?.downloads)return;let expType=Settings.state.snapAutoExportType,expInfo=prepareExport(snapshot,{JSON:expType==="json"||expType==="both",Markdown:expType==="md"||expType==="both"}),path2=getExportPath(expInfo);expInfo.jsonFile&&browser.downloads.download({url:URL.createObjectURL(expInfo.jsonFile),filename:`${path2}.json`,conflictAction:"overwrite",saveAs:!1}),expInfo.mdFile&&browser.downloads.download({url:URL.createObjectURL(expInfo.mdFile),filename:`${path2}.md`,conflictAction:"overwrite",saveAs:!1})}async function addSnapshot(snapshot){if(!Info.isBg)return await bg("addSnapshot",snapshot);let snapshots=(await browser.storage.local.get("snapshots").catch(()=>{}))?.snapshots??[],timestamp=Date.now();return snapshot.time=timestamp,snapshots.push(snapshot),await Store.set({snapshots,lastSnapTime:timestamp})}function isSnapshotRedundant(prevSnapshot,snapshot){if(snapshot.containers!==-1||snapshot.sidebar!==-1||prevSnapshot.tabs.length!==snapshot.tabs.length)return!1;for(let wi=0;wi<snapshot.tabs.length;wi++){let win=snapshot.tabs[wi],prevWin=prevSnapshot.tabs[wi];if(!win||prevWin?.length!==win?.length)return!1;for(let pi=0;pi<win.length;pi++){let panel=win[pi],prevPanel=prevWin[pi];if(!panel||prevPanel?.length!==panel?.length)return!1;for(let tab of panel)if(tab!==-1)return!1}}return!0}function minimizeSnapshot(snapshots,snapshot){let newContainersJSON=JSON.stringify(snapshot.containers),newSidebarJSON=JSON.stringify(snapshot.sidebar);for(let i=snapshots.length;i--;){let snapN=snapshots[i];if(!snapN||!snapN.containers)break;if(snapN.containers===-1)continue;let lastContainersJSON=JSON.stringify(snapN.containers);newContainersJSON===lastContainersJSON&&(snapshot.containers=-1);break}for(let i=snapshots.length;i--;){let snapN=snapshots[i];if(!snapN||!snapN.sidebar)break;if(snapN.sidebar===-1)continue;let lastSidebarJSON=JSON.stringify(snapN.sidebar);newSidebarJSON===lastSidebarJSON&&(snapshot.sidebar=-1);break}per_win:for(let wi=0;wi<snapshot.tabs.length;wi++){let win=snapshot.tabs[wi];if(!win)break per_win;per_panel:for(let gi=0;gi<win.length;gi++){let tabs=win[gi];if(!tabs)break per_win;per_tab:for(let ti=0;ti<tabs.length;ti++){let tab=tabs[ti];if(!tab)break per_win;if(tab!==-1)for(let i=snapshots.length;i--;){let snapN=snapshots[i];if(!snapN)break per_win;let winN=snapN.tabs[wi];if(!winN)break per_win;let panelN=winN[gi];if(!panelN)break per_panel;let tabN=panelN[ti];if(!tabN)break per_tab;if(tabN!==-1){tab.url===tabN.url&&tab.title===tabN.title&&tab.pinned===tabN.pinned&&tab.containerId===tabN.containerId&&tab.panelId===tabN.panelId&&tab.lvl===tabN.lvl&&tab.customTitle===tabN.customTitle&&tab.customColor===tabN.customColor&&(tabs[ti]=-1);break}}}}}}function getNormalizedSnapshot(snapshots,index){let snapshot=snapshots[index];if(snapshot){if(snapshot.containers===-1)for(let i=index;i--;){let snapN=snapshots[i];if(snapN&&snapN.containers!==-1){snapshot.containers=snapN.containers;break}}if(snapshot.sidebar===-1)for(let i=index;i--;){let snapN=snapshots[i];if(snapN&&snapN.sidebar!==-1){snapshot.sidebar=snapN.sidebar;break}}for(let wi=0;wi<snapshot.tabs.length;wi++){let win=snapshot.tabs[wi];if(win)for(let pi=0;pi<win.length;pi++){let panel=win[pi];if(panel){for(let ti=0;ti<panel.length;ti++)if(panel[ti]===-1){if(index===0)return;for(let i=index;i--;){let tabN=snapshots[i]?.tabs[wi]?.[pi]?.[ti];if(tabN&&tabN!==-1){panel[ti]=tabN;break}if(i===0)return}}}}}if(!(!snapshot.sidebar||snapshot.sidebar===-1)&&!(!snapshot.containers||snapshot.containers===-1))return snapshot}}function notifyAboutNewSnapshot(){if(Settings.state.snapExcludePrivate&&Windows.incognito)return;let config={icon:"#icon_snapshot",title:translate("notif.snapshot_created"),ctrl:translate("notif.view_snapshot"),callback:()=>SetupPage.open("snapshots")};Notifications.notify(config)}async function scheduleSnapshots(){clearTimeout(scheduleTimeout);let interval=getSnapInterval();if(interval<MIN_SNAP_INTERVAL)return;let elapsed=await getLastSnapTimeElapsed(),nextInterval=interval-elapsed;nextInterval<MIN_SNAP_INTERVAL&&(nextInterval=MIN_SNAP_INTERVAL),scheduleNextSnapshot(nextInterval)}var scheduleTimeout;function scheduleNextSnapshot(nextTimeout){scheduleTimeout=setTimeout(()=>{nextTimeout=getSnapInterval(),nextTimeout<MIN_SNAP_INTERVAL&&(nextTimeout=MIN_SNAP_INTERVAL),createSnapshot(!0),scheduleNextSnapshot(nextTimeout)},nextTimeout)}function getSnapInterval(){let interval=Settings.state.snapInterval,unit=Settings.state.snapIntervalUnit;return!interval||typeof interval!="number"?0:(unit==="min"&&(interval=Settings.state.snapInterval*6e4),unit==="hr"&&(interval=Settings.state.snapInterval*36e5),unit==="day"&&(interval=Settings.state.snapInterval*864e5),interval)}async function getLastSnapTimeElapsed(){let stored=await browser.storage.local.get("lastSnapTime"),now=Date.now(),lastSnapTime=stored.lastSnapTime??now,elapsed=now-lastSnapTime;return elapsed<0?0:elapsed}async function adaptContainers(snapshot){let currentContainers=Object.values(Containers.reactive.byId),oldNewIds={};for(let container of Object.values(snapshot.containers)){let currentContainer=currentContainers.find(c=>c.name===container.name&&c.icon===container.icon&&c.color===container.color);if(Containers.updateReopeningRules(container),currentContainer)oldNewIds[container.id]=currentContainer.id;else{let newContainer=await Containers.create(container.name,container.color,container.icon);newContainer.proxified=container.proxified,newContainer.proxy=container.proxy,newContainer.reopenRulesActive=container.reopenRulesActive,newContainer.reopenRules=cloneArray(container.reopenRules),newContainer.userAgentActive=container.userAgentActive,newContainer.userAgent=container.userAgent,oldNewIds[container.id]=newContainer.id}}for(let win of snapshot.tabs)for(let panel of win)for(let tab of panel)tab.containerId&&oldNewIds[tab.containerId]&&(tab.containerId=oldNewIds[tab.containerId]);await Containers.saveContainers()}async function adaptTabsPanels(snapshot){let stored=await browser.storage.local.get("sidebar");if(!stored.sidebar?.nav)return;let lastStoredTabsPanelIndex=stored.sidebar.nav.length;for(;lastStoredTabsPanelIndex-- >0;){let storedId=stored.sidebar.nav[lastStoredTabsPanelIndex];if(storedId===void 0)break;let storedPanel=stored.sidebar.panels[storedId];if(storedPanel&&storedPanel.type===2)break}let changed=!1;for(let i=0;i<snapshot.sidebar.nav.length;i++){let snapId=snapshot.sidebar.nav[i];if(snapId===void 0)continue;let snapPanel=snapshot.sidebar.panels[snapId];if(!snapPanel||snapPanel.type!==2)continue;stored.sidebar.nav.indexOf(snapId)===-1&&(changed=!0,lastStoredTabsPanelIndex++,stored.sidebar.nav.splice(lastStoredTabsPanelIndex,0,snapId),stored.sidebar.panels[snapId]=snapPanel)}for(let i=0;i<snapshot.tabs.length;i++){let win=snapshot.tabs[i];if(!win||win.length<=1)continue;let newOrder=[];win[0]?.[0]?.pinned&&(newOrder.push(win[0]),win.shift());for(let tabs of win)tabs[0]?.panelId===NOID&&newOrder.push(tabs);for(let storedId of stored.sidebar.nav){let storedPanel=stored.sidebar.panels[storedId];if(!storedPanel||storedPanel.type!==2)continue;let snapPanelTabs=win.find(tabs=>tabs[0]?.panelId===storedPanel.id);if(snapPanelTabs)newOrder.push(snapPanelTabs);else continue}snapshot.tabs[i]=newOrder}changed&&await Store.set({sidebar:stored.sidebar})}async function openWindows(snapshot,winIndex){if(await adaptContainers(snapshot),await adaptTabsPanels(snapshot),winIndex===void 0)for(let i=0;i<snapshot.tabs.length;i++)await openWindow(snapshot,i);else await openWindow(snapshot,winIndex)}async function openWindow(snapshot,winIndex){let winTabs=snapshot.tabs[winIndex];if(!winTabs)return warn("Snapshots.openWindow: No winTabs");let items=[],tabsInfoByLvl={},index=0;for(let panel of winTabs)for(let tab of panel){tab.panelId===GLOB_PINNED_ID&&(tab.panelId=NOID);let tabInfo={id:index++,url:tab.url,title:tab.title,parentId:NOID,panelId:tab.panelId??NOID,container:tab.containerId??DEFAULT_CONTAINER_ID};if(tab.customTitle&&(tabInfo.customTitle=tab.customTitle),tab.customColor&&(tabInfo.customColor=tab.customColor),tabsInfoByLvl[tab.lvl??0]=tabInfo,tab.pinned&&(tabInfo.pinned=!0),isGroupUrl(tab.url)){let index2=tab.url.indexOf("group.html")+10,newUrl=GROUP_URL+tab.url.slice(index2);tabInfo.url=newUrl}if(tab.lvl){let parent=tabsInfoByLvl[tab.lvl-1];parent&&(tabInfo.parentId=parent.id)}items.push(tabInfo)}let firstItem2=items[0];firstItem2&&(firstItem2.active=!0),await Windows.createWithTabs(items,{incognito:!1})}function limitSnapshots(snapshots){if(snapshots.length<=MIN_LIMITING_COUNT)return;let normMaxSize=MAX_SIZE_LIMIT*1024,limit=Settings.state.snapLimit,unit=Settings.state.snapLimitUnit;(!limit||limit<0)&&(limit=MAX_SIZE_LIMIT,unit="kb");let normLimit=limit;unit==="day"?normLimit=Date.now()-limit*864e5:unit==="kb"&&(limit>MAX_SIZE_LIMIT&&(limit=MAX_SIZE_LIMIT),normLimit=limit*1024);let index=snapshots.length,accum=0,sizeAccum=0;for(;index--;){let snapshot=snapshots[index];if(snapshot&&(sizeAccum+=new Blob([JSON.stringify(snapshot)]).size,unit==="snap"&&(accum++,accum>normLimit)||unit==="kb"&&sizeAccum>normLimit||unit==="day"&&snapshot.time<normLimit||sizeAccum>normMaxSize))break}index++;let normSnapshot=getNormalizedSnapshot(snapshots,index);if(normSnapshot)snapshots[index]=normSnapshot;else return;return snapshots.slice(index)}async function removeSnapshot(id){let stored;try{stored=await browser.storage.local.get(["snapshots"])}catch(err3){return err("removeSnapshot: Cannot get snapshots",err3),-1}if(!stored.snapshots)return-1;let index=stored.snapshots.findIndex(s=>s.id===id);if(!stored.snapshots[index])return-1;if(stored.snapshots[index+1]){let normSnapshot=getNormalizedSnapshot(stored.snapshots,index+1);if(!normSnapshot)return-1;stored.snapshots[index+1]=normSnapshot}return stored.snapshots.splice(index,1),await Store.set(stored),1}function parseSnapshot(snapshots,index,dayStartMs){let sizeStr=strSize(JSON.stringify(snapshots[index])),snapshot=getNormalizedSnapshot(snapshots,index);if(!snapshot)return;let windows=[],winCount=snapshot.tabs.length,tabsCount=0;for(let win of snapshot.tabs){if(!win.length)continue;let panelsById={},winState={id:tabsCount,panels:[],tabsLen:0};windows.push(winState);for(let panel of win)if(panel.length)for(let tab of panel){let container=tab.containerId?snapshot.containers[tab.containerId]:void 0;tab.pinned&&tab.panelId===NOID&&(tab.panelId=GLOB_PINNED_ID);let panelState=panelsById[tab.panelId];if(!panelState){let panelConfig=snapshot.sidebar.panels[tab.panelId];panelConfig||(panelConfig=cloneObject(TABS_PANEL_CONFIG),tab.pinned&&tab.panelId===GLOB_PINNED_ID?(panelConfig.id=GLOB_PINNED_ID,panelConfig.name=translate("snapshot.global_pin_title"),panelConfig.iconSVG="icon_pin"):(panelConfig.id=NOID,tab.panelId=NOID)),panelState={id:panelConfig.id,tabs:[],name:panelConfig.name,iconSVG:panelConfig.iconSVG||"icon_tabs",iconIMG:panelConfig.iconIMG,color:panelConfig.color},panelsById[panelState.id]=panelState}let tabState={...tab,id:tabsCount,containerIcon:container?.icon,containerColor:container?.color,domain:getDomainOf(tab.url),iconSVG:getFavPlaceholder(tab.url),sel:!1};panelState.tabs.push(tabState),tabsCount++,winState.tabsLen++}panelsById[GLOB_PINNED_ID]&&winState.panels.push(panelsById[GLOB_PINNED_ID]);for(let id of snapshot.sidebar.nav??[]){let panelState=panelsById[id];panelState?.tabs.length&&winState.panels.push(panelState)}}return{...snapshot,windows,dateStr:uDate(snapshot.time,".",dayStartMs),timeStr:uTime(snapshot.time),sizeStr,winCount,tabsCount}}function isV4(snapshots){if(!snapshots)return!1;let first=snapshots[0];return first?!!first.containersById:!1}function convertFromV4(oldSnapshots){let result=[];for(let snapshotV4 of oldSnapshots){if(!snapshotV4.windows)continue;let snapshot={id:snapshotV4.id??Math.random().toString(36).replace("0.",Date.now().toString(36)),time:snapshotV4.time??Date.now(),containers:{},sidebar:{nav:[],panels:{}},tabs:[]};if(snapshotV4.containersById)for(let ctrV4 of Object.values(snapshotV4.containersById)){if(ctrV4.id===void 0)continue;let ctr=cloneObject(DEFAULT_CONTAINER);ctr.id=ctr.cookieStoreId=ctrV4.id,ctr.name=ctrV4.name??"",ctr.color=ctrV4.color??"toolbar",ctr.icon=ctrV4.icon??"fingerprint",snapshot.containers[ctr.id]=ctr}let defaultPanelId=NOID;snapshotV4.panels&&(defaultPanelId=snapshotV4.panels.find(p=>p.type==="default")?.id??"firefox-default",snapshot.sidebar=getSidebarConfigFromV4(snapshotV4.panels));for(let winV4 of Object.values(snapshotV4.windows)){if(!winV4.items?.length)continue;let win=[],panelTabs,targetGroup;for(let tabV4 of winV4.items){if(tabV4.url===void 0)continue;let snapTab={url:tabV4.url,title:tabV4.title??"",panelId:NOID};if(tabV4.panel?snapTab.panelId=tabV4.panel:snapTab.panelId=defaultPanelId,tabV4.lvl&&(snapTab.lvl=tabV4.lvl),tabV4.pinned&&(snapTab.pinned=!0),tabV4.ctr&&tabV4.ctr!==CONTAINER_ID&&(snapTab.containerId=tabV4.ctr),isV4GroupUrl(snapTab.url)){let titleEndIndex=snapTab.url.indexOf(":id:",V4_GROUP_URL_LEN);titleEndIndex===-1&&(titleEndIndex=void 0);let newUrl=GROUP_URL+snapTab.url.slice(V4_GROUP_URL_LEN,titleEndIndex);snapTab.url=newUrl}if(isV4UrlUrl(snapTab.url)){let newUrl=URL_URL+snapTab.url.slice(V4_URL_URL_LEN);snapTab.url=newUrl}snapTab.panelId!==-1&&(snapshot.sidebar.panels[snapTab.panelId]||(snapTab.panelId=-1)),snapTab.containerId&&(snapshot.containers[snapTab.containerId]||delete snapTab.containerId),snapTab.pinned&&targetGroup!=="pinned"&&(panelTabs=[],win.push(panelTabs),targetGroup="pinned"),!snapTab.pinned&&targetGroup!==snapTab.panelId&&(panelTabs=[],win.push(panelTabs),targetGroup=snapTab.panelId),panelTabs&&panelTabs.push(snapTab)}snapshot.tabs.push(win)}minimizeSnapshot(result,snapshot),result.push(snapshot)}return result}function updateInternalUrls(snapshot){for(let win of snapshot.tabs)for(let panel of win)for(let tab of panel)if(isGroupUrl(tab.url)){let newUrl=GROUP_URL+tab.url.slice(GROUP_URL_LEN);tab.url=newUrl}else if(isUrlUrl(tab.url)){let newUrl=URL_URL+tab.url.slice(URL_URL_LEN);tab.url=newUrl}}async function getStoredSnapshots(){let stored;try{stored=await browser.storage.local.get("snapshots")}catch(err3){return err("Snapshots: getStoredSnapshots: Cannot get snapshots",err3)}return stored.snapshots}function prepareExport(snapshot,type){let{id,time,containers,sidebar:sidebar2,tabs}=snapshot,expInfo={id,time,containers,sidebar:sidebar2,tabs};if(type.JSON){let jsonStr=JSON.stringify(snapshot);expInfo.jsonFile=new Blob([jsonStr],{type:"application/json"})}return type.Markdown&&(expInfo.md=convertToMarkdown(snapshot),expInfo.mdFile=new Blob([expInfo.md],{type:"text/markdown"})),expInfo}function convertToMarkdown(snapshot){let dateStr=uDate(snapshot.time,"."),timeStr=uTime(snapshot.time,"."),md=[`# ${`${dateStr} - ${timeStr}`}`,""],globalPinnedTabs=[],pinnedTabsByPanelId=new Map,indent="  ",pinMark="📌 ",winIndent="",panelsIndent=Settings.state.snapMdFullTree?indent:"",tabsIndent=Settings.state.snapMdFullTree?indent.repeat(2):"",winBullet=Settings.state.snapMdFullTree?"- ":"",panelBullet=Settings.state.snapMdFullTree?"- ":"",tabBullet="- ";if(snapshot.tabs[0]?.[0]?.[0]?.pinned){let pinnedTabs=snapshot.tabs[0]?.[0];for(let tab of pinnedTabs)if(snapshot.sidebar.panels[tab.panelId]){let panelPinnedTabs=pinnedTabsByPanelId.get(tab.panelId);panelPinnedTabs||(panelPinnedTabs=[]),panelPinnedTabs.push(tab),pinnedTabsByPanelId.set(tab.panelId,panelPinnedTabs)}else globalPinnedTabs.push(tab)}for(let i=0;i<snapshot.tabs.length;i++){let win=snapshot.tabs[i],winTitle=`## ${translate("snapshot.window_title")} ${i+1}`;if(md.push(winIndent+winBullet+winTitle),globalPinnedTabs.length){let globalPinnedTitle=`### ${translate("snapshot.global_pin_title")}`;md.push(panelsIndent+panelBullet+globalPinnedTitle);for(let tab of globalPinnedTabs){let tabLink=`[${tab.title}](${tab.url})`;md.push(tabsIndent+tabBullet+pinMark+tabLink)}}for(let id of snapshot.sidebar.nav){let panel=snapshot.sidebar.panels[id];if(!isTabsPanel(panel))continue;let pinnedTabs=pinnedTabsByPanelId.get(id),normalTabs=win.find(p=>p[0]&&p[0].panelId===id&&!p[0].pinned);if(!pinnedTabs?.length&&!normalTabs)continue;let panelTitle=`### ${panel.name}`;if(md.push(panelsIndent+panelBullet+panelTitle),pinnedTabs?.length)for(let tab of pinnedTabs){let tabLink=`[${tab.title}](${tab.url})`;md.push(tabsIndent+tabBullet+pinMark+tabLink)}if(normalTabs?.length)for(let tab of normalTabs){let tabLink=`[${tab.title}](${tab.url})`;md.push(tabsIndent+indent.repeat(tab.lvl??0)+tabBullet+tabLink)}}}return md.join(`
`)}var Snapshots={state:{list:[]},...snapshots_actions_exports};async function loadSettings(){let stored=await browser.storage.local.get("settings");stored.settings||(window.matchMedia("(prefers-reduced-motion: reduce)")?.matches&&(DEFAULT_SETTINGS.animations=!1),stored.settings={}),normalizeObject(stored.settings,DEFAULT_SETTINGS),updateObject(Settings.state,stored.settings,Settings.state),Settings.state.hideInact&&(Settings.state.activateLastTabOnPanelSwitching=!0,Settings.state.tabsPanelSwitchActMove=!0),parsePrefaceTemplate(),Search.parseShortcuts()}async function saveSettings(){let clone=cloneObject(Settings.state),settings=recreateNormalizedObject(clone,DEFAULT_SETTINGS);await Store.set({settings}),settings.syncSaveSettings&&saveSettingsToSync()}var saveSettingsTimeout;function saveDebounced(delay=500){clearTimeout(saveSettingsTimeout),saveSettingsTimeout=setTimeout(()=>{Settings.saveSettings()},delay)}async function saveSettingsToSync(settings){settings||(settings=recreateNormalizedObject(Settings.state,DEFAULT_SETTINGS)),await Store.sync("settings",{settings})}function setupSettingsChangeListener(){Info.isBg?Store.onKeyChange("settings",updateSettingsBg):Store.onKeyChange("settings",updateSettingsFg)}function updateSettingsBg(settings){if(!settings)return;let prev2=Settings.state,next2=settings,markWindowChanged=prev2.markWindow!==next2.markWindow,markWindowPrefaceChanged=prev2.markWindowPreface!==next2.markWindowPreface,snapIntervalChanged=prev2.snapInterval!==next2.snapInterval,snapIntervalUnitChanged=prev2.snapIntervalUnit!==next2.snapIntervalUnit,colorSchemeChanged=prev2.colorScheme!==next2.colorScheme;if(updateObject(Settings.state,settings,Settings.state),markWindowChanged)for(let win of Object.values(Windows.byId))win.type!=="normal"||win.id===void 0||(next2.markWindow?isConnected(2,win.id)&&sendToSidebar(win.id,"updWindowPreface"):browser.windows.update(win.id,{titlePreface:""}));else if(markWindowPrefaceChanged)for(let win of Object.values(Windows.byId))win.type!=="normal"||win.id===void 0||Settings.state.markWindow&&isConnected(2,win.id)&&sendToSidebar(win.id,"updWindowPreface",Settings.state.markWindowPreface);(snapIntervalChanged||snapIntervalUnitChanged)&&Snapshots.scheduleSnapshots(),colorSchemeChanged&&Styles.updateColorScheme()}function updateSettingsFg(settings){if(!settings)return;let prev2=Settings.state,next2=settings,hideInactTabs=prev2.hideInact!==next2.hideInact,updateSuccessions=prev2.activateAfterClosing!==next2.activateAfterClosing||prev2.activateAfterClosingNoDiscarded!==next2.activateAfterClosingNoDiscarded,resetTree=prev2.tabsTree!==next2.tabsTree&&prev2.tabsTree,updateTree=prev2.tabsTreeLimit!==next2.tabsTreeLimit,hideFoldedTabs=prev2.hideFoldedTabs!==next2.hideFoldedTabs,hideFoldedParent=prev2.hideFoldedParent!==next2.hideFoldedParent,theme=prev2.theme!==next2.theme,highlightOpenBookmarks=prev2.highlightOpenBookmarks!==next2.highlightOpenBookmarks,colorScheme=prev2.colorScheme!==next2.colorScheme,ctxMenuCtrIgnore=prev2.ctxMenuIgnoreContainers!==next2.ctxMenuIgnoreContainers,fontSize=prev2.fontSize!==next2.fontSize,updateSidebarTitleChanged=prev2.updateSidebarTitle!==next2.updateSidebarTitle,pinnedTabsPositionChanged=prev2.pinnedTabsPosition!==next2.pinnedTabsPosition,colorizeTabsChanged=prev2.colorizeTabs!==next2.colorizeTabs,colorizeTabsSrcChanged=prev2.colorizeTabsSrc!==next2.colorizeTabsSrc,colorizeTabsBranchesChanged=prev2.colorizeTabsBranches!==next2.colorizeTabsBranches,colorizeTabsBranchesSrcChanged=prev2.colorizeTabsBranchesSrc!==next2.colorizeTabsBranchesSrc,tabsUpdateMarkChanged=prev2.tabsUpdateMark!==next2.tabsUpdateMark,navTabsPanelMidClickAction=prev2.navTabsPanelMidClickAction!==next2.navTabsPanelMidClickAction,navBookmarksPanelMidClickAction=prev2.navBookmarksPanelMidClickAction!==next2.navBookmarksPanelMidClickAction,tabsUrlInTooltip=prev2.tabsUrlInTooltip!==next2.tabsUrlInTooltip,newTabCtxReopen=prev2.newTabCtxReopen!==next2.newTabCtxReopen,previewTabs=prev2.previewTabs!==next2.previewTabs,previewTabsMode=prev2.previewTabsMode!==next2.previewTabsMode,markWindowPreface=prev2.markWindowPreface!==next2.markWindowPreface;if(updateObject(Settings.state,settings,Settings.state),Info.isSidebar&&newTabCtxReopen&&updateWebReqHandlers(),(tabsUrlInTooltip||previewTabs)&&Tabs2.list.forEach(t=>Tabs2.updateTooltip(t.id)),previewTabsMode&&resetMode(),(navTabsPanelMidClickAction||navBookmarksPanelMidClickAction)&&Sidebar.updatePanelsTooltips(),Info.isSidebar&&updateSuccessions&&Sidebar.hasTabs&&Tabs2.updateSuccessionDebounced(0),resetTree&&Sidebar.hasTabs){for(let tab of Tabs2.list)tab.reactive.isParent=tab.isParent=!1,tab.reactive.folded=tab.folded=!1,tab.invisible=!1,tab.parentId=-1,tab.reactive.lvl=tab.lvl=0;Sidebar.recalcVisibleTabs()}if(updateTree&&Sidebar.hasTabs&&(Tabs2.updateTabsTree(),Sidebar.recalcVisibleTabs()),(hideInactTabs||hideFoldedTabs||hideFoldedParent)&&Sidebar.hasTabs&&Tabs2.updateNativeTabsVisibility(),highlightOpenBookmarks&&Bookmarks.reactive.byId&&(Settings.state.highlightOpenBookmarks?Bookmarks.markOpenBookmarksForAllTabs():Bookmarks.unmarkAllOpenBookmarks()),theme&&(Styles.updateColorScheme(),Info.isSidebar&&(Styles.removeCustomCSS(),Styles.loadCustomSidebarCSS())),ctxMenuCtrIgnore&&Menu.parseContainersRules(),fontSize&&Sidebar.updateFontSize(),colorScheme&&Styles.updateColorScheme(),Info.isSidebar&&updateSidebarTitleChanged&&Sidebar.updateSidebarTitle(0),pinnedTabsPositionChanged&&Sidebar.hasTabs&&Sidebar.recalcTabsPanels(),Sidebar.reMountSidebar&&Sidebar.reMountSidebar(),(colorizeTabsBranchesChanged||colorizeTabsBranchesSrcChanged)&&Settings.state.colorizeTabsBranches&&Tabs2.colorizeBranches(),(colorizeTabsChanged||colorizeTabsSrcChanged)&&Settings.state.colorizeTabs&&Tabs2.colorizeTabs(),tabsUpdateMarkChanged&&next2.tabsUpdateMark==="none"){for(let tab of Tabs2.list)tab.reactive.updated=tab.updated=!1;for(let panel of Sidebar.panels)isTabsPanel(panel)&&(panel.updatedTabs=[],panel.reactive.updated=!1)}markWindowPreface&&parsePrefaceTemplate(),Search.parseShortcuts()}function resetSettings(){updateObject(Settings.state,DEFAULT_SETTINGS,DEFAULT_SETTINGS)}function getOpts(key){return SETTINGS_OPTIONS[key]}function parsePrefaceTemplate(){let preface=Settings.state.markWindowPreface;Settings.updateWinPrefaceOnPanelSwitch=preface.includes("%PN")}var Settings={state:cloneObject(DEFAULT_SETTINGS),updateWinPrefaceOnPanelSwitch:!1,...settings_actions_exports};var stopSorting=!1;async function sort(type,ids,dir=0,tree){if(!ids.length||!dir)return;if(tree){let treeIds=new Set;for(let id of ids){let tab=Tabs2.byId[id];!tab||treeIds.has(tab.id)||(treeIds.add(tab.id),tab.isParent&&Tabs2.getBranch(tab,!1).forEach(t=>treeIds.add(t.id)))}ids=Array.from(treeIds)}else if(ids=ids.filter(id=>!Tabs2.byId[id]?.invisible),ids.length===1){let siblings=getSiblings(ids[0]);if(!siblings)return;ids=siblings}Tabs2.sortTabIds(ids);let sortingChunks=getSortingChunks(ids).reverse();Tabs2.sorting=!0;let progressNotification;if(stopSorting=!1,(sortingChunks.length>1||ids.length>2)&&(progressNotification=Notifications.progress({icon:getNotifIcon(1,dir),title:translate("notif.tabs_sort"),progress:{percent:-1},unconcealed:!0,ctrl:translate("btn.stop"),callback:()=>{stopSorting=!0}})),type===1){let collatorOptions={numeric:!0};await sortTabsInChunks(sortingChunks,(aId,bId)=>{let aTab=Tabs2.byId[aId],bTab=Tabs2.byId[bId];if(!aTab||!bTab)return 0;let aTitle=aTab.customTitle??aTab.title,bTitle=bTab.customTitle??bTab.title;return Settings.state.sortGroupsFirst&&aTab.isGroup!==bTab.isGroup?aTab.isGroup?-1:1:dir>0?aTitle.localeCompare(bTitle,void 0,collatorOptions):bTitle.localeCompare(aTitle,void 0,collatorOptions)}).catch(()=>{})}else if(type===2){let collatorOptions={numeric:!0},sortableLinks=new Map;await sortTabsInChunks(sortingChunks,(aId,bId)=>{let aTab=Tabs2.byId[aId],bTab=Tabs2.byId[bId];if(!aTab||!bTab)return 0;if(Settings.state.sortGroupsFirst&&aTab.isGroup!==bTab.isGroup)return aTab.isGroup?-1:1;let aLink=getSortableLink(sortableLinks,aTab),bLink=getSortableLink(sortableLinks,bTab);return dir>0?aLink.localeCompare(bLink,void 0,collatorOptions):bLink.localeCompare(aLink,void 0,collatorOptions)}).catch(()=>{})}else type===3&&await sortTabsInChunks(sortingChunks,(aId,bId)=>{let aTab=Tabs2.byId[aId],bTab=Tabs2.byId[bId];return!aTab||!bTab?0:Settings.state.sortGroupsFirst&&aTab.isGroup!==bTab.isGroup?aTab.isGroup?-1:1:dir>0?aTab.lastAccessed-bTab.lastAccessed:bTab.lastAccessed-aTab.lastAccessed}).catch(()=>{});progressNotification&&Notifications.finishProgress(progressNotification),Tabs2.sorting=!1,Tabs2.deferredEventHandling.forEach(cb=>cb()),Tabs2.deferredEventHandling=[]}function getSortableLink(sortableUrls,tab){let value=sortableUrls.get(tab.id);if(!value){let parsedUrl;try{parsedUrl=new URL(tab.url)}catch{return tab.url}let reversedHostname=parsedUrl.hostname.split(".").reverse().join("."),hIndex=parsedUrl.protocol.length+2,pIndex=tab.url.indexOf("/",hIndex);pIndex===-1?value=reversedHostname:value=reversedHostname+tab.url.slice(pIndex),sortableUrls.set(tab.id,value)}return value}function getNotifIcon(type,dir=0){if(!dir)return;let notifIcon;return type===1?dir>0?notifIcon="#icon_sort_name_asc":notifIcon="#icon_sort_name_des":type===2?dir>0?notifIcon="#icon_sort_url_asc":notifIcon="#icon_sort_url_des":type===3&&(dir>0?notifIcon="#icon_sort_time_asc":notifIcon="#icon_sort_time_des"),notifIcon}function getSiblings(id){let tab=Tabs2.byId[id];if(!tab)return;let panel=Sidebar.panelsById[tab.panelId];return tab.pinned&&Settings.state.pinnedTabsPosition!=="panel"?Tabs2.pinned.map(t=>t.id):tab.pinned&&isTabsPanel(panel)?panel.pinnedTabs.map(t=>t.id):isTabsPanel(panel)?panel.tabs.filter(t=>t.parentId===tab.parentId).map(t=>t.id):void 0}function getSortingChunks(ids){let groups=[],parentIndexes={};for(let id of ids){let tab=Tabs2.byId[id];if(!tab)continue;if(tab.pinned)return[ids];let index=parentIndexes[tab.parentId];index===void 0?(index=groups.push([id])-1,parentIndexes[tab.parentId]=index):groups[index].push(id)}return groups}async function sortTabsInChunks(sortingGroups,sortFn){let tabProbe;for(let group of sortingGroups){if(group.length<=1)continue;let startTab=Tabs2.byId[group[0]],startIndex=startTab?.index;if(!startTab||startIndex===void 0)continue;tabProbe||(tabProbe=startTab);let branches={},toCut=[];for(let id of group){let tab=Tabs2.byId[id];if(tab&&(toCut.push(tab),tab.isParent)){let branch=Tabs2.getBranch(tab,!1);branches[tab.id]=branch,toCut.push(...branch)}}for(let i=toCut.length;i--;){let tab=toCut[i];tab&&(tab.moving=!0,Tabs2.list.splice(tab.index,1))}group.sort(sortFn);let toPaste=[];for(let id of group){let tab=Tabs2.byId[id];if(!tab)continue;toPaste.push(tab);let branch=branches[tab.id];branch&&toPaste.push(...branch)}Tabs2.list.splice(startIndex,0,...toPaste),Tabs2.updateTabsIndexes(startIndex);let toPasteIds=toPaste.map(t=>t.id);try{await browser.tabs.move(toPasteIds,{index:startIndex,windowId:Windows.id})}catch(err3){return err("Tabs.sortNativeTabs: Cannot move tabs",err3),Tabs2.reinitTabs()}if(toPaste.forEach(t=>t.moving=void 0),stopSorting){stopSorting=!1;break}}Tabs2.updateTabsTree(),Sidebar.recalcTabsPanels(),tabProbe&&!tabProbe.pinned&&Sidebar.recalcVisibleTabs(tabProbe.panelId)}var tabsMenuOptions={undoRmTab:()=>({label:translate("menu.tab.undo"),icon:"icon_undo",onClick:()=>Tabs2.undoRmTab()}),moveToNewWin:()=>({label:translate(`menu.tab.move_to_new_${Windows.incognito?"priv_window":"window"}`),icon:Windows.incognito?"icon_move_to_new_priv_win":"icon_move_to_new_norm_win",onClick:()=>{let items=Selection.getTabsInfo(!0);Tabs2.move(items,{},{windowId:NEWID,incognito:Windows.incognito})}}),moveToWin:()=>{let option={},wins=Windows.otherWindows.filter(w=>w.incognito===Windows.incognito),winLen=wins.length;if(winLen===0&&(option.inactive=!0),winLen<=1?(option.label=translate("menu.tab.move_to_another_window"),Windows.incognito?option.icon="icon_move_to_priv_win":option.icon="icon_move_to_norm_win",option.onClick=()=>{let items=Selection.getTabsInfo(!0),dst={windowId:wins[0].id,pinned:items[0]?.pinned};Tabs2.move(items,{},dst)}):(option.label=translate("menu.tab.move_to_window_"),Windows.incognito?option.icon="icon_move_to_priv_wins":option.icon="icon_move_to_norm_wins",option.onClick=()=>{let filter=w=>w.incognito===Windows.incognito,windowChooseConf={title:option.label,otherWindows:!0,filter},items=Selection.getTabsInfo(!0),dst={windowChooseConf,pinned:items[0]?.pinned};Tabs2.move(items,{},dst)}),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},moveToPanel:()=>{let opts=[],probeTab=Tabs2.byId[Selection.getFirst()];if(!(!probeTab||probeTab.pinned&&Settings.state.pinnedTabsPosition!=="panel")){for(let panel of Sidebar.panels)isTabsPanel(panel)&&probeTab.panelId!==panel.id&&opts.push({label:translate("menu.tab.move_to_panel_")+panel.name,icon:panel.iconSVG,img:panel.iconIMG,badge:"icon_move_badge",color:panel.color,onClick:()=>{let items=Selection.getTabsInfo(!0),src={windowId:Windows.id,panelId:probeTab.panelId,pinned:probeTab.pinned};Tabs2.move(items,src,{panelId:panel.id,index:panel.nextTabIndex})}});if(opts.length)return opts}},moveToNewPanel:()=>{let probeTab=Tabs2.byId[Selection.getFirst()];if(!probeTab||probeTab.pinned&&Settings.state.pinnedTabsPosition!=="panel")return;let option={label:translate("menu.tab.move_to_new_panel"),icon:"icon_add_tabs_panel",badge:"icon_move_badge",onClick:()=>Tabs2.moveToNewPanel(Selection.get())};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},reopenInNewWin:()=>{let label=Windows.incognito?"reopen_in_new_norm_window":"reopen_in_new_priv_window";return{label:translate("menu.tab."+label),icon:Windows.incognito?"icon_reopen_in_new_norm_window":"icon_reopen_in_new_priv_win",onClick:()=>{let items=Selection.getTabsInfo(!0),pinned=items[0]?.pinned;Tabs2.reopen(items,{windowId:NEWID,incognito:!Windows.incognito,pinned})}}},reopenInWin:()=>{let option={},wins=Windows.otherWindows.filter(w=>w.incognito!==Windows.incognito),winLen=wins.length,containerId=Windows.incognito?DEFAULT_CONTAINER_ID:PRIVATE_CONTAINER_ID;if(winLen===0&&(option.inactive=!0),winLen<=1?(Windows.incognito?(option.label=translate("menu.tab.reopen_in_norm_window"),option.icon="icon_reopen_in_norm_win"):(option.label=translate("menu.tab.reopen_in_priv_window"),option.icon="icon_reopen_in_priv_win"),option.onClick=()=>{let items=Selection.getTabsInfo(!0),pinned=items[0]?.pinned;Tabs2.reopen(items,{windowId:wins[0].id,containerId,pinned})}):(option.label=translate("menu.tab.reopen_in_window_"),Windows.incognito?option.icon="icon_reopen_in_norm_wins":option.icon="icon_reopen_in_priv_wins",option.onClick=()=>{let filter=w=>w.incognito!==Windows.incognito,items=Selection.getTabsInfo(!0),pinned=items[0]?.pinned;Tabs2.reopen(items,{windowId:ASKID,windowChooseConf:{title:option.label,otherWindows:!0,filter},containerId,pinned})}),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},reopenInCtr:()=>{if(Windows.incognito)return;let opts=[],firstTab=Tabs2.byId[Selection.getFirst()],ignoreRules=Menu.ctxMenuIgnoreContainersRules;if(firstTab){firstTab.cookieStoreId!==CONTAINER_ID&&opts.push({label:translate("menu.tab.reopen_in_default_container"),icon:"icon_ff",badge:"icon_reopen",onClick:()=>Tabs2.reopenInContainer(Selection.get(),CONTAINER_ID)});for(let c of Containers.sortContainers(Object.values(Containers.reactive.byId)))firstTab.cookieStoreId!==c.id&&(ignoreRules?.[c.id]||opts.push({label:translate("menu.tab.reopen_in_")+c.name,icon:c.icon,badge:"icon_reopen",color:c.color,onClick:()=>Tabs2.reopenInContainer(Selection.get(),c.id)}));return opts}},reopenInNewCtr:()=>{if(Windows.incognito)return;let option={label:translate("menu.tab.reopen_in_new_container"),icon:"icon_new_container",badge:"icon_reopen",onClick:()=>Tabs2.reopenTabsInNewContainer(Selection.get())};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},urlConf:()=>{let selected=Selection.get(),firstTab=Tabs2.byId[selected[0]];return firstTab?{label:translate("menu.tab.url_conf"),icon:"icon_url_conf",onClick:()=>openSiteConfigPopup(firstTab)}:void 0},openTabsInCtr:()=>{if(Windows.incognito)return;let opts=[],firstTab=Tabs2.byId[Selection.getFirst()],ignoreRules=Menu.ctxMenuIgnoreContainersRules;if(firstTab){firstTab.cookieStoreId!==CONTAINER_ID&&opts.push({label:translate("menu.tab.open_in_default_container"),icon:"icon_ff",onClick:()=>Tabs2.openInContainer(Selection.get(),CONTAINER_ID)});for(let c of Containers.sortContainers(Object.values(Containers.reactive.byId)))firstTab.cookieStoreId!==c.id&&(ignoreRules?.[c.id]||opts.push({label:translate("menu.tab.open_in_")+c.name,icon:c.icon,color:c.color,onClick:()=>Tabs2.openInContainer(Selection.get(),c.id)}));return opts}},pin:()=>{let selected=Selection.get(),firstTab=Tabs2.byId[selected[0]];if(firstTab)return{label:translate("menu.tab."+(firstTab.pinned?"unpin":"pin")),icon:"icon_pin",onClick:firstTab.pinned?()=>Tabs2.unpinTabs(selected):()=>Tabs2.pinTabs(selected)}},reload:()=>({label:translate("menu.tab.reload"),icon:"icon_reload",onClick:()=>Tabs2.reloadTabs(Selection.get())}),duplicate:()=>({label:translate("menu.tab.duplicate"),icon:"icon_duplicate",onClick:()=>Tabs2.duplicateTabs(Selection.get())}),bookmark:()=>({label:translate("menu.tab.bookmark"),icon:"icon_star",onClick:()=>Tabs2.bookmarkTabs(Selection.get())}),mute:()=>{let selected=Selection.get(),isMuted=Tabs2.byId[selected[0]]?.mutedInfo?.muted;return{label:translate("menu.tab."+(isMuted?"unmute":"mute")),icon:isMuted?"icon_loud":"icon_mute",onClick:isMuted?()=>Tabs2.unmuteTabs(selected):()=>Tabs2.muteTabs(selected)}},discard:()=>{let option={label:translate("menu.tab.discard"),icon:"icon_discard",onClick:()=>Tabs2.discardTabs(Selection.get())},firstTab=Tabs2.byId[Selection.getFirst()];if(Selection.getLength()===1&&firstTab?.discarded&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},group:()=>{let option={label:translate("menu.tab.group"),icon:"icon_group_tabs",onClick:()=>Tabs2.groupTabs(Selection.get())},firstTab=Tabs2.byId[Selection.getFirst()];if((!Settings.state.tabsTree||firstTab?.pinned)&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},flatten:()=>{let option={label:translate("menu.tab.flatten"),icon:"icon_flatten",onClick:()=>Tabs2.flattenTabs(Selection.get())},selLen=Selection.getLength();selLen<=0&&(option.inactive=!0);let firstTab=Tabs2.byId[Selection.getFirst()];if(firstTab&&(Selection.get().every(t=>firstTab.lvl===Tabs2.byId[t]?.lvl)&&(option.inactive=!0),selLen===1&&firstTab.isParent&&(option.inactive=!1),selLen===1&&firstTab.lvl>0&&(option.inactive=!1),(!Settings.state.tabsTree||firstTab.pinned)&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive)))return option},clearCookies:()=>({label:translate("menu.tab.clear_cookies"),icon:"icon_cookie",onClick:()=>Tabs2.clearTabsCookies(Selection.get())}),close:()=>{let option={label:translate("menu.tab.close"),icon:"icon_close",onClick:()=>Tabs2.removeTabs(Selection.get())};if(Tabs2.byId[Selection.getFirst()]&&!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},closeBranch:()=>{let option={label:translate("menu.tab.close_branch"),icon:"icon_rm_branch",onClick:()=>Tabs2.removeBranches(Selection.get())},firstTab=Tabs2.byId[Selection.getFirst()];if(firstTab&&(firstTab.pinned&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive)))return option},closeDescendants:()=>{let option={label:translate("menu.tab.close_descendants"),icon:"icon_rm_descendants",onClick:()=>Tabs2.removeTabsDescendants(Selection.get())};if(Selection.get().some(tabId=>{let tab=Tabs2.byId[tabId];if(!tab)return!1;let nextTab=Tabs2.list[tab.index+1];return nextTab&&nextTab.parentId===tab.id})||(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},closeTabsAbove:()=>{let option={label:translate("menu.tab.close_above"),icon:"icon_close_tabs_above",onClick:()=>Tabs2.removeTabsAbove(Selection.get())},tabId=Selection.getFirst(),tab=Tabs2.byId[tabId];if(!tab)return;let prevTab=Tabs2.list[tab.index-1];if((!tab||tab.pinned)&&(option.inactive=!0),(!prevTab||prevTab.panelId!==tab.panelId||prevTab.pinned)&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},closeTabsBelow:()=>{let option={label:translate("menu.tab.close_below"),icon:"icon_close_tabs_below",onClick:()=>Tabs2.removeTabsBelow(Selection.get())},tabId=Selection.getFirst(),tab=Tabs2.byId[tabId];if(!tab)return;let nextTab=Tabs2.list[tab.index+1];if((!tab||tab.pinned)&&(option.inactive=!0),(!nextTab||nextTab.panelId!==tab.panelId)&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},closeOtherTabs:()=>{let option={label:translate("menu.tab.close_other"),icon:"icon_close_other_tabs",onClick:()=>Tabs2.removeOtherTabs(Selection.get())},tabId=Selection.getFirst(),tab=Tabs2.byId[tabId];if((!tab||tab.pinned)&&(option.inactive=!0),tab){let panel=Sidebar.panelsById[tab.panelId];(!panel||panel.reactive.len===1)&&(option.inactive=!0)}if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},copyTabsUrls:()=>{let selected=Selection.get();return{label:translate("menu.copy_urls",selected.length),icon:"icon_link",badge:"icon_copy_badge",onClick:()=>Tabs2.copyUrls(selected)}},copyTabsTitles:()=>{let selected=Selection.get();return{label:translate("menu.copy_titles",selected.length),icon:"icon_title",badge:"icon_copy_badge",onClick:()=>Tabs2.copyTitles(selected)}},colorizeTab:()=>{let opts=[],selected=Selection.get(),usedColor;selected.length===1&&(usedColor=Tabs2.byId[selected[0]]?.customColor??"toolbar");for(let color of COLOR_OPTS){if(usedColor&&usedColor===color.color)continue;let title=translate("colors."+color.color);opts.push({label:title,color:color.color,icon:color.value==="toolbar"?"icon_none":"circle",onClick:()=>Tabs2.setCustomColor(selected,color.value)})}if(opts.length)return opts},editTabTitle:()=>{let selected=Selection.get(),firstTab=Tabs2.byId[selected[0]];if(!firstTab)return;let option={label:translate("menu.tab.edit_title"),icon:"icon_edit",onClick:()=>Tabs2.editTabTitle(Selection.get())};if(firstTab.pinned&&(option.inactive=!Settings.state.pinnedTabsList||Settings.state.pinnedTabsPosition==="left"||Settings.state.pinnedTabsPosition==="right"),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortTabsByTitleAscending:()=>{let option={label:translate("menu.tab.sort_by_title_asc"),icon:"icon_sort_name_asc",onClick:()=>sort(1,Selection.get(),1),onAltClick:()=>sort(1,Selection.get(),1,!0)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortTabsByTitleDescending:()=>{let option={label:translate("menu.tab.sort_by_title_des"),icon:"icon_sort_name_des",onClick:()=>sort(1,Selection.get(),-1),onAltClick:()=>sort(1,Selection.get(),-1,!0)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortTabsByUrlAscending:()=>{let option={label:translate("menu.tab.sort_by_url_asc"),icon:"icon_sort_url_asc",onClick:()=>sort(2,Selection.get(),1),onAltClick:()=>sort(2,Selection.get(),1,!0)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortTabsByUrlDescending:()=>{let option={label:translate("menu.tab.sort_by_url_des"),icon:"icon_sort_url_des",onClick:()=>sort(2,Selection.get(),-1),onAltClick:()=>sort(2,Selection.get(),-1,!0)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortTabsByAccessTimeAscending:()=>{let option={label:translate("menu.tab.sort_by_time_asc"),icon:"icon_sort_time_asc",onClick:()=>sort(3,Selection.get(),1),onAltClick:()=>sort(3,Selection.get(),1,!0)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortTabsByAccessTimeDescending:()=>{let option={label:translate("menu.tab.sort_by_time_des"),icon:"icon_sort_time_des",onClick:()=>sort(3,Selection.get(),-1),onAltClick:()=>sort(3,Selection.get(),-1,!0)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortTabsTreeByTitleAscending:()=>{let ids=Selection.get(),option={label:translate("menu.tab.sort_tree_by_title_asc"),icon:"icon_sort_name_asc",onClick:()=>sort(1,ids,1,!0)};if(ids.length===1&&!Tabs2.byId[ids[0]]?.isParent&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortTabsTreeByTitleDescending:()=>{let ids=Selection.get(),option={label:translate("menu.tab.sort_tree_by_title_des"),icon:"icon_sort_name_des",onClick:()=>sort(1,ids,-1,!0)};if(ids.length===1&&!Tabs2.byId[ids[0]]?.isParent&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortTabsTreeByUrlAscending:()=>{let ids=Selection.get(),option={label:translate("menu.tab.sort_tree_by_url_asc"),icon:"icon_sort_url_asc",onClick:()=>sort(2,ids,1,!0)};if(ids.length===1&&!Tabs2.byId[ids[0]]?.isParent&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortTabsTreeByUrlDescending:()=>{let ids=Selection.get(),option={label:translate("menu.tab.sort_tree_by_url_des"),icon:"icon_sort_url_des",onClick:()=>sort(2,ids,-1,!0)};if(ids.length===1&&!Tabs2.byId[ids[0]]?.isParent&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortTabsTreeByAccessTimeAscending:()=>{let ids=Selection.get(),option={label:translate("menu.tab.sort_tree_by_time_asc"),icon:"icon_sort_time_asc",onClick:()=>sort(3,ids,1,!0)};if(ids.length===1&&!Tabs2.byId[ids[0]]?.isParent&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortTabsTreeByAccessTimeDescending:()=>{let ids=Selection.get(),option={label:translate("menu.tab.sort_tree_by_time_des"),icon:"icon_sort_time_des",onClick:()=>sort(3,ids,-1,!0)};if(ids.length===1&&!Tabs2.byId[ids[0]]?.isParent&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},selectAllTabs:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let ids=panel.tabs.map(t=>t.id),option={label:translate("menu.tabs_panel.sel_all"),icon:"icon_sel_all",onClick:async()=>{await sleep(32),document.body.focus(),Selection.selectTabs(ids)}};if(ids.length||(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},muteAllAudibleTabs:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let tabIds=[];panel.pinnedTabs.forEach(t=>t.audible&&tabIds.push(t.id)),panel.tabs.forEach(t=>t.audible&&tabIds.push(t.id));let option={label:translate("menu.tabs_panel.mute_all_audible"),icon:"icon_mute",onClick:()=>Tabs2.muteTabs(tabIds)};if(tabIds.length||(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},closeTabsDuplicates:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let tabIds=(panel.tabs??[]).map(t=>t.id),option={label:translate("menu.tabs_panel.dedup"),icon:"icon_dedup_tabs",onClick:()=>Tabs2.dedupTabs(tabIds)};if(tabIds.length||(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},reloadTabs:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let tabIds=(panel.tabs??[]).map(t=>t.id),option={label:translate("menu.tabs_panel.reload"),icon:"icon_reload",onClick:()=>Tabs2.reloadTabs(tabIds)};if(tabIds.length||(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},discardTabs:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let tabIds=[];panel.pinnedTabs.forEach(t=>tabIds.push(t.id)),panel.tabs.forEach(t=>tabIds.push(t.id));let option={label:translate("menu.tabs_panel.discard"),icon:"icon_discard",onClick:()=>Tabs2.discardTabs(tabIds)};if(tabIds.length||(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},closeTabs:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let tabIds=(panel.tabs??[]).map(t=>t.id),option={label:translate("menu.tabs_panel.close"),icon:"icon_close",onClick:()=>Tabs2.removeTabs(tabIds)};if(tabIds.length||(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},collapseInactiveBranches:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel)||!Settings.state.tabsTree)return;let panelTabs=panel.tabs??[],option={label:translate("menu.tabs_panel.collapse_inact_branches"),icon:"icon_collapse_all",onClick:()=>{let tabs=[];for(let rTab of panelTabs){let tab=Tabs2.byId[rTab.id];tab&&tab.lvl===0&&tabs.push(tab)}Tabs2.foldAllInactiveBranches(tabs)}};if(panelTabs.length<3&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},bookmarkTabsPanel:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];return isTabsPanel(panel)?{label:translate("menu.tabs_panel.bookmark"),icon:"icon_star",badge:"icon_move_badge",onClick:()=>{Sidebar.bookmarkTabsPanel(panel.id,!0).catch(err3=>{err3!==2&&err("Menu.bookmarkTabsPanel",err3)})},onAltClick:()=>{Sidebar.bookmarkTabsPanel(panel.id).catch(err3=>{err3!==2&&err("Menu.bookmarkTabsPanel",err3)})}}:void 0},restoreFromBookmarks:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let option={label:translate("menu.tabs_panel.restore_from_bookmarks"),icon:"icon_star",badge:"icon_move_out_badge",onClick:()=>{Sidebar.restoreFromBookmarks(panel).catch(err3=>{err3!==2&&err("Menu.restoreFromBookmarks",err3)})}};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},convertToBookmarksPanel:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];return isTabsPanel(panel)?{label:translate("menu.tabs_panel.convert_to_bookmarks_panel"),icon:"icon_star",badge:"icon_reopen",onClick:()=>Sidebar.convertToBookmarksPanel(panel)}:void 0},sortAllTabsByTitleAscending:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let ids=panel.tabs.map(t=>t.id),option={label:translate("menu.tabs_panel.sort_all_by_title_asc"),icon:"icon_sort_name_asc",inactive:ids.length<2,onClick:()=>sort(1,ids,1,!0)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortAllTabsByTitleDescending:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let ids=panel.tabs.map(t=>t.id),option={label:translate("menu.tabs_panel.sort_all_by_title_des"),icon:"icon_sort_name_des",inactive:ids.length<2,onClick:()=>sort(1,ids,-1,!0)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortAllTabsByUrlAscending:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let ids=panel.tabs.map(t=>t.id),option={label:translate("menu.tabs_panel.sort_all_by_url_asc"),icon:"icon_sort_url_asc",inactive:ids.length<2,onClick:()=>sort(2,ids,1,!0)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortAllTabsByUrlDescending:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let ids=panel.tabs.map(t=>t.id),option={label:translate("menu.tabs_panel.sort_all_by_url_des"),icon:"icon_sort_url_des",inactive:ids.length<2,onClick:()=>sort(2,ids,-1,!0)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortAllTabsByAccessTimeAscending:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let ids=panel.tabs.map(t=>t.id),option={label:translate("menu.tabs_panel.sort_all_by_time_asc"),icon:"icon_sort_time_asc",inactive:ids.length<2,onClick:()=>sort(3,ids,1,!0)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortAllTabsByAccessTimeDescending:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let ids=panel.tabs.map(t=>t.id),option={label:translate("menu.tabs_panel.sort_all_by_time_des"),icon:"icon_sort_time_des",inactive:ids.length<2,onClick:()=>sort(3,ids,-1,!0)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option}};var bookmarksMenuOptions={openInNewWin:()=>{let allSeparators=Selection.get().every(id=>Bookmarks.reactive.byId[id]?.type==="separator"),option={label:translate("menu.bookmark.open_in_new_window"),icon:"icon_new_win",onClick:()=>Bookmarks.openInNewWindow(Selection.get())};if(allSeparators&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},openInNewPrivWin:()=>{let allSeparators=Selection.get().every(id=>Bookmarks.reactive.byId[id]?.type==="separator"),option={label:translate("menu.bookmark.open_in_new_priv_window"),icon:"icon_new_priv_win",onClick:()=>Bookmarks.openInNewWindow(Selection.get(),!0)};if(allSeparators&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},openInNewPanel:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let allSeparators=Selection.get().every(id=>Bookmarks.reactive.byId[id]?.type==="separator"),option={label:translate("menu.bookmark.open_in_new_panel"),icon:"icon_add_tabs_panel",onClick:()=>Bookmarks.openInNewPanel(Selection.get()),onAltClick:()=>Bookmarks.openAsTabsPanel(node,!1)};if(allSeparators&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},openInPanel:()=>{if(!Bookmarks.reactive.byId[Selection.getFirst()])return;let allSeparators=Selection.get().every(id=>Bookmarks.reactive.byId[id]?.type==="separator");if(allSeparators&&!Settings.state.ctxMenuRenderInact)return;let opts=[];for(let p of Sidebar.panels)isTabsPanel(p)&&opts.push({label:translate("menu.bookmark.open_in_")+p.name,icon:p.iconSVG,img:p.iconIMG,color:p.color,inactive:allSeparators,onClick:()=>Bookmarks.open(Selection.get(),{panelId:p.id})});return opts},openInCtr:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let allSeparators=Selection.get().every(id=>Bookmarks.reactive.byId[id]?.type==="separator");if(allSeparators&&!Settings.state.ctxMenuRenderInact)return;let opts=[];if((node.type==="folder"||Selection.getLength()>1)&&opts.push({label:translate("menu.bookmark.open_in_default_ctr"),icon:"icon_ffm",inactive:allSeparators,onClick:()=>Bookmarks.open(Selection.get(),{containerId:CONTAINER_ID})}),!Windows.incognito){let ignoreRules=Menu.ctxMenuIgnoreContainersRules;for(let c of Containers.sortContainers(Object.values(Containers.reactive.byId)))ignoreRules?.[c.id]||opts.push({label:translate("menu.bookmark.open_in_")+c.name,icon:c.icon,color:c.color,inactive:allSeparators,onClick:()=>Bookmarks.open(Selection.get(),{containerId:c.id})})}return opts},createBookmark:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.create_bookmark"),icon:"icon_create_bookmark",onClick:()=>Bookmarks.createBookmarkNode("bookmark",node)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},createFolder:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.create_folder"),icon:"icon_create_folder",onClick:()=>Bookmarks.createBookmarkNode("folder",node)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},createSeparator:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.create_separator"),icon:"icon_create_separator",onClick:()=>Bookmarks.createBookmarkNode("separator",node)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortByNameAscending:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.sort_by_name_asc"),icon:"icon_sort_name_asc",onClick:()=>Bookmarks.sortBookmarks("name",Selection.get(),1)};if(Selection.getLength()===1&&node.type!=="folder"&&(option.inactive=!0),Search.reactive.value&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortByNameDescending:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.sort_by_name_des"),icon:"icon_sort_name_des",onClick:()=>Bookmarks.sortBookmarks("name",Selection.get(),-1)};if(Selection.getLength()===1&&node.type!=="folder"&&(option.inactive=!0),Search.reactive.value&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortByLinkAscending:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.sort_by_link_asc"),icon:"icon_sort_url_asc",onClick:()=>Bookmarks.sortBookmarks("link",Selection.get(),1)};if(Selection.getLength()===1&&node.type!=="folder"&&(option.inactive=!0),Search.reactive.value&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortByLinkDescending:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.sort_by_link_des"),icon:"icon_sort_url_des",onClick:()=>Bookmarks.sortBookmarks("link",Selection.get(),-1)};if(Selection.getLength()===1&&node.type!=="folder"&&(option.inactive=!0),Search.reactive.value&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortByTimeAscending:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.sort_by_time_asc"),icon:"icon_sort_time_asc",onClick:()=>Bookmarks.sortBookmarks("time",Selection.get(),1)};if(Selection.getLength()===1&&node.type!=="folder"&&(option.inactive=!0),Search.reactive.value&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},sortByTimeDescending:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.sort_by_time_des"),icon:"icon_sort_time_des",onClick:()=>Bookmarks.sortBookmarks("time",Selection.get(),-1)};if(Selection.getLength()===1&&node.type!=="folder"&&(option.inactive=!0),Search.reactive.value&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},edit:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.edit_bookmark"),icon:"icon_edit",onClick:()=>Bookmarks.editBookmarkNode(node)};if(Selection.getLength()>1&&(option.inactive=!0),node.type==="separator"&&(option.inactive=!0),node.parentId==="root________"&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},delete:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.delete_bookmark"),icon:"icon_close",onClick:()=>Bookmarks.removeBookmarks(Selection.get())};if(node.parentId==="root________"&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},openAsBookmarksPanel:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.open_as_bookmarks_panel"),icon:"icon_bookmarks",onClick:()=>Bookmarks.openAsBookmarksPanel(node)};if(node.type!=="folder"&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},openAsTabsPanel:()=>{let node=Bookmarks.reactive.byId[Selection.getFirst()];if(!node)return;let option={label:translate("menu.bookmark.open_as_tabs_panel"),icon:"icon_tabs",onClick:()=>Bookmarks.openAsTabsPanel(node,!0)};if(node.type!=="folder"&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},copyBookmarksUrls:()=>{let selected=Selection.get(),firstNode=Bookmarks.reactive.byId[selected[0]],len=selected.length;firstNode.children?.length&&(len+=firstNode.children.length);let option={label:translate("menu.copy_urls",len),icon:"icon_link",badge:"icon_copy_badge",onClick:()=>Bookmarks.copyUrls(selected)};if(selected.length===1&&firstNode?.type==="separator"&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},copyBookmarksTitles:()=>{let selected=Selection.get(),firstNode=Bookmarks.reactive.byId[selected[0]],len=selected.length;firstNode.children?.length&&(len+=firstNode.children.length);let option={label:translate("menu.copy_titles",len),icon:"icon_title",badge:"icon_copy_badge",onClick:()=>Bookmarks.copyTitles(selected)};if(selected.length===1&&firstNode?.type==="separator"&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},moveBookmarksTo:()=>{let ids=Selection.get(),option={label:translate("menu.bookmark.move_to"),icon:"icon_move",onClick:()=>Bookmarks.move(ids,{})};if(ids.some(id=>Bookmarks.reactive.byId[id]?.parentId===BKM_ROOT_ID)&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},collapseAllFolders:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!panel||!Bookmarks.reactive.tree.length)return;let option={label:translate("menu.bookmark.collapse_all"),icon:"icon_collapse_all",onClick:()=>Bookmarks.collapseAllBookmarks(panel.id)};if(isBookmarksPanel(panel)&&panel.viewMode!=="tree"&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},switchViewMode:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isBookmarksPanel(panel)||!Bookmarks.reactive.tree.length)return;let isTree=panel.viewMode==="tree",label;panel.viewMode==="tree"?label=translate("menu.bookmark.switch_view_history"):label=translate("menu.bookmark.switch_view_tree"),translate("menu.bookmark.switch_view_tree");let option={label,icon:isTree?"icon_clock":"icon_tree_struct",onClick:()=>Sidebar.setViewMode(panel,isTree?"history":"tree")};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},convertToTabsPanel:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isBookmarksPanel(panel))return;let option={label:translate("menu.bookmark.convert_to_tabs_panel"),icon:"icon_tabs",badge:"icon_reopen",onClick:()=>Sidebar.convertToTabsPanel(panel,!0)};if(panel.rootId===BKM_ROOT_ID&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option}};var historyMenuOptions={open:()=>({label:translate("menu.history.open"),icon:"icon_reopen",onClick:()=>{let firstId=Selection.getFirst(),target=(History.filtered??History.visits).find(v=>v.id===firstId);target&&History.open(target,{panelId:Sidebar.getRecentTabsPanelId()},!1,!0)}}),copyHistoryUrls:()=>{let selected=Selection.get();return{label:translate("menu.copy_urls",selected.length),icon:"icon_link",badge:"icon_copy_badge",onClick:()=>History.copyUrls(selected)}},copyHistoryTitles:()=>{let selected=Selection.get();return{label:translate("menu.copy_titles",selected.length),icon:"icon_title",badge:"icon_copy_badge",onClick:()=>History.copyTitles(selected)}},deleteVisits:()=>{let selected=Selection.get();return{label:translate("menu.history.delete_visits",selected.length),icon:"icon_clock",badge:"icon_close",keepSearching:!0,onClick:()=>History.deleteVisits(selected)}},deleteSites:()=>{let selected=Selection.get();return{label:translate("menu.history.delete_sites",selected.length),icon:"icon_web",badge:"icon_close",keepSearching:!0,onClick:async()=>{await History.deleteSites(selected),Search.rawValue&&Search.search()}}}};var menuOptions={...tabsMenuOptions,...bookmarksMenuOptions,...historyMenuOptions,openPanelConfig:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!panel)return;let inSidebar=isTabsPanel(panel)||isBookmarksPanel(panel),option={label:translate("menu.common.conf"),tooltip:translate("menu.common.conf_tooltip"),icon:"icon_panel_config",onClick:()=>SetupPage.open(`settings_nav.${panel.id}`),onAltClick:()=>{inSidebar?openPanelPopup({id:panel.id}):SetupPage.open(`settings_nav.${panel.id}`)}};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},openPanelConfigInSidebar:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!panel)return;let inSidebar=isTabsPanel(panel)||isBookmarksPanel(panel),option={label:translate("menu.common.conf_in_sidebar"),icon:"icon_panel_config",onClick:()=>{inSidebar?openPanelPopup({id:panel.id}):SetupPage.open(`settings_nav.${panel.id}`)}};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},unloadPanelType:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!panel)return;let option={label:translate("menu.panels.unload"),icon:"icon_discard",onClick:()=>Sidebar.unloadPanelType(panel.type)};if(panel.ready||(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},hidePanel:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!panel)return;let option={label:translate("menu.panels.hide_panel"),icon:"icon_hide",onClick:()=>Sidebar.hidePanel(panel.id)};if(panel.hidden&&(option.inactive=!0),!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},removePanel:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!panel)return;let option={label:translate("menu.tabs_panel.remove_panel"),icon:"icon_close",onClick:()=>Sidebar.removePanel(panel.id)};if(!(!Settings.state.ctxMenuRenderInact&&option.inactive))return option},newTabNoContainer:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(panel)return{label:translate("menu.new_tab_bar.no_container"),icon:"icon_plus",onClick:()=>Tabs2.createTabInPanel(panel,{cookieStoreId:CONTAINER_ID}),onAltClick:()=>{if(Settings.state.newTabMiddleClickAction==="new_child"){let actTab=Tabs2.byId[Tabs2.activeId];actTab&&!actTab.pinned&&actTab.panelId===panel.id?Tabs2.createChildTab(actTab.id):Tabs2.createTabInPanel(panel)}else if(Settings.state.newTabMiddleClickAction==="reopen"){let dst={containerId:CONTAINER_ID,panelId:panel.id};Tabs2.reopen(Tabs2.getTabsInfo([Tabs2.activeId]),dst)}}}},newTabContainers:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];if(!isTabsPanel(panel))return;let opts=[],ignoreRules=Menu.ctxMenuIgnoreContainersRules;for(let c of Containers.sortContainers(Object.values(Containers.reactive.byId)))ignoreRules?.[c.id]||opts.push({label:c.name,icon:c.icon,color:c.color,flag:{active:panel.newTabBtns.includes(c.name),icon:"#icon_pin",onClick:opt=>{let index=panel.newTabBtns.indexOf(c.name);index!==-1?(panel.newTabBtns.splice(index,1),opt.flag?.active&&(opt.flag.active=!1)):(panel.newTabBtns.push(c.name),opt.flag&&(opt.flag.active=!0)),panel.reactive.newTabBtns=cloneArray(panel.newTabBtns),Sidebar.saveSidebar(500)}},onClick:()=>Tabs2.createTabInPanel(panel,{cookieStoreId:c.id}),onAltClick:()=>{if(Settings.state.newTabMiddleClickAction==="new_child"){let actTab=Tabs2.byId[Tabs2.activeId];actTab&&!actTab.pinned&&actTab.panelId===panel.id?Tabs2.createChildTab(actTab.id,void 0,c.id):Tabs2.createTabInPanel(panel,{cookieStoreId:c.id})}else if(Settings.state.newTabMiddleClickAction==="reopen"){let dst={containerId:c.id,panelId:panel.id};Tabs2.reopen(Tabs2.getTabsInfo([Tabs2.activeId]),dst)}}});return opts},newTabNewContainer:()=>{if(Sidebar.panelsById[Selection.getFirst()])return{label:translate("menu.new_tab_bar.new_container"),icon:"icon_new_container",onClick:()=>Tabs2.createTabInNewContainer()}},manageShortcuts:()=>{let panel=Sidebar.panelsById[Selection.getFirst()];return{label:translate("menu.new_tab_bar.manage_shortcuts"),icon:"icon_pin",onClick:()=>openNewTabShortcutsPopup(panel)}},manageContainers:()=>({label:translate("menu.new_tab_bar.manage_containers"),icon:"icon_settings",onClick:()=>SetupPage.open("settings_containers")})};var openCallbacks=[],closeCallbacks=[],xmlSerializer=new XMLSerializer,ctxMenuBlockTimeout;async function loadCtxMenu(){let storage=await browser.storage.local.get("contextMenu");storage.contextMenu?.tabs?.length?Menu.tabsConf=storage.contextMenu.tabs:Menu.tabsConf=cloneArray(TABS_MENU),storage.contextMenu?.tabsPanel?.length?Menu.tabsPanelConf=storage.contextMenu.tabsPanel:Menu.tabsPanelConf=cloneArray(TABS_PANEL_MENU),storage.contextMenu?.bookmarks?.length?Menu.bookmarksConf=storage.contextMenu.bookmarks:Menu.bookmarksConf=cloneArray(BOOKMARKS_MENU),storage.contextMenu?.bookmarksPanel?.length?Menu.bookmarksPanelConf=storage.contextMenu.bookmarksPanel:Menu.bookmarksPanelConf=cloneArray(BOOKMARKS_PANEL_MENU)}function upgradeMenuConf(oldConf){let conf=[];for(let oldOpt of oldConf)if(typeof oldOpt=="string")conf.push(oldOpt);else{let name="",opts=[];oldOpt.forEach(opt=>{typeof opt=="string"?opts.push(opt):opt.name&&(name=opt.name)}),conf.push({name,opts})}return conf}function saveCtxMenu(delay){let storage={contextMenu:{tabs:cloneArray(Menu.tabsConf),tabsPanel:cloneArray(Menu.tabsPanelConf),bookmarks:cloneArray(Menu.bookmarksConf),bookmarksPanel:cloneArray(Menu.bookmarksPanelConf)}};Store.set(storage,delay),Settings.state.syncSaveCtxMenu&&saveCtxMenuToSync()}async function saveCtxMenuToSync(){let contextMenu={};Menu.tabsConf&&(contextMenu.tabs=Menu.tabsConf),Menu.tabsPanelConf&&(contextMenu.tabsPanel=Menu.tabsPanelConf),Menu.bookmarksConf&&(contextMenu.bookmarks=Menu.bookmarksConf),Menu.bookmarksPanelConf&&(contextMenu.bookmarksPanel=Menu.bookmarksPanelConf);let value=cloneObject({contextMenu});await Store.sync("ctxMenu",value)}function createSettingsMenu(){browser.menus.create({id:"open_settings",title:translate("menu.browserAction.open_settings"),icons:{16:"assets/logo-native.svg"},onclick:()=>browser.runtime.openOptionsPage(),contexts:["browser_action"]}),browser.menus.create({id:"create_snapshot",title:translate("menu.browserAction.create_snapshot"),icons:{16:"assets/snapshot-native.svg"},onclick:()=>Snapshots.createSnapshot(),contexts:["browser_action"]})}function onMenuHiddenFg(){Selection.resetSelection()}function onMenuHiddenBg(){browser.menus.removeAll(),createSettingsMenu()}function setupListeners6(){Info.isBg?browser.menus.onHidden.addListener(onMenuHiddenBg):(browser.menus.onHidden.addListener(onMenuHiddenFg),Store.onKeyChange("contextMenu",menuConfigs=>{menuConfigs?.tabs?.length?Menu.tabsConf=menuConfigs.tabs:Menu.tabsConf=cloneArray(TABS_MENU),menuConfigs?.tabsPanel?.length?Menu.tabsPanelConf=menuConfigs.tabsPanel:Menu.tabsPanelConf=cloneArray(TABS_PANEL_MENU),menuConfigs?.bookmarks?.length?Menu.bookmarksConf=menuConfigs.bookmarks:Menu.bookmarksConf=cloneArray(BOOKMARKS_MENU),menuConfigs?.bookmarksPanel?.length?Menu.bookmarksPanelConf=menuConfigs.bookmarksPanel:Menu.bookmarksPanelConf=cloneArray(BOOKMARKS_PANEL_MENU)}))}function resetListeners4(){Info.isBg?browser.menus.onHidden.removeListener(onMenuHiddenBg):browser.menus.onHidden.removeListener(onMenuHiddenFg)}function isBlocked(){return!!ctxMenuBlockTimeout}function open5(type,x,y,customForced){if(!Selection.isSet())return;if(Mouse.isLocked())return Mouse.resetClickLock();if(!type)return;let nodeType="all",blocks;if(type===1?(nodeType="tab",blocks=createMenuBlocks(Menu.tabsConf,customForced),Settings.state.previewTabs&&closePreview()):type===2?(nodeType="bookmark",blocks=createMenuBlocks(Menu.bookmarksConf,customForced)):type===3?blocks=createMenuBlocks(HISTORY_MENU,customForced):type===6?blocks=createMenuBlocks(NEW_TAB_MENU,customForced):type===7?blocks=createMenuBlocks(Menu.tabsPanelConf,customForced):type===8?blocks=createMenuBlocks(Menu.bookmarksPanelConf,customForced):type===9&&(blocks=createMenuBlocks(OTHER_PANELS_MENU,customForced)),!!blocks?.length){if(Menu.isOpen=!0,Settings.state.ctxMenuNative&&!customForced){for(let block of blocks)for(let opt of block.opts)if(opt.sub&&opt.sub.length&&opt.label){let parentId=createNativeSubMenuOption(opt.label,nodeType);for(let subOpt of opt.sub)createNativeOption(nodeType,subOpt,parentId)}else createNativeOption(nodeType,opt);resetNativeMenu(120);return}for(let cb of openCallbacks)cb(blocks,x,y)}}function createOption(optName,prevOpt){let gen=menuOptions[optName];if(gen)return gen();if(optName.startsWith("separator"))return prevOpt?.type==="separator"?void 0:{type:"separator"}}function createMenuBlocks(config,customForced){let blocks=[],block,prevOpt;for(let optConf of config)if(typeof optConf=="string"){block||(block={type:"list",opts:[]},blocks.push(block));let opt=createOption(optConf,prevOpt);opt&&(block.opts=block.opts.concat(opt),prevOpt=block.opts[block.opts.length-1])}else{let opts=optConf.opts.reduce((a,subOpt)=>{let opt=createOption(subOpt,prevOpt);if(opt){let aOpts=a.concat(opt);return prevOpt=aOpts[aOpts.length-1],aOpts}return a},[]);if(optConf.name){block||(block={type:"list",opts:[]},blocks.push(block));let name=optConf.name?.startsWith("%")?translate(optConf.name.slice(1)):optConf.name,allInactive=!0;for(let opt of opts)opt.label?.startsWith(name)&&(opt.label=shrinkLabel(name,opt.label)??opt.label),allInactive&&!opt.inactive&&opt.type!=="separator"&&(allInactive=!1);block.opts.push({label:name,sub:opts,inactive:allInactive})}else blocks.push({type:"inline",opts}),block=void 0}return(!Settings.state.ctxMenuNative||customForced)&&(blocks=blocks.reduce((blocks2,block2)=>(block2.opts.length===0||block2.opts.length===1&&block2.opts[0].type==="separator"||(block2.type==="list"&&(block2.opts[0].type==="separator"&&block2.opts.shift(),block2.opts[block2.opts.length-1].type==="separator"&&block2.opts.pop()),blocks2.push(block2)),blocks2),[])),blocks}function shrinkLabel(parentLabel,label){if(!label||label.length-parentLabel.length<2||LANG==="zh")return;let cutIndex=parentLabel.length,capitalizeNeeded=!1;return label[cutIndex]===":"&&cutIndex++,label[cutIndex]===" "&&(cutIndex++,capitalizeNeeded=!0),capitalizeNeeded?label=label[cutIndex].toUpperCase()+label.slice(cutIndex+1):label=label.slice(cutIndex).trim(),label}var base64SvgIconsCache={};function getBase64SVGIcon(icon,rgbColor){let cachedIcons=base64SvgIconsCache[icon];cachedIcons||(base64SvgIconsCache[icon]={},cachedIcons=base64SvgIconsCache[icon]);let cached=cachedIcons[rgbColor];if(cached)return cached;let svgIconEl=document.getElementById(icon);if(svgIconEl){let svg=xmlSerializer.serializeToString(svgIconEl);return svg='<svg fill="'+rgbColor+'" '+svg.slice(5),icon="data:image/svg+xml;base64,"+window.btoa(svg),cachedIcons[rgbColor]=icon,icon}}function createNativeOption(ctx,option,parentId){if(ctx||(ctx="all"),option.type==="separator"){browser.menus.create({type:"separator",contexts:[ctx],parentId});return}let icon;if(Settings.state.ctxMenuRenderIcons){if(option.img)icon=option.img;else if(option.icon){let alpha=option.inactive?"64":"ff",rgbColor=option.color?RGB_COLORS[option.color]:"#686868"+alpha;icon=getBase64SVGIcon(option.icon,rgbColor)}}let optProps={type:"normal",contexts:[ctx],viewTypes:["sidebar"],title:option.label};parentId&&(optProps.parentId=parentId),option.inactive&&(optProps.enabled=!1),icon&&(optProps.icons={16:icon}),optProps.onclick=()=>{option.onClick&&option.onClick(),Selection.resetSelection(),Search.stop()},browser.menus.create(optProps)}function createNativeSubMenuOption(title,ctx){ctx||(ctx="all");let optProps={type:"normal",contexts:[ctx],viewTypes:["sidebar"],title};return browser.menus.create(optProps)}function close2(){Menu.isOpen&&(closeCallbacks.forEach(cb=>cb()),Menu.isOpen=!1)}var resetNativeMenu=debounce(()=>{Menu.isOpen=!1});function blockCtxMenu(){ctxMenuBlockTimeout&&(clearTimeout(ctxMenuBlockTimeout),ctxMenuBlockTimeout=void 0),ctxMenuBlockTimeout=setTimeout(()=>{ctxMenuBlockTimeout=void 0},500)}function onOpen(cb){openCallbacks.push(cb)}function onClose(cb){closeCallbacks.push(cb)}function parseContainersRules(){if(Menu.ctxMenuIgnoreContainersRules={},!Settings.state.ctxMenuIgnoreContainers)return;let rules=getContainersRules(Settings.state.ctxMenuIgnoreContainers);if(rules)for(let container of Object.values(Containers.reactive.byId)){let ignore=checkCtxMenuContainer(container,rules);Menu.ctxMenuIgnoreContainersRules[container.id]=ignore}}function getContainersRules(value){if(!value)return null;let rules=[];try{let rawRules=value.split(",");for(let rule of rawRules)rule=rule.trim(),rule&&(rule.startsWith("/")&&rule.endsWith("/")?rules.push(new RegExp(rule.slice(1,-1))):rules.push(rule))}catch{return null}return rules.length?rules:null}function checkCtxMenuContainer(container,rules){if(!container||!rules)return!1;let value=!1;for(let rule of rules)if(isRegExp(rule)?value=rule.test(container.name):value=rule===container.name,value)return value;return value}function selectOption(dir){componentInstance&&componentInstance.selectOption(dir)}function activateOption(){if(componentInstance)return componentInstance.activateOption()}var componentInstance=null;function registerComponent(instance){componentInstance=instance}var Menu={isOpen:!1,tabsConf:[],bookmarksConf:[],tabsPanelConf:[],bookmarksPanelConf:[],ctxMenuIgnoreContainersRules:{},...menu_actions_exports};async function load4(){if(Info.isBg){let[ffContainers,storage]=await Promise.all([browser.contextualIdentities.query({}),browser.storage.local.get("containers")]),containers=storage.containers??{},saveNeeded=!1;for(let ffContainer of ffContainers){let container=containers[ffContainer.cookieStoreId];container||(container=cloneObject(DEFAULT_CONTAINER),containers[ffContainer.cookieStoreId]=container,saveNeeded||(saveNeeded=!0)),container.cookieStoreId=ffContainer.cookieStoreId,container.id=ffContainer.cookieStoreId,container.name=ffContainer.name,container.icon=ffContainer.icon,container.color=ffContainer.color}for(let id of Object.keys(containers)){let container=containers[id];if(!ffContainers.find(c=>c.cookieStoreId===container.id)){let conf={name:container.name,color:container.color,icon:container.icon},newFFContainer=await browser.contextualIdentities.create(conf);delete containers[id],container.id=newFFContainer.cookieStoreId,container.cookieStoreId=newFFContainer.cookieStoreId,containers[container.id]=container,saveNeeded||(saveNeeded=!0)}normalizeObject(container,DEFAULT_CONTAINER),updateReopeningRules(container)&&!saveNeeded&&(saveNeeded=!0)}Containers.reactive.byId=containers,saveNeeded&&Containers.saveContainers()}else{let storage=await browser.storage.local.get("containers");storage.containers&&(Containers.reactive.byId=storage.containers,Menu.parseContainersRules())}}function updateReopeningRules(container){container.reopenRules||(container.reopenRules=[]),container.reopenRulesActive===void 0&&(container.reopenRulesActive=!1);let saveNeeded=!1,initiallyEmpty=container.reopenRules.length===0;if(container.includeHosts){let active=!!container.includeHostsActive;for(let rawRule of container.includeHosts.split(`
`)){let ruleStr=rawRule.trim();ruleStr&&(container.reopenRules.push({id:uid(),active,type:1,url:ruleStr}),saveNeeded||(saveNeeded=!0))}}if(container.includeHosts!==void 0&&delete container.includeHosts,container.includeHostsActive!==void 0&&delete container.includeHostsActive,container.excludeHosts){let active=!!container.excludeHostsActive;for(let rawRule of container.excludeHosts.split(`
`)){let ruleStr=rawRule.trim();ruleStr&&(container.reopenRules.push({id:uid(),active,type:2,url:ruleStr}),saveNeeded||(saveNeeded=!0))}}return container.excludeHosts!==void 0&&delete container.excludeHosts,container.excludeHostsActive!==void 0&&delete container.excludeHostsActive,initiallyEmpty&&container.reopenRules.length>0&&(container.reopenRulesActive=!0),saveNeeded}function upgradeReopeningRules(oldCtr,newCtr){if(oldCtr.includeHosts){let active=!!oldCtr.includeHostsActive;for(let rawRule of oldCtr.includeHosts.split(`
`)){let ruleStr=rawRule.trim();ruleStr&&(newCtr.reopenRules.push({id:uid(),active,type:1,url:ruleStr}),newCtr.reopenRulesActive||(newCtr.reopenRulesActive=!0))}}if(oldCtr.excludeHosts){let active=!!oldCtr.excludeHostsActive;for(let rawRule of oldCtr.excludeHosts.split(`
`)){let ruleStr=rawRule.trim();ruleStr&&(newCtr.reopenRules.push({id:uid(),active,type:2,url:ruleStr}),newCtr.reopenRulesActive||(newCtr.reopenRulesActive=!0))}}}function upgradeV4Containers(oldContainers){let output={};for(let id of Object.keys(oldContainers)){let oldContainer=oldContainers[id],newContainer=cloneObject(DEFAULT_CONTAINER);newContainer.cookieStoreId=oldContainer.cookieStoreId??oldContainer.id??id,oldContainer.name&&(newContainer.name=oldContainer.name),oldContainer.icon&&(newContainer.icon=oldContainer.icon),oldContainer.color&&(newContainer.color=oldContainer.color),oldContainer.colorCode&&(newContainer.colorCode=oldContainer.colorCode),newContainer.id=oldContainer.id??oldContainer.cookieStoreId??id,oldContainer.proxified&&(newContainer.proxified=oldContainer.proxified),oldContainer.proxy&&(newContainer.proxy=cloneObject(oldContainer.proxy)),upgradeReopeningRules(oldContainer,newContainer),oldContainer.userAgentActive&&(newContainer.userAgentActive=oldContainer.userAgentActive),oldContainer.userAgent&&(newContainer.userAgent=oldContainer.userAgent),output[id]=newContainer}return output}async function saveContainers(delay){return Store.set({containers:cloneObject(Containers.reactive.byId)},delay)}function updateContainers(newContainers){if(newContainers&&(Containers.reactive.byId=newContainers,Info.isBg&&WebReq.updateReqHandlersDebounced(),Info.isSidebar&&Settings.state.ctxMenuIgnoreContainers&&Menu.parseContainersRules(),Info.isSidebar))for(let tab of Tabs2.list){let container=newContainers[tab.cookieStoreId];container&&(tab.reactive.containerColor=container.color)}}async function create(name,color,icon){let newRawContainer=await browser.contextualIdentities.create({name,color,icon}),newContainer=recreateNormalizedObject(newRawContainer,DEFAULT_CONTAINER);return newContainer.id=newRawContainer.cookieStoreId,Containers.reactive.byId[newContainer.id]=newContainer,Info.isBg&&WebReq.updateReqHandlersDebounced(),newContainer}function getCUID(container){let parts=[container.name,container.icon,container.color];return JSON.stringify(parts).slice(1,-1)}function parseCUID(cuid){let result;try{result=JSON.parse(`[${cuid}]`)}catch{return}if(!(!result||result.length!==3))return{name:result[0],icon:result[1],color:result[2]}}function findUnique(props){if(!props)return;let container;for(let ctr of Object.values(Containers.reactive.byId))if(ctr.name===props.name&&ctr.icon===props.icon&&ctr.color===props.color)if(!container)container=ctr;else{container=void 0;break}return container}function getContainerFor(url){for(let ctr of Object.values(Containers.reactive.byId))if(ctr.reopenRulesActive){let matchedContiner=!1;for(let rule of ctr.reopenRules){if(!rule.active)continue;let urlMatchStr=rule.url.trim();if(!urlMatchStr)continue;let urlMatchRe;if(urlMatchStr.startsWith("/")&&urlMatchStr.endsWith("/"))try{if(urlMatchRe=new RegExp(urlMatchStr.slice(1,-1)),urlMatchRe.test(url)){matchedContiner=!0;break}}catch{warn(`Containers.getContainerFor: Cannot parse RegExp: ${urlMatchStr}`)}else if(url.includes(urlMatchStr)){matchedContiner=!0;break}}if(matchedContiner)return ctr.id}}function sortContainers(containers){return Settings.state.containersSortByName?containers.sort((a,b)=>a.name.localeCompare(b.name)):containers}var containers_handlers_exports={};__export(containers_handlers_exports,{setupContainersListeners:()=>setupContainersListeners});function setupContainersListeners(){Info.isBg?(browser.contextualIdentities.onCreated.addListener(onContainerCreated),browser.contextualIdentities.onRemoved.addListener(onContainerRemovedBg),browser.contextualIdentities.onUpdated.addListener(onContainerUpdated),Store.onKeyChange("containers",Containers.updateContainers)):(browser.contextualIdentities.onRemoved.addListener(onContainerRemovedFg),Store.onKeyChange("containers",Containers.updateContainers))}function onContainerCreated(info2){let ffContainer=info2.contextualIdentity,id=ffContainer.cookieStoreId,container=Containers.reactive.byId[id]??cloneObject(DEFAULT_CONTAINER);container.cookieStoreId=id,container.id=id,container.name=ffContainer.name,container.icon=ffContainer.icon,container.color=ffContainer.color,Containers.reactive.byId[id]||(Containers.reactive.byId[id]=container),Info.isBg&&Containers.saveContainers(300)}function onContainerRemovedBg(info2){let id=info2.contextualIdentity.cookieStoreId;delete Containers.reactive.byId[id],Info.isBg&&Containers.saveContainers(300)}async function onContainerRemovedFg(info2){let id=info2.contextualIdentity.cookieStoreId,moveRulesRecalcNeeded=!1;for(let panel of Sidebar.panels)isTabsPanel(panel)&&(panel.newTabCtx===id&&(panel.newTabCtx="none"),panel.moveRules.length&&(panel.moveRules=panel.moveRules.filter(rule=>{if(rule.containerId===id)if(moveRulesRecalcNeeded=!0,rule.url)delete rule.containerId,rule.active=!1;else return!1;return!0})));moveRulesRecalcNeeded&&Tabs2.recalcMoveRules();let orphanTabs=Tabs2.list.filter(t=>t.cookieStoreId===id);Tabs2.removingTabs=orphanTabs.map(t=>t.id),await browser.tabs.remove([...Tabs2.removingTabs])}function onContainerUpdated(info2){let container=info2.contextualIdentity,id=container.cookieStoreId;Containers.reactive.byId[id]&&(Containers.reactive.byId[id].name=container.name,Containers.reactive.byId[id].icon=container.icon,Containers.reactive.byId[id].color=container.color,Info.isBg&&Containers.saveContainers(300))}var Containers={reactive:{byId:{}},...containers_handlers_exports,...containers_actions_exports};var favicons_bg_exports={};__export(favicons_bg_exports,{MAX_COUNT_LIMIT:()=>MAX_COUNT_LIMIT,SHARD_SIZE:()=>SHARD_SIZE,SIZE:()=>SIZE,getFavPlaceholder:()=>getFavPlaceholder,loadFavicons:()=>loadFavicons2,loadFaviconsData:()=>loadFaviconsData,resizeFavicon:()=>resizeFavicon,saveFavicon:()=>saveFavicon,upgradeFaviCache:()=>upgradeFaviCache});var SAVE_DELAY=2e3,saveAll=!0,favicons=[],hashes=[],domainsInfo={},RC4toRC5=!1;async function loadFavicons2(){let favData;try{favData=await loadFaviconsData()}catch(err3){return err("loadFavicons: Cannot get favicons",err3)}RC4toRC5=favData.RC4toRC5,favicons=[],hashes=[],domainsInfo={};let index=0;for(let domain of Object.keys(favData.favDomains)){let domainInfo=favData.favDomains[domain];if(domainInfo.index===void 0)continue;let srcUrl=domainInfo.src;srcUrl?(domainInfo.len=srcUrl.length,delete domainInfo.src):domainInfo.len===void 0&&(domainInfo.len=999);let favicon=favData.favicons[domainInfo.index],hash=favData.favHashes[domainInfo.index];if(!favicon||hash===void 0)continue;let existedIndex=hashes.indexOf(hash);existedIndex>-1?domainInfo.index=existedIndex:domainInfo.index=index++,domainsInfo[domain]=domainInfo,favicons[domainInfo.index]=favicon,hashes[domainInfo.index]=hash}}function saveFaviconsData(domainsInfo2,hashes2,favicons2,index,saveAll2){let toSave={favDomains:domainsInfo2,favHashes:hashes2};if(favicons2&&index!==void 0&&index>=0)if(saveAll2)toSave.favicons_01=favicons2.slice(0,SHARD_SIZE),toSave.favicons_02=favicons2.slice(SHARD_SIZE,SHARD_SIZE*2),toSave.favicons_03=favicons2.slice(SHARD_SIZE*2,SHARD_SIZE*3),toSave.favicons_04=favicons2.slice(SHARD_SIZE*3,SHARD_SIZE*4),toSave.favicons_05=favicons2.slice(SHARD_SIZE*4);else{let shard=Math.trunc(index/SHARD_SIZE);shard===0?toSave.favicons_01=favicons2.slice(0,SHARD_SIZE):shard===1?toSave.favicons_02=favicons2.slice(SHARD_SIZE,SHARD_SIZE*2):shard===2?toSave.favicons_03=favicons2.slice(SHARD_SIZE*2,SHARD_SIZE*3):shard===3?toSave.favicons_04=favicons2.slice(SHARD_SIZE*3,SHARD_SIZE*4):toSave.favicons_05=favicons2.slice(SHARD_SIZE*4,SHARD_SIZE*5)}Store.set(toSave),RC4toRC5&&(browser.storage.local.remove("favicons"),RC4toRC5=!1)}function getIndexToReplace(){let randomIndex=Math.trunc(Math.random()*favicons.length);for(let domain of Object.keys(domainsInfo))domainsInfo[domain].index===randomIndex&&delete domainsInfo[domain];return randomIndex}var saveFaviconTimeouts={};function saveFavicon(url,icon){!url||!icon||icon.length>234567||url.startsWith("about")||(clearTimeout(saveFaviconTimeouts[url]),saveFaviconTimeouts[url]=setTimeout(async()=>{delete saveFaviconTimeouts[url];let domain=getDomainOf(url);if(!domain)return;let domainInfo=domainsInfo[domain],hash=strHash(icon),index=hashes.indexOf(hash),iconAlreadyExists=index>-1;if(domainInfo){if(domainInfo.len<url.length||iconAlreadyExists&&index===domainInfo.index)return;(!iconAlreadyExists||index!==domainInfo.index)&&(domainInfo&&Object.values(domainsInfo).find(d=>d!==domainInfo&&d.index===domainInfo.index)||(index=domainInfo.index))}if(!iconAlreadyExists)try{icon=await resizeFavicon(icon)}catch{return}index===-1&&(favicons.length>=MAX_COUNT_LIMIT?index=getIndexToReplace():index=favicons.length),domainInfo?(domainInfo.index=index,domainInfo.len=url.length):domainsInfo[domain]={index,len:url.length},iconAlreadyExists||(favicons[index]=icon),hashes[index]=hash,!iconAlreadyExists||saveAll?saveFaviconsData(domainsInfo,hashes,favicons,index,saveAll):saveFaviconsData(domainsInfo,hashes),saveAll=!1,sendToSidebars("setFavicon",domain,icon)},SAVE_DELAY))}async function upgradeFaviCache(stored,newStorage){let favicons2=stored.favicons??[],favUrls=stored.favUrls??{},urlsMap={};for(let url of Object.keys(favUrls)){let index=favUrls[url];typeof index!="number"||index<0||urlsMap[index]||(urlsMap[index]=url)}let newFavs=[],newFavDomains={},newHashes=[];for(let hash,favicon,i=0;i<favicons2.length;i++){if(favicon=favicons2[i],!favicon)continue;hash=strHash(favicon);let newFav;try{newFav=await resizeFavicon(favicon)}catch{continue}if(urlsMap[i]){newHashes.push(hash);let newIndex=newFavs.push(newFav)-1,url=urlsMap[i],domain=getDomainOf(url);newFavDomains[domain]||(newFavDomains[domain]={index:newIndex,len:url.length})}}newStorage.favicons_01=newFavs,newStorage.favHashes=newHashes,newStorage.favDomains=newFavDomains}async function loadTabs(){let tabs=await browser.tabs.query({});for(let tab of tabs){let tabWindow=Windows.byId[tab.windowId];tabWindow&&(tabWindow.tabs?tabWindow.tabs.push(tab):tabWindow.tabs=[tab],Tabs.byId[tab.id]=tab,WebReq.containersProxies[tab.cookieStoreId]&&(tab.proxified=!0,showProxyBadge(tab.id)),tab.internal=tab.url.startsWith(ADDON_HOST),tab.pinned&&!tab.discarded&&Settings.state.pinnedForcedDiscard&&browser.tabs.discard(tab.id).catch(()=>{warn("Tabs.loadTabs: Cannot discard pinned tab for 1703072")}))}Tabs.ready=!0,Tabs.deferredEventHandling.length&&warn("Tabs: Deferred event handlers:",Tabs.deferredEventHandling.length),Tabs.deferredEventHandling.forEach(cb=>cb()),Tabs.deferredEventHandling=[]}async function reinitTabs2(msg){warn("Tabs.reinitTabs:",msg),Tabs.ready=!1,Tabs.byId={},Tabs.cacheByWin={};for(let win of Object.values(Windows.byId))win.tabs=[];await loadTabs()}function onTabCreated2(tab){if(!Tabs.ready){Tabs.deferredEventHandling.push(()=>onTabCreated2(tab));return}Tabs.byId[tab.id]=tab;let parentTab=Tabs.byId[tab.openerTabId??NOID];parentTab&&parentTab.preventAutoReopening&&(tab.preventAutoReopening=!0);let tabWindow=Windows.byId[tab.windowId];if(!tabWindow){let win={id:tab.windowId,alwaysOnTop:!1,focused:!1,incognito:tab.incognito};win.tabs=[tab],Windows.byId[tab.windowId]=win;return}tabWindow.tabs?tabWindow.tabs.splice(tab.index,0,tab):tabWindow.tabs=[tab];let len=tabWindow.tabs.length;for(let i=tab.index,t;i<len;i++)if(t=tabWindow.tabs[i],t)t.index=i;else{reinitTabs2("onTabCreated: Empty space in list");return}if(Settings.state.hideInact&&!isConnected(2,tab.windowId)){let prevTab=tabWindow.tabs[tab.index-1];if(prevTab&&prevTab.hidden)for(let i=prevTab.index-1;i>=0;i--){let prevTabN=tabWindow.tabs[i];if(prevTabN&&!prevTabN.hidden){browser.tabs.move(tab.id,{index:i+1,windowId:tabWindow.id}).catch(err3=>{err("Tabs.onTabCreated: Cannot move tab (backward):",err3)});break}}else{let nextTab=tabWindow.tabs[tab.index+1];if(nextTab&&nextTab.hidden)for(let i=nextTab.index+1;i<tabWindow.tabs.length;i++){let nextTabN=tabWindow.tabs[i];if(nextTabN&&!nextTabN.hidden){browser.tabs.move(tab.id,{index:i,windowId:tabWindow.id}).catch(err3=>{err("Tabs.onTabCreated: Cannot move tab (forward):",err3)});break}}}}}function onTabRemoved2(tabId,info2){if(!Tabs.ready){Tabs.deferredEventHandling.push(()=>onTabRemoved2(tabId,info2));return}let tabs=Windows.byId[info2.windowId]?.tabs,tab=Tabs.byId[tabId];if(!tab||!tabs||info2.isWindowClosing)return;let index=tabs.findIndex(t=>t.id===tabId);if(index===-1||tab.index!==index)return;tabs.splice(index,1),delete Tabs.byId[tabId];let len=tabs.length;for(let i=index,t;i<len;i++)if(t=tabs[i],t)t.index=i;else{reinitTabs2("onTabRemoved: Empty space in list");return}}function onTabUpdated2(tabId,change){if(!Tabs.ready){Tabs.deferredEventHandling.push(()=>onTabUpdated2(tabId,change));return}let tab=Tabs.byId[tabId];if(tab){if(change.url){let isInternal=change.url.startsWith(ADDON_HOST);tab.internal=isInternal,isInternal&&isUrlUrl(change.url)&&injectUrlPageScript(tab.windowId,tabId)}change.status!==void 0&&change.status==="complete"&&tab.url[0]!=="a"&&!tab.internal&&reloadTabFaviconDebounced2(tab),change.title&&tab.internal&&!tab.discarded&&change.title===GROUP_INITIAL_TITLE&&injectGroupPageScript(tab.windowId,tabId),change.favIconUrl?.startsWith("data:")&&reloadTabFaviconTimeout2[tab.id]===void 0&&!tab.internal&&saveFavicon(tab.url,change.favIconUrl),Object.assign(tab,change),WebReq.containersProxies[tab.cookieStoreId]&&(tab.proxified=!0,showProxyBadgeDebounced(tabId)),!WebReq.containersProxies[tab.cookieStoreId]&&tab.proxified&&(tab.proxified=!1,hideProxyBadge(tabId))}}var reloadTabFaviconTimeout2={};function reloadTabFaviconDebounced2(targetTab,delay=500){clearTimeout(reloadTabFaviconTimeout2[targetTab.id]),reloadTabFaviconTimeout2[targetTab.id]=setTimeout(()=>{delete reloadTabFaviconTimeout2[targetTab.id],Tabs.byId[targetTab.id]&&browser.tabs.get(targetTab.id).then(tabInfo=>{tabInfo.favIconUrl&&!tabInfo.favIconUrl.startsWith("chrome:")?targetTab.favIconUrl=tabInfo.favIconUrl:targetTab.favIconUrl="",saveFavicon(targetTab.url,targetTab.favIconUrl)}).catch(err3=>{err("Tabs.reloadTabFaviconDebounced: Cannot get tab:",err3)})},delay)}function onTabActivated2(info2){if(!Tabs.ready){Tabs.deferredEventHandling.push(()=>onTabActivated2(info2));return}let tab=Tabs.byId[info2.tabId];tab&&(tab.active=!0);let prevTab=Tabs.byId[info2.previousTabId];prevTab&&(prevTab.active=!1),tab.reloadOnActivation&&(tab.reloadOnActivation=void 0,browser.tabs.reload(tab.id))}function showProxyBadge(tabId){let tab=Tabs.byId[tabId];if(!tab)return;let container=Containers.reactive.byId[tab.cookieStoreId];if(!container)return;let titlePre=browser.i18n.getMessage("proxy_popup_title_prefix"),titlePost=browser.i18n.getMessage("proxy_popup_title_postfix"),title=titlePre+container.name+titlePost;browser.pageAction.setTitle({title,tabId}),browser.pageAction.show(tabId).catch(err3=>{err("Tabs.showProxyBadge: Cannot show proxy badge:",err3)})}var showProxyBadgeTimeout;function showProxyBadgeDebounced(tabId,delay=500){showProxyBadgeTimeout&&clearTimeout(showProxyBadgeTimeout),showProxyBadgeTimeout=setTimeout(()=>{showProxyBadge(tabId)},delay)}function hideProxyBadge(tabId){browser.pageAction.hide(tabId).catch(err3=>{err("Tabs.hideProxyBadge: Cannot hide proxy badge:",err3)}),browser.pageAction.setTitle({title:"Sidebery proxy off",tabId})}function onTabMoved2(id,info2){if(!Tabs.ready){Tabs.deferredEventHandling.push(()=>onTabMoved2(id,info2));return}let tabWindow=Windows.byId[info2.windowId];if(!tabWindow||!tabWindow.tabs)return;if(!Tabs.byId[id]){warn("onTabMoved: No tab");return}let tabAtDstIndex=tabWindow.tabs[info2.toIndex],tabAtSrcIndex=tabWindow.tabs[info2.fromIndex];if(!(tabAtDstIndex?.id===id&&tabAtDstIndex.index===info2.toIndex)){if(!tabAtSrcIndex||tabAtSrcIndex.id!==id){reinitTabs2("onTabMoved: Wrong tab at src index");return}tabWindow.tabs.splice(info2.fromIndex,1),tabWindow.tabs.splice(info2.toIndex,0,tabAtSrcIndex);for(let i=tabWindow.tabs.length,t;i--;)t=tabWindow.tabs[i],t&&(t.index=i)}}function onTabAttached2(id,info2){if(!Tabs.ready){Tabs.deferredEventHandling.push(()=>onTabAttached2(id,info2));return}let tabs=Windows.byId[info2.newWindowId]?.tabs,tab=Tabs.byId[id];if(!tabs||!tab){reinitTabs2("onTabAttached: No tab[s]");return}tab.windowId=info2.newWindowId,tab.index=info2.newPosition,tabs.splice(info2.newPosition,0,tab);for(let i=info2.newPosition,t;i<tabs.length;i++)if(t=tabs[i],t)t.index=i;else{reinitTabs2("onTabAttached: Empty space in list");return}}function onTabDetached2(id,info2){if(!Tabs.ready){Tabs.deferredEventHandling.push(()=>onTabDetached2(id,info2));return}let tabs=Windows.byId[info2.oldWindowId]?.tabs,tab=Tabs.byId[id];if(!tabs||!tab){reinitTabs2("onTabDetached: No tab[s]");return}tabs.splice(info2.oldPosition,1)[0];for(let i=info2.oldPosition,t;i<tabs.length;i++)if(t=tabs[i],t)t.index=i;else{reinitTabs2("onTabDetached: Empty space in list");return}}var cacheTabsDataTimeout2;function cacheTabsData2(windowId,tabs,delay=300){tabs&&(Tabs.cacheByWin[windowId]=tabs,clearTimeout(cacheTabsDataTimeout2),cacheTabsDataTimeout2=setTimeout(()=>{let tabsData=[];for(let tabs2 of Object.values(Tabs.cacheByWin))tabs2.length&&tabsData.push(tabs2);Store.set({tabsDataCache:tabsData})},delay))}async function updateBgTabsTreeData(){let receivingSidebarTrees=[],windowsList=[];for(let window2 of Object.values(Windows.byId)){if(window2.id===void 0)continue;windowsList.push(window2),getConnection(2,window2.id)?receivingSidebarTrees.push(sidebar(window2.id,"getTabsTreeData")):receivingSidebarTrees.push(Promise.resolve([]))}let trees;try{trees=await Promise.all(receivingSidebarTrees)}catch{trees=[]}for(let tree,window2,i=0;i<windowsList.length;i++){if(tree=trees[i],window2=windowsList[i],!window2?.tabs)continue;let treeDataById={},prevPanelId=NOID;for(let data of tree)data.pid===SAMEID&&(data.pid=prevPanelId),prevPanelId=data.pid??NOID,treeDataById[data.id]=data;for(let tab of window2.tabs){if(tab.lvl=0,tab.parentId=NOID,tab.panelId=NOID,tab.customTitle=void 0,tab.customColor=void 0,!tree)continue;let tabInfo=treeDataById[tab.id];if(!tabInfo)continue;tabInfo.pid!==void 0&&(tab.panelId=tabInfo.pid),tabInfo.tid!==void 0&&(tab.parentId=tabInfo.tid),tabInfo.ct&&(tab.customTitle=tabInfo.ct),tabInfo.cc&&(tab.customColor=tabInfo.cc);let parent=Tabs.byId[tab.parentId];parent&&(tab.lvl=parent.lvl+1)}}}async function initInternalPageScripts(tabs){Styles.theme||await Styles.initColorScheme();for(let tab of tabs){if(!Windows.byId[tab.windowId])continue;tab.internal===void 0&&(tab.internal=tab.url.startsWith(ADDON_HOST));let isGroup=isGroupUrl(tab.url),isUrl=isUrlUrl(tab.url);if(!tab.internal&&isGroup){let[_,groupUrlInfo]=tab.url.split("/group.html");if(!groupUrlInfo)continue;let groupUrl=GROUP_URL+groupUrlInfo;browser.tabs.update(tab.id,{url:groupUrl}).catch(err3=>{err("Tabs.initInternalPageScripts: Cannot update group url:",err3)});continue}if(!tab.internal&&isUrl){let[_,urlUrlInfo]=tab.url.split("/url.html");if(!urlUrlInfo)continue;let urlUrl=URL_URL+urlUrlInfo;browser.tabs.update(tab.id,{url:urlUrl}).catch(err3=>{err("Tabs.initInternalPageScripts: Cannot update url url:",err3)});continue}isGroup&&!tab.discarded&&injectGroupPageScript(tab.windowId,tab.id),isUrl&&!tab.discarded&&injectUrlPageScript(tab.windowId,tab.id)}}function injectUrlPageScript(winId,tabId){try{browser.tabs.executeScript(tabId,{file:"/injections/url.js",runAt:"document_start",matchAboutBlank:!0}).catch(err3=>{warn("Tabs.injectUrlPageScript: Cannot inject script, tabId:",tabId,err3)});let initData=getUrlPageInitData(winId,tabId),initDataJson=JSON.stringify(initData);browser.tabs.executeScript(tabId,{code:`window.sideberyInitData=${initDataJson};window.onSideberyInitDataReady?.()`,runAt:"document_start",matchAboutBlank:!0}).catch(()=>{warn("Tabs.injectUrlPageScript: Cannot inject init data, reloading tab (if active)...");let tab=Tabs.byId[tabId];tab.active&&tab.reloadOnActivation===void 0?(tab.reloadOnActivation=!1,browser.tabs.reload(tabId).catch(err3=>{err("Tabs.injectUrlPageScript: Cannot reload tab",err3)})):tab.discarded||(tab.reloadOnActivation=!0)})}catch(err3){err("Injected url-page script",err3)}}function getUrlPageInitData(winId,tabId){return{theme:Settings.state.theme,parsedTheme:Styles.parsedTheme,frameColorScheme:Styles.reactive.frameColorScheme,toolbarColorScheme:Styles.reactive.toolbarColorScheme,winId,tabId}}async function injectGroupPageScript(winId,tabId){try{browser.tabs.executeScript(tabId,{file:"/injections/group.js",runAt:"document_start",matchAboutBlank:!0}).catch(err3=>{warn("Tabs.injectGroupPageScript: Cannot inject script, tabId:",tabId,err3)});let initData=await getGroupPageInitData(winId,tabId),initDataJson=JSON.stringify(initData);browser.tabs.executeScript(tabId,{code:`window.sideberyInitData=${initDataJson};window.onSideberyInitDataReady?.()`,runAt:"document_start",matchAboutBlank:!0}).catch(()=>{warn("Tabs.injectGroupPageScript: Cannot inject init data, reloading tab");let tab=Tabs.byId[tabId];tab.active&&tab.reloadOnActivation===void 0?(tab.reloadOnActivation=!1,browser.tabs.reload(tabId).catch(err3=>{err("Tabs.injectGroupPageScript: Cannot reload tab:",err3)})):tab.discarded||(tab.reloadOnActivation=!0)})}catch(err3){err("Injected group-page script",err3)}}async function getGroupPageInitData(winId,tabId){let groupInfo=await sidebar(winId,"getGroupInfo",tabId).catch(err3=>(err("Tabs: Cannot get tabs info for group page",err3),null));return{theme:Settings.state.theme,parsedTheme:Styles.parsedTheme,frameColorScheme:Styles.reactive.frameColorScheme,toolbarColorScheme:Styles.reactive.toolbarColorScheme,groupLayout:Settings.state.groupLayout,animations:Settings.state.animations,groupInfo,winId,tabId}}function tabsApiProxy(method,...args){if(method==="create")return browser.tabs.create(...args);if(method==="update")return browser.tabs.update(...args);if(method==="remove")return browser.tabs.remove(...args);if(method==="discard")return browser.tabs.discard(...args);if(method==="reload")return browser.tabs.reload(...args);if(method==="captureTab"&&browser.tabs.captureTab)return browser.tabs.captureTab(...args)}async function getSidebarTabs(windowId,tabIds){let con=getConnection(2,windowId);if(con&&!((!con.localPort||con.localPort.error)&&(!con.remotePort||con.remotePort.error)))return sidebar(windowId,"getTabs",tabIds)}async function openTabs(items,dst){if(dst.windowId===void 0||!Windows.byId[dst.windowId])return!1;let con=getConnection(2,dst.windowId);if(con?.localPort&&!con.localPort.error||con?.remotePort&&!con.remotePort.error)return sidebar(dst.windowId,"openTabs",items,dst);for(let item of items)await browser.tabs.create({url:item.url,windowId:dst.windowId});return!0}function setupTabsListeners2(){browser.tabs.onCreated.addListener(onTabCreated2),browser.tabs.onRemoved.addListener(onTabRemoved2),browser.tabs.onUpdated.addListener(onTabUpdated2,{properties:["pinned","title","status","favIconUrl","url","hidden","discarded"]}),browser.tabs.onActivated.addListener(onTabActivated2),browser.tabs.onMoved.addListener(onTabMoved2),browser.tabs.onAttached.addListener(onTabAttached2),browser.tabs.onDetached.addListener(onTabDetached2)}var Tabs={ready:!1,byId:{},cacheByWin:{},deferredEventHandling:[],...tabs_bg_actions_exports};async function loadWindows(){let windows=await browser.windows.getAll({windowTypes:["normal"],populate:!1});Windows.byId={};for(let window2 of windows)window2.type!=="normal"||window2.id===void 0||(Windows.byId[window2.id]=window2)}async function loadWindowInfo(){let winData=await Promise.all([browser.windows.getCurrent({populate:!1}),browser.sessions.getWindowValue(browser.windows.WINDOW_ID_CURRENT,"uniqWinId")]),currentWindow=winData[0],uniqWinId=winData[1];if(currentWindow.type!=="normal")throw'This code should not be launched in a window with a type other than "normal"';uniqWinId||(uniqWinId=uid(),browser.sessions.setWindowValue(browser.windows.WINDOW_ID_CURRENT,"uniqWinId",uniqWinId)),Windows.incognito=currentWindow.incognito,Windows.id=currentWindow.id??NOID,Windows.uniqWinId=uniqWinId,Windows.focused=currentWindow.focused,Windows.focused&&currentWindow.id&&(Windows.lastFocusedId=currentWindow.id),Windows.lastFocused=currentWindow.focused,browser.windows.getAll().then(windows=>{Windows.otherWindows=windows.filter(w=>w.id!==Windows.id&&w.type==="normal")})}async function showWindowsPopup(config={}){Windows.reactive.choosingTitle=config.title??"",setTimeout(()=>{Windows.reactive.choosing||(Windows.reactive.choosing=[])},120);let wins=await browser.windows.getAll({windowTypes:["normal"],populate:!1});return config.otherWindows?wins=wins.filter(w=>w.id!==Windows.id):wins=await browser.windows.getAll(),config.filter&&(wins=wins.filter(config.filter)),new Promise(res=>{let options=wins.map(async w=>{let[tab]=await browser.tabs.query({active:!0,windowId:w.id}),screen;if(Settings.state.selWinScreenshots&&browser.tabs.captureTab){let imageConf={format:"jpeg",quality:75,scale:.5};tab&&(screen=await browser.tabs.captureTab(tab.id,imageConf))}return{id:w.id??NOID,title:w.title??tab?.title,screen,sel:!1,choose:()=>{closeWindowsPopup(),res(w.id??NOID)}}});Promise.all(options).then(wins2=>{Windows.reactive.choosing=wins2})})}function selectWindow(dir){if(!Windows.reactive.choosing)return;let selIndex=Windows.reactive.choosing.findIndex(w=>w.sel);selIndex!==-1&&(Windows.reactive.choosing[selIndex].sel=!1),selIndex+=dir,(selIndex<0||selIndex>=Windows.reactive.choosing.length)&&(selIndex=dir>0?0:Windows.reactive.choosing.length-1),Windows.reactive.choosing[selIndex].sel=!0}function activateSelectedWindow(){if(!Windows.reactive.choosing)return;let winInfo=Windows.reactive.choosing.find(w=>w.sel);winInfo&&winInfo.choose()}function closeWindowsPopup(){Windows.reactive.choosing=null,Windows.reactive.choosingTitle=""}var lockedWindowsTabs={};function isWindowTabsLocked(id){return info("Windows.isWindowTabsLocked",id),lockedWindowsTabs[id]??!1}async function createWithTabs(tabsInfo,conf){conf||(conf={});let moveTabs=conf.tabId===MOVEID;if(moveTabs&&delete conf.tabId,conf.url===void 0&&conf.tabId===void 0&&(conf.url="about:blank"),!moveTabs)for(let info2 of tabsInfo)info2.url=normalizeUrl(info2.url,info2.title);let idsMap={},createdTabs=[],defaultContainerId=conf.incognito?PRIVATE_CONTAINER_ID:DEFAULT_CONTAINER_ID,window2;try{window2=await browser.windows.create(conf)}catch(err3){if(String(err3)==="Error: Extension does not have permission for incognito mode"&&Windows.lastFocusedWinId!==void 0){let notification={title:"Cannot open window",details:String(err3),lvl:"err"};sendToSidebar(Windows.lastFocusedWinId,"notify",notification,1e4)}return err("Windows: Cannot create window with tabs",err3),!1}if(!window2.id||!window2.tabs?.length)return!0;lockedWindowsTabs[window2.id]=!0;let firstTabId=window2.tabs[0]?.id,processingTabs=[],index=0;for(let info2 of tabsInfo)if(moveTabs)processingTabs.push(browser.tabs.move(info2.id,{index:index++,windowId:window2.id}));else{let conf2={url:info2.url,windowId:window2.id,index:index++};info2.pinned&&(conf2.pinned=!0),info2.active?conf2.active=!0:conf2.active=!1,info2.url&&!info2.pinned&&!info2.active&&(conf2.discarded=!0),info2.title&&conf2.discarded&&(conf2.title=info2.title),info2.container!==void 0&&Containers.reactive.byId[info2.container]&&(conf2.cookieStoreId=info2.container),processingTabs.push(browser.tabs.create(conf2))}try{let processed=await Promise.all(processingTabs);for(let tabOrTabs of processed)Array.isArray(tabOrTabs)?createdTabs.push(...tabOrTabs):createdTabs.push(tabOrTabs)}catch(err3){return err("Windows.createWithTabs: Cannot process tabs:",err3),!1}let cache=[];for(let i=0;i<createdTabs.length;i++){let tab=createdTabs[i],srcInfo=tabsInfo[i];if(!srcInfo||!tab)continue;srcInfo.parentId!==void 0&&idsMap[srcInfo.parentId]!==void 0&&(browser.tabs.update(tab.id,{openerTabId:idsMap[srcInfo.parentId]}).catch(err3=>{err("Windows.createWithTabs: Cannot set openerTabId:",err3)}),tab.parentId=idsMap[srcInfo.parentId]);let cachedData={id:tab.id,url:srcInfo.url??"about:newtab"};+tab.parentId>-1&&(cachedData.parentId=tab.parentId),srcInfo.panelId&&(cachedData.panelId=srcInfo.panelId),tab.cookieStoreId!==defaultContainerId&&(cachedData.ctx=tab.cookieStoreId),srcInfo.customTitle&&(cachedData.customTitle=srcInfo.customTitle),srcInfo.customColor&&(cachedData.customColor=srcInfo.customColor),srcInfo.pinned&&(cachedData.pin=!0),cache.push(cachedData);let sessionData={id:tab.id,panelId:srcInfo.panelId??NOID,parentId:tab.parentId??NOID,folded:!1};srcInfo.customTitle&&(sessionData.customTitle=srcInfo.customTitle),srcInfo.customColor&&(sessionData.customColor=srcInfo.customColor),browser.sessions.setTabValue(tab.id,"data",sessionData).catch(err3=>{err("Windows.createWithTabs: Cannot set session data:",err3)}),idsMap[srcInfo.id]=tab.id}Tabs.cacheTabsData(window2.id,cache,0);try{await browser.tabs.remove(firstTabId)}catch(err3){err("Windows.createWithTabs: Cannot remove initial tab:",err3)}return lockedWindowsTabs[window2.id]=cache,setTimeout(()=>{window2.id!==void 0&&delete lockedWindowsTabs[window2.id]},5e3),!0}function updWindowPreface(preface){preface===void 0&&(preface=Settings.state.markWindowPreface),preface=preface.replace("%PN",Sidebar.panelsById[Sidebar.activePanelId]?.name??""),browser.windows.update(Windows.id,{titlePreface:preface})}var windows_handlers_exports={};__export(windows_handlers_exports,{resetWindowsListeners:()=>resetWindowsListeners,setupWindowsListeners:()=>setupWindowsListeners});function setupWindowsListeners(){Info.isBg?(browser.windows.onCreated.addListener(onWindowCreatedBg),browser.windows.onRemoved.addListener(onWindowRemovedBg),browser.windows.onFocusChanged.addListener(onWindowFocusedBg)):(browser.windows.onCreated.addListener(onWindowCreatedFg),browser.windows.onRemoved.addListener(onWindowRemovedFg),browser.windows.onFocusChanged.addListener(onWindowFocusedFg))}function resetWindowsListeners(){Info.isBg?(browser.windows.onCreated.removeListener(onWindowCreatedBg),browser.windows.onRemoved.removeListener(onWindowRemovedBg),browser.windows.onFocusChanged.removeListener(onWindowFocusedBg)):(browser.windows.onCreated.removeListener(onWindowCreatedFg),browser.windows.onRemoved.removeListener(onWindowRemovedFg),browser.windows.onFocusChanged.removeListener(onWindowFocusedFg))}function onWindowCreatedBg(window2){if(window2.id===void 0)return;let existedTabs=Windows.byId[window2.id]?.tabs;existedTabs&&(window2.tabs=existedTabs),Windows.byId[window2.id]=window2}function onWindowCreatedFg(window2){window2.id!==Windows.id&&window2.type==="normal"&&Windows.otherWindows.push(window2)}function onWindowRemovedBg(windowId){let window2=Windows.byId[windowId];if(window2&&(delete Windows.byId[windowId],delete Tabs.cacheByWin[windowId],window2.tabs))for(let tab of window2.tabs)delete Tabs.byId[tab.id]}function onWindowRemovedFg(windowId){if(state.popupWinId===windowId&&(state.popupWinId=NOID,state.status=0),windowId===Windows.id||!Windows.otherWindows)return;let index=Windows.otherWindows.findIndex(w=>w.id===windowId);index>=0&&Windows.otherWindows.splice(index,1)}function onWindowFocusedBg(windowId){if(windowId===-1)for(let id of Object.keys(Windows.byId)){let window2=Windows.byId[id];window2?.focused&&(window2.focused=!1)}else{let window2=Windows.byId[windowId];window2&&(Windows.lastFocusedWinId=window2.id,window2.focused=!0)}}function onWindowFocusedFg(id){Windows.focused=id===Windows.id,id!==-1&&(Windows.lastFocusedId=id,Windows.lastFocused=id===Windows.id)}var Windows={byId:{},reactive:{choosing:null,choosingTitle:""},id:NOID,uniqWinId:NOID,incognito:!1,lastFocusedId:NOID,focused:!1,lastFocused:!1,otherWindows:[],lastFocusedWinId:NOID,...windows_actions_exports,...windows_handlers_exports};var MSG_CONFIRMATION_MAX_DELAY=5e3,CONNECT_CONFIRMATION_MAX_DELAY=5e3,actions,_localType=-1,_localWinId=NOID,_localTabId=NOID,state2={bgConnection:void 0,searchPopupConnections:new Map,sidebarConnections:new Map,setupPageConnections:new Map,groupPageConnections:new Map,previewConnection:void 0};function setInstanceType2(type){_localType=type}function setWinId2(id){_localWinId=id}function setTabId2(id){_localTabId=id}function registerActions(a){actions=a}function isConnected(type,id=NOID){return type===0&&state2.bgConnection?!0:type===2?state2.sidebarConnections.has(id):type===3?state2.setupPageConnections.has(id):type===4?state2.searchPopupConnections.has(id):type===1?state2.groupPageConnections.has(id):!!(type===7&&state2.previewConnection)}function getConnection(type,id){if(type===0&&state2.bgConnection)return state2.bgConnection;if(type===2)return state2.sidebarConnections.get(id);if(type===3)return state2.setupPageConnections.get(id);if(type===4)return state2.searchPopupConnections.get(id);if(type===1)return state2.groupPageConnections.get(id);if(type===7)return state2.previewConnection}function createConnection(type,id){let connection={type,id,reconnectCount:0};return type===0?state2.bgConnection=connection:type===2?state2.sidebarConnections.set(id,connection):type===3?state2.setupPageConnections.set(id,connection):type===4?state2.searchPopupConnections.set(id,connection):type===1?state2.groupPageConnections.set(id,connection):type===7&&(state2.previewConnection=connection),connection}var connectingTimeout;function connectTo(dstType,dstWinId=NOID,dstTabId=NOID){let srcType=_localType,srcWinId=_localWinId,srcTabId=_localTabId,toBg=dstType===0,toSidebar=dstType===2,toSetup=dstType===3,toSearch=dstType===4,toGroup=dstType===1,toPreview=dstType===7,id;if(toBg||toPreview)id=NOID;else if((toSidebar||toSearch)&&dstWinId!==NOID)id=dstWinId;else if((toSetup||toGroup)&&dstTabId!==NOID)id=dstTabId;else{err("IPC.connectTo: No destination id");return}let portNameData={srcType,dstType};srcWinId!==NOID&&(portNameData.srcWinId=srcWinId),srcTabId!==NOID&&(portNameData.srcTabId=srcTabId),dstWinId!==NOID&&(toSidebar||toSearch)&&(portNameData.dstWinId=dstWinId),dstTabId!==NOID&&(toSetup||toGroup)&&(portNameData.dstTabId=dstTabId);let portNameJson=JSON.stringify(portNameData),connection,connectionIsNew=!1,existedConnection=getConnection(dstType,id);existedConnection?connection=existedConnection:(connectionIsNew=!0,connection=createConnection(dstType,id)),connection.localPort&&connection.localPort.disconnect(),connection.localPort=browser.runtime.connect({name:portNameJson}),connection.postListener=msg=>{onPostMsg(msg,connection.localPort)},connection.localPort.onMessage.addListener(connection.postListener),connection.disconnectListener=port=>{port.onMessage.removeListener(connection.postListener),port.onDisconnect.removeListener(connection.disconnectListener),resolveUnfinishedCommunications(port),connection.localPort=void 0;let connectionIsRemoved=!1;if(connection.remotePort||(connectionIsRemoved=!0,toBg?state2.bgConnection=void 0:toSidebar?state2.sidebarConnections.delete(dstWinId):toSetup?state2.setupPageConnections.delete(dstTabId):toSearch?state2.searchPopupConnections.delete(dstWinId):toGroup?state2.groupPageConnections.delete(dstTabId):toPreview&&(state2.previewConnection=void 0)),connectionIsRemoved){let handlers=disconnectionHandlers.get(dstType);handlers&&handlers.forEach(cb=>cb(connection.id))}toBg&&connection.reconnectCount++<3&&(clearTimeout(connectingTimeout),connectingTimeout=setTimeout(()=>connectTo(dstType,dstWinId),120))},connection.localPort.onDisconnect.addListener(connection.disconnectListener),clearTimeout(connectingTimeout),connectingTimeout=setTimeout(()=>{connection.localPort&&!connection.localPort.error?connection.reconnectCount=0:err("IPC.connectTo: Cannot reconnect")},120);let conConfirmId=toBg?-1:-2,timeout=setTimeout(()=>{warn("IPC.connectTo: No confirmation:",getInstanceName(dstType)),msgsWaitingForAnswer.delete(conConfirmId)},CONNECT_CONFIRMATION_MAX_DELAY);return msgsWaitingForAnswer.set(conConfirmId,{timeout,portName:"",ok:()=>{if(connectionIsNew){let handlers=connectionHandlers.get(dstType);handlers&&handlers.forEach(cb=>cb(connection.id))}}}),connection.localPort}function sidebar(dstWinId,action,...args){let msg={dstType:2,dstWinId,action,args};return request2(msg,2)}function sendToSidebar(dstWinId,action,...args){send({dstType:2,dstWinId,action,args})}function sidebars(action,...args){let tasks=Array.from(state2.sidebarConnections.keys()).map(id=>{let msg={dstType:2,dstWinId:id,action,args};return request2(msg,2)});return Promise.all(tasks)}function sendToSidebars(action,...args){state2.sidebarConnections.forEach(con=>{send({dstType:2,dstWinId:con.id,action,args})})}function sendToLastFocusedSidebar(action,...args){if(state2.sidebarConnections.size===1){let[connection]=state2.sidebarConnections.values();connection&&sidebar(connection.id,action,...args);return}if(Windows.lastFocusedWinId===void 0){sendToSidebars(action,...args);return}Windows.byId[Windows.lastFocusedWinId]&&sidebar(Windows.lastFocusedWinId,action,...args)}function setupPage(dstTabId,action,...args){let msg={dstType:3,dstTabId,action,args};return request2(msg,2)}function groupPage(dstTabId,msg){browser.tabs.sendMessage(dstTabId,msg).catch(()=>{})}function sendToSearchPopup(dstWinId,action,...args){send({dstType:4,dstWinId,action,args})}function bg(action,...args){let msg={dstType:0,action,args};return request2(msg,2)}function sendToBg(action,...args){send({dstType:0,action,args})}function sendToPreview(action,...args){send({dstType:7,action,args})}function send(msg){if(msg.dstType===void 0)return;let id=NOID;msg.dstType===2&&msg.dstWinId!==void 0?id=msg.dstWinId:msg.dstType===3&&msg.dstTabId!==void 0?id=msg.dstTabId:msg.dstType===4&&msg.dstWinId!==void 0?id=msg.dstWinId:msg.dstType===1&&msg.dstTabId!==void 0&&(id=msg.dstTabId);let connection=getConnection(msg.dstType,id),port=connection?.localPort??connection?.remotePort;if(!(!port||port.error))try{port.postMessage(msg)}catch(e){warn("IPC.send: Got error on postMessage",e)}}var msgsWaitingForAnswer=new Map,msgCounter=1;async function request2(msg,autoConnectMode){if(msg.dstType===void 0)return Promise.reject("IPC.request: No dstType");let id=NOID;msg.dstType===2&&msg.dstWinId!==void 0?id=msg.dstWinId:msg.dstType===3&&msg.dstTabId!==void 0?id=msg.dstTabId:msg.dstType===4&&msg.dstWinId!==void 0?id=msg.dstWinId:msg.dstType===1&&msg.dstTabId!==void 0&&(id=msg.dstTabId);let connection=getConnection(msg.dstType,id),port=connection?.localPort??connection?.remotePort;return new Promise((ok,err3)=>{if(msg.dstType===void 0)return err3("IPC.request: No dstType");if(!port||port.error){if(autoConnectMode===0)return err3("IPC.request: No port");if(port?.error&&err("IPC.request: Target port has an error:",port?.error),port=void 0,autoConnectMode===2&&(warn("IPC.request: Cannot find appropriate port, trying to reconnect..."),port=connectTo(msg.dstType,msg.dstWinId,msg.dstTabId)),!port||port.error)return port?.error&&err("IPC.request: Target port has error:",port?.error),err3(`IPC.request: Cannot get target port for "${getInstanceName(msg.dstType)}"`)}let msgId=msgCounter++;msg.id=msgId;try{port.postMessage(msg)}catch(e){if(warn("IPC.request: Got error on postMessage, trying to reconnect...",e),port=connectTo(msg.dstType,msg.dstWinId,msg.dstTabId),!port||port.error)return port?.error&&err("IPC.request: Target port has error:",port?.error),err3(`IPC.request: Cannot get target port for "${getInstanceName(msg.dstType)}"`);try{port?.postMessage(msg)}catch(e2){let dstTypeName=getInstanceName(msg.dstType);return err(`IPC.request: Cannot post message to "${dstTypeName}":`,e2),err3(`IPC.request: Cannot post message to "${dstTypeName}": ${String(e2)}`)}}let timeout=setTimeout(async()=>{if(warn("IPC.request: No confirmation:",getInstanceName(msg.dstType),msg.action),msgsWaitingForAnswer.delete(msgId),port&&(port.error={message:"No confirmation"}),autoConnectMode===2)try{ok(await request2(msg,0))}catch(e){err3(e)}else err3("IPC.request: No confirmation")},MSG_CONFIRMATION_MAX_DELAY);msgsWaitingForAnswer.set(msgId,{timeout,ok,err:err3,portName:port.name})})}function broadcast(msg){return browser.runtime.sendMessage(msg)}function onConnect(port){let portNameData;try{portNameData=JSON.parse(port.name)}catch{return err("IPC.onConnect: Cannot parse PortName")}if(portNameData.dstType!==_localType||portNameData.dstWinId!==void 0&&portNameData.dstWinId!==_localWinId)return;let srcType=portNameData.srcType,srcWinId=portNameData.srcWinId??NOID,srcTabId=portNameData.srcTabId??NOID,fromBg=srcType===0,fromSidebar=srcType===2,fromSetup=srcType===3,fromSearch=srcType===4,fromGroup=srcType===1,fromPreview=srcType===7;if(fromSidebar&&srcWinId===NOID)return err("IPC.onConnect: Sidebar: No srcWinId");if(fromSetup&&srcTabId===NOID)return err("IPC.onConnect: Setup page: No srcTabId");if(fromSearch&&srcWinId===NOID)return err("IPC.onConnect: Search popup: No srcWinId");if(fromGroup&&srcTabId===NOID)return err("IPC.onConnect: Group page: No srcTabId");let id;if(fromBg||fromPreview)id=NOID;else if((fromSidebar||fromSearch)&&srcWinId!==NOID)id=srcWinId;else if((fromSetup||fromGroup)&&srcTabId!==NOID)id=srcTabId;else{err("IPC.onConnect: No source id");return}let connection,connectionIsNew=!1,existedConnection=getConnection(srcType,id);if(existedConnection?connection=existedConnection:(connectionIsNew=!0,connection=createConnection(srcType,id)),connection.remotePort=port,connectionIsNew){let handlers=connectionHandlers.get(srcType);handlers&&handlers.forEach(cb=>cb(connection.id))}let postListener=msg=>{onPostMsg(msg,port)};port.onMessage.addListener(postListener);let disconnectListener=port2=>{if(port2.onMessage.removeListener(postListener),port2.onDisconnect.removeListener(disconnectListener),!portNameData)return;resolveUnfinishedCommunications(port2),connection.remotePort=void 0;let connectionIsRemoved=!1;if(connection.localPort||(connectionIsRemoved=!0,fromBg?state2.bgConnection=void 0:fromSidebar?state2.sidebarConnections.delete(srcWinId):fromSetup?state2.setupPageConnections.delete(srcTabId):fromSearch?state2.searchPopupConnections.delete(srcWinId):fromGroup?state2.groupPageConnections.delete(srcTabId):fromPreview&&(state2.previewConnection=void 0)),connectionIsRemoved){let handlers=disconnectionHandlers.get(srcType);handlers&&handlers.forEach(cb=>cb(connection.id))}};port.onDisconnect.addListener(disconnectListener);let conConfirmId=_localType===0?-1:-2;port.postMessage(conConfirmId)}var connectionHandlers=new Map;function onConnected(type,cb){type===0&&state2.bgConnection&&cb(NOID),type===2&&state2.sidebarConnections.forEach(con=>cb(con.id)),type===3&&state2.setupPageConnections.forEach(con=>cb(con.id)),type===4&&state2.searchPopupConnections.forEach(con=>cb(con.id)),type===1&&state2.groupPageConnections.forEach(con=>cb(con.id)),type===7&&state2.previewConnection&&cb(NOID);let handlers=connectionHandlers.get(type)??[];handlers.push(cb),connectionHandlers.set(type,handlers)}var disconnectionHandlers=new Map;function onDisconnected(type,cb){let handlers=disconnectionHandlers.get(type)??[];handlers.push(cb),disconnectionHandlers.set(type,handlers)}function runActionFor(msg){if(msg.action!==void 0&&actions){let action=actions[msg.action];if(action)return msg.arg?action(msg.arg):msg.args?action(...msg.args):action()}}var runningAsyncActions=new Map;async function onPostMsg(msg,port){if(msg<0){let waiting=msgsWaitingForAnswer.get(msg);waiting&&(clearTimeout(waiting.timeout),waiting.ok&&waiting.ok(),msgsWaitingForAnswer.delete(-1));return}if(typeof msg=="number"){let waiting=msgsWaitingForAnswer.get(msg);waiting&&clearTimeout(waiting.timeout);return}if(!msg.action&&msg.id){let waiting=msgsWaitingForAnswer.get(msg.id);waiting&&(clearTimeout(waiting.timeout),msg.error&&waiting.err?waiting.err(msg.error):waiting.ok&&waiting.ok(msg.result),msgsWaitingForAnswer.delete(msg.id));return}let result,error;try{result=runActionFor(msg)}catch(err3){error=String(err3),err(`IPC.onPostMsg: Error on running "${String(msg.action)}" action:`,err3)}if(msg.id&&port)if(result instanceof Promise){let msgId=msg.id;try{port.postMessage(msgId)}catch(err3){err(`IPC.onPostMsg: Error on sending "${String(msg.action)}" action confirm:`,err3);return}let finalResult,error2;try{runningAsyncActions.set(msgId,port.name),finalResult=await result}catch(err3){error2=String(err3)}if(runningAsyncActions.has(msgId))runningAsyncActions.delete(msgId);else return;try{port.postMessage({id:msgId,result:finalResult,error:error2})}catch(err3){err(`IPC.onPostMsg: Error on sending "${String(msg.action)}" action result:`,err3);return}}else try{port.postMessage({id:msg.id,result,error})}catch(err3){err(`IPC.onPostMsg: Error on sending "${String(msg.action)}" action result:`,err3)}}function onSendMsg(msg){if(msg.dstWinId!==void 0&&msg.dstWinId!==_localWinId||msg.dstType!==void 0&&msg.dstType!==_localType)return;let result;try{result=runActionFor(msg)}catch(err3){err(`IPC.onSendMsg: Error on running "${String(msg.action)}" action:`,err3)}if(result instanceof Promise)return result;if(result!==void 0)return Promise.resolve(result)}function setupConnectionListener(){browser.runtime.onConnect.addListener(onConnect)}function setupGlobalMessageListener(){browser.runtime.onMessage.addListener(onSendMsg)}function resolveUnfinishedCommunications(port){for(let[msgId,waiting]of msgsWaitingForAnswer)waiting.portName===port.name&&(clearTimeout(waiting.timeout),waiting.err&&waiting.err("IPC: Target disconnected"),msgsWaitingForAnswer.delete(msgId));for(let[msgId,portName]of runningAsyncActions)portName===port.name&&runningAsyncActions.delete(msgId)}function disconnectFrom(fromType,winOrTabId){if(winOrTabId===void 0&&(winOrTabId=NOID),fromType!==0&&fromType!==7&&winOrTabId===NOID)return err("IPC.disconnectFrom: No winOrTabId");let connection=getConnection(fromType,winOrTabId);if(!connection)return;connection.localPort&&(resolveUnfinishedCommunications(connection.localPort),connection.localPort.disconnect(),connection.localPort.onMessage.removeListener(connection.postListener),connection.localPort.onDisconnect.removeListener(connection.disconnectListener),connection.localPort=void 0),connection.remotePort&&(resolveUnfinishedCommunications(connection.remotePort),connection.remotePort.disconnect(),connection.remotePort.onMessage.removeListener(connection.postListener),connection.remotePort.onDisconnect.removeListener(connection.disconnectListener),connection.remotePort=void 0),clearTimeout(connectingTimeout);let connectionIsRemoved=!1;if(!connection.remotePort&&!connection.localPort&&(connectionIsRemoved=!0,fromType===0?state2.bgConnection=void 0:fromType===2?state2.sidebarConnections.delete(winOrTabId):fromType===3?state2.setupPageConnections.delete(winOrTabId):fromType===4?state2.searchPopupConnections.delete(winOrTabId):fromType===1?state2.groupPageConnections.delete(winOrTabId):fromType===7&&(state2.previewConnection=void 0)),connectionIsRemoved){let handlers=disconnectionHandlers.get(fromType);handlers&&handlers.forEach(cb=>cb(connection.id))}}var Store={set:set2,setFromRemoteFg,sync,storageChangeListener,onKeyChange},SIDEBAR_LISTENED_KEYS=["settings","sidebarCSS","sidebar","contextMenu","containers"],SETUP_LISTENED_KEYS=["settings","sidebarCSS","groupCSS","sidebar","contextMenu","containers","snapshots","keybindings"];function storageChangeListener(newValues){for(let[key,newValue]of Object.entries(newValues)){let handler=changeHandlers[key];handler&&handler(newValue)}}var storageBuf={},storageBufTimeout;async function _set(newValues,srcInfo){if(Info.isBg){let changesForSidebar,changesForSetup;for(let[key,newValue]of Object.entries(newValues)){SIDEBAR_LISTENED_KEYS.includes(key)&&(changesForSidebar?changesForSidebar[key]=newValue:changesForSidebar={[key]:newValue}),SETUP_LISTENED_KEYS.includes(key)&&(changesForSetup?changesForSetup[key]=newValue:changesForSetup={[key]:newValue});let handler=changeHandlers[key];handler&&newValue&&handler(newValue)}if(changesForSidebar)for(let[id,con]of state2.sidebarConnections)srcInfo&&srcInfo.type===con.type&&srcInfo.winId===con.id||sidebar(con.id,"storageChanged",changesForSidebar);if(changesForSetup)for(let[id,con]of state2.setupPageConnections)srcInfo&&srcInfo.type===con.type&&srcInfo.tabId===con.id||setupPage(con.id,"storageChanged",changesForSetup);return browser.storage.local.set(newValues)}else{let srcInfo2={type:Info.instanceType,winId:Windows.id,tabId:Info.currentTabId};return bg("saveInLocalStorage",newValues,srcInfo2)}}async function set2(newValues,delay){if(!delay)return _set(newValues);storageBuf={...storageBuf,...newValues},clearTimeout(storageBufTimeout),storageBufTimeout=setTimeout(()=>{_set(storageBuf),storageBuf={}},delay)}function setFromRemoteFg(newValues,srcInfo){_set(newValues,srcInfo)}var changeHandlers={};function onKeyChange(key,cb){if(changeHandlers[key])throw err(`Storage: onKeyChange: "${key}" handler already exists`);changeHandlers[key]=cb}async function sync(name,value){let keys=Object.keys(value),syncPropName=await Info.getProfileId()+"::"+name;if(keys.length){let time=Date.now(),ver=Info.reactive.addonVer;await browser.storage.sync.set({[syncPropName]:{value,time,name:Settings.state.syncName,ver}})}else await browser.storage.sync.remove(syncPropName)}async function loadPlatformInfo(){let info2=await browser.runtime.getPlatformInfo();Info.reactive.os=info2.os}async function loadVersionInfo(){let stored=await browser.storage.local.get(["ver","favAutoCleanTime"]);!stored.ver&&stored.favAutoCleanTime&&(stored.ver="4.0.0"),stored.ver&&(Info.prevMajorVersion=Info.getMajVer(stored.ver),Info.prevVersion=stored.ver),Info.majorVersion=Info.getMajVer(Info.reactive.addonVer)}function saveVersion(){Info.prevVersion!==Info.reactive.addonVer&&Store.set({ver:Info.reactive.addonVer},500)}function setInstanceType3(t){Info.instanceType=t,t===2?Info.isSidebar=!0:t===1?Info.isGroup=!0:t===3?Info.isSetup=!0:t===0?Info.isBg=!0:t===5?Info.isUrl=!0:t===6?Info.isProxy=!0:t===4?Info.isSearch=!0:t===7&&(Info.isPreview=!0)}function getInstanceName(instance){return instance===2?"sidebar":instance===0?"bg":instance===3?"setup":instance===1?"group":instance===6?"proxy":instance===5?"url":instance===4?"search":instance===7?"preview":"unknown"}function getMajVer(verStr){if(!verStr)return;let num=parseInt(verStr);if(!isNaN(num))return num}async function getProfileId(){let{profileID}=await browser.storage.local.get("profileID");return profileID||(profileID=uid(),Store.set({profileID})),profileID}function isFreshInstall(){return!Info.prevMajorVersion}function isMajorUpgrade(){return Info.prevMajorVersion===void 0||Info.majorVersion===void 0?!1:Info.prevMajorVersion!==Info.majorVersion}async function loadCurrentTabInfo(){let tab=await browser.tabs.getCurrent();Info.currentTabId=tab.id}function versionToInt(version){let parsed=version.split(".").map(n=>parseInt(n)),major=isNaN(parsed[0])?0:parsed[0],minor=isNaN(parsed[1])?0:parsed[1],patch=isNaN(parsed[2])?0:parsed[2];return(isNaN(parsed[3])?0:parsed[3])+patch*1e3+minor*1e6+major*1e9}var Info={reactive:{os:"unknown",addonVer:browser.runtime.getManifest().version},instanceType:-1,isSidebar:!1,isSetup:!1,isGroup:!1,isProxy:!1,isUrl:!1,isBg:!1,isSearch:!1,isPreview:!1,majorVersion:void 0,prevMajorVersion:void 0,prevVersion:void 0,currentTabId:NOID,...info_actions_exports};export{NavItemTypeNames,ButtonTypes,TabStatus,SubPanelType,DropType,MediaState,DEFAULT_CONTAINER,DEFAULT_CONTAINER_ID,CONTAINER_ID,TABS_MENU,TABS_PANEL_MENU,BOOKMARKS_MENU,BOOKMARKS_PANEL_MENU,LANG,translate,DEFAULT_SETTINGS,SETTINGS_OPTIONS,PRE_SCROLL,GROUP_URL,URL_URL,SETUP_URL,V4_GROUP_URL_LEN,V4_URL_URL_LEN,RGB_COLORS,COLOR_NAMES,FOLDER_NAME_DATA_RE,BTN_ICONS,DOMAIN_RE,NOID,NEWID,CONTAINER_ICON_OPTS,PANEL_ICON_OPTS,COLOR_OPTS,PROXY_OPTS,BKM_ROOT_ID,BKM_OTHER_ID,BKM_MENU_ID,uid,asap,debounce,wait,sleep,bytesToStr,strSize,uDate,uTime,getDomainOf,toRGBA,isV4GroupUrl,isV4UrlUrl,createGroupUrl,cloneArray,cloneObject,normalizeUrl,recreateNormalizedObject,updateObject,loadBinAsBase64,getDayStartMS,isNavBtn,isNavSpace,isNavPanel,isTabsPanel,isBookmarksPanel,isHistoryPanel,findLastIndex,getRandomFrom,Info,WebReq,reactive,initPopups,finishConfirmation,ask,openPanelPopup,closePanelPopup,closeContainerPopup,openNewTabShortcutsPopup,closeNewTabShortcutsPopup,closeSiteConfigPopup,openTabMoveRulesPopup,closeTabMoveRulesPopup,openTabReopenRulesPopup,closeTabReopenRulesPopup,SidebarConfigRState,initSidebarConfig,loadSidebarConfig,saveSidebarConfig,getSidebarConfigFromV4,createTabsPanelConfig,createBookmarksPanelConfig,createHistoryPanelConfig,setupSidebarConfigListeners,SetupPage,Notifications,Search,History,Permissions,MAX_COUNT_LIMIT,loadFaviconsData,resizeFavicon,getFavPlaceholder,reactive3 as reactive2,initFavicons,loadFavicons,set,getFavicon,fillIcon,favicons_fg_exports,DndPointerModeNames,DnD,Styles,Mouse,state,setTargetTab,resetTargetTab,closePreview,resetMode,closePreviewPopup,closePreviewInline,Tabs2 as Tabs,Bookmarks,Selection,updateWebReqHandlers,Sidebar,sort,MAX_SIZE_LIMIT,Snapshots,Menu,Containers,loadFavicons2,saveFavicon,upgradeFaviCache,favicons_bg_exports,Tabs as Tabs2,Windows,Settings,Store,versionToInt,setInstanceType,setWinId,setTabId,info,warn,err,setInstanceType2,setWinId2,setTabId2,registerActions,connectTo,sidebar,sendToSidebar,bg,broadcast,onConnected,onDisconnected,setupConnectionListener,setupGlobalMessageListener,ipc_exports};
