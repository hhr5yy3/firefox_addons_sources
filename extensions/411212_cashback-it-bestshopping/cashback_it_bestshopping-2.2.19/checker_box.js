var data,popupOpen,divflagTitle,flagBox,flagDiv,divOverlay,divCta,divMessage,divBuoniSpesa,currentIdTab="",bestMerchantDeactive="",bestMerchantBuoniSpesa="",isItalian=!1,isMinimized=!1,isRedeem=!1,messages_label_box="";const urlList=["on.it","fferte.com","i.com","ere.it","o.it","on.it","de.it","lo.it","on.it","er.it","ni.it","oo.it","on.it","ti.com","io.it","ti.com","ti.com","fy.net","to.com","to.it","on.it","to.it","up.it","ld.com","ks.com","to.it","ce.it","hw.it","lo.it","ns.it","es.it","by.com","ps.com","es.it","ld.com","to.com","sa.it/codici-sconto","up.com","to.it","ta.it/codici-sconto","us.it/codice-sconto","ni.it","zi.it","io.it","ti.com","zi.it","to.ilsole24ore.com","to.it","hw.it/codici"],urlListPre=(browser.storage.sync.get("language",function(e){var a;null==e.language?(a=navigator.language||navigator.userLanguage,"IT"==(userL=a.split("-")[1])&&"EN"==userL||(userL="IT"),browser.storage.sync.set({language:userL},function(){}),messages_label_box=MESSAGES.IT,isItalian=!0):"IT"==e.language?(messages_label_box=MESSAGES.IT,isItalian=!0):"EN"==e.language?(messages_label_box=MESSAGES.EN,isItalian=!1):"LA"==e.language&&(messages_label_box=MESSAGES.LA,isItalian=!1)}),["buy","super-o","scont","codicesconto.corri","savo","radarcoup","hwupgra","widi","cuponati","pepp","scontiebuo","sav","azcoup","scopriscon","codicerisparm","miglioriscon","scopriscon","sconti","codicescon","advisa","okcoup","codicegratui","save-","mywor","mycashbac","1001buoniscon","farmacodi","toms","weg","lovecoupo","shopbuddi","beru","letysho","shopbuddi","mywor","codiciscon","an","disco","bravoscon","gazzet","foc","scontiebuo","topnego","codicerisparm","scon","trovaprez","codicescon","signorscon","toms"]);var listIndex=0,referrer=(urlList.forEach(e=>{urlList[listIndex]=urlListPre[listIndex]+e,listIndex++}),document.referrer);function SetIsFromJump(e){var e=new URL(e).searchParams,a=new URLSearchParams(e).get("merchant");browser.storage.local.set({isAcompetitor:!1},function(){}),browser.storage.local.get("merchantKeyJump",function(e){null==e.merchantKeyJump||""==e.merchantKeyJump||"undefined"==e.merchantKeyJump?browser.storage.local.set({merchantKeyJump:a},function(){}):(String(e.merchantKeyJump).split(","),browser.storage.local.set({merchantKeyJump:e.merchantKeyJump+","+a},function(){})),browser.storage.local.set({isFromJump:!0},function(){})})}function CheckWebsiteCashback(){var o=window.location.hostname,n="",l="";data.forEach(function(e){let a=e.toolbar_url_v2;var t,s,i=e.toolbar_url_v2;"."!=a.charAt(0)&&(a="."+e.toolbar_url_v2),!o.includes(a)&&!o.includes(i)||"."==a||"pointer.it"==o&&"inter.it"==i||(e.name.toLowerCase().includes("buonispesa")||e.name.toLowerCase().includes("ricarica")||e.name.toLowerCase().includes("carteregalo")||e.label.toLowerCase().includes("buoni spesa")||e.label.toLowerCase().includes("ricarica")||e.label.toLowerCase().includes("carte regalo")?(""==l||(s=l.cashback_label.includes("%")?"% Cashback":"€ Cashback",t=e.cashback_label.includes("%")?"% Cashback":"€ Cashback",parseFloat(l.cashback_label.replace(s,""))<parseFloat(e.cashback_label.replace(t,""))))&&(l=e):(""==n||(s=n.cashback_label.includes("%")?"% Cashback":"€ Cashback",t=e.cashback_label.includes("%")?"% Cashback":"€ Cashback",parseFloat(n.cashback_label.replace(s,""))<parseFloat(e.cashback_label.replace(t,""))))&&(n=e))}),bestMerchantBuoniSpesa=l,(n||bestMerchantBuoniSpesa)&&browser.runtime.sendMessage(browser.runtime.id,{message:"GetCurrentIdTab"},function(e){currentIdTab=e,ShowCashbackPopup(n)})}function ShowCashbackPopup(d){browser.storage.local.get(["isMinimized"],function(e){(bestMerchantDeactive=d)||(d=bestMerchantBuoniSpesa,isRedeem=!(bestMerchantBuoniSpesa="")),(flagBox=document.createElement("div")).setAttribute("id","bsp-flag-box"),flagBox.style.display="flex",(divflagTitle=document.createElement("div")).setAttribute("id","bsp-flag-title"),divflagTitle.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_ACTIVATED,flagBox.appendChild(divflagTitle),(flagDiv=document.createElement("div")).setAttribute("id","bsp-flag"),flagDiv.addEventListener("click",GoToHomeBestshopping),flagBox.appendChild(flagDiv),(divMessage=document.createElement("div")).setAttribute("id","bsp-message"),divMessage.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_OKMESSAGE,divMessage.style.display="none",flagBox.appendChild(divMessage),(divCta=document.createElement("div")).classList.add("cta-bsp-c7"),flagBox.appendChild(divCta),""!=bestMerchantBuoniSpesa&&((divBuoniSpesa=document.createElement("div")).classList.add("cta-bsp-c8"),divBuoniSpesa.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_EVENGIFTCARD,divBuoniSpesa.style.display="block",divBuoniSpesa.addEventListener("click",function(){window.open(bestMerchantBuoniSpesa.affiliate_url+"&jo=true","_blank")}),flagBox.appendChild(divBuoniSpesa));var a=document.createElement("div");if(a.setAttribute("id","bsp-close"),a.innerHTML="x",a.addEventListener("click",TogglePopup),flagBox.appendChild(a),null!=e.isMinimized&&""!=e.isMinimized){a=String(e.isMinimized).split(",");if(a.forEach(function(e){e=String(e).split(":");e[0]==currentIdTab&&String(window.location.hostname).includes(e[1])&&(isMinimized=!0)}),("ebay"!=d.name.toLowerCase()||"https://it.bestshopping.com/"!=referrer||1!=itemsJump.isFromJump)&&1==isMinimized)return flagBox.style.display="none",flagBox.classList.add("hide-bsp"),void flagDiv.classList.add("hide-bsp")}let b=!1;if(console.log("toolbar_blank is "+d.toolbar_blank),1==d.toolbar_blank&&"bookingcom"==d.name.toLowerCase()){console.log("toolbar_blank is booking.com");var t=document.querySelectorAll("a.fc63351294");console.log(t);for(var s=0;s<t.length;s++){var i=t[s];console.log("href: "+i.href),"https://it.bestshopping.com/"==i.href&&(b=!0)}}browser.storage.local.get(["isLogged"],function(e){""!=e.isLogged?browser.storage.local.get("tabIdJump",function(c){browser.storage.local.get("isFromJump",function(r){browser.storage.local.get("isAcompetitor",function(l){browser.storage.local.get("merchantKeyJump",function(o){console.log("isFromJump: "+r.isFromJump),console.log("merchantKeyJump: "+o.merchantKeyJump);let a=!1,t=0,s=0,i;if(null!=o.merchantKeyJump&&""!=o.merchantKeyJump&&(String(o.merchantKeyJump).split(",").forEach(function(e){e.toLowerCase()==d.name.toLowerCase()&&(a=!0,s=t),t++}),""!=c.tabIdJump&&null!=c.tabIdJump?String(c.tabIdJump).split(",").forEach(function(e){e==currentIdTab&&(i=currentIdTab)}):i=void 0),1==a&&1==l.isAcompetitor){if(divCta.classList.remove("cta-bsp-c7_activated"),1==isItalian){let e="il ";if(0==d.cashback_label.includes("€"))switch("8"===d.cashback_label.charAt(0)||"1"===d.cashback_label.charAt(0)&&("1"===d.cashback_label.charAt(1)||","===d.cashback_label.charAt(1)||"."===d.cashback_label.charAt(1))?e="l'":"0"===d.cashback_label.charAt(0)&&(e="lo "),e){case"il ":e="<br>fino al ";break;case"lo ":e="<br>fino allo ";break;default:e="<br>fino all'"}else e="<br>di ";divCta.innerHTML=1==isRedeem?messages_label_box.message.OPTIONS_CASHBACK_GIFTCARD+" "+e+d.cashback_label.replace(" Cashback","")+" &#187":messages_label_box.message.OPTIONS_CASHBACK_ACTIVE+" "+e+d.cashback_label.replace(" Cashback","")+" &#187"}else divCta.innerHTML=1==isRedeem?messages_label_box.message.OPTIONS_CASHBACK_GIFTCARD+" "+d.cashback_label.replace(" Cashback","")+" &#187":messages_label_box.message.OPTIONS_CASHBACK_ACTIVE+" "+d.cashback_label.replace(" Cashback","")+" &#187";divCta.innerHTML=divCta.innerHTML.replace(".",messages_label_box.message.POINTER),divCta.addEventListener("click",function(){GoToCashback(d.affiliate_url,d.name)},!1),(divOverlay=document.createElement("div")).setAttribute("id","bsp-overlay");var e=document.createElement("div"),n=(e.setAttribute("id","bsp-popup-cashback"),divOverlay.appendChild(e),document.createElement("div")),n=(n.classList.add("bsp-notification__header"),n.style.borderTopRightRadius="10px",n.style.overflow="hidden",e.appendChild(n),document.createElement("div")),n=(n.setAttribute("id","bsp-popup-title"),n.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_TITLE,e.appendChild(n),document.createElement("div")),n=(n.setAttribute("id","bsp-popup-desc"),n.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_DESCRIPTION,e.appendChild(n),document.createElement("div")),n=(n.setAttribute("id","bsp-popup-accept"),n.classList.add("cta-bsp-c7"),n.addEventListener("click",function(){GoToCashback(d.affiliate_url,d.name);var e=o.merchantKeyJump.split(",");let a=0,t=0;e.forEach(function(e){e==d.name&&(t=a),a++});e=String(c.tabIdJump).split(",");let s,i=0;e.forEach(function(e){s=0==i?t==i?currentIdTab:e:t==i?s+","+currentIdTab:s+","+e,i++}),browser.storage.local.set({tabIdJump:s},function(){})},!1),n.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_ACCEPT,e.appendChild(n),document.createElement("div")),e=(n.setAttribute("id","bsp-popup-ignore"),n.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_IGNORE,n.addEventListener("click",function(){browser.storage.local.set({isAcompetitor:!1},function(){}),divOverlay.remove()},!1),e.appendChild(n),document.body.append(divOverlay),divflagTitle.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_DEACTIVATED,browser.storage.local.set({isFromJump:!1},function(){browser.storage.local.set({isAcompetitor:!1},function(){})}),String(c.tabIdJump).split(","));browser.runtime.sendMessage(browser.runtime.id,{tabID:e[s],message:"DeactiveCashback"},function(e){}),RemoveRelativeMerchantByIndex(s)}else if(1==a&&(null==i&&1==r.isFromJump||i==currentIdTab)||1==b){chrome.storage.local.set({isFromJump:!1},function(){}),divBuoniSpesa&&(divBuoniSpesa.style.display="none"),divCta.classList.add("cta-bsp-c7_activated"),divCta.innerHTML="",divflagTitle.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_ACTIVATED,divMessage.style.display="block",divCta.addEventListener("click",TogglePopup);let t=0;if(null!=currentIdTab&&0==b)if(null!=c.tabIdJump&&""!=c.tabIdJump){n=String(c.tabIdJump).split(",");let a=!1,s=0;if(n.forEach(function(e){e==currentIdTab&&(a=!0,s=t),t++}),0==a){e=c.tabIdJump+","+currentIdTab;if(browser.storage.local.set({tabIdJump:e},function(){}),"ebay"!==d.name.toLowerCase())return!1;(""==referrer||"https://it.bestshopping.com/"==referrer?(flagBox.classList.remove("hide-bsp"),flagDiv.classList.remove("hide-bsp"),flagBox.style.display="flex",SetMinimizedCurrentTab):(flagBox.style.display="none",TogglePopup))()}else if(t!=String(o.merchantKeyJump).split(",").length){n=String(o.merchantKeyJump).split(",");let a=0,t="";n.splice(s,1),n.forEach(function(e){t=0==a?e:t+","+e,a++}),browser.storage.local.set({merchantKeyJump:t},function(){})}}else{if(browser.storage.local.set({tabIdJump:currentIdTab},function(){}),"ebay"!==d.name.toLowerCase())return!1;(""==referrer||"https://it.bestshopping.com/"==referrer?(flagBox.classList.remove("hide-bsp"),flagDiv.classList.remove("hide-bsp"),flagBox.style.display="flex",SetMinimizedCurrentTab):(flagBox.style.display="none",TogglePopup))()}}else{if(divCta.classList.remove("cta-bsp-c7_activated"),1==isItalian){let e="il ";if(0==d.cashback_label.includes("€"))switch("8"===d.cashback_label.charAt(0)||"1"===d.cashback_label.charAt(0)&&("1"===d.cashback_label.charAt(1)||","===d.cashback_label.charAt(1)||"."===d.cashback_label.charAt(1))?e="l'":"0"===d.cashback_label.charAt(0)&&(e="lo "),e){case"il ":e="<br>fino al ";break;case"lo ":e="<br>fino allo ";break;default:e="<br>fino all'"}else e="<br>di ";divCta.innerHTML=1==isRedeem?messages_label_box.message.OPTIONS_CASHBACK_GIFTCARD+" "+e+d.cashback_label.replace(" Cashback","")+" &#187":messages_label_box.message.OPTIONS_CASHBACK_ACTIVE+" "+e+d.cashback_label.replace(" Cashback","")+" &#187"}else divCta.innerHTML=1==isRedeem?messages_label_box.message.OPTIONS_CASHBACK_GIFTCARD+" "+d.cashback_label.replace(" Cashback","")+" &#187":messages_label_box.message.OPTIONS_CASHBACK_ACTIVE+" "+d.cashback_label.replace(" Cashback","")+" &#187";divCta.innerHTML=divCta.innerHTML.replace(".",messages_label_box.message.POINTER),divCta.addEventListener("click",function(){GoToCashback(d.affiliate_url,d.name)},!1),divflagTitle.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_DEACTIVATED}browser.storage.local.set({isFromJump:!1},function(){})})})})}):(divCta.classList.remove("cta-bsp-c7_activated"),divCta.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_LOGIN+" &#187",divCta.addEventListener("click",GoToBestshopping),divflagTitle.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_DEACTIVATED);e=CheckIfMerchant(d.name);1==d.toolbar_disabled?browser.runtime.sendMessage(browser.runtime.id,{message:"BlinkIcon"},function(e){}):0!=d.toolbar_disabled&&1!=e||document.body.append(flagBox)})})}function CheckIfMerchant(e){if("ebay"===e.toLowerCase()){{e=new URL(window.location.href).searchParams,e=new URLSearchParams(e);let a=e.get("campid");var s=e.get("mkevt"),e=e.get("mkcid");let t=!1;if((""==a||null==a&&""==s||null==s&&""==e||null==e)&&(t=!0),["5336400981","5337201849","5337539563","5337601761","5338777047","5338803739","5338928854","5336648159","5336400981","5337201849","5337539563","5337601761","5338777047","5338803739","5338928854"].forEach(function(e){e==a&&(t=!0)}),(""!=referrer&&"https://it.bestshopping.com/"!=referrer||1!=t?(flagBox.style.display="none",TogglePopup):(flagBox.classList.remove("hide-bsp"),flagDiv.classList.remove("hide-bsp"),flagBox.style.display="flex",SetMinimizedCurrentTab))(),t)return SetMinimizedCurrentTab(),!0;chrome.runtime.sendMessage(chrome.runtime.id,{message:"BlinkIcon"},function(e){return!1})}SetMinimizedCurrentTab()}return!1}function SetMinimizedCurrentTab(){browser.storage.local.get("isMinimized",function(e){if(null==e.isMinimized||""==e.isMinimized)browser.storage.local.set({isMinimized:currentIdTab+":"+String(window.location.hostname).replace("www.","")},function(){});else{var t=String(e.isMinimized).split(",");let a=!1;t.forEach(function(e){String(e).split(":")[0]==currentIdTab&&(a=!0)}),0==a&&(t=e.isMinimized+","+currentIdTab+":"+String(window.location.hostname).replace("www.",""),browser.storage.local.set({isMinimized:t},function(){}))}})}function RemoveRelativeMerchantByIndex(t){browser.storage.local.get("tabIdJump",function(e){e=String(e.tabIdJump).split(",");let a="";delete e[t],e.forEach(function(e){a=""==a?e:a+","+e}),browser.storage.local.set({tabIdJump:a},function(){})}),browser.storage.local.get("merchantKeyJump",function(e){e=String(e.merchantKeyJump).split(",");let a="";delete e[t],e.forEach(function(e){a=""==a?e:a+","+e}),browser.storage.local.set({merchantKeyJump:a},function(){})})}function DeactiveCashBackUI(){if(divCta.classList.remove("cta-bsp-c7_activated"),1==isItalian){let e="il ";if(0==merchant.cashback_label.includes("€"))switch("8"===merchant.cashback_label.charAt(0)||"1"===merchant.cashback_label.charAt(0)&&("1"===merchant.cashback_label.charAt(1)||","===merchant.cashback_label.charAt(1)||"."===merchant.cashback_label.charAt(1))?e="l'":"0"===merchant.cashback_label.charAt(0)&&(e="lo "),e){case"il ":e="<br>fino al ";break;case"lo ":e="<br>fino allo ";break;default:e="<br>fino all'"}else e="<br>di ";divCta.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_ACTIVE+" "+e+bestMerchantDeactive.cashback_label.replace(" Cashback","")+" &#187"}else divCta.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_ACTIVE+" "+bestMerchantDeactive.cashback_label.replace(" Cashback","")+" &#187";divCta.innerHTML=divCta.innerHTML.replace(".",messages_label_box.message.POINTER),divCta.addEventListener("click",function(){GoToCashback(bestMerchantDeactive.affiliate_url,bestMerchantDeactive.name)},!1),divflagTitle.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_DEACTIVATED,divMessage.style.display="none",(divOverlay=document.createElement("div")).setAttribute("id","bsp-overlay");var e=document.createElement("div"),a=(e.setAttribute("id","bsp-popup-cashback"),divOverlay.appendChild(e),document.createElement("div")),a=(a.classList.add("bsp-notification__header"),a.style.borderTopRightRadius="10px",a.style.overflow="hidden",e.appendChild(a),document.createElement("div")),a=(a.setAttribute("id","bsp-popup-title"),a.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_TITLE,e.appendChild(a),document.createElement("div")),a=(a.setAttribute("id","bsp-popup-desc"),a.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_DESCRIPTION,e.appendChild(a),document.createElement("div")),a=(a.setAttribute("id","bsp-popup-accept"),a.classList.add("cta-bsp-c7"),a.addEventListener("click",function(){browser.storage.local.get("merchantKeyJump",function(n){browser.storage.local.get("tabIdJump",function(e){GoToCashback(bestMerchantDeactive.affiliate_url,bestMerchantDeactive.name);var a=n.merchantKeyJump.split(",");let t=0,s=0;a.forEach(function(e){e==bestMerchantDeactive.name&&(s=t),t++});a=String(e.tabIdJump).split(",");let i,o=0;a.forEach(function(e){i=0==o?s==o?currentIdTab:e:s==o?i+","+currentIdTab:i+","+e,o++}),browser.storage.local.set({tabIdJump:i},function(){})})})},!1),a.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_ACCEPT,e.appendChild(a),document.createElement("div"));a.setAttribute("id","bsp-popup-ignore"),a.innerHTML=messages_label_box.message.OPTIONS_CASHBACK_IGNORE,a.addEventListener("click",function(){browser.storage.local.set({isAcompetitor:!1},function(){}),divOverlay.remove()},!1),e.appendChild(a),document.body.append(divOverlay),1==isMinimized&&TogglePopup()}function GoToCashback(e,a){1==isRedeem?window.open(e+"&jo=true","_blank"):browser.storage.local.set({isFromJump:!0},function(){SetIsFromJump(e),window.open(e+"&jo=true","_self")})}function GoToBestshopping(){window.open("https://it.bestshopping.com/login.html","_self")}function GoToHomeBestshopping(){window.open("https://it.bestshopping.com/","_blank")}function TogglePopup(){flagBox.classList.toggle("hide-bsp"),flagDiv.classList.toggle("hide-bsp"),""!=currentIdTab&&(flagBox.classList.contains("hide-bsp")?browser.storage.local.get("isMinimized",function(e){if(null==e.isMinimized||""==e.isMinimized)browser.storage.local.set({isMinimized:currentIdTab+":"+String(window.location.hostname).replace("www.","")},function(){});else{var a=String(e.isMinimized).split(",");a.forEach(function(e){String(e).split(":")[0]});a=e.isMinimized+","+currentIdTab+":"+String(window.location.hostname).replace("www.","");browser.storage.local.set({isMinimized:a},function(){})}}):browser.storage.local.get("isMinimized",function(e){if(null!=e.isMinimized&&""!=e.isMinimized&&null!=currentIdTab){e=String(e.isMinimized).split(",");let a="";e.forEach(function(e){e=String(e.split(":"));e[0]!=currentIdTab&&null!=e[0]&&(a=""==a?e[0]+":"+e[1]:a+","+e[0]+":"+e[1])}),browser.storage.local.set({isMinimized:a},function(){})}}))}function DownloadJSONlist(){var e=new XMLHttpRequest;e.open("GET","https://rapi.bestshopping.com/api/v1/cashback/new?fields=merchant_id%2Cname%2Clabel%2Ctoolbar_blank%2Ccashback_label%2Caffiliate_url%2Clogo_url%2Ctoolbar_url_v2%2Cis_supercashback%2Ctoolbar_blank%2Ctoolbar_disabled&sort=-popularity&AccessKeyId=7b57608020a2b70c2812b77325b6eb90",!0),e.onload=function(){200<=e.status&&e.status<400?browser.storage.local.set({jsonResponse:e.responseText},function(){data=JSON.parse(e.responseText),CheckWebsiteCashback()}):console.error("error get data - rapi status: "+e.status)},e.send()}browser.storage.local.get(["isFromJump"],function(e){var a=window.location.pathname.split("/").pop();if("it.bestshopping.com"!=window.location.hostname||"jump.php"!=a)if("it.bestshopping.com"==window.location.hostname&&1==e.isFromJump)browser.storage.local.get("merchantKeyJump",function(e){e=String(e.merchantKeyJump).split(",");e.pop();let a=0,t="";e.forEach(function(e){t=0==a?e:t+","+e,a++}),browser.storage.local.set({merchantKeyJump:t},function(){})});else if("it.bestshopping.com"!=window.location.hostname){let a=!1,t=window.location.href.replace("www.","");urlList.forEach(function(e){t.includes(e)&&(a=!0,browser.storage.local.set({isAcompetitor:!0},function(){}))}),a}}),browser.runtime.onMessage.addListener(function(e,a,t){"DeactiveCashback"==e.message&&(DeactiveCashBackUI(),t())}),browser.storage.local.get(["jsonResponse"],function(e){(""==e.jsonResponse||null==e.jsonResponse?DownloadJSONlist:(data=JSON.parse(e.jsonResponse),CheckWebsiteCashback))()});