import{browser_ as e,OnFirefox as t,post_ as r}from"./async_bg.js";import{bgSettings_ as n,Option_ as s,oTrans_ as i}from"./options_base.js";let l=/\s/g,a=(e,t)=>{let r=0,n=e.length,s=t;for(;s<n;s++)switch(e[s]){case"{":case"[":r++;break;case"]":case"}":if(--r,r>0)break;default:{let t=('"'===e[s]?/^"([^"\\]|\\[^])*"/:r>0?/^(?:[$a-zA-Z_][$\w]*|\d[\d.eE+-]|\s+)/:/^\S+/).exec(e.slice(s));if(!t&&!r&&/\s/.test(e[s]))return s;s+=t?t[0].length-1:0}}if(r>0){let r=/^\S*/.exec(e.slice(t));return t+(r?r[0].length:0)}return s},o={n:0,i:null,R(){function e(e,t,r){let n="";r.length>2&&":"===r[r.length-2]&&(n=r.slice(-2),r=r.slice(0,-2)),t=t.toLowerCase();let s=r.length>1,i=t.includes("s-"),l=r.toUpperCase();if(!s){if(!t)return e;if(i&&t.length<3)return n?`<${l}${n}>`:l}if(t.includes("v-"))return`<v-${r}>`;let a=r.toLowerCase();var o;return t=(o=t).length<4?o:o.slice(0,-1).split("-").sort().join("-")+"-",r!==a&&!i&&(t+="s-"),t||s||n?`<${t}${a}${n}>`:r}this.i=t=>t.replace(/<(?!<)((?:[ACMSVacmsv]-){0,4})(.[^>]*)>/g,e),this.R=null},l:(e,t)=>t?"\\u00"+t:"\\\\",c(e){let t=e.slice(1),r="",n="";t.startsWith('"')&&t.endsWith('"')?(r=t.slice(1,-1),r=r.replace(/\\(?:x([\da-z]{2})|\\)/gi,o.l),t=`"${r}"`):t&&"{[".includes(t[0])&&(t=t.replace(/([{,](?: |\x7f\d*\x80)*)(\w+):|"(?:[^"\\]|\\[^])*"/g,(e,t,r)=>t?`${t}"${r}":`:e),n=t);let s=t.includes("\x7f"),i=s&&!r?(/^(?:\x7f\d*\x80)+/.exec(t)||[""])[0]:"",a=!s||r?"":(/(?:\x7f\d*\x80)+$/.exec(t.slice(i.length+1))||[""])[0];try{let r=JSON.parse(s?t.replace(/\x7f\d*\x80/g,""):t);if("string"!=typeof r&&!/\s/.test(t))return true===r?"":n?"="+n:e;t=s?JSON.parse(t.slice(i.length,a?-a.length:void 0)):r}catch(e){t=s?r||t.slice(i.length,a?-a.length:void 0):r||t}return t=t&&"string"==typeof t?t.replace(/\\(\\|s)/g,(e,t)=>"s"===t?" ":e):t,t=t&&JSON.stringify(t).replace(l,o.d),"="+i+t+a},d:e=>"\\u"+(e.charCodeAt(0)+1048576).toString(16).slice(2),ee(e,t,r,n,s){let i=o.i(n);if(i!==n&&(console.log("KeyMappings Checker:",n,"is corrected into",i),n=i),"mapkey"===r.toLowerCase()){let e=/^\S+/.exec(s.trimLeft()),t=e&&e[0],r=t&&o.i(t);r!==t&&(console.log("KeyMappings Checker:",t,"is corrected into",r),s=s.replace(t,r))}else if(!r.startsWith("unmap")){let e=s.trimLeft().split(/\s/,1)[0];if(e){let t=s.indexOf(e)+e.length;n+=s.slice(0,t),s=s.slice(t)}}return o.te("",t,n,s)},re:(e,t,r)=>t.replace("map","mapKey")+(3===r.length?r[1]:r),te(e,t,r,n){if(/\s(createTab|openUrl)/.test(r)&&!/\surls?=/i.test(n)&&(n=o.ne(n)),!n)return t+r;let s=0,i=-1,u="";for(;i<n.length&&(i=n.indexOf("=",i+1),u+=n.slice(s,i>=0?i:void 0),!(i<0));){let e=i+1;if(e<n.length&&'"[{'.includes(n[e]))e=a(n,e);else{l.lastIndex=i;let t=l.exec(n);e=t?t.index:n.length}u+=o.c(n.slice(i,e)),s=i=e}return t+r+u},ne(e){let t=[];e=(e+" ").replace(/\s+(\w+:[^=\s]+|[^\s=]+:\/\/\S+)(?=\s|$)/g,(e,r)=>(t.push(r),"")).trimRight();let r=t.length;return e+(r>1?" urls=":r?" url=":"")+(r?JSON.stringify(r>1?t:t[0]):"")},C(e){return e?(this.R&&this.R(),e=(e=(e=(e=(e=(e=e.replace(/\\(?:\n|\\\n[^\S\n]*)/g,e=>"\n"===e[1]?"\x7f\x80":`\x7f${e.length-3}\x80`)).replace(/^([ \t]*(?:#\s?)?map\s+(?:<(?!<)(?:.-){0,4}.[\w:]*?>|\S)\s+)(<(?!<)(?:[ACMSVacmsv]-){0,4}.\w*?>|\S)(?=\s|$)/gm,this.re)).replace(/^([ \t]*(?:#\s?)?(map(?:[kK]ey|!)?|run!?|unmap!?)\s+)(\S+)([^\n]*)/gm,this.ee)).replace(/^([ \t]*(?:#\s?)?(?:command|shortcut)\s+)(\S+)([^\n]*)/gm,this.te)).replace(/\x7f(\d*)\x80/g,(e,t)=>""===t?"\\\n":"\\\\\n"+" ".repeat(+t))).replace(/\\(?:\n|\\\n\s*)$/,"").trim()):e}};s.D.keyMappings.T=o,s.D.searchUrl.T={n:0,C(e){return r(14,e).then(e=>{let t=s.D.searchUrl;if(null==e)return t.E();let r=e[1];if(!e[0]){let e=i("nonPlainURL",[r]);return console.log("searchUrl checker:",e),t.se(e),t.E()}return t.se(""),r})}},s.D.newTabUrl.T={n:0,C(t){return r(13,/^\/?pages\/[a-z]+.html\b/i.test(t)?e.runtime.getURL(t):t.toLowerCase()).then(([e,r])=>{e=e.split("?",1)[0].split("#",1)[0];{let t="";/^chrome|^(javascript|data|file):|^about:(?!(newtab|blank)\/?$)/i.test(e)&&(t=i("refusedURLs",[e]),console.log("newTabUrl checker:",t)),s.D.newTabUrl.se(t)}return t.startsWith("http")||1!==r&&!/^(?!http|s?ftp)[a-z\-]+:\/?\/?newtab\b\/?/i.test(t)?t:n.r.newTabUrl})}},s.D.vimSync.K=function(){if(!this.O&&true===this.z()){let e=s.D,t=0;for(let r in e)e[r].O||++t;let r=t>1;if(setTimeout(alert,100,i(r?"changedBeforeSync":"warningForSync")),r)return false}return true},s.D.keyboard.T={n:0,C:e=>null==e||e.length<2||!(e[0]>0&&e[0]<4e3)||!(e[1]>0&&e[1]<1e3)?n.r.keyboard:[+e[0],+e[1]].concat(e.slice(2))};