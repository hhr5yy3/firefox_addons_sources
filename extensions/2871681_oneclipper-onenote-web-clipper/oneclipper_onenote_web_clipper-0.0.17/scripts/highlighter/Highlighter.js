var I=Object.defineProperty;var k=(n,t)=>()=>(n&&(t=n(n=0)),t);var E=(n,t)=>{for(var i in t)I(n,i,{get:t[i],enumerable:!0})};var H={};E(H,{HighlightRange:()=>c});function R(n){let t=n.nodeType===Node.TEXT_NODE?n.parentElement:n,i=[t.markerIdx],e=t;for(;(e=e.parentElement)&&e!==document.body;)i.push(e.markerIdx);return i.reverse()}function C(n){let t=0,i=n.previousSibling;for(;i;)i=i.previousSibling,t++;return t}function y(n,t){let i=[],e=t.parentElement;for(;e!==n;)i.push(e.markerIdx),e=e.parentElement;return i.length!==0?i.reverse():null}var c,S=k(()=>{c=class{constructor(t,i="#ffff00",e){let s=C(t.startContainer),h=C(t.endContainer);this.markerId=e,this.startTxtNodeIdx=s,this.startOffset=t.startOffset,this.endTxtNodeIdx=h,this.endOffset=t.endOffset,this.color=i;let o=t.commonAncestorContainer;this.commonParentTree=R(o),t.startContainer===t.endContainer?this.startParents=this.endParents=null:(this.startParents=y(o,t.startContainer),this.endParents=y(o,t.endContainer))}}});S();var f=class{highlighters=new Map([[0,new Highlight]]);highlightRangeStack=[];highlightedRanges=new Map;position=0;pageId;constructor(){this.pageId=location.href.split("#",1)[0].slice(8,100),this.fetchSavedHighlights(),document.body.addEventListener("keyup",t=>t.ctrlKey&&t.shiftKey&&this.undoRedo[t.code]?.())}addChildIndexOnElem(){function t(i){for(let e=0;e<i.length;e++){let s=i[e];Object.defineProperty(s,"markerIdx",{value:e}),s.childElementCount>0&&t(s.children)}}t(document.body.children)}async saveAllHighlights(){this.addChildIndexOnElem();let{HighlightRange:t}=await Promise.resolve().then(()=>(S(),H)),i=(await chrome.storage.local.get(this.pageId))[this.pageId]??{};this.highlightedRanges.forEach((e,s)=>{i[s]??=new t(e,"#ffff00",s)}),await chrome.storage.local.set({[this.pageId]:i})}undoRedo={KeyZ:async()=>{if(this.position<0)return;this.position--;let t=this.highlightRangeStack[this.position];this.highlighters.get(t.index).delete(t.range),this.removeHightlightFromStore(t.markerId)},KeyY:()=>{if(this.position>=this.highlightRangeStack.length)return;let t=this.highlightRangeStack[this.position];this.highlighters.get(t.index).add(t.range),this.saveHightlightInStore(t.range,t.color,t.markerId),this.position++},KeyH:this.deleteHighlight.bind(this)};async removeHightlightFromStore(t){let i=(await chrome.storage.local.get(this.pageId))[this.pageId]??{};delete i[t],await chrome.storage.local.set({[this.pageId]:i})}async saveHightlightInStore(t,i,e){if(!e)throw new Error("MarkerId cannot undefined");let s=new c(t,i,e),h=(await chrome.storage.local.get(this.pageId))[this.pageId]??{};h[e]=s,await chrome.storage.local.set({[this.pageId]:h})}applyHighlight(t,i){try{let e=function(a,g=document.body){for(let m of a)g=g.children[m];return g},s=e(t.commonParentTree),h=new Range,r=(t.startParents?e(t.startParents,s):s).childNodes[t.startTxtNodeIdx];h.setStart(r,t.startOffset);let u=(t.endParents?e(t.endParents,s):s).childNodes[t.endTxtNodeIdx];h.setEnd(u,t.endOffset),this.setHighlightRange(h,t.color,s,t.markerId)}catch(e){i!==void 0?setTimeout(()=>this.applyHighlight(t),1e3):console.error(e.message)}}async fetchSavedHighlights(){let t=(await chrome.storage.local.get(this.pageId))[this.pageId];if(!t)return;let i=Object.values(t);i.length!==0&&(i.forEach(this.applyHighlight.bind(this)),this.position=i.length)}deleteHighlight(){let t=getSelection();if(t.isCollapsed)return;let i=t.getRangeAt(0),e=i.commonAncestorContainer,s=e.nodeType===1?e:e.parentElement;for(let h in s.dataset){if(!h.startsWith("markerid"))continue;let o=s.dataset[h],r=this.highlightedRanges.get(o),d=+h.replace("markerid","")||0;if(!(!r.intersectsNode(t.focusNode)||r.comparePoint(i.startContainer,i.startOffset)!==0)){this.highlighters.get(d).delete(r),this.removeHightlightFromStore(o),t.removeAllRanges();break}}}clearHighlights(){this.highlighters.forEach(t=>t.clear())}async removeHighlights(){this.clearHighlights(),await chrome.storage.local.remove(this.pageId)}};var x=class extends f{constructor(){super(),this.highlightSheet=new CSSStyleSheet,CSS.highlights.set("oneClipper",this.highlighters.get(0)),this.highlightSheet.insertRule(":scope {--highlight-clr:yellow; --text-clr:black}"),this.highlightSheet.insertRule("*::highlight(oneClipper) {background-color: var(--highlight-clr);color:black}"),document.adoptedStyleSheets.push(this.highlightSheet),this.highlightSelected("#ffff00",!0)}addCssHighlight(t){t??=this.highlighters.size-1;let i=new Highlight;this.highlighters.set(t,i),this.highlightSheet.insertRule(`*::highlight(oneClipper${t}) { background-color:var(--highlight${t}-clr,var(--highlight-clr)); color:var(--text${t}-clr,var(--text-clr)) }`),CSS.highlights.set("oneClipper"+t,i)}async sendSelectedContents(t){let i=new Set(["BLOCKQUOTE","PRE","OL","UL"]),e=t.commonAncestorContainer.nodeType===1?t.commonAncestorContainer:t.commonAncestorContainer.parentElement,s=i.has(e.parentElement.tagName)?e.parentElement.tagName:e.tagName,h=document.createElement(s.toLowerCase());h.appendChild(t.cloneContents());let o=await chrome.runtime.sendMessage({htmlContent:h.outerHTML});if(o.errCaused)return alert(o.errCaused)}async highlightSelected(t,i){t.startsWith("#")||(t="#"+t);let e=getSelection();if(e.isCollapsed)return;let s=e.getRangeAt(0);await this.setAndSaveHighlight(s,t),i&&await this.sendSelectedContents(s),e.removeAllRanges(),l?.isConnected||P()}async setAndSaveHighlight(t,i){let e=t.commonAncestorContainer;e.markerIdx===void 0&&this.addChildIndexOnElem();let s=e.nodeType===1?e:e.parentElement,h=this.setHighlightRange(t,i,s)}addHighlight(t,i,e=0){this.highlighters.has(e)||this.addCssHighlight(e),this.highlighters.get(e).add(i),this.highlightedRanges.set(t,i),this.highlightRangeStack.push({index:e,range:i}),this.position++}setHighlightRange(t,i,e,s){let h=Object.keys(e.dataset).filter(o=>o.startsWith("markerid"));if(h.length!==0){for(let g in e.dataset){let m=e.dataset[g],p=this.highlightedRanges.get(m);if(p&&!i&&p.intersectsNode(t.startContainer)&&p.comparePoint(t.startContainer,t.startOffset)===0){let w=+g.replace("markerid","")||0;this.highlighters.get(w).delete(p),this.removeHightlightFromStore(m);return}}let o=h.sort().at(-1),r=e.dataset[o],[d,u]=r.split(":"),a=(+u||0)+1;return s=`${d}:${a}`,e.dataset["markerid"+a]=s,e.style.setProperty(`--highlight${a}-clr`,i),this.addHighlight(s,t,a),s}return s??=Math.random().toString(36).slice(2),e.dataset.markerid=s,e.style.setProperty("--highlight-clr",i),this.addHighlight(s,t),s}};globalThis.oneClipperHighlighter=new x;async function b(){async function n(){await oneClipperHighlighter.saveAllHighlights(),l.remove()}if(await chrome.runtime.sendMessage({msg:"checkPermission"})){n();let{hightlightOn:i}=await chrome.storage.sync.get("hightlightOn");i||(chrome.storage.sync.set({hightlightOn:!0}),chrome.runtime.sendMessage({msg:"toggle_highlight",hightlightOn:!0}))}else alert(chrome.i18n.getMessage("permission_denied"))}var l;function P(){l=document.createElement("save-highlight"),l.textContent=chrome.i18n.getMessage("save_highlights"),document.body.appendChild(l),l.addEventListener("click",b)}var v=new CSSStyleSheet;v.replace(`
save-highlight {
	border-radius: 10px;
	padding: 2px 5px;
	font-size: 16px;
	color: white;
	background-color: Orange;
	box-shadow: rgba(0, 0, 0, 0.25) 0px 14px 28px, rgba(0, 0, 0, 0.22) 0px 10px 10px;
	position: fixed;
	bottom: 1em;
	right: 1em;
	z-index:2200;
    cursor:pointer;
}`);document.adoptedStyleSheets.push(v);chrome.runtime.onMessage.addListener((n,t,i)=>{n==="highlightTxt"?(oneClipperHighlighter.highlightSelected("#ffff00",!0),i("highlighted")):n.msg==="deletePage"&&(oneClipperHighlighter.undoRedo.KeyZ(),alert(i18n("selected_page_is_deleted")))});
