class BaseScreenCapturer{#registerRuntimeChannel(){throw new Error("Not implemented")}async captureCurrentTab(){throw new Error("Not implemented")}}function debugCanvas(e){var t=document.createElement("img");t.src=e.toDataURL(),document.body.appendChild(t)}class ForegroundScreenCapturer extends BaseScreenCapturer{#captureImages;#pixelRatio;#MAX_PRIMARY_DIMENSION;#MAX_AREA;#screenCapturerScroll;#devicePixelInfo;constructor(){super(),this.#initShortcut(),this.#registerRuntimeChannel(),eagle.shortcuts.changed(()=>{this.#initShortcut()})}get devicePixelInfo(){return this.#devicePixelInfo}#initShortcut(){var e;eagle.preference.keybindings["capture-area"]&&(e=eagle.preference.keybindings["capture-area"].replace(/\s/g,"").toLowerCase(),Mousetrap.bind(e,eagle.utils.debounce(async e=>{if(await eagle.env.isReady())return e.preventDefault(),this.captureArea(),!1},500,!0))),eagle.preference.keybindings["capture-visible"]&&(e=eagle.preference.keybindings["capture-visible"].replace(/\s/g,"").toLowerCase(),Mousetrap.bind(e,eagle.utils.debounce(async e=>{if(await eagle.env.isReady())return e.preventDefault(),this.captureVisible(),!1},500,!0))),eagle.preference.keybindings["capture-entire"]&&(e=eagle.preference.keybindings["capture-entire"].replace(/\s/g,"").toLowerCase(),Mousetrap.bind(e,eagle.utils.debounce(async e=>{if(await eagle.env.isReady())return e.preventDefault(),this.capturePage(),!1},500,!0)))}#registerRuntimeChannel(){eagle.runtime.onMessage("capture-visible",async(e,t,a)=>(this.captureVisible(),a(),!0)),eagle.runtime.onMessage("capture-area",async(e,t,a)=>(this.captureArea(),a(),!0)),eagle.runtime.onMessage("capture-page",async(e,t,a)=>(this.capturePage(),a(),!0))}async#updateDevicePixelRatio(){var e=await eagle.screenCapturer.captureCurrentTab(),t=new Image,e=(t.src=e,await eagle.utils.imageLoaded(t),parseFloat((t.width/window.innerWidth).toFixed(2))),a=!eagle.preference.useRetina&&t.width>window.innerWidth,a=a?{devicePixelRatio:e,width:window.innerWidth,height:t.height*(window.innerWidth/t.width),force1x:a,force1xRatio:t.width/window.innerWidth}:{devicePixelRatio:e,width:t.width,height:t.height};return eagle.preference.useRetina||(t.width,window.innerWidth),this.#devicePixelInfo=a}async captureVisible(){if(await eagle.env.isReady()){await this.#updateDevicePixelRatio();var a=eagle.preference.captureFormat||"png";let e=await this.captureCurrentTab({format:a,quality:100}),t=(!eagle.preference.useRetina&&1<this.#devicePixelInfo.devicePixelRatio&&(e=await this.#resizeBase64(e,1/this.#devicePixelInfo.devicePixelRatio,a)),{behavior:"capture-visible",type:"image",version:eagle.extension.manifest.version,title:eagle.utils.clearWeirdCharacters(document.title).substr(0,65),url:location.href,src:e,width:this.#devicePixelInfo.width,height:this.#devicePixelInfo.height});eagle.env.shouldShowNewCollectWindow()?(eagle.collectWindow.open({...t,onCollect:e=>{eagle.item.addFile({...t,...e})}}),eagle.collectWindow.updateResolution(t.width,t.height)):await eagle.item.addFile(t)}}async captureArea(e){await eagle.env.isReady()&&new Cropper({onClose:()=>{},onCropped:async e=>{await this.#updateDevicePixelRatio(),this.#startScrollCapture(e)}})}async capturePage(){await eagle.env.isReady()&&(await this.#updateDevicePixelRatio(),this.#startScrollCapture())}async captureCurrentTab(e){return document.documentElement.classList.add("eagle-scrolling"),await eagle.utils.sleep(100),e=await eagle.runtime.sendMessage("capture-current-tab",{options:e}),document.documentElement.classList.remove("eagle-scrolling"),e}#startScrollCapture(e){this.#captureImages=[],this.#pixelRatio=this.#devicePixelInfo.devicePixelRatio,this.#MAX_PRIMARY_DIMENSION=eagle.env.canvas.maxSide,this.#MAX_AREA=eagle.env.canvas.maxArea,this.#screenCapturerScroll=new ScreenCapturerScroll({screenCapturer:this,onScroll:e=>{var t=e.base64;if(t){const a=new Image;a.addEventListener("load",()=>{a.removeEventListener("load",onload),this.#captureImages.push({image:a,data:e}),1==e.complete&&this.#endScrollCapture(e)}),a.src=t}}}),this.#screenCapturerScroll.start(e)}async#endScrollCapture(e){const t=this.#combineImagesToCanvases(e),a=eagle.preference.captureFormat||"png",n=t.map(e=>({width:e.width,height:e.height,base64:e.toDataURL("png"===a?"image/png":"image/jpeg",1)}));if(eagle.env.shouldShowNewCollectWindow()){const s={type:"image",version:eagle.extension.manifest.version,title:eagle.utils.clearWeirdCharacters(document.title).substr(0,65),url:location.href,src:n[0].base64};e.rect?(s.behavior="capture-area",s.width=e.rect.width,s.height=e.rect.height):(s.behavior="capture-page",s.width=n[0].width,s.height=n.reduce((e,t)=>e+t.height,0)),eagle.collectWindow.open({type:"image",width:s.width,height:s.height,src:s.src,title:s.title,onCollect:async e=>{var t,a,i={...s,...e},r=1<n.length;for([t,a]of n.entries())i.src=a.base64,i.title+=r?" - "+(t+1):"",await eagle.item.addFile(i)}}),eagle.collectWindow.updateResolution(s.width,s.height)}else n.forEach((e,t)=>{eagle.item.addScreenshot({base64:e.base64,indexStr:1<n.length?" #"+(t+1):""})});setTimeout(()=>{$("#screen-capturer-progress").remove(),t.forEach(e=>{e.getContext("2d").clearRect(0,0,e.width,e.height)})},1e3)}#combineImagesToCanvases(e){let r;if(e.rect)r=e.rect,this.#devicePixelInfo.force1x||(t=this.#devicePixelInfo.devicePixelRatio,r.x=r.x*t,r.y=r.y*t,r.width=r.width*t,r.height=r.height*t);else if(r={width:e.totalWidth,height:e.totalHeight,x:0,y:0},this.#devicePixelInfo.force1x){const t=this.#devicePixelInfo.width/r.width;r.width=this.#devicePixelInfo.width,r.height*=t}var t=r.width*this.#MAX_PRIMARY_DIMENSION;t>this.#MAX_AREA&&(this.#MAX_PRIMARY_DIMENSION=this.#MAX_PRIMARY_DIMENSION*(this.#MAX_AREA/t));let o=99999999,n=this.#captureImages[0].image.height;for(let e=0;e<this.#captureImages.length;e++){var a=this.#captureImages[e].data.y*this.#devicePixelInfo.devicePixelRatio;a<o&&(o=a)}let i=0,s=[],c=[];this.#captureImages=this.#captureImages.sort((e,t)=>e.data.y-t.data.y);for(let e=0;e<this.#captureImages.length;e++){var h=this.#captureImages[e];i+h.image.height>this.#MAX_PRIMARY_DIMENSION?(i=0,s.push(c),c=[]):i+=h.image.height,c.push(h)}0<c.length&&s.push(c);let l=[],g=0,u=(s.forEach((e,t)=>{var a,a=(e=e.sort((e,t)=>t.data.y-e.data.y))[0].data.y*this.#pixelRatio-o+n-g,i=document.createElement("canvas");let h=i.getContext("2d");i.height=Math.min(a,this.#MAX_PRIMARY_DIMENSION),i.width=e[0].image.width,this.#devicePixelInfo.force1x?(i.height/=this.#devicePixelInfo.force1xRatio,i.width=this.#devicePixelInfo.width):eagle.env.browser.isFirefox()&&1<s.length&&t!==s.length&&(i.height-=3,r.height-=3),e.forEach((e,t)=>{var a=e.data.y*this.#pixelRatio-o-g;if(this.#devicePixelInfo.force1x){var i=e.image.width,r=e.image.height,n=a/this.#devicePixelInfo.force1xRatio,s=e.image.width/this.#devicePixelInfo.force1xRatio,c=e.image.height/this.#devicePixelInfo.force1xRatio;h.drawImage(e.image,0,0,i,r,0,n,s,c)}else if(eagle.env.browser.isFirefox()){i=e.image.width,r=e.image.height;const n=Math.floor(a);s=0===t?0:3,h.drawImage(e.image,0,0,i,r-s,0,n,i,r-s)}else h.drawImage(e.image,0,a);e.image.src="",e.image=null,delete e.image}),l.push(i),g+=a}),eagle.logger.info(`[background] merge ${s.length} piece image...`),this.#captureImages=[],r.x),d=r.y,p=r.width,m=r.height,w=0,I=0,v=0,f=[];var x=Math.ceil(m/this.#MAX_PRIMARY_DIMENSION);let R=m;for(let e=1;e<=x;e++){var C=document.createElement("canvas");C.width=p,C.height=this.#MAX_PRIMARY_DIMENSION,0<R-this.#MAX_PRIMARY_DIMENSION&&(R-=this.#MAX_PRIMARY_DIMENSION),e==x&&(C.height=R),f.push(C)}if(0!==f.length)return l.forEach((t,e,a)=>{let i=f[v],r=i.getContext("2d");var n,s=t.getContext("2d");if(0===e){let e=o;this.devicePixelInfo.force1x&&(e=Math.floor(o/this.devicePixelInfo.force1xRatio));var c=s.getImageData(u,d-e,p,m);r.putImageData(c,0,0),w=t.height-(d-e),I=0}0!=e&&(w<i.height&&((c=i.height-w)<(e=t.height-I)?(n=s.getImageData(u,I,p,c),r.putImageData(n,0,w),I+=c,w+=c):(n=s.getImageData(u,I,p,e),r.putImageData(n,0,w),I+=e,w+=e)),f[v+1]&&I<t.height&&(v++,w=0,i=f[v],r=i.getContext("2d"),i.height,w,c=t.height-I,n=s.getImageData(u,I,p,c),r.putImageData(n,0,w),I=0,w+=c),w>=this.#MAX_PRIMARY_DIMENSION&&(eagle.logger.info("output dimension reaching this.#MAX_PRIMARY_DIMENSION",this.#MAX_PRIMARY_DIMENSION),eagle.logger.info("change to new page, and reset position"),v++),I>=t.height)&&(eagle.logger.info("source position has reaching maximum size, resetting..."),I=0)}),eagle.logger.info(`[background] return canvas count[${f.length}] totalHeight[${m}]`),f}async#resizeBase64(e,i,r="png"){return new Promise(t=>{const a=new Image;a.onload=function(){var e=document.createElement("canvas");e.width=a.width*i,e.height=a.height*i,e.getContext("2d").drawImage(a,0,0,e.width,e.height),e="png"===r?e.toDataURL():e.toDataURL("image/jpeg"),t(e)},a.src=e})}}class BackgroundScreenCapturer extends BaseScreenCapturer{constructor(){super(),this.#registerRuntimeChannel()}#registerRuntimeChannel(){eagle.runtime.onMessage("capture-current-tab",async(e,t,a)=>{a(await this.captureCurrentTab(e.options||{}))})}async captureCurrentTab({format:i="png",quality:r=100}={}){return new Promise(async(t,e)=>{var a=await eagle.tabs.getCurrentTab();if("number"!=typeof r||r<0||100<r)return e(new Error("Quality must be a number between 0-100"));eagle.tabs.captureVisibleTab(a.windowId,{format:i,quality:r}).then(e=>t(e))})}}class ScreenCapturer{screenCapturer=null;constructor(){eagle.env.isBackground()?this.screenCapturer=new BackgroundScreenCapturer:this.screenCapturer=new ForegroundScreenCapturer}get devicePixelInfo(){return this.screenCapturer.devicePixelInfo}capturePage(){return this.screenCapturer.capturePage()}captureVisible(){return this.screenCapturer.captureVisible()}captureArea(){return this.screenCapturer.captureArea()}async captureCurrentTab(e){return this.screenCapturer.captureCurrentTab(e)}}eagle.preference.ready(()=>{eagle.screenCapturer=new ScreenCapturer});