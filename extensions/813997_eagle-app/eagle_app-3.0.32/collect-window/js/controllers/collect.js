"use strict";let isMouseDownOnBody=!1;function closeWindow(){window.parent.postMessage({channel:"iframe-closed"},"*")}document.body.addEventListener("mousedown",e=>{e.target===document.body&&(isMouseDownOnBody=!0)}),document.body.addEventListener("mouseup",e=>{isMouseDownOnBody&&e.target===document.body&&closeWindow(),isMouseDownOnBody=!1}),$(document).ready(function(){document.addEventListener("wheel",function(e){var t=e.target.closest("[allow-scroll]");t&&t.scrollHeight!=t.clientHeight||e.preventDefault()},{passive:!1})});let isMouseMoving,windowMouseX=0,windowMouseY=0,mousemoveTimeout;document.addEventListener("mousemove",e=>{windowMouseX=e.pageX,windowMouseY=e.pageY,isMouseMoving||(isMouseMoving=!0,clearTimeout(mousemoveTimeout),mousemoveTimeout=setTimeout(()=>{isMouseMoving=!1},500))},!1);const EagleApp=angular.module("CollectApp",["i18n","contenteditable","stopWheel","vs-repeat","contextMenu","vsAutoScroll"]);EagleApp.config(["$sceProvider","$httpProvider",(e,t)=>{e.enabled(!1)}]),EagleApp.filter("fuzzyMatch",()=>function(e,t){return t&&function(e,t){t=t.replace(/ /g,"").toLowerCase();for(var o=[],a=0,n=0;n<e.length;n++){var l=e[n];a<t.length&&l.toLowerCase()==t[a]&&(l="<b>"+l+"</b>",a+=1),o.push(l)}return a!=t.length?"":o.join("")}(e,t)||e}),window.onload=async function(){if(eagle.env.isSafari){const t=setInterval(()=>{var e=document.querySelector("#folder-select-panel-search-input");e&&(document?.activeElement?.isContentEditable?(document.activeElement.focus(),clearInterval(t)):(e.focus(),e===document.activeElement&&clearInterval(t)))},100)}},EagleApp.controller("CollectController",["$rootScope","$scope","$timeout","i18nService",(o,l,s,e)=>{{let a={},n=[];function r(o){const a=["title","annotation","tags","folderIDs","star"];return Object.keys(o).reduce((e,t)=>(a.includes(t)&&(e[t]=o[t]),e),{})}async function t(){var[e,t,o]=await Promise.all([eagle.folder.all(),eagle.folder.recent(),eagle.tag.all()]);l.folders=e,l.foldersMap={},l.recentFolders=t,l.tags=o?.tags||[],n=o||{},a={},l.recentFolders.forEach((e,t)=>{a[e.id]=t}),l.tagsMap=l.tags.reduce((e,t)=>(e[t.name]=t,e),{}),treeUtil.walk(l.folders,"children",(e,t)=>{l.foldersMap[e.id]=e}),l.isLoadingData=!1,l.initFolderSelect(),s(()=>{var e=eagle.utils.tree.depth(l.folders,"children");window.parent.postMessage({channel:"update-previewer-position",depth:e},"*")},50)}o.getTheme=()=>"system"===o.preference.theme?o.preference.displayTheme:o.preference.theme,l.changeStar=e=>{e&&e!==l.collectItem.star?l.collectItem.star=e:delete l.collectItem.star},l.removeTag=e=>{-1!==(e=l.collectItem.tags.indexOf(e))&&l.collectItem.tags.splice(e,1)},l.openTagSelect=()=>{TagSelectPanel.open({preventCollisionWithElement:document.querySelector("div.fake-thumbnail"),tagManager:{allTags:l.tags,groups:n?.groups||[],recentTags:n?.recent?.map(e=>e.name)||[],suggestions:[]},selectedTags:l.collectItem.tags.reduce((e,t)=>(e[t]=!0,e),{}),onChanged:e=>{e=e.selectedTags,(e=Object.keys(e)).forEach(e=>{l.tagsMap[e]=l.tagsMap[e]||{name:e,color:"",groups:[]}}),l.collectItem.tags=e,l.$evalAsync()},onClosed:()=>{l.focusFolderInput()}})},l.focusFolderInput=()=>{s(()=>{var e=document.querySelector("#folder-select-panel-search-input");e&&e.focus()},100)},l.initFolderSelect=()=>{FolderSelectPanel.open({recentFolderOrders:a,folders:l.folders,selectedIds:[],onOpenItem:async e=>{if(!l.isLoadingData){let t=r(l.collectItem);e instanceof Array?(t.folderIDs=e).forEach(e=>{(e=l.foldersMap[e])&&e.extendTags instanceof Array&&(t.tags=[...new Set([...t.tags,...e.extendTags])])}):(e.id&&(t.folderIDs=[e.id]),e.extendTags instanceof Array&&(t.tags=[...new Set([...t.tags,...e.extendTags])])),window.parent.postMessage({channel:"collect-item",result:t},"*")}},onCreateItem:async e=>{var t=r(l.collectItem);window.parent.postMessage({channel:"open-create-folder-dialog",collectItem:t,item:e},"*")},onLibrarySwitching:()=>{l.isLoadingData=!0},onLibrarySwitched:()=>{t()},onLibrarySwitchClosed:()=>{l.focusFolderInput()}})},(async()=>{o.preference=eagle.preference,await o.preference.init(),o.i18nService=e,o.i18nService.initLocale(o.i18nService.getCurrentLocaleKey()),o.$evalAsync(),l.browserName=eagle.env.browser.name,l.theme=o.getTheme(),l.isOpen=!1,l.collectItem=new CollectItem,await t(),window.addEventListener("message",e=>{var t;!1!==e.isTrusted&&e.source===window.parent&&("update-theme"==(t=e.data.channel)&&(l.theme=o.getTheme(),l.$evalAsync()),"cancel-create-folder-dialog"==t&&l.focusFolderInput(),"preview-meta"==t)&&(l.previewerSize=e.data.previewerSize,l.collectItem.type=e.data.type||"image",l.collectItem.src=e.data.src,l.collectItem.title=e.data.title,l.collectItem.annotation=e.data.annotation,l.collectItem.tags=e.data.tags||[],l.collectItem.tags.map((e,t)=>{l.tagsMap[e]=l.tagsMap[e]||{name:e,color:"",groups:[]}}),l.$evalAsync())},!1),window.parent.postMessage({channel:"iframe-ready"},"*"),l.isOpen=!0})()}}]);