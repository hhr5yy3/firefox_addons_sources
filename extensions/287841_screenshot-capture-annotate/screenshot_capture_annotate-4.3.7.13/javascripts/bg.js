var win,menuType,type,tabid,taburl,tabtitle,zoomLevel,counter,ratio,scrollBar,data,tempDataUrl,currentWindowId,currentTabId,currentTabIndex,request,dataURL=[],newClickVersion="4.3.7",centerW=0,centerH=0,cameraStream=null,tabIdBeforeRecordStart="",tabTitleBeforeRecordStart="",recorderPageTabId="",recorderPageWindowId="",tabCameraClosedManually=!1,isEmbedCamera=!1,currentversion=chrome.runtime.getManifest().version,tabids={},recordType="",cVideo=null;let isWin=navigator.platform&&navigator.platform.includes("Win");var recordingStatus="",isRecordingPaused=!1,isRecordingPausedError=!1,recordingTime=0,recordingTimer=null,lastPausingTime=null,pausedTime=null,currentRecordType="",isPremium=!1,recordingStartTime=null,countDownInterval=null,devicePixelRatio=1;window.devicePixelRatio;var actualPageWidth=0,centerOffX=0,centerOffY=0,isCopyAction=!1,desktopCaptureInterval=null,actionFrom="",bgRegions=[],bottomClip=null,contentClip=null,topCapturePosition=null,isScrollCapturing=(devicePixelRatio=1,!1);function sendMessageToTab(e,t,a){try{return browser.tabs.sendMessage(e,t,{frameId:0}).then((e=>{a&&a(e)})).catch((e=>{t.action}))}catch(e){}}function sendMessage(e,t){return browser.runtime.sendMessage(e).then(t).catch((e=>{}))}function getCurrentTab(e){chrome.tabs.query({active:!0,currentWindow:!0},(function(t){e(t[0])}))}function insertFile(e,t,a){return new Promise((function(r,o){"css"===e?chrome.tabs.insertCSS(t,{file:a},(function(e){r(e)})):"script"===e&&chrome.tabs.executeScript(t,{file:a},(function(e){r(e)}))}))}function captureVisibleImage(e,t){t&&e&&("selected"==e&&(type="visible",centerW=t.centerW,centerH=t.centerH),actualPageWidth=t.innerWidth),dataURL=[],captureVisible(),getCurrentTab((function(e){sendMessageToTab(e.id,{action:"restorebar"})}))}function saveStorage(e,t){return new Promise(((a,r)=>{let o=null;if("object"==typeof e)o=e;else{if("string"!=typeof e)throw"TypeError: First argument should be a string or an object.";o={[e]:t}}chrome.storage.local.set(o,(()=>chrome.runtime.lastError?r(chrome.runtime.lastError):a()))}))}function setBadge(e,t){"text"===e?chrome.browserAction.setBadgeText({text:t}):"color"===e&&chrome.browserAction.setBadgeBackgroundColor({color:t})}function isNotAcceptedTab(e){return e.match(/chrome(.*):\/\//)||e.match(/edge(.*):\/\//)||e.match(/moz-extension:\/\//)||e.match(/https:\/\/chrome.google.com\/webstore/i)||e.match(/https:\/\/ntp.msn.cn\/edge\/ntp/i)||e.match(/about:blank/)&&!1}function enablePriceCompare(){localStorage.pcnotification="true",localStorage.popupnotification="true",localStorage.barnotification="true",localStorage.show_feature_bar="false",refreshOptions()}function disablePriceCompare(){localStorage.pcnotification="false",localStorage.popupnotification="false",localStorage.barnotification="false","never"!==localStorage.show_feature_bar&&(localStorage.show_feature_bar="true"),refreshOptions()}function captureVisible(){type="visible",updateScrollCapturing(!1),getSelectedTab((()=>{chrome.windows.update(currentWindowId,{focused:!0},(function(){chrome.tabs.update(currentTabId,{active:!0},(function(){chrome.tabs.captureVisibleTab(null,{format:"png"},(function(e){e&&((dataURL=[]).push(e),isCopyAction?copySelectAction():newTab())}))}))}))}))}function copySelectAction(){isCopyAction=!1,sendMessageToTab(tabid,{action:"destroy_selected"}),dataURLGenerator(menuType,type,centerOffX,centerOffY,centerW,centerH,counter,ratio,scrollBar,dataURL,(function(e){sendMessageToTab(tabid,{action:"copytoclipboard",obj:e})}))}function dataURLGenerator(e,t,a,r,o,n,i,c,l,s,d){var u,g,p,b,h,m,f,S,v=document.createElement("IMG"),y=document.createElement("canvas"),w=y.getContext("2d"),T=getScrollbarWidth(),x=0,C=0;function k(){y.width=p,y.height=b}v.onload=function(){switch(u=this.width,g=this.height,t){case"visible":"selected"===e?(p=o,b=n,I=a,B=r):"desktop"===e||"upload"===e?(p=u,b=g,I=0,B=0):(p=u-T,b=g,I=0,B=0),k(),w.drawImage(this,I,B,p,b,0,0,p,b),d(y.toDataURL());break;case"entire":var R=C=x=0,_=s.length,W=i,j=Math.round(_/W);function P(e,t,a,r,o,n,i,c,l){e?(i=R*g,R==j-1&&h>0&&(a=g-h,o=l=h),v.onload=function(){w.drawImage(this,t,a,r,o,n,i,c,l),++R>j-1&&L(),P(s[++x],t,a,r,o,n,i,c,l)},v.src=e):d(y.toDataURL())}function L(){++C>W-1||(C==W-1?(I=u-m,U=f=p-C*u,M=C*u):(I=0,U=f=u,M=C*u),B=0,E=S=g,A=0,P(s[x=(R=0)+C*j],I,B,U,E,M,A,f,S))}if(!l.x&&l.y){j=_,h=Math.round(g*c.y),p="selected"==e?o:u,b=h>0?g*(j-1)+h:g*j,k();var I=0,U=f=u,M=0,B=0,E=S=g,A=0;"selected"==e&&a&&(I=a),P(s[x],I,B,U,E,M,A,f,S)}if(l.x&&!l.y){W=_,m=Math.round(u*c.x),b="selected"==e?request.centerH:g,p=m>0?u*(W-1)+m:u*W,k();I=0,U=f=u,M=0,B=0,E=S=g,A=0;!function e(t,a,r,o,n,i,c,l,d,g){i=C*u,C==W-1&&(a=u-m,o=l=m),v.onload=function(){w.drawImage(this,a,r,o,n,i,c,l,d),C<W-1&&e(s[++C],a,r,o,n,i,c,l,d)},v.src=t}(s[x],I,B,U,E,M,A,f,S)}if(l.x&&l.y){m=Math.round(u*c.x),h=Math.round(g*c.y),"selected"==e?(p=request.centerW,b=request.centerH):(p=m>0?u*(W-1)+m:u*W,b=h>0?g*(j-1)+h:g*j),k();I=0,U=f=u,M=0,B=0,E=S=g,A=0;P(s[x],I,B,U,E,M,A,f,S)}}},v.src=s[0]}function getScrollbarWidth(){var e=document.createElement("p");e.style.width="100%",e.style.height="200px";var t=document.createElement("div");t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.visibility="hidden",t.style.width="200px",t.style.height="150px",t.style.overflow="hidden",t.appendChild(e),document.body.appendChild(t);var a=e.offsetWidth;t.style.overflow="scroll";var r=e.offsetWidth;return a==r&&(r=t.clientWidth),document.body.removeChild(t),a-r}function captureSelected(){type="selected",getSelectedTab(checkContentScript)}function captureEntire(){type="entire",getSelectedTab(checkContentScript)}function getSelectedTab(e){getCurrentTab((function(t){tabid=t.id,taburl=t.url,tabtitle=t.title,chrome.tabs.getZoom(t.id,(function(t){zoomLevel=t,null!=e&&e()}))}))}function insertContentScript(e){return new Promise((function(t,a){chrome.tabs.executeScript(e,{file:"javascripts/checkContentScript.js"},(function(r){r?r[0]?insertFile("script",e,"javascripts/libs/jquery-3.4.0.min.js").then(insertFile("script",e,"javascripts/libs/dragresize.js")).then(insertFile("script",e,"javascripts/jquery.draggable.js")).then(insertFile("script",e,"javascripts/libs/jquery-ui-custom.min.js")).then(insertFile("css",e,"stylesheets/selected.css")).then(insertFile("script",e,"javascripts/in-place-play.js")).then(insertFile("script",e,"javascripts/content_script.js")).then((function(){t()})):t():a()}))}))}function checkContentScript(){chrome.tabs.executeScript(tabid,{file:"javascripts/isload.js"})}function saveAndScroll(){pushDataURL()}function pushUploadDataURL(e){(dataURL=[]).push(e);var t=chrome.runtime.getURL("")+"edit-react.html";chrome.tabs.update({url:t})}function pushDataURL(){chrome.tabs.update(currentTabId,{active:!0},(function(){chrome.tabs.captureVisibleTab(currentWindowId,{format:"png"},(function(e){dataURL.push(e),sendMessageToTab(tabid,{action:"scroll_next"})}))}))}function updateShortcutsRequest(e){sendMessageToTab(e,{action:"update_shortcuts",msObj:localStorage.msObj})}async function saveDataUrlToStorage(){await saveStorage("dataURL",dataURL)}async function openEditTab(e){if(e&&"gmail"==e.type)var t="edit-react.html?"+e.type+"="+e.tabId;else t="edit-react.html";chrome.tabs.query({active:!0,currentWindow:!0},(async a=>{if(a&&a.length){if(e&&e.tabId)var r=a[0].index;else r=a[0].index+1;if(a[0].incognito)try{await saveDataUrlToStorage()}catch(e){}var o={url:t,index:r}}else o={url:t};chrome.tabs.create(o,(function(e){tabids[e.id]=tabid,tabid=e.id}))}))}function updateScrollCapturing(e){isScrollCapturing=e}function newTab(e){updateScrollCapturing(!1),sendMessage({action:"closeWin"}),dataURL?("selected"==menuType&&sendMessageToTab(tabid,{action:"destroy_selected"}),"true"==localStorage.autoSave?prepareImage():openEditTab(e)):alert("Screen Capture Fail!!")}function regeneralImage(e,t){var a=document.getElementById("tempCanvas"),r=a.getContext("2d"),o=new Image,n=e=>{editW=o.width*e,editH=o.height*e,0,0,$("#tempCanvas").attr({width:editW,height:editH}),r.drawImage(o,0,0,o.width,o.height,0,0,editW,editH);const n=new Image;"jpg"==localStorage.format?n.src=a.toDataURL("image/jpeg"):"png"==localStorage.format&&(n.src=a.toDataURL()),t&&t(n)};o.onload=function(){o.width,o.height;actualPageWidth>0?(o.width/actualPageWidth,n(devicePixelRatio)):getCurrentTab((function(e){sendMessageToTab(e.id,{action:"fetchPageWidth"},(e=>{actualPageWidth=e,o.width/actualPageWidth,n(devicePixelRatio)}))}))},o.src=e}function prepareImage(){var e,t,a=document.getElementById("tempCanvas"),r=a.getContext("2d"),o=document.getElementById("test_image"),i=(document.getElementById("temp_image"),17),c=function(){if(e=o.width,t=o.height,"visible"==type){var l,s;"selected"==menuType?(l=centerW*devicePixelRatio,s=centerH*devicePixelRatio,S=centerOffX,w=centerOffY):(l=o.width,s=o.height,S=0,w=0),$("#tempCanvas").attr({width:l*devicePixelRatio,height:s*devicePixelRatio}),r.drawImage(o,S*devicePixelRatio,w*devicePixelRatio,l,s,0,0,l*devicePixelRatio,s*devicePixelRatio);const C=new Image;"jpg"==localStorage.format?C.src=a.toDataURL("image/jpeg"):"png"==localStorage.format&&(C.src=a.toDataURL()),(dataURL=[]).push(C),openEditTab()}else if("entire"==type||"selected"==type){var d=dataURL,u=j=n=0,g=d.length,p=counter,b=Math.round(g/p);function h(e,a,o,i,c,l,s,g,p){s=u*t,u==b-1&&lastH>0&&(o=t-lastH,c=p=lastH),$("#temp_image").attr({src:e}).load((function(){$(this).unbind("load"),r.drawImage(this,a,o,i,c,l,s,g,p),++u>b-1?f():h(d[++n],a,o,i,c,l,s,g,p)}))}function m(){$(a).attr({width:l,height:s})}function f(){if(++j>p-1){var r=document.getElementById("pluginobj");return"jpg"==localStorage.format?tempDataUrl=a.toDataURL("image/jpeg"):"png"==localStorage.format&&(tempDataUrl=a.toDataURL()),r.AutoSave(tempDataUrl,tabtitle.replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," "),localStorage.savePath),void setTimeout((function(){getCurrentTab((function(e){sendMessageToTab(e.id,{action:"finishAutoSave",path:localStorage.savePath})})),sendMessage({action:"closeWin"})}),1e3)}j==p-1?(S=e-lastW,v=dw=l-j*e,y=j*e):(S=0,v=dw=e,y=j*e),w=0,T=dh=t,x=0,u=0,n=u+j*b,h(d[n],S,w,v,T,y,x,dw,dh)}if(!scrollBar.x&&scrollBar.y){e-=i,b=g,lastH=Math.round(t*ratio.y),"selected"==menuType?(scrollBar.realX&&(t-=i),l=centerW*devicePixelRatio):l=e,s=lastH>0?t*(b-1)+lastH:t*b,m();var S=0,v=dw=e,y=0,w=0,T=dh=t,x=0;h(d[n],S,w,v,T,y,x,dw,dh)}if(scrollBar.x&&!scrollBar.y){t-=i,p=g,lastW=Math.round(e*ratio.x),"selected"==menuType?(scrollBar.realY&&(e-=i),s=centerH*devicePixelRatio):s=t,l=lastW>0?e*(p-1)+lastW:e*p,m();S=0,v=dw=e,y=0,w=0,T=dh=t,x=0;!function t(a,o,n,i,c,l,s,u,g,b){l=j*e,j==p-1&&(o=e-lastW,i=u=lastW),$("#temp_image").attr({src:a}).load((function(){$(this).unbind("load"),r.drawImage(this,o,n,i,c,l,s,u,g),j<p-1&&t(d[++j],o,n,i,c,l,s,u,g)}))}(d[n],S,w,v,T,y,x,dw,dh)}if(scrollBar.x&&scrollBar.y){lastW=Math.round(e*ratio.x),lastH=Math.round(t*ratio.y),e-=i,t-=i,"selected"==menuType?(l=Math.round(centerW*devicePixelRatio),s=Math.round(centerH*devicePixelRatio)):(l=lastW>0?e*(p-1)+lastW:e*p,s=lastH>0?t*(b-1)+lastH:t*b),m();S=0,v=dw=e,y=0,w=0,T=dh=t,x=0;h(d[n],S,w,v,T,y,x,dw,dh)}}o.removeEventListener("onload",c,!1),o.src=""};o.onload=c,o.src=dataURL[0]}localStorage.msObj||(localStorage.msObj=isWin?'{"visible":{"enable":true,"key":"V"},"selected":{"enable":true,"key":"C"},"entire":{"enable":true,"key":"E"}}':'{"visible":{"enable":true,"key":"V"},"selected":{"enable":true,"key":"S"},"entire":{"enable":true,"key":"E"}}'),localStorage.format||(localStorage.format="png"),localStorage.delay_sec||(localStorage.delay_sec=3),localStorage.desktop_delay_sec||(localStorage.desktop_delay_sec=0),localStorage["remove-print-watermark"]||(localStorage["remove-print-watermark"]=!1),localStorage["data-tracking"]||(localStorage["data-tracking"]=!0),localStorage["add-url"]||(localStorage["add-url"]=!1),localStorage["expand-link"]||(localStorage["expand-link"]=!0),localStorage["expand-link-slack"]||(localStorage["expand-link-slack"]=!0),localStorage["expand-link-trello"]||(localStorage["expand-link-trello"]=!0),localStorage["expand-link-asana"]||(localStorage["expand-link-asana"]=!0),localStorage["expand-link-github"]||(localStorage["expand-link-github"]=!0),localStorage["expand-link-jira"]||(localStorage["expand-link-jira"]=!0),localStorage["expand-link-gmail"]||(localStorage["expand-link-gmail"]=!1),localStorage.aws_s&&32!==localStorage.aws_s.length&&(localStorage.aws_s="",localStorage.aws_uid="",localStorage.aws_username=""),localStorage["show-noti"]||(localStorage["show-noti"]=!0),localStorage.popupTab||localStorage.version||(localStorage.popupTab="record"),localStorage["save-as"]||(localStorage["save-as"]=!0),localStorage.record_mic||(localStorage.record_mic=!0),localStorage.record_countdown||(localStorage.record_countdown=3),localStorage.max_resolution||(window.screen.width*devicePixelRatio>3e3?localStorage.max_resolution="1080":localStorage.max_resolution="720"),localStorage["save-location"]||(localStorage["save-location"]="cloud"),localStorage.record_tabsound||(localStorage.record_tabsound=!0),localStorage.reocrd_type||(localStorage.record_type="desktop"),localStorage["gmail-btn"]||(localStorage["gmail-btn"]="true"),$(document).ready((function(){})),localStorage.autoSave="false",chrome.runtime.onMessage.addListener((function(e,t,a){switch(getCurrentTab((function(e){e&&(/moz-extension:\/\/nlipoenfbbikpbjkfpfillcgkoblgpmj/.test(e.url)||(currentWindowId=e.windowId,currentTabId=e.id,currentTabIndex=e.index))})),t.tab&&-1!=t.tab.id&&"visible"!=e.action&&"selected"!=e.action&&"entire"!=e.action&&"delay"!==e.action||(menuType=e.action,e.menuType&&(menuType=e.menuType)),e.action){case"getImageInfo":a({menuType,type,centerOffX,centerOffY,centerW,centerH,counter,ratio,scrollBar,tabtitle,taburl,contentCanScroll:!1,scrollBarWidth:0,contentClip,bottomClip,bgRegions,topCapturePosition,zoomLevel});break;case"visible":captureVisibleImage(menuType,e);break;case"selected":dataURL=[],actualPageWidth=e.innerWidth,captureSelected();break;case"entire":dataURL=[],actualPageWidth=e.innerWidth,captureEntire();break;case"delay":type="delay",actualPageWidth=e.innerWidth,getSelectedTab(checkContentScript);break;case"https":alert("For security reason, Capture Selected Area doesn't work in https pages! Please try other options.");case"insert_script":insertFile("script",tabid,"javascripts/libs/jquery-3.4.0.min.js").then(insertFile("script",tabid,"javascripts/libs/dragresize.js")).then(insertFile("script",tabid,"javascripts/jquery.draggable.js")).then(insertFile("css",tabid,"stylesheets/selected.css")).then(insertFile("script",tabid,"javascripts/in-place-play.js")).then(insertFile("script",tabid,"javascripts/content_script.js")).then((function(){sendMessageToTab(tabid,"delay"===type?{action:"delay",sec:localStorage.delay_sec}:{action:"init_"+menuType+"_capture"})}));break;case"script_running":sendMessageToTab(tabid,"delay"===type?{action:"delay",sec:localStorage.delay_sec}:{action:"init_"+type+"_capture"});break;case"check_shortcuts":let i=t.tab.id;setTimeout((()=>{updateShortcutsRequest(i)}),100);break;case"update_shortcuts":chrome.tabs.query({currentWindow:!0},(function(e){for(var t=0,a=e.length;t<a;t++){var r=e[t],o=r.url;o.match(/https?:\/\/*\/*/gi)&&!o.match(/https:\/\/chrome.google.com\/extensions/i)&&updateShortcutsRequest(r.id)}}));break;case"scroll_next_done":actualPageWidth=e.innerWidth,null!=e.isCopyAction&&(isCopyAction=e.isCopyAction),e.isFirstScroll&&(updateScrollCapturing(!0),userStop=!1,bgRegions=e.bgRegions,contentClip=e.contentClip,bottomClip=e.bottomClip,topCapturePosition=e.topCapturePosition,devicePixelRatio=e.devicePixelRatio,dataURL=[]),saveAndScroll();break;case"entire_capture_done":counter=e.counter,ratio=e.ratio,scrollBar=e.scrollBar,type="entire","selected"==menuType&&(centerW=e.centerW,centerH=e.centerH,e.data&&(centerOffX=e.data.x,centerOffY=e.data.y)),actualPageWidth=e.innerWidth,sendMessageToTab(tabid,{action:"restorebar"}),updateScrollCapturing(!1),isCopyAction?copySelectAction():newTab();break;case"capture_selected_done":type="visible",actualPageWidth=e.data.innerWidth,centerH=e.data.h,centerW=e.data.w,centerOffX=e.data.x,centerOffY=e.data.y,null!=e.isCopyAction&&(isCopyAction=e.isCopyAction),captureVisible();break;case"copy":chrome.experimental.clipboard.executeCopy(tabid,(function(){alert("copied")}));break;case"upload":e.data&&((dataURL=[]).push(e.data),type="visible",menuType="upload",tabtitle=e.name,saveDataUrlToStorage().then((()=>{a("gaga")})));break;case"clearDataURL":dataURL=[],saveDataUrlToStorage();break;case"exit":getCurrentTab((function(e){chrome.tabs.remove(e.id)}));break;case"get_option":a({options:localStorage.msObj});break;case"openNewTab":var r=e.url;chrome.tabs.create({url:r});break;case"openOauthTab":r=e.url;chrome.tabs.create({url:r}),chrome.tabs.remove(t.tab.id);break;case"enablePriceCompare":enablePriceCompare(),localStorage.show_feature_bar="false";break;case"getShowFeatureBar":a(localStorage.show_feature_bar);break;case"disableShowFeatureBar":localStorage.show_feature_bar="never";break;case"gmail-btn":a("true"==localStorage["gmail-btn"]);break;case"getLocalStorage":var o=e.what,n={};o.forEach((function(e){n[e]="true"===localStorage[e]})),a(n);break;case"isCapturing":a(isScrollCapturing)}})),chrome.commands.onCommand.addListener((function(e){"Capture-Visible"===e?captureVisibleImage():"Capture-Selected-Area"===e?(dataURL=[],captureSelected()):"Capture-Entire"===e&&(dataURL=[],captureEntire())})),chrome.tabs.onUpdated.addListener((function(e,t,a){"moz-extension://alelhddbbhepgpmgidjdcjakblofbmce/#"==t.url?sendMessage({name:"loginByGoogle"}):"https://www.awesomescreenshot.com/redirect.html#"!=t.url&&"https://www.awesomescreenshot.com/redirect.html"!=t.url||(chrome.tabs.remove(a.id),a.openerTabId&&chrome.tabs.update(a.openerTabId,{active:!0}),chrome.runtime.sendMessage({name:"awsLoginByGoogle"})),e===tabIdBeforeRecordStart&&isEmbedCamera&&sendMessageToTab(tabIdBeforeRecordStart,{action:"setup-camera"}),"complete"==a.status&&sendMessageToTab(e,{action:"tabupdate"})})),chrome.tabs.onRemoved.addListener((function(e){tabids[e]&&chrome.tabs.update(tabids[e],{active:!0})})),chrome.runtime.onInstalled.addListener((function(e){"install"==e.reason&&("true"===localStorage["expand-link-gmail"]&&(localStorage["expand-link-gmail"]=!1),chrome.tabs.create({url:"/privacy.html"}))})),localStorage.version||(localStorage.newClickVersion=newClickVersion),localStorage.version&&localStorage.newClickVersion!=newClickVersion&&chrome.browserAction.setBadgeText({text:"New"}),"recording"!==recordingStatus&&chrome.browserAction.getBadgeText({},(function(e){"New"!==e&&chrome.browserAction.setBadgeText({text:""})}));var baseUrl="https://www.awesomescreenshot.com";function refreshCookie(){$.get(baseUrl+"/promotion_ex")}chrome.cookies.get({url:baseUrl,name:"screenshot_personal_uid"},(function(e){e&&localStorage.version!=currentversion&&refreshCookie(),localStorage.version=currentversion}));var createLogger=function(e){if("red"===e);else;};function loggerEvent(e,t){}var log_red=createLogger("red"),log=createLogger();function getClientStr(){return/Edg/.test(navigator.userAgent)?"Edge extension":/Firefox/.test(navigator.userAgent)?"Firefox extension":"Chrome extension"}