import{s as E}from"./content-script-D7YBjZpd.js";import{s as b,P as S}from"./shared-functions-50IQFOKT.js";import{u as w,d as D,t as v}from"./storeTypes-CGrbvTi_.js";import"./chunk-QIZ4XBKF-C_NfkaUr.js";import"./_commonjsHelpers-CqkleIqs.js";b(S.Crunchyroll);const{data:l,promise:k}=w("settings",D),q=window.location.href,f=new Date,x={attributes:!0,childList:!0,subtree:!0};async function A(){console.log("%cStreaming enhanced","color: #00aeef;font-size: 2em;"),console.log("Settings",l.value)}async function L(){if(await k,A(),l.value.Crunchyroll.releaseCalendar&&T(),l.value.Crunchyroll.profile){const t=setInterval(function(){I()},100);setTimeout(function(){var n;(n=l.value.Crunchyroll)!=null&&n.bigPlayer&&z()},1e3),setTimeout(function(){clearInterval(t)},2e3),H.observe(document,x)}}function m(t){document.querySelectorAll("div.queue-flag:not(.queued)").forEach(n=>{var e,r,i;(r=(e=n==null?void 0:n.parentElement)==null?void 0:e.parentElement)!=null&&r.parentElement&&(n.parentElement.parentElement.parentElement.style.display=(i=n.parentElement.parentElement.querySelector(".premiere-flag"))!=null&&i.checkVisibility()?"block":t)}),t=="block"&&l.value.General.filterDub&&y("none")}function y(t){document.querySelectorAll("cite[itemprop='name']").forEach(e=>{var r,i,o,a,c,s;((r=e==null?void 0:e.textContent)!=null&&r.includes("Dub")||(i=e==null?void 0:e.textContent)!=null&&i.includes("Audio"))&&((s=(c=(a=(o=e==null?void 0:e.parentElement)==null?void 0:o.parentElement)==null?void 0:a.parentElement)==null?void 0:c.parentElement)!=null&&s.parentElement)&&(e.parentElement.parentElement.parentElement.parentElement.parentElement.style.display=t)}),t=="block"&&l.value.General.filterQueued&&m("none")}function g(t,n,e,r){const i=document.createElement("label"),o=document.createElement("span");o.style.display="flex",o.style.alignItems="center";const a=document.createElement("input");a.type="checkbox",a.checked=e,a.id=t,a.onclick=function(){l.value.General[t]=a.checked,console.log("input.checked",a.checked),r(a.checked?"none":"block")};const c=document.createElement("p");return c.style.width="100px",c.textContent=n,i.appendChild(o),o.appendChild(a),o.appendChild(c),i}function G(){const t=document.querySelector("#filter_toggle_form");t!=null&&t.firstElementChild&&(t.style.display="flex",t.firstElementChild.appendChild(g("filterQueued","Show Playlist only",l.value.General.filterQueued,m)),t.firstElementChild.appendChild(g("filterDub","Filter Dub",l.value.General.filterDub,y)))}function P(t,n){n.forEach(e=>{const r=document.createElement("article");r.className="release js-release";const i=document.createElement("time");i.className="available-time",i.textContent=new Date(e.time).toLocaleString([],{hour:"2-digit",minute:"2-digit"});const o=document.createElement("div"),a=document.createElement("div");a.className="queue-flag queued enhanced";const c=document.createElementNS("http://www.w3.org/2000/svg","svg");c.setAttribute("viewBox","0 0 48 48");const s=document.createElementNS("http://www.w3.org/2000/svg","use");s.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","/i/svg/simulcastcalendar/calendar_icons.svg#cr_bookmark"),c.appendChild(s),a.appendChild(c);const d=document.createElement("h1");d.className="season-name";const u=document.createElement("a");u.className="js-season-name-link",u.href=(e==null?void 0:e.href)||"",u.setAttribute("itemprop","url");const p=document.createElement("cite");p.setAttribute("itemprop","name"),p.textContent=(e==null?void 0:e.name)||"",u.appendChild(p),d.appendChild(u),o.appendChild(a),o.appendChild(d),r.appendChild(i),r.appendChild(o),t.appendChild(r)})}function _(){const t=document.querySelectorAll(".specific-date [datetime]");for(const n of t){const e=new Date(n.getAttribute("datetime"));if(f.getDay()==e.getDay())return setTimeout(()=>{n.click()},1e3),f.toLocaleDateString()==e.toLocaleDateString()}return!1}function N(){const t=[];return document.querySelectorAll("div.queue-flag.queued:not(.enhanced)").forEach(n=>{var i,o,a,c,s,d,u;const e=(o=(i=n.nextElementSibling)==null?void 0:i.firstChild)==null?void 0:o.nextSibling,r=(c=(a=e==null?void 0:e.firstChild)==null?void 0:a.nextSibling)==null?void 0:c.textContent;if(!(r!=null&&r.includes("Dub"))){const p=e==null?void 0:e.href,C=((u=(d=(s=n.parentElement)==null?void 0:s.parentElement)==null?void 0:d.firstElementChild)==null?void 0:u.getAttribute("datetime"))??"";t.push({href:p,name:r,time:C})}}),t}function O(t,n){let e=v(l.value.General.savedCrunchyList);const r=n[n.length-1];if(!(r!=null&&r.time))return e;const i=new Date(r.time),[o,a,c]=[i.getDay(),i.getHours(),i.getMinutes()];return t?e=e.filter(s=>s&&h(f.getDay())-h(new Date(s.time).getDay())<=0).filter(s=>{const d=new Date(s.time),u=d.getHours(),p=d.getDay();return o!=p||p!=f.getDay()||u>a||u==a&&d.getMinutes()>c}):e=[],e}const h=t=>(t+6)%7;function Q(){const t=N(),n=_(),e=t.length>0?O(n,t):v(l.value.General.savedCrunchyList);l.value.General.savedCrunchyList=t.concat(e),n&&!document.querySelector("div.queue-flag.queued.enhanced")&&document.querySelectorAll("section.calendar-day").forEach(r=>{var a,c,s,d,u;const i=((a=r.querySelector("time"))==null?void 0:a.getAttribute("datetime"))??"",o=new Date(i).getDay();h(f.getDay())-h(o)<0&&((u=(d=(s=(c=r==null?void 0:r.children)==null?void 0:c[1])==null?void 0:s.firstChild)==null?void 0:d.nextSibling)==null||u.remove()),P(r.children[1],e.filter(p=>new Date(p.time).getDay()==o))})}async function T(){q.includes("simulcastcalendar")&&(m(l.value.General.filterQueued?"none":"block"),y(l.value.General.filterDub?"none":"block"),document.querySelector("#filterQueued")||G(),Q())}const H=new MutationObserver(M);async function M(){var t;(t=l.value.Crunchyroll)!=null&&t.profile&&B()}async function B(){const t=document.querySelector(".avatar-wrapper img");t&&t.src!==l.value.General.Crunchyroll_profilePicture&&(l.value.General.Crunchyroll_profilePicture=t.src,console.log("Profile switched to",t.src))}async function I(){var t;document.querySelector(".profile-item-name")&&((t=document.querySelectorAll(".erc-profile-item img"))==null||t.forEach(n=>{const e=n;e.src===l.value.General.Crunchyroll_profilePicture&&(e.click(),console.log("Profile automatically chosen:",e.src),l.value.Statistics.SegmentsSkipped++,E("increaseBadge",{},"background"))}))}async function z(){var t,n;if(document.querySelector(".video-player-wrapper")){const e=document.createElement("style"),i=`
      .video-player-wrapper{
          max-Height: calc(100vw / 1.7777);
          height: 100vh;
      }
			.${(n=(t=document.querySelector('[class^="app-layout__header"]'))==null?void 0:t.classList)==null?void 0:n[0]} {
					position: absolute;
          top: 0;
          width: 100%;
          height: 3.75rem;
          z-index: 999;
			}
      .erc-large-header {
          position: absolute;
          top: 0;
          width: 100%;
          height: 3.75rem;
          z-index: 999;
      }
      .erc-large-header .header-content {
          position: absolute;
          top: -3.75rem;
          transition: top 0.4s, top 0.4s;
      }
      .erc-large-header:hover .header-content {
          top: 0;
      }
    `;e.appendChild(document.createTextNode(i)),document.head.appendChild(e)}}L();
