import{c as w,P as d,e as D,a as y}from"./cplx-DC-QQLj-.js";import{b}from"./cplx-CVsLL7Ku.js";import{c as h,a as I}from"./cplx-B814hFp-.js";import{u as L}from"./cplx-wwbq-DDb.js";var P=(s="")=>{const v=w();let r,a=[];const o=y(),p=new Set,l=new Set,f=(e,m)=>{switch(e.status){case"undeliverable":a.some(n=>n.message.messageID===e.message.messageID)||(a=[...a,{message:e.message,resolvedDestination:e.resolvedDestination}]);return;case"deliverable":a=a.reduce((n,t)=>t.resolvedDestination===e.deliverableTo?(d.toBackground(m,{type:"deliver",message:t.message}),n):[...n,t],[]);return;case"delivered":e.receipt.message.messageType==="message"&&o.add(e.receipt);return;case"incoming":e.message.messageType==="reply"&&o.remove(e.message.messageID),p.forEach(n=>n(e.message,m));return;case"terminated":{const n=o.entries().filter(t=>e.fingerprint===t.to);o.remove(n),n.forEach(({message:t})=>l.forEach(M=>M(t)))}}},u=()=>{r=b.runtime.connect({name:D({endpointName:s,fingerprint:v})}),r.onMessage.addListener(f),r.onDisconnect.addListener(u),d.toBackground(r,{type:"sync",pendingResponses:o.entries(),pendingDeliveries:[...new Set(a.map(({resolvedDestination:e})=>e))]})};return u(),{onFailure(e){l.add(e)},onMessage(e){p.add(e)},postMessage(e){d.toBackground(r,{type:"deliver",message:e})}}},i=L("content-script"),g=P(),c=h("content-script",s=>{s.destination.context==="window"?i.postMessage(s):g.postMessage(s)});i.onMessage(s=>{c.handleMessage(Object.assign({},s,{origin:{context:"window",tabId:null}}))});g.onMessage(c.handleMessage);g.onFailure(s=>{if(s.origin.context==="window"){i.postMessage({type:"error",transactionID:s.transactionId});return}c.endTransaction(s.transactionId)});function S(s){i.setNamespace(s),i.enable()}var{sendMessage:T,onMessage:k}=c;I(c);export{S as a,k as o,T as s};
