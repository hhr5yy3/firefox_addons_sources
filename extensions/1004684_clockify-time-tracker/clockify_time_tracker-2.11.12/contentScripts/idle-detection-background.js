const minuteInMilliseconds=6e4,idleChangeStateListener=async e=>{const t=await this.getIdleDetectionByUser(),n=await localStorage.getItem("timeEntryInProgress");if(n){const a=await localStorage.getItem("idleDetectedIn");if(t&&"idle"===e)localStorage.setItem("idleDetectedIn",Date.now()-6e4*parseInt(t.counter)),this.setTimeEntryToDetectedIdleTime(n.id);else if(a&&parseInt(a)>0&&"active"===e&&t.timeEntryId===n.id){const e=await localStorage.getItem("idleDetectedIn");this.createIdleNotification(n,e)}}};async function addIdleListenerIfIdleIsEnabled(){const e=await this.getIdleDetectionByUser();e&&e.counter>0&&(aBrowser.idle.setDetectionInterval(60*parseInt(e.counter)),aBrowser.idle.onStateChanged.addListener(idleChangeStateListener))}async function removeIdleListenerIfIdleIsEnabled(){const e=await this.getIdleDetectionByUser();e&&e.counter>0&&idleChangeStateListener&&aBrowser.idle.onStateChanged.removeListener(idleChangeStateListener),this.clearNotification("idleDetection")}async function setIdleDetectionOnBrowserStart(){const e=await this.getIdleDetectionByUser();e&&e.counter>0?(aBrowser.idle.setDetectionInterval(60*parseInt(e.counter)),aBrowser.storage.local.get(["timeEntryInProgress"],(e=>{e.timeEntryInProgress?aBrowser.idle.onStateChanged.addListener(idleChangeStateListener):idleChangeStateListener&&aBrowser.idle.onStateChanged.hasListener(idleChangeStateListener)&&aBrowser.idle.onStateChanged.removeListener(idleChangeStateListener)}))):idleChangeStateListener&&aBrowser.idle.onStateChanged.hasListener(idleChangeStateListener)&&aBrowser.idle.onStateChanged.removeListener(idleChangeStateListener)}async function getIdleDetectionByUser(){const e=await localStorage.getItem("permanent_idleDetection"),t=await localStorage.getItem("userId");return e?JSON.parse(e).filter((e=>e.userId===t))[0]:null}function createIdleNotification(e,t){const{projectId:n,project:a,task:i,description:r}=e;let s=clockifyLocales.NO_DESCRIPTION;r?(s=r,n&&(s+=" - "+a.name,i&&(s+=":"+i.name))):n&&(s=a.name,i&&(s+=":"+i.name));const o=this.getIdleDuration(t),l=[{title:clockifyLocales.DISCARD_IDLE_TIME},{title:clockifyLocales.DISCARD_AND_CONTINUE}],d={type:"basic",iconUrl:"./assets/icons/64x64.png",title:clockifyLocales.IDLE_TIME_DETECTED,message:this.createIdleMessage(s,o)};this.isChrome()?(d.buttons=l,d.requireInteraction=!0):d.message=d.message+" "+clockifyLocales.CLICK_HERE_TO_DISCARD_IDLE,this.createNotification("idleDetection",d)}function getIdleDuration(e){const t=Date.now();let n,a=0,i=parseInt(((t-e)/6e4).toString().split(".")[0]);return i>=60&&(i%60>0?(i%=60,a=(i-i%60)/60):(a=i/60,i=0)),n={hours:a,minutes:i},n}function createIdleMessage(e,t){return e=e?"'"+e+"'":clockifyLocales.NO_DESCRIPTION,t.hours>0?clockifyLocales.IDLE_MESSAGE(t.hours,t.minutes,e):clockifyLocales.IDLE_MESSAGE_MINUTES(t.minutes,e)}async function discardIdleTimeAndStopEntry(){const{entry:e,error:t}=await TimeEntry.getEntryInProgress();if(t);else if(e){const t=await localStorage.getItem("idleDetectedIn"),{error:n}=await TimeEntry.endInProgress({timeEntry:e,end:new Date(t)});this.clearNotification("idleDetection"),n&&400==n.status&&await TimeEntry.saveEntryOfflineAndStopItByDeletingIt(e,t),aBrowser.runtime.sendMessage({eventName:"idleEvent",timeEntry:null}),setTimeEntryInProgress(null)}}async function discardIdleTimeAndContinueEntry(){const{entry:e,error:t}=await TimeEntry.getEntryInProgress();if(t);else if(e){const t=await localStorage.getItem("idleDetectedIn"),{error:n}=await TimeEntry.endInProgress({timeEntry:e,end:new Date(t)});if(this.clearNotification("idleDetection"),n&&400==n.status&&await TimeEntry.saveEntryOfflineAndStopItByDeletingIt(e,t),setTimeEntryInProgress(null),aBrowser.runtime.sendMessage({eventName:"idleEvent",timeEntry:null}),n&&400==n.status)return;aBrowser.runtime.sendMessage({eventName:"idleEvent",timeEntry:{}}),TimeEntry.startTimer(e.description,{projectId:e.projectId,billable:e.billable,task:e.taskId?{id:e.taskId}:null,tags:e.tagIds?e.tagIds.map((e=>({id:e}))):null})}}async function setTimeEntryToDetectedIdleTime(e){const t=await localStorage.getItem("userId"),n=JSON.parse(await localStorage.getItem("permanent_idleDetection")).map((n=>(n.userId===t&&(n.timeEntryId=e),n)));localStorage.setItem("permanent_idleDetection",JSON.stringify(n))}aBrowser.idle.onStateChanged.addListener(idleChangeStateListener),this.setIdleDetectionOnBrowserStart(),aBrowser.runtime.onMessage.addListener(((e,t,n)=>{"idleDetection"===e.eventName?parseInt(e.counter)>0?(aBrowser.idle.setDetectionInterval(60*parseInt(e.counter)),aBrowser.storage.local.get(["timeEntryInProgress"],(e=>{e.timeEntryInProgress||idleChangeStateListener&&aBrowser.idle.onStateChanged.hasListener(idleChangeStateListener)&&aBrowser.idle.onStateChanged.removeListener(idleChangeStateListener)}))):idleChangeStateListener&&aBrowser.idle.onStateChanged.hasListener(idleChangeStateListener)&&aBrowser.idle.onStateChanged.removeListener(idleChangeStateListener):"addIdleListenerIfIdleIsEnabled"===e.eventName?addIdleListenerIfIdleIsEnabled():"removeIdleListenerIfIdleIsEnabled"===e.eventName&&removeIdleListenerIfIdleIsEnabled()}));