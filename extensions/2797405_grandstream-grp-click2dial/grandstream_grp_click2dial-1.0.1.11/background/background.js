import{DBmanager}from"./indexedDB.js";import{X2JS}from"./xml2json.js";import{GsApi}from"./gs.sdk.min.js";import{WebRTCSocketInstance}from"./gsRTC.socket.js";const DEFAULT_COLOR="rgb(47, 145, 255)";let grpDialingApi={language:"",screen:{width:"",height:""},manifestVersion:"",extensionNamespace:"",keepUserInfo:!0,contactSearchFrom:{ldap:!0,localAddressBook:!0},wordDialingEnabled:!0,popupPort:"",openerPopupId:0,isLogin:!1,permissionCheckRefuse:!1,gsApi:null,lineData:null,maxLinesNum:0,ldapKeys:["emailAttributes","nameAttributes","numberAttributes"],loginData:{selectedAccountId:"",accountLists:[],password:"",url:"",username:"",emailAttributes:"email",nameAttributes:"CallerIDName",numberAttributes:"AccountNumber,MobileNumber,HomeNumber"},sid:"",waitingCall:!1,call401Authentication:!1,intervalList:{getLine:null,getAccounts:null,getPhone:null,willLogin:null},intervalTime:{getLine:1e3,getAccounts:5e3,getPhone:5e3,willLogin:3e4},xml2Json:new X2JS,phoneBooks:{phoneBookGroup:[],phoneBookGroupWithContact:[],localAddressBook:[],ldap:[]},phoneBookDB:new self.DBmanager("phoneBookDB","phoneBook",null,["phoneBookName","TS"]),getContentNumber:"",socket:null,websocketStatus:0,incomingCallNotificationQueue:[],createGsApiOrUpdateConfig:function(){let i=grpDialingApi.loginData;if(!(i&&i.url&&i.username&&i.password))return void console.info("Invalid parameter for login");let e={url:i.url,username:i.username,password:i.password,autoKeepAlive:!1,onerror:grpDialingApi.onErrorCatchHandler};grpDialingApi.gsApi?(console.log("update gsApi config"),grpDialingApi.gsApi.updateCfg(e)):(console.info("create new gsApi"),grpDialingApi.gsApi=new GsApi(e))},createWebSocket:function(i){let e,n=grpDialingApi.loginData.url.split("//");if("http:"===n[0])e=`ws://${n[1]}/websockify`;else{if("https:"!==n[0])return void console.log("websocketUrl error "+grpDialingApi.loginData.url);e=`wss://${n[1]}/websockify`}if(!grpDialingApi.socket||grpDialingApi.socket&&(grpDialingApi.socket.url!==n||!grpDialingApi.socket.wsIsConnected())){grpDialingApi.socket&&(console.log("clear before websocket first."),grpDialingApi.socket.wsCleanUp(),grpDialingApi.socket=null);let n=new WebRTCSocketInstance(e,"gs-ws-addon",(function(e){console.log("create ws callback event：",e),e&&999===e.code&&(grpDialingApi.socket=n,grpDialingApi.getAccountDialPlan(),grpDialingApi.getExtendedContacts(),grpDialingApi.cgiKeepAlive(),i&&i({codeType:e.code})),grpDialingApi.popupPort&&(e.status=grpDialingApi.websocketStatus,grpDialingApi.sendMessage2Popup({cmd:"websocketStatus",data:e}))}))}},socketOnClose:function(i){this.openerPopupId>0&&(console.log("popup page is opened"),grpDialingApi.sendMessage2Popup({cmd:"websocketStatus",data:{code:i.code,status:i.status}}))},onErrorCatchHandler:function(i){console.log("on error catch handler event:",i),i.target&&i.target.readyState?console.log("** An error occurred during the transaction, readyState,"+i.target.readyState+" status ",i.target.status):console.info("** An error occurred during the transaction, status ",i.status),grpDialingApi.loginData&&grpDialingApi.loginData.url&&401===i.status?(console.log("error occurred, check permission!"),grpDialingApi.permissionCheck(grpDialingApi.loginData.url,(function(){console.log("success!!!!!!!!!!"),-1===i.url.indexOf("api-make_call")||grpDialingApi.call401Authentication||(console.info("Authentication information is invalid, login again"),grpDialingApi.call401Authentication=!0,grpDialingApi.accountLogin())}))):console.log("url empty.")},cgiKeepAlive:function(){grpDialingApi.intervalList.willLogin&&(clearInterval(grpDialingApi.intervalList.willLogin),grpDialingApi.intervalList.willLogin=null),grpDialingApi.intervalList.willLogin=setInterval((function(){grpDialingApi.permissionCheck(grpDialingApi.loginData.url)}),grpDialingApi.intervalTime.willLogin)},autoReLogin:function(){console.log("The login may have timed out"),grpDialingApi.isLogin=!1,grpDialingApi.setBrowserAction({color:DEFAULT_COLOR,iconPath:"../quicall/assets/logo.png"}),grpDialingApi.sendMessage2Popup({cmd:"loginStatus",grpClick2TalObj:grpDialingApi,data:{response:"unauthorized"}}),grpDialingApi.permissionCheck(grpDialingApi.loginData.url,grpDialingApi.accountLogin,"loginStatus")},permissionCheck:function(i,e,n){i&&(i=grpDialingApi.checkUrlFormat(i),fetch(i+"/cgi-bin/api-will_login",{method:"GET",credentials:"include",body:null,referrer:i,referrerPolicy:"strict-origin-when-cross-origin",mode:"cors",headers:{accept:"application/json, text/plain, */*","sec-fetch-mode":"cors","sec-fetch-site":"same-origin"}}).then((function(i){if(!i.ok)return console.info("Network response was not OK"),void(grpDialingApi.popupPort&&grpDialingApi.sendMessage2Popup({cmd:n,grpClick2TalObj:grpDialingApi,data:{response:"failed"}}));200===i.status&&i.ok&&(grpDialingApi.permissionCheckRefuse=!1,e&&e())})).catch((function(i){console.info("An error occurred during the transaction\r\n",i),grpDialingApi.popupPort&&grpDialingApi.sendMessage2Popup({cmd:n,grpClick2TalObj:grpDialingApi,data:{response:"failed"}})})))},accountLogin:function(){try{grpDialingApi.gsApi||grpDialingApi.createGsApiOrUpdateConfig(),grpDialingApi.isLogin=!1,grpDialingApi.gsApi.login({onreturn:grpDialingApi.loginCallback,onerror:grpDialingApi.loginErrorCallback})}catch(i){grpDialingApi.popupPort&&grpDialingApi.sendMessage2Popup({cmd:"loginStatus",grpClick2TalObj:grpDialingApi,data:{response:i.name,message:i.message}})}},loginErrorCallback:function(i){console.log("login error: request ",i.url," get response status ",i.status),grpDialingApi.popupPort&&grpDialingApi.sendMessage2Popup({cmd:"loginStatus",grpClick2TalObj:grpDialingApi,data:{response:{status:i.status,url:i.url},body:i.body}})},loginCallback:function(i){if(4===i.readyState||i.ok){let e;if(i.bodyInJsonFormat?e=i.bodyInJsonFormat:i.response&&(e=JSON.parse(i.response)),e)if(console.info("login response:"+e.response),200===i.status&&"success"===e.response){if(e.body&&!0===e.body.defaultAuth&&!1===e.body.defaultLogin)return console.log("password is currently the initial password, please modify it in time"),void(grpDialingApi.popupPort&&grpDialingApi.sendMessage2Popup({cmd:"loginStatus",grpClick2TalObj:grpDialingApi,data:{response:"defaultLoginNotAllow",body:e.body}}));grpDialingApi.sid=e.body.sid,grpDialingApi.isLogin=!0,grpDialingApi.setBrowserAction({color:"#27CA15",iconPath:"../quicall/assets/logo.blue.png"}),grpDialingApi.createWebSocket(),grpDialingApi.getLinesNum(),grpDialingApi.popupPort&&(grpDialingApi.sendMessage2Popup({cmd:"loginStatus",grpClick2TalObj:grpDialingApi,data:{response:"success",body:e.body}}),grpDialingApi.getPhoneStatus()),(grpDialingApi.call401Authentication||grpDialingApi.waitingCall)&&(grpDialingApi.waitingCall?grpDialingApi.waitingCall=!1:console.log("Call 401, re-authentication success"),grpDialingApi.extMakeCall({phonenumber:grpDialingApi.remotenumber}))}else grpDialingApi.popupPort&&grpDialingApi.sendMessage2Popup({cmd:"loginStatus",grpClick2TalObj:grpDialingApi,data:{response:e.response,body:e.body}});else console.info("login return response: ",i),grpDialingApi.call401Authentication&&(console.info("call failed"),grpDialingApi.call401Authentication=!1)}},makeCallActionCallback:function(i){if(4===i.readyState||i.ok)if(console.info("make call return status code : "+i.status),200===i.status){let e;grpDialingApi.call401Authentication&&(grpDialingApi.call401Authentication=!1),i.bodyInJsonFormat?e=i.bodyInJsonFormat:i.response&&(e=JSON.parse(i.response)),console.log("make call response:",e),e&&"error"===e.response?grpDialingApi.popupPort?grpDialingApi.sendMessage2Popup({cmd:"makeCallCallback",data:e.body}):confirm(grpDialingApi.language.L1001):e&&"success"===e.response&&grpDialingApi.popupPort&&grpDialingApi.sendMessage2Popup({cmd:"makeCallCallback",data:e.body})}else 401!==i.status||grpDialingApi.call401Authentication?grpDialingApi.call401Authentication&&(grpDialingApi.call401Authentication=!1):(console.info("Authentication information is invalid, login again"),grpDialingApi.call401Authentication=!0,grpDialingApi.accountLogin())},extMakeCall:function(i){if(i){if(grpDialingApi.remotenumber=i.phonenumber,!grpDialingApi.gsApi)return console.log("[EXT] gsAPI not exist"),grpDialingApi.waitingCall=!0,void grpDialingApi.automaticLoginCheck(!0);grpDialingApi.permissionCheck(grpDialingApi.loginData.url,(function(){console.log("permissionCheck 成功，检查click to dial功能"),grpDialingApi.clickToDialFeatureCheck(grpDialingApi.clickToDialActionCheckCallback,i)}),"makeCallCallback")}else console.info("Invalid phoneNumber parameter to set for make call")},clickToDialActionCheckCallback:function(i,e){if(console.log("click to dial feature enable ",i),!1!==i){let i={account:(e.accountId||parseInt(grpDialingApi.loginData.selectedAccountId))-1,phonenumber:e.phonenumber,password:grpDialingApi.loginData.password,onreturn:grpDialingApi.makeCallActionCallback,onerror:grpDialingApi.onErrorCatchHandler},n=!1;if(grpDialingApi.loginData&&grpDialingApi.loginData.accountLists&&grpDialingApi.loginData.accountLists.length)for(let i=0;i<grpDialingApi.loginData.accountLists.length;i++)if(1===parseInt(grpDialingApi.loginData.accountLists[i].reg)){n=!0;break}n?(console.info("gsApi call phone number "+i.phonenumber),grpDialingApi.gsApi.makeCall(i)):(console.log("[EXT] no active account here:",grpDialingApi.loginData.accountLists),alert("Call failed: account not registered."))}},clickToDialFeatureCheck:function(i,e){grpDialingApi.gsApi&&grpDialingApi.gsApi.configGet({pvalues:"1561",onreturn:function(n){if(4===n.readyState||n.ok){let o;if(n.bodyInJsonFormat?o=n.bodyInJsonFormat:n.response&&(o=JSON.parse(n.response)),200===n.status&&"error"!==o){let n=o.configs;n&&n.length&&"1561"===n[0].pvalue&&(console.log("Click-To-Dial Feature enable: ",n[0].value),"1"===n[0].value?i&&i(!0,e):(console.info("Click-To-Dial Feature is not enabled"),grpDialingApi.popupPort&&grpDialingApi.sendMessage2Popup({cmd:"clickToDialDisabled",data:e})))}else console.log("config get response:",o),i&&i(o)}},onerror:grpDialingApi.onErrorCatchHandler})},apiConfigUpdate:function(i){if(!i||!grpDialingApi.gsApi)return;let e=i.callback;grpDialingApi.gsApi.configUpdate({body:{alias:{},pvalue:{1561:"1"}},onreturn:function(i){if(4===i.readyState||i.ok)if(200===i.status){let n;i.bodyInJsonFormat?n=i.bodyInJsonFormat:i.response&&(n=JSON.parse(i.response)),n&&n.body&&"right"===n.body.status?(console.info("config update success"),e&&e(!0)):(console.info("config update failed: ",n.body.status),e&&e(!1))}else console.log("config update failed, code: ",i.status),e&&e(!1)},onerror:grpDialingApi.onErrorCatchHandler})},getLinesNum:function(){grpDialingApi.gsApi&&grpDialingApi.gsApi.configGet({pvalues:"num_lines",onreturn:function(i){if(console.log("getLinesNum configGetCallBack:",i),4===i.readyState||i.ok){let e;if(i.bodyInJsonFormat?e=i.bodyInJsonFormat:i.response&&(e=JSON.parse(i.response)),200===i.status&&"error"!==e){let i=e.configs;i&&i.length&&(console.log("Get max lines num: ",i[0].value),grpDialingApi.maxLinesNum=i[0].value,grpDialingApi.sendMessage2Popup({cmd:"setMaxLinesNum",maxLinesNum:grpDialingApi.maxLinesNum}))}else console.log("get lines num response:",e)}},onerror:grpDialingApi.onErrorCatchHandler})},getAccounts:function(i){if(!grpDialingApi.loginData||!grpDialingApi.loginData.url)return;let e=function(i){if(4===i.readyState&&200===i.status||i.ok){let e;i.response?e=JSON.parse(i.response):i.bodyInJsonFormat&&(e=i.bodyInJsonFormat),e&&"success"===e.response&&(e.body.length?(grpDialingApi.loginData.accountLists=e.body,grpDialingApi.sendMessage2Popup({cmd:"updateAccountLists",accountLists:e.body})):console.info("account []"))}else 401===i.status&&(console.info("get account unauthorized"),grpDialingApi.sendMessage2Popup({cmd:"loginStatus",grpClick2TalObj:grpDialingApi,data:{response:"unauthorized"}}))};i?(grpDialingApi.clearAccountsStatusInterval(),grpDialingApi.intervalList.getAccounts=setInterval((function(){grpDialingApi.gsApi.getLineStatus({onreturn:e,onerror:grpDialingApi.onErrorCatchHandler})}),grpDialingApi.intervalTime.getAccounts)):grpDialingApi.gsApi.getAccounts({onreturn:e,onerror:grpDialingApi.onErrorCatchHandler})},getPhoneStatus:function(){if(!grpDialingApi.gsApi)return;let i=function(i){if((4===i.readyState||i.ok)&&(i.response||i.bodyInJsonFormat)){let e;i.bodyInJsonFormat?e=i.bodyInJsonFormat:i.response&&(e=JSON.parse(i.response)),e&&"unauthorized"===e.body&&(console.log("login authentication failed"),grpDialingApi.isLogin=!1,grpDialingApi.setBrowserAction({color:DEFAULT_COLOR,iconPath:"../quicall/assets/logo.png"}),grpDialingApi.clearPhoneStatusInterval(),grpDialingApi.sendMessage2Popup({cmd:"loginStatus",grpClick2TalObj:grpDialingApi,data:{response:"unauthorized"}}),grpDialingApi.socket&&(console.log("get phone status authentication failed, clear webSocket"),grpDialingApi.socket.wsCleanUp()))}};grpDialingApi.clearPhoneStatusInterval(),grpDialingApi.intervalList.getPhone=setInterval((function(){grpDialingApi.gsApi.getPhoneStatus({onreturn:i,onerror:grpDialingApi.onErrorCatchHandler})}),grpDialingApi.intervalTime.getPhone)},showLineStatus:function(i){if(!grpDialingApi.gsApi)return;let e=function(i){if(4===i.readyState&&200===i.status||i.ok){let e;i.bodyInJsonFormat?e=i.bodyInJsonFormat:i.responseText&&(e=JSON.parse(i.responseText)),e&&"success"===e.response&&e.body&&e.body.length&&grpDialingApi.sendMessage2Popup({cmd:"setLineStatus",lines:e.body,maxLinesNum:grpDialingApi.maxLinesNum})}else 401===i.status&&(grpDialingApi.isLogin=!1,grpDialingApi.setBrowserAction({color:DEFAULT_COLOR,iconPath:"../quicall/assets/logo.png"}),grpDialingApi.clearLineStatusInterval(),grpDialingApi.sendMessage2Popup({cmd:"loginStatus",grpClick2TalObj:grpDialingApi,data:{response:"unauthorized"}}),grpDialingApi.socket&&(console.log("get phone status authentication failed, clear webSocket"),grpDialingApi.socket.wsCleanUp()))};i?(grpDialingApi.clearLineStatusInterval(),grpDialingApi.intervalList.getLine=setInterval((function(){grpDialingApi.gsApi.getLineStatus({onreturn:e,onerror:grpDialingApi.onErrorCatchHandler})}),grpDialingApi.intervalTime.getLine)):grpDialingApi.gsApi.getLineStatus({onreturn:e,onerror:grpDialingApi.onErrorCatchHandler})},clearAccountsStatusInterval:function(){grpDialingApi.intervalList.getAccounts&&(clearInterval(grpDialingApi.intervalList.getAccounts),grpDialingApi.intervalList.getAccounts=null)},clearLineStatusInterval:function(){grpDialingApi.intervalList.getLine&&(clearInterval(grpDialingApi.intervalList.getLine),grpDialingApi.intervalList.getLine=null)},clearPhoneStatusInterval:function(){grpDialingApi.intervalList.getPhone&&(clearInterval(grpDialingApi.intervalList.getPhone),grpDialingApi.intervalList.getPhone=null)},clearApiKeepAliveInterval:function(){grpDialingApi.gsApi&&grpDialingApi.gsApi.stopKeepAlive&&grpDialingApi.gsApi.stopKeepAlive({onerror:grpDialingApi.onErrorCatchHandler})},updateCallCfg:function(i){if(console.log("update call data: \r\n"+JSON.stringify(i,null,"    ")),!i)return void console.info("Invalid parameter to set update");let e=!1,n=!1;Object.keys(i).forEach((function(o){"url"===o?(i[o]=grpDialingApi.checkUrlFormat(i[o]),i[o]!==grpDialingApi.loginData.url&&(e=!0,console.log("[EXT] clear the selected account information when switching devices to log in."),grpDialingApi.loginData.selectedAccountId="")):"username"!==o&&"password"!==o||i[o]===grpDialingApi.loginData[o]||(n=!0),grpDialingApi.loginData[o]=i[o]}));let o=grpDialingApi.objectDeepClone(grpDialingApi.loginData);grpDialingApi.extensionNamespace.storage.local.set({XNewestData:o},(function(){console.log("set XNewestData success.")})),grpDialingApi.createGsApiOrUpdateConfig(),e?(console.info("Recheck permission of : "+i.url),console.log("clear accountLists"),grpDialingApi.loginData.accountLists=[],grpDialingApi.keepUserInfo=!0,grpDialingApi.contactSearchFrom={ldap:!0,localAddressBook:!0},grpDialingApi.wordDialingEnabled=!0,grpDialingApi.popupPort&&grpDialingApi.sendMessage2Popup({cmd:"updateAccountLists",accountLists:grpDialingApi.loginData.accountLists}),grpDialingApi.permissionCheck(i.url,grpDialingApi.accountLogin,"loginStatus")):!n&&grpDialingApi.isLogin||(console.log("username/password change or logout.."),grpDialingApi.accountLogin())},automaticLoginCheck:function(i){let e=grpDialingApi.loginData;e&&e.url&&e.username&&e.password?(console.info("check permission before auto login"),grpDialingApi.permissionCheck(e.url,grpDialingApi.accountLogin,"loginStatus")):i&&(grpDialingApi.waitingCall=!1,alert("Please login on the GRP Click2Dial page first"))},checkUrlFormat:function(i){return"http://"!==i.substr(0,7)&&"https://"!==i.substr(0,8)&&-1===i.indexOf("addon")?i="http://"+i+"/addon":"http://"===i.substr(0,7)&&-1===i.indexOf("addon")?i+="/addon":"https://"===i.substr(0,8)&&-1===i.indexOf("addons")&&(i+="/addons"),i},objectDeepClone:function(i){if(null===i||"object"!=typeof i)return i;let e=function(i){let e=i.constructor();for(let n in i)i.hasOwnProperty(n)&&(e[n]=i[n]);return e};if("object"==typeof i&&!Array.isArray(i))try{return JSON.parse(JSON.stringify(i))}catch(n){return e(i)}return e(i)},isObjectXExactlyEqualToY:function(i,e){let n,o,a,t;function r(i,e){let n;if(isNaN(i)&&isNaN(e)&&"number"==typeof i&&"number"==typeof e)return!0;if(i===e)return!0;if("function"==typeof i&&"function"==typeof e||i instanceof Date&&e instanceof Date||i instanceof RegExp&&e instanceof RegExp||i instanceof String&&e instanceof String||i instanceof Number&&e instanceof Number)return i.toString()===e.toString();if(!(i instanceof Object&&e instanceof Object))return!1;if(i.isPrototypeOf(e)||e.isPrototypeOf(i))return!1;if(i.constructor!==e.constructor)return!1;if(i.prototype!==e.prototype)return!1;if(a.indexOf(i)>-1||t.indexOf(e)>-1)return!1;for(n in e){if(e.hasOwnProperty(n)!==i.hasOwnProperty(n))return!1;if(typeof e[n]!=typeof i[n])return!1}for(n in i){if(e.hasOwnProperty(n)!==i.hasOwnProperty(n))return!1;if(typeof e[n]!=typeof i[n])return!1;switch(typeof i[n]){case"object":case"function":if(a.push(i),t.push(e),!r(i[n],e[n]))return!1;a.pop(),t.pop();break;default:if(i[n]!==e[n])return!1}}return!0}if(arguments.length<1)return console.log("Need two or more arguments to compare"),!0;for(n=1,o=arguments.length;n<o;n++)if(a=[],t=[],!r(arguments[0],arguments[n]))return!1;return!0},contactGrouping:function(i,e){if(!i||!e)return console.log("pbgroup or localAddressBook can not be empty!"),{};let n=function(i){let e={};return i.forEach((function(i){e[i.id]||(e[i.id]=i,i.memberList=[])})),e}(i);e.forEach((function(i){"Group"in i&&(Array.isArray(i.Group)?i.Group.forEach((function(e){n[e]&&n[e].memberList.push(i)})):n[i.Group]&&n[i.Group].memberList.push(i))})),console.log("分组后的联系人列表：",n),grpDialingApi.phoneBooks.phoneBookGroupWithContact=n,grpDialingApi.phoneBookDB.setItems([{phoneBookName:"phoneBookGroupWithContact",content:n,TS:(new Date).getTime(),deviceId:grpDialingApi.loginData.url.split("//")[1]}])},getLocalPhoneBook:function(){console.log("get local phone book ",grpDialingApi.isLogin),grpDialingApi.gsApi&&grpDialingApi.isLogin&&(console.log("获取GRP本地联系人(兼容GRP261X)"),grpDialingApi.gsApi.phonebookDownload({onreturn:function(i){if(4===i.readyState||i.ok)if(200===i.status&&"OK"===i.statusText){let e,n=i.bodyInJsonFormat||i.response;if(n&&n.startsWith("<?xml")){console.log("GET LOCAL ADDRESS BOOK SUCCESS"),e=grpDialingApi.xml2Json.xml_str2json(n);let i=[],o=[];e&&e.AddressBook&&(e.AddressBook.Contact&&(e.AddressBook.Contact.length?i=e.AddressBook.Contact:"[object Object]"===Object.prototype.toString.call(e.AddressBook.Contact)&&(i[0]=e.AddressBook.Contact)),e.AddressBook.pbgroup&&(e.AddressBook.pbgroup.length?o=e.AddressBook.pbgroup:"[object Object]"===Object.prototype.toString.call(e.AddressBook.pbgroup)&&(o[0]=e.AddressBook.pbgroup))),i&&i.length?grpDialingApi.phoneBooks.localAddressBook=i:(console.log("未获取到本地通讯录数据:",e),grpDialingApi.phoneBooks.localAddressBook=[]),o&&o.length?(grpDialingApi.phoneBooks.phoneBookGroup=o,grpDialingApi.phoneBookDB.setItems([{phoneBookName:"phoneBookGroup",content:grpDialingApi.phoneBooks.phoneBookGroup,TS:(new Date).getTime(),deviceId:grpDialingApi.loginData.url.split("//")[1]}]),i&&i.length&&grpDialingApi.contactGrouping(o,i)):console.log("未获取到群组信息"),grpDialingApi.phoneBookDB.setItems([{phoneBookName:"localAddressBook",content:grpDialingApi.phoneBooks.localAddressBook,TS:(new Date).getTime(),deviceId:grpDialingApi.loginData.url.split("//")[1]}]),grpDialingApi.extensionNamespace.storage.local.set({phoneBooks:JSON.stringify(grpDialingApi.phoneBooks)},(function(){console.log("save phoneBooks success")}))}}else console.log("GET AddressBook FAILED, ",i.status)},onerror:function(i){console.log("errorCallback",i)}}))},getLdap:function(i){if(!grpDialingApi.gsApi||!grpDialingApi.isLogin)return;let e=grpDialingApi.getLdapSearchParam(i);grpDialingApi.gsApi.ldapSearch({body:{ldapParam:e},contentType:"application/json",onreturn:function(i){if(4===i.readyState||i.ok){if(200===i.status&&"OK"===i.statusText){let e;console.log("GET LDAP SUCCESS");let n=[];i.bodyInJsonFormat?e=i.bodyInJsonFormat:i.response&&(e=JSON.parse(i.response)),Object.keys(e).forEach((function(i){let o=e[i];o&&o.length&&(n=n.concat(o))})),n.length&&"timeout"!==n[0]&&"param error"!==n[0]?grpDialingApi.phoneBooks.ldap=n:(grpDialingApi.phoneBooks.ldap=[],console.log("未获取到ldap数据:",n))}else console.log("GET LDAP FAILED, ",i.status),grpDialingApi.phoneBooks.ldap=[];grpDialingApi.phoneBookDB.setItems([{phoneBookName:"ldap",content:grpDialingApi.phoneBooks.ldap,TS:(new Date).getTime(),ldapParam:e}]),grpDialingApi.extensionNamespace.storage.local.set({phoneBooks:JSON.stringify(grpDialingApi.phoneBooks)},(function(){console.log("save phoneBooks success")}))}},onerror:function(i){console.log("errorCallback",i)}})},getAccountDialPlan:function(){console.log("get account dial plan");let i=grpDialingApi.loginData?.url+"/cgi-bin/api-dialplan_regex";fetch(i,{body:null,method:"GET",mode:"cors",credentials:"include"}).then((function(i){return i.ok&&200===i.status?i.json():null})).then((function(i){i&&"success"===i.response&&function(i){let e=grpDialingApi.loginData.selectedAccountId-1;i&&i.length&&i[e]&&i[e].regex&&i[e].regex.length?(grpDialingApi.dialplanregulars=i,grpDialingApi.extensionNamespace.storage.local.set({dialplanregulars:i[e].regex})):console.log("get dial plan regulars:",i)}(i.result.regex)})).catch((function(i){console.error("get DialPlan error:",i)}))},getExtendedContacts:function(){console.log("get extended contacts."),grpDialingApi.gsApi?(grpDialingApi.getLocalPhoneBook(),grpDialingApi.getLdap()):console.log("no login, can not authorized")},getLdapSearchParam:function(i){let e="";return Object.keys(grpDialingApi.loginData).forEach((function(i){grpDialingApi.ldapKeys.includes(i)&&(e=e?e+","+grpDialingApi.loginData[i]:grpDialingApi.loginData[i])})),{searchWord:i?.searchWord||"",searchKey:i?.searchKey||"",returnKey:e||"email,CallerIDName,AccountNumber,MobileNumber,HomeNumber",returnLimit:i?.limit||0}},getPhoneBookFromDB:function(i={}){grpDialingApi.phoneBookDB&&grpDialingApi.phoneBookDB.getAllItems((function(e=[]){let n=!0,o=!0,a=6048e5;if(e.length){console.log("wave extended contacts",e);for(let i=0;i<e.length;i++){let t=e[i].phoneBookName;grpDialingApi.phoneBooks[t]=e[i].content;let r=(new Date).getTime()-e[i].TS,l=grpDialingApi.loginData.url.split("//")[1];"localAddressBook"===t&&e.deviceId===l&&r<=a?n=!1:"ldap"===t&&r<=a&&(o=!1)}}i.callback&&i.callback({isAddressBookNeedUpdated:n,isLdapNeedUpdated:o})}))},userInfoManagement:function(){grpDialingApi.extensionNamespace.storage.local.get("keepUserInfo",(function(i){"true"!==i.keepUserInfo&&!0!==i.keepUserInfo&&(grpDialingApi.phoneBookDB?.clear(),grpDialingApi.loginData={selectedAccountId:"",accountLists:[],password:"",url:"",username:"",emailAttributes:"email",nameAttributes:"CallerIDName",numberAttributes:"AccountNumber,MobileNumber,HomeNumber"},grpDialingApi.phoneBooks.ldap=[],grpDialingApi.isLogin=!1,grpDialingApi.keepUserInfo=!0,grpDialingApi.contactSearchFrom={ldap:!0,localAddressBook:!0},grpDialingApi.wordDialingEnabled=!0,grpDialingApi.extensionNamespace.storage.local.clear((function(){console.log("local storage clear success.")})))}))},sendMessageToContentScript:function(i,e){grpDialingApi.extensionNamespace?grpDialingApi.extensionNamespace.tabs&&grpDialingApi.extensionNamespace.tabs.query&&grpDialingApi.extensionNamespace.tabs.query({active:!0,currentWindow:!0},(function(n){n&&n.length&&(i.requestType="backgroundMessage2ContentScript",grpDialingApi.extensionNamespace.tabs.sendMessage(n[0].id,i,(function(i){grpDialingApi.extensionNamespace.runtime.lastError?console.log(`Error: ${grpDialingApi.extensionNamespace.runtime.lastError.message}`):e&&e(i)})))})):console.log("unknown tab type")},chromeRuntimeOnMessage:function(i,e){switch(i.cmd){case"contentScriptMakeCall":console.info("contentScriptMakeCall extension make call data:",i.data),grpDialingApi.extMakeCall(i.data);break;case"configureQuery":e&&e({contactSearchFrom:grpDialingApi.contactSearchFrom,wordDialing:grpDialingApi.wordDialingEnabled})}},runTimeOnConnect:function(i){console.log("runTime Connect port:",i),"popup"===i.name&&(grpDialingApi.popupPort=i,i.onMessage.addListener((e=>{e&&"popupMessage2Background"===e.requestType&&grpDialingApi.recvPopupMessage(e,i)})),i.onDisconnect.addListener((function(){console.log("onDisconnect, clear popup port and interval"),grpDialingApi.extensionNamespace.runtime.lastError&&console.log("Got expected error: "+grpDialingApi.extensionNamespace.runtime.lastError.message),grpDialingApi.popupPort=null,grpDialingApi.isLogin||(grpDialingApi.clearLineStatusInterval(),grpDialingApi.clearPhoneStatusInterval(),grpDialingApi.clearApiKeepAliveInterval(),grpDialingApi.userInfoManagement())})))},sendMessage2Popup:function(i){grpDialingApi.popupPort?(i=JSON.stringify(i),grpDialingApi.popupPort.postMessage(i)):console.log("popup port not exist!")},handlePopupOpen:function(i){if(console.log("islogin ",grpDialingApi.isLogin),grpDialingApi.createGsApiOrUpdateConfig(),grpDialingApi.popupPort&&grpDialingApi.sendMessage2Popup({cmd:"popupShowConfig",grpClick2TalObj:grpDialingApi}),grpDialingApi.isLogin)grpDialingApi.getPhoneStatus(),console.log("websocket status:",grpDialingApi.websocketStatus),grpDialingApi.websocketStatus&&grpDialingApi.sendMessage2Popup({cmd:"websocketStatus",data:{status:grpDialingApi.websocketStatus}});else{if(grpDialingApi.permissionCheckRefuse)return void console.log("[EXT] already refuse permission check, do not auto login when popup open");grpDialingApi.automaticLoginCheck()}i.screen&&(grpDialingApi.screen=i.screen,grpDialingApi.extensionNamespace.storage.local.set({screen:i.screen})),i.language&&(grpDialingApi.language=i.language,grpDialingApi.extensionNamespace.storage.local.set({language:grpDialingApi.language},(function(){console.log("set language success")}))),grpDialingApi.lineData&&grpDialingApi.sendMessage2Popup({cmd:"setLineStatus",lines:grpDialingApi.lineData,maxLinesNum:grpDialingApi.maxLinesNum})},logoutProcess:function(){console.log("[EXT] account logout."),grpDialingApi.clearLineStatusInterval(),grpDialingApi.clearPhoneStatusInterval(),grpDialingApi.gsApi.dologout(),grpDialingApi.isLogin=!1,grpDialingApi.lineData=null,grpDialingApi.websocketStatus=0,grpDialingApi.userInfoManagement(),grpDialingApi.socket&&(console.log("clear websocket for logout"),grpDialingApi.socket.wsCleanUp()),grpDialingApi.setBrowserAction({color:DEFAULT_COLOR,iconPath:"../quicall/assets/logo.png"})},recvPopupMessage:function(i,e){if(i)switch(console.log("receive popup message cmd:",i.cmd),i.cmd){case"popupOnOpen":grpDialingApi.handlePopupOpen(i);break;case"permissionCheckRefuse":grpDialingApi.permissionCheckRefuse=!0;break;case"enableClickToDial":grpDialingApi.apiConfigUpdate({callback:function(e){grpDialingApi.clickToDialActionCheckCallback(e,i.data)}});break;case"popupAccountChange":case"popupUpdateLoginInfo":i.data&&i.data.url&&(i.data.url=grpDialingApi.checkUrlFormat(i.data.url)),grpDialingApi.updateCallCfg(i.data);break;case"popupMakeCall":console.info("extension make call data:",i.data),grpDialingApi.extMakeCall(i.data);break;case"setSelectedAccount":i.data&&i.data.accountId&&(console.log("set selected account ",i.data.accountId),grpDialingApi.loginData.selectedAccountId=i.data.accountId,grpDialingApi.extensionNamespace.storage.local.set({selectedAccount:i.data.accountId},(function(){console.log("set selected account success")})),grpDialingApi.getAccountDialPlan());break;case"popupLineOperation":if(console.info(i.type+" line ",i.lineId),!i.lineId)return;grpDialingApi.gsApi.phoneOperation({arg:i.lineId,cmd:i.type,sid:grpDialingApi.sid,onerror:grpDialingApi.onErrorCatchHandler});break;case"accountLogout":grpDialingApi.logoutProcess();break;case"userDataControl":console.log("request.data.keep:",i.data),grpDialingApi.keepUserInfo=i.data.keep,grpDialingApi.extensionNamespace.storage.local.set({keepUserInfo:i.data.keep},(function(){console.log("set keep user info "+i.data.keep)}));break;case"setWordDialing":console.log("enabeld word dialing ?",i.data.wordDialing),grpDialingApi.wordDialingEnabled=i.data.wordDialing;break;case"setContactSearch":console.log("set contact search source: ",JSON.stringify(i.data,"    ")),grpDialingApi.contactSearchFrom=i.data}},getBrowserDetail(){function i(i,e,n){let o=i.match(e);return o&&o.length>=n&&parseInt(o[n],10)}var e={browser:null,version:null,UIVersion:null,chromeVersion:null,systemFriendlyName:null};if(navigator.userAgent.match(/Windows/)?e.systemFriendlyName="windows":navigator.userAgent.match(/Mac/)?e.systemFriendlyName="mac":navigator.userAgent.match(/Linux/)&&(e.systemFriendlyName="linux"),"undefined"==typeof window||!window.navigator)return e.browser="Not a browser.",e;if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))e.browser="edge",e.version=i(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2),e.UIVersion=navigator.userAgent.match(/Edge\/([\d.]+)/)[1];else if(!navigator.mediaDevices&&(window.ActiveXObject||"ActiveXObject"in window||navigator.userAgent.match(/MSIE (\d+)/)||navigator.userAgent.match(/rv:(\d+)/)))e.browser="ie",navigator.userAgent.match(/MSIE (\d+)/)?(e.version=i(navigator.userAgent,/MSIE (\d+).(\d+)/,1),e.UIVersion=navigator.userAgent.match(/MSIE ([\d.]+)/)[1]):navigator.userAgent.match(/rv:(\d+)/)&&(e.version=i(navigator.userAgent,/rv:(\d+).(\d+)/,1),e.UIVersion=navigator.userAgent.match(/rv:([\d.]+)/)[1]);else if(navigator.mozGetUserMedia)e.browser="firefox",e.version=i(navigator.userAgent,/Firefox\/(\d+)\./,1),e.UIVersion=navigator.userAgent.match(/Firefox\/([\d.]+)/)[1];else if(navigator.webkitGetUserMedia&&window.webkitRTCPeerConnection)navigator.userAgent.match(/(OPR|Opera).([\d.]+)/)?(e.browser="opera",e.version=i(navigator.userAgent,/O(PR|pera)\/(\d+)\./,2),e.UIVersion=navigator.userAgent.match(/O(PR|pera)\/([\d.]+)/)[2],navigator.userAgent.match(/Chrom(e|ium)\/([\d.]+)/)[2]&&(e.chromeVersion=i(navigator.userAgent,/Chrom(e|ium)\/(\d+)\./,2))):(e.browser="chrome",e.version=i(navigator.userAgent,/Chrom(e|ium)\/(\d+)\./,2),e.UIVersion=navigator.userAgent.match(/Chrom(e|ium)\/([\d.]+)/)[2]);else{if(!(!navigator.webkitGetUserMedia&&navigator.userAgent.match(/AppleWebKit\/([0-9]+)\./)||navigator.webkitGetUserMedia&&!navigator.webkitRTCPeerConnection))return e.browser="Not a supported browser.",e;if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return e.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",e;e.browser="safari",e.version=i(navigator.userAgent,/AppleWebKit\/(\d+)\./,1),e.UIVersion=navigator.userAgent.match(/Version\/([\d.]+)/)[1]}return e},openPopup:function(i){let e=this,n=e.extensionNamespace.runtime.getURL("../quicall/quicall.html");console.log("openPopup url:",n);let o=function(n){if(n){if(e.openerPopupId=n&&n.id,!i||!i.number)return void console.log("no number to call");console.log("set temporary call number: ",i.number),e.extensionNamespace.storage.local.set({temporaryCallInfo:i},(function(){console.log("set number success.")}))}else console.log("window maybe open failed!")},a=450,t=540;"firefox"===grpDialingApi.getBrowserDetail().browser&&(t+=150);let r=200,l=600;2===e.extensionNamespace.runtime.getManifest().manifest_version?(r=(window.screen.height-30-t)/2,l=(window.screen.width-10-a)/2):grpDialingApi.screen.width&&grpDialingApi.screen.height&&(r=(grpDialingApi.screen.height-30-t)/2,l=(grpDialingApi.screen.width-10-a)/2),e.openerPopupId>0?e.extensionNamespace.windows.get(e.openerPopupId,{},(function(i){i?(console.log("update window"),e.extensionNamespace.windows.update(i.id,{focused:!0,left:l,top:r},o)):e.extensionNamespace.windows.create({url:n,type:"popup",height:t,width:a,left:l,top:r},o)})):(console.log("open popup page"),e.extensionNamespace.windows.create({url:n,type:"popup",height:t,width:a,left:l,top:r},o))},handleMenusClick2DialNumber:function(i,e){let n=i.selectionText;console.log("handle menus click to dial number info：",n),grpDialingApi.openPopup({number:n,email:""})},handleClick2DialNumber:function(i){i&&i.number&&(console.log("handle click 2 dial number:"),grpDialingApi.openPopup(i))},getLoginInfo:function(){grpDialingApi.extensionNamespace.storage.local.get("XNewestData",(function(i){if(i&&i.XNewestData){grpDialingApi.loginData=i.XNewestData,console.log("get login data form storage:",grpDialingApi.loginData);let e=grpDialingApi.loginData;e&&e.url&&e.username&&e.password&&grpDialingApi.permissionCheck(e.url,grpDialingApi.accountLogin,"loginStatus")}})),grpDialingApi.extensionNamespace.storage.local.get("keepUserInfo",(function(i){console.log("keep user info value:",i);let e=i.keepUserInfo;"false"===e||"true"===e?grpDialingApi.keepUserInfo=e:(console.log("keep user info for default."),grpDialingApi.keepUserInfo=!0,grpDialingApi.extensionNamespace.storage.local.set({keepUserInfo:!0},(function(){console.log("set keep user info default value:"+!0)})))})),grpDialingApi.extensionNamespace.storage.local.get("selectedAccount",(function(i){console.log("selectedAccount value:",i),grpDialingApi.loginData.selectedAccountId=i.selectedAccount})),console.log("open db!!"),grpDialingApi.phoneBookDB?.openDB()},setBrowserAction:function(i){let e=i.version;e&&(e=e.toString());let n=i.color,o=i.iconPath;grpDialingApi.extensionNamespace.browserAction&&grpDialingApi.extensionNamespace.browserAction.setBadgeText?(o&&grpDialingApi.extensionNamespace.browserAction.setIcon({path:o}),n&&grpDialingApi.extensionNamespace.browserAction.setBadgeBackgroundColor({color:n}),e&&grpDialingApi.extensionNamespace.browserAction.setBadgeText({text:e})):grpDialingApi.extensionNamespace.action&&grpDialingApi.extensionNamespace.action.setBadgeText&&(o&&grpDialingApi.extensionNamespace.action.setIcon({path:o}),n&&grpDialingApi.extensionNamespace.action.setBadgeBackgroundColor({color:n}),e&&grpDialingApi.extensionNamespace.action.setBadgeText({text:e}))},handleRequest:function(i){i&&("string"==typeof i&&(i=JSON.parse(i)),"setLineStatus"===i.cmd?i.lines&&(grpDialingApi.checkNotification(i),grpDialingApi.lineData=i.lines):console.log("get content:",i))},checkNotification:function(i){if(i&&i.lines)for(let e=0;e<i.lines.length;e++){let n=i.lines[e],o="incomingCallNotification"+n.line,a=grpDialingApi.incomingCallNotificationQueue.indexOf(o);if("ringing"===n.state&&a<0){let i;grpDialingApi.incomingCallNotificationQueue.push(o),i="zh-CN"===grpDialingApi.language.language?`${n.remotename} (${n.remotenumber}) ${grpDialingApi.language.L149}`:`${grpDialingApi.language.L149} ${n.remotename} (${n.remotenumber})`;let e={id:o,title:"GRP Click2Dial",message:i,action:"ringing"};"firefox"!==grpDialingApi.getBrowserDetail().browser&&(e.buttons=[{title:grpDialingApi.language.L21}]),grpDialingApi.createDesktopNotification(e)}"ringing"!==n.state&&a>=0&&grpDialingApi.clearNotification(o)}},createDesktopNotification:function(i){if(grpDialingApi.extensionNamespace&&grpDialingApi.extensionNamespace.notifications){console.log("notifications.create");let e=i.id||null,n={type:"basic",iconUrl:"../quicall/assets/logo.png",title:i.title,message:i.message};i.buttons&&(n.buttons=i.buttons),grpDialingApi.extensionNamespace.notifications.create(e,n,(e=>{i.action&&"ringing"===i.action||(grpDialingApi.notificationsId=e,console.log("current notifications id:",e))}))}},clearNotification:function(i){if(console.log("clearNotification: ",i),i){if("firefox"===grpDialingApi.getBrowserDetail().browser?(grpDialingApi.extensionNamespace.notifications.clear(i).then((()=>{console.log(`Notification ${i} cleared successfully.`)})),grpDialingApi.extensionNamespace.notifications.onClicked.removeListener(grpDialingApi.handleNotificationClick)):(grpDialingApi.extensionNamespace.notifications.onButtonClicked.removeListener(grpDialingApi.handleNotificationButtonClicked),grpDialingApi.extensionNamespace.notifications.clear(i)),grpDialingApi.incomingCallNotificationQueue.indexOf(i)>=0){let e=parseInt(i.split("incomingCallNotification")[1]),n=grpDialingApi.incomingCallNotificationQueue.indexOf(e);grpDialingApi.incomingCallNotificationQueue.splice(n,1)}}else console.log("no notificationsId to clear")},handleNotificationClick:function(i){console.log("onClicked event trigger, notificationId: ",i),grpDialingApi.openPopup("../quicall/quicall.html")},handleNotificationButtonClicked:function(i,e){console.log(`notifications onButtonClicked notificationId: ${i}, is byUser: ${e}`),grpDialingApi.clearNotification(i)},handleNotificationOnClosed:function(i,e){console.log(`notifications onClosed notificationId: ${i}, is byUser: ${e}`)}};chrome?grpDialingApi.extensionNamespace=chrome:browser&&(grpDialingApi.extensionNamespace=browser),grpDialingApi.extensionNamespace.browserAction?grpDialingApi.extensionNamespace.browserAction.onClicked.addListener((function(i){console.log("action onClicked"),grpDialingApi.openPopup()})):grpDialingApi.extensionNamespace.action&&grpDialingApi.extensionNamespace.action.onClicked.addListener((function(i){console.log("action onClicked"),grpDialingApi.openPopup()})),grpDialingApi.extensionNamespace.windows.onCreated.addListener((function(){console.log("windows onCreated")})),grpDialingApi.extensionNamespace.windows.onRemoved.addListener((function(i){console.log("windows onRemoved, windowId: ",i),grpDialingApi.openerPopupId===i&&(console.log("popup window is closed."),grpDialingApi.openerPopupId=null)})),grpDialingApi.extensionNamespace.windows.onFocusChanged.addListener((function(i){})),grpDialingApi.extensionNamespace.runtime.onMessage.addListener((function(i,e,n){console.log("runtime onMessage"),i&&"contentMessage2Background"===i.requestType&&grpDialingApi.chromeRuntimeOnMessage(i,n)})),grpDialingApi.extensionNamespace.runtime.onConnect.addListener((function(i){console.log("runtime onConnect"),grpDialingApi.runTimeOnConnect(i)})),grpDialingApi.extensionNamespace.management&&(grpDialingApi.extensionNamespace.management.onDisabled.addListener((function(i){console.log("onDisabled"),grpDialingApi.extensionNamespace.contextMenus.update("GRP Click2Dial",{visible:!1})})),grpDialingApi.extensionNamespace.management.onEnabled.addListener((function(i){console.log("onEnabled")})),grpDialingApi.extensionNamespace.management.onInstalled.addListener((function(i){console.log("onInstalled")})),grpDialingApi.extensionNamespace.management.onUninstalled.addListener((function(i){console.log("onUninstalled"),console.log("all contextMenus removed"),grpDialingApi.extensionNamespace.contextMenus.removeAll()}))),grpDialingApi.extensionNamespace.runtime.onInstalled.addListener((function(i){console.log("runtime onInstalled"),grpDialingApi.extensionNamespace.storage.local.get("screen",(function(i){i&&i.screen&&(grpDialingApi.screen=i.screen,console.log("get screen data form storage:",grpDialingApi.screen))}))})),grpDialingApi.extensionNamespace.contextMenus.create({id:"GRP Click2Dial",title:`${grpDialingApi.language.call||"Call"}: %s`,contexts:["selection"]},(function(){grpDialingApi.extensionNamespace.runtime.lastError&&console.log("Got expected error: "+grpDialingApi.extensionNamespace.runtime.lastError.message)})),grpDialingApi.extensionNamespace.contextMenus.onClicked.addListener(grpDialingApi.handleMenusClick2DialNumber),grpDialingApi.getLoginInfo(),self&&(self.grpDialingApi=grpDialingApi),grpDialingApi&&grpDialingApi.extensionNamespace&&grpDialingApi.extensionNamespace.notifications&&(grpDialingApi.extensionNamespace.notifications.onClicked.addListener(grpDialingApi.handleNotificationClick),grpDialingApi.extensionNamespace.notifications.onClosed.addListener(grpDialingApi.handleNotificationOnClosed),grpDialingApi.extensionNamespace.notifications.onButtonClicked.addListener(grpDialingApi.handleNotificationButtonClicked));